<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alliance DAO NFT Explorer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: #121212;
            color: #e5e7eb; /* gray-200 */
        }
        .nft-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .nft-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 255, 255, 0.1), 0 6px 6px rgba(0, 255, 255, 0.09);
        }
        .pagination-btn, .control-btn {
            background-color: #374151; /* gray-700 */
            color: #e5e7eb; /* gray-200 */
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            border: 1px solid #4b5563; /* gray-600 */
            transition: background-color 0.2s;
            font-weight: 500;
        }
        .pagination-btn:hover:not(:disabled), .control-btn:hover:not(:disabled) {
            background-color: #4b5563; /* gray-600 */
        }
        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .form-input, .form-select {
            background-color: #1f2937; /* gray-800 */
            border: 1px solid #4b5563; /* gray-600 */
            border-radius: 0.5rem;
            color: #e5e7eb;
            padding: 0.5rem 0.75rem;
        }
        .form-select {
            -webkit-appearance: none; -moz-appearance: none; appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; padding-right: 2.5rem;
        }
        .aspect-w-1-aspect-h-1 { position: relative; width: 100%; padding-bottom: 100%; }
        .aspect-w-1-aspect-h-1 > img { position: absolute; height: 100%; width: 100%; top: 0; right: 0; bottom: 0; left: 0; object-fit: cover; }
        
        .toggle-label { display: flex; align-items: center; cursor: pointer; color: #d1d5db; }
        .toggle-checkbox { opacity: 0; width: 0; height: 0; }
        .toggle-switch { position: relative; display: inline-block; width: 36px; height: 20px; background-color: #4b5563; border-radius: 20px; transition: background-color 0.2s; }
        .toggle-switch::before { content: ''; position: absolute; width: 16px; height: 16px; border-radius: 50%; background-color: white; top: 2px; left: 2px; transition: transform 0.2s; }
        .toggle-checkbox:checked + .toggle-switch { background-color: #2dd4bf; }
        .toggle-checkbox:checked + .toggle-switch::before { transform: translateX(16px); }

        .direction-slider-container { display: flex; align-items: center; gap: 0.5rem; }
        input[type="range"].direction-slider { -webkit-appearance: none; appearance: none; width: 60px; height: 16px; background: #374151; border-radius: 8px; outline: none; transition: background 0.2s; }
        input[type="range"].direction-slider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; background: #9ca3af; border-radius: 50%; border: 2px solid #1f2937; cursor: pointer; margin-top: -2px; }
        input[type="range"].direction-slider:disabled { opacity: 0.4; }
        input[type="range"].direction-slider:disabled::-webkit-slider-thumb { background: #4b5563; }
    </style>
</head>
<body class="bg-gray-900 p-4 sm:p-8">

    <header class="text-center mb-8">
        <h1 class="text-4xl sm:text-5xl font-bold text-white">Alliance DAO NFT Explorer</h1>
        <p class="text-cyan-400 mt-2">Explore the entire collection with advanced search and filtering.</p>
    </header>

    <div class="max-w-screen-2xl mx-auto">
        <div id="controls" class="p-4 bg-gray-800/50 rounded-lg border border-gray-700">
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                <div class="col-span-1 sm:col-span-2 lg:col-span-3 grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="search-id" class="block text-sm font-medium text-gray-300 mb-1">Search by ID</label>
                        <input type="number" id="search-id" placeholder="Enter NFT ID..." class="form-input w-full">
                    </div>
                    <div>
                        <label for="sort-rarity" class="block text-sm font-medium text-gray-300 mb-1">Sort Rarity</label>
                        <select id="sort-rarity" class="form-select w-full">
                            <option value="none">Default</option>
                            <option value="asc">Ascending</option>
                            <option value="desc" selected>Descending</option>
                        </select>
                    </div>
                </div>
                <div class="flex justify-end">
                     <button id="reset-filters" class="control-btn">Reset All</button>
                </div>
            </div>
            
            <div id="trait-filters-container" class="mt-4 pt-4 border-t border-gray-700 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-4">
                <div id="gender-filter-container">
                    <label for="filter-gender" class="block text-sm font-medium text-gray-300 mb-1">Filter by Gender</label>
                    <select id="filter-gender" class="form-select w-full">
                        <option value="all">All Genders</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                    </select>
                </div>
            </div>
    
            <div class="mt-6 pt-4 border-t border-gray-700">
                 <label class="block text-sm font-medium text-gray-300 mb-2">Planet Filters</label>
                 <div id="planet-filters-container" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-y-4 gap-x-6">
                 </div>
            </div>
    
            <div class="mt-6 pt-4 border-t border-gray-700">
                 <label class="block text-sm font-medium text-gray-300 mb-2">Display Options</label>
                 <div id="trait-toggles-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-x-4 gap-y-2">
                 </div>
            </div>
        </div>
        <div id="results-count" class="mt-8 mb-4 text-gray-400"></div>
        <div id="nft-gallery" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6 min-h-[500px]">
        </div>
        <div id="pagination-controls" class="flex justify-center items-center mt-8 space-x-4">
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const gallery = document.getElementById('nft-gallery');
            const paginationControls = document.getElementById('pagination-controls');
            const searchInput = document.getElementById('search-id');
            const raritySort = document.getElementById('sort-rarity');
            const genderFilter = document.getElementById('filter-gender');
            const traitFiltersContainer = document.getElementById('trait-filters-container');
            const planetFiltersContainer = document.getElementById('planet-filters-container');
            const traitTogglesContainer = document.getElementById('trait-toggles-container');
            const resetButton = document.getElementById('reset-filters');
            const resultsCount = document.getElementById('results-count');

            // --- Configuration ---
            const METADATA_URL = "https://cdn.jsdelivr.net/gh/defipatriot/nft-metadata/all_nfts_metadata.json";
            const itemsPerPage = 20;
            const traitOrder = ["Rarity", "Planet", "Inhabitant", "Object", "Weather", "Light"];
            const defaultTraitsOn = ["Rarity", "Planet", "Inhabitant", "Object"];

            // --- State Variables ---
            let allNfts = [];
            let filteredNfts = [];
            let currentPage = 1;

            // --- UI Update Functions ---
            const showLoading = (container, message) => {
                container.innerHTML = `<p class="text-center col-span-full text-cyan-400 text-lg">${message}</p>`;
            };

            const showError = (container, message) => {
                container.innerHTML = `<div class="text-center col-span-full bg-red-900/50 border border-red-700 text-white p-6 rounded-lg">
                                        <h3 class="font-bold text-xl">Error</h3>
                                        <p class="mt-2 text-red-300">${message}</p>
                                     </div>`;
            };

            function convertIpfsUrl(ipfsUrl) {
                if (!ipfsUrl || !ipfsUrl.startsWith('ipfs://')) return '';
                const cidAndPath = ipfsUrl.replace('ipfs://', '');
                return `https://ipfs.io/ipfs/${cidAndPath}`;
            }

            // --- Core Logic ---
            const initializeExplorer = async () => {
                showLoading(gallery, 'Loading collection metadata...');
                try {
                    const response = await fetch(METADATA_URL);
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    allNfts = await response.json();
                    
                    if (!Array.isArray(allNfts) || allNfts.length === 0) {
                        showError(gallery, "Metadata is empty or in the wrong format.");
                        return;
                    }

                    console.log(`Loaded ${allNfts.length} NFTs successfully.`);
                    
                    updateGenderFilterCounts();
                    populatePlanetFilters();
                    populateTraitFilters();
                    populateTraitToggles();
                    applyFiltersAndSort();

                } catch (error) {
                    console.error("Failed to load or parse metadata:", error);
                    showError(gallery, "Could not load metadata from the source. Please check that the 'all_nfts_metadata.json' file exists and is public in your GitHub repository.");
                }
            };

            const updateGenderFilterCounts = () => {
                const maleCount = allNfts.filter(nft => nft.attributes.some(attr => attr.trait_type === 'Inhabitant' && attr.value.endsWith(' M'))).length;
                const femaleCount = allNfts.filter(nft => nft.attributes.some(attr => attr.trait_type === 'Inhabitant' && attr.value.endsWith(' F'))).length;
                genderFilter.options[1].textContent = `Male (${maleCount})`;
                genderFilter.options[2].textContent = `Female (${femaleCount})`;
            };

            const populatePlanetFilters = () => {
                const planetNames = [...new Set(allNfts.map(nft => {
                    const planetAttr = nft.attributes.find(a => a.trait_type === 'Planet');
                    if (!planetAttr) return null;
                    return planetAttr.value.replace(/ (North|South|East|West)$/, '');
                }).filter(Boolean))].sort();

                planetFiltersContainer.innerHTML = '';
                planetNames.forEach(planetName => {
                    const container = document.createElement('div');
                    const hasDirections = allNfts.some(nft => nft.attributes.some(a => a.trait_type === 'Planet' && a.value.startsWith(planetName + ' ')));
                    container.innerHTML = `<div class="flex items-center justify-between"><label class="toggle-label"><input type="checkbox" class="toggle-checkbox planet-toggle-cb" data-planet="${planetName}"><span class="toggle-switch mr-2"></span><span class="font-medium">${planetName}</span></label><div class="direction-slider-container"><span class="text-xs ${hasDirections ? 'text-gray-400' : 'text-gray-600'}">N</span><input type="range" min="0" max="2" value="1" class="direction-slider" data-planet-direction="${planetName}" ${!hasDirections ? 'disabled' : ''}><span class="text-xs ${hasDirections ? 'text-gray-400' : 'text-gray-600'}">S</span></div></div>`;
                    planetFiltersContainer.appendChild(container);
                });

                document.querySelectorAll('.planet-toggle-cb, .direction-slider').forEach(el => el.addEventListener('change', applyFiltersAndSort));
            };
            
            const populateTraitFilters = () => {
                const genderContainer = document.getElementById('gender-filter-container');
                traitFiltersContainer.innerHTML = '';
                traitFiltersContainer.appendChild(genderContainer);

                const traitValueCounts = {};
                allNfts.forEach(nft => {
                    if(nft.attributes) {
                        nft.attributes.forEach(attr => {
                            if (!traitValueCounts[attr.trait_type]) {
                                traitValueCounts[attr.trait_type] = {};
                            }
                            traitValueCounts[attr.trait_type][attr.value] = (traitValueCounts[attr.trait_type][attr.value] || 0) + 1;
                        });
                    }
                });

                traitOrder.forEach(traitType => {
                    if (traitType === 'Inhabitant' || traitType === 'Planet') return;
                    const uniqueValues = Object.keys(traitValueCounts[traitType] || {});
                    
                    if (traitType === 'Rarity') {
                        uniqueValues.sort((a, b) => Number(b) - Number(a));
                    } else if (traitType === 'Object') {
                        uniqueValues.sort((a, b) => traitValueCounts[traitType][a] - traitValueCounts[traitType][b]);
                        const phoenixIndex = uniqueValues.indexOf('Phoenix Rising');
                        if (phoenixIndex > -1) {
                            const [phoenixRising] = uniqueValues.splice(phoenixIndex, 1);
                            uniqueValues.unshift(phoenixRising);
                        }
                    } else {
                        uniqueValues.sort();
                    }

                    const selectWrapper = document.createElement('div');
                    let optionsHtml = `<option value="all">All ${traitType}s</option>`;
                    uniqueValues.forEach(value => {
                        const count = traitValueCounts[traitType][value];
                        const style = value === 'Phoenix Rising' ? 'style="color: #f97316; font-weight: bold;"' : '';
                        optionsHtml += `<option value="${value}" ${style}>${value} (${count})</option>`;
                    });
                    
                    let labelHtml = `<label for="filter-${traitType}" class="block text-sm font-medium text-gray-300 mb-1">${traitType}</label>`;
                    if (traitType === 'Rarity') {
                        labelHtml = `<label for="filter-${traitType}" class="block text-sm font-medium text-gray-300 mb-1">${traitType} <span class="text-xs text-gray-400 font-normal">(40 = rarest)</span></label>`;
                    }
                    selectWrapper.innerHTML = `${labelHtml}<select id="filter-${traitType}" data-trait="${traitType}" class="form-select w-full trait-filter">${optionsHtml}</select>`;
                    traitFiltersContainer.insertBefore(selectWrapper, genderContainer);
                });
                document.querySelectorAll('.trait-filter').forEach(el => el.addEventListener('change', applyFiltersAndSort));
            };

            const populateTraitToggles = () => {
                traitTogglesContainer.innerHTML = '';
                traitOrder.forEach(traitType => {
                    const toggleId = `toggle-${traitType.toLowerCase().replace(' ', '-')}`;
                    const isChecked = defaultTraitsOn.includes(traitType);
                    const label = document.createElement('label');
                    label.className = 'toggle-label';
                    label.innerHTML = `<input type="checkbox" id="${toggleId}" class="toggle-checkbox trait-toggle" data-trait="${traitType}" ${isChecked ? 'checked' : ''}><span class="toggle-switch mr-2"></span><span>${traitType}</span>`;
                    traitTogglesContainer.appendChild(label);
                });
                document.querySelectorAll('.trait-toggle').forEach(el => el.addEventListener('change', () => displayPage(currentPage)));
            };

            const applyFiltersAndSort = () => {
                let tempNfts = [...allNfts];
                const activePlanetFilters = [];
                document.querySelectorAll('.planet-toggle-cb:checked').forEach(cb => {
                    const planetName = cb.dataset.planet;
                    const slider = document.querySelector(`.direction-slider[data-planet-direction="${planetName}"]`);
                    activePlanetFilters.push({ name: planetName, direction: slider.value });
                });

                if (activePlanetFilters.length > 0) {
                    tempNfts = tempNfts.filter(nft => {
                        const planetAttr = nft.attributes.find(a => a.trait_type === 'Planet');
                        if (!planetAttr) return false;
                        return activePlanetFilters.some(filter => {
                            const planetValue = planetAttr.value;
                            if (filter.direction === '1') return planetValue.startsWith(filter.name);
                            if (filter.direction === '0') return planetValue === `${filter.name} North`;
                            if (filter.direction === '2') return planetValue === `${filter.name} South`;
                            return false;
                        });
                    });
                }
                
                const searchTerm = searchInput.value;
                if (searchTerm) tempNfts = tempNfts.filter(nft => nft.id.toString() === searchTerm);

                const selectedGender = genderFilter.value;
                if (selectedGender !== 'all') {
                    tempNfts = tempNfts.filter(nft => {
                        const inhabitantAttr = nft.attributes.find(attr => attr.trait_type === 'Inhabitant');
                        if (!inhabitantAttr) return false;
                        if (selectedGender === 'male') return inhabitantAttr.value.endsWith(' M');
                        if (selectedGender === 'female') return inhabitantAttr.value.endsWith(' F');
                        return false;
                    });
                }

                document.querySelectorAll('.trait-filter').forEach(select => {
                    const trait = select.dataset.trait;
                    const value = select.value;
                    if (value !== 'all') {
                        tempNfts = tempNfts.filter(nft => nft.attributes.some(attr => attr.trait_type === trait && attr.value.toString() === value));
                    }
                });

                const sortValue = raritySort.value;
                if (sortValue !== 'none') {
                    tempNfts.sort((a, b) => {
                        const rarityA = a.attributes.find(attr => attr.trait_type === 'Rarity')?.value || 0;
                        const rarityB = b.attributes.find(attr => attr.trait_type === 'Rarity')?.value || 0;
                        return sortValue === 'asc' ? rarityA - rarityB : rarityB - rarityA;
                    });
                }

                filteredNfts = tempNfts;
                resultsCount.textContent = `${filteredNfts.length} NFTs found.`;
                displayPage(1);
            };

            const displayPage = (page) => {
                currentPage = page;
                gallery.innerHTML = '';
                if (filteredNfts.length === 0) {
                    showLoading(gallery, 'No NFTs match the current filters.');
                    updatePaginationControls(0);
                    return;
                }
                const totalPages = Math.ceil(filteredNfts.length / itemsPerPage);
                const pageItems = filteredNfts.slice((page - 1) * itemsPerPage, page * itemsPerPage);
                pageItems.forEach(nft => gallery.appendChild(createNftCard(nft)));
                updatePaginationControls(totalPages);
            };

            const createNftCard = (nft) => {
                const card = document.createElement('div');
                card.className = 'nft-card bg-gray-800 border border-gray-700 rounded-xl overflow-hidden flex flex-col';
                // Use thumbnail_image for the gallery view
                const imageUrl = convertIpfsUrl(nft.thumbnail_image || nft.image); 
                const traitsHtml = nft.attributes
                    .filter(attr => document.querySelector(`.trait-toggle[data-trait="${attr.trait_type}"]`)?.checked)
                    .sort((a, b) => traitOrder.indexOf(a.trait_type) - traitOrder.indexOf(b.trait_type))
                    .map(attr => `<li class="flex justify-between items-center py-2 px-1 border-b border-gray-700 last:border-b-0"><span class="text-xs font-medium text-cyan-400 uppercase">${attr.trait_type}</span><span class="text-sm font-semibold text-gray-100">${attr.value}</span></li>`).join('');
                card.innerHTML = `<div class="aspect-w-1-aspect-h-1 w-full"><img src="${imageUrl}" alt="${nft.name}" class="w-full h-full" loading="lazy" onerror="this.onerror=null; this.src='https://placehold.co/300x300/1f2937/e5e7eb?text=Image+Error';"></div><div class="p-4 flex-grow flex flex-col"><h2 class="text-lg font-bold text-white mb-3 truncate" title="${nft.name}">${nft.name}</h2><ul class="text-sm flex-grow">${traitsHtml}</ul></div>`;
                return card;
            };

            const updatePaginationControls = (totalPages) => {
                paginationControls.innerHTML = '';
                if (totalPages <= 1) return;
                const prevButton = document.createElement('button');
                prevButton.textContent = 'Previous';
                prevButton.className = 'pagination-btn';
                prevButton.disabled = currentPage === 1;
                prevButton.onclick = () => displayPage(currentPage - 1);
                paginationControls.appendChild(prevButton);
                const pageInfo = document.createElement('span');
                pageInfo.className = 'text-gray-400';
                pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
                paginationControls.appendChild(pageInfo);
                const nextButton = document.createElement('button');
                nextButton.textContent = 'Next';
                nextButton.className = 'pagination-btn';
                nextButton.disabled = currentPage === totalPages;
                nextButton.onclick = () => displayPage(currentPage + 1);
                paginationControls.appendChild(nextButton);
            };

            const resetAll = () => {
                searchInput.value = '';
                raritySort.value = 'desc';
                genderFilter.value = 'all';
                document.querySelectorAll('.trait-filter').forEach(select => select.value = 'all');
                document.querySelectorAll('.trait-toggle').forEach(toggle => {
                    toggle.checked = defaultTraitsOn.includes(toggle.dataset.trait);
                });
                document.querySelectorAll('.planet-toggle-cb').forEach(cb => cb.checked = false);
                document.querySelectorAll('.direction-slider').forEach(slider => slider.value = 1);
                applyFiltersAndSort();
            };

            searchInput.addEventListener('input', applyFiltersAndSort);
            raritySort.addEventListener('change', applyFiltersAndSort);
            genderFilter.addEventListener('change', applyFiltersAndSort);
            resetButton.addEventListener('click', resetAll);
            
            initializeExplorer();
        });
    </script>

</body>
</html>
