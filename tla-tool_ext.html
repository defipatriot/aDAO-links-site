<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TLA Admin (Extensions) | Alliance DAO</title>
<meta name="description" content="Internal admin tool for TLA extension data - Votion, PD Bribes, historical tracking. Not the public dashboard.">
<meta name="robots" content="noindex, nofollow">

<!-- Favicon -->
<link rel="icon" type="image/x-icon" href="https://raw.githubusercontent.com/defipatriot/aDAO-Image-Files/main/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://raw.githubusercontent.com/defipatriot/aDAO-Image-Files/main/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://raw.githubusercontent.com/defipatriot/aDAO-Image-Files/main/favicon-32x32.png">
<link rel="apple-touch-icon" sizes="180x180" href="https://raw.githubusercontent.com/defipatriot/aDAO-Image-Files/main/apple-touch-icon.png">

<!-- OG Meta -->
<meta property="og:title" content="TLA Admin Extensions | Alliance DAO">
<meta property="og:description" content="Internal admin tool for TLA extension data collection">
<meta property="og:image" content="https://raw.githubusercontent.com/defipatriot/aDAO-Image-Files/main/android-chrome-512x512.png">
<meta property="og:type" content="website">

<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<!-- Vercel Analytics -->
<script defer src="/_vercel/insights/script.js"></script>
<style>
    body { font-family: 'Inter', monospace; background: #0D0D0D; color: #EAEAEA; }
    .input-dark { background: #1A1A1A; border: 1px solid #333; color: white; padding: 8px; border-radius: 6px; width: 100%; font-family: monospace; font-size: 0.75rem; resize: vertical; }
    .input-dark:focus { border-color: #2dd4bf; outline: none; }
    .tab-btn { padding: 8px 16px; border-radius: 6px; font-weight: 600; cursor: pointer; background: #1f2937; border: 1px solid #374151; color: #9ca3af; font-size: 0.8rem; transition: all 0.2s; display: flex; align-items: center; gap: 6px; }
    .tab-btn:hover { background: #374151; color: white; }
    .tab-btn.active { background: #2dd4bf; color: #000; border-color: #2dd4bf; }
    .tab-btn.active .tab-status { color: #000; }
    
    /* Tab status indicators */
    .tab-status { font-size: 10px; }
    .tab-incomplete .tab-status { color: #ef4444; }
    .tab-complete .tab-status { color: #22c55e; }
    .tab-partial .tab-status { color: #eab308; }
    .tab-optional .tab-status { color: #6b7280; }
    .tab-optional { color: #6b7280 !important; }
    
    /* Complete tab styling */
    .tab-btn.tab-complete { background: #14532d; border-color: #22c55e; color: #86efac; }
    .tab-btn.tab-complete:hover { background: #166534; }
    .tab-btn.tab-complete.active { background: #22c55e; color: #000; }
    
    /* Incomplete tab styling */
    .tab-btn.tab-incomplete { background: #450a0a; border-color: #b91c1c; color: #fca5a5; }
    .tab-btn.tab-incomplete:hover { background: #7f1d1d; }
    .tab-btn.tab-incomplete.active { background: #ef4444; color: #000; border-color: #ef4444; }
    
    /* Partial tab styling */
    .tab-btn.tab-partial { background: #422006; border-color: #a16207; color: #fde047; }
    .tab-btn.tab-partial:hover { background: #713f12; }
    .tab-btn.tab-partial.active { background: #eab308; color: #000; border-color: #eab308; }
    
    .workspace { display: none !important; } .workspace.active { display: block !important; }
    .preview-card { background: #111; border: 1px solid #333; border-radius: 8px; padding: 16px; }
    .btn-action { background: #333; color: white; padding: 6px; border-radius: 6px; font-size: 0.75rem; width: 100%; margin-top: 8px; transition: 0.2s; font-weight: 600; }
    .btn-action:hover { background: #444; }
    .custom-scroll::-webkit-scrollbar { width: 6px; }
    .custom-scroll::-webkit-scrollbar-track { background: #0d0d0d; }
    .custom-scroll::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
    .status-done { background: #065f46 !important; border-color: #10b981 !important; color: #6ee7b7 !important; }
</style>
</head>
<body class="p-4 w-full max-w-[1600px] mx-auto min-h-screen flex flex-col">

<!-- ADMIN TOOL NOTICE -->
<div class="bg-amber-900/30 border border-amber-600/50 rounded-lg px-4 py-2 mb-4 flex items-center gap-3">
    <i class="fas fa-tools text-amber-400"></i>
    <div class="flex-grow">
        <span class="text-amber-400 font-bold text-xs">INTERNAL ADMIN TOOL</span>
        <span class="text-amber-200/70 text-xs ml-2">Extension data (Votion, PD Bribes, Historical). Looking for the dashboard?</span>
    </div>
    <a href="https://www.thealliancedao.com/tla-stats.html" target="_blank" class="bg-cyan-600 hover:bg-cyan-500 text-white px-3 py-1 rounded text-xs font-bold transition-colors flex items-center gap-1">
        <i class="fas fa-chart-line"></i> View TLA Stats
    </a>
</div>

<!-- HEADER -->
<header class="flex flex-col gap-4 mb-4 pb-4 border-b border-gray-800">
    <div class="flex justify-between items-start">
        <div class="flex flex-col">
            <h1 class="text-xl font-bold text-teal-400 flex items-center gap-2">
                <i class="fas fa-puzzle-piece"></i> TLA Admin <span class="text-gray-500 text-sm">Extensions</span>
            </h1>
            <div class="flex gap-4 mt-1 text-[10px] font-mono text-gray-500">
                <span class="flex items-center gap-1"><i class="far fa-clock text-teal-600"></i> Target Epoch: <span id="target-epoch" class="text-white font-bold">...</span></span>
                <span class="text-gray-600">|</span>
                <span class="flex items-center gap-1">Phase: <span id="target-phase" class="text-yellow-400 font-bold">...</span></span>
                <span class="text-gray-600">|</span>
                <span class="flex items-center gap-1">Status: <span id="status-indicator" class="text-gray-400">Idle</span></span>
            </div>
        </div>
        
        <!-- Global Actions -->
        <div class="flex gap-2">
            <button onclick="clearAll()" class="bg-red-900/20 hover:bg-red-900/40 text-red-400 border border-red-900/50 px-3 py-1.5 rounded text-xs font-bold transition-colors">Clear All</button>
            <button onclick="downloadExtJson()" class="bg-teal-900/50 hover:bg-teal-800 text-teal-200 border border-teal-700 px-3 py-1.5 rounded text-xs font-bold transition-colors">Download JSON</button>
            <a href="https://github.com/defipatriot/tla-ext_json_storage" target="_blank" class="bg-gray-700 hover:bg-gray-600 text-white px-3 py-1.5 rounded text-xs font-bold transition-colors flex items-center gap-1">
                <i class="fab fa-github"></i> GitHub
            </a>
        </div>
    </div>
</header>

<!-- Upload Reminder Banner -->
<div class="bg-orange-900/20 border border-orange-700/50 rounded px-4 py-2 mb-4 flex items-center gap-3">
    <i class="fas fa-upload text-orange-400"></i>
    <div class="text-[10px] text-orange-300">
        <span class="font-bold">Remember:</span> Upload 2 files to GitHub → 
        <span class="text-white">tla-ext-{epoch}-{phase}.json</span> + 
        <span class="text-white">Staking APR.csv</span> (if stale)
    </div>
</div>

<!-- CONFIG BAR -->
<div class="bg-[#161616] border border-gray-800 rounded-lg p-3 mb-4">
    <div class="flex items-center gap-4 mb-3">
        <div class="flex-shrink-0 text-teal-500 text-xl"><i class="fas fa-sliders-h"></i></div>
        <div class="flex-grow">
            <h3 class="text-xs font-bold text-gray-400 uppercase">Epoch Configuration</h3>
            <p class="text-[10px] text-gray-600">Auto-detected from TLA. Verify before exporting.</p>
        </div>
        
        <!-- Live Epoch Info -->
        <div class="flex items-center gap-3 bg-[#0D0D0D] rounded px-3 py-2 border border-gray-700">
            <div class="flex flex-col items-center">
                <span class="text-[8px] text-gray-500 uppercase">Live Epoch</span>
                <span id="live-epoch" class="text-sm font-mono font-bold text-teal-400">...</span>
            </div>
            <div class="flex flex-col items-center border-l border-gray-700 pl-3">
                <span class="text-[8px] text-gray-500 uppercase">Ends In</span>
                <span id="live-ends" class="text-sm font-mono font-bold text-yellow-400">...</span>
            </div>
            <div class="flex flex-col items-center border-l border-gray-700 pl-3">
                <span class="text-[8px] text-gray-500 uppercase">Auto Phase</span>
                <span id="live-phase" class="text-sm font-mono font-bold text-orange-400">...</span>
            </div>
            <button onclick="fetchLiveEpochInfo()" class="ml-2 text-teal-400 hover:text-teal-300 text-[10px]" title="Refresh live epoch info">
                <i class="fas fa-sync-alt"></i>
            </button>
        </div>
        
        <!-- Working Epoch Selection -->
        <div class="flex items-center gap-2 bg-[#0D0D0D] rounded px-3 py-2 border border-teal-900/50">
            <span class="text-[9px] text-gray-400 uppercase">Working:</span>
            <input type="number" id="extEpoch" placeholder="Ep" class="input-dark w-16 text-center font-mono text-sm" onchange="updateMeta()">
            <select id="extPhase" class="input-dark w-20 text-xs" onchange="updateMeta()">
                <option value="end">End</option>
                <option value="mid">Mid</option>
                <option value="start">Start</option>
            </select>
            <button onclick="syncToLive()" class="text-[9px] text-teal-400 hover:text-teal-300 border border-teal-900 rounded px-2 py-1" title="Sync to live epoch">
                ← Sync
            </button>
        </div>
        
        <!-- Mismatch Warning -->
        <div id="epoch-mismatch-warning" class="hidden bg-red-900/30 border border-red-700 rounded px-3 py-2 text-[10px] text-red-300">
            <i class="fas fa-exclamation-triangle mr-1"></i>
            <span id="mismatch-text">Working epoch doesn't match live!</span>
        </div>
        
        <!-- Mode Toggle -->
        <div class="border-l border-gray-700 pl-4 flex items-center gap-2">
            <span class="text-[9px] text-gray-500 uppercase">Mode:</span>
            <button id="mode-staging" onclick="setMode('staging')" class="px-2 py-1 text-[10px] rounded bg-yellow-900/50 text-yellow-400 border border-yellow-700">Staging</button>
            <button id="mode-normal" onclick="setMode('normal')" class="px-2 py-1 text-[10px] rounded bg-gray-800 text-gray-500 border border-gray-700">Normal</button>
        </div>
    </div>
    
    <!-- Second Row: Load Previous + Fetch Status -->
    <div class="grid grid-cols-8 gap-2 text-[9px]">
        <!-- Load Previous Ext File -->
        <div class="col-span-2 bg-[#0D0D0D] rounded p-2 border border-purple-900/50">
            <div class="flex items-center justify-between mb-1">
                <span class="text-purple-400 font-bold uppercase text-[8px]">Load Previous Ext</span>
                <label class="text-purple-300 hover:text-purple-200 cursor-pointer">
                    <i class="fas fa-upload"></i>
                    <input type="file" accept=".json" class="hidden" onchange="loadPreviousExt(event)">
                </label>
            </div>
            <div id="prev-ext-status" class="text-gray-600 text-[9px] truncate">No file loaded</div>
        </div>
        
        <!-- Fetch Status Indicators -->
        <div class="bg-[#0D0D0D] rounded p-2 flex items-center justify-between">
            <span class="text-gray-500">LP Registry</span>
            <span id="fetch-lp" class="text-gray-600">-</span>
        </div>
        <div class="bg-[#0D0D0D] rounded p-2 flex items-center justify-between">
            <span class="text-gray-500">Staging</span>
            <span id="fetch-staging" class="text-gray-600">-</span>
        </div>
        <div class="bg-[#0D0D0D] rounded p-2 flex items-center justify-between">
            <span class="text-gray-500">Historical</span>
            <span id="fetch-historical" class="text-gray-600">-</span>
        </div>
        <div class="bg-[#0D0D0D] rounded p-2 flex items-center justify-between">
            <span class="text-gray-500">Current</span>
            <span id="fetch-current" class="text-gray-600">-</span>
        </div>
        <div class="bg-[#0D0D0D] rounded p-2 flex items-center justify-between">
            <span class="text-gray-500">PD Bribes</span>
            <span id="fetch-pd" class="text-gray-600">-</span>
        </div>
        <button onclick="fetchAllFromGithub()" class="bg-teal-900/30 text-teal-400 rounded p-2 hover:bg-teal-900/50 border border-teal-900/50">
            ⟳ Fetch All
        </button>
    </div>
</div>

<!-- TABS -->
<div class="flex gap-2 mb-4 border-b border-gray-800 pb-1 overflow-x-auto">
    <div id="tab-lpreg" class="tab-btn active tab-incomplete" onclick="switchTab('lpreg')">
        <span class="tab-status">●</span> 1. LP Registry
    </div>
    <div id="tab-ratios" class="tab-btn tab-incomplete" onclick="switchTab('ratios')">
        <span class="tab-status">●</span> 2. Ratios
    </div>
    <div id="tab-prices" class="tab-btn tab-incomplete" onclick="switchTab('prices')">
        <span class="tab-status">●</span> 3. Prices
    </div>
    <div id="tab-votion" class="tab-btn tab-incomplete" onclick="switchTab('votion')">
        <span class="tab-status">●</span> 4. Votion
    </div>
    <div id="tab-pdbribes" class="tab-btn tab-incomplete" onclick="switchTab('pdbribes')">
        <span class="tab-status">●</span> 5. PD Bribes
    </div>
    <div id="tab-dashboard" class="tab-btn tab-incomplete" onclick="switchTab('dashboard')">
        <span class="tab-status">●</span> 6. Dashboard
    </div>
    <div id="tab-nft" class="tab-btn tab-incomplete" onclick="switchTab('nft')">
        <span class="tab-status">●</span> 7. NFT Stats
    </div>
    <div id="tab-news" class="tab-btn tab-incomplete" onclick="switchTab('news')">
        <span class="tab-status">●</span> 8. News
    </div>
    <div id="tab-dao" class="tab-btn tab-incomplete" onclick="switchTab('dao')">
        <span class="tab-status">●</span> 9. DAO
    </div>
    <div id="tab-astro" class="tab-btn tab-optional" onclick="switchTab('astro')">
        <span class="tab-status">○</span> 10. Astroport
    </div>
    <div id="tab-ww" class="tab-btn tab-optional" onclick="switchTab('ww')">
        <span class="tab-status">○</span> 11. Skeleton
    </div>
</div>

<!-- WS 0: LP REGISTRY -->
<div id="ws-lpreg" class="workspace active">
    <div class="grid grid-cols-12 gap-4 mb-4">
        <!-- Parse Vote Tab -->
        <div class="col-span-6 bg-[#161616] p-3 rounded border border-gray-800 flex flex-col gap-2">
            <div class="flex justify-between items-center">
                <h3 class="text-teal-400 font-bold text-xs">Paste TLA Vote Tab</h3>
                <button onclick="openPreviewModal('https://www.erisprotocol.com/terra/liquidity-hub?tab=vote', 'TLA Vote Tab')" class="text-[9px] text-cyan-400 hover:text-cyan-300 bg-cyan-900/30 px-2 py-0.5 rounded border border-cyan-900/50">
                    <i class="fas fa-external-link-alt mr-1"></i> TLA Vote Tab
                </button>
            </div>
            <textarea id="voteTabPaste" class="input-dark h-48 font-mono text-[9px]" placeholder="Copy entire Vote tab from TLA Core..."></textarea>
            <div class="flex gap-2">
                <button onclick="parseVoteTab()" class="btn-action flex-1 bg-teal-900/40 text-teal-200 border border-teal-900">Parse Vote Tab</button>
                <button onclick="clearPaste('voteTabPaste')" class="btn-action w-20 bg-red-900/30 text-red-300 border border-red-900/50 text-[9px]">Clear</button>
            </div>
        </div>
        
        <!-- Registry Summary -->
        <div class="col-span-6 bg-[#161616] p-3 rounded border border-gray-800">
            <div class="text-[9px] text-gray-500 uppercase font-bold mb-2">LP Registry Summary</div>
            <div class="grid grid-cols-2 gap-2 text-[10px] mb-3">
                <div class="flex justify-between"><span class="text-gray-500">Total LPs:</span><span id="lp-total" class="text-white font-mono">0</span></div>
                <div class="flex justify-between"><span class="text-gray-500">Active (>1%):</span><span id="lp-active" class="text-green-400 font-mono">0</span></div>
                <div class="flex justify-between"><span class="text-gray-500">Astroport:</span><span id="lp-astro" class="text-cyan-400 font-mono">0</span></div>
                <div class="flex justify-between"><span class="text-gray-500">Skeleton Swap:</span><span id="lp-ww" class="text-blue-400 font-mono">0</span></div>
            </div>
            <div class="border-t border-gray-700 pt-2 flex gap-2">
                <button onclick="exportLpRegistry()" class="btn-action flex-1 bg-green-900/30 text-green-300 border border-green-900/50 text-[10px]">Export Registry</button>
                <button onclick="loadLpRegistryPaste()" class="btn-action flex-1 bg-blue-900/30 text-blue-300 border border-blue-900/50 text-[10px]">Load from JSON</button>
            </div>
        </div>
    </div>
    
    <!-- LP List by Bucket -->
    <div class="preview-card">
        <div class="flex justify-between items-center mb-2 border-b border-gray-800 pb-2">
            <div class="flex items-center gap-3">
                <h3 class="text-xs font-bold text-white">LP Registry</h3>
                <span id="lp-scroll-hint" class="text-[9px] text-yellow-400 bg-yellow-900/30 px-2 py-0.5 rounded border border-yellow-700">⚠ Scroll to bottom to verify & complete</span>
            </div>
            <div class="flex gap-4 text-[9px]">
                <label class="flex items-center gap-1 cursor-pointer">
                    <input type="checkbox" id="filter-active" onchange="renderLpRegistry()">
                    <span class="text-gray-400">Active Only</span>
                </label>
                <label class="flex items-center gap-1 cursor-pointer">
                    <input type="checkbox" id="filter-astro" checked onchange="renderLpRegistry()">
                    <span class="text-cyan-400">Astroport</span>
                </label>
                <label class="flex items-center gap-1 cursor-pointer">
                    <input type="checkbox" id="filter-ww" checked onchange="renderLpRegistry()">
                    <span class="text-blue-400">Skeleton Swap</span>
                </label>
            </div>
        </div>
        <div id="lp-registry-list" class="max-h-[500px] overflow-y-auto custom-scroll space-y-2" onscroll="checkLpRegistryScroll(this)"></div>
        <div id="lp-verify-section" class="hidden mt-3 p-3 bg-green-900/20 border border-green-700 rounded">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <span class="text-green-400 text-lg">✓</span>
                    <span class="text-green-300 text-[11px]">Scrolled to bottom - LP Registry verified!</span>
                </div>
                <button onclick="confirmLpRegistry()" class="bg-green-700 hover:bg-green-600 text-white px-3 py-1 rounded text-[10px] font-bold">Confirm & Complete Step ①</button>
            </div>
        </div>
    </div>
</div>

<!-- WS: LST RATIOS -->
<div id="ws-ratios" class="workspace">
    <!-- Header with status -->
    <div class="bg-[#161616] border border-teal-900/50 rounded-lg p-4 mb-4">
        <div class="flex justify-between items-center mb-3">
            <div class="flex items-center gap-3">
                <i class="fas fa-exchange-alt text-teal-400 text-xl"></i>
                <div>
                    <h2 class="text-teal-400 font-bold text-sm">LST Ratios & Chain Staking</h2>
                    <p class="text-gray-500 text-[10px]">Track liquid staking token ratios and APYs for snapshot export</p>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <button id="lst-all-status" onclick="togglePricesOverride()" class="px-3 py-1 rounded text-[10px] font-bold bg-red-900/30 text-red-400 border border-red-700 cursor-pointer hover:opacity-80" title="Click to override and mark complete">
                    <i class="fas fa-exclamation-circle mr-1"></i> Incomplete
                </button>
                <button onclick="fetchAllLstRatiosFromChain()" class="bg-green-900/30 hover:bg-green-900/50 text-green-400 px-3 py-1.5 rounded text-[10px] border border-green-900/50 font-bold">
                    <i class="fas fa-bolt mr-1"></i> Auto-Fetch All Ratios
                </button>
                <button onclick="fetchChainStakingApr()" class="bg-teal-900/30 hover:bg-teal-900/50 text-teal-400 px-3 py-1.5 rounded text-[10px] border border-teal-900/50">
                    <i class="fas fa-sync-alt mr-1"></i> Fetch APR
                </button>
            </div>
        </div>
        
        <!-- Chain Staking APR -->
        <div class="grid grid-cols-3 gap-4 mb-4">
            <div class="bg-[#0D0D0D] rounded-lg p-3 border border-yellow-900/50">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-yellow-400 text-[10px] font-bold uppercase">Chain Staking APR</span>
                    <button onclick="openPreviewModal('https://analytics.smartstake.io/terra/stats/staking', 'Smart Stake APR')" class="text-[9px] text-cyan-400 hover:text-cyan-300 bg-cyan-900/30 px-2 py-0.5 rounded cursor-pointer">
                        <i class="fas fa-external-link-alt mr-1"></i> Smart Stake
                    </button>
                </div>
                <div class="flex items-baseline gap-2">
                    <input type="number" id="lst-chain-apr" step="0.01" class="input-dark text-xl font-bold w-24 text-center text-yellow-400" placeholder="" onchange="updateLstRatio('chainStakingApr', this.value)">
                    <span class="text-yellow-400 text-lg">%</span>
                </div>
                <div id="lst-chain-apr-date" class="text-[9px] text-gray-600 mt-1">Last: --</div>
            </div>
            <div class="col-span-2 bg-[#0D0D0D] rounded-lg p-3 border border-gray-800">
                <div class="text-[9px] text-gray-500 uppercase font-bold mb-2">Auto-Fetch Info</div>
                <div class="text-[10px] text-gray-400 space-y-1">
                    <p><span class="text-green-400">✓ Auto-Fetch:</span> ampLUNA, arbLUNA, bLUNA, ampROAR, ampCAPA (from chain contracts)</p>
                    <p><span class="text-blue-400">Manual:</span> xASTRO ratio + all APYs (paste from Eris/Astroport)</p>
                    <p><span class="text-yellow-400">Staking APR:</span> Download CSV from Smart Stake → Upload to GitHub</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- LST Ratio Cards -->
    <div class="grid grid-cols-3 gap-4 mb-4">
        <!-- ampLUNA - AUTO-FETCH -->
        <div id="lst-card-ampLUNA" class="bg-[#161616] rounded-lg p-3 border-2 border-gray-700">
            <div class="flex justify-between items-center mb-1">
                <div class="flex items-center gap-2">
                    <img src="https://raw.githubusercontent.com/defipatriot/aDAO-Image-Files/refs/heads/main/logos/ampLUNA.png" class="w-6 h-6 rounded-full" onerror="this.style.display='none'">
                    <span class="text-teal-400 font-bold text-sm">ampLUNA</span>
                </div>
                <button onclick="openPreviewModal('https://www.erisprotocol.com/terra/amplifier/LUNA', 'ampLUNA - Eris')" class="text-[9px] text-teal-400 hover:text-teal-300 bg-teal-900/30 px-2 py-0.5 rounded border border-teal-900/50 cursor-pointer">
                    <i class="fas fa-external-link-alt mr-1"></i> Eris
                </button>
            </div>
            <div class="flex items-center gap-2 mb-2">
                <span class="text-[8px] bg-green-900/50 text-green-400 px-1.5 py-0.5 rounded border border-green-700">⚡ AUTO-FETCH</span>
                <div id="lst-status-ampLUNA" class="text-[9px] px-2 py-0.5 rounded bg-gray-800 text-gray-500 flex-1 text-center">pending</div>
            </div>
            <div class="flex items-center gap-2 mb-2">
                <span class="text-[10px] text-gray-500">1 ampLUNA =</span>
                <input type="number" id="lst-ratio-ampLUNA" step="0.0001" class="input-dark w-24 text-center font-mono" placeholder="" onchange="updateLstRatio('ampLUNA', this.value)">
                <span class="text-[10px] text-gray-400">LUNA</span>
            </div>
            <div class="flex items-center gap-2 mb-2">
                <span class="text-[8px] bg-red-900/50 text-red-400 px-1.5 py-0.5 rounded border border-red-700">✎ MANUAL</span>
                <span class="text-[10px] text-gray-500">APY:</span>
                <input type="number" id="lst-apy-ampLUNA" step="0.01" class="input-dark w-20 text-center font-mono text-green-400" placeholder="" onchange="updateLstApy('ampLUNA', this.value)">
                <span class="text-[10px] text-gray-400">%</span>
            </div>
            <textarea id="lst-paste-ampLUNA" class="input-dark text-[9px] h-16 w-full" placeholder="Paste: Amplified APY 29.68% TVL... 1 ampLUNA = 1.9015 LUNA" onpaste="setTimeout(() => parseLstPaste('ampLUNA'), 100)"></textarea>
            <button onclick="parseLstPaste('ampLUNA')" class="btn-action text-[9px] bg-teal-900/30 text-teal-300">Parse</button>
        </div>
        
        <!-- arbLUNA - AUTO-FETCH -->
        <div id="lst-card-arbLUNA" class="bg-[#161616] rounded-lg p-3 border-2 border-gray-700">
            <div class="flex justify-between items-center mb-1">
                <div class="flex items-center gap-2">
                    <img src="https://raw.githubusercontent.com/defipatriot/aDAO-Image-Files/refs/heads/main/logos/arbLUNA.png" class="w-6 h-6 rounded-full" onerror="this.style.display='none'">
                    <span class="text-orange-400 font-bold text-sm">arbLUNA</span>
                </div>
                <button onclick="openPreviewModal('https://www.erisprotocol.com/terra/arb-vault', 'arbLUNA - Eris Arb')" class="text-[9px] text-orange-400 hover:text-orange-300 bg-orange-900/30 px-2 py-0.5 rounded border border-orange-900/50 cursor-pointer">
                    <i class="fas fa-external-link-alt mr-1"></i> Eris Arb
                </button>
            </div>
            <div class="flex items-center gap-2 mb-2">
                <span class="text-[8px] bg-green-900/50 text-green-400 px-1.5 py-0.5 rounded border border-green-700">⚡ AUTO-FETCH</span>
                <div id="lst-status-arbLUNA" class="text-[9px] px-2 py-0.5 rounded bg-gray-800 text-gray-500 flex-1 text-center">pending</div>
            </div>
            <div class="flex items-center gap-2 mb-2">
                <span class="text-[10px] text-gray-500">1 arbLUNA =</span>
                <input type="number" id="lst-ratio-arbLUNA" step="0.0001" class="input-dark w-24 text-center font-mono" placeholder="" onchange="updateLstRatio('arbLUNA', this.value)">
                <span class="text-[10px] text-gray-400">LUNA</span>
            </div>
            <div class="flex items-center gap-2 mb-2">
                <span class="text-[8px] bg-red-900/50 text-red-400 px-1.5 py-0.5 rounded border border-red-700">✎ MANUAL</span>
                <span class="text-[10px] text-gray-500">APY:</span>
                <input type="number" id="lst-apy-arbLUNA" step="0.01" class="input-dark w-20 text-center font-mono text-green-400" placeholder="" onchange="updateLstApy('arbLUNA', this.value)">
                <span class="text-[10px] text-gray-400">%</span>
            </div>
            <textarea id="lst-paste-arbLUNA" class="input-dark text-[9px] h-16 w-full" placeholder="Paste: Arbitrage APY 146.24% TVL... 1 arbLUNA = 2.6873 LUNA" onpaste="setTimeout(() => parseLstPaste('arbLUNA'), 100)"></textarea>
            <button onclick="parseLstPaste('arbLUNA')" class="btn-action text-[9px] bg-orange-900/30 text-orange-300">Parse</button>
        </div>
        
        <!-- bLUNA - AUTO-FETCH -->
        <div id="lst-card-bLUNA" class="bg-[#161616] rounded-lg p-3 border-2 border-gray-700">
            <div class="flex justify-between items-center mb-1">
                <div class="flex items-center gap-2">
                    <img src="https://raw.githubusercontent.com/defipatriot/aDAO-Image-Files/refs/heads/main/logos/bLUNA.png" class="w-6 h-6 rounded-full" onerror="this.style.display='none'">
                    <span class="text-cyan-400 font-bold text-sm">bLUNA</span>
                </div>
                <button onclick="openPreviewModal('https://app.backbonelabs.io/liquid-staking/gravedigger/phoenix-1', 'bLUNA - Backbone Labs')" class="text-[9px] text-cyan-400 hover:text-cyan-300 bg-cyan-900/30 px-2 py-0.5 rounded border border-cyan-900/50 cursor-pointer">
                    <i class="fas fa-external-link-alt mr-1"></i> Backbone
                </button>
            </div>
            <div class="flex items-center gap-2 mb-2">
                <span class="text-[8px] bg-green-900/50 text-green-400 px-1.5 py-0.5 rounded border border-green-700">⚡ AUTO-FETCH</span>
                <div id="lst-status-bLUNA" class="text-[9px] px-2 py-0.5 rounded bg-gray-800 text-gray-500 flex-1 text-center">pending</div>
            </div>
            <div class="flex items-center gap-2 mb-2">
                <span class="text-[10px] text-gray-500">1 bLUNA =</span>
                <input type="number" id="lst-ratio-bLUNA" step="0.0001" class="input-dark w-24 text-center font-mono" placeholder="" onchange="updateLstRatio('bLUNA', this.value)">
                <span class="text-[10px] text-gray-400">LUNA</span>
            </div>
            <div class="flex items-center gap-2 mb-2">
                <span class="text-[8px] bg-gray-800 text-gray-500 px-1.5 py-0.5 rounded border border-gray-700">N/A</span>
                <span class="text-[10px] text-gray-500">APY:</span>
                <input type="number" id="lst-apy-bLUNA" step="0.01" class="input-dark w-20 text-center font-mono text-gray-500" placeholder="N/A" disabled>
                <span class="text-[10px] text-gray-600">% (BBL doesn't show)</span>
            </div>
            <textarea id="lst-paste-bLUNA" class="input-dark text-[9px] h-16 w-full" placeholder="Paste: Exchange rate 1 LUNA = 0.623302 bLUNA (will auto-convert)" onpaste="setTimeout(() => parseLstPaste('bLUNA'), 100)"></textarea>
            <button onclick="parseLstPaste('bLUNA')" class="btn-action text-[9px] bg-cyan-900/30 text-cyan-300">Parse</button>
        </div>
        
        <!-- ampCAPA - AUTO-FETCH -->
        <div id="lst-card-ampCAPA" class="bg-[#161616] rounded-lg p-3 border-2 border-gray-700">
            <div class="flex justify-between items-center mb-1">
                <div class="flex items-center gap-2">
                    <img src="https://raw.githubusercontent.com/defipatriot/aDAO-Image-Files/refs/heads/main/logos/ampCAPA.png" class="w-6 h-6 rounded-full" onerror="this.style.display='none'">
                    <span class="text-purple-400 font-bold text-sm">ampCAPA</span>
                </div>
                <button onclick="openPreviewModal('https://www.erisprotocol.com/terra/amplifier/CAPA', 'ampCAPA - Eris')" class="text-[9px] text-purple-400 hover:text-purple-300 bg-purple-900/30 px-2 py-0.5 rounded border border-purple-900/50 cursor-pointer">
                    <i class="fas fa-external-link-alt mr-1"></i> Eris
                </button>
            </div>
            <div class="flex items-center gap-2 mb-2">
                <span class="text-[8px] bg-green-900/50 text-green-400 px-1.5 py-0.5 rounded border border-green-700">⚡ AUTO-FETCH</span>
                <div id="lst-status-ampCAPA" class="text-[9px] px-2 py-0.5 rounded bg-gray-800 text-gray-500 flex-1 text-center">pending</div>
            </div>
            <div class="flex items-center gap-2 mb-2">
                <span class="text-[10px] text-gray-500">1 ampCAPA =</span>
                <input type="number" id="lst-ratio-ampCAPA" step="0.0001" class="input-dark w-24 text-center font-mono" placeholder="" onchange="updateLstRatio('ampCAPA', this.value)">
                <span class="text-[10px] text-gray-400">CAPA</span>
            </div>
            <div class="flex items-center gap-2 mb-2">
                <span class="text-[8px] bg-red-900/50 text-red-400 px-1.5 py-0.5 rounded border border-red-700">✎ MANUAL</span>
                <span class="text-[10px] text-gray-500">APY:</span>
                <input type="number" id="lst-apy-ampCAPA" step="0.01" class="input-dark w-20 text-center font-mono text-green-400" placeholder="" onchange="updateLstApy('ampCAPA', this.value)">
                <span class="text-[10px] text-gray-400">%</span>
            </div>
            <textarea id="lst-paste-ampCAPA" class="input-dark text-[9px] h-16 w-full" placeholder="Paste: Amplified APY 4.83% TVL... 1 ampCAPA = 1.1055 CAPA" onpaste="setTimeout(() => parseLstPaste('ampCAPA'), 100)"></textarea>
            <button onclick="parseLstPaste('ampCAPA')" class="btn-action text-[9px] bg-purple-900/30 text-purple-300">Parse</button>
        </div>
        
        <!-- ampROAR - AUTO-FETCH -->
        <div id="lst-card-ampROAR" class="bg-[#161616] rounded-lg p-3 border-2 border-gray-700">
            <div class="flex justify-between items-center mb-1">
                <div class="flex items-center gap-2">
                    <img src="https://raw.githubusercontent.com/defipatriot/aDAO-Image-Files/refs/heads/main/logos/ampROAR.png" class="w-6 h-6 rounded-full" onerror="this.style.display='none'">
                    <span class="text-yellow-400 font-bold text-sm">ampROAR</span>
                </div>
                <button onclick="openPreviewModal('https://www.erisprotocol.com/terra/amplifier/ROAR', 'ampROAR - Eris')" class="text-[9px] text-yellow-400 hover:text-yellow-300 bg-yellow-900/30 px-2 py-0.5 rounded border border-yellow-900/50 cursor-pointer">
                    <i class="fas fa-external-link-alt mr-1"></i> Eris
                </button>
            </div>
            <div class="flex items-center gap-2 mb-2">
                <span class="text-[8px] bg-green-900/50 text-green-400 px-1.5 py-0.5 rounded border border-green-700">⚡ AUTO-FETCH</span>
                <div id="lst-status-ampROAR" class="text-[9px] px-2 py-0.5 rounded bg-gray-800 text-gray-500 flex-1 text-center">pending</div>
            </div>
            <div class="flex items-center gap-2 mb-2">
                <span class="text-[10px] text-gray-500">1 ampROAR =</span>
                <input type="number" id="lst-ratio-ampROAR" step="0.0001" class="input-dark w-24 text-center font-mono" placeholder="" onchange="updateLstRatio('ampROAR', this.value)">
                <span class="text-[10px] text-gray-400">ROAR</span>
            </div>
            <div class="flex items-center gap-2 mb-2">
                <span class="text-[8px] bg-red-900/50 text-red-400 px-1.5 py-0.5 rounded border border-red-700">✎ MANUAL</span>
                <span class="text-[10px] text-gray-500">APY:</span>
                <input type="number" id="lst-apy-ampROAR" step="0.01" class="input-dark w-20 text-center font-mono text-green-400" placeholder="" onchange="updateLstApy('ampROAR', this.value)">
                <span class="text-[10px] text-gray-400">%</span>
            </div>
            <textarea id="lst-paste-ampROAR" class="input-dark text-[9px] h-16 w-full" placeholder="Paste: Amplified APY 9.92% TVL... 1 ampROAR = 1.1087 ROAR" onpaste="setTimeout(() => parseLstPaste('ampROAR'), 100)"></textarea>
            <button onclick="parseLstPaste('ampROAR')" class="btn-action text-[9px] bg-yellow-900/30 text-yellow-300">Parse</button>
        </div>
        
        <!-- xASTRO - MANUAL ONLY -->
        <div id="lst-card-xASTRO" class="bg-[#161616] rounded-lg p-3 border-2 border-red-900/50">
            <div class="flex justify-between items-center mb-1">
                <div class="flex items-center gap-2">
                    <img src="https://raw.githubusercontent.com/defipatriot/aDAO-Image-Files/refs/heads/main/logos/xASTRO.png" class="w-6 h-6 rounded-full" onerror="this.style.display='none'">
                    <span class="text-blue-400 font-bold text-sm">xASTRO</span>
                </div>
                <button onclick="openPreviewModal('https://app.astroport.fi/governance', 'xASTRO - Astroport')" class="text-[9px] text-blue-400 hover:text-blue-300 bg-blue-900/30 px-2 py-0.5 rounded border border-blue-900/50 cursor-pointer">
                    <i class="fas fa-external-link-alt mr-1"></i> Astroport
                </button>
            </div>
            <div class="flex items-center gap-2 mb-2">
                <span class="text-[8px] bg-red-900/50 text-red-400 px-1.5 py-0.5 rounded border border-red-700">✎ ALL MANUAL</span>
                <div id="lst-status-xASTRO" class="text-[9px] px-2 py-0.5 rounded bg-gray-800 text-gray-500 flex-1 text-center">pending</div>
            </div>
            <div class="flex items-center gap-2 mb-2">
                <span class="text-[10px] text-gray-500">1 xASTRO =</span>
                <input type="number" id="lst-ratio-xASTRO" step="0.0001" class="input-dark w-24 text-center font-mono" placeholder="" onchange="updateLstRatio('xASTRO', this.value)">
                <span class="text-[10px] text-gray-400">ASTRO</span>
            </div>
            <div class="flex items-center gap-2 mb-2">
                <span class="text-[10px] text-gray-500">APY:</span>
                <input type="number" id="lst-apy-xASTRO" step="0.01" class="input-dark w-20 text-center font-mono text-green-400" placeholder="" onchange="updateLstApy('xASTRO', this.value)">
                <span class="text-[10px] text-gray-400">%</span>
            </div>
            <textarea id="lst-paste-xASTRO" class="input-dark text-[9px] h-16 w-full" placeholder="Paste: 22.49% APY 1:1.22 xASTRO:ASTRO" onpaste="setTimeout(() => parseLstPaste('xASTRO'), 100)"></textarea>
            <button onclick="parseLstPaste('xASTRO')" class="btn-action text-[9px] bg-blue-900/30 text-blue-300">Parse</button>
        </div>
    </div>
</div>

<!-- WS: TOKEN PRICES -->
<div id="ws-prices" class="workspace">
    <!-- Header -->
    <div class="bg-[#161616] border border-green-900/50 rounded-lg p-4 mb-4">
        <div class="flex justify-between items-center mb-3">
            <div class="flex items-center gap-3">
                <i class="fas fa-coins text-green-400 text-xl"></i>
                <div>
                    <h2 class="text-green-400 font-bold text-sm">Token Prices</h2>
                    <p class="text-gray-500 text-[10px]">Fetch unique token prices from CoinGecko + calculate LST prices from ratios</p>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <button onclick="openPricePreview('https://app.astroport.fi/swap?chain=terra&to=ibc%2F4B44179AC2F0BEE50C16A673B3B886398988692885B2848A1C8AEF27148B3961&from=uluna')" class="text-[9px] text-cyan-400 hover:text-cyan-300 bg-cyan-900/30 px-2 py-0.5 rounded border border-cyan-900/50" title="Check FUEL price on Astroport">
                    <i class="fas fa-external-link-alt mr-1"></i> FUEL Price
                </button>
                <button onclick="openPricePreview('https://app.astroport.fi/swap?chain=terra')" class="text-[9px] text-blue-400 hover:text-blue-300 bg-blue-900/30 px-2 py-0.5 rounded border border-blue-900/50" title="Astroport Swap">
                    <i class="fas fa-exchange-alt mr-1"></i> Astroport
                </button>
                <button id="prices-all-status" onclick="togglePricesTabOverride()" class="px-3 py-1 rounded text-[10px] font-bold bg-red-900/30 text-red-400 border border-red-700 cursor-pointer hover:opacity-80" title="Click to override">
                    <i class="fas fa-exclamation-circle mr-1"></i> 0 Tokens
                </button>
                <button onclick="fetchAllTokenPrices()" class="bg-green-900/30 hover:bg-green-900/50 text-green-400 px-3 py-1.5 rounded text-[10px] border border-green-900/50 font-bold">
                    <i class="fas fa-sync-alt mr-1"></i> Fetch All Prices
                </button>
            </div>
        </div>
        
        <!-- Price Summary -->
        <div class="grid grid-cols-5 gap-3 text-[10px]">
            <div class="bg-[#0D0D0D] rounded p-2 text-center">
                <div class="text-gray-500">LUNA</div>
                <div id="price-luna" class="text-green-400 font-mono font-bold text-lg">$--</div>
            </div>
            <div class="bg-[#0D0D0D] rounded p-2 text-center">
                <div class="text-gray-500">Unique Tokens</div>
                <div id="price-found-count" class="text-white font-mono font-bold text-lg">0</div>
            </div>
            <div class="bg-[#0D0D0D] rounded p-2 text-center">
                <div class="text-gray-500">Auto (CoinGecko)</div>
                <div id="price-cg-count" class="text-green-400 font-mono font-bold text-lg">0</div>
            </div>
            <div class="bg-[#0D0D0D] rounded p-2 text-center">
                <div class="text-gray-500">Calculated</div>
                <div id="price-calc-count" class="text-yellow-400 font-mono font-bold text-lg">0</div>
            </div>
            <div class="bg-[#0D0D0D] rounded p-2 text-center">
                <div class="text-gray-500">Manual/Skipped</div>
                <div id="price-manual-count" class="text-orange-400 font-mono font-bold text-lg">0</div>
            </div>
        </div>
    </div>
    
    <!-- Token Price Lists -->
    <div class="grid grid-cols-2 gap-4">
        <!-- Auto-Fetched Prices (CoinGecko + Calculated) -->
        <div class="preview-card">
            <div class="flex justify-between items-center mb-3 border-b border-gray-800 pb-2">
                <h3 class="text-xs font-bold text-white flex items-center gap-2">
                    <span class="text-green-400">✓</span> Auto-Fetched Prices
                </h3>
                <div class="text-[9px] text-gray-500">
                    <span class="text-green-400">●</span> CoinGecko 
                    <span class="text-yellow-400 ml-2">●</span> Calculated
                </div>
            </div>
            <div id="token-price-auto" class="space-y-1 max-h-[350px] overflow-y-auto custom-scroll">
                <div class="text-gray-500 text-[10px] text-center p-4">Click "Fetch All Prices" to load</div>
            </div>
        </div>
        
        <!-- Manual Entry / Not Found -->
        <div class="preview-card">
            <div class="flex justify-between items-center mb-3 border-b border-gray-800 pb-2">
                <h3 class="text-xs font-bold text-white flex items-center gap-2">
                    <span class="text-red-400">✗</span> Manual Entry Required
                </h3>
                <div class="text-[9px] text-gray-500">Enter price or check to skip</div>
            </div>
            
            <!-- Add Custom Token -->
            <div class="flex items-center gap-2 mb-3 p-2 bg-[#0D0D0D] rounded border border-gray-700">
                <span class="text-[10px] text-gray-400">Add Token:</span>
                <input type="text" id="custom-token-name" class="input-dark w-24 text-[10px] py-1 uppercase" placeholder="TOKEN" maxlength="12">
                <span class="text-gray-500 text-[10px]">$</span>
                <input type="number" id="custom-token-price" step="any" class="input-dark w-24 text-[10px] text-right py-1" placeholder="0.00">
                <button onclick="addCustomToken()" class="bg-green-900/30 hover:bg-green-900/50 text-green-400 px-2 py-1 rounded text-[9px] border border-green-900/50">
                    <i class="fas fa-plus mr-1"></i>Add
                </button>
            </div>
            
            <div id="token-price-manual" class="space-y-1 max-h-[300px] overflow-y-auto custom-scroll">
                <div class="text-gray-500 text-[10px] text-center p-4">Tokens not found on CoinGecko will appear here</div>
            </div>
        </div>
    </div>
</div>

<!-- Price Preview Modal -->
<div id="price-preview-modal" class="fixed inset-0 bg-black/80 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-[#1a1a1a] rounded-lg border border-gray-700 w-full max-w-4xl max-h-[80vh] flex flex-col">
        <div class="flex justify-between items-center p-3 border-b border-gray-700">
            <div class="flex items-center gap-2">
                <i class="fas fa-chart-line text-cyan-400"></i>
                <span class="text-white font-bold text-sm">Price Lookup</span>
                <a id="price-preview-link" href="#" target="_blank" class="text-[9px] text-gray-400 hover:text-gray-300">
                    <i class="fas fa-external-link-alt mr-1"></i> Open in new tab
                </a>
            </div>
            <button onclick="closePricePreview()" class="text-gray-400 hover:text-white text-xl px-2">×</button>
        </div>
        <div class="flex-1 overflow-hidden">
            <iframe id="price-preview-iframe" class="w-full h-full min-h-[500px]" src="" frameborder="0"></iframe>
        </div>
    </div>
</div>

<!-- WS: VOTION -->
<div id="ws-votion" class="workspace">
    <!-- Ratios Status + Votion Summary -->
    <div class="grid grid-cols-12 gap-4 mb-4">
        <!-- Ratios & APY Status Card -->
        <div id="votion-ratios-card" class="col-span-4 bg-[#161616] p-3 rounded border-2 border-red-700 flex flex-col gap-2">
            <div class="flex justify-between items-center">
                <span class="text-[10px] text-gray-400 font-bold">Ratios Tab Status</span>
                <button onclick="switchTab('prices')" class="text-[9px] text-teal-400 hover:text-teal-300 flex items-center gap-1 bg-teal-900/30 px-2 py-1 rounded border border-teal-900/50">
                    <i class="fas fa-cog"></i> Prices Tab
                </button>
            </div>
            <div id="votion-ratios-status" class="text-center py-1">
                <div class="text-2xl mb-1">⚠️</div>
                <div class="text-red-400 font-bold text-[11px]">NOT READY</div>
                <div class="text-gray-500 text-[9px]">Complete Prices/Ratios tab first</div>
            </div>
            <div class="grid grid-cols-2 gap-1 text-[9px] border-t border-gray-800 pt-2">
                <div class="text-gray-500 font-bold">Ratios:</div>
                <div class="text-gray-500 font-bold">APYs:</div>
                <div class="flex items-center gap-1">
                    <span id="votion-arb-ratio-status" class="text-red-400">✗</span>
                    <span class="text-orange-400">arb:</span>
                    <span id="ratioArb" class="text-white font-mono">--</span>
                </div>
                <div class="flex items-center gap-1">
                    <span id="votion-arb-apy-status" class="text-red-400">✗</span>
                    <span class="text-orange-400">arb:</span>
                    <span id="apyArb" class="text-white font-mono">--</span>
                </div>
                <div class="flex items-center gap-1">
                    <span id="votion-amp-ratio-status" class="text-red-400">✗</span>
                    <span class="text-cyan-400">amp:</span>
                    <span id="ratioAmp" class="text-white font-mono">--</span>
                </div>
                <div class="flex items-center gap-1">
                    <span id="votion-amp-apy-status" class="text-red-400">✗</span>
                    <span class="text-cyan-400">amp:</span>
                    <span id="apyAmp" class="text-white font-mono">--</span>
                </div>
            </div>
        </div>
        
        <!-- Votion Summary -->
        <div class="col-span-4 bg-[#161616] p-3 rounded border border-gray-800 flex flex-col gap-2">
            <div class="text-[9px] text-gray-500 uppercase font-bold">Votion Summary</div>
            <div class="grid grid-cols-2 gap-2 text-[10px]">
                <div><span class="text-gray-500">Lockups:</span> <span id="votion-lock-count" class="text-white font-mono">0</span></div>
                <div><span class="text-gray-500">VP:</span> <span id="votion-total-vp" class="text-teal-400 font-mono font-bold">0</span></div>
                <div><span class="text-gray-500">USD:</span> <span id="votion-total-usd" class="text-green-400 font-mono">$0</span></div>
                <div><span class="text-gray-500">Rew:</span> <span id="votion-total-rew" class="text-green-400 font-mono">$0</span></div>
            </div>
            <div class="text-[8px] text-gray-500 mt-1 border-t border-gray-700 pt-2">
                VP = LUNA × 10 (Max) | × 2 (3mo) | × 1 (1wk)
            </div>
        </div>
        
        <!-- Lockup Checklist -->
        <div class="col-span-4 bg-[#161616] p-3 rounded border border-gray-800 flex flex-col gap-2">
            <div class="flex justify-between items-center">
                <div class="text-[9px] text-gray-500 uppercase font-bold">Lockup Checklist (6 total)</div>
                <span id="votion-checklist-count" class="text-[9px] text-red-400">0/6</span>
            </div>
            <div class="grid grid-cols-2 gap-1 text-[9px]">
                <div id="votion-chk-arbmax" class="flex items-center gap-1 text-gray-600">
                    <input type="checkbox" id="votion-skip-arbmax" class="w-3 h-3" onchange="updateVotionChecklist(); updateWorkflowStatus();" title="Skip this lockup">
                    <span class="lock-status">☐</span> arbLUNA Max
                </div>
                <div id="votion-chk-ampmax" class="flex items-center gap-1 text-gray-600">
                    <input type="checkbox" id="votion-skip-ampmax" class="w-3 h-3" onchange="updateVotionChecklist(); updateWorkflowStatus();" title="Skip this lockup">
                    <span class="lock-status">☐</span> ampLUNA Max
                </div>
                <div id="votion-chk-arb3mo" class="flex items-center gap-1 text-gray-600">
                    <input type="checkbox" id="votion-skip-arb3mo" class="w-3 h-3" onchange="updateVotionChecklist(); updateWorkflowStatus();" title="Skip this lockup">
                    <span class="lock-status">☐</span> arbLUNA 3mo
                </div>
                <div id="votion-chk-amp3mo" class="flex items-center gap-1 text-gray-600">
                    <input type="checkbox" id="votion-skip-amp3mo" class="w-3 h-3" onchange="updateVotionChecklist(); updateWorkflowStatus();" title="Skip this lockup">
                    <span class="lock-status">☐</span> ampLUNA 3mo
                </div>
                <div id="votion-chk-arb1wk" class="flex items-center gap-1 text-gray-600">
                    <input type="checkbox" id="votion-skip-arb1wk" class="w-3 h-3" onchange="updateVotionChecklist(); updateWorkflowStatus();" title="Skip this lockup">
                    <span class="lock-status">☐</span> arbLUNA 1wk
                </div>
                <div id="votion-chk-amp1wk" class="flex items-center gap-1 text-gray-600">
                    <input type="checkbox" id="votion-skip-amp1wk" class="w-3 h-3" onchange="updateVotionChecklist(); updateWorkflowStatus();" title="Skip this lockup">
                    <span class="lock-status">☐</span> ampLUNA 1wk
                </div>
            </div>
            <div id="votion-confirm-section" class="hidden border-t border-gray-800 pt-2 mt-1">
                <button onclick="confirmVotionComplete()" class="w-full bg-green-900/30 hover:bg-green-900/50 text-green-400 py-2 rounded text-[10px] font-bold border border-green-700">
                    <i class="fas fa-check-circle mr-1"></i> Confirm & Complete Step ④
                </button>
            </div>
            <div class="text-[8px] text-gray-600 border-t border-gray-800 pt-1 mt-1">
                ☑ Check to skip a lockup if not enough funds
            </div>
        </div>
    </div>
    
    <!-- Votion Lockups -->
    <div class="grid grid-cols-12 gap-4 mb-4">
        <div class="col-span-12 bg-[#161616] p-3 rounded border border-teal-900/30 flex flex-col gap-2">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <span class="text-[10px] text-gray-400 font-bold">Votion Lockups</span>
                    <span class="text-gray-500 font-normal text-[9px]">(paste each lockup page separately)</span>
                </div>
                <div class="flex items-center gap-2">
                    <a href="https://votion.io" target="_blank" class="text-[9px] text-purple-400 hover:text-purple-300 bg-purple-900/30 px-2 py-0.5 rounded border border-purple-900/50">
                        <i class="fas fa-external-link-alt mr-1"></i> Votion.io
                    </a>
                    <button onclick="clearPaste('votionPaste')" class="text-[9px] text-red-400 hover:text-red-300">Clear</button>
                </div>
            </div>
            <textarea id="votionPaste" class="input-dark h-24 font-mono text-[10px]" placeholder="Ctrl+A / Ctrl+C on a Votion lockup page... each lockup has its own optimization"></textarea>
            <div class="flex gap-2">
                <button onclick="parseVotion()" class="btn-action flex-1 bg-teal-900/40 text-teal-200 border border-teal-900">Add Lockup</button>
                <button onclick="clearVotionLocks()" class="btn-action w-32 bg-red-900/30 text-red-300 border border-red-900/50">Clear All</button>
            </div>
        </div>
    </div>
    
    <!-- Lockups Grid - Each lockup as its own card with vote allocations -->
    <div id="votion-lockups" class="grid grid-cols-1 xl:grid-cols-2 gap-4">
        <div class="text-gray-600 text-[10px] italic text-center py-8 col-span-full border border-dashed border-gray-800 rounded">
            No lockups loaded. Paste each Votion lockup page and click "Add Lockup".
        </div>
    </div>
</div>

<!-- WS 2: PD BRIBES -->
<div id="ws-pdbribes" class="workspace">
    <!-- Top: Status + Fetch -->
    <div class="grid grid-cols-12 gap-4 mb-4">
        <!-- Coverage Status -->
        <div class="col-span-4 bg-[#161616] p-3 rounded border border-gray-800">
            <div class="flex justify-between items-center mb-2">
                <div class="text-[9px] text-gray-500 uppercase font-bold">Epoch Coverage</div>
                <button onclick="fetchPdBribesFromGithub()" class="text-[9px] text-teal-400 hover:text-teal-300 flex items-center gap-1">
                    <span id="pd-fetch-status">⟳</span> Fetch from GitHub
                </button>
            </div>
            <div class="flex items-center gap-3 mb-2">
                <div id="pd-coverage-light" class="w-4 h-4 rounded-full bg-gray-700 border-2 border-gray-600"></div>
                <div class="text-[10px]">
                    <span class="text-gray-500">Target Epoch:</span>
                    <span id="pd-current-epoch" class="text-white font-mono ml-1">-</span>
                </div>
            </div>
            <div class="text-[9px] text-gray-500">
                Covered: <span id="pd-covered-range" class="text-green-400 font-mono">-</span>
            </div>
            <div class="text-[9px] text-gray-500 mt-1">
                Missing: <span id="pd-missing-epochs" class="text-red-400 font-mono">-</span>
            </div>
        </div>
        
        <!-- Alert Box - shows when epoch not covered -->
        <div id="pd-alert-box" class="col-span-4 bg-red-900/30 border border-red-700 rounded p-3 hidden">
            <div class="flex items-center gap-2 mb-2">
                <div class="text-red-400 text-lg animate-pulse">⚠</div>
                <div class="text-red-300 font-bold text-[11px]">Epoch <span id="pd-alert-epoch">-</span> NOT COVERED!</div>
            </div>
            <p class="text-red-200/70 text-[9px] mb-2">Paste the new PD bribes proposal below to add coverage for this epoch.</p>
            <div class="text-[8px] text-red-400/60">
                Expected: Range covering epoch <span id="pd-alert-epoch2">-</span> (e.g., [<span id="pd-alert-range">160-163</span>])
            </div>
        </div>
        
        <!-- Success Box - shows when epoch is covered -->
        <div id="pd-success-box" class="col-span-4 bg-green-900/20 border border-green-700 rounded p-3 hidden">
            <div class="flex items-center gap-2 mb-2">
                <div class="text-green-400 text-lg">✓</div>
                <div class="text-green-300 font-bold text-[11px]">Epoch <span id="pd-success-epoch">-</span> Covered</div>
            </div>
            <p class="text-green-200/70 text-[9px]">
                Range: <span id="pd-success-range" class="font-mono">-</span>
            </p>
            <p class="text-green-200/50 text-[8px] mt-1">
                Bribes: <span id="pd-success-bribes" class="font-mono">-</span>/epoch
            </p>
            <button onclick="confirmPdBribesComplete()" class="w-full mt-2 bg-green-900/30 hover:bg-green-900/50 text-green-400 py-1 rounded text-[9px] font-bold border border-green-700">
                <i class="fas fa-check-circle mr-1"></i> Confirm & Complete Step ⑤
            </button>
        </div>
        
        <!-- Summary Stats -->
        <div class="col-span-4 bg-[#161616] p-3 rounded border border-gray-800">
            <div class="text-[9px] text-gray-500 uppercase font-bold mb-2">Master File Summary</div>
            <div class="grid grid-cols-2 gap-1 text-[10px]">
                <span class="text-gray-500">Ranges Loaded:</span>
                <span id="pd-props-count" class="text-white font-mono text-right">0</span>
                <span class="text-gray-500">Total Epochs:</span>
                <span id="pd-total-epochs" class="text-white font-mono text-right">0</span>
                <span class="text-gray-500">Avg Bribes:</span>
                <span id="pd-total-bribes" class="text-green-400 font-mono text-right">$0</span>
            </div>
            <div class="mt-2 flex gap-1">
                <button onclick="exportPdBribesJson()" class="btn-action flex-1 bg-green-900/40 text-green-200 border border-green-900 text-[9px] mt-0">Download</button>
                <button onclick="copyPdBribesJson()" class="btn-action flex-1 bg-blue-900/40 text-blue-200 border border-blue-900 text-[9px] mt-0">Copy</button>
            </div>
        </div>
    </div>
    
    <!-- Current Epoch Bribes Preview -->
    <div id="pd-current-bribes-section" class="preview-card mb-4 hidden">
        <div class="flex justify-between items-center mb-3 border-b border-gray-800 pb-2">
            <h3 class="text-xs font-bold text-white">
                <i class="fas fa-coins text-yellow-400 mr-2"></i>
                Current Epoch Bribes - <span id="pd-preview-epoch" class="text-yellow-400">-</span>
            </h3>
            <div class="text-[9px] text-gray-500">
                LUNA Price: <span id="pd-preview-luna-price" class="text-green-400 font-mono">$--</span>
            </div>
        </div>
        <div id="pd-current-bribes-grid" class="space-y-3">
            <!-- Will be populated with bribe data -->
        </div>
    </div>
    
    <!-- Add New Prop -->
    <div class="grid grid-cols-12 gap-4 mb-4">
        <div class="col-span-8 bg-[#161616] p-3 rounded border border-gray-800 flex flex-col gap-2">
            <div class="flex justify-between items-center">
                <h3 class="text-orange-400 font-bold text-xs">Add New Bribe Range <span class="text-gray-500 font-normal text-[10px]">(paste proposal text)</span></h3>
                <div class="flex items-center gap-2">
                    <a href="https://station.terra.money/proposal/alliance/terra1j5zqhemayf6kz3c6hzlh9u0yqg72g7eg3falhgre9xf90afnhvuqa8zyz5" target="_blank" class="text-[9px] text-orange-400 hover:text-orange-300 bg-orange-900/30 px-2 py-0.5 rounded border border-orange-900/50">
                        <i class="fas fa-external-link-alt mr-1"></i> PD DAO Proposals
                    </a>
                    <button onclick="clearPaste('pdPaste')" class="text-[9px] text-red-400 hover:text-red-300">Clear</button>
                </div>
            </div>
            <textarea id="pdPaste" class="input-dark h-32 font-mono text-[10px]" placeholder="Bribes for [160-163]:
Gauge: project
AMPLUNA-LUNA (55.44%): $ 150 = 1973.01 LUNA per epoch
..."></textarea>
            <button onclick="parsePdBribes()" class="btn-action bg-orange-900/40 text-orange-200 border border-orange-900">Parse & Add Range</button>
        </div>
        
        <!-- New Prop Preview -->
        <div class="col-span-4 bg-[#161616] p-3 rounded border border-gray-800">
            <div class="text-[9px] text-gray-500 uppercase font-bold mb-2">New Range Preview</div>
            <div class="space-y-1 text-[10px]">
                <div class="flex justify-between">
                    <span class="text-gray-500">Epoch Range:</span>
                    <span id="pd-new-range" class="text-white font-mono">-</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-500">Epochs:</span>
                    <span id="pd-new-count" class="text-white font-mono">0</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-500">$/Epoch:</span>
                    <span id="pd-new-per-epoch" class="text-green-400 font-mono">$0</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-500">Total:</span>
                    <span id="pd-new-total" class="text-green-400 font-mono font-bold">$0</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-500">Pools:</span>
                    <span id="pd-new-pools" class="text-white font-mono">0</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Props History -->
    <div class="preview-card">
        <div class="flex justify-between items-center mb-2 border-b border-gray-800 pb-2">
            <h3 class="text-xs font-bold text-white">All Bribe Ranges (for tla_pd_bribes.json)</h3>
            <button onclick="clearAllPdBribes()" class="text-[9px] text-red-400 hover:text-red-300">Clear All</button>
        </div>
        <div id="pd-history" class="max-h-[400px] overflow-y-auto text-xs custom-scroll space-y-2"></div>
    </div>
</div>

<!-- WS 3: ASTROPORT -->
<div id="ws-astro" class="workspace">
    <!-- Mode-specific content will be rendered here -->
    <div id="astro-staging-mode">
        <!-- STAGING MODE: 4-day 180d capture -->
        <div class="bg-yellow-900/20 border border-yellow-700 rounded-lg p-4 mb-4">
            <div class="flex items-center gap-3 mb-3">
                <div class="text-yellow-400 text-xl">⚠</div>
                <div>
                    <h3 class="text-yellow-400 font-bold text-sm">Staging Mode - Initial 180-Day Capture</h3>
                    <p class="text-yellow-200/70 text-[10px]">180d = 4 days, 90d = 2 days, 30d = 1 day. LPs complete when they have required days.</p>
                </div>
            </div>
            
            <!-- Day Tracker -->
            <div class="grid grid-cols-4 gap-2 mb-4">
                <div id="staging-day1" class="bg-[#0D0D0D] rounded p-3 border border-gray-800">
                    <div class="text-[9px] text-gray-500 uppercase font-bold mb-1">Day 1</div>
                    <div id="staging-day1-status" class="text-[10px] text-gray-600">Not started</div>
                    <div id="staging-day1-lps" class="text-[9px] text-gray-500 mt-1">0 LPs</div>
                </div>
                <div id="staging-day2" class="bg-[#0D0D0D] rounded p-3 border border-gray-800">
                    <div class="text-[9px] text-gray-500 uppercase font-bold mb-1">Day 2</div>
                    <div id="staging-day2-status" class="text-[10px] text-gray-600">Not started</div>
                    <div id="staging-day2-lps" class="text-[9px] text-gray-500 mt-1">0 LPs</div>
                </div>
                <div id="staging-day3" class="bg-[#0D0D0D] rounded p-3 border border-gray-800">
                    <div class="text-[9px] text-gray-500 uppercase font-bold mb-1">Day 3</div>
                    <div id="staging-day3-status" class="text-[10px] text-gray-600">Not started</div>
                    <div id="staging-day3-lps" class="text-[9px] text-gray-500 mt-1">0 LPs</div>
                </div>
                <div id="staging-day4" class="bg-[#0D0D0D] rounded p-3 border border-gray-800">
                    <div class="text-[9px] text-gray-500 uppercase font-bold mb-1">Day 4</div>
                    <div id="staging-day4-status" class="text-[10px] text-gray-600">Not started</div>
                    <div id="staging-day4-lps" class="text-[9px] text-gray-500 mt-1">0 LPs</div>
                </div>
            </div>
            
            <!-- Current Day Selection -->
            <div class="flex items-center gap-4 mb-4">
                <span class="text-[10px] text-gray-400">Working on:</span>
                <select id="staging-current-day" class="input-dark w-32 text-[11px]" onchange="updateStagingDay()">
                    <option value="day1">Day 1</option>
                    <option value="day2">Day 2</option>
                    <option value="day3">Day 3</option>
                    <option value="day4">Day 4</option>
                </select>
                <button onclick="exportStagingDay()" class="btn-action bg-yellow-900/40 text-yellow-300 border border-yellow-700 text-[10px]">Export Current Day</button>
                <button onclick="loadStagingDayPaste()" class="btn-action bg-blue-900/40 text-blue-300 border border-blue-700 text-[10px]">Load Day from JSON</button>
            </div>
        </div>
        
        <!-- LP Selection & Data Input (Staging) -->
        <div class="grid grid-cols-12 gap-4 mb-4">
            <!-- LP Dropdown + Range -->
            <div class="col-span-3 bg-[#161616] p-3 rounded border border-gray-800">
                <div class="text-[9px] text-gray-500 uppercase font-bold mb-2">Select LP (Astroport)</div>
                <select id="astro-lp-select" class="input-dark w-full text-[11px] mb-2" onchange="updateSelectedLp()">
                    <option value="">-- Select LP --</option>
                </select>
                <div class="text-[9px] text-gray-500 uppercase font-bold mb-1 mt-3">Data Range <span class="text-cyan-400 normal-case">(auto-detected)</span></div>
                <select id="astro-data-range" class="input-dark w-full text-[10px]" disabled>
                    <option value="180">180d (4 days needed)</option>
                    <option value="90">90d (2 days needed)</option>
                    <option value="30">30d (1 day needed)</option>
                </select>
                <div id="astro-lp-status" class="text-[9px] text-gray-500 mt-3 space-y-1">
                    <div class="flex justify-between"><span>Liquidity:</span><span id="astro-lp-liq-status" class="text-gray-600">-</span></div>
                    <div class="flex justify-between"><span>Volume:</span><span id="astro-lp-vol-status" class="text-gray-600">-</span></div>
                    <div class="flex justify-between"><span>Days Done:</span><span id="astro-lp-days-status" class="text-gray-600">-</span></div>
                </div>
                <!-- Action buttons -->
                <div class="flex gap-2 mt-3">
                    <button onclick="markLpNotAvailable()" class="btn-action flex-1 bg-yellow-900/30 text-yellow-300 border border-yellow-800 text-[9px] py-1">⚠ No Data</button>
                    <button onclick="clearLpData()" class="btn-action flex-1 bg-red-900/30 text-red-300 border border-red-800 text-[9px] py-1">✕ Clear</button>
                </div>
            </div>
            
            <!-- Liquidity Paste -->
            <div class="col-span-4 bg-[#161616] p-3 rounded border border-gray-800 flex flex-col gap-2">
                <div class="flex justify-between items-center">
                    <h3 class="text-cyan-400 font-bold text-[10px]">Paste Liquidity JSON</h3>
                    <button onclick="clearPaste('astroLiqPaste')" class="text-[9px] text-red-400 hover:text-red-300">Clear</button>
                </div>
                <textarea id="astroLiqPaste" class="input-dark flex-1 font-mono text-[8px]" placeholder='{"result":{"data":{"json":[{"series":[...]}]}}}'></textarea>
            </div>
            
            <!-- Volume Paste -->
            <div class="col-span-4 bg-[#161616] p-3 rounded border border-gray-800 flex flex-col gap-2">
                <div class="flex justify-between items-center">
                    <h3 class="text-purple-400 font-bold text-[10px]">Paste Volume JSON</h3>
                    <button onclick="clearPaste('astroVolPaste')" class="text-[9px] text-red-400 hover:text-red-300">Clear</button>
                </div>
                <textarea id="astroVolPaste" class="input-dark flex-1 font-mono text-[8px]" placeholder='{"result":{"data":{"json":[{"series":[...]}]}}}'></textarea>
            </div>
            
            <!-- Capture Button -->
            <div class="col-span-1 flex flex-col justify-center">
                <button onclick="captureStagingBoth()" class="btn-action h-full bg-green-900/50 text-green-300 border border-green-700 text-[10px] flex flex-col items-center justify-center gap-1 hover:bg-green-800/50">
                    <span class="text-lg">✓</span>
                    <span>Capture</span>
                    <span>Both</span>
                </button>
            </div>
        </div>
        
        <!-- LP Progress Grid -->
        <div class="preview-card">
            <div class="flex justify-between items-center mb-2 border-b border-gray-800 pb-2">
                <h3 class="text-xs font-bold text-white">LP Capture Progress (Current Day)</h3>
                <div class="text-[9px] text-gray-500">
                    <span id="astro-staging-complete" class="text-green-400">0</span><span id="astro-staging-total"></span>
                </div>
            </div>
            <div id="astro-staging-lp-grid" class="grid grid-cols-4 gap-2 max-h-[300px] overflow-y-auto custom-scroll"></div>
        </div>
        
        <!-- Finalize Button -->
        <div id="staging-finalize-section" class="mt-4 bg-green-900/20 border border-green-700 rounded-lg p-4 hidden">
            <div class="flex items-center justify-between">
                <div>
                    <h3 class="text-green-400 font-bold text-sm">Ready to Finalize! <span id="staging-ready-count" class="text-green-300 font-normal"></span></h3>
                    <p class="text-green-200/70 text-[10px]">Generate epoch averages and create historical file from complete LPs.</p>
                </div>
                <button onclick="finalizeStaging()" class="btn-action bg-green-900/50 text-green-300 border border-green-600 px-4 py-2">
                    Finalize & Generate Historical
                </button>
            </div>
        </div>
    </div>
    
    <div id="astro-normal-mode" class="hidden">
        <!-- NORMAL MODE: Weekly updates with 14d/30d data -->
        <div class="bg-green-900/20 border border-green-700 rounded-lg p-3 mb-4">
            <div class="flex items-center gap-3">
                <div class="text-green-400 text-lg">✓</div>
                <div>
                    <h3 class="text-green-400 font-bold text-xs">Normal Mode - Weekly Updates</h3>
                    <p class="text-green-200/70 text-[10px]">Merge 14d/30d data into current file. Old data auto-ages to historical.</p>
                </div>
            </div>
        </div>
        
        <!-- Status Row -->
        <div class="grid grid-cols-12 gap-4 mb-4">
            <div class="col-span-4 bg-[#161616] p-3 rounded border border-gray-800">
                <div class="flex justify-between items-center mb-2">
                    <div class="text-[9px] text-gray-500 uppercase font-bold">Historical File (180d)</div>
                    <button onclick="fetchHistoricalFromGithub()" class="text-[9px] text-teal-400 hover:text-teal-300">⟳ Fetch</button>
                </div>
                <div class="space-y-1 text-[10px]">
                    <div class="flex justify-between"><span class="text-gray-500">Epochs:</span><span id="hist-epochs" class="text-white font-mono">-</span></div>
                    <div class="flex justify-between"><span class="text-gray-500">LPs:</span><span id="hist-lps" class="text-white font-mono">0</span></div>
                    <div class="flex justify-between"><span class="text-gray-500">Last Updated:</span><span id="hist-updated" class="text-gray-400 font-mono">-</span></div>
                </div>
                <!-- Status alerts -->
                <div id="hist-need-epochs" class="hidden mt-2 p-2 bg-yellow-900/30 border border-yellow-700 rounded text-[9px]">
                    <span class="text-yellow-400">⚠ Need:</span>
                    <span id="hist-need-list" class="text-yellow-300 font-mono ml-1">-</span>
                </div>
                <div id="hist-archive-epochs" class="hidden mt-2 p-2 bg-orange-900/30 border border-orange-700 rounded text-[9px]">
                    <span class="text-orange-400">📦 Archive:</span>
                    <span id="hist-archive-list" class="text-orange-300 font-mono ml-1">-</span>
                </div>
            </div>
            <div class="col-span-4 bg-[#161616] p-3 rounded border border-gray-800">
                <div class="text-[9px] text-gray-500 uppercase font-bold mb-2">Current File (Rolling 90d)</div>
                <div class="space-y-1 text-[10px]">
                    <div class="flex justify-between"><span class="text-gray-500">Epochs:</span><span id="curr-epochs" class="text-white font-mono">-</span></div>
                    <div class="flex justify-between"><span class="text-gray-500">LPs:</span><span id="curr-lps" class="text-white font-mono">0</span></div>
                    <div class="flex justify-between"><span class="text-gray-500">Last Updated:</span><span id="curr-updated" class="text-gray-400 font-mono">-</span></div>
                </div>
            </div>
            <div class="col-span-4 bg-[#161616] p-3 rounded border border-gray-800">
                <div class="text-[9px] text-gray-500 uppercase font-bold mb-2">Export Files</div>
                <div class="space-y-1">
                    <button onclick="exportHistorical()" class="btn-action w-full bg-orange-900/30 text-orange-300 border border-orange-900/50 text-[9px]">Download Historical</button>
                    <button onclick="exportArchive()" class="btn-action w-full bg-purple-900/30 text-purple-300 border border-purple-900/50 text-[9px]">Download Archive</button>
                    <button onclick="exportCombined()" class="btn-action w-full bg-green-900/30 text-green-300 border border-green-900/50 text-[9px]">Download Combined</button>
                </div>
            </div>
        </div>
        
        <!-- LP Selection & Data Input (Normal) -->
        <div class="grid grid-cols-12 gap-4 mb-4">
            <!-- LP Dropdown -->
            <div class="col-span-4 bg-[#161616] p-3 rounded border border-gray-800">
                <div class="text-[9px] text-gray-500 uppercase font-bold mb-2">Select LP (Astroport)</div>
                <select id="astro-lp-select-normal" class="input-dark w-full text-[11px] mb-2" onchange="updateSelectedLpNormal()">
                    <option value="">-- Select LP --</option>
                </select>
                <div class="text-[9px] text-gray-500">
                    <div class="flex justify-between"><span>Last Epoch:</span><span id="normal-lp-last-epoch" class="text-green-400 font-mono">-</span></div>
                </div>
            </div>
            
            <!-- Liquidity Paste -->
            <div class="col-span-4 bg-[#161616] p-3 rounded border border-gray-800 flex flex-col gap-2">
                <div class="flex justify-between items-center">
                    <h3 class="text-cyan-400 font-bold text-[10px]">Paste 14d/30d Liquidity</h3>
                    <button onclick="clearPaste('normalLiqPaste')" class="text-[9px] text-red-400 hover:text-red-300">Clear</button>
                </div>
                <textarea id="normalLiqPaste" class="input-dark h-24 font-mono text-[8px]" placeholder='{"result":{"data":{"json":[{"series":[...]}]}}}'></textarea>
                <button onclick="parseNormalLiquidity()" class="btn-action bg-cyan-900/40 text-cyan-200 border border-cyan-900 text-[10px]">Merge Liquidity</button>
            </div>
            
            <!-- Volume Paste -->
            <div class="col-span-4 bg-[#161616] p-3 rounded border border-gray-800 flex flex-col gap-2">
                <div class="flex justify-between items-center">
                    <h3 class="text-purple-400 font-bold text-[10px]">Paste 14d/30d Volume</h3>
                    <button onclick="clearPaste('normalVolPaste')" class="text-[9px] text-red-400 hover:text-red-300">Clear</button>
                </div>
                <textarea id="normalVolPaste" class="input-dark h-24 font-mono text-[8px]" placeholder='{"result":{"data":{"json":[{"series":[...]}]}}}'></textarea>
                <button onclick="parseNormalVolume()" class="btn-action bg-purple-900/40 text-purple-200 border border-purple-900 text-[10px]">Merge Volume</button>
            </div>
        </div>
        
        <!-- LP Status Grid -->
        <div class="preview-card">
            <div class="flex justify-between items-center mb-2 border-b border-gray-800 pb-2">
                <h3 class="text-xs font-bold text-white">LP Update Status</h3>
            </div>
            <div id="astro-normal-lp-grid" class="grid grid-cols-4 gap-2 max-h-[300px] overflow-y-auto custom-scroll"></div>
        </div>
    </div>
</div>

<!-- WS 4: WHITEWHALE -->
<div id="ws-ww" class="workspace">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="bg-[#161616] p-3 rounded border border-gray-800 flex flex-col gap-2">
            <div class="flex justify-between items-center">
                <h3 class="text-green-400 font-bold text-xs">Skeleton Swap Data</h3>
                <button onclick="clearPaste('wwPaste')" class="text-[9px] text-red-400 hover:text-red-300">Clear</button>
            </div>
            <textarea id="wwPaste" class="input-dark h-64 font-mono text-[10px]" placeholder="Paste Skeleton Swap dashboard text..."></textarea>
            <button onclick="parseWW()" class="btn-action bg-green-900/40 text-green-200 border border-green-900">Parse Skeleton Swap</button>
        </div>
        <div class="preview-card flex flex-col">
            <div class="flex justify-between items-center mb-2 border-b border-gray-800 pb-2">
                <h3 class="text-xs font-bold text-white">Parsed Skeleton Swap</h3>
                <div class="text-[10px] text-gray-500">Items: <span id="ww-count" class="text-white font-mono">0</span></div>
            </div>
            <div class="grid grid-cols-12 gap-1 text-[9px] text-gray-500 uppercase font-bold px-2 py-1 bg-gray-900 rounded-t">
                <div class="col-span-5">Pool</div>
                <div class="col-span-2 text-right">Volume</div>
                <div class="col-span-2 text-right">Fees</div>
                <div class="col-span-3 text-right">APR</div>
            </div>
            <div id="ww-list" class="max-h-[500px] overflow-y-auto text-xs bg-[#0D0D0D] p-2 border border-gray-800 rounded-b custom-scroll space-y-0"></div>
        </div>
    </div>
</div>

<!-- WS: PRICES - Token Price Manager (merged into main prices tab) -->
<div id="ws-prices-tokens" class="workspace hidden">
    <div class="bg-[#161616] border border-green-900/50 rounded-lg p-4 mb-4">
        <div class="flex justify-between items-center mb-3">
            <div class="flex items-center gap-3">
                <i class="fas fa-coins text-green-400 text-xl"></i>
                <div>
                    <h2 class="text-green-400 font-bold text-sm">Token Price Manager</h2>
                    <p class="text-gray-500 text-[10px]">Auto-fetch from CoinGecko + manual entry for unlisted tokens</p>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <div id="prices-fetch-status" class="px-3 py-1 rounded text-[10px] font-bold bg-gray-800 text-gray-400">
                    Not fetched
                </div>
                <button onclick="fetchAllPrices()" class="bg-green-900/30 hover:bg-green-900/50 text-green-400 px-3 py-1.5 rounded text-[10px] border border-green-900/50">
                    <i class="fas fa-sync-alt mr-1"></i> Fetch All Prices
                </button>
            </div>
        </div>
        
        <!-- Fetch Status -->
        <div class="grid grid-cols-4 gap-2 mb-4">
            <div class="bg-[#0D0D0D] rounded p-2 flex items-center justify-between text-[10px]">
                <span class="text-gray-500">CoinGecko API</span>
                <span id="price-status-coingecko" class="text-gray-600">-</span>
            </div>
            <div class="bg-[#0D0D0D] rounded p-2 flex items-center justify-between text-[10px]">
                <span class="text-gray-500">LST Ratios (Chain)</span>
                <span id="price-status-lst" class="text-gray-600">-</span>
            </div>
            <div class="bg-[#0D0D0D] rounded p-2 flex items-center justify-between text-[10px]">
                <span class="text-gray-500">Banner Config</span>
                <span id="price-status-config" class="text-gray-600">-</span>
            </div>
            <div class="bg-[#0D0D0D] rounded p-2 flex items-center justify-between text-[10px]">
                <span class="text-gray-500">Last Update</span>
                <span id="price-status-time" class="text-gray-600">-</span>
            </div>
        </div>
    </div>
    
    <!-- Banner Tokens (CoinGecko) -->
    <div class="grid grid-cols-2 gap-4 mb-4">
        <div class="bg-[#161616] p-3 rounded border border-green-800">
            <div class="flex justify-between items-center mb-3">
                <h3 class="text-green-400 font-bold text-xs">🌐 Banner Tokens (CoinGecko)</h3>
                <span class="text-[9px] text-gray-500">Auto-fetched from API</span>
            </div>
            <div class="text-[9px] text-gray-400 mb-2">Select tokens to include in snapshot:</div>
            <div id="banner-tokens-list" class="space-y-1 max-h-[400px] overflow-y-auto custom-scroll">
                <!-- Populated by JS -->
                <div class="text-gray-600 text-[10px] italic">Click "Fetch All Prices" to load...</div>
            </div>
        </div>
        
        <!-- Additional Tokens (Manual) -->
        <div class="bg-[#161616] p-3 rounded border border-yellow-800">
            <div class="flex justify-between items-center mb-3">
                <h3 class="text-yellow-400 font-bold text-xs">✏️ Additional Tokens (Manual)</h3>
                <button onclick="addManualToken()" class="text-[9px] bg-yellow-900/30 text-yellow-400 px-2 py-1 rounded border border-yellow-900/50 hover:bg-yellow-900/50">
                    + Add Token
                </button>
            </div>
            <div class="text-[9px] text-gray-400 mb-2">Tokens not on CoinGecko (ampCAPA, ampROAR, etc.) - leave blank = "unknown"</div>
            <div id="manual-tokens-list" class="space-y-2 max-h-[400px] overflow-y-auto custom-scroll">
                <!-- Manual token entries -->
                <div class="grid grid-cols-12 gap-2 items-center bg-[#0D0D0D] rounded p-2">
                    <input type="text" id="manual-token-ampCAPA" class="col-span-3 input-dark text-[10px]" value="ampCAPA" readonly>
                    <div class="col-span-3 text-[9px] text-gray-500">= CAPA × ratio</div>
                    <input type="number" id="manual-price-ampCAPA" step="0.0001" class="col-span-3 input-dark text-[10px] text-right" placeholder="USD price">
                    <div class="col-span-2 text-[9px]">
                        <span id="manual-status-ampCAPA" class="text-gray-600">❌ Unknown</span>
                    </div>
                    <button onclick="calcDerivedPrice('ampCAPA', 'CAPA')" class="col-span-1 text-[9px] text-cyan-400 hover:text-cyan-300" title="Calculate from CAPA × ratio">
                        <i class="fas fa-calculator"></i>
                    </button>
                </div>
                <div class="grid grid-cols-12 gap-2 items-center bg-[#0D0D0D] rounded p-2">
                    <input type="text" id="manual-token-ampROAR" class="col-span-3 input-dark text-[10px]" value="ampROAR" readonly>
                    <div class="col-span-3 text-[9px] text-gray-500">= ROAR × ratio</div>
                    <input type="number" id="manual-price-ampROAR" step="0.0001" class="col-span-3 input-dark text-[10px] text-right" placeholder="USD price">
                    <div class="col-span-2 text-[9px]">
                        <span id="manual-status-ampROAR" class="text-gray-600">❌ Unknown</span>
                    </div>
                    <button onclick="calcDerivedPrice('ampROAR', 'ROAR')" class="col-span-1 text-[9px] text-cyan-400 hover:text-cyan-300" title="Calculate from ROAR × ratio">
                        <i class="fas fa-calculator"></i>
                    </button>
                </div>
            </div>
            <div id="additional-manual-tokens" class="space-y-2 mt-2">
                <!-- Dynamic manual tokens added here -->
            </div>
        </div>
    </div>
    
    <!-- LST Ratios Summary -->
    <div class="bg-[#161616] p-3 rounded border border-teal-800 mb-4">
        <div class="flex justify-between items-center mb-3">
            <h3 class="text-teal-400 font-bold text-xs">📐 LST Ratios (Auto-Fetched from Chain)</h3>
            <button onclick="fetchLstRatiosFromChain()" class="text-[9px] bg-teal-900/30 text-teal-400 px-2 py-1 rounded border border-teal-900/50 hover:bg-teal-900/50">
                <i class="fas fa-link mr-1"></i> Fetch from Chain
            </button>
        </div>
        <div class="grid grid-cols-6 gap-2" id="lst-ratios-summary">
            <div class="bg-[#0D0D0D] rounded p-2 text-center">
                <div class="text-[9px] text-gray-500">ampLUNA</div>
                <div id="lst-sum-ampLUNA" class="text-sm font-mono text-teal-400">--</div>
                <div id="lst-sum-ampLUNA-status" class="text-[8px] text-gray-600">pending</div>
            </div>
            <div class="bg-[#0D0D0D] rounded p-2 text-center">
                <div class="text-[9px] text-gray-500">arbLUNA</div>
                <div id="lst-sum-arbLUNA" class="text-sm font-mono text-orange-400">--</div>
                <div id="lst-sum-arbLUNA-status" class="text-[8px] text-gray-600">pending</div>
            </div>
            <div class="bg-[#0D0D0D] rounded p-2 text-center">
                <div class="text-[9px] text-gray-500">bLUNA</div>
                <div id="lst-sum-bLUNA" class="text-sm font-mono text-blue-400">--</div>
                <div id="lst-sum-bLUNA-status" class="text-[8px] text-gray-600">pending</div>
            </div>
            <div class="bg-[#0D0D0D] rounded p-2 text-center">
                <div class="text-[9px] text-gray-500">ampCAPA</div>
                <div id="lst-sum-ampCAPA" class="text-sm font-mono text-purple-400">--</div>
                <div id="lst-sum-ampCAPA-status" class="text-[8px] text-gray-600">pending</div>
            </div>
            <div class="bg-[#0D0D0D] rounded p-2 text-center">
                <div class="text-[9px] text-gray-500">ampROAR</div>
                <div id="lst-sum-ampROAR" class="text-sm font-mono text-yellow-400">--</div>
                <div id="lst-sum-ampROAR-status" class="text-[8px] text-gray-600">pending</div>
            </div>
            <div class="bg-[#0D0D0D] rounded p-2 text-center">
                <div class="text-[9px] text-gray-500">xASTRO</div>
                <div id="lst-sum-xASTRO" class="text-sm font-mono text-cyan-400">--</div>
                <div id="lst-sum-xASTRO-status" class="text-[8px] text-gray-600">pending</div>
            </div>
        </div>
    </div>
    
    <!-- Price Snapshot Preview -->
    <div class="preview-card">
        <div class="flex justify-between items-center mb-2 border-b border-gray-800 pb-2">
            <h3 class="text-xs font-bold text-white">💾 Price Snapshot Preview</h3>
            <div class="flex gap-2">
                <span id="price-snapshot-count" class="text-[10px] text-gray-500">0 tokens</span>
                <button onclick="copyPriceSnapshot()" class="text-[9px] bg-gray-800 text-gray-300 px-2 py-1 rounded hover:bg-gray-700">
                    <i class="fas fa-copy mr-1"></i> Copy JSON
                </button>
            </div>
        </div>
        <pre id="price-snapshot-preview" class="text-[9px] text-gray-400 font-mono bg-[#0D0D0D] p-3 rounded max-h-[200px] overflow-auto custom-scroll">
{ "prices": {}, "lst_ratios": {}, "timestamp": null }
        </pre>
    </div>
</div>

<!-- WS: DASHBOARD STATS -->
<div id="ws-dashboard" class="workspace">
    <div class="bg-[#161616] border border-cyan-900/50 rounded-lg p-4 mb-4">
        <div class="flex justify-between items-center mb-3">
            <div class="flex items-center gap-3">
                <i class="fas fa-tachometer-alt text-cyan-400 text-xl"></i>
                <div>
                    <h2 class="text-cyan-400 font-bold text-sm">Dashboard Stats Snapshot</h2>
                    <p class="text-gray-500 text-[10px]">Capture all dashboard tile data for epoch snapshot</p>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <button onclick="openPreviewModal('https://www.thealliancedao.com/tla-stats.html', 'TLA Stats')" class="text-[9px] text-cyan-400 hover:text-cyan-300 bg-cyan-900/30 px-2 py-0.5 rounded border border-cyan-900/50 cursor-pointer">
                    <i class="fas fa-external-link-alt mr-1"></i> TLA Stats
                </button>
                <button onclick="openPreviewModal('https://www.erisprotocol.com/terra/liquidity-hub', 'Eris TLA')" class="text-[9px] text-teal-400 hover:text-teal-300 bg-teal-900/30 px-2 py-0.5 rounded border border-teal-900/50 cursor-pointer">
                    <i class="fas fa-external-link-alt mr-1"></i> Eris TLA
                </button>
                <div id="dashboard-status" class="px-3 py-1 rounded text-[10px] font-bold bg-gray-800 text-gray-400">
                    0/12 tiles
                </div>
                <button onclick="fetchDashboardData()" class="bg-cyan-900/30 hover:bg-cyan-900/50 text-cyan-400 px-3 py-1.5 rounded text-[10px] border border-cyan-900/50">
                    <i class="fas fa-download mr-1"></i> Fetch Live Data
                </button>
            </div>
        </div>
    </div>
    
    <!-- Dashboard Tiles Grid - 12 tiles in 4 columns -->
    <div class="grid grid-cols-4 gap-3 mb-4">
        <!-- Tile 1: NFT Collection -->
        <div id="tile-nft" class="bg-[#161616] p-3 rounded border-2 border-gray-700">
            <div class="flex justify-between items-center mb-2">
                <h4 class="text-[10px] text-gray-500 uppercase">① NFT Collection</h4>
                <span id="tile-nft-status" class="text-[9px] text-gray-600">--</span>
            </div>
            <div class="space-y-1 text-[10px]">
                <div class="flex justify-between"><span class="text-gray-400">Minted:</span><span id="dash-nft-minted" class="text-white font-mono">--</span></div>
                <div class="flex justify-between"><span class="text-gray-400">Unminted:</span><span id="dash-nft-unminted" class="text-white font-mono">--</span></div>
                <div class="flex justify-between"><span class="text-gray-400">Broken:</span><span id="dash-nft-broken" class="text-red-400 font-mono">--</span></div>
            </div>
        </div>
        
        <!-- Tile 2: Backing Per NFT -->
        <div id="tile-backing" class="bg-[#161616] p-3 rounded border-2 border-gray-700">
            <div class="flex justify-between items-center mb-2">
                <h4 class="text-[10px] text-gray-500 uppercase">② Backing/NFT</h4>
                <span id="tile-backing-status" class="text-[9px] text-gray-600">--</span>
            </div>
            <div class="space-y-1 text-[10px]">
                <div class="flex justify-between"><span class="text-gray-400">ampLUNA:</span><span id="dash-backing-ampluna" class="text-cyan-400 font-mono">--</span></div>
                <div class="flex justify-between"><span class="text-gray-400">→ LUNA:</span><span id="dash-backing-luna" class="text-white font-mono">--</span></div>
                <div class="flex justify-between"><span class="text-gray-400">→ USD:</span><span id="dash-backing-usd" class="text-green-400 font-mono">--</span></div>
            </div>
        </div>
        
        <!-- Tile 3: DAO Treasury -->
        <div id="tile-treasury" class="bg-[#161616] p-3 rounded border-2 border-gray-700">
            <div class="flex justify-between items-center mb-2">
                <h4 class="text-[10px] text-gray-500 uppercase">③ DAO Treasury</h4>
                <span id="tile-treasury-status" class="text-[9px] text-gray-600">--</span>
            </div>
            <div class="space-y-1 text-[10px]">
                <div class="flex justify-between"><span class="text-gray-400">Total USD:</span><span id="dash-treasury-usd" class="text-green-400 font-mono">--</span></div>
                <div class="flex justify-between"><span class="text-gray-400">LUNA:</span><span id="dash-treasury-luna" class="text-white font-mono">--</span></div>
                <div class="flex justify-between"><span class="text-gray-400">Tokens:</span><span id="dash-treasury-tokens" class="text-white font-mono">--</span></div>
            </div>
        </div>
        
        <!-- Tile 4: DAODAO Stats -->
        <div id="tile-daodao" class="bg-[#161616] p-3 rounded border-2 border-gray-700">
            <div class="flex justify-between items-center mb-2">
                <h4 class="text-[10px] text-gray-500 uppercase">④ DAODAO</h4>
                <span id="tile-daodao-status" class="text-[9px] text-gray-600">--</span>
            </div>
            <div class="space-y-1 text-[10px]">
                <div class="flex justify-between"><span class="text-gray-400">Staked:</span><span id="dash-dao-staked" class="text-white font-mono">--</span></div>
                <div class="flex justify-between"><span class="text-gray-400">Members:</span><span id="dash-dao-members" class="text-white font-mono">--</span></div>
                <div class="flex justify-between"><span class="text-gray-400">Props:</span><span id="dash-dao-props" class="text-white font-mono">--</span></div>
            </div>
        </div>
        
        <!-- Tile 5: TLA Deposits Summary -->
        <div id="tile-tla-summary" class="bg-[#161616] p-3 rounded border-2 border-gray-700">
            <div class="flex justify-between items-center mb-2">
                <h4 class="text-[10px] text-gray-500 uppercase">⑤ TLA Deposits</h4>
                <span id="tile-tla-status" class="text-[9px] text-gray-600">--</span>
            </div>
            <div class="space-y-1 text-[10px]">
                <div class="flex justify-between"><span class="text-gray-400">TLA USD:</span><span id="dash-tla-usd-tla" class="text-green-400 font-mono">--</span></div>
                <div class="flex justify-between"><span class="text-gray-400">Our Calc:</span><span id="dash-tla-usd-calc" class="text-cyan-400 font-mono">--</span></div>
                <div class="flex justify-between"><span class="text-gray-400">APR:</span><span id="dash-tla-apr" class="text-yellow-400 font-mono">--</span></div>
            </div>
        </div>
        
        <!-- Tile 6: TLA Token Balances -->
        <div id="tile-tla-tokens" class="bg-[#161616] p-3 rounded border-2 border-gray-700">
            <div class="flex justify-between items-center mb-2">
                <h4 class="text-[10px] text-gray-500 uppercase">⑥ TLA Tokens</h4>
                <span id="tile-tla-tokens-status" class="text-[9px] text-gray-600">--</span>
            </div>
            <div id="dash-tla-token-list" class="space-y-0.5 text-[9px] max-h-[60px] overflow-y-auto custom-scroll">
                <div class="text-gray-600 text-center">No tokens</div>
            </div>
        </div>
        
        <!-- Tile 7: Deposit Rewards -->
        <div id="tile-deposit-rewards" class="bg-[#161616] p-3 rounded border-2 border-gray-700">
            <div class="flex justify-between items-center mb-2">
                <h4 class="text-[10px] text-gray-500 uppercase">⑦ Deposit Rewards</h4>
                <span id="tile-deposit-status" class="text-[9px] text-gray-600">--</span>
            </div>
            <div class="space-y-1 text-[10px]">
                <div class="flex justify-between"><span class="text-gray-400">Pending:</span><span id="dash-deposit-pending" class="text-green-400 font-mono">--</span></div>
                <div class="flex justify-between"><span class="text-gray-400">Token:</span><span id="dash-deposit-token" class="text-cyan-400 font-mono">--</span></div>
            </div>
        </div>
        
        <!-- Tile 8: Vote Rewards -->
        <div id="tile-vote-rewards" class="bg-[#161616] p-3 rounded border-2 border-gray-700">
            <div class="flex justify-between items-center mb-2">
                <h4 class="text-[10px] text-gray-500 uppercase">⑧ Vote Rewards</h4>
                <span id="tile-vote-status" class="text-[9px] text-gray-600">--</span>
            </div>
            <div id="dash-vote-rewards-list" class="space-y-0.5 text-[9px] max-h-[60px] overflow-y-auto custom-scroll">
                <div class="text-gray-600 text-center">No rewards</div>
            </div>
        </div>
        
        <!-- Tile 9: Rebase -->
        <div id="tile-rebase" class="bg-[#161616] p-3 rounded border-2 border-gray-700">
            <div class="flex justify-between items-center mb-2">
                <h4 class="text-[10px] text-gray-500 uppercase">⑨ Rebase</h4>
                <span id="tile-rebase-status" class="text-[9px] text-gray-600">--</span>
            </div>
            <div class="space-y-1 text-[10px]">
                <div class="flex justify-between"><span class="text-gray-400">Amount:</span><span id="dash-rebase-amount" class="text-cyan-400 font-mono">--</span></div>
                <div class="flex justify-between"><span class="text-gray-400">USD:</span><span id="dash-rebase-usd" class="text-green-400 font-mono">--</span></div>
            </div>
        </div>
        
        <!-- Tile 10: Voting Power -->
        <div id="tile-vp" class="bg-[#161616] p-3 rounded border-2 border-gray-700">
            <div class="flex justify-between items-center mb-2">
                <h4 class="text-[10px] text-gray-500 uppercase">⑩ Voting Power</h4>
                <span id="tile-vp-status" class="text-[9px] text-gray-600">--</span>
            </div>
            <div class="space-y-1 text-[10px]">
                <div class="flex justify-between"><span class="text-gray-400">VP:</span><span id="dash-vp-total" class="text-purple-400 font-mono">--</span></div>
                <div class="flex justify-between"><span class="text-gray-400">% of Total:</span><span id="dash-vp-pct" class="text-white font-mono">--</span></div>
            </div>
        </div>
        
        <!-- Tile 11: Epoch Info -->
        <div id="tile-epoch" class="bg-[#161616] p-3 rounded border-2 border-gray-700">
            <div class="flex justify-between items-center mb-2">
                <h4 class="text-[10px] text-gray-500 uppercase">⑪ Epoch</h4>
                <span id="tile-epoch-status" class="text-[9px] text-green-400">✓</span>
            </div>
            <div class="space-y-1 text-[10px]">
                <div class="flex justify-between"><span class="text-gray-400">Current:</span><span id="dash-epoch-current" class="text-white font-mono">--</span></div>
                <div class="flex justify-between"><span class="text-gray-400">Phase:</span><span id="dash-epoch-phase" class="text-yellow-400 font-mono">--</span></div>
                <div class="flex justify-between"><span class="text-gray-400">Days Left:</span><span id="dash-epoch-days" class="text-white font-mono">--</span></div>
            </div>
        </div>
        
        <!-- Tile 12: Prices Snapshot -->
        <div id="tile-prices" class="bg-[#161616] p-3 rounded border-2 border-gray-700">
            <div class="flex justify-between items-center mb-2">
                <h4 class="text-[10px] text-gray-500 uppercase">⑫ Prices</h4>
                <span id="tile-prices-status" class="text-[9px] text-gray-600">--</span>
            </div>
            <div class="space-y-1 text-[10px]">
                <div class="flex justify-between"><span class="text-gray-400">LUNA:</span><span id="dash-price-luna" class="text-white font-mono">--</span></div>
                <div class="flex justify-between"><span class="text-gray-400">ampLUNA:</span><span id="dash-price-ampluna" class="text-cyan-400 font-mono">--</span></div>
                <div class="flex justify-between"><span class="text-gray-400">Tokens:</span><span id="dash-price-count" class="text-white font-mono">--</span></div>
            </div>
        </div>
    </div>
    
    <!-- TLA Data Entry Section -->
    <div class="grid grid-cols-2 gap-4 mb-4">
        <!-- Left: Paste Sections -->
        <div class="space-y-3">
            <!-- Token Amounts Paste -->
            <div class="bg-[#161616] p-3 rounded border border-teal-800">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-teal-400 font-bold text-xs">📋 TLA Token Amounts</h3>
                    <button onclick="clearPaste('dash-tokens-paste')" class="text-[9px] text-red-400 hover:text-red-300">Clear</button>
                </div>
                <textarea id="dash-tokens-paste" class="input-dark h-24 font-mono text-[9px] mb-2" placeholder="CAPA	307090.5579191414
LUNA	41425.07181925935
ampLUNA	11313.998821293122
..."></textarea>
                <button onclick="parseDashTokens()" class="btn-action w-full bg-teal-900/30 text-teal-300 border border-teal-900/50">Parse Token Amounts</button>
            </div>
            
            <!-- USD + APR Paste -->
            <div class="bg-[#161616] p-3 rounded border border-yellow-800">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-yellow-400 font-bold text-xs">💰 USD Amount & APR</h3>
                    <button onclick="clearPaste('dash-usd-paste')" class="text-[9px] text-red-400 hover:text-red-300">Clear</button>
                </div>
                <textarea id="dash-usd-paste" class="input-dark h-16 font-mono text-[9px] mb-2" placeholder="Your deposit
__7 980.05__$
est. APR 36.35 %"></textarea>
                <button onclick="parseDashUsd()" class="btn-action w-full bg-yellow-900/30 text-yellow-300 border border-yellow-900/50">Parse USD & APR</button>
            </div>
            
            <!-- Rewards Paste -->
            <div class="bg-[#161616] p-3 rounded border border-green-800">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-green-400 font-bold text-xs">🎁 Rewards (Deposit + Vote + Rebase)</h3>
                    <button onclick="clearPaste('dash-rewards-paste')" class="text-[9px] text-red-400 hover:text-red-300">Clear</button>
                </div>
                <textarea id="dash-rewards-paste" class="input-dark h-28 font-mono text-[9px] mb-2" placeholder="Paste full TLA page for rewards...
Includes: Deposit Rewards, Vote Rewards, Rebase"></textarea>
                <button onclick="parseDashRewards()" class="btn-action w-full bg-green-900/30 text-green-300 border border-green-900/50">Parse All Rewards</button>
            </div>
        </div>
        
        <!-- Right: Parsed Data Preview -->
        <div class="bg-[#161616] p-3 rounded border border-gray-800">
            <div class="flex justify-between items-center mb-3">
                <h3 class="text-gray-400 font-bold text-xs">📊 Parsed TLA Data</h3>
                <div class="flex gap-2">
                    <button onclick="useTlaUsd()" id="btn-use-tla" class="text-[9px] px-2 py-1 rounded bg-gray-800 text-gray-500 border border-gray-700" disabled>Use TLA $</button>
                    <button onclick="useCalcUsd()" id="btn-use-calc" class="text-[9px] px-2 py-1 rounded bg-gray-800 text-gray-500 border border-gray-700" disabled>Use Our Calc $</button>
                </div>
            </div>
            
            <!-- USD Comparison -->
            <div class="bg-[#0D0D0D] rounded p-2 mb-3">
                <div class="flex justify-between items-center text-[10px] mb-1">
                    <span class="text-gray-500">TLA Shows:</span>
                    <span id="dash-compare-tla" class="text-yellow-400 font-mono">$--</span>
                </div>
                <div class="flex justify-between items-center text-[10px] mb-1">
                    <span class="text-gray-500">Our Calculation:</span>
                    <span id="dash-compare-calc" class="text-cyan-400 font-mono">$--</span>
                </div>
                <div class="flex justify-between items-center text-[10px]">
                    <span class="text-gray-500">Difference:</span>
                    <span id="dash-compare-diff" class="text-gray-400 font-mono">--</span>
                </div>
            </div>
            
            <!-- Token Breakdown -->
            <div class="text-[9px] text-gray-500 uppercase font-bold mb-1">Token Breakdown</div>
            <div id="dash-token-breakdown" class="bg-[#0D0D0D] rounded p-2 max-h-[180px] overflow-y-auto custom-scroll text-[9px]">
                <div class="text-gray-600 text-center py-2">Parse token amounts to see breakdown</div>
            </div>
            
            <!-- Rewards Summary -->
            <div class="text-[9px] text-gray-500 uppercase font-bold mb-1 mt-3">Rewards Summary</div>
            <div id="dash-rewards-summary" class="bg-[#0D0D0D] rounded p-2 text-[9px]">
                <div class="text-gray-600 text-center py-2">Parse rewards to see summary</div>
            </div>
        </div>
    </div>
    
    <!-- Dashboard Snapshot Preview -->
    <div class="preview-card">
        <div class="flex justify-between items-center mb-2 border-b border-gray-800 pb-2">
            <h3 class="text-xs font-bold text-white">💾 Dashboard Snapshot JSON</h3>
            <button onclick="downloadDashboardSnapshot()" class="text-[9px] bg-cyan-900/30 text-cyan-300 px-2 py-1 rounded hover:bg-cyan-900/50 border border-cyan-900/50">
                <i class="fas fa-download mr-1"></i> Download Snapshot
            </button>
        </div>
        <pre id="dashboard-snapshot-preview" class="text-[9px] text-gray-400 font-mono bg-[#0D0D0D] p-3 rounded max-h-[200px] overflow-auto custom-scroll">
{ "timestamp": null, "epoch": null, "tiles": {} }
        </pre>
    </div>
    
    <!-- Confirm Section -->
    <div id="dashboard-confirm-section" class="hidden mt-3 p-3 bg-yellow-900/20 border border-yellow-700 rounded">
    </div>
</div>

<!-- WS: NFT STATS -->
<div id="ws-nft" class="workspace">
    <div class="bg-[#161616] border border-purple-900/50 rounded-lg p-4 mb-4">
        <div class="flex justify-between items-center mb-3">
            <div class="flex items-center gap-3">
                <i class="fas fa-images text-purple-400 text-xl"></i>
                <div>
                    <h2 class="text-purple-400 font-bold text-sm">NFT Collection Stats Snapshot</h2>
                    <p class="text-gray-500 text-[10px]">Capture BBL collection stats, listings, and epoch sales</p>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <a href="https://www.thealliancedao.com/tla-nft.html" target="_blank" class="text-[9px] text-purple-400 hover:text-purple-300 bg-purple-900/30 px-2 py-0.5 rounded border border-purple-900/50">
                    <i class="fas fa-external-link-alt mr-1"></i> NFT Explorer
                </a>
                <a href="https://www.randomearth.io/collections/terra13ckenyqrq9aa2kzz3lnfv8el4squx2xmkwdzy9pvtv755d7uku3qamu6wv" target="_blank" class="text-[9px] text-blue-400 hover:text-blue-300 bg-blue-900/30 px-2 py-0.5 rounded border border-blue-900/50">
                    <i class="fas fa-external-link-alt mr-1"></i> RandomEarth
                </a>
                <div id="nft-status" class="px-3 py-1 rounded text-[10px] font-bold bg-gray-800 text-gray-400">
                    Not captured
                </div>
                <button onclick="fetchNftData()" class="bg-purple-900/30 hover:bg-purple-900/50 text-purple-400 px-3 py-1.5 rounded text-[10px] border border-purple-900/50">
                    <i class="fas fa-download mr-1"></i> Fetch from deving.zone
                </button>
            </div>
        </div>
        
        <!-- Prices for NFT -->
        <div class="bg-[#0D0D0D] rounded p-3 mb-3">
            <div class="flex justify-between items-center mb-2">
                <span class="text-[10px] text-gray-400 font-bold">NFT Sale Prices (for USD calculations)</span>
                <button onclick="loadNftPricesFromPriceManager()" class="text-[9px] text-green-400 hover:text-green-300">
                    <i class="fas fa-sync-alt mr-1"></i> Load from Price Manager
                </button>
            </div>
            <div class="grid grid-cols-6 gap-2">
                <div>
                    <label class="text-[8px] text-gray-500">LUNA</label>
                    <input type="number" id="nft-price-luna" step="0.0001" class="input-dark text-[10px]" placeholder="0.166">
                </div>
                <div>
                    <label class="text-[8px] text-gray-500">ampLUNA</label>
                    <input type="number" id="nft-price-ampluna" step="0.0001" class="input-dark text-[10px]" placeholder="0.315">
                </div>
                <div>
                    <label class="text-[8px] text-gray-500">bLUNA</label>
                    <input type="number" id="nft-price-bluna" step="0.0001" class="input-dark text-[10px]" placeholder="0.266">
                </div>
                <div>
                    <label class="text-[8px] text-gray-500">arbLUNA</label>
                    <input type="number" id="nft-price-arbluna" step="0.0001" class="input-dark text-[10px]" placeholder="0.446">
                </div>
                <div>
                    <label class="text-[8px] text-gray-500">SOLID</label>
                    <input type="number" id="nft-price-solid" step="0.0001" class="input-dark text-[10px]" placeholder="0.014">
                </div>
                <div>
                    <label class="text-[8px] text-gray-500">USDC</label>
                    <input type="number" id="nft-price-usdc" step="0.0001" class="input-dark text-[10px]" value="1.00">
                </div>
            </div>
        </div>
    </div>
    
    <!-- BBL Collection Data -->
    <div class="grid grid-cols-2 gap-4 mb-4">
        <div class="bg-[#161616] p-3 rounded border border-purple-800">
            <h3 class="text-purple-400 font-bold text-xs mb-3">🦁 BBL Collection Stats</h3>
            <textarea id="nft-bbl-collection-json" class="input-dark h-24 font-mono text-[9px] mb-2" placeholder='Paste BBL collection JSON from deving.zone API...'></textarea>
            <div class="flex gap-2">
                <button onclick="parseNftBblCollection()" class="btn-action flex-1 bg-purple-900/30 text-purple-300 border border-purple-900/50">Parse Collection</button>
                <span id="nft-bbl-collection-status" class="text-[9px] text-gray-500 self-center">-</span>
            </div>
            <div id="nft-bbl-collection-results" class="hidden mt-3 bg-[#0D0D0D] rounded p-2 text-[10px]">
                <div class="flex justify-between"><span class="text-gray-500">All-time Volume:</span><span id="nft-bbl-volume" class="text-purple-400 font-mono">--</span></div>
                <div class="flex justify-between"><span class="text-gray-500">Most Recent Sale:</span><span id="nft-bbl-recent" class="text-white font-mono">--</span></div>
            </div>
        </div>
        
        <div class="bg-[#161616] p-3 rounded border border-purple-800">
            <h3 class="text-purple-400 font-bold text-xs mb-3">📋 BBL Listings</h3>
            <textarea id="nft-bbl-listings-json" class="input-dark h-24 font-mono text-[9px] mb-2" placeholder='Paste BBL listings JSON...'></textarea>
            <div class="flex gap-2">
                <button onclick="parseNftBblListings()" class="btn-action flex-1 bg-purple-900/30 text-purple-300 border border-purple-900/50">Parse Listings</button>
                <span id="nft-bbl-listings-status" class="text-[9px] text-gray-500 self-center">-</span>
            </div>
            <div id="nft-bbl-floors" class="mt-3 bg-[#0D0D0D] rounded p-2 text-[10px] space-y-2">
                <div class="grid grid-cols-3 gap-2">
                    <div><label class="text-[8px] text-gray-500">Floor Unbroken ID</label><input type="text" id="nft-floor-unbroken-id" class="input-dark text-[9px]"></div>
                    <div><label class="text-[8px] text-gray-500">bLUNA</label><input type="number" id="nft-floor-unbroken-amount" class="input-dark text-[9px]"></div>
                    <div><label class="text-[8px] text-gray-500">USD</label><span id="nft-floor-unbroken-usd" class="text-green-400">--</span></div>
                </div>
                <div class="grid grid-cols-3 gap-2">
                    <div><label class="text-[8px] text-gray-500">Floor Broken ID</label><input type="text" id="nft-floor-broken-id" class="input-dark text-[9px]"></div>
                    <div><label class="text-[8px] text-gray-500">bLUNA</label><input type="number" id="nft-floor-broken-amount" class="input-dark text-[9px]"></div>
                    <div><label class="text-[8px] text-gray-500">USD</label><span id="nft-floor-broken-usd" class="text-green-400">--</span></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Epoch Sales -->
    <div class="grid grid-cols-2 gap-4 mb-4">
        <div class="bg-[#161616] p-3 rounded border border-orange-800">
            <h3 class="text-orange-400 font-bold text-xs mb-3">🔥 BBL Epoch Sales</h3>
            <div class="grid grid-cols-4 gap-2 mb-2">
                <input type="text" id="nft-bbl-sale-id" class="input-dark text-[9px]" placeholder="NFT ID">
                <input type="number" id="nft-bbl-sale-amount" class="input-dark text-[9px]" placeholder="Amount">
                <select id="nft-bbl-sale-token" class="input-dark text-[9px]">
                    <option value="bLUNA">bLUNA</option>
                    <option value="LUNA">LUNA</option>
                    <option value="ampLUNA">ampLUNA</option>
                    <option value="USDC">USDC</option>
                </select>
                <button onclick="addNftBblSale()" class="btn-action text-[9px] !mt-0 bg-orange-900/30 text-orange-300">+ Add</button>
            </div>
            <div id="nft-bbl-sales-list" class="max-h-[150px] overflow-y-auto custom-scroll text-[9px] space-y-1">
                <div class="text-gray-600 italic">No sales added</div>
            </div>
        </div>
        
        <div class="bg-[#161616] p-3 rounded border border-cyan-800">
            <h3 class="text-cyan-400 font-bold text-xs mb-3">🚀 Boost Epoch Sales</h3>
            <div class="grid grid-cols-4 gap-2 mb-2">
                <input type="text" id="nft-boost-sale-id" class="input-dark text-[9px]" placeholder="NFT ID">
                <input type="number" id="nft-boost-sale-amount" class="input-dark text-[9px]" placeholder="Amount">
                <select id="nft-boost-sale-token" class="input-dark text-[9px]">
                    <option value="LUNA">LUNA</option>
                    <option value="ampLUNA">ampLUNA</option>
                    <option value="bLUNA">bLUNA</option>
                    <option value="USDC">USDC</option>
                </select>
                <button onclick="addNftBoostSale()" class="btn-action text-[9px] !mt-0 bg-cyan-900/30 text-cyan-300">+ Add</button>
            </div>
            <div id="nft-boost-sales-list" class="max-h-[150px] overflow-y-auto custom-scroll text-[9px] space-y-1">
                <div class="text-gray-600 italic">No sales added</div>
            </div>
        </div>
    </div>
    
    <!-- NFT Snapshot Preview -->
    <div class="preview-card">
        <div class="flex justify-between items-center mb-2 border-b border-gray-800 pb-2">
            <h3 class="text-xs font-bold text-white">💾 NFT Snapshot Preview</h3>
            <button onclick="downloadNftSnapshot()" class="text-[9px] bg-purple-900/30 text-purple-300 px-2 py-1 rounded hover:bg-purple-900/50 border border-purple-900/50">
                <i class="fas fa-download mr-1"></i> Download Snapshot
            </button>
        </div>
        <pre id="nft-snapshot-preview" class="text-[9px] text-gray-400 font-mono bg-[#0D0D0D] p-3 rounded max-h-[200px] overflow-auto custom-scroll">
{ "snapshot_time": null, "bbl": {}, "boost": {} }
        </pre>
    </div>
</div>

<!-- WS: TERRA NEWS -->
<div id="ws-news" class="workspace">
    <div class="bg-[#161616] border border-orange-900/50 rounded-lg p-4 mb-4">
        <div class="flex justify-between items-center mb-3">
            <div class="flex items-center gap-3">
                <i class="fas fa-newspaper text-orange-400 text-xl"></i>
                <div>
                    <h2 class="text-orange-400 font-bold text-sm">Terra Ecosystem News</h2>
                    <p class="text-gray-500 text-[10px]">Collect and organize news articles for the ecosystem</p>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <a href="https://twitter.com/search?q=%23TerraLuna%20OR%20%24LUNA" target="_blank" class="text-[9px] text-blue-400 hover:text-blue-300 bg-blue-900/30 px-2 py-0.5 rounded border border-blue-900/50">
                    <i class="fab fa-twitter mr-1"></i> Twitter
                </a>
                <a href="https://agora.terra.money/" target="_blank" class="text-[9px] text-teal-400 hover:text-teal-300 bg-teal-900/30 px-2 py-0.5 rounded border border-teal-900/50">
                    <i class="fas fa-comments mr-1"></i> Agora
                </a>
                <button onclick="loadNewsFromGithub()" class="bg-gray-800 hover:bg-gray-700 text-gray-300 px-3 py-1.5 rounded text-[10px] border border-gray-700">
                    <i class="fas fa-cloud-download-alt mr-1"></i> Load Existing
                </button>
                <button onclick="downloadNewsJson()" class="bg-orange-900/30 hover:bg-orange-900/50 text-orange-400 px-3 py-1.5 rounded text-[10px] border border-orange-900/50">
                    <i class="fas fa-download mr-1"></i> Download JSON
                </button>
            </div>
        </div>
    </div>
    
    <!-- Add New Article -->
    <div class="bg-[#161616] p-4 rounded border border-orange-800 mb-4">
        <h3 class="text-orange-400 font-bold text-xs mb-3">➕ Add New Article</h3>
        <div class="grid grid-cols-2 gap-4">
            <div class="space-y-2">
                <div>
                    <label class="text-[9px] text-gray-500">Title *</label>
                    <input type="text" id="news-title" class="input-dark text-[11px]" placeholder="Article title...">
                </div>
                <div>
                    <label class="text-[9px] text-gray-500">Source URL *</label>
                    <input type="url" id="news-url" class="input-dark text-[11px]" placeholder="https://...">
                </div>
                <div>
                    <label class="text-[9px] text-gray-500">Date</label>
                    <input type="date" id="news-date" class="input-dark text-[11px]">
                </div>
                <div>
                    <label class="text-[9px] text-gray-500">Tags (comma separated)</label>
                    <input type="text" id="news-tags" class="input-dark text-[11px]" placeholder="governance, update, tfl">
                </div>
            </div>
            <div class="space-y-2">
                <div>
                    <label class="text-[9px] text-gray-500">Summary / Content</label>
                    <textarea id="news-content" class="input-dark h-24 text-[11px]" placeholder="Article summary or key points..."></textarea>
                </div>
                <div>
                    <label class="text-[9px] text-gray-500">Image URLs (one per line)</label>
                    <textarea id="news-images" class="input-dark h-16 text-[11px]" placeholder="https://image1.jpg&#10;https://image2.jpg"></textarea>
                </div>
            </div>
        </div>
        <button onclick="addNewsArticle()" class="btn-action bg-orange-900/30 text-orange-300 border border-orange-900/50 mt-3">
            <i class="fas fa-plus mr-1"></i> Add Article
        </button>
    </div>
    
    <!-- Articles List -->
    <div class="preview-card">
        <div class="flex justify-between items-center mb-2 border-b border-gray-800 pb-2">
            <h3 class="text-xs font-bold text-white">📰 News Articles (<span id="news-count">0</span>)</h3>
            <button onclick="clearAllNews()" class="text-[9px] text-red-400 hover:text-red-300">Clear All</button>
        </div>
        <div id="news-articles-list" class="space-y-2 max-h-[400px] overflow-y-auto custom-scroll">
            <div class="text-gray-600 text-[10px] italic">No articles added yet</div>
        </div>
    </div>
</div>

<!-- WS: DAO PROPOSALS -->
<div id="ws-dao" class="workspace">
    <div class="bg-[#161616] border border-blue-900/50 rounded-lg p-4 mb-4">
        <div class="flex justify-between items-center mb-3">
            <div class="flex items-center gap-3">
                <i class="fas fa-landmark text-blue-400 text-xl"></i>
                <div>
                    <h2 class="text-blue-400 font-bold text-sm">DAO Proposal History</h2>
                    <p class="text-gray-500 text-[10px]">Track aDAO proposals, voting records, and outcomes</p>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <a href="https://daodao.zone/dao/terra1csp8gsjk2yyxzqewza6lkjvwkspn7zs2jvamk9uf05crtcakf6gszk2g8y/proposals" target="_blank" class="text-[9px] text-blue-400 hover:text-blue-300 bg-blue-900/30 px-2 py-0.5 rounded border border-blue-900/50">
                    <i class="fas fa-external-link-alt mr-1"></i> DAODAO
                </a>
                <button onclick="loadProposalsFromGithub()" class="bg-gray-800 hover:bg-gray-700 text-gray-300 px-3 py-1.5 rounded text-[10px] border border-gray-700">
                    <i class="fas fa-cloud-download-alt mr-1"></i> Load Existing
                </button>
                <button onclick="fetchProposalsFromDaodao()" class="bg-blue-900/30 hover:bg-blue-900/50 text-blue-400 px-3 py-1.5 rounded text-[10px] border border-blue-900/50">
                    <i class="fas fa-sync-alt mr-1"></i> Fetch from DAODAO
                </button>
            </div>
        </div>
    </div>
    
    <!-- Add/Edit Proposal -->
    <div class="bg-[#161616] p-4 rounded border border-blue-800 mb-4">
        <h3 class="text-blue-400 font-bold text-xs mb-3">➕ Add/Edit Proposal</h3>
        <div class="grid grid-cols-3 gap-4">
            <div class="space-y-2">
                <div>
                    <label class="text-[9px] text-gray-500">Proposal ID *</label>
                    <input type="text" id="dao-prop-id" class="input-dark text-[11px]" placeholder="A-31">
                </div>
                <div>
                    <label class="text-[9px] text-gray-500">Title *</label>
                    <input type="text" id="dao-prop-title" class="input-dark text-[11px]" placeholder="Proposal title...">
                </div>
                <div>
                    <label class="text-[9px] text-gray-500">Status</label>
                    <select id="dao-prop-status" class="input-dark text-[11px]">
                        <option value="passed">✅ Passed</option>
                        <option value="rejected">❌ Rejected</option>
                        <option value="executed">🟢 Executed</option>
                        <option value="pending">⏳ Pending</option>
                        <option value="vetoed">🚫 Vetoed</option>
                    </select>
                </div>
            </div>
            <div class="space-y-2">
                <div>
                    <label class="text-[9px] text-gray-500">Date</label>
                    <input type="date" id="dao-prop-date" class="input-dark text-[11px]">
                </div>
                <div>
                    <label class="text-[9px] text-gray-500">DAODAO Link</label>
                    <input type="url" id="dao-prop-link" class="input-dark text-[11px]" placeholder="https://daodao.zone/...">
                </div>
                <div>
                    <label class="text-[9px] text-gray-500">Category</label>
                    <select id="dao-prop-category" class="input-dark text-[11px]">
                        <option value="governance">Governance</option>
                        <option value="treasury">Treasury</option>
                        <option value="investment">Investment</option>
                        <option value="operations">Operations</option>
                        <option value="other">Other</option>
                    </select>
                </div>
            </div>
            <div class="space-y-2">
                <div>
                    <label class="text-[9px] text-gray-500">Description/Summary</label>
                    <textarea id="dao-prop-description" class="input-dark h-20 text-[11px]" placeholder="What the proposal does..."></textarea>
                </div>
                <div class="grid grid-cols-3 gap-1">
                    <div>
                        <label class="text-[8px] text-gray-500">Yes %</label>
                        <input type="number" id="dao-prop-yes" class="input-dark text-[10px]" placeholder="85">
                    </div>
                    <div>
                        <label class="text-[8px] text-gray-500">No %</label>
                        <input type="number" id="dao-prop-no" class="input-dark text-[10px]" placeholder="10">
                    </div>
                    <div>
                        <label class="text-[8px] text-gray-500">Abstain %</label>
                        <input type="number" id="dao-prop-abstain" class="input-dark text-[10px]" placeholder="5">
                    </div>
                </div>
            </div>
        </div>
        <button onclick="addDaoProposal()" class="btn-action bg-blue-900/30 text-blue-300 border border-blue-900/50 mt-3">
            <i class="fas fa-plus mr-1"></i> Add Proposal
        </button>
    </div>
    
    <!-- Proposals List -->
    <div class="preview-card">
        <div class="flex justify-between items-center mb-2 border-b border-gray-800 pb-2">
            <h3 class="text-xs font-bold text-white">🏛️ Proposals (<span id="dao-count">0</span>)</h3>
            <div class="flex gap-2">
                <select id="dao-filter-status" class="input-dark text-[9px] w-24" onchange="renderDaoProposals()">
                    <option value="all">All</option>
                    <option value="passed">Passed</option>
                    <option value="rejected">Rejected</option>
                    <option value="executed">Executed</option>
                </select>
                <button onclick="downloadDaoJson()" class="text-[9px] bg-blue-900/30 text-blue-300 px-2 py-1 rounded border border-blue-900/50">
                    <i class="fas fa-download mr-1"></i> Export
                </button>
            </div>
        </div>
        <div id="dao-proposals-list" class="space-y-2 max-h-[400px] overflow-y-auto custom-scroll">
            <div class="text-gray-600 text-[10px] italic">No proposals added yet</div>
        </div>
    </div>
</div>

<script>
const $ = id => document.getElementById(id);
const setTxt = (id, v) => { const e = $(id); if(e) e.innerText = v; };
const setHtml = (id, v) => { const e = $(id); if(e) e.innerHTML = v; };
const clean = s => { if(!s)return 0; let m=1; if(/[\d\.]\s*[Kk]($|[\s\W])/.test(s))m=1e3; if(/[\d\.]\s*[Mm]($|[\s\W])/.test(s))m=1e6; return parseFloat(s.replace(/[^0-9\.]/g,''))*m||0; };
const fmt$ = n => '$'+n.toLocaleString(undefined,{maximumFractionDigits:0});

let store = {
    meta: { ep: 0, ph: 'end' },
    mode: 'staging', // 'staging' or 'normal'
    lpRegistry: {},  // { "LUNA-USDC": { bucket, sources: { Astroport: { vote_pct } }, active } }
    votion: { lockups: [], ratioArb: null, ratioAmp: null },
    // Comprehensive LST ratios and APYs - all start empty
    lstRatios: {
        ampLUNA: { ratio: null, base: 'LUNA', apy: null, updated: null },
        arbLUNA: { ratio: null, base: 'LUNA', apy: null, updated: null },
        bLUNA: { ratio: null, base: 'LUNA', apy: null, updated: null }, // bLUNA doesn't show APY on BBL
        ampCAPA: { ratio: null, base: 'CAPA', apy: null, updated: null },
        ampROAR: { ratio: null, base: 'ROAR', apy: null, updated: null },
        xASTRO: { ratio: null, base: 'ASTRO', apy: null, updated: null },
        chainStakingApr: null,
        chainStakingAprDate: null,
        allUpdated: false
    },
    pdBribesHistory: [],
    pdNewProp: null,
    staging: {
        day1: null,
        day2: null,
        day3: null,
        day4: null
    },
    historical: { lps: {}, meta: {} },
    current: { lps: {}, meta: {} },
    ww: [],
    liveEpoch: null, // { epoch, end_time, phase, daysRemaining }
    prevExt: null,    // Loaded previous ext file for reference
    // Token prices from CoinGecko and calculated
    tokenPrices: {},  // { LUNA: { price, source: 'coingecko'|'calculated'|'manual' }, ... }
    skippedTokens: {}, // { TOKEN: true } for tokens user wants to skip
    // Verification flags for workflow steps
    lpRegistryVerified: false,
    ratiosVerified: false,
    pricesVerified: false,
    tokenPricesVerified: false,
    votionVerified: false,
    pdBribesVerified: false,
    dashboardVerified: false,
    nftVerified: false,
    newsVerified: false,
    daoVerified: false
};

// GitHub URLs
const GITHUB_BASE = 'https://raw.githubusercontent.com/defipatriot/tla-ext_json_storage/main/';
const STAGING_URLS = {
    day1: GITHUB_BASE + 'tla_ext_staging_day1.json',
    day2: GITHUB_BASE + 'tla_ext_staging_day2.json',
    day3: GITHUB_BASE + 'tla_ext_staging_day3.json',
    day4: GITHUB_BASE + 'tla_ext_staging_day4.json'
};
const HISTORICAL_URL = GITHUB_BASE + 'tla_ext_historical.json';
const CURRENT_URL = GITHUB_BASE + 'tla_ext_current.json';
const PD_BRIBES_GITHUB_URL = GITHUB_BASE + 'tla_pd_bribes.json';
const STAKING_APR_CSV_URL = 'https://raw.githubusercontent.com/defipatriot/tla-ext_json_storage/main/Staking%20APR.csv';

// LST Hub Contracts for auto-fetching ratios - WORKING CONFIG
const lstContracts = {
    ampLUNA: {
        hub: 'terra10788fkzah89xrdm27zkj5yvhj9x3494lxawzm5qq3vvxcqz2yzaqyd3enk',
        query: 'exchange_rates',
        parse: (data) => parseFloat(data?.data?.exchange_rates?.[0]?.[1] || 0)
    },
    arbLUNA: {
        hub: 'terra1r9gls56glvuc4jedsvc3uwh6vj95mqm9efc7hnweqxa2nlme5cyqxygy5m',
        query: 'state',
        parse: (data) => parseFloat(data?.data?.exchange_rate || 0)
    },
    ampROAR: {
        hub: 'terra1vklefn7n6cchn0u962w3gaszr4vf52wjvd4y95t2sydwpmpdtszsqvk9wy',
        query: 'state',
        parse: (data) => parseFloat(data?.data?.exchange_rate || 0)
    },
    ampCAPA: {
        hub: 'terra186rpfczl7l2kugdsqqedegl4es4hp624phfc7ddy8my02a4e8lgq5rlx7y',
        query: 'state',
        parse: (data) => parseFloat(data?.data?.exchange_rate || 0)
    },
    bLUNA: {
        hub: 'terra1l2nd99yze5fszmhl5svyh5fky9wm4nz4etlgnztfu4e8809gd52q04n3ea',
        query: 'state',
        parse: (data) => parseFloat(data?.data?.exchange_rate || 0)
    }
};

// Epoch calculation constants
const EPOCH_ANCHOR_DATE = new Date(Date.UTC(2025, 10, 17, 0, 0, 0)); // Nov 17, 2025 = Epoch 160
const EPOCH_ANCHOR_NUM = 160;
const SECONDS_PER_WEEK = 604800;

// CoinGecko ID mapping for tokens
const COINGECKO_IDS = {
    'LUNA': 'terra-luna-2',
    'USDC': 'usd-coin',
    'USDT': 'tether',
    'WBTC': 'wrapped-bitcoin',
    'ATOM': 'cosmos',
    'ETH': 'ethereum',
    'WETH': 'ethereum',
    'PAXG': 'pax-gold',
    'EURE': 'euroe-stablecoin',
    'INJ': 'injective-protocol',
    'ASTRO': 'astroport-fi',
    'SOLID': 'solid-2',
    'FUEL': null, // Not on CoinGecko
    'SWTH': 'switcheo',
    'ROAR': 'lion-dao',
    'CAPA': 'capapult',
    'STLUNA': 'stride-staked-luna',
    'WSTETH': 'wrapped-steth',
    'OSMO': 'osmosis',
    'WBNB': 'wbnb',
    'BNB': 'binancecoin',
    'STATOM': 'stride-staked-atom'
};

// Tokens that need calculation from ratio: price = base_price * ratio
const CALCULATED_TOKENS = {
    'AMPLUNA': { base: 'LUNA', ratioKey: 'ampLUNA' },
    'ARBLUNA': { base: 'LUNA', ratioKey: 'arbLUNA' },
    'BLUNA': { base: 'LUNA', ratioKey: 'bLUNA' },
    'BONELUNA': { base: 'LUNA', ratioKey: 'bLUNA' },  // boneLUNA = bLUNA, same ratio
    'AMPCAPA': { base: 'CAPA', ratioKey: 'ampCAPA' },
    'AMPROAR': { base: 'ROAR', ratioKey: 'ampROAR' },
    'XASTRO': { base: 'ASTRO', ratioKey: 'xASTRO' }
};

// Quick lookup URLs for tokens not on CoinGecko (opens in preview modal)
const TOKEN_LOOKUP_URLS = {
    'FUEL': 'https://app.astroport.fi/swap?chain=terra&to=ibc%2F4B44179AC2F0BEE50C16A673B3B886398988692885B2848A1C8AEF27148B3961&from=uluna'
};

async function fetchAllTokenPrices() {
    // Get unique base tokens from LP registry (use lp property, not the key which includes DEX)
    const uniqueTokens = new Set();
    
    Object.values(store.lpRegistry).forEach(lpData => {
        // Use the lp property which has clean pair name like "LUNA-USDC"
        const lpName = lpData.lp || '';
        const parts = lpName.split('-');
        parts.forEach(t => {
            // Normalize: remove bridge suffixes, uppercase everything
            let normalized = t.toUpperCase()
                .replace(/\.(AXL|OSMO|ATOM|WH)/gi, '');  // Remove bridge suffixes
            
            if (normalized) uniqueTokens.add(normalized);
        });
    });
    
    // Add core tokens we always need
    ['LUNA', 'ASTRO', 'ROAR', 'CAPA'].forEach(t => uniqueTokens.add(t));
    
    const tokenList = Array.from(uniqueTokens).sort();
    setTxt('price-found-count', tokenList.length);
    
    // Build CoinGecko query
    const geckoIds = [];
    const tokenToGecko = {};
    
    tokenList.forEach(token => {
        const geckoId = COINGECKO_IDS[token];
        if (geckoId) {
            geckoIds.push(geckoId);
            tokenToGecko[geckoId] = token;
        }
    });
    
    // Fetch from CoinGecko
    let cgCount = 0;
    if (geckoIds.length > 0) {
        try {
            const url = `https://api.coingecko.com/api/v3/simple/price?ids=${geckoIds.join(',')}&vs_currencies=usd`;
            const resp = await fetch(url);
            const data = await resp.json();
            
            Object.entries(data).forEach(([geckoId, priceData]) => {
                const token = tokenToGecko[geckoId];
                if (token && priceData.usd) {
                    store.tokenPrices[token] = {
                        price: priceData.usd,
                        source: 'coingecko'
                    };
                    cgCount++;
                }
            });
        } catch (e) {
            console.error('CoinGecko fetch error:', e);
        }
    }
    setTxt('price-cg-count', cgCount);
    
    // Calculate derived LST prices (ampLUNA, arbLUNA, etc.)
    let calcCount = 0;
    Object.entries(CALCULATED_TOKENS).forEach(([token, config]) => {
        const basePrice = store.tokenPrices[config.base]?.price;
        const ratio = store.lstRatios[config.ratioKey]?.ratio;
        
        if (basePrice && ratio) {
            store.tokenPrices[token] = {
                price: basePrice * ratio,
                source: 'calculated',
                formula: `${config.base} × ${ratio.toFixed(4)}`
            };
            calcCount++;
            // Also add to token list if not there
            if (!tokenList.includes(token)) tokenList.push(token);
        }
    });
    setTxt('price-calc-count', calcCount);
    
    // Update LUNA display
    if (store.tokenPrices.LUNA) {
        setTxt('price-luna', '$' + store.tokenPrices.LUNA.price.toFixed(4));
    }
    
    // Render the two lists - include calculated tokens
    renderTokenPriceLists(tokenList.sort());
    updatePricesStatus();
    updateWorkflowStatus();
}

function renderTokenPriceLists(tokens) {
    const autoContainer = $('token-price-auto');
    const manualContainer = $('token-price-manual');
    if (!autoContainer || !manualContainer) return;
    
    let autoHtml = '';
    let manualHtml = '';
    let manualCount = 0;
    
    // Sort tokens alphabetically
    const sorted = [...tokens].sort();
    
    sorted.forEach(token => {
        const priceData = store.tokenPrices[token];
        const isSkipped = store.skippedTokens?.[token];
        
        if (priceData) {
            // Auto-fetched (CoinGecko, Calculated, Manual, or Custom) - all show in left list
            const priceStr = formatPrice(priceData.price);
            const isCalc = priceData.source === 'calculated';
            const isCustom = priceData.source === 'custom' || priceData.source === 'manual';
            // All are "auto" now - show green
            const dotColor = 'text-green-400';
            const bgColor = 'bg-green-900/10 border-green-900/30';
            let sourceLabel = '';
            if (isCalc) {
                sourceLabel = `<span class="text-yellow-400 text-[8px] ml-2">(${priceData.formula})</span>`;
            } else if (isCustom) {
                sourceLabel = `<span class="text-cyan-400 text-[8px] ml-2">(manual)</span>`;
            }
            
            autoHtml += `
                <div class="flex items-center justify-between p-2 rounded border ${bgColor}">
                    <div class="flex items-center gap-2">
                        <span class="${dotColor} text-[10px]">●</span>
                        <span class="text-white font-bold text-[11px]">${token}</span>
                        ${sourceLabel}
                    </div>
                    <span class="text-white font-mono text-[11px]">${priceStr}</span>
                </div>
            `;
        } else {
            // Manual entry needed
            manualCount++;
            const skipChecked = isSkipped ? 'checked' : '';
            const rowClass = isSkipped ? 'opacity-50' : '';
            const hasLookup = TOKEN_LOOKUP_URLS[token];
            const lookupBtn = hasLookup ? `
                <button onclick="openTokenLookup('${token}')" class="text-[9px] text-cyan-400 hover:text-cyan-300 bg-cyan-900/30 px-1.5 py-0.5 rounded border border-cyan-900/50" title="Look up price">
                    <i class="fas fa-search"></i>
                </button>
            ` : '';
            
            manualHtml += `
                <div class="flex items-center justify-between p-2 rounded border bg-red-900/10 border-red-900/30 ${rowClass}" id="price-row-${token}">
                    <div class="flex items-center gap-2">
                        <input type="checkbox" ${skipChecked} onchange="toggleSkipToken('${token}')" class="w-3 h-3" title="Skip this token">
                        <span class="text-red-400 text-[10px]">●</span>
                        <span class="text-white font-bold text-[11px]">${token}</span>
                        ${lookupBtn}
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-gray-500 text-[10px]">$</span>
                        <input type="number" step="any" class="input-dark w-24 text-[10px] text-right py-1" 
                               placeholder="0.00" id="manual-price-${token}"
                               onchange="setManualPrice('${token}', this.value)"
                               ${isSkipped ? 'disabled' : ''}>
                    </div>
                </div>
            `;
        }
    });
    
    autoContainer.innerHTML = autoHtml || '<div class="text-gray-500 text-[10px] text-center p-4">No prices fetched yet</div>';
    manualContainer.innerHTML = manualHtml || '<div class="text-green-400 text-[10px] text-center p-4">✓ All tokens have prices!</div>';
    
    setTxt('price-manual-count', manualCount);
}

// Smart price formatting - show all zeros, no scientific notation
function formatPrice(price) {
    if (price === 0) return '$0.00';
    if (price >= 1000) return '$' + price.toLocaleString(undefined, { maximumFractionDigits: 2 });
    if (price >= 1) return '$' + price.toFixed(4);
    if (price >= 0.01) return '$' + price.toFixed(6);
    if (price >= 0.0001) return '$' + price.toFixed(8);
    if (price >= 0.000001) return '$' + price.toFixed(10);
    // For extremely small, show up to 12 decimals
    return '$' + price.toFixed(12);
}

function toggleSkipToken(token) {
    if (!store.skippedTokens) store.skippedTokens = {};
    store.skippedTokens[token] = !store.skippedTokens[token];
    
    const row = $(`price-row-${token}`);
    const input = $(`manual-price-${token}`);
    
    if (store.skippedTokens[token]) {
        row?.classList.add('opacity-50');
        if (input) input.disabled = true;
    } else {
        row?.classList.remove('opacity-50');
        if (input) input.disabled = false;
    }
    
    updatePricesStatus();
    updateWorkflowStatus();
}

function setManualPrice(token, value) {
    const price = parseFloat(value);
    if (price > 0) {
        store.tokenPrices[token] = {
            price: price,
            source: 'manual'
        };
        
        // Move from manual to auto list by re-rendering
        const tokens = Object.keys(store.tokenPrices).concat(
            Object.keys(store.skippedTokens || {})
        );
        renderTokenPriceLists([...new Set(tokens)]);
    }
    updatePricesStatus();
    updateWorkflowStatus();
}

function addCustomToken() {
    const nameInput = $('custom-token-name');
    const priceInput = $('custom-token-price');
    
    const name = nameInput?.value?.trim().toUpperCase();
    const price = parseFloat(priceInput?.value);
    
    if (!name) {
        alert('Enter a token name');
        return;
    }
    
    if (!price || price <= 0) {
        alert('Enter a valid price');
        return;
    }
    
    // Add to store
    store.tokenPrices[name] = {
        price: price,
        source: 'custom'
    };
    
    // Clear inputs
    nameInput.value = '';
    priceInput.value = '';
    
    // Re-render lists
    const tokens = Object.keys(store.tokenPrices).concat(
        Object.keys(store.skippedTokens || {})
    );
    renderTokenPriceLists([...new Set(tokens)]);
    updatePricesStatus();
    updateWorkflowStatus();
}

function updatePricesStatus() {
    const totalTokens = Object.keys(store.tokenPrices).length;
    const skippedCount = Object.values(store.skippedTokens || {}).filter(Boolean).length;
    
    const statusEl = $('prices-all-status');
    if (statusEl) {
        if (store.tokenPricesVerified || totalTokens >= 10) {
            statusEl.innerHTML = `<i class="fas fa-check-circle mr-1"></i> ${totalTokens} Tokens`;
            statusEl.className = 'px-3 py-1 rounded text-[10px] font-bold bg-green-900/30 text-green-400 border border-green-700 cursor-pointer hover:opacity-80';
        } else if (totalTokens > 0) {
            statusEl.innerHTML = `<i class="fas fa-exclamation-circle mr-1"></i> ${totalTokens} Tokens (click to override)`;
            statusEl.className = 'px-3 py-1 rounded text-[10px] font-bold bg-yellow-900/30 text-yellow-400 border border-yellow-700 cursor-pointer hover:opacity-80';
        } else {
            statusEl.innerHTML = '<i class="fas fa-exclamation-circle mr-1"></i> 0 Tokens';
            statusEl.className = 'px-3 py-1 rounded text-[10px] font-bold bg-red-900/30 text-red-400 border border-red-700 cursor-pointer hover:opacity-80';
        }
    }
}

let pasteStatus = { votion: false, pd: false, astro: false, ww: false };

function updatePasteStatus(id, done) {
    const el = $(id);
    if (el) {
        if (done) el.classList.add('status-done');
        else el.classList.remove('status-done');
    }
}

function clearPaste(id) {
    const el = $(id);
    if (el) el.value = '';
}

function parseRatioPaste() {
    let txt = $('ratioPaste').value;
    // Parse "1 ampLUNA = 1.8707 LUNA" or "1 arbLUNA = 2.4362 LUNA"
    let match = txt.match(/1\s*(amp|arb)LUNA\s*=\s*([\d\.]+)\s*LUNA/i);
    if (match) {
        let type = match[1].toLowerCase();
        let ratio = parseFloat(match[2]);
        if (type === 'amp') {
            $('ratioAmp').value = ratio;
            store.votion.ratioAmp = ratio;
            store.votion.ratioAmpUpdated = new Date().toISOString();
        } else if (type === 'arb') {
            $('ratioArb').value = ratio;
            store.votion.ratioArb = ratio;
            store.votion.ratioArbUpdated = new Date().toISOString();
        }
        $('ratioPaste').value = ''; // Clear after parse
        updateRatios();
        recalcVotion();
    }
}

function updateRatios() {
    // Check if ratios and APYs are set in store
    const arbRatioSet = store.votion.ratioArb !== null && store.votion.ratioArb > 0;
    const ampRatioSet = store.votion.ratioAmp !== null && store.votion.ratioAmp > 0;
    const arbApySet = store.lstRatios.arbLUNA?.apy !== null && store.lstRatios.arbLUNA?.apy > 0;
    const ampApySet = store.lstRatios.ampLUNA?.apy !== null && store.lstRatios.ampLUNA?.apy > 0;
    
    // Update display spans for ratios
    const ratioArbEl = $('ratioArb');
    const ratioAmpEl = $('ratioAmp');
    if (ratioArbEl) ratioArbEl.textContent = arbRatioSet ? store.votion.ratioArb.toFixed(4) : '--';
    if (ratioAmpEl) ratioAmpEl.textContent = ampRatioSet ? store.votion.ratioAmp.toFixed(4) : '--';
    
    // Update display spans for APYs
    const apyArbEl = $('apyArb');
    const apyAmpEl = $('apyAmp');
    if (apyArbEl) apyArbEl.textContent = arbApySet ? store.lstRatios.arbLUNA.apy.toFixed(2) + '%' : '--';
    if (apyAmpEl) apyAmpEl.textContent = ampApySet ? store.lstRatios.ampLUNA.apy.toFixed(2) + '%' : '--';
    
    // Update individual status indicators for ratios
    const arbRatioStatus = $('votion-arb-ratio-status');
    const ampRatioStatus = $('votion-amp-ratio-status');
    if (arbRatioStatus) {
        arbRatioStatus.textContent = arbRatioSet ? '✓' : '✗';
        arbRatioStatus.className = arbRatioSet ? 'text-green-400' : 'text-red-400';
    }
    if (ampRatioStatus) {
        ampRatioStatus.textContent = ampRatioSet ? '✓' : '✗';
        ampRatioStatus.className = ampRatioSet ? 'text-green-400' : 'text-red-400';
    }
    
    // Update individual status indicators for APYs
    const arbApyStatus = $('votion-arb-apy-status');
    const ampApyStatus = $('votion-amp-apy-status');
    if (arbApyStatus) {
        arbApyStatus.textContent = arbApySet ? '✓' : '✗';
        arbApyStatus.className = arbApySet ? 'text-green-400' : 'text-red-400';
    }
    if (ampApyStatus) {
        ampApyStatus.textContent = ampApySet ? '✓' : '✗';
        ampApyStatus.className = ampApySet ? 'text-green-400' : 'text-red-400';
    }
    
    // Update main status card - need ALL 4 to be ready
    const allReady = arbRatioSet && ampRatioSet && arbApySet && ampApySet;
    const ratiosReady = arbRatioSet && ampRatioSet;
    const apysReady = arbApySet && ampApySet;
    
    const card = $('votion-ratios-card');
    const statusDiv = $('votion-ratios-status');
    
    if (card && statusDiv) {
        if (allReady) {
            card.className = 'col-span-4 bg-green-900/20 p-3 rounded border-2 border-green-700 flex flex-col gap-2';
            statusDiv.innerHTML = `
                <div class="text-2xl mb-1">✅</div>
                <div class="text-green-400 font-bold text-[11px]">ALL READY</div>
                <div class="text-gray-400 text-[9px]">VP & APY calculations accurate</div>
            `;
        } else if (ratiosReady && !apysReady) {
            card.className = 'col-span-4 bg-yellow-900/20 p-3 rounded border-2 border-yellow-700 flex flex-col gap-2';
            statusDiv.innerHTML = `
                <div class="text-2xl mb-1">⚠️</div>
                <div class="text-yellow-400 font-bold text-[11px]">APYs MISSING</div>
                <div class="text-gray-400 text-[9px]">Ratios OK, enter APYs manually</div>
            `;
        } else if (!ratiosReady && apysReady) {
            card.className = 'col-span-4 bg-yellow-900/20 p-3 rounded border-2 border-yellow-700 flex flex-col gap-2';
            statusDiv.innerHTML = `
                <div class="text-2xl mb-1">⚠️</div>
                <div class="text-yellow-400 font-bold text-[11px]">RATIOS MISSING</div>
                <div class="text-gray-400 text-[9px]">APYs OK, fetch ratios</div>
            `;
        } else {
            card.className = 'col-span-4 bg-[#161616] p-3 rounded border-2 border-red-700 flex flex-col gap-2';
            statusDiv.innerHTML = `
                <div class="text-2xl mb-1">⚠️</div>
                <div class="text-red-400 font-bold text-[11px]">NOT READY</div>
                <div class="text-gray-500 text-[9px]">Complete Prices/Ratios tab first</div>
            `;
        }
    }
    
    // Also sync to LST ratios store
    if (store.votion.ratioArb) store.lstRatios.arbLUNA.ratio = store.votion.ratioArb;
    if (store.votion.ratioAmp) store.lstRatios.ampLUNA.ratio = store.votion.ratioAmp;
    
    updateWorkflowStatus();
    recalcVotion();
}

// ============ LST RATIO FUNCTIONS ============

function updateLstRatio(token, value) {
    const ratio = parseFloat(value) || 0;
    if (token === 'chainStakingApr') {
        store.lstRatios.chainStakingApr = ratio;
        store.lstRatios.chainStakingAprDate = new Date().toISOString();
    } else if (store.lstRatios[token]) {
        store.lstRatios[token].ratio = ratio;
        store.lstRatios[token].updated = new Date().toISOString();
        
        // Sync ampLUNA/arbLUNA to votion ratios for VP calculation
        if (token === 'ampLUNA') {
            store.votion.ratioAmp = ratio;
            $('ratioAmp').value = ratio;
        } else if (token === 'arbLUNA') {
            store.votion.ratioArb = ratio;
            $('ratioArb').value = ratio;
        }
    }
    updateLstCardStatus(token);
    updateLstOverallStatus();
    updateWorkflowStatus();
}

function updateLstApy(token, value) {
    const apy = parseFloat(value) || null;
    if (store.lstRatios[token]) {
        store.lstRatios[token].apy = apy;
        store.lstRatios[token].updated = new Date().toISOString();
    }
    updateLstCardStatus(token);
    updateLstOverallStatus();
    updateRatios(); // Sync to Votion tab
    updateWorkflowStatus();
}

function togglePricesOverride() {
    store.ratiosVerified = !store.ratiosVerified;
    updateLstOverallStatus();
    updateWorkflowStatus();
}

function parseLstPaste(token) {
    const pasteEl = $(`lst-paste-${token}`);
    if (!pasteEl) return;
    
    const txt = pasteEl.value;
    if (!txt.trim()) return;
    
    let ratio = null;
    let apy = null;
    
    // Parse based on token type
    if (token === 'ampLUNA' || token === 'arbLUNA') {
        // Eris format: "1 ampLUNA = 1.9015 LUNA" or "1 arbLUNA = 2.6873 LUNA"
        const ratioMatch = txt.match(/1\s*(amp|arb)LUNA\s*=\s*([\d\.]+)\s*LUNA/i);
        if (ratioMatch) ratio = parseFloat(ratioMatch[2]);
        
        // APY: "Amplified APY 29.68%" or "Arbitrage APY 146.24%"
        const apyMatch = txt.match(/(Amplified|Arbitrage)\s*APY[:\s]*([\d\.]+)\s*%/i);
        if (apyMatch) apy = parseFloat(apyMatch[2]);
    }
    else if (token === 'bLUNA') {
        // Backbone format: "1 LUNA = 0.623302 bLUNA" - need to invert
        const bbMatch = txt.match(/1\s*LUNA\s*=\s*([\d\.]+)\s*bLUNA/i);
        if (bbMatch) {
            const inverse = parseFloat(bbMatch[1]);
            if (inverse > 0) ratio = 1 / inverse;
        }
        // Also try direct format "1 bLUNA = X LUNA"
        const directMatch = txt.match(/1\s*bLUNA\s*=\s*([\d\.]+)\s*LUNA/i);
        if (directMatch) ratio = parseFloat(directMatch[1]);
        
        // APY from Backbone (if present)
        const apyMatch = txt.match(/APY[:\s]*([\d\.]+)\s*%/i);
        if (apyMatch) apy = parseFloat(apyMatch[1]);
    }
    else if (token === 'ampCAPA' || token === 'ampROAR') {
        // Eris format: "1 ampCAPA = 1.1055 CAPA" or "1 ampROAR = 1.1087 ROAR"
        const base = token === 'ampCAPA' ? 'CAPA' : 'ROAR';
        const ratioRegex = new RegExp(`1\\s*${token}\\s*=\\s*([\\d\\.]+)\\s*${base}`, 'i');
        const ratioMatch = txt.match(ratioRegex);
        if (ratioMatch) ratio = parseFloat(ratioMatch[1]);
        
        // APY
        const apyMatch = txt.match(/Amplified\s*APY[:\s]*([\d\.]+)\s*%/i);
        if (apyMatch) apy = parseFloat(apyMatch[1]);
    }
    else if (token === 'xASTRO') {
        // Astroport format variations:
        // "13.78%\nAPY\n1:1.22\nxASTRO:ASTRO"
        // "1:1.22 xASTRO:ASTRO"
        // "22.49% APY 1:1.22 xASTRO:ASTRO"
        
        // Try to find ratio - multiline: "1:1.22\nxASTRO:ASTRO" 
        const multilineMatch = txt.match(/1:([\d\.]+)\s*[\n\r]+\s*xASTRO:ASTRO/i);
        if (multilineMatch) ratio = parseFloat(multilineMatch[1]);
        
        // Try inline format: "1:1.22 xASTRO:ASTRO"
        if (!ratio) {
            const inlineMatch = txt.match(/1:([\d\.]+)\s+xASTRO:ASTRO/i);
            if (inlineMatch) ratio = parseFloat(inlineMatch[1]);
        }
        
        // Try any "1:X.XX" pattern followed by xASTRO
        if (!ratio) {
            const generalMatch = txt.match(/1:([\d\.]+)[\s\S]*?xASTRO/i);
            if (generalMatch) ratio = parseFloat(generalMatch[1]);
        }
        
        // APY for xASTRO: "13.78%\nAPY" or "22.49% APY"
        const apyMatch = txt.match(/([\d\.]+)\s*%\s*[\n\r]?\s*APY/i);
        if (apyMatch) apy = parseFloat(apyMatch[1]);
        
        // Also try "APY: 22.49%" format
        if (!apy) {
            const altApyMatch = txt.match(/APY\s*:?\s*([\d\.]+)\s*%/i);
            if (altApyMatch) apy = parseFloat(altApyMatch[1]);
        }
    }
    
    // Update values if found
    if (ratio !== null && ratio > 0) {
        $(`lst-ratio-${token}`).value = ratio.toFixed(4);
        updateLstRatio(token, ratio);
    }
    if (apy !== null) {
        $(`lst-apy-${token}`).value = apy.toFixed(2);
        updateLstApy(token, apy);
    }
    
    // Clear paste box and update status
    if (ratio !== null || apy !== null) {
        pasteEl.value = '';
        updateLstCardStatus(token);
    }
}

function updateLstCardStatus(token) {
    const statusEl = $(`lst-status-${token}`);
    const cardEl = $(`lst-card-${token}`);
    if (!statusEl || !cardEl) return;
    
    const data = store.lstRatios[token];
    if (!data) return;
    
    const isUpdated = data.updated !== null;
    
    if (isUpdated) {
        statusEl.textContent = '✓ updated';
        statusEl.className = 'text-[9px] px-2 py-0.5 rounded bg-green-900/50 text-green-400 text-center mb-2';
        cardEl.className = 'bg-[#161616] rounded-lg p-3 border-2 border-green-700';
    } else {
        statusEl.textContent = 'pending';
        statusEl.className = 'text-[9px] px-2 py-0.5 rounded bg-gray-800 text-gray-500 text-center mb-2';
        cardEl.className = 'bg-[#161616] rounded-lg p-3 border-2 border-gray-700';
    }
}

function updateLstOverallStatus() {
    const ratioTokens = ['ampLUNA', 'arbLUNA', 'bLUNA', 'ampCAPA', 'ampROAR', 'xASTRO'];
    const apyTokens = ['ampLUNA', 'arbLUNA', 'ampCAPA', 'ampROAR', 'xASTRO']; // bLUNA excluded - no APY available
    let ratioCount = 0;
    let apyCount = 0;
    
    ratioTokens.forEach(token => {
        if (store.lstRatios[token]?.ratio > 0) ratioCount++;
    });
    apyTokens.forEach(token => {
        if (store.lstRatios[token]?.apy > 0) apyCount++;
    });
    
    // Also check chain staking APR
    const hasChainApr = store.lstRatios.chainStakingApr > 0;
    
    const allRatios = ratioCount === ratioTokens.length;
    const allApys = apyCount === apyTokens.length;
    const allComplete = allRatios && allApys && hasChainApr;
    
    store.lstRatios.allUpdated = allComplete;
    
    const statusEl = $('lst-all-status');
    if (statusEl) {
        // Check for manual override
        if (store.ratiosVerified) {
            statusEl.innerHTML = '<i class="fas fa-check-circle mr-1"></i> Override ✓';
            statusEl.className = 'px-3 py-1 rounded text-[10px] font-bold bg-green-900/30 text-green-400 border border-green-700 cursor-pointer hover:opacity-80';
        } else if (allComplete) {
            statusEl.innerHTML = '<i class="fas fa-check-circle mr-1"></i> All Complete';
            statusEl.className = 'px-3 py-1 rounded text-[10px] font-bold bg-green-900/30 text-green-400 border border-green-700 cursor-pointer hover:opacity-80';
        } else {
            // Show what's missing
            let missing = [];
            if (!allRatios) missing.push(`Ratios: ${ratioCount}/6`);
            if (!allApys) missing.push(`APYs: ${apyCount}/5`);
            if (!hasChainApr) missing.push('Chain APR');
            statusEl.innerHTML = `<i class="fas fa-exclamation-circle mr-1"></i> ${missing.join(', ')} (click to override)`;
            statusEl.className = 'px-3 py-1 rounded text-[10px] font-bold bg-red-900/30 text-red-400 border border-red-700 cursor-pointer hover:opacity-80';
        }
    }
}

async function fetchChainStakingApr() {
    try {
        const resp = await fetch(STAKING_APR_CSV_URL);
        if (!resp.ok) throw new Error('Failed to fetch');
        
        const text = await resp.text();
        const lines = text.trim().split('\n');
        
        // Get last non-empty line (most recent APR)
        let lastLine = null;
        for (let i = lines.length - 1; i >= 0; i--) {
            if (lines[i].trim() && !lines[i].toLowerCase().includes('title')) {
                lastLine = lines[i];
                break;
            }
        }
        
        if (lastLine) {
            // Parse CSV: "12/19/2025,22.0373" or 12/19/2025,22.0373
            const parts = lastLine.split(',');
            if (parts.length >= 2) {
                const date = parts[0].replace(/"/g, '').trim();
                const apr = parseFloat(parts[1].replace(/"/g, '').trim());
                
                if (apr > 0) {
                    $('lst-chain-apr').value = apr.toFixed(2);
                    $('lst-chain-apr-date').textContent = `Last: ${date}`;
                    
                    store.lstRatios.chainStakingApr = apr;
                    store.lstRatios.chainStakingAprDate = date;
                    
                    // Check if data is stale (more than 2 days old)
                    checkStaleAprData(date);
                    return;
                }
            }
        }
        throw new Error('Could not parse APR');
    } catch (e) {
        console.error('Failed to fetch staking APR:', e);
        $('lst-chain-apr-date').textContent = 'Fetch failed - enter manually';
    }
}

function checkStaleAprData(dateStr) {
    // Parse date string - handle both YYYY-MM-DD and MM/DD/YYYY formats
    let dataDate;
    
    if (dateStr.includes('-')) {
        // YYYY-MM-DD format (ISO)
        dataDate = new Date(dateStr);
    } else if (dateStr.includes('/')) {
        // MM/DD/YYYY format
        const parts = dateStr.split('/');
        if (parts.length === 3) {
            dataDate = new Date(parts[2], parts[0] - 1, parts[1]);
        }
    }
    
    if (!dataDate || isNaN(dataDate)) return;
    
    const today = new Date();
    const diffDays = Math.floor((today - dataDate) / (1000 * 60 * 60 * 24));
    
    const dateEl = $('lst-chain-apr-date');
    const aprInput = $('lst-chain-apr');
    const aprContainer = aprInput?.parentElement?.parentElement;
    
    // Color coding:
    // Green (0 days) = today
    // Yellow (1-6 days) = this epoch/week
    // Red (7+ days) = older than this epoch
    
    if (diffDays === 0) {
        // Today - Green
        if (dateEl) {
            dateEl.textContent = `✓ Updated today (${dateStr})`;
            dateEl.className = 'text-[9px] text-green-400 font-bold';
        }
        if (aprInput) {
            aprInput.className = 'input-dark text-xl font-bold w-24 text-center text-green-400';
        }
        if (aprContainer) {
            aprContainer.className = 'bg-[#0D0D0D] rounded-lg p-3 border-2 border-green-700';
        }
    } else if (diffDays <= 6) {
        // This week/epoch - Yellow
        if (dateEl) {
            dateEl.textContent = `Last: ${dateStr} (${diffDays}d ago)`;
            dateEl.className = 'text-[9px] text-yellow-400';
        }
        if (aprInput) {
            aprInput.className = 'input-dark text-xl font-bold w-24 text-center text-yellow-400';
        }
        if (aprContainer) {
            aprContainer.className = 'bg-[#0D0D0D] rounded-lg p-3 border-2 border-yellow-700';
        }
    } else {
        // More than a week old - Red
        if (dateEl) {
            dateEl.textContent = `⚠️ ${diffDays} days old (${dateStr}) - Update from Smart Stake!`;
            dateEl.className = 'text-[9px] text-red-400 font-bold';
        }
        if (aprInput) {
            aprInput.className = 'input-dark text-xl font-bold w-24 text-center text-red-400';
        }
        if (aprContainer) {
            aprContainer.className = 'bg-[#0D0D0D] rounded-lg p-3 border-2 border-red-700';
        }
    }
    
    updateWorkflowStatus();
}

// Fetch all LST ratios from chain - WORKING VERSION
async function fetchAllLstRatiosFromChain() {
    const tokens = ['ampLUNA', 'arbLUNA', 'bLUNA', 'ampROAR', 'ampCAPA'];
    
    // Set all to fetching
    tokens.forEach(token => {
        const statusEl = $(`lst-status-${token}`);
        if (statusEl) {
            statusEl.textContent = '⏳ fetching...';
            statusEl.className = 'text-[9px] px-2 py-0.5 rounded bg-yellow-900/50 text-yellow-400 flex-1 text-center';
        }
    });
    
    let successCount = 0;
    
    for (const [token, config] of Object.entries(lstContracts)) {
        try {
            const queryObj = config.query === 'exchange_rates' ? { exchange_rates: {} } : { state: {} };
            const query = btoa(JSON.stringify(queryObj));
            const url = `https://terra.publicnode.com/cosmwasm/wasm/v1/contract/${config.hub}/smart/${query}`;
            
            const res = await fetch(url);
            if (!res.ok) throw new Error('Query failed');
            
            const data = await res.json();
            const rate = config.parse(data);
            
            if (rate > 0) {
                // Update store
                store.lstRatios[token].ratio = rate;
                store.lstRatios[token].updated = new Date().toISOString();
                
                // Update UI
                const inputEl = $(`lst-ratio-${token}`);
                const statusEl = $(`lst-status-${token}`);
                const cardEl = $(`lst-card-${token}`);
                
                if (inputEl) inputEl.value = rate.toFixed(4);
                if (statusEl) {
                    statusEl.textContent = '✓ fetched';
                    statusEl.className = 'text-[9px] px-2 py-0.5 rounded bg-green-900/50 text-green-400 flex-1 text-center';
                }
                if (cardEl) cardEl.className = 'bg-[#161616] rounded-lg p-3 border-2 border-green-700';
                
                // Sync to votion ratios
                if (token === 'ampLUNA') {
                    store.votion.ratioAmp = rate;
                    if ($('ratioAmp')) $('ratioAmp').value = rate.toFixed(4);
                } else if (token === 'arbLUNA') {
                    store.votion.ratioArb = rate;
                    if ($('ratioArb')) $('ratioArb').value = rate.toFixed(4);
                }
                
                successCount++;
                console.log(`✅ ${token}: ${rate.toFixed(4)}`);
            } else {
                throw new Error('Invalid rate');
            }
        } catch (e) {
            console.warn(`❌ ${token} fetch failed:`, e.message);
            
            const statusEl = $(`lst-status-${token}`);
            const cardEl = $(`lst-card-${token}`);
            
            if (statusEl) {
                statusEl.textContent = '❌ failed';
                statusEl.className = 'text-[9px] px-2 py-0.5 rounded bg-red-900/50 text-red-400 flex-1 text-center';
            }
            if (cardEl) cardEl.className = 'bg-[#161616] rounded-lg p-3 border-2 border-red-700';
        }
    }
    
    updateLstOverallStatus();
    updateWorkflowStatus();
    updateRatios();
    
    console.log(`LST auto-fetch complete: ${successCount}/${tokens.length} successful`);
    return successCount;
}

function initLstRatiosTab() {
    // Initialize values from store
    const tokens = ['ampLUNA', 'arbLUNA', 'bLUNA', 'ampCAPA', 'ampROAR', 'xASTRO'];
    tokens.forEach(token => {
        const data = store.lstRatios[token];
        if (data) {
            const ratioEl = $(`lst-ratio-${token}`);
            const apyEl = $(`lst-apy-${token}`);
            if (ratioEl) ratioEl.value = data.ratio;
            if (apyEl && data.apy !== null) apyEl.value = data.apy;
            updateLstCardStatus(token);
        }
    });
    
    // Sync ampLUNA/arbLUNA to Votion tab display
    $('ratioArb').value = store.lstRatios.arbLUNA.ratio;
    $('ratioAmp').value = store.lstRatios.ampLUNA.ratio;
    store.votion.ratioArb = store.lstRatios.arbLUNA.ratio;
    store.votion.ratioAmp = store.lstRatios.ampLUNA.ratio;
    
    $('lst-chain-apr').value = store.lstRatios.chainStakingApr;
    updateLstOverallStatus();
}

function updateWorkflowStatus() {
    // Helper to set tab status
    function setTabStatus(tabId, status) {
        const tab = $(`tab-${tabId}`);
        if (!tab) return;
        
        // Remove all status classes
        tab.classList.remove('tab-incomplete', 'tab-complete', 'tab-partial', 'tab-optional');
        
        // Add new status class
        tab.classList.add(`tab-${status}`);
        
        // Update status indicator
        const statusEl = tab.querySelector('.tab-status');
        if (statusEl) {
            if (status === 'complete') statusEl.textContent = '✓';
            else if (status === 'partial') statusEl.textContent = '◐';
            else if (status === 'optional') statusEl.textContent = '○';
            else statusEl.textContent = '●';
        }
    }
    
    // Step 1: LP Registry
    let lpCount = Object.keys(store.lpRegistry).length;
    if (store.lpRegistryVerified) {
        setTabStatus('lpreg', 'complete');
    } else if (lpCount > 0) {
        setTabStatus('lpreg', 'partial');
    } else {
        setTabStatus('lpreg', 'incomplete');
    }
    
    // Step 2: Ratios - check ratios AND APYs (bLUNA APY excluded - can't get it)
    const ratioTokens = ['ampLUNA', 'arbLUNA', 'bLUNA', 'ampCAPA', 'ampROAR'];
    const apyTokens = ['ampLUNA', 'arbLUNA', 'ampCAPA', 'ampROAR', 'xASTRO']; // bLUNA excluded
    let ratioCount = 0, apyCount = 0;
    ratioTokens.forEach(t => { if (store.lstRatios[t]?.ratio > 0) ratioCount++; });
    apyTokens.forEach(t => { if (store.lstRatios[t]?.apy > 0) apyCount++; });
    
    // Check chain staking APR staleness - handle both date formats
    let chainAprStale = true;
    let chainAprSet = store.lstRatios.chainStakingApr > 0;
    if (store.lstRatios.chainStakingAprDate && chainAprSet) {
        let dateStr = store.lstRatios.chainStakingAprDate;
        let aprDate;
        
        if (dateStr.includes('-')) {
            // YYYY-MM-DD format (ISO)
            aprDate = new Date(dateStr);
        } else if (dateStr.includes('/')) {
            // MM/DD/YYYY format
            const parts = dateStr.split('/');
            if (parts.length === 3) {
                aprDate = new Date(parts[2], parts[0] - 1, parts[1]);
            }
        }
        
        if (aprDate && !isNaN(aprDate)) {
            const daysSince = (new Date() - aprDate) / 86400000;
            chainAprStale = daysSince > 2;
        }
    }
    
    // Check for manual override
    const ratiosOverride = store.ratiosVerified;
    const ratiosComplete = ratiosOverride || (ratioCount >= 5 && apyCount >= 5 && chainAprSet && !chainAprStale);
    
    if (ratiosComplete) {
        setTabStatus('ratios', 'complete');
    } else if (ratioCount > 0 || apyCount > 0) {
        setTabStatus('ratios', 'partial');
    } else {
        setTabStatus('ratios', 'incomplete');
    }
    
    // Step 3: Prices - check token prices
    const tokenCount = Object.keys(store.tokenPrices).length;
    const pricesOverride = store.tokenPricesVerified;
    
    if (pricesOverride || tokenCount >= 10) {
        setTabStatus('prices', 'complete');
    } else if (tokenCount > 0) {
        setTabStatus('prices', 'partial');
    } else {
        setTabStatus('prices', 'incomplete');
    }
    
    // Step 4: Votion - check all 6 lockups or skipped
    updateVotionChecklist();
    let lockCount = store.votion.lockups?.length || 0;
    let skipCount = 0;
    ['arbmax', 'ampmax', 'arb3mo', 'amp3mo', 'arb1wk', 'amp1wk'].forEach(id => {
        if ($(`votion-skip-${id}`)?.checked) skipCount++;
    });
    let votionComplete = (lockCount + skipCount) >= 6 && store.votionVerified;
    
    if (votionComplete) {
        setTabStatus('votion', 'complete');
    } else if (lockCount > 0) {
        setTabStatus('votion', 'partial');
    } else {
        setTabStatus('votion', 'incomplete');
    }
    
    // Step 5: PD Bribes
    let epoch = store.meta.ep;
    let pdCovered = false;
    for (let b of store.pdBribesHistory || []) {
        if (epoch >= b.start_epoch && epoch <= b.end_epoch) {
            pdCovered = true;
            break;
        }
    }
    
    if (pdCovered && store.pdBribesVerified) {
        setTabStatus('pdbribes', 'complete');
    } else if (pdCovered) {
        setTabStatus('pdbribes', 'partial');
    } else {
        setTabStatus('pdbribes', 'incomplete');
    }
    
    // Steps 5-6: Astroport and Skeleton are optional
    setTabStatus('astro', 'optional');
    setTabStatus('ww', 'optional');
    
    // Steps 7-10: Dashboard, NFT, News, DAO - use verified flags
    ['dashboard', 'nft', 'news', 'dao'].forEach(step => {
        let verified = store[`${step}Verified`];
        setTabStatus(step, verified ? 'complete' : 'incomplete');
    });
}

// LP Registry scroll detection
function checkLpRegistryScroll(el) {
    const isAtBottom = el.scrollHeight - el.scrollTop <= el.clientHeight + 50;
    const lpCount = Object.keys(store.lpRegistry).length;
    
    if (isAtBottom && lpCount > 0) {
        $('lp-scroll-hint')?.classList.add('hidden');
        $('lp-verify-section')?.classList.remove('hidden');
    }
}

function confirmLpRegistry() {
    store.lpRegistryVerified = true;
    $('lp-verify-section').innerHTML = '<div class="flex items-center gap-2"><span class="text-green-400 text-lg">✓</span><span class="text-green-300 text-[11px]">LP Registry confirmed!</span></div>';
    updateWorkflowStatus();
}

function updateVotionChecklist() {
    // Map lockups to checklist items
    const lockupMap = {
        'arbLUNA-Max': 'arbmax',
        'arbLUNA-3mo': 'arb3mo',
        'arbLUNA-1wk': 'arb1wk',
        'ampLUNA-Max': 'ampmax',
        'ampLUNA-3mo': 'amp3mo',
        'ampLUNA-1wk': 'amp1wk'
    };
    
    // Reset all to unchecked
    Object.values(lockupMap).forEach(id => {
        const el = $(`votion-chk-${id}`);
        const skipEl = $(`votion-skip-${id}`);
        if (el) {
            const isSkipped = skipEl?.checked;
            if (isSkipped) {
                el.querySelector('.lock-status').textContent = '⊘';
                el.className = 'flex items-center gap-1 text-gray-500 line-through';
            } else {
                el.querySelector('.lock-status').textContent = '☐';
                el.className = 'flex items-center gap-1 text-gray-600';
            }
        }
    });
    
    // Mark captured lockups
    let capturedCount = 0;
    let skippedCount = 0;
    
    for (let lock of store.votion.lockups || []) {
        const key = `${lock.type}-${lock.duration}`;
        const id = lockupMap[key];
        if (id) {
            const el = $(`votion-chk-${id}`);
            if (el) {
                el.querySelector('.lock-status').textContent = '✓';
                el.className = 'flex items-center gap-1 text-green-400';
                capturedCount++;
            }
        }
    }
    
    // Count skipped
    Object.values(lockupMap).forEach(id => {
        if ($(`votion-skip-${id}`)?.checked) skippedCount++;
    });
    
    // Update counter
    const total = capturedCount + skippedCount;
    const countEl = $('votion-checklist-count');
    if (countEl) {
        countEl.textContent = `${total}/6`;
        countEl.className = total >= 6 ? 'text-[9px] text-green-400' : 'text-[9px] text-red-400';
    }
    
    // Show/hide confirm button based on completion
    const confirmSection = $('votion-confirm-section');
    if (confirmSection) {
        if (total >= 6 && !store.votionVerified) {
            confirmSection.classList.remove('hidden');
        } else {
            confirmSection.classList.add('hidden');
        }
    }
    
    // Update votion summary counts
    let totalVp = 0, totalUsd = 0, totalRew = 0;
    for (let lock of store.votion.lockups || []) {
        totalVp += lock.vp || 0;
        totalUsd += lock.usd || 0;
        totalRew += lock.expectedRewards || 0;
    }
    
    setTxt('votion-lock-count', store.votion.lockups?.length || 0);
    setTxt('votion-total-vp', totalVp.toLocaleString(undefined, {maximumFractionDigits: 0}));
    setTxt('votion-total-usd', fmt$(totalUsd));
    setTxt('votion-total-rew', fmt$(totalRew));
    
    // Note: Don't call updateWorkflowStatus() here - it calls us and would cause infinite loop
}

function confirmVotionComplete() {
    store.votionVerified = true;
    const confirmSection = $('votion-confirm-section');
    if (confirmSection) {
        confirmSection.innerHTML = `
            <div class="text-green-400 text-[10px] text-center py-2">
                <i class="fas fa-check-circle mr-1"></i> Step ④ Complete!
            </div>
        `;
    }
    updateWorkflowStatus();
}

window.onload = async function() {
    // Fetch live epoch info first
    await fetchLiveEpochInfo();
    
    // Set initial working epoch from live data or calculate fallback
    if (store.liveEpoch) {
        $('extEpoch').value = store.liveEpoch.epoch;
        $('extPhase').value = store.liveEpoch.phase;
    } else {
        // Fallback calculation
        const anchorDate = new Date(Date.UTC(2025, 10, 17, 0, 0, 0)); 
        const now = new Date();
        const msPerWeek = 604800000;
        let diffTime = now.getTime() - anchorDate.getTime();
        let weeksPassed = Math.floor(diffTime / msPerWeek);
        let currentEp = 160 + weeksPassed;
        $('extEpoch').value = currentEp;
        $('extPhase').value = 'end';
    }
    updateMeta();
    
    // Initialize mode and Astro tab
    setMode('staging');
    renderLpRegistry();
    updateAstroTab();
    
    // Initialize LST Ratios tab
    initLstRatiosTab();
    
    // Auto-fetch data from GitHub (including PD Bribes)
    await fetchAllFromGithub();
    
    // Now render PD Bribes after data is loaded
    renderPdBribesHistory();
    updatePdCoverage();
    
    // Auto-fetch LST ratios from chain and staking APR
    fetchAllLstRatiosFromChain();
    fetchChainStakingApr();
    
    // Initialize workflow status
    updateWorkflowStatus();
    
    // Start timer to update countdown every minute
    setInterval(updateLiveCountdown, 60000);
};

function updateLiveCountdown() {
    if (!store.liveEpoch || !store.liveEpoch.end_time) return;
    
    const now = new Date();
    const endTime = new Date(store.liveEpoch.end_time);
    const msRemaining = endTime - now;
    const daysRemaining = msRemaining / 86400000;
    
    if (daysRemaining < 0) {
        // Epoch ended, refresh data
        fetchLiveEpochInfo();
        return;
    }
    
    // Update days remaining
    store.liveEpoch.daysRemaining = daysRemaining;
    
    // Update phase if changed
    // Phase based on days REMAINING:
    // 5-7 remaining = START (0-2 days into epoch)
    // 2-5 remaining = MID (2-5 days into epoch)
    // 0-2 remaining = END (5-7 days into epoch)
    let newPhase = 'end';
    if (daysRemaining >= 5) newPhase = 'start';
    else if (daysRemaining > 2) newPhase = 'mid';
    
    if (newPhase !== store.liveEpoch.phase) {
        store.liveEpoch.phase = newPhase;
        let phaseEl = $('live-phase');
        setTxt('live-phase', newPhase.charAt(0).toUpperCase() + newPhase.slice(1));
        phaseEl.className = 'text-sm font-mono font-bold ' + 
            (newPhase === 'start' ? 'text-green-400' : newPhase === 'mid' ? 'text-yellow-400' : 'text-red-400');
        checkEpochMismatch();
    }
    
    // Update countdown display
    let days = Math.floor(daysRemaining);
    let hours = Math.floor((daysRemaining - days) * 24);
    let mins = Math.floor(((daysRemaining - days) * 24 - hours) * 60);
    setTxt('live-ends', `${days}d ${hours}h ${mins}m`);
}

function switchTab(t) {
    // Remove active from all tabs
    document.querySelectorAll('.tab-btn').forEach(b => {
        b.classList.remove('active');
    });
    
    // Add active to clicked tab
    const activeTab = $(`tab-${t}`);
    if (activeTab) activeTab.classList.add('active');
    
    // Switch workspace
    document.querySelectorAll('.workspace').forEach(w => w.classList.remove('active'));
    let ws = $('ws-' + t);
    if (ws) ws.classList.add('active');
    
    // Auto-fetch ratios when switching to Ratios tab (if not already fetched)
    if (t === 'ratios') {
        // Check if ratios have been fetched already
        const hasRatios = Object.values(store.lstRatios).some(r => r?.ratio > 0);
        if (!hasRatios) {
            fetchAllLstRatiosFromChain();
            fetchChainStakingApr();
        }
    }
    
    // Auto-fetch prices when switching to Prices tab (always fetch to get latest)
    if (t === 'prices' && Object.keys(store.lpRegistry).length > 0) {
        fetchAllTokenPrices();
    }
    
    // Auto-fetch PD bribes and refresh preview when switching to that tab
    if (t === 'pdbribes') {
        // Fetch from GitHub if not loaded
        if (store.pdBribesHistory.length === 0) {
            fetchPdBribesFromGithub();
        } else {
            updatePdCoverage();
        }
    }
    
    // Auto-fetch Dashboard data when switching to that tab
    if (t === 'dashboard') {
        // Only fetch if NFT data not loaded yet
        if (!dashboardStore.tiles?.nft?.total_minted) {
            fetchDashboardData();
        }
    }
    
    // Auto-load NFT data when switching to NFT tab (uses cached data from Dashboard if available)
    if (t === 'nft') {
        if (nftStore.bbl.collection) {
            // Data already loaded from Dashboard, just parse it
            parseNftBblCollection();
            if (nftStore.bbl.listings.length > 0) {
                parseNftBblListings();
            }
            $('nft-status').innerHTML = '✅ Pre-loaded';
        } else {
            fetchNftData();
        }
    }
}

function updateMeta() {
    store.meta.ep = parseInt($('extEpoch').value) || 0;
    store.meta.ph = $('extPhase').value;
    setTxt('target-epoch', store.meta.ep);
    setTxt('target-phase', store.meta.ph.charAt(0).toUpperCase() + store.meta.ph.slice(1));
    // Update coverage when epoch changes
    updatePdCoverage();
    updateAstroStatus();
    updateWorkflowStatus();
    checkEpochMismatch();
}

// ============ LIVE EPOCH FUNCTIONS ============

const EPOCH_DATA_URL = 'https://raw.githubusercontent.com/defipatriot/tla_json_storage/main/epoch_1-300_date.json';
let epochData = [];

async function fetchLiveEpochInfo() {
    try {
        setTxt('live-epoch', '...');
        setTxt('live-ends', '...');
        setTxt('live-phase', '...');
        
        // Fetch epoch data from GitHub (same source as Core tool)
        let resp = await fetch(EPOCH_DATA_URL);
        if (!resp.ok) throw new Error('Failed to fetch epoch data');
        
        epochData = await resp.json();
        console.log('Loaded epoch data:', epochData.length, 'epochs');
        
        // Find current epoch
        const now = new Date();
        let currentEpoch = null;
        
        for (let ep of epochData) {
            let start = new Date(ep.start_time);
            let end = new Date(ep.end_time);
            
            if (now >= start && now < end) {
                currentEpoch = ep;
                break;
            }
        }
        
        // If we're past all epochs, use the last one
        if (!currentEpoch && epochData.length > 0) {
            currentEpoch = epochData[epochData.length - 1];
        }
        
        if (!currentEpoch) throw new Error('No epoch data found');
        
        // Calculate time remaining
        let endTime = new Date(currentEpoch.end_time);
        let msRemaining = endTime - now;
        let daysRemaining = msRemaining / 86400000;
        
        // Phase based on days REMAINING:
        // 5-7 remaining = START (0-2 days into epoch)
        // 2-5 remaining = MID (2-5 days into epoch)
        // 0-2 remaining = END (5-7 days into epoch)
        let phase = 'end';
        if (daysRemaining >= 5) phase = 'start';
        else if (daysRemaining > 2) phase = 'mid';
        
        // Store live info
        store.liveEpoch = {
            epoch: currentEpoch.epoch,
            end_time: endTime.toISOString(),
            daysRemaining: daysRemaining,
            phase: phase
        };
        
        // Update display
        setTxt('live-epoch', currentEpoch.epoch);
        
        // Format time remaining
        let days = Math.floor(daysRemaining);
        let hours = Math.floor((daysRemaining - days) * 24);
        let mins = Math.floor(((daysRemaining - days) * 24 - hours) * 60);
        setTxt('live-ends', `${days}d ${hours}h ${mins}m`);
        
        // Phase with color
        let phaseEl = $('live-phase');
        setTxt('live-phase', phase.charAt(0).toUpperCase() + phase.slice(1));
        phaseEl.className = 'text-sm font-mono font-bold ' + 
            (phase === 'start' ? 'text-green-400' : phase === 'mid' ? 'text-yellow-400' : 'text-red-400');
        
        checkEpochMismatch();
        console.log('Live epoch info:', store.liveEpoch);
        
    } catch (e) {
        console.error('Failed to fetch live epoch:', e);
        setTxt('live-epoch', 'ERR');
        setTxt('live-ends', '-');
        setTxt('live-phase', '-');
        
        // Fallback to calculated epoch
        const anchorDate = new Date(Date.UTC(2025, 10, 17, 0, 0, 0)); 
        const now = new Date();
        const msPerWeek = 604800000;
        let diffTime = now.getTime() - anchorDate.getTime();
        let weeksPassed = Math.floor(diffTime / msPerWeek);
        let currentEp = 160 + weeksPassed;
        
        // Calculate approximate days remaining in epoch
        let msIntoEpoch = diffTime % msPerWeek;
        let msRemaining = msPerWeek - msIntoEpoch;
        let daysRemaining = msRemaining / 86400000;
        
        // Phase based on days REMAINING
        let phase = 'end';
        if (daysRemaining >= 5) phase = 'start';
        else if (daysRemaining > 2) phase = 'mid';
        
        store.liveEpoch = {
            epoch: currentEp,
            daysRemaining: daysRemaining,
            phase: phase,
            isFallback: true
        };
        
        setTxt('live-epoch', currentEp + '*');
        let days = Math.floor(daysRemaining);
        let hours = Math.floor((daysRemaining - days) * 24);
        setTxt('live-ends', `~${days}d ${hours}h`);
        setTxt('live-phase', phase.charAt(0).toUpperCase() + phase.slice(1));
        $('live-phase').className = 'text-sm font-mono font-bold ' + 
            (phase === 'start' ? 'text-green-400' : phase === 'mid' ? 'text-yellow-400' : 'text-red-400');
    }
}

function syncToLive() {
    if (!store.liveEpoch) {
        alert('No live epoch data. Click refresh first.');
        return;
    }
    
    $('extEpoch').value = store.liveEpoch.epoch;
    $('extPhase').value = store.liveEpoch.phase;
    updateMeta();
    
    console.log('Synced to live:', store.liveEpoch.epoch, store.liveEpoch.phase);
}

function checkEpochMismatch() {
    let warningEl = $('epoch-mismatch-warning');
    if (!warningEl || !store.liveEpoch) {
        if (warningEl) warningEl.classList.add('hidden');
        return;
    }
    
    let workingEp = store.meta.ep;
    let workingPh = store.meta.ph;
    let liveEp = store.liveEpoch.epoch;
    let livePh = store.liveEpoch.phase;
    
    let warnings = [];
    
    // Check epoch mismatch
    if (workingEp !== liveEp) {
        warnings.push(`Epoch ${workingEp} ≠ live ${liveEp}`);
    }
    
    // Check phase mismatch
    if (workingPh !== livePh) {
        warnings.push(`Phase "${workingPh}" ≠ live "${livePh}"`);
    }
    
    if (warnings.length > 0) {
        setTxt('mismatch-text', warnings.join(' | '));
        warningEl.classList.remove('hidden');
    } else {
        warningEl.classList.add('hidden');
    }
}

// ============ LOAD PREVIOUS EXT ============

function loadPreviousExt(event) {
    let file = event.target.files[0];
    if (!file) return;
    
    let reader = new FileReader();
    reader.onload = function(e) {
        try {
            let data = JSON.parse(e.target.result);
            store.prevExt = data;
            
            // Display info
            let meta = data.meta || {};
            let votionPools = Object.keys(data.votion?.pools || {}).length;
            let info = `Ep ${meta.epoch || '?'} ${meta.phase || '?'} | ${votionPools} pools`;
            setTxt('prev-ext-status', info);
            $('prev-ext-status').className = 'text-purple-300 text-[9px] truncate';
            
            console.log('Loaded previous ext:', data);
            
            // Optionally pre-fill data from previous ext
            if (confirm(`Loaded Ep ${meta.epoch} ${meta.phase}.\n\nPre-fill Votion ratios from this file?`)) {
                if (data.votion?.ratios) {
                    if (data.votion.ratios.arbLUNA) {
                        $('ratioArb').value = data.votion.ratios.arbLUNA;
                        store.votion.ratioArb = data.votion.ratios.arbLUNA;
                    }
                    if (data.votion.ratios.ampLUNA) {
                        $('ratioAmp').value = data.votion.ratios.ampLUNA;
                        store.votion.ratioAmp = data.votion.ratios.ampLUNA;
                    }
                    updateRatios();
                }
            }
            
        } catch (err) {
            console.error('Failed to parse previous ext:', err);
            setTxt('prev-ext-status', 'Parse error');
            $('prev-ext-status').className = 'text-red-400 text-[9px] truncate';
        }
    };
    reader.readAsText(file);
}

// ============ EXPORT VALIDATION ============

function validateExport() {
    let issues = [];
    let warnings = [];
    
    // Check epoch is set
    if (!store.meta.ep || store.meta.ep === 0) {
        issues.push('Epoch not set');
    }
    
    // Check epoch matches live
    if (store.liveEpoch && store.meta.ep !== store.liveEpoch.epoch) {
        warnings.push(`Working epoch ${store.meta.ep} differs from live ${store.liveEpoch.epoch}`);
    }
    
    // Check phase matches live
    if (store.liveEpoch && store.meta.ph !== store.liveEpoch.phase) {
        warnings.push(`Working phase "${store.meta.ph}" differs from live "${store.liveEpoch.phase}"`);
    }
    
    // Check Votion data
    if (store.votion.lockups.length === 0) {
        issues.push('No Votion lockups captured');
    } else {
        // Check for major lockups
        let hasArbMax = store.votion.lockups.some(l => l.type === 'arbLUNA' && l.duration === 'Max');
        let hasAmpMax = store.votion.lockups.some(l => l.type === 'ampLUNA' && l.duration === 'Max');
        if (!hasArbMax) warnings.push('Missing arbLUNA Max lockup');
        if (!hasAmpMax) warnings.push('Missing ampLUNA Max lockup');
    }
    
    // Check PD Bribes coverage
    let pdCovered = store.pdBribesHistory.some(prop => 
        store.meta.ep >= prop.start_epoch && store.meta.ep <= prop.end_epoch
    );
    if (!pdCovered) {
        warnings.push(`PD Bribes don't cover epoch ${store.meta.ep}`);
    }
    
    // Check ratios are reasonable
    if (store.votion.ratioArb < 2 || store.votion.ratioArb > 3) {
        warnings.push(`arbLUNA ratio ${store.votion.ratioArb} seems unusual (expected 2.0-3.0)`);
    }
    if (store.votion.ratioAmp < 1.5 || store.votion.ratioAmp > 2.5) {
        warnings.push(`ampLUNA ratio ${store.votion.ratioAmp} seems unusual (expected 1.5-2.5)`);
    }
    
    return { issues, warnings, canExport: issues.length === 0 };
}

function downloadExtJson() {
    // Run validation
    let validation = validateExport();
    
    // Show issues/warnings
    if (validation.issues.length > 0) {
        alert('❌ Cannot export - critical issues:\n\n• ' + validation.issues.join('\n• '));
        return;
    }
    
    if (validation.warnings.length > 0) {
        let proceed = confirm(
            '⚠️ Export warnings:\n\n• ' + validation.warnings.join('\n• ') + 
            '\n\nProceed with export anyway?'
        );
        if (!proceed) return;
    }
    
    // Generate and download
    let data = getExportData();
    let jsonStr = JSON.stringify(data, null, 2);
    let blob = new Blob([jsonStr], { type: "application/json" });
    let url = URL.createObjectURL(blob);
    let a = document.createElement('a');
    a.href = url;
    a.download = `tla-ext-epoch-${store.meta.ep}-${store.meta.ph}.json`; 
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    // Update workflow status
    setTxt('step-export-val', '✓ saved');
    $('step-export').classList.add('status-done');
}

// ============ MODE FUNCTIONS ============

function setMode(mode) {
    store.mode = mode;
    $('mode-staging').className = mode === 'staging' 
        ? 'px-2 py-1 text-[10px] rounded bg-yellow-900/50 text-yellow-400 border border-yellow-700'
        : 'px-2 py-1 text-[10px] rounded bg-gray-800 text-gray-500 border border-gray-700';
    $('mode-normal').className = mode === 'normal'
        ? 'px-2 py-1 text-[10px] rounded bg-green-900/50 text-green-400 border border-green-700'
        : 'px-2 py-1 text-[10px] rounded bg-gray-800 text-gray-500 border border-gray-700';
    updateAstroTab();
}

// ============ FETCH FUNCTIONS ============

async function fetchAllFromGithub() {
    await fetchStagingData();
    await fetchHistoricalData();
    await fetchCurrentData();
    await fetchPdBribesFromGithub();
}

async function fetchStagingData() {
    for (let day of ['day1', 'day2', 'day3', 'day4']) {
        try {
            console.log(`Fetching staging ${day}: ${STAGING_URLS[day]}`);
            let resp = await fetch(STAGING_URLS[day]);
            console.log(`Staging ${day} response: ${resp.status}`);
            if (resp.ok) {
                let data = await resp.json();
                console.log(`Staging ${day} loaded:`, data);
                store.staging[day] = data;
            } else {
                console.log(`Staging ${day} not OK: ${resp.status}`);
            }
        } catch (e) {
            console.log(`Staging ${day} error:`, e);
        }
    }
    updateStagingStatus();
}

async function fetchHistoricalData() {
    try {
        let resp = await fetch(HISTORICAL_URL);
        if (resp.ok) {
            store.historical = await resp.json();
            setTxt('fetch-historical', '✓');
        } else {
            setTxt('fetch-historical', '-');
        }
    } catch (e) {
        setTxt('fetch-historical', '✗');
    }
}

async function fetchCurrentData() {
    try {
        let resp = await fetch(CURRENT_URL);
        if (resp.ok) {
            store.current = await resp.json();
            setTxt('fetch-current', '✓');
        } else {
            setTxt('fetch-current', '-');
        }
    } catch (e) {
        setTxt('fetch-current', '✗');
    }
}

function updateStagingStatus() {
    let days = ['day1', 'day2', 'day3', 'day4'];
    let completed = days.filter(d => store.staging[d] !== null).length;
    setTxt('fetch-staging', `${completed}/4`);
    
    // Update individual day boxes
    days.forEach(day => {
        let data = store.staging[day];
        let statusEl = $(`staging-${day}-status`);
        let lpsEl = $(`staging-${day}-lps`);
        
        if (data && data.lps) {
            let lpCount = Object.keys(data.lps).length;
            if (statusEl) {
                statusEl.innerText = data.captureDate || 'Loaded';
                statusEl.className = 'text-[10px] text-green-400';
            }
            if (lpsEl) {
                lpsEl.innerText = `${lpCount} LPs`;
            }
        } else if (data) {
            // Data exists but no lps object
            if (statusEl) {
                statusEl.innerText = 'Loaded (no LPs)';
                statusEl.className = 'text-[10px] text-yellow-400';
            }
        } else {
            // No data
            if (statusEl) {
                statusEl.innerText = 'Not found';
                statusEl.className = 'text-[10px] text-gray-600';
            }
            if (lpsEl) {
                lpsEl.innerText = '0 LPs';
            }
        }
    });
}

// ============ LP REGISTRY FUNCTIONS ============

function parseVoteTab() {
    let txt = $('voteTabPaste').value;
    let lines = txt.split('\n').map(l => l.trim()).filter(l => l);
    
    store.lpRegistry = {};
    
    const BUCKETS = ['stable', 'project', 'bluechip', 'single'];
    let currentBucket = null;
    let i = 0;
    
    while (i < lines.length) {
        let line = lines[i];
        let lineLower = line.toLowerCase();
        
        // Check for bucket header
        if (BUCKETS.includes(lineLower)) {
            currentBucket = lineLower;
            i++;
            continue;
        }
        
        // Look for LP pattern: "LUNA-USDC LP" or similar, or single assets
        if (line.includes(' LP') || line === 'ampCAPA' || line === 'xASTRO' || line.endsWith('Single')) {
            let lpName = line.replace(' LP', '').replace(' Single', '').replace('Single', '').trim();
            
            // Look ahead for dex and vote %
            let dex = null;
            let votePct = 0;
            
            for (let k = 1; k <= 8 && i + k < lines.length; k++) {
                let next = lines[i + k];
                
                // Detect DEX - both names used
                if (next === 'Astroport') {
                    dex = 'Astroport';
                } else if (next === 'WhiteWhale' || next === 'Skeleton Swap') {
                    dex = 'Skeleton Swap'; // Normalize to Skeleton Swap
                }
                
                // VP line: "VP 15.85M  76.9 %" or "VP 1.29M  5.8 %"
                if (next.startsWith('VP ') && next.includes('%')) {
                    let pctMatch = next.match(/([\d\.]+)\s*%/);
                    if (pctMatch) {
                        votePct = parseFloat(pctMatch[1]);
                    }
                    
                    // We found the VP for this dex, create the entry
                    if (dex && lpName) {
                        // Use composite key: "LUNA-USDC|Astroport"
                        let key = `${lpName}|${dex}`;
                        
                        store.lpRegistry[key] = {
                            lp: lpName,
                            dex: dex,
                            bucket: currentBucket || 'unknown',
                            vote_pct: votePct,
                            active: votePct >= 1
                        };
                    }
                    
                    // Reset for next potential dex entry for same LP
                    dex = null;
                    votePct = 0;
                }
                
                // Stop at next LP or bucket
                if (k > 2 && (next.includes(' LP') || next === 'ampCAPA' || next === 'xASTRO' || next.endsWith('Single') || BUCKETS.includes(next.toLowerCase()))) {
                    break;
                }
            }
        }
        i++;
    }
    
    $('voteTabPaste').value = '';
    renderLpRegistry();
    updateLpSummary();
    setTxt('fetch-lp', '✓');
    
    // Update Astroport dropdown
    updateAstroLpDropdown();
}

function renderLpRegistry() {
    let showActive = $('filter-active').checked;
    let showAstro = $('filter-astro').checked;
    let showWW = $('filter-ww').checked;
    
    let html = '';
    const BUCKETS = ['stable', 'project', 'bluechip', 'single'];
    
    BUCKETS.forEach(bucket => {
        let bucketLps = Object.entries(store.lpRegistry)
            .filter(([key, lp]) => lp.bucket === bucket)
            .filter(([key, lp]) => !showActive || lp.active)
            .filter(([key, lp]) => {
                if (lp.dex === 'Astroport' && !showAstro) return false;
                if ((lp.dex === 'Skeleton Swap' || lp.dex === 'Skeleton Swap') && !showWW) return false;
                return true;
            })
            .sort((a, b) => b[1].vote_pct - a[1].vote_pct);
        
        if (bucketLps.length === 0) return;
        
        let bucketColor = bucket === 'stable' ? 'blue' : bucket === 'project' ? 'purple' : bucket === 'bluechip' ? 'yellow' : 'green';
        
        html += `<div class="bg-${bucketColor}-900/20 border-l-2 border-${bucketColor}-500 p-2 rounded">
            <div class="text-[10px] font-bold text-${bucketColor}-400 uppercase mb-2">${bucket} (${bucketLps.length})</div>
            <div class="space-y-1">`;
        
        bucketLps.forEach(([key, lp]) => {
            let activeClass = lp.active ? 'text-white' : 'text-gray-500';
            let dexColor = lp.dex === 'Astroport' ? 'text-cyan-400' : 'text-blue-400';
            let dexLabel = lp.dex === 'Astroport' ? 'Astro' : 'SS';
            
            html += `<div class="flex items-center justify-between py-1 px-2 bg-[#0D0D0D] rounded text-[10px]">
                <span class="${activeClass} font-mono">${lp.lp}</span>
                <div class="flex items-center gap-3">
                    <span class="${dexColor}">${lp.vote_pct.toFixed(1)}% ${dexLabel}</span>
                </div>
            </div>`;
        });
        
        html += `</div></div>`;
    });
    
    setHtml('lp-registry-list', html || '<div class="text-gray-600 text-[10px] italic text-center py-8">No LPs loaded. Paste Vote tab data above.</div>');
}

function updateLpSummary() {
    let total = Object.keys(store.lpRegistry).length;
    let active = Object.values(store.lpRegistry).filter(lp => lp.active).length;
    let astro = Object.values(store.lpRegistry).filter(lp => lp.dex === 'Astroport').length;
    let ww = Object.values(store.lpRegistry).filter(lp => lp.dex === 'Skeleton Swap' || lp.dex === 'Skeleton Swap').length;
    
    setTxt('lp-total', total);
    setTxt('lp-active', active);
    setTxt('lp-astro', astro);
    setTxt('lp-ww', ww);
}

function exportLpRegistry() {
    let json = JSON.stringify({ lpRegistry: store.lpRegistry }, null, 2);
    let blob = new Blob([json], { type: 'application/json' });
    let url = URL.createObjectURL(blob);
    let a = document.createElement('a');
    a.href = url;
    a.download = 'tla_lp_registry.json';
    a.click();
    URL.revokeObjectURL(url);
}

function loadLpRegistryPaste() {
    let txt = prompt('Paste LP Registry JSON:');
    if (!txt) return;
    try {
        let data = JSON.parse(txt);
        if (data.lpRegistry) {
            store.lpRegistry = data.lpRegistry;
        }
        renderLpRegistry();
        updateLpSummary();
        updateAstroLpDropdown();
        setTxt('fetch-lp', '✓');
    } catch (e) {
        alert('Invalid JSON');
    }
}

function parseVotion() {
    let txt = $('votionPaste').value;
    if (!txt.trim()) return;
    
    let lines = txt.split('\n').map(l => l.trim()).filter(l => l);
    
    // Get ratios from store (already fetched from chain)
    let ratioArb = store.votion.ratioArb || 0;
    let ratioAmp = store.votion.ratioAmp || 0;
    
    // Parse lockup info
    let lockup = {
        type: '',
        duration: '',
        amount: 0,
        luna: 0,
        vp: 0,
        usd: 0,
        lockApy: 0,      // APY shown on the lock (e.g. 80.06%)
        lstApy: 0,       // Base LST APY from Prices tab
        votionApy: 0,    // Additional yield from Votion = lockApy - lstApy
        period: 0,
        expectedRewards: 0,
        buckets: []
    };
    
    // Find lock type and duration: "arbLUNA - Max" or "ampLUNA - 3 Month"
    for (let i = 0; i < lines.length; i++) {
        let line = lines[i];
        if ((line.includes('arbLUNA -') || line.includes('ampLUNA -')) && !line.includes('%')) {
            lockup.type = line.includes('arbLUNA') ? 'arbLUNA' : 'ampLUNA';
            if (line.toLowerCase().includes('3 month')) lockup.duration = '3mo';
            else if (line.toLowerCase().includes('1 week') || line.toLowerCase().includes('week')) lockup.duration = '1wk';
            else if (line.toLowerCase().includes('max')) lockup.duration = 'Max';
            
            // Look ahead for amount, USD, APY
            for (let k = 1; k <= 12 && i + k < lines.length; k++) {
                let next = lines[i + k];
                if (next.includes(lockup.type) && !next.includes('-') && !next.includes('%') && lockup.amount === 0) {
                    lockup.amount = clean(next);
                }
                if (next.startsWith('$') && lockup.usd === 0) {
                    lockup.usd = clean(next);
                }
                // Capture the Lock APY (the big % shown on the lockup)
                if (next.includes('%') && !next.includes('→') && !next.includes('APY') && !next.includes('Period') && lockup.lockApy === 0) {
                    lockup.lockApy = parseFloat(next.replace(/[^0-9\.]/g, '')) || 0;
                }
                if (next === 'stable' || next === 'project' || next === 'bluechip' || next === 'single') break;
            }
            break;
        }
    }
    
    // Get the LST APY from the Prices tab store
    if (lockup.type === 'ampLUNA') {
        lockup.lstApy = store.lstRatios.ampLUNA?.apy || 0;
    } else if (lockup.type === 'arbLUNA') {
        lockup.lstApy = store.lstRatios.arbLUNA?.apy || 0;
    }
    
    // Calculate Votion APY = Lock APY - LST APY
    if (lockup.lockApy > 0 && lockup.lstApy > 0) {
        lockup.votionApy = lockup.lockApy - lockup.lstApy;
    }
    
    // Parse period
    for (let i = 0; i < lines.length; i++) {
        if (lines[i] === 'Period' && lines[i+1]) {
            lockup.period = parseInt(lines[i+1]) || 0;
        }
        if (lines[i].includes('Total Expected Rewards') && lines[i+1]) {
            lockup.expectedRewards = clean(lines[i+1]);
        }
    }
    
    // Calculate LUNA and VP
    if (lockup.amount > 0 && lockup.type) {
        let ratio = lockup.type === 'arbLUNA' ? ratioArb : ratioAmp;
        lockup.luna = lockup.amount * ratio;
        let vpMult = lockup.duration === 'Max' ? 10 : (lockup.duration === '3mo' ? 2 : 1);
        lockup.vp = lockup.luna * vpMult;
    }
    
    // Parse buckets and vote allocations
    const BUCKET_NAMES = ['stable', 'project', 'bluechip', 'single'];
    
    for (let i = 0; i < lines.length; i++) {
        let line = lines[i].toLowerCase();
        
        if (BUCKET_NAMES.includes(line)) {
            let bucketName = lines[i];
            let expectedRewards = 0;
            let pools = [];
            
            for (let k = 1; k <= 50 && i + k < lines.length; k++) {
                let next = lines[i + k];
                let nextLower = next.toLowerCase();
                
                if (BUCKET_NAMES.includes(nextLower) && k > 2) break;
                
                if (lines[i + k - 1] === 'Expected Rewards' && next.includes('$')) {
                    expectedRewards = clean(next);
                }
                
                // Pool detection - includes single assets like ampCAPA
                if ((next.includes(' LP') || next.match(/^[a-zA-Z]+-[a-zA-Z]+$/) || next === 'ampCAPA' || next === 'xASTRO') && !next.includes('$') && !next.includes('%')) {
                    let poolName = next.replace(' LP', '');
                    let currentPct = null;  // Use null to distinguish "not set" from "0%"
                    let optimizedPct = null;
                    
                    for (let m = 1; m <= 4 && i + k + m < lines.length; m++) {
                        let pctLine = lines[i + k + m];
                        if (pctLine.includes('%') && !pctLine.includes('→')) {
                            let pct = parseFloat(pctLine.replace(/[^0-9\.]/g, '')) || 0;
                            if (currentPct === null) currentPct = pct;
                            else if (optimizedPct === null) optimizedPct = pct;
                        }
                        if (pctLine === '→' && lines[i + k + m + 1]) {
                            optimizedPct = parseFloat(lines[i + k + m + 1].replace(/[^0-9\.]/g, '')) || 0;
                        }
                    }
                    
                    // Convert null to 0 for final values
                    currentPct = currentPct ?? 0;
                    optimizedPct = optimizedPct ?? 0;
                    
                    if (currentPct > 0 || optimizedPct > 0) {
                        pools.push({
                            name: poolName,
                            current: currentPct,
                            optimized: optimizedPct,
                            change: optimizedPct - currentPct
                        });
                    }
                }
            }
            
            if (pools.length > 0) {
                lockup.buckets.push({
                    name: bucketName,
                    expectedRewards: expectedRewards,
                    pools: pools
                });
            }
        }
    }
    
    // Only add if we got valid data
    if (lockup.type && lockup.amount > 0) {
        // Check for duplicate (same type + duration) and update
        let existingIdx = store.votion.lockups.findIndex(l => l.type === lockup.type && l.duration === lockup.duration);
        if (existingIdx >= 0) {
            store.votion.lockups[existingIdx] = lockup;
        } else {
            store.votion.lockups.push(lockup);
        }
        
        $('votionPaste').value = '';
        renderVotion();
        updateWorkflowStatus();
        pasteStatus.votion = true;
        updatePasteStatus('ps-votion', true);
    } else {
        alert('Could not parse lockup data. Make sure you copied the entire page.');
    }
}

function clearVotionLocks() {
    if (confirm('Clear all loaded Votion lockups?')) {
        store.votion.lockups = [];
        renderVotion();
        updateWorkflowStatus();
        pasteStatus.votion = false;
        updatePasteStatus('ps-votion', false);
    }
}

function recalcVotion() {
    let ratioArb = store.votion.ratioArb || 0;
    let ratioAmp = store.votion.ratioAmp || 0;
    
    store.votion.lockups.forEach(lockup => {
        let ratio = lockup.type === 'arbLUNA' ? ratioArb : ratioAmp;
        lockup.luna = lockup.amount * ratio;
        let vpMult = lockup.duration === 'Max' ? 10 : (lockup.duration === '3mo' ? 2 : 1);
        lockup.vp = lockup.luna * vpMult;
        
        // Recalculate APY breakdown with latest LST APY
        if (lockup.type === 'ampLUNA') {
            lockup.lstApy = store.lstRatios.ampLUNA?.apy || 0;
        } else if (lockup.type === 'arbLUNA') {
            lockup.lstApy = store.lstRatios.arbLUNA?.apy || 0;
        }
        
        // Votion APY = Lock APY - LST APY
        if (lockup.lockApy > 0) {
            lockup.votionApy = lockup.lockApy - (lockup.lstApy || 0);
        }
    });
    
    renderVotion();
    updateWorkflowStatus();
}

function removeLockup(idx) {
    store.votion.lockups.splice(idx, 1);
    renderVotion();
    updateWorkflowStatus();
    if (store.votion.lockups.length === 0) {
        pasteStatus.votion = false;
        updatePasteStatus('ps-votion', false);
    }
}

function renderVotion() {
    let totalVp = 0;
    let totalUsd = 0;
    let totalRew = 0;
    
    // Sort lockups: arbLUNA first, then by duration
    let sortedLockups = [...store.votion.lockups].sort((a, b) => {
        if (a.type !== b.type) return a.type === 'arbLUNA' ? -1 : 1;
        const durOrder = { 'Max': 0, '3mo': 1, '1wk': 2 };
        return durOrder[a.duration] - durOrder[b.duration];
    });
    
    let cardsHtml = '';
    
    sortedLockups.forEach((lockup, idx) => {
        totalVp += lockup.vp;
        totalUsd += lockup.usd;
        totalRew += lockup.expectedRewards;
        
        let typeColor = lockup.type === 'arbLUNA' ? 'orange' : 'cyan';
        let typeBorder = lockup.type === 'arbLUNA' ? 'border-orange-500' : 'border-cyan-500';
        let typeBg = lockup.type === 'arbLUNA' ? 'bg-orange-900/10' : 'bg-cyan-900/10';
        
        cardsHtml += `<div class="preview-card ${typeBg} border-l-4 ${typeBorder}">
            <!-- Header -->
            <div class="flex justify-between items-center mb-2 pb-2 border-b border-gray-800">
                <div class="flex items-center gap-3">
                    <span class="text-${typeColor}-400 font-bold text-sm">${lockup.type}</span>
                    <span class="text-gray-400 text-xs bg-gray-800 px-2 py-0.5 rounded">${lockup.duration}</span>
                    <span class="text-gray-500 text-[10px]">Period ${lockup.period}</span>
                </div>
                <button onclick="removeLockup(${idx})" class="text-red-400 hover:text-red-300 text-[10px]">✕ Remove</button>
            </div>
            
            <!-- Stats Row -->
            <div class="grid grid-cols-5 gap-2 mb-3 text-[10px]">
                <div class="bg-gray-900/50 rounded p-2 text-center">
                    <div class="text-gray-500">Amount</div>
                    <div class="text-white font-mono">${lockup.amount.toLocaleString()}</div>
                </div>
                <div class="bg-gray-900/50 rounded p-2 text-center">
                    <div class="text-gray-500">LUNA Eq.</div>
                    <div class="text-gray-300 font-mono">${lockup.luna.toLocaleString(undefined,{maximumFractionDigits:0})}</div>
                </div>
                <div class="bg-gray-900/50 rounded p-2 text-center">
                    <div class="text-gray-500">Voting Power</div>
                    <div class="text-teal-400 font-mono font-bold">${lockup.vp.toLocaleString(undefined,{maximumFractionDigits:0})}</div>
                </div>
                <div class="bg-gray-900/50 rounded p-2 text-center">
                    <div class="text-gray-500">USD Value</div>
                    <div class="text-green-400 font-mono">${fmt$(lockup.usd)}</div>
                </div>
                <div class="bg-gray-900/50 rounded p-2 text-center">
                    <div class="text-gray-500">Est. Rewards</div>
                    <div class="text-green-400 font-mono">${fmt$(lockup.expectedRewards)}</div>
                </div>
            </div>
            
            <!-- APY Breakdown -->
            <div class="grid grid-cols-4 gap-2 mb-3 text-[10px] bg-yellow-900/20 rounded p-2 border border-yellow-900/50">
                <div class="text-center">
                    <div class="text-yellow-500 font-bold">Lock APY</div>
                    <div class="text-yellow-400 font-mono text-lg font-bold">${lockup.lockApy > 0 ? lockup.lockApy.toFixed(2) + '%' : '--'}</div>
                </div>
                <div class="text-center flex flex-col justify-center">
                    <div class="text-gray-500">=</div>
                </div>
                <div class="text-center">
                    <div class="text-${typeColor}-400">${lockup.type} APY</div>
                    <div class="text-${typeColor}-300 font-mono">${lockup.lstApy > 0 ? lockup.lstApy.toFixed(2) + '%' : '<span class="text-red-400">NOT SET</span>'}</div>
                </div>
                <div class="text-center">
                    <div class="text-green-400">+ Votion APY</div>
                    <div class="text-green-300 font-mono">${lockup.votionApy > 0 ? '+' + lockup.votionApy.toFixed(2) + '%' : '--'}</div>
                </div>
            </div>
            
            <!-- Vote Allocations -->
            <div class="text-[9px]">`;
        
        lockup.buckets.forEach(bucket => {
            let bucketColor = bucket.name === 'stable' ? 'blue' : 
                              bucket.name === 'project' ? 'purple' :
                              bucket.name === 'bluechip' ? 'yellow' : 'green';
            
            cardsHtml += `<div class="mb-2">
                <div class="flex justify-between items-center bg-${bucketColor}-900/30 px-2 py-1 rounded-t border-l-2 border-${bucketColor}-500">
                    <span class="font-bold text-${bucketColor}-400 uppercase">${bucket.name}</span>
                    <span class="text-green-400 font-mono">${fmt$(bucket.expectedRewards)}</span>
                </div>
                <div class="bg-gray-900/30 rounded-b">`;
            
            bucket.pools.forEach(pool => {
                let changeColor = pool.change > 0 ? 'text-green-400' : (pool.change < 0 ? 'text-red-400' : 'text-gray-500');
                let changeStr = pool.change > 0 ? '+' + pool.change.toFixed(2) + '%' : pool.change.toFixed(2) + '%';
                let poolVotes = lockup.vp * (pool.optimized / 100);
                
                cardsHtml += `<div class="grid grid-cols-12 gap-1 px-2 py-0.5 border-b border-gray-800/30 hover:bg-white/5">
                    <div class="col-span-4 text-white truncate">${pool.name}</div>
                    <div class="col-span-2 text-right text-gray-500">${pool.current.toFixed(2)}%</div>
                    <div class="col-span-1 text-center text-gray-600">→</div>
                    <div class="col-span-2 text-right text-white">${pool.optimized.toFixed(2)}%</div>
                    <div class="col-span-2 text-right text-teal-400 font-mono">${poolVotes.toLocaleString(undefined,{maximumFractionDigits:0})}</div>
                    <div class="col-span-1 text-right ${changeColor}">${changeStr}</div>
                </div>`;
            });
            
            cardsHtml += `</div></div>`;
        });
        
        cardsHtml += `</div></div>`;
    });
    
    if (cardsHtml === '') {
        cardsHtml = '<div class="text-gray-600 text-[10px] italic text-center py-8 col-span-full border border-dashed border-gray-800 rounded">No lockups loaded. Paste each Votion lockup page and click "Add Lockup".</div>';
    }
    
    setHtml('votion-lockups', cardsHtml);
    setTxt('votion-lock-count', store.votion.lockups.length);
    setTxt('votion-total-vp', totalVp.toLocaleString(undefined,{maximumFractionDigits:0}));
    setTxt('votion-total-usd', fmt$(totalUsd));
    setTxt('votion-total-rew', fmt$(totalRew));
}

// ============ PD BRIBES FUNCTIONS ============

async function fetchPdBribesFromGithub() {
    setTxt('pd-fetch-status', '⏳');
    try {
        let resp = await fetch(PD_BRIBES_GITHUB_URL);
        if (!resp.ok) throw new Error('Failed to fetch');
        let data = await resp.json();
        store.pdBribesHistory = data;
        setTxt('pd-fetch-status', '✓');
        renderPdBribesHistory();
        updatePdCoverage();
    } catch (e) {
        setTxt('pd-fetch-status', '✗');
        console.error('Failed to fetch PD bribes:', e);
        // Don't show alert - just log to console
    }
}

function loadPdBribesJson() {
    let txt = $('pdJsonPaste').value.trim();
    if (!txt) return;
    try {
        let data = JSON.parse(txt);
        if (Array.isArray(data)) {
            store.pdBribesHistory = data;
            $('pdJsonPaste').value = '';
            renderPdBribesHistory();
            updatePdCoverage();
            pasteStatus.pd = true;
            updatePasteStatus('ps-pd', true);
        } else {
            alert('Invalid JSON format. Expected an array of props.');
        }
    } catch (e) {
        alert('Failed to parse JSON: ' + e.message);
    }
}

function parsePdBribes() {
    let txt = $('pdPaste').value;
    let lines = txt.split('\n').map(l => l.trim()).filter(l => l);
    
    let newProp = {
        epoch_range: '',
        start_epoch: 0,
        end_epoch: 0,
        bribes: []
    };
    
    // Parse epoch range: "Bribes for [160-163]:"
    for (let line of lines) {
        let epochMatch = line.match(/\[(\d+)[-–—](\d+)\]/);
        if (epochMatch) {
            newProp.start_epoch = parseInt(epochMatch[1]);
            newProp.end_epoch = parseInt(epochMatch[2]);
            newProp.epoch_range = `[${newProp.start_epoch}-${newProp.end_epoch}]`;
            break;
        }
    }
    
    // Parse gauges and pools
    let currentGauge = null;
    
    for (let i = 0; i < lines.length; i++) {
        let line = lines[i];
        
        // Gauge header
        let gaugeMatch = line.match(/^Gauge:\s*(\w+)/i) || line.match(/^(project|bluechip|single|stable):/i);
        if (gaugeMatch) {
            currentGauge = gaugeMatch[1].toLowerCase();
            continue;
        }
        
        // Pool line
        let hasPoolPattern = line.match(/^[\*\•\-]?\s*([A-Za-z0-9\.\-]+)\s*\([\d\.]+%\)/);
        
        if (currentGauge && hasPoolPattern) {
            let poolNameMatch = line.match(/^[\*\•\-]?\s*([A-Za-z0-9\.\-]+)\s*\(/);
            let scoreMatch = line.match(/\((\d+\.?\d*)%\)/);
            let usdMatch = line.match(/:\s*\$?\s*(\d+)\s*=/);
            let lunaMatch = line.match(/=\s*([\d,\.]+)\s*LUNA/i);
            
            if (poolNameMatch && scoreMatch && usdMatch) {
                newProp.bribes.push({
                    gauge: currentGauge,
                    pool: poolNameMatch[1].toUpperCase(),
                    percent: parseFloat(scoreMatch[1]),
                    usd_per_epoch: parseFloat(usdMatch[1]),
                    luna_per_epoch: lunaMatch ? parseFloat(lunaMatch[1].replace(/,/g, '')) : 0
                });
            }
        }
    }
    
    // Store as new prop and update preview
    if (newProp.start_epoch && newProp.bribes.length > 0) {
        store.pdNewProp = newProp;
        updateNewPropPreview();
        
        // Check if this prop already exists
        let existingIdx = store.pdBribesHistory.findIndex(p => 
            p.start_epoch === newProp.start_epoch && p.end_epoch === newProp.end_epoch
        );
        
        if (existingIdx >= 0) {
            if (confirm(`Prop ${newProp.epoch_range} already exists. Replace it?`)) {
                store.pdBribesHistory[existingIdx] = newProp;
            }
        } else {
            store.pdBribesHistory.push(newProp);
            // Sort by start_epoch
            store.pdBribesHistory.sort((a, b) => a.start_epoch - b.start_epoch);
        }
        
        $('pdPaste').value = '';
        renderPdBribesHistory();
        updatePdCoverage();
        pasteStatus.pd = true;
        updatePasteStatus('ps-pd', true);
    } else {
        alert('Could not parse prop data. Check format.');
    }
}

function updateNewPropPreview() {
    let prop = store.pdNewProp;
    if (!prop) {
        setTxt('pd-new-range', '-');
        setTxt('pd-new-count', '0');
        setTxt('pd-new-per-epoch', '$0');
        setTxt('pd-new-total', '$0');
        setTxt('pd-new-pools', '0');
        return;
    }
    
    let epochCount = prop.end_epoch - prop.start_epoch + 1;
    let perEpoch = prop.bribes.reduce((sum, b) => sum + b.usd_per_epoch, 0);
    
    setTxt('pd-new-range', prop.epoch_range);
    setTxt('pd-new-count', epochCount);
    setTxt('pd-new-per-epoch', fmt$(perEpoch));
    setTxt('pd-new-total', fmt$(perEpoch * epochCount));
    setTxt('pd-new-pools', prop.bribes.length);
}

function updatePdCoverage() {
    // Get current epoch from meta (or use a reasonable default)
    let currentEpoch = store.meta.ep || 161;
    setTxt('pd-current-epoch', currentEpoch);
    
    // Find all covered epochs
    let coveredEpochs = new Set();
    let coveringRange = null;
    store.pdBribesHistory.forEach(prop => {
        for (let e = prop.start_epoch; e <= prop.end_epoch; e++) {
            coveredEpochs.add(e);
            if (e === currentEpoch) {
                coveringRange = prop;
            }
        }
    });
    
    // Find range
    let minEpoch = Math.min(...coveredEpochs) || 0;
    let maxEpoch = Math.max(...coveredEpochs) || 0;
    
    if (coveredEpochs.size > 0) {
        setTxt('pd-covered-range', `${minEpoch} - ${maxEpoch}`);
    } else {
        setTxt('pd-covered-range', '-');
    }
    
    // Check if current epoch is covered
    let isCovered = coveredEpochs.has(currentEpoch);
    let light = $('pd-coverage-light');
    let alertBox = $('pd-alert-box');
    let successBox = $('pd-success-box');
    let bribesSection = $('pd-current-bribes-section');
    
    if (isCovered && coveringRange) {
        light.className = 'w-4 h-4 rounded-full bg-green-500 border-2 border-green-400 shadow-lg shadow-green-500/50';
        setTxt('pd-missing-epochs', 'None');
        
        // Show success box
        if (alertBox) alertBox.classList.add('hidden');
        if (successBox) {
            successBox.classList.remove('hidden');
            setTxt('pd-success-epoch', currentEpoch);
            setTxt('pd-success-range', coveringRange.epoch_range);
            let totalBribes = coveringRange.bribes.reduce((s, b) => s + (b.usd_per_epoch || 0), 0);
            setTxt('pd-success-bribes', '$' + totalBribes.toLocaleString());
        }
        
        // Show current epoch bribes preview
        if (bribesSection) {
            bribesSection.classList.remove('hidden');
            renderCurrentEpochBribes(coveringRange, currentEpoch);
        }
    } else {
        light.className = 'w-4 h-4 rounded-full bg-red-500 border-2 border-red-400 shadow-lg shadow-red-500/50 animate-pulse';
        
        // Find missing epochs between min and current
        let missing = [];
        for (let e = minEpoch; e <= currentEpoch; e++) {
            if (!coveredEpochs.has(e)) missing.push(e);
        }
        setTxt('pd-missing-epochs', missing.length > 5 ? `${missing.slice(0,5).join(', ')}... (+${missing.length - 5})` : missing.join(', ') || currentEpoch.toString());
        
        // Show alert box
        if (successBox) successBox.classList.add('hidden');
        if (bribesSection) bribesSection.classList.add('hidden');
        if (alertBox) {
            alertBox.classList.remove('hidden');
            setTxt('pd-alert-epoch', currentEpoch);
            setTxt('pd-alert-epoch2', currentEpoch);
            // Suggest a range like [160-163]
            let suggestedStart = Math.floor(currentEpoch / 4) * 4;
            let suggestedEnd = suggestedStart + 3;
            setTxt('pd-alert-range', `${suggestedStart}-${suggestedEnd}`);
        }
    }
    
    // Update summary stats
    setTxt('pd-props-count', store.pdBribesHistory.length);
    setTxt('pd-total-epochs', coveredEpochs.size);
    
    let totalBribes = 0;
    store.pdBribesHistory.forEach(prop => {
        let epochCount = prop.end_epoch - prop.start_epoch + 1;
        let perEpoch = prop.bribes.reduce((sum, b) => sum + b.usd_per_epoch, 0);
        totalBribes += perEpoch * epochCount;
    });
    setTxt('pd-total-bribes', fmt$(totalBribes));
    
    // Update workflow status
    updateWorkflowStatus();
}

function renderCurrentEpochBribes(range, epoch) {
    const container = $('pd-current-bribes-grid');
    if (!container) return;
    
    // Get current LUNA price from Prices tab
    const lunaPrice = store.tokenPrices.LUNA?.price || 0;
    setTxt('pd-preview-epoch', `Epoch ${epoch}`);
    setTxt('pd-preview-luna-price', lunaPrice > 0 ? '$' + lunaPrice.toFixed(4) : '$-- (fetch prices first)');
    
    // Group bribes by gauge
    const gauges = {};
    range.bribes.forEach(bribe => {
        const gauge = bribe.gauge || 'unknown';
        if (!gauges[gauge]) gauges[gauge] = [];
        gauges[gauge].push(bribe);
    });
    
    let html = '';
    const gaugeColors = {
        'project': 'text-purple-400 border-purple-900/50 bg-purple-900/10',
        'bluechip': 'text-blue-400 border-blue-900/50 bg-blue-900/10',
        'single': 'text-green-400 border-green-900/50 bg-green-900/10',
        'stable': 'text-yellow-400 border-yellow-900/50 bg-yellow-900/10'
    };
    
    Object.entries(gauges).forEach(([gauge, bribes]) => {
        const colorClass = gaugeColors[gauge] || 'text-gray-400 border-gray-800 bg-gray-900/10';
        
        // Calculate gauge total
        const gaugeTotal = bribes.reduce((s, b) => s + (b.usd_per_epoch || 0), 0);
        const gaugeLuna = bribes.reduce((s, b) => s + (b.luna_per_epoch || 0), 0);
        
        html += `
            <div class="rounded border ${colorClass} p-3">
                <div class="flex justify-between items-center mb-2 border-b border-gray-800 pb-2">
                    <span class="font-bold text-[11px] uppercase">${gauge}</span>
                    <span class="text-[10px]">$${gaugeTotal}/ep | ${gaugeLuna.toFixed(0)} LUNA</span>
                </div>
                <div class="space-y-1">
        `;
        
        bribes.forEach(bribe => {
            const originalUsd = bribe.usd_per_epoch || 0;
            const lunaAmount = bribe.luna_per_epoch || 0;
            
            // Calculate original LUNA price when bribe was posted
            const originalLunaPrice = lunaAmount > 0 ? originalUsd / lunaAmount : 0;
            
            // Calculate current value
            const currentValue = lunaPrice > 0 && lunaAmount > 0 ? lunaAmount * lunaPrice : 0;
            
            // Calculate change
            let changeHtml = '';
            if (currentValue > 0 && originalUsd > 0) {
                const pctChange = ((currentValue - originalUsd) / originalUsd) * 100;
                const changeColor = pctChange >= 0 ? 'text-green-400' : 'text-red-400';
                const arrow = pctChange >= 0 ? '↑' : '↓';
                changeHtml = `<span class="${changeColor} text-[9px]">${arrow} ${Math.abs(pctChange).toFixed(1)}%</span>`;
            }
            
            html += `
                <div class="flex items-center justify-between text-[10px] py-1 border-b border-gray-800/50 last:border-0">
                    <div class="flex items-center gap-2">
                        <span class="text-white font-mono">${bribe.pool}</span>
                        <span class="text-gray-500">(${bribe.percent}%)</span>
                    </div>
                    <div class="flex items-center gap-3 text-right">
                        <div class="text-gray-400">
                            <span class="text-yellow-400">$${originalUsd}</span>
                            <span class="text-gray-600 mx-1">=</span>
                            <span class="text-cyan-400">${lunaAmount.toFixed(0)} LUNA</span>
                        </div>
                        ${currentValue > 0 ? `
                            <div class="text-gray-600">→</div>
                            <div>
                                <span class="text-green-400 font-bold">$${currentValue.toFixed(0)}</span>
                                ${changeHtml}
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        });
        
        html += `
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function confirmPdBribesComplete() {
    store.pdBribesVerified = true;
    updateWorkflowStatus();
}

function renderPdBribesHistory() {
    let html = '';
    
    if (store.pdBribesHistory.length === 0) {
        html = '<div class="text-gray-600 text-[10px] italic text-center py-8">No props loaded. Fetch from GitHub or paste JSON.</div>';
        setHtml('pd-history', html);
        return;
    }
    
    // Render each prop as a collapsible card
    store.pdBribesHistory.forEach((prop, idx) => {
        let epochCount = prop.end_epoch - prop.start_epoch + 1;
        let perEpoch = prop.bribes.reduce((sum, b) => sum + b.usd_per_epoch, 0);
        let total = perEpoch * epochCount;
        
        // Group bribes by gauge
        let byGauge = {};
        prop.bribes.forEach(b => {
            if (!byGauge[b.gauge]) byGauge[b.gauge] = [];
            byGauge[b.gauge].push(b);
        });
        
        html += `<div class="bg-[#161616] border border-gray-800 rounded overflow-hidden">
            <div class="flex justify-between items-center px-3 py-2 bg-gray-900/50 cursor-pointer hover:bg-gray-800/50" onclick="togglePropDetails(${idx})">
                <div class="flex items-center gap-3">
                    <span class="text-orange-400 font-bold text-[11px]">${prop.epoch_range}</span>
                    <span class="text-gray-500 text-[9px]">${epochCount} epochs</span>
                    <span class="text-gray-500 text-[9px]">${prop.bribes.length} pools</span>
                </div>
                <div class="flex items-center gap-3">
                    <span class="text-green-400 font-mono text-[10px]">${fmt$(perEpoch)}/ep</span>
                    <span class="text-green-400 font-mono text-[10px] font-bold">${fmt$(total)} total</span>
                    <button onclick="event.stopPropagation(); removeProp(${idx})" class="text-red-400 hover:text-red-300 text-[10px] ml-2">✕</button>
                </div>
            </div>
            <div id="prop-details-${idx}" class="hidden px-3 py-2 space-y-1 text-[9px]">`;
        
        // Render gauges
        Object.entries(byGauge).forEach(([gauge, bribes]) => {
            let gaugeColor = gauge === 'stable' ? 'blue' : gauge === 'project' ? 'purple' : gauge === 'bluechip' ? 'yellow' : 'green';
            let gaugeTotal = bribes.reduce((sum, b) => sum + b.usd_per_epoch, 0);
            
            html += `<div class="bg-${gaugeColor}-900/20 border-l-2 border-${gaugeColor}-500 px-2 py-1">
                <div class="flex justify-between text-${gaugeColor}-400 font-bold uppercase">${gauge} <span class="font-mono">${fmt$(gaugeTotal)}/ep</span></div>`;
            
            bribes.forEach(b => {
                html += `<div class="flex justify-between text-gray-400 pl-2">
                    <span class="text-white">${b.pool}</span>
                    <span>${b.percent.toFixed(1)}% | ${fmt$(b.usd_per_epoch)} | ${b.luna_per_epoch.toLocaleString(undefined,{maximumFractionDigits:0})} LUNA</span>
                </div>`;
            });
            
            html += `</div>`;
        });
        
        html += `</div></div>`;
    });
    
    setHtml('pd-history', html);
    updatePdCoverage();
}

function togglePropDetails(idx) {
    let el = $(`prop-details-${idx}`);
    if (el) el.classList.toggle('hidden');
}

function removeProp(idx) {
    if (confirm(`Remove prop ${store.pdBribesHistory[idx].epoch_range}?`)) {
        store.pdBribesHistory.splice(idx, 1);
        renderPdBribesHistory();
    }
}

function clearAllPdBribes() {
    if (confirm('Clear all loaded props?')) {
        store.pdBribesHistory = [];
        store.pdNewProp = null;
        renderPdBribesHistory();
        updatePdCoverage();
        updateNewPropPreview();
        pasteStatus.pd = false;
        updatePasteStatus('ps-pd', false);
    }
}

function exportPdBribesJson() {
    if (store.pdBribesHistory.length === 0) {
        alert('No props to export');
        return;
    }
    
    let json = JSON.stringify(store.pdBribesHistory, null, 2);
    let blob = new Blob([json], { type: 'application/json' });
    let url = URL.createObjectURL(blob);
    let a = document.createElement('a');
    a.href = url;
    a.download = 'tla_pd_bribes.json';
    a.click();
    URL.revokeObjectURL(url);
}

function copyPdBribesJson() {
    if (store.pdBribesHistory.length === 0) {
        alert('No props to copy');
        return;
    }
    
    let json = JSON.stringify(store.pdBribesHistory, null, 2);
    navigator.clipboard.writeText(json).then(() => {
        alert('Copied tla_pd_bribes.json to clipboard!\n\n' + store.pdBribesHistory.length + ' bribe ranges ready to paste into GitHub.');
    }).catch(e => {
        console.error('Copy failed:', e);
        alert('Copy failed. Try using Download instead.');
    });
}

// ============ ASTROPORT FUNCTIONS ============

// Convert timestamp to epoch number
function timestampToEpoch(ts) {
    // ts is in seconds, anchor is Nov 17, 2025 = Epoch 160
    let anchorTs = EPOCH_ANCHOR_DATE.getTime() / 1000;
    let diffWeeks = Math.floor((ts - anchorTs) / SECONDS_PER_WEEK);
    return EPOCH_ANCHOR_NUM + diffWeeks;
}

// Get epoch start/end timestamps
function getEpochRange(epochNum) {
    let anchorTs = EPOCH_ANCHOR_DATE.getTime() / 1000;
    let weeksDiff = epochNum - EPOCH_ANCHOR_NUM;
    let startTs = anchorTs + (weeksDiff * SECONDS_PER_WEEK);
    let endTs = startTs + SECONDS_PER_WEEK;
    return { start: startTs, end: endTs };
}

// Format timestamp to date string
function formatDate(ts) {
    let d = new Date(ts * 1000);
    return d.toISOString().split('T')[0];
}

// Update Astroport tab based on mode
function updateAstroTab() {
    if (store.mode === 'staging') {
        $('astro-staging-mode').classList.remove('hidden');
        $('astro-normal-mode').classList.add('hidden');
        updateStagingDisplay();
    } else {
        $('astro-staging-mode').classList.add('hidden');
        $('astro-normal-mode').classList.remove('hidden');
        updateNormalDisplay();
    }
    updateAstroLpDropdown();
}

function updateAstroStatus() {
    updateAstroTab();
}

// ============ LP DROPDOWN ============

function updateAstroLpDropdown() {
    // Filter for Astroport LPs only
    let astroLps = Object.entries(store.lpRegistry)
        .filter(([key, lp]) => lp.dex === 'Astroport');
    
    // Sort by bucket order, then A-Z within bucket
    const BUCKET_ORDER = ['stable', 'project', 'bluechip', 'single'];
    astroLps.sort((a, b) => {
        let bucketA = BUCKET_ORDER.indexOf(a[1].bucket);
        let bucketB = BUCKET_ORDER.indexOf(b[1].bucket);
        if (bucketA === -1) bucketA = 99;
        if (bucketB === -1) bucketB = 99;
        if (bucketA !== bucketB) return bucketA - bucketB;
        // A-Z within bucket
        return a[1].lp.localeCompare(b[1].lp);
    });
    
    let html = '<option value="">-- Select LP --</option>';
    
    // Group by bucket
    let currentBucket = null;
    astroLps.forEach(([key, lp]) => {
        // Start new optgroup for each bucket
        if (lp.bucket !== currentBucket) {
            if (currentBucket !== null) html += '</optgroup>';
            let bucketLabel = lp.bucket.charAt(0).toUpperCase() + lp.bucket.slice(1);
            html += `<optgroup label="${bucketLabel}">`;
            currentBucket = lp.bucket;
        }
        
        let status = getStagingLpStatus(key);
        let icon = status.notAvailable ? '⛔' :
                   status.isComplete ? '🟢' : 
                   status.daysCaptured.length > 0 ? '🟡' : 
                   lp.active ? '⚪' : '⬜';
        let rangeLabel = status.range !== 180 ? ` [${status.range}d]` : '';
        let naLabel = status.notAvailable ? ' (N/A)' : '';
        html += `<option value="${key}">${icon} ${lp.lp} (${lp.vote_pct.toFixed(1)}%)${rangeLabel}${naLabel}</option>`;
    });
    
    if (currentBucket !== null) html += '</optgroup>';
    
    // Update both dropdowns
    if ($('astro-lp-select')) setHtml('astro-lp-select', html);
    if ($('astro-lp-select-normal')) setHtml('astro-lp-select-normal', html);
}

function getStagingLpStatus(lpKey) {
    // Check ALL staging days for this LP
    let daysCaptured = [];
    let range = 180; // default
    let hasLiq = false;
    let hasVol = false;
    let notAvailable = false;
    
    ['day1', 'day2', 'day3', 'day4'].forEach((day, idx) => {
        let dayData = store.staging[day];
        if (dayData && dayData.lps && dayData.lps[lpKey]) {
            let lp = dayData.lps[lpKey];
            if (lp.range) range = lp.range;
            if (lp.notAvailable) notAvailable = true;
            if (lp.liquidity?.length > 0 || lp.volume?.length > 0) {
                daysCaptured.push(idx + 1);
            }
            if (lp.liquidity?.length > 0) hasLiq = true;
            if (lp.volume?.length > 0) hasVol = true;
        }
    });
    
    // Days needed based on range
    let daysNeeded = range === 180 ? 4 : range === 90 ? 2 : 1;
    let isComplete = (daysCaptured.length >= daysNeeded && hasLiq && hasVol) || notAvailable;
    
    return {
        liq: hasLiq,
        vol: hasVol,
        range: range,
        daysCaptured: daysCaptured,
        daysNeeded: daysNeeded,
        isComplete: isComplete,
        notAvailable: notAvailable
    };
}

function updateSelectedLp() {
    let lpKey = $('astro-lp-select').value;
    if (!lpKey) {
        setTxt('astro-lp-liq-status', '-');
        setTxt('astro-lp-vol-status', '-');
        setTxt('astro-lp-days-status', '-');
        return;
    }
    
    let status = getStagingLpStatus(lpKey);
    
    // Update range dropdown to match stored range
    if ($('astro-data-range')) {
        $('astro-data-range').value = status.range.toString();
    }
    
    // Check if marked as not available
    if (status.notAvailable) {
        setTxt('astro-lp-liq-status', '⛔ N/A');
        $('astro-lp-liq-status').className = 'text-yellow-400';
        setTxt('astro-lp-vol-status', '⛔ N/A');
        $('astro-lp-vol-status').className = 'text-yellow-400';
        setTxt('astro-lp-days-status', 'Marked unavailable');
        $('astro-lp-days-status').className = 'text-yellow-400';
        return;
    }
    
    // Current day status
    let currentDay = $('staging-current-day')?.value || 'day1';
    let dayData = store.staging[currentDay];
    let currentDayLiq = dayData?.lps?.[lpKey]?.liquidity?.length || 0;
    let currentDayVol = dayData?.lps?.[lpKey]?.volume?.length || 0;
    
    if (currentDayLiq > 0) {
        setTxt('astro-lp-liq-status', `✓ ${currentDayLiq} pts`);
        $('astro-lp-liq-status').className = 'text-green-400';
    } else {
        setTxt('astro-lp-liq-status', 'Not captured');
        $('astro-lp-liq-status').className = 'text-gray-600';
    }
    
    if (currentDayVol > 0) {
        setTxt('astro-lp-vol-status', `✓ ${currentDayVol} pts`);
        $('astro-lp-vol-status').className = 'text-green-400';
    } else {
        setTxt('astro-lp-vol-status', 'Not captured');
        $('astro-lp-vol-status').className = 'text-gray-600';
    }
    
    // Days status
    let daysStr = status.daysCaptured.length > 0 ? status.daysCaptured.join(',') : 'none';
    let daysClass = status.isComplete ? 'text-green-400' : 
                    status.daysCaptured.length > 0 ? 'text-yellow-400' : 'text-gray-600';
    setTxt('astro-lp-days-status', `${daysStr} / ${status.daysNeeded} needed`);
    $('astro-lp-days-status').className = daysClass;
}

// ============ STAGING MODE ============

function updateStagingDay() {
    updateSelectedLp();
    renderStagingLpGrid();
}

function updateStagingDisplay() {
    // Update day tracker cards
    ['day1', 'day2', 'day3', 'day4'].forEach(day => {
        let dayData = store.staging[day];
        let statusEl = $(`staging-${day}-status`);
        let lpsEl = $(`staging-${day}-lps`);
        let cardEl = $(`staging-${day}`);
        
        if (dayData && dayData.lps && Object.keys(dayData.lps).length > 0) {
            let lpCount = Object.keys(dayData.lps).length;
            let complete = Object.values(dayData.lps).filter(lp => 
                lp.liquidity?.length > 0 && lp.volume?.length > 0
            ).length;
            
            statusEl.textContent = dayData.captureDate || 'Captured';
            statusEl.className = 'text-[10px] text-green-400';
            lpsEl.textContent = `${complete}/${lpCount} LPs`;
            cardEl.className = 'bg-green-900/20 rounded p-3 border border-green-700';
        } else {
            statusEl.textContent = 'Not started';
            statusEl.className = 'text-[10px] text-gray-600';
            lpsEl.textContent = '0 LPs';
            cardEl.className = 'bg-[#0D0D0D] rounded p-3 border border-gray-800';
        }
    });
    
    // Check if we have at least some LPs and at least 1 day captured
    let hasData = ['day1', 'day2', 'day3', 'day4'].some(day => 
        store.staging[day] && store.staging[day].lps && Object.keys(store.staging[day].lps).length > 0
    );
    
    // Count how many LPs are fully complete based on their range
    let astroLps = Object.entries(store.lpRegistry).filter(([k, lp]) => lp.dex === 'Astroport');
    let completeLps = astroLps.filter(([key, lp]) => {
        let status = getStagingLpStatus(key);
        return status.isComplete;
    }).length;
    
    // Show finalize if we have any complete LPs
    if (completeLps > 0) {
        $('staging-finalize-section').classList.remove('hidden');
        setTxt('staging-ready-count', `${completeLps} LP${completeLps > 1 ? 's' : ''} ready`);
    } else {
        $('staging-finalize-section').classList.add('hidden');
    }
    
    renderStagingLpGrid();
}

function renderStagingLpGrid() {
    let currentDay = $('staging-current-day')?.value || 'day1';
    
    // Get all Astroport LPs from registry
    const BUCKET_ORDER = ['stable', 'project', 'bluechip', 'single'];
    let astroLps = Object.entries(store.lpRegistry)
        .filter(([key, lp]) => lp.dex === 'Astroport')
        .sort((a, b) => {
            // Sort by bucket order, then A-Z within bucket
            let bucketA = BUCKET_ORDER.indexOf(a[1].bucket);
            let bucketB = BUCKET_ORDER.indexOf(b[1].bucket);
            if (bucketA === -1) bucketA = 99;
            if (bucketB === -1) bucketB = 99;
            if (bucketA !== bucketB) return bucketA - bucketB;
            return a[1].lp.localeCompare(b[1].lp);
        });
    
    let html = '';
    let complete = 0;
    let activeComplete = 0;
    let activeTotal = astroLps.filter(([k, lp]) => lp.active).length;
    let notAvailableCount = 0;
    let currentBucket = null;
    
    astroLps.forEach(([key, lp]) => {
        let status = getStagingLpStatus(key);
        
        if (status.isComplete) {
            complete++;
            if (lp.active) activeComplete++;
        }
        if (status.notAvailable) notAvailableCount++;
        
        // Bucket header
        if (lp.bucket !== currentBucket) {
            if (currentBucket !== null) {
                html += '</div></div>'; // Close previous bucket
            }
            currentBucket = lp.bucket;
            let bucketColor = lp.bucket === 'stable' ? 'blue' : lp.bucket === 'project' ? 'purple' : lp.bucket === 'bluechip' ? 'yellow' : 'green';
            let bucketLabel = lp.bucket.charAt(0).toUpperCase() + lp.bucket.slice(1);
            html += `<div class="col-span-4 mb-2">
                <div class="text-[9px] font-bold text-${bucketColor}-400 uppercase mb-1 border-b border-${bucketColor}-900 pb-1">${bucketLabel}</div>
                <div class="grid grid-cols-4 gap-2">`;
        }
        
        // Color based on completion
        let bgClass = status.notAvailable ? 'bg-yellow-900/20 border-yellow-800' :
                      status.isComplete ? 'bg-green-900/30 border-green-700' : 
                      status.daysCaptured.length > 0 ? 'bg-yellow-900/30 border-yellow-700' :
                      'bg-[#0D0D0D] border-gray-800';
        
        let activeClass = lp.active ? 'text-white' : 'text-gray-500';
        let pctClass = lp.active ? 'text-green-400' : (lp.vote_pct >= 0.5 ? 'text-yellow-400' : 'text-gray-600');
        
        // Range badge
        let rangeBadge = status.range === 180 ? '180' : status.range === 90 ? '90' : '30';
        let rangeColor = status.range === 180 ? 'text-blue-400' : status.range === 90 ? 'text-cyan-400' : 'text-green-400';
        
        // Status display
        let statusDisplay = '';
        if (status.notAvailable) {
            statusDisplay = '<span class="text-yellow-400">⛔ N/A</span>';
        } else {
            let daysIndicator = `${status.daysCaptured.length}/${status.daysNeeded}`;
            statusDisplay = `<div class="flex gap-2">
                <span class="${status.liq ? 'text-cyan-400' : 'text-gray-600'}">L:${status.liq ? '✓' : '○'}</span>
                <span class="${status.vol ? 'text-purple-400' : 'text-gray-600'}">V:${status.vol ? '✓' : '○'}</span>
            </div>
            <div class="flex gap-1 items-center">
                <span class="${rangeColor} text-[7px]">${rangeBadge}d</span>
                <span class="${status.isComplete ? 'text-green-400' : 'text-gray-500'} text-[8px]">${daysIndicator}</span>
            </div>`;
        }
        
        html += `<div class="p-2 rounded border ${bgClass} text-[9px]">
            <div class="flex justify-between items-start">
                <div class="${activeClass} font-mono truncate flex-1" title="${lp.lp}">${lp.lp}</div>
                <span class="${pctClass} text-[8px] ml-1">${lp.vote_pct.toFixed(1)}%</span>
            </div>
            <div class="flex justify-between mt-1">
                ${statusDisplay}
            </div>
        </div>`;
    });
    
    // Close last bucket
    if (currentBucket !== null) {
        html += '</div></div>';
    }
    
    setHtml('astro-staging-lp-grid', html || '<div class="col-span-4 text-gray-600 italic text-center py-4">No LPs in registry. Parse Vote tab first.</div>');
    
    let naLabel = notAvailableCount > 0 ? ` (${notAvailableCount} N/A)` : '';
    setTxt('astro-staging-complete', `${activeComplete}/${activeTotal} active, ${complete}/${astroLps.length} total${naLabel}`);
    setTxt('astro-staging-total', '');
}

function detectDataRange(series) {
    // Check interval between first few points to determine range
    if (!series || series.length < 3) return 180; // default
    
    // Calculate average interval from first 5 points
    let intervals = [];
    for (let i = 1; i < Math.min(5, series.length); i++) {
        let diff = series[i].time - series[i-1].time;
        intervals.push(diff);
    }
    
    let avgInterval = intervals.reduce((a, b) => a + b, 0) / intervals.length;
    let avgDays = avgInterval / 86400; // convert to days
    
    // Determine range based on interval
    // 180d = ~4 day intervals (345600 sec)
    // 90d = ~2 day intervals (172800 sec)
    // 30d = ~1 day intervals (86400 sec)
    
    if (avgDays >= 3) return 180;      // 3-4+ day intervals = 180d
    if (avgDays >= 1.5) return 90;     // 1.5-3 day intervals = 90d
    return 30;                          // <1.5 day intervals = 30d
}

function captureStagingBoth() {
    let lpKey = $('astro-lp-select').value;
    let currentDay = $('staging-current-day').value;
    
    if (!lpKey) {
        alert('Please select an LP first');
        return;
    }
    
    let liqTxt = $('astroLiqPaste').value.trim();
    let volTxt = $('astroVolPaste').value.trim();
    
    if (!liqTxt && !volTxt) {
        alert('Please paste at least one data type (liquidity or volume)');
        return;
    }
    
    // Get LP name for display
    let lpName = store.lpRegistry[lpKey]?.lp || lpKey;
    
    // Initialize staging day if needed
    if (!store.staging[currentDay]) {
        store.staging[currentDay] = {
            captureDate: new Date().toISOString().split('T')[0],
            lps: {}
        };
    }
    
    if (!store.staging[currentDay].lps[lpKey]) {
        store.staging[currentDay].lps[lpKey] = {
            liquidity: [],
            volume: [],
            range: 180
        };
    }
    
    let liqCount = 0, volCount = 0;
    let detectedRange = null;
    
    // Parse liquidity if provided
    if (liqTxt) {
        try {
            let json = JSON.parse(liqTxt);
            let series = json?.result?.data?.json?.[0]?.series;
            if (series && Array.isArray(series)) {
                // Auto-detect range from data
                detectedRange = detectDataRange(series);
                
                let rawPoints = series.map(point => ({
                    ts: point.time,
                    v: point.value,
                    date: formatDate(point.time)
                }));
                store.staging[currentDay].lps[lpKey].liquidity = rawPoints;
                liqCount = rawPoints.length;
            }
        } catch (e) {
            alert('Failed to parse Liquidity JSON: ' + e.message);
            return;
        }
    }
    
    // Parse volume if provided
    if (volTxt) {
        try {
            let json = JSON.parse(volTxt);
            let series = json?.result?.data?.json?.[0]?.series;
            if (series && Array.isArray(series)) {
                // Auto-detect range from data (use this if liq didn't set it)
                if (!detectedRange) {
                    detectedRange = detectDataRange(series);
                }
                
                let rawPoints = series.map(point => ({
                    ts: point.time,
                    v: point.value,
                    date: formatDate(point.time)
                }));
                store.staging[currentDay].lps[lpKey].volume = rawPoints;
                volCount = rawPoints.length;
            }
        } catch (e) {
            alert('Failed to parse Volume JSON: ' + e.message);
            return;
        }
    }
    
    // Set auto-detected range
    if (detectedRange) {
        store.staging[currentDay].lps[lpKey].range = detectedRange;
        // Update dropdown to show detected range
        if ($('astro-data-range')) {
            $('astro-data-range').value = detectedRange.toString();
        }
    }
    
    // Calculate days needed based on detected range
    let daysNeeded = detectedRange === 180 ? 4 : detectedRange === 90 ? 2 : 1;
    
    // Clear paste boxes but KEEP the selection
    $('astroLiqPaste').value = '';
    $('astroVolPaste').value = '';
    
    // Update UI
    updateSelectedLp();
    updateStagingDisplay();
    updateAstroLpDropdown();
    
    alert(`Captured ${lpName}:\n• Liquidity: ${liqCount} points\n• Volume: ${volCount} points\n• Detected: ${detectedRange}d data (${daysNeeded} days needed)`);
}

function parseStagingData(type) {
    captureStagingBoth();
}

function parseStagingLiquidity() {
    captureStagingBoth();
}

function parseStagingVolume() {
    captureStagingBoth();
}

function updateSelectedLpRange() {
    updateSelectedLp();
}

function clearLpData() {
    let lpKey = $('astro-lp-select').value;
    let currentDay = $('staging-current-day').value;
    
    if (!lpKey) {
        alert('Please select an LP first');
        return;
    }
    
    let lpName = store.lpRegistry[lpKey]?.lp || lpKey;
    
    if (!confirm(`Clear all data for ${lpName} on ${currentDay}?`)) {
        return;
    }
    
    if (store.staging[currentDay] && store.staging[currentDay].lps && store.staging[currentDay].lps[lpKey]) {
        delete store.staging[currentDay].lps[lpKey];
    }
    
    updateSelectedLp();
    updateStagingDisplay();
    updateAstroLpDropdown();
    
    alert(`Cleared ${lpName} data from ${currentDay}`);
}

function markLpNotAvailable() {
    let lpKey = $('astro-lp-select').value;
    let currentDay = $('staging-current-day').value;
    
    if (!lpKey) {
        alert('Please select an LP first');
        return;
    }
    
    let lpName = store.lpRegistry[lpKey]?.lp || lpKey;
    
    if (!confirm(`Mark ${lpName} as "Data Not Available"?\n\nThis will count as complete but flag it as unavailable.`)) {
        return;
    }
    
    // Initialize staging day if needed
    if (!store.staging[currentDay]) {
        store.staging[currentDay] = {
            captureDate: new Date().toISOString().split('T')[0],
            lps: {}
        };
    }
    
    // Set notAvailable flag
    store.staging[currentDay].lps[lpKey] = {
        liquidity: [],
        volume: [],
        range: 180,
        notAvailable: true,
        notAvailableDate: new Date().toISOString().split('T')[0]
    };
    
    updateSelectedLp();
    updateStagingDisplay();
    updateAstroLpDropdown();
    
    alert(`Marked ${lpName} as "Data Not Available"`);
}

function exportStagingDay() {
    let currentDay = $('staging-current-day').value;
    let dayData = store.staging[currentDay];
    
    if (!dayData || !dayData.lps || Object.keys(dayData.lps).length === 0) {
        alert('No data for current day');
        return;
    }
    
    let json = JSON.stringify(dayData, null, 2);
    let blob = new Blob([json], { type: 'application/json' });
    let url = URL.createObjectURL(blob);
    let a = document.createElement('a');
    a.href = url;
    a.download = `tla_ext_staging_${currentDay}.json`;
    a.click();
    URL.revokeObjectURL(url);
}

function loadStagingDayPaste() {
    let txt = prompt('Paste staging day JSON:');
    if (!txt) return;
    
    let currentDay = $('staging-current-day').value;
    
    try {
        let data = JSON.parse(txt);
        if (data.lps) {
            store.staging[currentDay] = data;
            updateStagingDisplay();
            updateAstroLpDropdown();
            alert(`Loaded staging data for ${currentDay}`);
        } else {
            alert('Invalid staging data format');
        }
    } catch (e) {
        alert('Invalid JSON: ' + e.message);
    }
}

function finalizeStaging() {
    // Get only LPs that are complete based on their range (includes notAvailable)
    let astroLps = Object.entries(store.lpRegistry).filter(([k, lp]) => lp.dex === 'Astroport');
    let completeLpKeys = astroLps
        .filter(([key, lp]) => getStagingLpStatus(key).isComplete)
        .map(([key, lp]) => key);
    
    // Separate notAvailable LPs
    let notAvailableLpKeys = completeLpKeys.filter(key => getStagingLpStatus(key).notAvailable);
    let dataLpKeys = completeLpKeys.filter(key => !getStagingLpStatus(key).notAvailable);
    
    if (completeLpKeys.length === 0) {
        alert('No LPs are fully complete based on their data range requirements.');
        return;
    }
    
    let naMsg = notAvailableLpKeys.length > 0 ? `\n(${notAvailableLpKeys.length} marked as N/A)` : '';
    if (!confirm(`Generate historical file from ${completeLpKeys.length} complete LP(s)?${naMsg}\n\nThis will calculate epoch averages from all raw points.`)) {
        return;
    }
    
    // Merge all days of raw data for COMPLETE LPs with data
    let allRawData = {}; // { lpKey: { liquidity: [], volume: [], range: X } }
    
    ['day1', 'day2', 'day3', 'day4'].forEach(day => {
        let dayData = store.staging[day];
        if (!dayData || !dayData.lps) return;
        
        Object.entries(dayData.lps).forEach(([lpKey, lpData]) => {
            // Only include complete LPs that have data
            if (!dataLpKeys.includes(lpKey)) return;
            
            if (!allRawData[lpKey]) {
                allRawData[lpKey] = { 
                    liquidity: [], 
                    volume: [],
                    range: lpData.range || 180
                };
            }
            
            if (lpData.liquidity) {
                allRawData[lpKey].liquidity.push(...lpData.liquidity);
            }
            if (lpData.volume) {
                allRawData[lpKey].volume.push(...lpData.volume);
            }
        });
    });
    
    // Dedupe by timestamp and calculate epoch averages
    let historical = {
        meta: {
            created: new Date().toISOString(),
            source: 'staging_finalize',
            lp_count: completeLpKeys.length,
            not_available_count: notAvailableLpKeys.length
        },
        lps: {}
    };
    
    Object.entries(allRawData).forEach(([lpKey, lpData]) => {
        historical.lps[lpKey] = {
            liquidity: { epochs: {}, raw: [] },
            volume: { epochs: {}, raw: [] },
            range: lpData.range
        };
        
        ['liquidity', 'volume'].forEach(type => {
            // Dedupe by timestamp
            let seen = new Set();
            let uniquePoints = lpData[type].filter(p => {
                if (seen.has(p.ts)) return false;
                seen.add(p.ts);
                return true;
            });
            
            // Store raw
            historical.lps[lpKey][type].raw = uniquePoints;
            
            // Group by epoch
            let epochData = {};
            uniquePoints.forEach(p => {
                let epoch = timestampToEpoch(p.ts);
                if (!epochData[epoch]) {
                    epochData[epoch] = { values: [], sum: 0, count: 0 };
                }
                epochData[epoch].values.push(p.v);
                epochData[epoch].sum += p.v;
                epochData[epoch].count++;
            });
            
            // Calculate averages for complete epochs
            let currentEpoch = store.meta.ep || timestampToEpoch(Date.now() / 1000);
            Object.entries(epochData).forEach(([ep, data]) => {
                let epochNum = parseInt(ep);
                let epochRange = getEpochRange(epochNum);
                let isComplete = (Date.now() / 1000) > epochRange.end;
                
                if (isComplete) {
                    historical.lps[lpKey][type].epochs[epochNum] = {
                        avg: Math.round((data.sum / data.count) * 100) / 100,
                        dataPoints: data.count,
                        startDate: formatDate(epochRange.start),
                        endDate: formatDate(epochRange.end)
                    };
                }
            });
        });
    });
    
    // Add notAvailable LPs with flag
    notAvailableLpKeys.forEach(lpKey => {
        historical.lps[lpKey] = {
            notAvailable: true,
            notAvailableDate: new Date().toISOString().split('T')[0],
            liquidity: { epochs: {}, raw: [] },
            volume: { epochs: {}, raw: [] }
        };
    });
    
    // Update epoch coverage in meta
    let allEpochs = new Set();
    Object.values(historical.lps).forEach(lp => {
        Object.keys(lp.liquidity.epochs).forEach(ep => allEpochs.add(parseInt(ep)));
        Object.keys(lp.volume.epochs).forEach(ep => allEpochs.add(parseInt(ep)));
    });
    
    if (allEpochs.size > 0) {
        historical.meta.epoch_start = Math.min(...allEpochs);
        historical.meta.epoch_end = Math.max(...allEpochs);
    }
    
    // Store and export
    store.historical = historical;
    
    let json = JSON.stringify(historical, null, 2);
    let blob = new Blob([json], { type: 'application/json' });
    let url = URL.createObjectURL(blob);
    let a = document.createElement('a');
    a.href = url;
    a.download = 'tla_ext_historical.json';
    a.click();
    URL.revokeObjectURL(url);
    
    alert('Historical file generated! Switch to Normal mode for weekly updates.');
}

// ============ NORMAL MODE ============

function updateNormalDisplay() {
    // Historical stats
    if (store.historical.meta) {
        setTxt('hist-epochs', `${store.historical.meta.epoch_start || '-'} - ${store.historical.meta.epoch_end || '-'}`);
        setTxt('hist-lps', store.historical.lps ? Object.keys(store.historical.lps).length : 0);
        setTxt('hist-updated', store.historical.meta.created?.split('T')[0] || '-');
    }
    
    // Current stats
    if (store.current.meta) {
        setTxt('curr-epochs', `${store.current.meta.epoch_start || '-'} - ${store.current.meta.epoch_end || '-'}`);
        setTxt('curr-lps', store.current.lps ? Object.keys(store.current.lps).length : 0);
        setTxt('curr-updated', store.current.meta.last_updated || '-');
    }
    
    // Update historical status (need/archive)
    updateHistoricalStatus();
    
    renderNormalLpGrid();
}

function updateHistoricalStatus() {
    let currentEpoch = store.meta.ep || 161;
    let histStart = store.historical.meta?.epoch_start || 0;
    let histEnd = store.historical.meta?.epoch_end || 0;
    
    // What epochs are needed? (from histEnd+1 to currentEpoch)
    let needEpochs = [];
    if (histEnd > 0 && histEnd < currentEpoch) {
        for (let e = histEnd + 1; e <= currentEpoch; e++) {
            needEpochs.push(e);
        }
    }
    
    // What epochs should be archived? (older than 180 days = ~26 epochs)
    let archiveEpochs = [];
    let archiveCutoff = currentEpoch - 26; // ~180 days
    if (histStart > 0 && histStart < archiveCutoff) {
        for (let e = histStart; e < archiveCutoff; e++) {
            archiveEpochs.push(e);
        }
    }
    
    // Update UI
    let needEl = $('hist-need-epochs');
    let archiveEl = $('hist-archive-epochs');
    
    if (needEl) {
        if (needEpochs.length > 0) {
            needEl.classList.remove('hidden');
            let needStr = needEpochs.length > 5 
                ? `Ep ${needEpochs[0]}-${needEpochs[needEpochs.length-1]}` 
                : needEpochs.map(e => e).join(', ');
            setTxt('hist-need-list', needStr);
        } else {
            needEl.classList.add('hidden');
        }
    }
    
    if (archiveEl) {
        if (archiveEpochs.length > 0) {
            archiveEl.classList.remove('hidden');
            let archiveStr = `Ep ${archiveEpochs[0]}${archiveEpochs.length > 1 ? '-' + archiveEpochs[archiveEpochs.length-1] : ''}`;
            setTxt('hist-archive-list', archiveStr);
        } else {
            archiveEl.classList.add('hidden');
        }
    }
}

async function fetchHistoricalFromGithub() {
    try {
        let resp = await fetch(HISTORICAL_URL);
        if (resp.ok) {
            store.historical = await resp.json();
            setTxt('fetch-historical', '✓');
            updateNormalDisplay();
        } else {
            setTxt('fetch-historical', '-');
        }
    } catch(e) {
        setTxt('fetch-historical', '✗');
        console.error('Failed to fetch historical:', e);
    }
}

function exportArchive() {
    // Extract epochs older than 180 days from historical
    let currentEpoch = store.meta.ep || 161;
    let archiveCutoff = currentEpoch - 26;
    
    if (!store.historical.lps || Object.keys(store.historical.lps).length === 0) {
        alert('No historical data loaded. Fetch from GitHub first.');
        return;
    }
    
    let archive = {
        meta: {
            archived_at: new Date().toISOString(),
            cutoff_epoch: archiveCutoff,
            source: 'tla_ext_historical'
        },
        lps: {}
    };
    
    let hasArchiveData = false;
    
    // Extract old epochs from each LP
    Object.entries(store.historical.lps).forEach(([lpKey, lpData]) => {
        let archiveLp = { liquidity: { epochs: {} }, volume: { epochs: {} } };
        
        // Liquidity epochs
        if (lpData.liquidity?.epochs) {
            Object.entries(lpData.liquidity.epochs).forEach(([ep, data]) => {
                if (parseInt(ep) < archiveCutoff) {
                    archiveLp.liquidity.epochs[ep] = data;
                    hasArchiveData = true;
                }
            });
        }
        
        // Volume epochs
        if (lpData.volume?.epochs) {
            Object.entries(lpData.volume.epochs).forEach(([ep, data]) => {
                if (parseInt(ep) < archiveCutoff) {
                    archiveLp.volume.epochs[ep] = data;
                    hasArchiveData = true;
                }
            });
        }
        
        // Only add LP if it has archive data
        if (Object.keys(archiveLp.liquidity.epochs).length > 0 || Object.keys(archiveLp.volume.epochs).length > 0) {
            archive.lps[lpKey] = archiveLp;
        }
    });
    
    if (!hasArchiveData) {
        alert('No epochs older than ' + archiveCutoff + ' to archive.');
        return;
    }
    
    // Find epoch range in archive
    let allEpochs = new Set();
    Object.values(archive.lps).forEach(lp => {
        Object.keys(lp.liquidity.epochs).forEach(ep => allEpochs.add(parseInt(ep)));
        Object.keys(lp.volume.epochs).forEach(ep => allEpochs.add(parseInt(ep)));
    });
    archive.meta.epoch_start = Math.min(...allEpochs);
    archive.meta.epoch_end = Math.max(...allEpochs);
    
    downloadJson(JSON.stringify(archive, null, 2), 'tla_ext_archive.json');
}

function updateSelectedLpNormal() {
    let lpKey = $('astro-lp-select-normal').value;
    if (!lpKey) {
        setTxt('normal-lp-last-epoch', '-');
        return;
    }
    
    let lastEpoch = 0;
    if (store.current.lps && store.current.lps[lpKey]) {
        let liqEpochs = Object.keys(store.current.lps[lpKey].liquidity?.epochs || {}).map(Number);
        let volEpochs = Object.keys(store.current.lps[lpKey].volume?.epochs || {}).map(Number);
        lastEpoch = Math.max(...liqEpochs, ...volEpochs, 0);
    }
    
    setTxt('normal-lp-last-epoch', lastEpoch || '-');
}

function renderNormalLpGrid() {
    // Show ALL Astroport LPs, not just active
    let astroLps = Object.entries(store.lpRegistry)
        .filter(([key, lp]) => lp.dex === 'Astroport')
        .sort((a, b) => {
            // Active first, then by vote %
            if (a[1].active !== b[1].active) return b[1].active - a[1].active;
            return b[1].vote_pct - a[1].vote_pct;
        });
    
    let html = '';
    let currentEpoch = store.meta.ep || 161;
    
    astroLps.forEach(([key, lp]) => {
        let lastEpoch = 0;
        if (store.current.lps && store.current.lps[key]) {
            let liqEpochs = Object.keys(store.current.lps[key].liquidity?.epochs || {}).map(Number);
            let volEpochs = Object.keys(store.current.lps[key].volume?.epochs || {}).map(Number);
            lastEpoch = Math.max(...liqEpochs, ...volEpochs, 0);
        }
        
        let upToDate = lastEpoch >= currentEpoch - 1;
        let bgClass = upToDate ? 'bg-green-900/30 border-green-700' : 
                      lastEpoch > 0 ? 'bg-yellow-900/30 border-yellow-700' :
                      'bg-[#0D0D0D] border-gray-800';
        
        let nameClass = lp.active ? 'text-white' : 'text-gray-500';
        let pctClass = lp.active ? 'text-green-400' : 'text-gray-600';
        
        html += `<div class="p-2 rounded border ${bgClass} text-[9px]">
            <div class="flex justify-between">
                <span class="${nameClass} font-mono truncate" title="${lp.lp}">${lp.lp}</span>
                <span class="${pctClass} text-[8px]">${lp.vote_pct.toFixed(1)}%</span>
            </div>
            <div class="text-gray-400 mt-1">Last: ${lastEpoch || '-'}</div>
        </div>`;
    });
    
    setHtml('astro-normal-lp-grid', html || '<div class="col-span-4 text-gray-600 italic text-center py-4">No LPs in registry.</div>');
}

function parseNormalData(type) {
    let pasteId = type === 'liquidity' ? 'normalLiqPaste' : 'normalVolPaste';
    let txt = $(pasteId).value.trim();
    let lpKey = $('astro-lp-select-normal').value;
    
    if (!lpKey) {
        alert('Please select an LP first');
        return;
    }
    
    if (!txt) {
        alert('Please paste data');
        return;
    }
    
    // Get LP name from key for display
    let lpName = store.lpRegistry[lpKey]?.lp || lpKey;
    
    try {
        let json = JSON.parse(txt);
        let series = json?.result?.data?.json?.[0]?.series;
        
        if (!series || !Array.isArray(series)) {
            alert('Invalid data format');
            return;
        }
        
        // Initialize current if needed
        if (!store.current.lps) store.current.lps = {};
        if (!store.current.lps[lpKey]) {
            store.current.lps[lpKey] = {
                liquidity: { epochs: {}, raw: [] },
                volume: { epochs: {}, raw: [] }
            };
        }
        
        // Parse and merge raw points
        let existing = new Set(store.current.lps[lpKey][type].raw.map(p => p.ts));
        let newPoints = series
            .filter(p => !existing.has(p.time))
            .map(p => ({ ts: p.time, v: p.value, date: formatDate(p.time) }));
        
        store.current.lps[lpKey][type].raw.push(...newPoints);
        
        // Recalculate epoch averages
        let epochData = {};
        store.current.lps[lpKey][type].raw.forEach(p => {
            let epoch = timestampToEpoch(p.ts);
            if (!epochData[epoch]) epochData[epoch] = { sum: 0, count: 0 };
            epochData[epoch].sum += p.v;
            epochData[epoch].count++;
        });
        
        let currentEpoch = store.meta.ep || timestampToEpoch(Date.now() / 1000);
        Object.entries(epochData).forEach(([ep, data]) => {
            let epochNum = parseInt(ep);
            let epochRange = getEpochRange(epochNum);
            let isComplete = (Date.now() / 1000) > epochRange.end;
            
            if (isComplete) {
                store.current.lps[lpKey][type].epochs[epochNum] = {
                    avg: Math.round((data.sum / data.count) * 100) / 100,
                    dataPoints: data.count,
                    startDate: formatDate(epochRange.start),
                    endDate: formatDate(epochRange.end)
                };
            }
        });
        
        // Update meta
        if (!store.current.meta) store.current.meta = {};
        store.current.meta.last_updated = new Date().toISOString().split('T')[0];
        
        $(pasteId).value = '';
        updateNormalDisplay();
        updateAstroLpDropdown();
        
        alert(`Merged ${newPoints.length} new ${type} points for ${lpName}`);
        
    } catch (e) {
        alert('Failed to parse: ' + e.message);
    }
}

function parseNormalLiquidity() {
    parseNormalData('liquidity');
}

function parseNormalVolume() {
    parseNormalData('volume');
}

// ============ EXPORT FUNCTIONS ============

function exportHistorical() {
    let json = JSON.stringify(store.historical, null, 2);
    downloadJson(json, 'tla_ext_historical.json');
}

function exportCurrent() {
    let json = JSON.stringify(store.current, null, 2);
    downloadJson(json, 'tla_ext_current.json');
}

function exportCombined() {
    // Merge historical and current
    let combined = {
        meta: {
            generated: new Date().toISOString(),
            source: 'tla-admin-ext'
        },
        lps: {}
    };
    
    // Add historical
    if (store.historical.lps) {
        Object.entries(store.historical.lps).forEach(([name, lp]) => {
            combined.lps[name] = JSON.parse(JSON.stringify(lp));
        });
    }
    
    // Merge current (overwrite epoch data, append raw)
    if (store.current.lps) {
        Object.entries(store.current.lps).forEach(([name, lp]) => {
            if (!combined.lps[name]) {
                combined.lps[name] = JSON.parse(JSON.stringify(lp));
            } else {
                ['liquidity', 'volume'].forEach(type => {
                    // Merge epochs
                    Object.assign(combined.lps[name][type].epochs, lp[type].epochs);
                    // Dedupe and merge raw
                    let existing = new Set(combined.lps[name][type].raw.map(p => p.ts));
                    let newRaw = lp[type].raw.filter(p => !existing.has(p.ts));
                    combined.lps[name][type].raw.push(...newRaw);
                });
            }
        });
    }
    
    // Calculate epoch coverage
    let allEpochs = new Set();
    Object.values(combined.lps).forEach(lp => {
        Object.keys(lp.liquidity?.epochs || {}).forEach(ep => allEpochs.add(parseInt(ep)));
        Object.keys(lp.volume?.epochs || {}).forEach(ep => allEpochs.add(parseInt(ep)));
    });
    
    if (allEpochs.size > 0) {
        combined.meta.epoch_start = Math.min(...allEpochs);
        combined.meta.epoch_end = Math.max(...allEpochs);
    }
    
    let json = JSON.stringify(combined, null, 2);
    downloadJson(json, 'tla_ext_combined.json');
}

function downloadJson(json, filename) {
    let blob = new Blob([json], { type: 'application/json' });
    let url = URL.createObjectURL(blob);
    let a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
    URL.revokeObjectURL(url);
}

function parseWW() {
    let txt = $('wwPaste').value;
    let lines = txt.split('\n').map(l => l.trim()).filter(l => l);
    
    store.ww = [];
    let i = 0;
    
    while (i < lines.length) {
        let line = lines[i];
        
        if ((line.includes('-') || line.includes('/')) && line.match(/[A-Z]{2,}/)) {
            let pool = line.replace(' LP', '').trim();
            let volume = 0;
            let fees = 0;
            let apr = '-';
            
            for (let k = 1; k <= 8 && i + k < lines.length; k++) {
                let next = lines[i + k];
                
                if (next.includes('$') && volume === 0) {
                    volume = clean(next);
                } else if (next.includes('$') && fees === 0) {
                    fees = clean(next);
                }
                if (next.includes('%')) {
                    apr = next;
                }
                if (k > 2 && (next.includes('-') || next.includes('/')) && next.match(/[A-Z]{2,}/) && !next.includes('$')) break;
            }
            
            if (pool && (volume > 0 || fees > 0)) {
                store.ww.push({ pool, volume, fees, apr });
            }
        }
        i++;
    }
    
    let html = '';
    store.ww.forEach(b => {
        html += `<div class="grid grid-cols-12 gap-1 border-b border-gray-800/50 py-1 text-gray-300 hover:bg-white/5 px-2">
            <div class="col-span-5 truncate text-white text-[10px]" title="${b.pool}">${b.pool}</div>
            <div class="col-span-2 text-right font-mono text-[9px] text-blue-300">${b.volume > 0 ? fmt$(b.volume) : '-'}</div>
            <div class="col-span-2 text-right font-mono text-[9px] text-green-300">${b.fees > 0 ? fmt$(b.fees) : '-'}</div>
            <div class="col-span-3 text-right text-[9px] text-yellow-400">${b.apr}</div>
        </div>`;
    });
    setHtml('ww-list', html || '<div class="text-center text-gray-600 italic py-4">No data parsed.</div>');
    setTxt('ww-count', store.ww.length);
    
    pasteStatus.ww = store.ww.length > 0;
    updatePasteStatus('ps-ww', pasteStatus.ww);
}

function getExportData() {
    // Aggregate votion pools from all lockups
    // Key insight: Each bucket uses 100% of lockup VP independently
    // So we sum VP amounts (not percentages) across all lockups for each pool
    
    let votionPools = {};
    let totalVp = 0;
    
    // First calculate total VP across all lockups
    store.votion.lockups.forEach(lockup => {
        totalVp += lockup.vp || 0;
    });
    
    console.log('Votion Export: Total VP from', store.votion.lockups.length, 'lockups:', totalVp.toLocaleString());
    
    // Now aggregate per-pool VP from all lockups
    // Helper to normalize pool name to match Vote page format
    // Vote page is source of truth - preserve its naming conventions
    function normalizePoolName(name) {
        // Remove LP suffix
        name = name.replace(' LP', '').trim();
        
        // Handle bridge suffix variations:
        // Votion sometimes uses "WBTCaxl" (no dot) vs "wBTC.axl" (with dot)
        // We normalize to include the dot: token.suffix
        
        // First, handle cases where suffix is attached without dot (WBTCaxl, WBTCosmo)
        // Only match if NOT preceded by a dot
        name = name.replace(/([^.])(atom|axl|osmo|wh)$/gi, (match, p1, p2) => p1 + '.' + p2.toLowerCase());
        
        // Now handle cases where suffix already has dot but wrong case (.ATOM -> .atom)
        name = name.replace(/\.(ATOM|AXL|OSMO|WH)/g, (match) => match.toLowerCase());
        
        // Handle token order - LUNA should be first for most pairs
        if (name.includes('-')) {
            let parts = name.split('-');
            
            // Only swap if LUNA itself is second (to put LUNA first)
            // Don't swap for ampLUNA, bLUNA - they stay as LUNA-ampLUNA, LUNA-bLUNA
            let secondBase = parts[1].replace(/\.(atom|axl|osmo|wh)$/i, '');
            if (secondBase === 'LUNA') {
                name = `LUNA-${parts[0]}`;
            }
        }
        
        return name;
    }
    
    store.votion.lockups.forEach(lockup => {
        let lockupVp = lockup.vp || 0;
        if (lockupVp === 0) return;
        
        console.log(`Processing ${lockup.type} ${lockup.duration}: ${lockupVp.toLocaleString()} VP`);
        
        lockup.buckets?.forEach(bucket => {
            let bucketName = (bucket.name || '').toLowerCase();
            
            bucket.pools?.forEach(pool => {
                // Normalize pool name to match Core tool format
                let poolName = normalizePoolName(pool.name);
                
                // Map to standard LP key format
                // All TLA pools are on Astroport
                let lpKey = `${poolName}|Astroport`;
                
                if (!votionPools[lpKey]) {
                    votionPools[lpKey] = {
                        current_vp: 0,
                        optimized_vp: 0,
                        current_pct: 0,
                        optimized_pct: 0,
                        bucket: bucketName,
                        lockup_contributions: []
                    };
                }
                
                // Calculate VP from this lockup's allocation
                let currentVp = lockupVp * (pool.current / 100);
                let optimizedVp = lockupVp * (pool.optimized / 100);
                
                votionPools[lpKey].current_vp += currentVp;
                votionPools[lpKey].optimized_vp += optimizedVp;
                
                // Track which lockups contribute (for debugging)
                votionPools[lpKey].lockup_contributions.push({
                    type: lockup.type,
                    duration: lockup.duration,
                    lockup_vp: lockupVp,
                    current_pct: pool.current,
                    optimized_pct: pool.optimized,
                    current_vp: currentVp,
                    optimized_vp: optimizedVp
                });
            });
        });
    });
    
    // Calculate percentages - since each bucket uses 100% of total VP,
    // the % within bucket equals % of total Votion VP
    Object.keys(votionPools).forEach(key => {
        if (totalVp > 0) {
            // This gives us the weighted average % within the bucket
            votionPools[key].current_pct = (votionPools[key].current_vp / totalVp) * 100;
            votionPools[key].optimized_pct = (votionPools[key].optimized_vp / totalVp) * 100;
        }
        // Round VP for cleaner output
        votionPools[key].current_vp = Math.round(votionPools[key].current_vp);
        votionPools[key].optimized_vp = Math.round(votionPools[key].optimized_vp);
    });
    
    console.log('Votion Export: Aggregated', Object.keys(votionPools).length, 'pools');
    
    // Aggregate PD bribes for current epoch - PER POOL
    let pdBribesForEpoch = {};
    let currentEpoch = store.meta.ep;
    
    store.pdBribesHistory.forEach(prop => {
        if (currentEpoch >= prop.start_epoch && currentEpoch <= prop.end_epoch) {
            prop.bribes?.forEach(bribe => {
                // Use pool name, not gauge (bucket)
                let lpKey = `${bribe.pool}|Astroport`;
                if (!pdBribesForEpoch[lpKey]) {
                    pdBribesForEpoch[lpKey] = { usd: 0, pct: 0, bucket: bribe.gauge };
                }
                pdBribesForEpoch[lpKey].usd += bribe.usd_per_epoch || 0;
                pdBribesForEpoch[lpKey].pct += bribe.percent || 0;
            });
        }
    });
    
    return {
        meta: {
            generated_at: new Date().toISOString(),
            epoch: store.meta.ep,
            phase: store.meta.ph,
            source: 'tla-admin-ext'
        },
        votion: {
            ratios: { arbLUNA: store.votion.ratioArb, ampLUNA: store.votion.ratioAmp },
            total_vp: Math.round(totalVp),
            pools: votionPools,
            lockups: store.votion.lockups // Keep raw lockups for reference
        },
        // Comprehensive LST ratios for dashboard snapshot
        lst_ratios: {
            snapshot_date: new Date().toISOString(),
            chain_staking_apr: store.lstRatios.chainStakingApr,
            chain_staking_apr_date: store.lstRatios.chainStakingAprDate,
            tokens: {
                ampLUNA: { ratio: store.lstRatios.ampLUNA.ratio, base: 'LUNA', apy: store.lstRatios.ampLUNA.apy },
                arbLUNA: { ratio: store.lstRatios.arbLUNA.ratio, base: 'LUNA', apy: store.lstRatios.arbLUNA.apy },
                bLUNA: { ratio: store.lstRatios.bLUNA.ratio, base: 'LUNA', apy: store.lstRatios.bLUNA.apy },
                ampCAPA: { ratio: store.lstRatios.ampCAPA.ratio, base: 'CAPA', apy: store.lstRatios.ampCAPA.apy },
                ampROAR: { ratio: store.lstRatios.ampROAR.ratio, base: 'ROAR', apy: store.lstRatios.ampROAR.apy },
                xASTRO: { ratio: store.lstRatios.xASTRO.ratio, base: 'ASTRO', apy: store.lstRatios.xASTRO.apy }
            }
        },
        pd_bribes: pdBribesForEpoch, // Simplified bribes for this epoch
        pd_bribes_master: store.pdBribesHistory, // Full bribe history
        astroport_data: store.astro,
        skeleton_swap_data: store.ww
    };
}

function clearAll() {
    if(confirm("Reset all Extension data?")) location.reload();
}

// ============================================
// PRICE MANAGER
// ============================================

const defaultBannerTokens = [
    { symbol: 'LUNA', geckoId: 'terra-luna-2', priority: 1 },
    { symbol: 'ampLUNA', geckoId: 'eris-amplified-luna', priority: 2 },
    { symbol: 'arbLUNA', geckoId: 'eris-arbitrage-luna', priority: 3 },
    { symbol: 'bLUNA', geckoId: 'backbone-labs-staked-luna', priority: 4 },
    { symbol: 'ROAR', geckoId: 'lion-dao', priority: 5 },
    { symbol: 'CAPA', geckoId: 'capapult', priority: 6 },
    { symbol: 'SOLID', geckoId: 'solid-2', priority: 7 },
    { symbol: 'xASTRO', geckoId: 'astroport-fi', priority: 8 },
    { symbol: 'wBTC', geckoId: 'eureka-bridged-wbtc-terra', priority: 9 },
    { symbol: 'ATOM', geckoId: 'cosmos', priority: 10 },
    { symbol: 'ETH', geckoId: 'ethereum', priority: 11 },
    { symbol: 'USDC', geckoId: 'usd-coin', priority: 12 }
];

let priceStore = {
    bannerTokens: [...defaultBannerTokens],
    prices: {},
    lstRatios: {},
    manualPrices: {},
    lastFetch: null,
    selectedTokens: {}
};
defaultBannerTokens.forEach(t => priceStore.selectedTokens[t.symbol] = true);

async function fetchAllPrices() {
    const statusEl = $('prices-fetch-status');
    if (!statusEl) return;
    statusEl.className = 'px-3 py-1 rounded text-[10px] font-bold bg-yellow-900/30 text-yellow-400';
    statusEl.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Fetching...';
    
    try {
        await fetchCoinGeckoPrices();
        await fetchLstRatiosFromChainForPrices();
        calculateDerivedPrices();
        renderBannerTokens();
        updateLstRatiosSummary();
        updatePriceSnapshotPreview();
        
        priceStore.lastFetch = new Date().toISOString();
        setTxt('price-status-time', new Date().toLocaleTimeString());
        
        statusEl.className = 'px-3 py-1 rounded text-[10px] font-bold bg-green-900/30 text-green-400';
        statusEl.innerHTML = '<i class="fas fa-check mr-1"></i> Fetched';
    } catch (error) {
        console.error('Price fetch error:', error);
        statusEl.className = 'px-3 py-1 rounded text-[10px] font-bold bg-red-900/30 text-red-400';
        statusEl.innerHTML = 'Error';
    }
}

async function fetchCoinGeckoPrices() {
    const geckoIds = priceStore.bannerTokens.map(t => t.geckoId).filter(Boolean).join(',');
    const url = `https://api.coingecko.com/api/v3/simple/price?ids=${geckoIds}&vs_currencies=usd`;
    setTxt('price-status-coingecko', '⏳');
    
    try {
        const response = await fetch(url);
        if (!response.ok) throw new Error('CoinGecko API failed');
        const data = await response.json();
        
        priceStore.bannerTokens.forEach(token => {
            if (token.geckoId && data[token.geckoId]?.usd) {
                priceStore.prices[token.symbol] = data[token.geckoId].usd;
            }
        });
        setTxt('price-status-coingecko', '✅');
    } catch (error) {
        setTxt('price-status-coingecko', '❌');
        console.error('CoinGecko error:', error);
    }
}

async function fetchLstRatiosFromChainForPrices() {
    setTxt('price-status-lst', '⏳');
    try {
        const ampLunaQuery = btoa(JSON.stringify({ exchange_rates: {} }));
        const ampLunaUrl = `https://terra.publicnode.com/cosmwasm/wasm/v1/contract/terra10788fkzah89xrdm27zkj5yvhj9x3494lxawzm5qq3vvxcqz2yzaqyd3enk/smart/${ampLunaQuery}`;
        
        const ampLunaRes = await fetch(ampLunaUrl);
        if (ampLunaRes.ok) {
            const ampLunaData = await ampLunaRes.json();
            const rate = parseFloat(ampLunaData?.data?.exchange_rates?.[0]?.[1] || 0);
            if (rate > 0) {
                priceStore.lstRatios.ampLUNA = rate;
                setTxt('lst-sum-ampLUNA', rate.toFixed(4));
                const lstInput = $('lst-ratio-ampLUNA');
                if (lstInput) lstInput.value = rate.toFixed(4);
            }
        }
        
        priceStore.lstRatios.arbLUNA = store.lstRatios?.arbLUNA?.ratio || 2.6873;
        priceStore.lstRatios.bLUNA = store.lstRatios?.bLUNA?.ratio || 1.6048;
        priceStore.lstRatios.ampCAPA = store.lstRatios?.ampCAPA?.ratio || 1.1055;
        priceStore.lstRatios.ampROAR = store.lstRatios?.ampROAR?.ratio || 1.1087;
        priceStore.lstRatios.xASTRO = store.lstRatios?.xASTRO?.ratio || 1.22;
        
        setTxt('price-status-lst', '✅');
    } catch (error) {
        setTxt('price-status-lst', '⚠️');
    }
}

function calculateDerivedPrices() {
    if (priceStore.prices.CAPA && priceStore.lstRatios.ampCAPA) {
        priceStore.manualPrices.ampCAPA = priceStore.prices.CAPA * priceStore.lstRatios.ampCAPA;
        const el = $('manual-price-ampCAPA');
        if (el) el.value = priceStore.manualPrices.ampCAPA.toFixed(6);
        setTxt('manual-status-ampCAPA', '✅ Calculated');
    }
    if (priceStore.prices.ROAR && priceStore.lstRatios.ampROAR) {
        priceStore.manualPrices.ampROAR = priceStore.prices.ROAR * priceStore.lstRatios.ampROAR;
        const el = $('manual-price-ampROAR');
        if (el) el.value = priceStore.manualPrices.ampROAR.toFixed(6);
        setTxt('manual-status-ampROAR', '✅ Calculated');
    }
}

function calcDerivedPrice(ampToken, baseToken) {
    const basePrice = priceStore.prices[baseToken];
    const ratio = priceStore.lstRatios[ampToken];
    if (!basePrice || !ratio) { alert(`Need ${baseToken} price and ${ampToken} ratio. Fetch prices first.`); return; }
    priceStore.manualPrices[ampToken] = basePrice * ratio;
    $(`manual-price-${ampToken}`).value = priceStore.manualPrices[ampToken].toFixed(6);
    setTxt(`manual-status-${ampToken}`, '✅ Calculated');
    updatePriceSnapshotPreview();
}

function renderBannerTokens() {
    const container = $('banner-tokens-list');
    if (!container) return;
    let html = '';
    priceStore.bannerTokens.forEach(token => {
        const price = priceStore.prices[token.symbol];
        const checked = priceStore.selectedTokens[token.symbol] ? 'checked' : '';
        const priceDisplay = price ? `$${price < 0.01 ? price.toFixed(6) : price.toFixed(4)}` : '--';
        const statusClass = price ? 'text-green-400' : 'text-gray-600';
        html += `<div class="grid grid-cols-12 gap-2 items-center bg-[#0D0D0D] rounded p-2 text-[10px]">
            <input type="checkbox" ${checked} class="col-span-1" onchange="toggleTokenSelection('${token.symbol}', this.checked)">
            <span class="col-span-3 text-white font-medium">${token.symbol}</span>
            <span class="col-span-4 text-gray-500 truncate text-[9px]">${token.geckoId || '-'}</span>
            <span class="col-span-3 text-right font-mono ${statusClass}">${priceDisplay}</span>
            <span class="col-span-1 text-center">${price ? '🟢' : '⚪'}</span>
        </div>`;
    });
    container.innerHTML = html || '<div class="text-gray-600 text-[10px] italic">No tokens</div>';
}

function toggleTokenSelection(symbol, selected) { priceStore.selectedTokens[symbol] = selected; updatePriceSnapshotPreview(); }

function updateLstRatiosSummary() {
    Object.keys(priceStore.lstRatios).forEach(symbol => {
        const el = $(`lst-sum-${symbol}`);
        if (el && priceStore.lstRatios[symbol]) el.innerText = priceStore.lstRatios[symbol].toFixed(4);
    });
}

function updatePriceSnapshotPreview() {
    const snapshot = { prices: {}, lst_ratios: priceStore.lstRatios, timestamp: new Date().toISOString() };
    priceStore.bannerTokens.forEach(token => {
        if (priceStore.selectedTokens[token.symbol] && priceStore.prices[token.symbol]) {
            snapshot.prices[token.symbol] = priceStore.prices[token.symbol];
        }
    });
    Object.keys(priceStore.manualPrices).forEach(symbol => {
        if (priceStore.manualPrices[symbol]) snapshot.prices[symbol] = priceStore.manualPrices[symbol];
    });
    setTxt('price-snapshot-count', Object.keys(snapshot.prices).length + ' tokens');
    setTxt('price-snapshot-preview', JSON.stringify(snapshot, null, 2));
}

function copyPriceSnapshot() {
    navigator.clipboard.writeText($('price-snapshot-preview').innerText);
    alert('Copied!');
}

function addManualToken() {
    const symbol = prompt('Enter token symbol:');
    if (!symbol) return;
    const container = $('additional-manual-tokens');
    container.insertAdjacentHTML('beforeend', `<div class="grid grid-cols-12 gap-2 items-center bg-[#0D0D0D] rounded p-2" id="manual-row-${symbol}">
        <input type="text" class="col-span-3 input-dark text-[10px]" value="${symbol}" readonly>
        <div class="col-span-3 text-[9px] text-gray-500">Manual</div>
        <input type="number" id="manual-price-${symbol}" step="0.0001" class="col-span-3 input-dark text-[10px] text-right" placeholder="USD" onchange="updateManualPrice('${symbol}', this.value)">
        <span id="manual-status-${symbol}" class="col-span-2 text-[9px] text-gray-600">❌</span>
        <button onclick="$('manual-row-${symbol}').remove();delete priceStore.manualPrices['${symbol}'];updatePriceSnapshotPreview()" class="col-span-1 text-red-400"><i class="fas fa-trash"></i></button>
    </div>`);
}

function updateManualPrice(symbol, value) {
    const price = parseFloat(value);
    if (price > 0) { priceStore.manualPrices[symbol] = price; setTxt(`manual-status-${symbol}`, '✅'); }
    else { delete priceStore.manualPrices[symbol]; setTxt(`manual-status-${symbol}`, '❌'); }
    updatePriceSnapshotPreview();
}

// ============================================
// DASHBOARD STATS
// ============================================

let dashboardStore = { 
    tiles: {}, 
    tlaTokens: {},      // Parsed token amounts
    tlaUsd: null,       // TLA reported USD
    tlaApr: null,       // TLA reported APR
    calcUsd: null,      // Our calculated USD
    useCalcUsd: false,  // Which USD to use
    depositRewards: null,
    voteRewards: [],
    rebase: null
};

async function fetchDashboardData() {
    const statusEl = $('dashboard-status');
    if (!statusEl) return;
    statusEl.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Fetching...';
    
    let tilesComplete = 0;
    
    try {
        // Tile 1: NFT stats from deving.zone - fetch BOTH stats and meta for NFT tab too
        const [statsRes, metaRes, listingsRes] = await Promise.all([
            fetch('https://deving.zone/api/nft/stats/terra1tpl03d6mvh2emu7lwl3062w8h3f7e7q5xd7zcx'),
            fetch('https://deving.zone/api/nft/meta/terra1tpl03d6mvh2emu7lwl3062w8h3f7e7q5xd7zcx'),
            fetch('https://deving.zone/api/nft/listings/terra1tpl03d6mvh2emu7lwl3062w8h3f7e7q5xd7zcx')
        ]);
        
        if (statsRes.ok) {
            const stats = await statsRes.json();
            dashboardStore.tiles.nft = {
                total_minted: stats.collection_stats?.num_tokens || 0,
                unminted: 10000 - (stats.collection_stats?.num_tokens || 0),
                broken_count: stats.nfts?.filter(n => n.special_trait === 'BROKEN').length || 0
            };
            setTxt('dash-nft-minted', dashboardStore.tiles.nft.total_minted.toLocaleString());
            setTxt('dash-nft-unminted', dashboardStore.tiles.nft.unminted.toLocaleString());
            setTxt('dash-nft-broken', dashboardStore.tiles.nft.broken_count.toLocaleString());
            setTileStatus('nft', true);
            tilesComplete++;
        }
        
        // Store NFT meta data for NFT Stats tab
        if (metaRes.ok) {
            const metaData = await metaRes.json();
            nftStore.bbl.collection = metaData;
            // Pre-fill the NFT tab JSON field
            const jsonField = $('nft-bbl-collection-json');
            if (jsonField) jsonField.value = JSON.stringify(metaData);
            console.log('✅ NFT metadata pre-loaded for NFT Stats tab');
        }
        
        // Store NFT listings for NFT Stats tab
        if (listingsRes.ok) {
            const listingsData = await listingsRes.json();
            if (listingsData.nfts) {
                nftStore.bbl.listings = listingsData.nfts;
                // Pre-fill listings field
                const listingsField = $('nft-bbl-listings-json');
                if (listingsField) listingsField.value = JSON.stringify(listingsData);
                console.log('✅ NFT listings pre-loaded for NFT Stats tab:', listingsData.nfts.length, 'listings');
            }
        }
        
        // Tile 11: Epoch info (from store)
        if (store.liveEpoch) {
            setTxt('dash-epoch-current', store.liveEpoch.epoch);
            setTxt('dash-epoch-phase', store.liveEpoch.phase);
            setTxt('dash-epoch-days', store.liveEpoch.daysRemaining + 'd');
            setTileStatus('epoch', true);
            tilesComplete++;
        }
        
        // Tile 12: Prices (from store)
        const priceCount = Object.keys(store.tokenPrices).length;
        if (priceCount > 0) {
            const lunaPrice = store.tokenPrices.LUNA?.price;
            const ampPrice = store.tokenPrices.AMPLUNA?.price;
            setTxt('dash-price-luna', lunaPrice ? '$' + lunaPrice.toFixed(4) : '--');
            setTxt('dash-price-ampluna', ampPrice ? '$' + ampPrice.toFixed(4) : '--');
            setTxt('dash-price-count', priceCount);
            setTileStatus('prices', true);
            tilesComplete++;
        }
        
        // Tile 2: Backing per NFT (calculated from treasury / minted)
        // This needs treasury data which we'll add later
        
        updateDashboardStatus(tilesComplete);
        updateDashboardSnapshotPreview();
        updateDashboardConfirmSection();
    } catch (e) {
        console.error('Dashboard fetch error:', e);
        statusEl.innerHTML = '❌ Error';
    }
}

function setTileStatus(tile, complete) {
    const el = $(`tile-${tile}`);
    const statusEl = $(`tile-${tile}-status`);
    if (el) {
        el.classList.remove('border-gray-700', 'border-green-700');
        el.classList.add(complete ? 'border-green-700' : 'border-gray-700');
    }
    if (statusEl) {
        statusEl.textContent = complete ? '✓' : '--';
        statusEl.className = `text-[9px] ${complete ? 'text-green-400' : 'text-gray-600'}`;
    }
}

function updateDashboardStatus(count) {
    const statusEl = $('dashboard-status');
    if (statusEl) {
        if (count >= 10) {
            statusEl.innerHTML = `<i class="fas fa-check-circle mr-1"></i> ${count}/12 tiles`;
            statusEl.className = 'px-3 py-1 rounded text-[10px] font-bold bg-green-900/30 text-green-400 border border-green-700';
        } else if (count > 0) {
            statusEl.innerHTML = `${count}/12 tiles`;
            statusEl.className = 'px-3 py-1 rounded text-[10px] font-bold bg-yellow-900/30 text-yellow-400 border border-yellow-700';
        } else {
            statusEl.innerHTML = '0/12 tiles';
            statusEl.className = 'px-3 py-1 rounded text-[10px] font-bold bg-gray-800 text-gray-400';
        }
    }
}

// Parse token amounts from paste
function parseDashTokens() {
    const txt = $('dash-tokens-paste')?.value?.trim();
    if (!txt) return;
    
    dashboardStore.tlaTokens = {};
    let calcTotal = 0;
    let html = '';
    
    // Parse tab-separated format: "TOKEN\tAMOUNT"
    txt.split('\n').forEach(line => {
        const parts = line.split(/\t+/);
        if (parts.length >= 2) {
            const token = parts[0].trim().toUpperCase();
            const amount = parseFloat(parts[1].trim());
            if (token && !isNaN(amount) && amount > 0) {
                dashboardStore.tlaTokens[token] = amount;
                
                // Calculate USD value using our prices
                const priceData = store.tokenPrices[token];
                const price = priceData?.price || 0;
                const usdValue = amount * price;
                calcTotal += usdValue;
                
                html += `<div class="flex justify-between">
                    <span class="text-gray-400">${token}:</span>
                    <span class="text-white font-mono">${formatNum(amount)}</span>
                    <span class="text-${price ? 'green' : 'red'}-400 font-mono">${price ? '$' + formatNum(usdValue) : '?'}</span>
                </div>`;
            }
        }
    });
    
    dashboardStore.calcUsd = calcTotal;
    
    // Update UI
    $('dash-token-breakdown').innerHTML = html || '<div class="text-gray-600">No tokens parsed</div>';
    setTxt('dash-compare-calc', '$' + formatNum(calcTotal));
    setTxt('dash-tla-usd-calc', '$' + formatNum(calcTotal));
    
    // Update tile
    const tokenList = Object.entries(dashboardStore.tlaTokens).map(([t, a]) => 
        `<div class="flex justify-between"><span class="text-gray-400">${t}:</span><span class="text-white font-mono">${formatNum(a)}</span></div>`
    ).join('');
    $('dash-tla-token-list').innerHTML = tokenList || '<div class="text-gray-600">No tokens</div>';
    setTileStatus('tla-tokens', Object.keys(dashboardStore.tlaTokens).length > 0);
    
    // Enable comparison buttons
    updateComparisonButtons();
    updateDashboardSnapshotPreview();
    countDashboardTiles();
}

// Parse USD amount and APR
function parseDashUsd() {
    const txt = $('dash-usd-paste')?.value?.trim();
    if (!txt) return;
    
    // Match patterns like "__7 980.05__$" or "7,980.05$" or "7980.05 $"
    let usdMatch = txt.match(/__?([\d\s,\.]+)__?\s*\$/);
    if (!usdMatch) usdMatch = txt.match(/([\d\s,\.]+)\s*\$/);
    
    if (usdMatch) {
        dashboardStore.tlaUsd = parseFloat(usdMatch[1].replace(/[\s,]/g, ''));
        setTxt('dash-compare-tla', '$' + formatNum(dashboardStore.tlaUsd));
        setTxt('dash-tla-usd-tla', '$' + formatNum(dashboardStore.tlaUsd));
    }
    
    // Match APR: "est. APR 36.35 %" or "APR 36.35%"
    const aprMatch = txt.match(/APR\s*([\d\.]+)\s*%/i);
    if (aprMatch) {
        dashboardStore.tlaApr = parseFloat(aprMatch[1]);
        setTxt('dash-tla-apr', dashboardStore.tlaApr.toFixed(2) + '%');
    }
    
    // Calculate difference
    if (dashboardStore.tlaUsd && dashboardStore.calcUsd) {
        const diff = dashboardStore.calcUsd - dashboardStore.tlaUsd;
        const pct = (diff / dashboardStore.tlaUsd * 100).toFixed(2);
        const color = Math.abs(diff) < 100 ? 'text-green-400' : 'text-yellow-400';
        setHtml('dash-compare-diff', `<span class="${color}">${diff >= 0 ? '+' : ''}$${formatNum(diff)} (${pct}%)</span>`);
    }
    
    setTileStatus('tla-summary', dashboardStore.tlaUsd > 0);
    updateComparisonButtons();
    updateDashboardSnapshotPreview();
    countDashboardTiles();
}

// Parse all rewards (deposit, vote, rebase)
function parseDashRewards() {
    const txt = $('dash-rewards-paste')?.value?.trim();
    if (!txt) return;
    
    let rewardsSummary = '';
    
    // Parse Deposit Rewards: "Received __224.69 ampLUNA__" or "297.32 Received 224.69 ampLUNA"
    const depositMatch = txt.match(/Received\s*__?([\d\.]+)\s*(amp\w+|LUNA|ASTRO)__?/i) ||
                        txt.match(/([\d\.]+)\s*(amp\w+)\s*Received/i);
    if (depositMatch) {
        dashboardStore.depositRewards = {
            amount: parseFloat(depositMatch[1]),
            token: depositMatch[2]
        };
        setTxt('dash-deposit-pending', depositMatch[1]);
        setTxt('dash-deposit-token', depositMatch[2]);
        setTileStatus('deposit-rewards', true);
        rewardsSummary += `<div class="flex justify-between"><span class="text-gray-400">Deposit:</span><span class="text-green-400">${depositMatch[1]} ${depositMatch[2]}</span></div>`;
    }
    
    // Parse Vote Rewards: "287.00 LUNA   892.03 ASTRO   927.29 CAPA   1.93M ROAR"
    const voteSection = txt.match(/Claim your rewards.*?(\d+[\d\.,\s]*(?:LUNA|ASTRO|CAPA|ROAR|K|M)[\s\d\.,LUNASTROCAPEAR]*)/is);
    if (voteSection) {
        dashboardStore.voteRewards = [];
        const voteStr = voteSection[1];
        // Parse each token: "287.00 LUNA" or "1.93M ROAR"
        const tokenMatches = voteStr.matchAll(/([\d\.]+)\s*(K|M)?\s*(LUNA|ASTRO|CAPA|ROAR)/gi);
        let voteHtml = '';
        for (const m of tokenMatches) {
            let amount = parseFloat(m[1]);
            if (m[2] === 'K') amount *= 1000;
            if (m[2] === 'M') amount *= 1000000;
            dashboardStore.voteRewards.push({ token: m[3], amount });
            voteHtml += `<div class="flex justify-between"><span class="text-gray-400">${m[3]}:</span><span class="text-cyan-400 font-mono">${formatNum(amount)}</span></div>`;
            rewardsSummary += `<div class="flex justify-between"><span class="text-gray-400">Vote ${m[3]}:</span><span class="text-cyan-400">${formatNum(amount)}</span></div>`;
        }
        $('dash-vote-rewards-list').innerHTML = voteHtml || '<div class="text-gray-600">No rewards</div>';
        setTileStatus('vote-rewards', dashboardStore.voteRewards.length > 0);
    }
    
    // Parse Rebase: "Rebase 457.68 ampLUNA" or "Rebase\n457.68 ampLUNA"
    const rebaseMatch = txt.match(/Rebase\s*([\d\.]+)\s*(ampLUNA)/i);
    if (rebaseMatch) {
        const amount = parseFloat(rebaseMatch[1]);
        dashboardStore.rebase = { amount, token: rebaseMatch[2] };
        setTxt('dash-rebase-amount', amount.toFixed(2) + ' ' + rebaseMatch[2]);
        
        // Calculate USD value
        const price = store.tokenPrices.AMPLUNA?.price || 0;
        if (price) {
            setTxt('dash-rebase-usd', '$' + formatNum(amount * price));
        }
        setTileStatus('rebase', true);
        rewardsSummary += `<div class="flex justify-between"><span class="text-gray-400">Rebase:</span><span class="text-purple-400">${amount.toFixed(2)} ${rebaseMatch[2]}</span></div>`;
    }
    
    $('dash-rewards-summary').innerHTML = rewardsSummary || '<div class="text-gray-600">No rewards parsed</div>';
    updateDashboardSnapshotPreview();
    countDashboardTiles();
}

function updateComparisonButtons() {
    const tlaBtn = $('btn-use-tla');
    const calcBtn = $('btn-use-calc');
    
    if (dashboardStore.tlaUsd > 0) {
        tlaBtn.disabled = false;
        tlaBtn.className = dashboardStore.useCalcUsd ? 
            'text-[9px] px-2 py-1 rounded bg-gray-800 text-gray-400 border border-gray-700 cursor-pointer' :
            'text-[9px] px-2 py-1 rounded bg-yellow-900/50 text-yellow-400 border border-yellow-700 cursor-pointer';
    }
    
    if (dashboardStore.calcUsd > 0) {
        calcBtn.disabled = false;
        calcBtn.className = dashboardStore.useCalcUsd ? 
            'text-[9px] px-2 py-1 rounded bg-cyan-900/50 text-cyan-400 border border-cyan-700 cursor-pointer' :
            'text-[9px] px-2 py-1 rounded bg-gray-800 text-gray-400 border border-gray-700 cursor-pointer';
    }
}

function useTlaUsd() {
    dashboardStore.useCalcUsd = false;
    updateComparisonButtons();
    updateDashboardSnapshotPreview();
}

function useCalcUsd() {
    dashboardStore.useCalcUsd = true;
    updateComparisonButtons();
    updateDashboardSnapshotPreview();
}

function countDashboardTiles() {
    let count = 0;
    // Count completed tiles
    if (dashboardStore.tiles.nft?.total_minted > 0) count++;
    if (store.liveEpoch) count++;
    if (Object.keys(store.tokenPrices).length > 0) count++;
    if (Object.keys(dashboardStore.tlaTokens).length > 0) count++;
    if (dashboardStore.tlaUsd > 0) count++;
    if (dashboardStore.depositRewards) count++;
    if (dashboardStore.voteRewards?.length > 0) count++;
    if (dashboardStore.rebase) count++;
    // Backing, Treasury, DAODAO, VP are manual/calculated
    
    updateDashboardStatus(count);
    updateDashboardConfirmSection();
}

function formatNum(n) {
    if (n >= 1000000) return (n/1000000).toFixed(2) + 'M';
    if (n >= 1000) return n.toLocaleString(undefined, {maximumFractionDigits: 2});
    return n.toFixed(2);
}

function updateDashboardConfirmSection() {
    const confirmSection = $('dashboard-confirm-section');
    if (!confirmSection) return;
    
    // Check if we have minimum required data
    const hasNft = dashboardStore.tiles.nft?.total_minted > 0;
    const hasTla = Object.keys(dashboardStore.tlaTokens).length > 0 || dashboardStore.tlaUsd > 0;
    
    if (hasNft || hasTla || store.dashboardVerified) {
        confirmSection.classList.remove('hidden');
        
        if (store.dashboardVerified) {
            confirmSection.innerHTML = `
                <div class="text-green-400 text-[10px] text-center py-2">
                    <i class="fas fa-check-circle mr-1"></i> Dashboard Complete!
                </div>
            `;
        } else {
            confirmSection.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <span class="text-yellow-400 text-lg">⚠️</span>
                        <span class="text-yellow-300 text-[11px]">Review data and confirm when ready</span>
                    </div>
                    <button onclick="confirmDashboardComplete()" class="bg-green-700 hover:bg-green-600 text-white px-3 py-1 rounded text-[10px] font-bold">
                        Confirm & Complete Dashboard
                    </button>
                </div>
            `;
        }
    } else {
        confirmSection.classList.add('hidden');
    }
}

function confirmDashboardComplete() {
    store.dashboardVerified = true;
    $('dashboard-status').innerHTML = '✅ Complete';
    $('dashboard-status').className = 'px-3 py-1 rounded text-[10px] font-bold bg-green-900/30 text-green-400 border border-green-700';
    updateDashboardConfirmSection();
    updateWorkflowStatus();
}

function updateDashboardSnapshotPreview() {
    const selectedUsd = dashboardStore.useCalcUsd ? dashboardStore.calcUsd : dashboardStore.tlaUsd;
    
    const snapshot = {
        timestamp: new Date().toISOString(),
        epoch: store.meta?.ep,
        phase: store.meta?.ph,
        tiles: {
            nft: dashboardStore.tiles.nft || null,
            tla_deposits: {
                usd_tla: dashboardStore.tlaUsd,
                usd_calculated: dashboardStore.calcUsd,
                usd_used: selectedUsd,
                apr: dashboardStore.tlaApr,
                tokens: dashboardStore.tlaTokens
            },
            deposit_rewards: dashboardStore.depositRewards,
            vote_rewards: dashboardStore.voteRewards,
            rebase: dashboardStore.rebase,
            prices_snapshot: Object.fromEntries(
                Object.entries(store.tokenPrices).map(([k, v]) => [k, v.price])
            )
        }
    };
    
    setTxt('dashboard-snapshot-preview', JSON.stringify(snapshot, null, 2));
}

function downloadDashboardSnapshot() {
    const epoch = store.meta?.ep || 'unknown';
    const blob = new Blob([$('dashboard-snapshot-preview').innerText], { type: 'application/json' });
    const a = document.createElement('a'); 
    a.href = URL.createObjectURL(blob); 
    a.download = `dashboard-snapshot_${epoch}_${store.meta?.ph || 'end'}.json`; 
    a.click();
}

// ============================================
// NFT STATS
// ============================================

let nftStore = { bbl: { collection: null, listings: [], epochSales: [] }, boost: { epochSales: [] }, prices: {} };

function loadNftPricesFromPriceManager() {
    // Use prices from main store instead of priceStore
    $('nft-price-luna').value = store.tokenPrices?.LUNA?.price || '';
    $('nft-price-ampluna').value = store.tokenPrices?.AMPLUNA?.price || '';
    $('nft-price-bluna').value = store.tokenPrices?.BLUNA?.price || '';
    $('nft-price-arbluna').value = store.tokenPrices?.ARBLUNA?.price || '';
    $('nft-price-solid').value = store.tokenPrices?.SOLID?.price || '';
    updateNftFloorUsd();
}

function getNftPrices() {
    return { luna: parseFloat($('nft-price-luna')?.value) || 0, ampluna: parseFloat($('nft-price-ampluna')?.value) || 0, bluna: parseFloat($('nft-price-bluna')?.value) || 0, arbluna: parseFloat($('nft-price-arbluna')?.value) || 0, solid: parseFloat($('nft-price-solid')?.value) || 0, usdc: 1 };
}

function nftToUsd(amount, token) { const p = getNftPrices(); return amount * (p[token.toLowerCase()] || 0); }

function updateNftFloorUsd() {
    const p = getNftPrices();
    const ub = parseFloat($('nft-floor-unbroken-amount')?.value) || 0;
    const br = parseFloat($('nft-floor-broken-amount')?.value) || 0;
    setTxt('nft-floor-unbroken-usd', ub > 0 ? '$' + (ub * p.bluna).toFixed(2) : '--');
    setTxt('nft-floor-broken-usd', br > 0 ? '$' + (br * p.bluna).toFixed(2) : '--');
    updateNftSnapshotPreview();
}

async function fetchNftData() {
    const statusEl = $('nft-status');
    if (!statusEl) return;
    
    // Check if data already loaded from Dashboard tab
    if (nftStore.bbl.collection) {
        statusEl.innerHTML = '✅ Pre-loaded';
        parseNftBblCollection();
        if (nftStore.bbl.listings.length > 0) {
            parseNftBblListings();
        }
        return;
    }
    
    statusEl.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Fetching...';
    try {
        // Fetch both meta and listings
        const [metaRes, listingsRes] = await Promise.all([
            fetch('https://deving.zone/api/nft/meta/terra1tpl03d6mvh2emu7lwl3062w8h3f7e7q5xd7zcx'),
            fetch('https://deving.zone/api/nft/listings/terra1tpl03d6mvh2emu7lwl3062w8h3f7e7q5xd7zcx')
        ]);
        
        if (metaRes.ok) {
            const data = await metaRes.json();
            nftStore.bbl.collection = data;
            $('nft-bbl-collection-json').value = JSON.stringify(data);
            parseNftBblCollection();
        }
        
        if (listingsRes.ok) {
            const data = await listingsRes.json();
            if (data.nfts) {
                nftStore.bbl.listings = data.nfts;
                $('nft-bbl-listings-json').value = JSON.stringify(data);
                parseNftBblListings();
            }
        }
        
        statusEl.innerHTML = '✅ Fetched';
    } catch (e) { 
        console.error('NFT fetch error:', e);
        statusEl.innerHTML = '❌ Error'; 
    }
}

function parseNftBblCollection() {
    const json = $('nft-bbl-collection-json')?.value?.trim();
    if (!json) return;
    try {
        const data = JSON.parse(json);
        nftStore.bbl.collection = data;
        const p = getNftPrices();
        const volumeUSD = data.volume && p.bluna ? (data.volume * p.bluna).toFixed(2) : '?';
        setTxt('nft-bbl-volume', `${data.volume?.toLocaleString() || '?'} bLUNA ($${volumeUSD})`);
        setTxt('nft-bbl-recent', `#${data.last_sale_token_id || '?'} for ${data.last_sale_amount || '?'} bLUNA`);
        $('nft-bbl-collection-results')?.classList.remove('hidden');
        setTxt('nft-bbl-collection-status', '✅');
    } catch (e) { setTxt('nft-bbl-collection-status', '❌ ' + e.message); }
}

function parseNftBblListings() {
    const json = $('nft-bbl-listings-json')?.value?.trim();
    if (!json) return;
    try {
        const data = JSON.parse(json);
        if (data.nfts) {
            nftStore.bbl.listings = data.nfts;
            let floorBroken = null, floorUnbroken = null, floorBrokenId = null, floorUnbrokenId = null;
            data.nfts.forEach(nft => {
                const price = nft.auction?.reserve_price ? nft.auction.reserve_price / 1e6 : null;
                const isBroken = nft.special_trait === 'BROKEN';
                if (price) {
                    if (isBroken && (floorBroken === null || price < floorBroken)) { floorBroken = price; floorBrokenId = nft.nft_token_id; }
                    if (!isBroken && (floorUnbroken === null || price < floorUnbroken)) { floorUnbroken = price; floorUnbrokenId = nft.nft_token_id; }
                }
            });
            if (floorUnbroken !== null) { $('nft-floor-unbroken-id').value = floorUnbrokenId; $('nft-floor-unbroken-amount').value = floorUnbroken; }
            if (floorBroken !== null) { $('nft-floor-broken-id').value = floorBrokenId; $('nft-floor-broken-amount').value = floorBroken; }
            updateNftFloorUsd();
            setTxt('nft-bbl-listings-status', `✅ ${data.nfts.length} listings`);
        }
    } catch (e) { setTxt('nft-bbl-listings-status', '❌ ' + e.message); }
}

function addNftBblSale() {
    const id = $('nft-bbl-sale-id')?.value?.trim(), amount = parseFloat($('nft-bbl-sale-amount')?.value) || 0, token = $('nft-bbl-sale-token')?.value;
    if (!id || !amount) return;
    nftStore.bbl.epochSales.push({ id, amount, token });
    $('nft-bbl-sale-id').value = ''; $('nft-bbl-sale-amount').value = '';
    renderNftBblSales();
}

function renderNftBblSales() {
    const list = $('nft-bbl-sales-list');
    if (!list) return;
    if (nftStore.bbl.epochSales.length === 0) { list.innerHTML = '<div class="text-gray-600 italic">No sales</div>'; return; }
    const p = getNftPrices();
    list.innerHTML = nftStore.bbl.epochSales.map((s, i) => {
        const usd = nftToUsd(s.amount, s.token);
        return `<div class="flex justify-between items-center bg-[#0D0D0D] rounded p-1">
            <span class="text-white">#${s.id}</span>
            <span class="text-orange-400">${s.amount} ${s.token}</span>
            <span class="text-green-400">$${usd.toFixed(2)}</span>
            <button onclick="nftStore.bbl.epochSales.splice(${i},1);renderNftBblSales()" class="text-red-400 text-[9px]">✕</button>
        </div>`;
    }).join('');
    updateNftSnapshotPreview();
}

function addNftBoostSale() {
    const id = $('nft-boost-sale-id')?.value?.trim(), amount = parseFloat($('nft-boost-sale-amount')?.value) || 0, token = $('nft-boost-sale-token')?.value;
    if (!id || !amount) return;
    nftStore.boost.epochSales.push({ id, amount, token });
    $('nft-boost-sale-id').value = ''; $('nft-boost-sale-amount').value = '';
    renderNftBoostSales();
}

function renderNftBoostSales() {
    const list = $('nft-boost-sales-list');
    if (!list) return;
    if (nftStore.boost.epochSales.length === 0) { list.innerHTML = '<div class="text-gray-600 italic">No sales</div>'; return; }
    list.innerHTML = nftStore.boost.epochSales.map((s, i) => {
        const usd = nftToUsd(s.amount, s.token);
        return `<div class="flex justify-between items-center bg-[#0D0D0D] rounded p-1">
            <span class="text-white">#${s.id}</span>
            <span class="text-cyan-400">${s.amount} ${s.token}</span>
            <span class="text-green-400">$${usd.toFixed(2)}</span>
            <button onclick="nftStore.boost.epochSales.splice(${i},1);renderNftBoostSales()" class="text-red-400 text-[9px]">✕</button>
        </div>`;
    }).join('');
    updateNftSnapshotPreview();
}

function updateNftSnapshotPreview() {
    const p = getNftPrices();
    const snapshot = {
        snapshot_time: new Date().toISOString(),
        epoch: store.meta?.epoch,
        prices_at_snapshot: p,
        bbl: {
            collection: nftStore.bbl.collection,
            floor_unbroken: { id: $('nft-floor-unbroken-id')?.value, bluna: parseFloat($('nft-floor-unbroken-amount')?.value) || 0 },
            floor_broken: { id: $('nft-floor-broken-id')?.value, bluna: parseFloat($('nft-floor-broken-amount')?.value) || 0 },
            epoch_sales: nftStore.bbl.epochSales.map(s => ({ ...s, usd: nftToUsd(s.amount, s.token) }))
        },
        boost: { epoch_sales: nftStore.boost.epochSales.map(s => ({ ...s, usd: nftToUsd(s.amount, s.token) })) }
    };
    setTxt('nft-snapshot-preview', JSON.stringify(snapshot, null, 2));
}

function downloadNftSnapshot() {
    const epoch = store.meta?.epoch || 'unknown';
    const blob = new Blob([$('nft-snapshot-preview').innerText], { type: 'application/json' });
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `nft-snapshot_${epoch}_end.json`; a.click();
}

// ============================================
// NEWS
// ============================================

let newsStore = { articles: [] };

function addNewsArticle() {
    const title = $('news-title')?.value?.trim();
    const url = $('news-url')?.value?.trim();
    if (!title || !url) { alert('Title and URL required'); return; }
    
    const article = {
        id: 'news-' + Date.now(),
        title,
        url,
        date: $('news-date')?.value || new Date().toISOString().split('T')[0],
        tags: ($('news-tags')?.value || '').split(',').map(t => t.trim()).filter(Boolean),
        content: $('news-content')?.value?.trim() || '',
        images: ($('news-images')?.value || '').split('\n').map(u => u.trim()).filter(Boolean),
        added_at: new Date().toISOString()
    };
    
    newsStore.articles.unshift(article);
    renderNewsArticles();
    
    // Clear form
    $('news-title').value = ''; $('news-url').value = ''; $('news-content').value = ''; $('news-tags').value = ''; $('news-images').value = '';
}

function renderNewsArticles() {
    const list = $('news-articles-list');
    setTxt('news-count', newsStore.articles.length);
    if (newsStore.articles.length === 0) { list.innerHTML = '<div class="text-gray-600 text-[10px] italic">No articles</div>'; return; }
    
    list.innerHTML = newsStore.articles.map((a, i) => `
        <div class="bg-[#0D0D0D] rounded p-3 border border-gray-800">
            <div class="flex justify-between items-start">
                <div class="flex-1">
                    <a href="${a.url}" target="_blank" class="text-orange-400 font-bold text-sm hover:text-orange-300">${a.title}</a>
                    <div class="text-[9px] text-gray-500 mt-1">${a.date} | ${a.tags.map(t => '<span class="bg-gray-800 px-1 rounded">' + t + '</span>').join(' ')}</div>
                    ${a.content ? '<p class="text-[10px] text-gray-400 mt-2">' + a.content.substring(0, 200) + (a.content.length > 200 ? '...' : '') + '</p>' : ''}
                </div>
                <button onclick="newsStore.articles.splice(${i},1);renderNewsArticles()" class="text-red-400 hover:text-red-300 ml-2"><i class="fas fa-trash"></i></button>
            </div>
        </div>
    `).join('');
}

function clearAllNews() { if (confirm('Clear all news?')) { newsStore.articles = []; renderNewsArticles(); } }

function downloadNewsJson() {
    const blob = new Blob([JSON.stringify({ version: 1, updated: new Date().toISOString(), articles: newsStore.articles }, null, 2)], { type: 'application/json' });
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'terra-news.json'; a.click();
}

async function loadNewsFromGithub() {
    try {
        const res = await fetch('https://raw.githubusercontent.com/defipatriot/tla_json_storage/main/terra-news.json');
        if (res.ok) {
            const data = await res.json();
            newsStore.articles = data.articles || [];
            renderNewsArticles();
            alert('Loaded ' + newsStore.articles.length + ' articles');
        }
    } catch (e) { alert('Could not load news: ' + e.message); }
}

// ============================================
// DAO PROPOSALS
// ============================================

let daoStore = { proposals: [] };

function addDaoProposal() {
    const id = $('dao-prop-id')?.value?.trim();
    const title = $('dao-prop-title')?.value?.trim();
    if (!id || !title) { alert('ID and Title required'); return; }
    
    const proposal = {
        id,
        title,
        status: $('dao-prop-status')?.value || 'passed',
        date: $('dao-prop-date')?.value || new Date().toISOString().split('T')[0],
        link: $('dao-prop-link')?.value?.trim() || '',
        category: $('dao-prop-category')?.value || 'governance',
        description: $('dao-prop-description')?.value?.trim() || '',
        votes: {
            yes: parseFloat($('dao-prop-yes')?.value) || 0,
            no: parseFloat($('dao-prop-no')?.value) || 0,
            abstain: parseFloat($('dao-prop-abstain')?.value) || 0
        },
        added_at: new Date().toISOString()
    };
    
    // Check if editing existing
    const existingIdx = daoStore.proposals.findIndex(p => p.id === id);
    if (existingIdx >= 0) {
        daoStore.proposals[existingIdx] = proposal;
    } else {
        daoStore.proposals.unshift(proposal);
    }
    renderDaoProposals();
    
    // Clear form
    $('dao-prop-id').value = ''; $('dao-prop-title').value = ''; $('dao-prop-description').value = '';
    $('dao-prop-link').value = ''; $('dao-prop-yes').value = ''; $('dao-prop-no').value = ''; $('dao-prop-abstain').value = '';
}

function renderDaoProposals() {
    const list = $('dao-proposals-list');
    const filter = $('dao-filter-status')?.value || 'all';
    const filtered = filter === 'all' ? daoStore.proposals : daoStore.proposals.filter(p => p.status === filter);
    setTxt('dao-count', daoStore.proposals.length);
    
    if (filtered.length === 0) { list.innerHTML = '<div class="text-gray-600 text-[10px] italic">No proposals</div>'; return; }
    
    const statusIcons = { passed: '✅', rejected: '❌', executed: '🟢', pending: '⏳', vetoed: '🚫' };
    
    list.innerHTML = filtered.map((p, i) => `
        <div class="bg-[#0D0D0D] rounded p-3 border border-gray-800">
            <div class="flex justify-between items-start">
                <div class="flex-1">
                    <div class="flex items-center gap-2">
                        <span class="text-blue-400 font-mono font-bold">${p.id}</span>
                        <span>${statusIcons[p.status] || ''}</span>
                        <span class="text-white font-medium">${p.title}</span>
                    </div>
                    <div class="text-[9px] text-gray-500 mt-1">${p.date} | ${p.category}</div>
                    ${p.description ? '<p class="text-[10px] text-gray-400 mt-2">' + p.description.substring(0, 150) + '</p>' : ''}
                    <div class="flex gap-3 mt-2 text-[9px]">
                        <span class="text-green-400">Yes: ${p.votes.yes}%</span>
                        <span class="text-red-400">No: ${p.votes.no}%</span>
                        <span class="text-gray-400">Abstain: ${p.votes.abstain}%</span>
                    </div>
                </div>
                <div class="flex gap-1">
                    ${p.link ? `<a href="${p.link}" target="_blank" class="text-blue-400 hover:text-blue-300"><i class="fas fa-external-link-alt"></i></a>` : ''}
                    <button onclick="editDaoProposal(${i})" class="text-yellow-400 hover:text-yellow-300 ml-2"><i class="fas fa-edit"></i></button>
                    <button onclick="daoStore.proposals.splice(${i},1);renderDaoProposals()" class="text-red-400 hover:text-red-300"><i class="fas fa-trash"></i></button>
                </div>
            </div>
        </div>
    `).join('');
}

function editDaoProposal(idx) {
    const p = daoStore.proposals[idx];
    $('dao-prop-id').value = p.id;
    $('dao-prop-title').value = p.title;
    $('dao-prop-status').value = p.status;
    $('dao-prop-date').value = p.date;
    $('dao-prop-link').value = p.link;
    $('dao-prop-category').value = p.category;
    $('dao-prop-description').value = p.description;
    $('dao-prop-yes').value = p.votes.yes;
    $('dao-prop-no').value = p.votes.no;
    $('dao-prop-abstain').value = p.votes.abstain;
}

function downloadDaoJson() {
    const blob = new Blob([JSON.stringify({ version: 1, updated: new Date().toISOString(), proposals: daoStore.proposals }, null, 2)], { type: 'application/json' });
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'adao-proposals.json'; a.click();
}

async function loadProposalsFromGithub() {
    try {
        const res = await fetch('https://raw.githubusercontent.com/defipatriot/tla_json_storage/main/adao-proposals.json');
        if (res.ok) {
            const data = await res.json();
            daoStore.proposals = data.proposals || [];
            renderDaoProposals();
            alert('Loaded ' + daoStore.proposals.length + ' proposals');
        }
    } catch (e) { alert('Could not load proposals: ' + e.message); }
}

async function fetchProposalsFromDaodao() {
    alert('DAODAO API fetch not yet implemented. Please add proposals manually or load from GitHub.');
}

// ============ IFRAME PREVIEW MODAL ============

function openPreviewModal(url, title = 'Preview') {
    // Create modal if it doesn't exist
    let modal = $('preview-modal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'preview-modal';
        modal.className = 'fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4';
        modal.innerHTML = `
            <div class="bg-[#1a1a1a] rounded-lg border border-gray-700 w-full max-w-4xl h-[80vh] flex flex-col">
                <div class="flex justify-between items-center p-3 border-b border-gray-700">
                    <div class="flex items-center gap-3">
                        <span class="text-white font-bold text-sm" id="preview-modal-title">Preview</span>
                        <a id="preview-modal-link" href="#" target="_blank" class="text-[9px] text-cyan-400 hover:text-cyan-300">
                            <i class="fas fa-external-link-alt mr-1"></i> Open in new tab
                        </a>
                    </div>
                    <button onclick="closePreviewModal()" class="text-gray-400 hover:text-white text-xl px-2">&times;</button>
                </div>
                <div class="flex-1 overflow-hidden">
                    <iframe id="preview-modal-iframe" class="w-full h-full border-0" src="about:blank"></iframe>
                </div>
            </div>
        `;
        modal.onclick = (e) => { if (e.target === modal) closePreviewModal(); };
        document.body.appendChild(modal);
    }
    
    // Set content and show
    $('preview-modal-title').textContent = title;
    $('preview-modal-link').href = url;
    $('preview-modal-iframe').src = url;
    modal.classList.remove('hidden');
    modal.style.display = 'flex';
}

function closePreviewModal() {
    const modal = $('preview-modal');
    if (modal) {
        $('preview-modal-iframe').src = 'about:blank'; // Stop loading
        modal.style.display = 'none';
    }
}

function openTokenLookup(token) {
    const url = TOKEN_LOOKUP_URLS[token];
    if (url) {
        openPreviewModal(url, `${token} Price Lookup`);
    } else {
        alert(`No lookup URL configured for ${token}`);
    }
}
</script>
</body>
</html>
