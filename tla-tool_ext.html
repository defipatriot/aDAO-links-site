<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TLA Admin (Extensions) | Alliance DAO</title>
<meta name="description" content="Internal admin tool for TLA extension data - Votion, PD Bribes, historical tracking. Not the public dashboard.">
<meta name="robots" content="noindex, nofollow">

<!-- Favicon -->
<link rel="icon" type="image/x-icon" href="https://raw.githubusercontent.com/defipatriot/aDAO-Image-Files/main/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://raw.githubusercontent.com/defipatriot/aDAO-Image-Files/main/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://raw.githubusercontent.com/defipatriot/aDAO-Image-Files/main/favicon-32x32.png">
<link rel="apple-touch-icon" sizes="180x180" href="https://raw.githubusercontent.com/defipatriot/aDAO-Image-Files/main/apple-touch-icon.png">

<!-- OG Meta -->
<meta property="og:title" content="TLA Admin Extensions | Alliance DAO">
<meta property="og:description" content="Internal admin tool for TLA extension data collection">
<meta property="og:image" content="https://raw.githubusercontent.com/defipatriot/aDAO-Image-Files/main/android-chrome-512x512.png">
<meta property="og:type" content="website">

<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<!-- Vercel Analytics -->
<script defer src="/_vercel/insights/script.js"></script>
<style>
    body { font-family: 'Inter', monospace; background: #0D0D0D; color: #EAEAEA; }
    .input-dark { background: #1A1A1A; border: 1px solid #333; color: white; padding: 8px; border-radius: 6px; width: 100%; font-family: monospace; font-size: 0.75rem; resize: vertical; }
    .input-dark:focus { border-color: #2dd4bf; outline: none; }
    .tab-btn { padding: 8px 16px; border-radius: 6px; font-weight: 600; cursor: pointer; background: #1f2937; border: 1px solid #374151; color: #9ca3af; font-size: 0.8rem; transition: all 0.2s; }
    .tab-btn:hover { background: #374151; color: white; }
    .tab-btn.active { background: #2dd4bf; color: #000; border-color: #2dd4bf; }
    .workspace { display: none !important; } .workspace.active { display: block !important; }
    .preview-card { background: #111; border: 1px solid #333; border-radius: 8px; padding: 16px; }
    .btn-action { background: #333; color: white; padding: 6px; border-radius: 6px; font-size: 0.75rem; width: 100%; margin-top: 8px; transition: 0.2s; font-weight: 600; }
    .btn-action:hover { background: #444; }
    .custom-scroll::-webkit-scrollbar { width: 6px; }
    .custom-scroll::-webkit-scrollbar-track { background: #0d0d0d; }
    .custom-scroll::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
    .status-done { background: #065f46 !important; border-color: #10b981 !important; color: #6ee7b7 !important; }
</style>
</head>
<body class="p-4 w-full max-w-[1600px] mx-auto min-h-screen flex flex-col">

<!-- ADMIN TOOL NOTICE -->
<div class="bg-amber-900/30 border border-amber-600/50 rounded-lg px-4 py-2 mb-4 flex items-center gap-3">
    <i class="fas fa-tools text-amber-400"></i>
    <div class="flex-grow">
        <span class="text-amber-400 font-bold text-xs">INTERNAL ADMIN TOOL</span>
        <span class="text-amber-200/70 text-xs ml-2">Extension data (Votion, PD Bribes, Historical). Looking for the dashboard?</span>
    </div>
    <a href="https://www.thealliancedao.com/tla-stats.html" target="_blank" class="bg-cyan-600 hover:bg-cyan-500 text-white px-3 py-1 rounded text-xs font-bold transition-colors flex items-center gap-1">
        <i class="fas fa-chart-line"></i> View TLA Stats
    </a>
</div>

<!-- HEADER -->
<header class="flex flex-col gap-4 mb-4 pb-4 border-b border-gray-800">
    <div class="flex justify-between items-start">
        <div class="flex flex-col">
            <h1 class="text-xl font-bold text-teal-400 flex items-center gap-2">
                <i class="fas fa-puzzle-piece"></i> TLA Admin <span class="text-gray-500 text-sm">Extensions</span>
            </h1>
            <div class="flex gap-4 mt-1 text-[10px] font-mono text-gray-500">
                <span class="flex items-center gap-1"><i class="far fa-clock text-teal-600"></i> Target Epoch: <span id="target-epoch" class="text-white font-bold">...</span></span>
                <span class="text-gray-600">|</span>
                <span class="flex items-center gap-1">Phase: <span id="target-phase" class="text-yellow-400 font-bold">...</span></span>
                <span class="text-gray-600">|</span>
                <span class="flex items-center gap-1">Status: <span id="status-indicator" class="text-gray-400">Idle</span></span>
            </div>
        </div>
        
        <!-- Epoch Snapshot Workflow -->
        <div class="flex flex-col items-end gap-1">
            <div class="text-[9px] text-gray-500 uppercase font-bold">Epoch Snapshot Checklist</div>
            <div class="flex gap-2 items-center">
                <div class="flex flex-col items-center">
                    <span id="step-lst" class="px-2 py-0.5 rounded bg-gray-800 text-gray-500 border border-gray-700 text-[10px] cursor-pointer" onclick="switchTab('lstratios')" title="Update LST ratios and APYs">‚ë† LST Ratios</span>
                    <span id="step-lst-val" class="text-[8px] text-gray-600 mt-0.5">0/6</span>
                </div>
                <div class="flex flex-col items-center">
                    <span id="step-votion" class="px-2 py-0.5 rounded bg-gray-800 text-gray-500 border border-gray-700 text-[10px] cursor-pointer" onclick="switchTab('votion')" title="Paste Votion lockup data">‚ë° Votion</span>
                    <span id="step-votion-val" class="text-[8px] text-gray-600 mt-0.5">0 locks</span>
                </div>
                <div class="flex flex-col items-center">
                    <span id="step-pd" class="px-2 py-0.5 rounded bg-gray-800 text-gray-500 border border-gray-700 text-[10px] cursor-pointer" onclick="switchTab('pdbribes')" title="Verify PD bribes coverage">‚ë¢ PD Bribes</span>
                    <span id="step-pd-val" class="text-[8px] text-gray-600 mt-0.5">-</span>
                </div>
                <div class="flex flex-col items-center">
                    <span id="step-export" class="px-2 py-0.5 rounded bg-gray-800 text-gray-500 border border-gray-700 text-[10px] cursor-pointer" onclick="downloadExtJson()" title="Export epoch snapshot">‚ë£ Export</span>
                    <span id="step-export-val" class="text-[8px] text-gray-600 mt-0.5">ready?</span>
                </div>
            </div>
        </div>
        
        <!-- Global Actions -->
        <div class="flex gap-2">
            <button onclick="clearAll()" class="bg-red-900/20 hover:bg-red-900/40 text-red-400 border border-red-900/50 px-3 py-1.5 rounded text-xs font-bold transition-colors">Clear All</button>
            <button onclick="downloadExtJson()" class="bg-teal-900/50 hover:bg-teal-800 text-teal-200 border border-teal-700 px-3 py-1.5 rounded text-xs font-bold transition-colors">Download JSON</button>
        </div>
    </div>
</header>

<!-- CONFIG BAR -->
<div class="bg-[#161616] border border-gray-800 rounded-lg p-3 mb-4">
    <div class="flex items-center gap-4 mb-3">
        <div class="flex-shrink-0 text-teal-500 text-xl"><i class="fas fa-sliders-h"></i></div>
        <div class="flex-grow">
            <h3 class="text-xs font-bold text-gray-400 uppercase">Epoch Configuration</h3>
            <p class="text-[10px] text-gray-600">Auto-detected from TLA. Verify before exporting.</p>
        </div>
        
        <!-- Live Epoch Info -->
        <div class="flex items-center gap-3 bg-[#0D0D0D] rounded px-3 py-2 border border-gray-700">
            <div class="flex flex-col items-center">
                <span class="text-[8px] text-gray-500 uppercase">Live Epoch</span>
                <span id="live-epoch" class="text-sm font-mono font-bold text-teal-400">...</span>
            </div>
            <div class="flex flex-col items-center border-l border-gray-700 pl-3">
                <span class="text-[8px] text-gray-500 uppercase">Ends In</span>
                <span id="live-ends" class="text-sm font-mono font-bold text-yellow-400">...</span>
            </div>
            <div class="flex flex-col items-center border-l border-gray-700 pl-3">
                <span class="text-[8px] text-gray-500 uppercase">Auto Phase</span>
                <span id="live-phase" class="text-sm font-mono font-bold text-orange-400">...</span>
            </div>
            <button onclick="fetchLiveEpochInfo()" class="ml-2 text-teal-400 hover:text-teal-300 text-[10px]" title="Refresh live epoch info">
                <i class="fas fa-sync-alt"></i>
            </button>
        </div>
        
        <!-- Working Epoch Selection -->
        <div class="flex items-center gap-2 bg-[#0D0D0D] rounded px-3 py-2 border border-teal-900/50">
            <span class="text-[9px] text-gray-400 uppercase">Working:</span>
            <input type="number" id="extEpoch" placeholder="Ep" class="input-dark w-16 text-center font-mono text-sm" onchange="updateMeta()">
            <select id="extPhase" class="input-dark w-20 text-xs" onchange="updateMeta()">
                <option value="end">End</option>
                <option value="mid">Mid</option>
                <option value="start">Start</option>
            </select>
            <button onclick="syncToLive()" class="text-[9px] text-teal-400 hover:text-teal-300 border border-teal-900 rounded px-2 py-1" title="Sync to live epoch">
                ‚Üê Sync
            </button>
        </div>
        
        <!-- Mismatch Warning -->
        <div id="epoch-mismatch-warning" class="hidden bg-red-900/30 border border-red-700 rounded px-3 py-2 text-[10px] text-red-300">
            <i class="fas fa-exclamation-triangle mr-1"></i>
            <span id="mismatch-text">Working epoch doesn't match live!</span>
        </div>
        
        <!-- Mode Toggle -->
        <div class="border-l border-gray-700 pl-4 flex items-center gap-2">
            <span class="text-[9px] text-gray-500 uppercase">Mode:</span>
            <button id="mode-staging" onclick="setMode('staging')" class="px-2 py-1 text-[10px] rounded bg-yellow-900/50 text-yellow-400 border border-yellow-700">Staging</button>
            <button id="mode-normal" onclick="setMode('normal')" class="px-2 py-1 text-[10px] rounded bg-gray-800 text-gray-500 border border-gray-700">Normal</button>
        </div>
    </div>
    
    <!-- Second Row: Load Previous + Fetch Status -->
    <div class="grid grid-cols-8 gap-2 text-[9px]">
        <!-- Load Previous Ext File -->
        <div class="col-span-2 bg-[#0D0D0D] rounded p-2 border border-purple-900/50">
            <div class="flex items-center justify-between mb-1">
                <span class="text-purple-400 font-bold uppercase text-[8px]">Load Previous Ext</span>
                <label class="text-purple-300 hover:text-purple-200 cursor-pointer">
                    <i class="fas fa-upload"></i>
                    <input type="file" accept=".json" class="hidden" onchange="loadPreviousExt(event)">
                </label>
            </div>
            <div id="prev-ext-status" class="text-gray-600 text-[9px] truncate">No file loaded</div>
        </div>
        
        <!-- Fetch Status Indicators -->
        <div class="bg-[#0D0D0D] rounded p-2 flex items-center justify-between">
            <span class="text-gray-500">LP Registry</span>
            <span id="fetch-lp" class="text-gray-600">-</span>
        </div>
        <div class="bg-[#0D0D0D] rounded p-2 flex items-center justify-between">
            <span class="text-gray-500">Staging</span>
            <span id="fetch-staging" class="text-gray-600">-</span>
        </div>
        <div class="bg-[#0D0D0D] rounded p-2 flex items-center justify-between">
            <span class="text-gray-500">Historical</span>
            <span id="fetch-historical" class="text-gray-600">-</span>
        </div>
        <div class="bg-[#0D0D0D] rounded p-2 flex items-center justify-between">
            <span class="text-gray-500">Current</span>
            <span id="fetch-current" class="text-gray-600">-</span>
        </div>
        <div class="bg-[#0D0D0D] rounded p-2 flex items-center justify-between">
            <span class="text-gray-500">PD Bribes</span>
            <span id="fetch-pd" class="text-gray-600">-</span>
        </div>
        <button onclick="fetchAllFromGithub()" class="bg-teal-900/30 text-teal-400 rounded p-2 hover:bg-teal-900/50 border border-teal-900/50">
            ‚ü≥ Fetch All
        </button>
    </div>
</div>

<!-- TABS -->
<div class="flex gap-2 mb-4 border-b border-gray-800 pb-1 overflow-x-auto">
    <div class="tab-btn active" onclick="switchTab('lpreg')">1. LP Registry</div>
    <div class="tab-btn" onclick="switchTab('lstratios')">2. LST Ratios</div>
    <div class="tab-btn" onclick="switchTab('votion')">3. Votion</div>
    <div class="tab-btn" onclick="switchTab('pdbribes')">4. PD Bribes</div>
    <div class="tab-btn" onclick="switchTab('astro')">5. Astroport</div>
    <div class="tab-btn" onclick="switchTab('ww')">6. Skeleton Swap</div>
    <div class="tab-btn bg-green-900/30 border-green-700 text-green-400" onclick="switchTab('prices')">üí∞ Prices</div>
    <div class="tab-btn bg-cyan-900/30 border-cyan-700 text-cyan-400" onclick="switchTab('dashboard')">üìä Dashboard</div>
    <div class="tab-btn bg-purple-900/30 border-purple-700 text-purple-400" onclick="switchTab('nft')">üñºÔ∏è NFT Stats</div>
    <div class="tab-btn bg-orange-900/30 border-orange-700 text-orange-400" onclick="switchTab('news')">üì∞ News</div>
    <div class="tab-btn bg-blue-900/30 border-blue-700 text-blue-400" onclick="switchTab('dao')">üèõÔ∏è DAO</div>
</div>

<!-- WS 0: LP REGISTRY -->
<div id="ws-lpreg" class="workspace active">
    <div class="grid grid-cols-12 gap-4 mb-4">
        <!-- Parse Vote Tab -->
        <div class="col-span-6 bg-[#161616] p-3 rounded border border-gray-800 flex flex-col gap-2">
            <div class="flex justify-between items-center">
                <h3 class="text-teal-400 font-bold text-xs">Paste TLA Vote Tab</h3>
                <button onclick="clearPaste('voteTabPaste')" class="text-[9px] text-red-400 hover:text-red-300">Clear</button>
            </div>
            <textarea id="voteTabPaste" class="input-dark h-48 font-mono text-[9px]" placeholder="Copy entire Vote tab from TLA Core..."></textarea>
            <button onclick="parseVoteTab()" class="btn-action bg-teal-900/40 text-teal-200 border border-teal-900">Parse Vote Tab</button>
        </div>
        
        <!-- Registry Summary -->
        <div class="col-span-6 bg-[#161616] p-3 rounded border border-gray-800">
            <div class="text-[9px] text-gray-500 uppercase font-bold mb-2">LP Registry Summary</div>
            <div class="grid grid-cols-2 gap-2 text-[10px] mb-3">
                <div class="flex justify-between"><span class="text-gray-500">Total LPs:</span><span id="lp-total" class="text-white font-mono">0</span></div>
                <div class="flex justify-between"><span class="text-gray-500">Active (>1%):</span><span id="lp-active" class="text-green-400 font-mono">0</span></div>
                <div class="flex justify-between"><span class="text-gray-500">Astroport:</span><span id="lp-astro" class="text-cyan-400 font-mono">0</span></div>
                <div class="flex justify-between"><span class="text-gray-500">Skeleton Swap:</span><span id="lp-ww" class="text-blue-400 font-mono">0</span></div>
            </div>
            <div class="border-t border-gray-700 pt-2 flex gap-2">
                <button onclick="exportLpRegistry()" class="btn-action flex-1 bg-green-900/30 text-green-300 border border-green-900/50 text-[10px]">Export Registry</button>
                <button onclick="loadLpRegistryPaste()" class="btn-action flex-1 bg-blue-900/30 text-blue-300 border border-blue-900/50 text-[10px]">Load from JSON</button>
            </div>
        </div>
    </div>
    
    <!-- LP List by Bucket -->
    <div class="preview-card">
        <div class="flex justify-between items-center mb-2 border-b border-gray-800 pb-2">
            <h3 class="text-xs font-bold text-white">LP Registry</h3>
            <div class="flex gap-4 text-[9px]">
                <label class="flex items-center gap-1 cursor-pointer">
                    <input type="checkbox" id="filter-active" checked onchange="renderLpRegistry()">
                    <span class="text-gray-400">Active Only</span>
                </label>
                <label class="flex items-center gap-1 cursor-pointer">
                    <input type="checkbox" id="filter-astro" checked onchange="renderLpRegistry()">
                    <span class="text-cyan-400">Astroport</span>
                </label>
                <label class="flex items-center gap-1 cursor-pointer">
                    <input type="checkbox" id="filter-ww" checked onchange="renderLpRegistry()">
                    <span class="text-blue-400">Skeleton Swap</span>
                </label>
            </div>
        </div>
        <div id="lp-registry-list" class="max-h-[500px] overflow-y-auto custom-scroll space-y-2"></div>
    </div>
</div>

<!-- WS: LST RATIOS -->
<div id="ws-lstratios" class="workspace">
    <!-- Header with status -->
    <div class="bg-[#161616] border border-teal-900/50 rounded-lg p-4 mb-4">
        <div class="flex justify-between items-center mb-3">
            <div class="flex items-center gap-3">
                <i class="fas fa-exchange-alt text-teal-400 text-xl"></i>
                <div>
                    <h2 class="text-teal-400 font-bold text-sm">LST Ratios & Chain Staking</h2>
                    <p class="text-gray-500 text-[10px]">Track liquid staking token ratios and APYs for snapshot export</p>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <div id="lst-all-status" class="px-3 py-1 rounded text-[10px] font-bold bg-red-900/30 text-red-400 border border-red-700">
                    <i class="fas fa-exclamation-circle mr-1"></i> Incomplete
                </div>
                <button onclick="fetchChainStakingApr()" class="bg-teal-900/30 hover:bg-teal-900/50 text-teal-400 px-3 py-1.5 rounded text-[10px] border border-teal-900/50">
                    <i class="fas fa-sync-alt mr-1"></i> Fetch APR
                </button>
            </div>
        </div>
        
        <!-- Chain Staking APR -->
        <div class="grid grid-cols-3 gap-4 mb-4">
            <div class="bg-[#0D0D0D] rounded-lg p-3 border border-yellow-900/50">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-yellow-400 text-[10px] font-bold uppercase">Chain Staking APR</span>
                    <a href="https://github.com/defipatriot/tla_json_storage/blob/main/luna_staking_apr.csv" target="_blank" class="text-[9px] text-gray-500 hover:text-gray-400">
                        <i class="fas fa-external-link-alt"></i>
                    </a>
                </div>
                <div class="flex items-baseline gap-2">
                    <input type="number" id="lst-chain-apr" step="0.01" class="input-dark text-xl font-bold w-24 text-center text-yellow-400" value="22.04" onchange="updateLstRatio('chainStakingApr', this.value)">
                    <span class="text-yellow-400 text-lg">%</span>
                </div>
                <div id="lst-chain-apr-date" class="text-[9px] text-gray-600 mt-1">Last: --</div>
            </div>
            <div class="col-span-2 bg-[#0D0D0D] rounded-lg p-3 border border-gray-800">
                <div class="text-[9px] text-gray-500 uppercase font-bold mb-2">Parse Instructions</div>
                <div class="text-[10px] text-gray-400 space-y-1">
                    <p><span class="text-teal-400 font-mono">Eris:</span> Copy "1 ampLUNA = X.XXXX LUNA" text and paste into boxes</p>
                    <p><span class="text-cyan-400 font-mono">Backbone:</span> Convert "1 LUNA = 0.623302 bLUNA" ‚Üí 1/0.623302 = 1.6048</p>
                    <p><span class="text-purple-400 font-mono">Astroport:</span> Copy "1:1.22 xASTRO:ASTRO" ‚Üí ratio = 1.22</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- LST Ratio Cards -->
    <div class="grid grid-cols-3 gap-4 mb-4">
        <!-- ampLUNA -->
        <div id="lst-card-ampLUNA" class="bg-[#161616] rounded-lg p-3 border-2 border-gray-700">
            <div class="flex justify-between items-center mb-2">
                <div class="flex items-center gap-2">
                    <img src="https://raw.githubusercontent.com/defipatriot/aDAO-Image-Files/refs/heads/main/logos/ampLUNA.png" class="w-6 h-6 rounded-full" onerror="this.style.display='none'">
                    <span class="text-teal-400 font-bold text-sm">ampLUNA</span>
                </div>
                <a href="https://www.erisprotocol.com/terra/amplifier/LUNA" target="_blank" class="text-[9px] text-teal-400 hover:text-teal-300 bg-teal-900/30 px-2 py-0.5 rounded border border-teal-900/50">
                    <i class="fas fa-external-link-alt mr-1"></i> Eris
                </a>
            </div>
            <div id="lst-status-ampLUNA" class="text-[9px] px-2 py-0.5 rounded bg-gray-800 text-gray-500 text-center mb-2">pending</div>
            <div class="flex items-center gap-2 mb-2">
                <span class="text-[10px] text-gray-500">1 ampLUNA =</span>
                <input type="number" id="lst-ratio-ampLUNA" step="0.0001" class="input-dark w-24 text-center font-mono" value="1.9015" onchange="updateLstRatio('ampLUNA', this.value)">
                <span class="text-[10px] text-gray-400">LUNA</span>
            </div>
            <div class="flex items-center gap-2 mb-2">
                <span class="text-[10px] text-gray-500">APY:</span>
                <input type="number" id="lst-apy-ampLUNA" step="0.01" class="input-dark w-20 text-center font-mono text-green-400" value="29.68" onchange="updateLstApy('ampLUNA', this.value)">
                <span class="text-[10px] text-gray-400">%</span>
            </div>
            <textarea id="lst-paste-ampLUNA" class="input-dark text-[9px] h-16 w-full" placeholder="Paste: Amplified APY 29.68% TVL... 1 ampLUNA = 1.9015 LUNA" onpaste="setTimeout(() => parseLstPaste('ampLUNA'), 100)"></textarea>
            <button onclick="parseLstPaste('ampLUNA')" class="btn-action text-[9px] bg-teal-900/30 text-teal-300">Parse</button>
        </div>
        
        <!-- arbLUNA -->
        <div id="lst-card-arbLUNA" class="bg-[#161616] rounded-lg p-3 border-2 border-gray-700">
            <div class="flex justify-between items-center mb-2">
                <div class="flex items-center gap-2">
                    <img src="https://raw.githubusercontent.com/defipatriot/aDAO-Image-Files/refs/heads/main/logos/arbLUNA.png" class="w-6 h-6 rounded-full" onerror="this.style.display='none'">
                    <span class="text-orange-400 font-bold text-sm">arbLUNA</span>
                </div>
                <a href="https://www.erisprotocol.com/terra/arb-vault" target="_blank" class="text-[9px] text-orange-400 hover:text-orange-300 bg-orange-900/30 px-2 py-0.5 rounded border border-orange-900/50">
                    <i class="fas fa-external-link-alt mr-1"></i> Eris Arb
                </a>
            </div>
            <div id="lst-status-arbLUNA" class="text-[9px] px-2 py-0.5 rounded bg-gray-800 text-gray-500 text-center mb-2">pending</div>
            <div class="flex items-center gap-2 mb-2">
                <span class="text-[10px] text-gray-500">1 arbLUNA =</span>
                <input type="number" id="lst-ratio-arbLUNA" step="0.0001" class="input-dark w-24 text-center font-mono" value="2.6873" onchange="updateLstRatio('arbLUNA', this.value)">
                <span class="text-[10px] text-gray-400">LUNA</span>
            </div>
            <div class="flex items-center gap-2 mb-2">
                <span class="text-[10px] text-gray-500">APY:</span>
                <input type="number" id="lst-apy-arbLUNA" step="0.01" class="input-dark w-20 text-center font-mono text-green-400" value="146.24" onchange="updateLstApy('arbLUNA', this.value)">
                <span class="text-[10px] text-gray-400">%</span>
            </div>
            <textarea id="lst-paste-arbLUNA" class="input-dark text-[9px] h-16 w-full" placeholder="Paste: Arbitrage APY 146.24% TVL... 1 arbLUNA = 2.6873 LUNA" onpaste="setTimeout(() => parseLstPaste('arbLUNA'), 100)"></textarea>
            <button onclick="parseLstPaste('arbLUNA')" class="btn-action text-[9px] bg-orange-900/30 text-orange-300">Parse</button>
        </div>
        
        <!-- bLUNA -->
        <div id="lst-card-bLUNA" class="bg-[#161616] rounded-lg p-3 border-2 border-gray-700">
            <div class="flex justify-between items-center mb-2">
                <div class="flex items-center gap-2">
                    <img src="https://raw.githubusercontent.com/defipatriot/aDAO-Image-Files/refs/heads/main/logos/bLUNA.png" class="w-6 h-6 rounded-full" onerror="this.style.display='none'">
                    <span class="text-cyan-400 font-bold text-sm">bLUNA</span>
                </div>
                <a href="https://app.backbonelabs.io/liquid-staking/gravedigger/phoenix-1" target="_blank" class="text-[9px] text-cyan-400 hover:text-cyan-300 bg-cyan-900/30 px-2 py-0.5 rounded border border-cyan-900/50">
                    <i class="fas fa-external-link-alt mr-1"></i> Backbone
                </a>
            </div>
            <div id="lst-status-bLUNA" class="text-[9px] px-2 py-0.5 rounded bg-gray-800 text-gray-500 text-center mb-2">pending</div>
            <div class="flex items-center gap-2 mb-2">
                <span class="text-[10px] text-gray-500">1 bLUNA =</span>
                <input type="number" id="lst-ratio-bLUNA" step="0.0001" class="input-dark w-24 text-center font-mono" value="1.6048" onchange="updateLstRatio('bLUNA', this.value)">
                <span class="text-[10px] text-gray-400">LUNA</span>
            </div>
            <div class="flex items-center gap-2 mb-2">
                <span class="text-[10px] text-gray-500">APY:</span>
                <input type="number" id="lst-apy-bLUNA" step="0.01" class="input-dark w-20 text-center font-mono text-gray-500" placeholder="N/A" onchange="updateLstApy('bLUNA', this.value)">
                <span class="text-[10px] text-gray-500">% <span class="text-[8px]">(not shown)</span></span>
            </div>
            <textarea id="lst-paste-bLUNA" class="input-dark text-[9px] h-16 w-full" placeholder="Paste: Exchange rate 1 LUNA = 0.623302 bLUNA (will auto-convert)" onpaste="setTimeout(() => parseLstPaste('bLUNA'), 100)"></textarea>
            <button onclick="parseLstPaste('bLUNA')" class="btn-action text-[9px] bg-cyan-900/30 text-cyan-300">Parse</button>
        </div>
        
        <!-- ampCAPA -->
        <div id="lst-card-ampCAPA" class="bg-[#161616] rounded-lg p-3 border-2 border-gray-700">
            <div class="flex justify-between items-center mb-2">
                <div class="flex items-center gap-2">
                    <img src="https://raw.githubusercontent.com/defipatriot/aDAO-Image-Files/refs/heads/main/logos/ampCAPA.png" class="w-6 h-6 rounded-full" onerror="this.style.display='none'">
                    <span class="text-purple-400 font-bold text-sm">ampCAPA</span>
                </div>
                <a href="https://www.erisprotocol.com/terra/amplifier/CAPA" target="_blank" class="text-[9px] text-purple-400 hover:text-purple-300 bg-purple-900/30 px-2 py-0.5 rounded border border-purple-900/50">
                    <i class="fas fa-external-link-alt mr-1"></i> Eris
                </a>
            </div>
            <div id="lst-status-ampCAPA" class="text-[9px] px-2 py-0.5 rounded bg-gray-800 text-gray-500 text-center mb-2">pending</div>
            <div class="flex items-center gap-2 mb-2">
                <span class="text-[10px] text-gray-500">1 ampCAPA =</span>
                <input type="number" id="lst-ratio-ampCAPA" step="0.0001" class="input-dark w-24 text-center font-mono" value="1.1055" onchange="updateLstRatio('ampCAPA', this.value)">
                <span class="text-[10px] text-gray-400">CAPA</span>
            </div>
            <div class="flex items-center gap-2 mb-2">
                <span class="text-[10px] text-gray-500">APY:</span>
                <input type="number" id="lst-apy-ampCAPA" step="0.01" class="input-dark w-20 text-center font-mono text-green-400" value="4.83" onchange="updateLstApy('ampCAPA', this.value)">
                <span class="text-[10px] text-gray-400">%</span>
            </div>
            <textarea id="lst-paste-ampCAPA" class="input-dark text-[9px] h-16 w-full" placeholder="Paste: Amplified APY 4.83% TVL... 1 ampCAPA = 1.1055 CAPA" onpaste="setTimeout(() => parseLstPaste('ampCAPA'), 100)"></textarea>
            <button onclick="parseLstPaste('ampCAPA')" class="btn-action text-[9px] bg-purple-900/30 text-purple-300">Parse</button>
        </div>
        
        <!-- ampROAR -->
        <div id="lst-card-ampROAR" class="bg-[#161616] rounded-lg p-3 border-2 border-gray-700">
            <div class="flex justify-between items-center mb-2">
                <div class="flex items-center gap-2">
                    <img src="https://raw.githubusercontent.com/defipatriot/aDAO-Image-Files/refs/heads/main/logos/ampROAR.png" class="w-6 h-6 rounded-full" onerror="this.style.display='none'">
                    <span class="text-yellow-400 font-bold text-sm">ampROAR</span>
                </div>
                <a href="https://www.erisprotocol.com/terra/amplifier/ROAR" target="_blank" class="text-[9px] text-yellow-400 hover:text-yellow-300 bg-yellow-900/30 px-2 py-0.5 rounded border border-yellow-900/50">
                    <i class="fas fa-external-link-alt mr-1"></i> Eris
                </a>
            </div>
            <div id="lst-status-ampROAR" class="text-[9px] px-2 py-0.5 rounded bg-gray-800 text-gray-500 text-center mb-2">pending</div>
            <div class="flex items-center gap-2 mb-2">
                <span class="text-[10px] text-gray-500">1 ampROAR =</span>
                <input type="number" id="lst-ratio-ampROAR" step="0.0001" class="input-dark w-24 text-center font-mono" value="1.1087" onchange="updateLstRatio('ampROAR', this.value)">
                <span class="text-[10px] text-gray-400">ROAR</span>
            </div>
            <div class="flex items-center gap-2 mb-2">
                <span class="text-[10px] text-gray-500">APY:</span>
                <input type="number" id="lst-apy-ampROAR" step="0.01" class="input-dark w-20 text-center font-mono text-green-400" value="9.92" onchange="updateLstApy('ampROAR', this.value)">
                <span class="text-[10px] text-gray-400">%</span>
            </div>
            <textarea id="lst-paste-ampROAR" class="input-dark text-[9px] h-16 w-full" placeholder="Paste: Amplified APY 9.92% TVL... 1 ampROAR = 1.1087 ROAR" onpaste="setTimeout(() => parseLstPaste('ampROAR'), 100)"></textarea>
            <button onclick="parseLstPaste('ampROAR')" class="btn-action text-[9px] bg-yellow-900/30 text-yellow-300">Parse</button>
        </div>
        
        <!-- xASTRO -->
        <div id="lst-card-xASTRO" class="bg-[#161616] rounded-lg p-3 border-2 border-gray-700">
            <div class="flex justify-between items-center mb-2">
                <div class="flex items-center gap-2">
                    <img src="https://raw.githubusercontent.com/defipatriot/aDAO-Image-Files/refs/heads/main/logos/xASTRO.png" class="w-6 h-6 rounded-full" onerror="this.style.display='none'">
                    <span class="text-blue-400 font-bold text-sm">xASTRO</span>
                </div>
                <a href="https://app.astroport.fi/governance" target="_blank" class="text-[9px] text-blue-400 hover:text-blue-300 bg-blue-900/30 px-2 py-0.5 rounded border border-blue-900/50">
                    <i class="fas fa-external-link-alt mr-1"></i> Astroport
                </a>
            </div>
            <div id="lst-status-xASTRO" class="text-[9px] px-2 py-0.5 rounded bg-gray-800 text-gray-500 text-center mb-2">pending</div>
            <div class="flex items-center gap-2 mb-2">
                <span class="text-[10px] text-gray-500">1 xASTRO =</span>
                <input type="number" id="lst-ratio-xASTRO" step="0.0001" class="input-dark w-24 text-center font-mono" value="1.22" onchange="updateLstRatio('xASTRO', this.value)">
                <span class="text-[10px] text-gray-400">ASTRO</span>
            </div>
            <div class="flex items-center gap-2 mb-2">
                <span class="text-[10px] text-gray-500">APY:</span>
                <input type="number" id="lst-apy-xASTRO" step="0.01" class="input-dark w-20 text-center font-mono text-green-400" value="22.49" onchange="updateLstApy('xASTRO', this.value)">
                <span class="text-[10px] text-gray-400">%</span>
            </div>
            <textarea id="lst-paste-xASTRO" class="input-dark text-[9px] h-16 w-full" placeholder="Paste: 22.49% APY 1:1.22 xASTRO:ASTRO" onpaste="setTimeout(() => parseLstPaste('xASTRO'), 100)"></textarea>
            <button onclick="parseLstPaste('xASTRO')" class="btn-action text-[9px] bg-blue-900/30 text-blue-300">Parse</button>
        </div>
    </div>
</div>

<!-- WS 1: VOTION -->
<div id="ws-votion" class="workspace">
    <!-- Ratios Reference (from LST Ratios tab) -->
    <div class="grid grid-cols-12 gap-4 mb-4">
        <div class="col-span-6 bg-[#161616] p-3 rounded border border-gray-800 flex flex-col gap-2">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <span class="text-[10px] text-gray-400 font-bold">LST ‚Üí LUNA Ratios</span>
                    <span class="text-[9px] text-gray-600">(for VP calculation)</span>
                </div>
                <button onclick="switchTab('lstratios')" class="text-[9px] text-teal-400 hover:text-teal-300 flex items-center gap-1 bg-teal-900/30 px-2 py-1 rounded border border-teal-900/50">
                    <i class="fas fa-arrow-left"></i> Edit in LST Ratios Tab
                </button>
            </div>
            <div class="grid grid-cols-2 gap-2">
                <div class="flex items-center gap-1 bg-orange-900/20 rounded px-2 py-1">
                    <span class="text-[9px] text-orange-400">arbLUNA:</span>
                    <input type="number" id="ratioArb" step="0.0001" value="2.4362" class="input-dark text-[10px] w-20 text-center bg-transparent border-orange-900/50" onchange="updateRatios()" readonly>
                </div>
                <div class="flex items-center gap-1 bg-cyan-900/20 rounded px-2 py-1">
                    <span class="text-[9px] text-cyan-400">ampLUNA:</span>
                    <input type="number" id="ratioAmp" step="0.0001" value="1.8707" class="input-dark text-[10px] w-20 text-center bg-transparent border-cyan-900/50" onchange="updateRatios()" readonly>
                </div>
            </div>
            <div class="flex items-center justify-between text-[8px]">
                <span id="ratio-status" class="text-gray-600">Using default ratios</span>
                <span class="text-gray-600">VP = LUNA √ó 10 (Max) | √ó 2 (3mo) | √ó 1 (1wk)</span>
            </div>
        </div>
        
        <!-- Votion Summary -->
        <div class="col-span-6 bg-[#161616] p-3 rounded border border-gray-800 flex flex-col gap-2">
            <div class="text-[9px] text-gray-500 uppercase font-bold">Votion Summary</div>
            <div class="grid grid-cols-4 gap-2 text-[10px]">
                <div><span class="text-gray-500">Lockups:</span> <span id="votion-lock-count" class="text-white font-mono">0</span></div>
                <div><span class="text-gray-500">VP:</span> <span id="votion-total-vp" class="text-teal-400 font-mono font-bold">0</span></div>
                <div><span class="text-gray-500">USD:</span> <span id="votion-total-usd" class="text-green-400 font-mono">$0</span></div>
                <div><span class="text-gray-500">Rew:</span> <span id="votion-total-rew" class="text-green-400 font-mono">$0</span></div>
            </div>
            <div class="text-[8px] text-gray-600 mt-1 border-t border-gray-700 pt-2">
                <strong class="text-gray-400">Checklist:</strong>
                <span id="votion-checklist-arbmax" class="text-gray-600 ml-2">‚òê arbLUNA Max</span>
                <span id="votion-checklist-ampmax" class="text-gray-600 ml-2">‚òê ampLUNA Max</span>
                <span id="votion-checklist-other" class="text-gray-600 ml-2">‚òê Other</span>
            </div>
        </div>
    </div>
    
    <!-- Votion Lockups -->
    <div class="grid grid-cols-12 gap-4 mb-4">
        <div class="col-span-12 bg-[#161616] p-3 rounded border border-teal-900/30 flex flex-col gap-2">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <span class="text-[10px] text-gray-400 font-bold">Votion Lockups</span>
                    <span class="text-gray-500 font-normal text-[9px]">(paste each lockup page separately)</span>
                </div>
                <button onclick="clearPaste('votionPaste')" class="text-[9px] text-red-400 hover:text-red-300">Clear Input</button>
            </div>
            <textarea id="votionPaste" class="input-dark h-24 font-mono text-[10px]" placeholder="Ctrl+A / Ctrl+C on a Votion lockup page... each lockup has its own optimization"></textarea>
            <div class="flex gap-2">
                <button onclick="parseVotion()" class="btn-action flex-1 bg-teal-900/40 text-teal-200 border border-teal-900">Add Lockup</button>
                <button onclick="clearVotionLocks()" class="btn-action w-32 bg-red-900/30 text-red-300 border border-red-900/50">Clear All</button>
            </div>
        </div>
    </div>
    
    <!-- Lockups Grid - Each lockup as its own card with vote allocations -->
    <div id="votion-lockups" class="grid grid-cols-1 xl:grid-cols-2 gap-4">
        <div class="text-gray-600 text-[10px] italic text-center py-8 col-span-full border border-dashed border-gray-800 rounded">
            No lockups loaded. Paste each Votion lockup page and click "Add Lockup".
        </div>
    </div>
</div>

<!-- WS 2: PD BRIBES -->
<div id="ws-pdbribes" class="workspace">
    <!-- Top: Status + Fetch -->
    <div class="grid grid-cols-12 gap-4 mb-4">
        <!-- Coverage Status -->
        <div class="col-span-4 bg-[#161616] p-3 rounded border border-gray-800">
            <div class="flex justify-between items-center mb-2">
                <div class="text-[9px] text-gray-500 uppercase font-bold">Epoch Coverage</div>
                <button onclick="fetchPdBribesFromGithub()" class="text-[9px] text-teal-400 hover:text-teal-300 flex items-center gap-1">
                    <span id="pd-fetch-status">‚ü≥</span> Fetch from GitHub
                </button>
            </div>
            <div class="flex items-center gap-3 mb-2">
                <div id="pd-coverage-light" class="w-4 h-4 rounded-full bg-gray-700 border-2 border-gray-600"></div>
                <div class="text-[10px]">
                    <span class="text-gray-500">Target Epoch:</span>
                    <span id="pd-current-epoch" class="text-white font-mono ml-1">-</span>
                </div>
            </div>
            <div class="text-[9px] text-gray-500">
                Covered: <span id="pd-covered-range" class="text-green-400 font-mono">-</span>
            </div>
            <div class="text-[9px] text-gray-500 mt-1">
                Missing: <span id="pd-missing-epochs" class="text-red-400 font-mono">-</span>
            </div>
        </div>
        
        <!-- Alert Box - shows when epoch not covered -->
        <div id="pd-alert-box" class="col-span-4 bg-red-900/30 border border-red-700 rounded p-3 hidden">
            <div class="flex items-center gap-2 mb-2">
                <div class="text-red-400 text-lg animate-pulse">‚ö†</div>
                <div class="text-red-300 font-bold text-[11px]">Epoch <span id="pd-alert-epoch">-</span> NOT COVERED!</div>
            </div>
            <p class="text-red-200/70 text-[9px] mb-2">Paste the new PD bribes proposal below to add coverage for this epoch.</p>
            <div class="text-[8px] text-red-400/60">
                Expected: Range covering epoch <span id="pd-alert-epoch2">-</span> (e.g., [<span id="pd-alert-range">160-163</span>])
            </div>
        </div>
        
        <!-- Success Box - shows when epoch is covered -->
        <div id="pd-success-box" class="col-span-4 bg-green-900/20 border border-green-700 rounded p-3 hidden">
            <div class="flex items-center gap-2 mb-2">
                <div class="text-green-400 text-lg">‚úì</div>
                <div class="text-green-300 font-bold text-[11px]">Epoch <span id="pd-success-epoch">-</span> Covered</div>
            </div>
            <p class="text-green-200/70 text-[9px]">
                Range: <span id="pd-success-range" class="font-mono">-</span>
            </p>
            <p class="text-green-200/50 text-[8px] mt-1">
                Bribes: <span id="pd-success-bribes" class="font-mono">-</span>/epoch
            </p>
        </div>
        
        <!-- Summary Stats -->
        <div class="col-span-4 bg-[#161616] p-3 rounded border border-gray-800">
            <div class="text-[9px] text-gray-500 uppercase font-bold mb-2">Master File Summary</div>
            <div class="grid grid-cols-2 gap-1 text-[10px]">
                <span class="text-gray-500">Ranges Loaded:</span>
                <span id="pd-props-count" class="text-white font-mono text-right">0</span>
                <span class="text-gray-500">Total Epochs:</span>
                <span id="pd-total-epochs" class="text-white font-mono text-right">0</span>
                <span class="text-gray-500">Avg Bribes:</span>
                <span id="pd-total-bribes" class="text-green-400 font-mono text-right">$0</span>
            </div>
            <div class="mt-2 flex gap-1">
                <button onclick="exportPdBribesJson()" class="btn-action flex-1 bg-green-900/40 text-green-200 border border-green-900 text-[9px] mt-0">Download</button>
                <button onclick="copyPdBribesJson()" class="btn-action flex-1 bg-blue-900/40 text-blue-200 border border-blue-900 text-[9px] mt-0">Copy</button>
            </div>
        </div>
    </div>
    
    <!-- Add New Prop -->
    <div class="grid grid-cols-12 gap-4 mb-4">
        <div class="col-span-8 bg-[#161616] p-3 rounded border border-gray-800 flex flex-col gap-2">
            <div class="flex justify-between items-center">
                <h3 class="text-orange-400 font-bold text-xs">Add New Bribe Range <span class="text-gray-500 font-normal text-[10px]">(paste proposal text)</span></h3>
                <button onclick="clearPaste('pdPaste')" class="text-[9px] text-red-400 hover:text-red-300">Clear</button>
            </div>
            <textarea id="pdPaste" class="input-dark h-32 font-mono text-[10px]" placeholder="Bribes for [160-163]:
Gauge: project
AMPLUNA-LUNA (55.44%): $ 150 = 1973.01 LUNA per epoch
..."></textarea>
            <button onclick="parsePdBribes()" class="btn-action bg-orange-900/40 text-orange-200 border border-orange-900">Parse & Add Range</button>
        </div>
        
        <!-- New Prop Preview -->
        <div class="col-span-4 bg-[#161616] p-3 rounded border border-gray-800">
            <div class="text-[9px] text-gray-500 uppercase font-bold mb-2">New Range Preview</div>
            <div class="space-y-1 text-[10px]">
                <div class="flex justify-between">
                    <span class="text-gray-500">Epoch Range:</span>
                    <span id="pd-new-range" class="text-white font-mono">-</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-500">Epochs:</span>
                    <span id="pd-new-count" class="text-white font-mono">0</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-500">$/Epoch:</span>
                    <span id="pd-new-per-epoch" class="text-green-400 font-mono">$0</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-500">Total:</span>
                    <span id="pd-new-total" class="text-green-400 font-mono font-bold">$0</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-500">Pools:</span>
                    <span id="pd-new-pools" class="text-white font-mono">0</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Props History -->
    <div class="preview-card">
        <div class="flex justify-between items-center mb-2 border-b border-gray-800 pb-2">
            <h3 class="text-xs font-bold text-white">All Bribe Ranges (for tla_pd_bribes.json)</h3>
            <button onclick="clearAllPdBribes()" class="text-[9px] text-red-400 hover:text-red-300">Clear All</button>
        </div>
        <div id="pd-history" class="max-h-[400px] overflow-y-auto text-xs custom-scroll space-y-2"></div>
    </div>
</div>

<!-- WS 3: ASTROPORT -->
<div id="ws-astro" class="workspace">
    <!-- Mode-specific content will be rendered here -->
    <div id="astro-staging-mode">
        <!-- STAGING MODE: 4-day 180d capture -->
        <div class="bg-yellow-900/20 border border-yellow-700 rounded-lg p-4 mb-4">
            <div class="flex items-center gap-3 mb-3">
                <div class="text-yellow-400 text-xl">‚ö†</div>
                <div>
                    <h3 class="text-yellow-400 font-bold text-sm">Staging Mode - Initial 180-Day Capture</h3>
                    <p class="text-yellow-200/70 text-[10px]">180d = 4 days, 90d = 2 days, 30d = 1 day. LPs complete when they have required days.</p>
                </div>
            </div>
            
            <!-- Day Tracker -->
            <div class="grid grid-cols-4 gap-2 mb-4">
                <div id="staging-day1" class="bg-[#0D0D0D] rounded p-3 border border-gray-800">
                    <div class="text-[9px] text-gray-500 uppercase font-bold mb-1">Day 1</div>
                    <div id="staging-day1-status" class="text-[10px] text-gray-600">Not started</div>
                    <div id="staging-day1-lps" class="text-[9px] text-gray-500 mt-1">0 LPs</div>
                </div>
                <div id="staging-day2" class="bg-[#0D0D0D] rounded p-3 border border-gray-800">
                    <div class="text-[9px] text-gray-500 uppercase font-bold mb-1">Day 2</div>
                    <div id="staging-day2-status" class="text-[10px] text-gray-600">Not started</div>
                    <div id="staging-day2-lps" class="text-[9px] text-gray-500 mt-1">0 LPs</div>
                </div>
                <div id="staging-day3" class="bg-[#0D0D0D] rounded p-3 border border-gray-800">
                    <div class="text-[9px] text-gray-500 uppercase font-bold mb-1">Day 3</div>
                    <div id="staging-day3-status" class="text-[10px] text-gray-600">Not started</div>
                    <div id="staging-day3-lps" class="text-[9px] text-gray-500 mt-1">0 LPs</div>
                </div>
                <div id="staging-day4" class="bg-[#0D0D0D] rounded p-3 border border-gray-800">
                    <div class="text-[9px] text-gray-500 uppercase font-bold mb-1">Day 4</div>
                    <div id="staging-day4-status" class="text-[10px] text-gray-600">Not started</div>
                    <div id="staging-day4-lps" class="text-[9px] text-gray-500 mt-1">0 LPs</div>
                </div>
            </div>
            
            <!-- Current Day Selection -->
            <div class="flex items-center gap-4 mb-4">
                <span class="text-[10px] text-gray-400">Working on:</span>
                <select id="staging-current-day" class="input-dark w-32 text-[11px]" onchange="updateStagingDay()">
                    <option value="day1">Day 1</option>
                    <option value="day2">Day 2</option>
                    <option value="day3">Day 3</option>
                    <option value="day4">Day 4</option>
                </select>
                <button onclick="exportStagingDay()" class="btn-action bg-yellow-900/40 text-yellow-300 border border-yellow-700 text-[10px]">Export Current Day</button>
                <button onclick="loadStagingDayPaste()" class="btn-action bg-blue-900/40 text-blue-300 border border-blue-700 text-[10px]">Load Day from JSON</button>
            </div>
        </div>
        
        <!-- LP Selection & Data Input (Staging) -->
        <div class="grid grid-cols-12 gap-4 mb-4">
            <!-- LP Dropdown + Range -->
            <div class="col-span-3 bg-[#161616] p-3 rounded border border-gray-800">
                <div class="text-[9px] text-gray-500 uppercase font-bold mb-2">Select LP (Astroport)</div>
                <select id="astro-lp-select" class="input-dark w-full text-[11px] mb-2" onchange="updateSelectedLp()">
                    <option value="">-- Select LP --</option>
                </select>
                <div class="text-[9px] text-gray-500 uppercase font-bold mb-1 mt-3">Data Range <span class="text-cyan-400 normal-case">(auto-detected)</span></div>
                <select id="astro-data-range" class="input-dark w-full text-[10px]" disabled>
                    <option value="180">180d (4 days needed)</option>
                    <option value="90">90d (2 days needed)</option>
                    <option value="30">30d (1 day needed)</option>
                </select>
                <div id="astro-lp-status" class="text-[9px] text-gray-500 mt-3 space-y-1">
                    <div class="flex justify-between"><span>Liquidity:</span><span id="astro-lp-liq-status" class="text-gray-600">-</span></div>
                    <div class="flex justify-between"><span>Volume:</span><span id="astro-lp-vol-status" class="text-gray-600">-</span></div>
                    <div class="flex justify-between"><span>Days Done:</span><span id="astro-lp-days-status" class="text-gray-600">-</span></div>
                </div>
                <!-- Action buttons -->
                <div class="flex gap-2 mt-3">
                    <button onclick="markLpNotAvailable()" class="btn-action flex-1 bg-yellow-900/30 text-yellow-300 border border-yellow-800 text-[9px] py-1">‚ö† No Data</button>
                    <button onclick="clearLpData()" class="btn-action flex-1 bg-red-900/30 text-red-300 border border-red-800 text-[9px] py-1">‚úï Clear</button>
                </div>
            </div>
            
            <!-- Liquidity Paste -->
            <div class="col-span-4 bg-[#161616] p-3 rounded border border-gray-800 flex flex-col gap-2">
                <div class="flex justify-between items-center">
                    <h3 class="text-cyan-400 font-bold text-[10px]">Paste Liquidity JSON</h3>
                    <button onclick="clearPaste('astroLiqPaste')" class="text-[9px] text-red-400 hover:text-red-300">Clear</button>
                </div>
                <textarea id="astroLiqPaste" class="input-dark flex-1 font-mono text-[8px]" placeholder='{"result":{"data":{"json":[{"series":[...]}]}}}'></textarea>
            </div>
            
            <!-- Volume Paste -->
            <div class="col-span-4 bg-[#161616] p-3 rounded border border-gray-800 flex flex-col gap-2">
                <div class="flex justify-between items-center">
                    <h3 class="text-purple-400 font-bold text-[10px]">Paste Volume JSON</h3>
                    <button onclick="clearPaste('astroVolPaste')" class="text-[9px] text-red-400 hover:text-red-300">Clear</button>
                </div>
                <textarea id="astroVolPaste" class="input-dark flex-1 font-mono text-[8px]" placeholder='{"result":{"data":{"json":[{"series":[...]}]}}}'></textarea>
            </div>
            
            <!-- Capture Button -->
            <div class="col-span-1 flex flex-col justify-center">
                <button onclick="captureStagingBoth()" class="btn-action h-full bg-green-900/50 text-green-300 border border-green-700 text-[10px] flex flex-col items-center justify-center gap-1 hover:bg-green-800/50">
                    <span class="text-lg">‚úì</span>
                    <span>Capture</span>
                    <span>Both</span>
                </button>
            </div>
        </div>
        
        <!-- LP Progress Grid -->
        <div class="preview-card">
            <div class="flex justify-between items-center mb-2 border-b border-gray-800 pb-2">
                <h3 class="text-xs font-bold text-white">LP Capture Progress (Current Day)</h3>
                <div class="text-[9px] text-gray-500">
                    <span id="astro-staging-complete" class="text-green-400">0</span><span id="astro-staging-total"></span>
                </div>
            </div>
            <div id="astro-staging-lp-grid" class="grid grid-cols-4 gap-2 max-h-[300px] overflow-y-auto custom-scroll"></div>
        </div>
        
        <!-- Finalize Button -->
        <div id="staging-finalize-section" class="mt-4 bg-green-900/20 border border-green-700 rounded-lg p-4 hidden">
            <div class="flex items-center justify-between">
                <div>
                    <h3 class="text-green-400 font-bold text-sm">Ready to Finalize! <span id="staging-ready-count" class="text-green-300 font-normal"></span></h3>
                    <p class="text-green-200/70 text-[10px]">Generate epoch averages and create historical file from complete LPs.</p>
                </div>
                <button onclick="finalizeStaging()" class="btn-action bg-green-900/50 text-green-300 border border-green-600 px-4 py-2">
                    Finalize & Generate Historical
                </button>
            </div>
        </div>
    </div>
    
    <div id="astro-normal-mode" class="hidden">
        <!-- NORMAL MODE: Weekly updates with 14d/30d data -->
        <div class="bg-green-900/20 border border-green-700 rounded-lg p-3 mb-4">
            <div class="flex items-center gap-3">
                <div class="text-green-400 text-lg">‚úì</div>
                <div>
                    <h3 class="text-green-400 font-bold text-xs">Normal Mode - Weekly Updates</h3>
                    <p class="text-green-200/70 text-[10px]">Merge 14d/30d data into current file. Old data auto-ages to historical.</p>
                </div>
            </div>
        </div>
        
        <!-- Status Row -->
        <div class="grid grid-cols-12 gap-4 mb-4">
            <div class="col-span-4 bg-[#161616] p-3 rounded border border-gray-800">
                <div class="flex justify-between items-center mb-2">
                    <div class="text-[9px] text-gray-500 uppercase font-bold">Historical File (180d)</div>
                    <button onclick="fetchHistoricalFromGithub()" class="text-[9px] text-teal-400 hover:text-teal-300">‚ü≥ Fetch</button>
                </div>
                <div class="space-y-1 text-[10px]">
                    <div class="flex justify-between"><span class="text-gray-500">Epochs:</span><span id="hist-epochs" class="text-white font-mono">-</span></div>
                    <div class="flex justify-between"><span class="text-gray-500">LPs:</span><span id="hist-lps" class="text-white font-mono">0</span></div>
                    <div class="flex justify-between"><span class="text-gray-500">Last Updated:</span><span id="hist-updated" class="text-gray-400 font-mono">-</span></div>
                </div>
                <!-- Status alerts -->
                <div id="hist-need-epochs" class="hidden mt-2 p-2 bg-yellow-900/30 border border-yellow-700 rounded text-[9px]">
                    <span class="text-yellow-400">‚ö† Need:</span>
                    <span id="hist-need-list" class="text-yellow-300 font-mono ml-1">-</span>
                </div>
                <div id="hist-archive-epochs" class="hidden mt-2 p-2 bg-orange-900/30 border border-orange-700 rounded text-[9px]">
                    <span class="text-orange-400">üì¶ Archive:</span>
                    <span id="hist-archive-list" class="text-orange-300 font-mono ml-1">-</span>
                </div>
            </div>
            <div class="col-span-4 bg-[#161616] p-3 rounded border border-gray-800">
                <div class="text-[9px] text-gray-500 uppercase font-bold mb-2">Current File (Rolling 90d)</div>
                <div class="space-y-1 text-[10px]">
                    <div class="flex justify-between"><span class="text-gray-500">Epochs:</span><span id="curr-epochs" class="text-white font-mono">-</span></div>
                    <div class="flex justify-between"><span class="text-gray-500">LPs:</span><span id="curr-lps" class="text-white font-mono">0</span></div>
                    <div class="flex justify-between"><span class="text-gray-500">Last Updated:</span><span id="curr-updated" class="text-gray-400 font-mono">-</span></div>
                </div>
            </div>
            <div class="col-span-4 bg-[#161616] p-3 rounded border border-gray-800">
                <div class="text-[9px] text-gray-500 uppercase font-bold mb-2">Export Files</div>
                <div class="space-y-1">
                    <button onclick="exportHistorical()" class="btn-action w-full bg-orange-900/30 text-orange-300 border border-orange-900/50 text-[9px]">Download Historical</button>
                    <button onclick="exportArchive()" class="btn-action w-full bg-purple-900/30 text-purple-300 border border-purple-900/50 text-[9px]">Download Archive</button>
                    <button onclick="exportCombined()" class="btn-action w-full bg-green-900/30 text-green-300 border border-green-900/50 text-[9px]">Download Combined</button>
                </div>
            </div>
        </div>
        
        <!-- LP Selection & Data Input (Normal) -->
        <div class="grid grid-cols-12 gap-4 mb-4">
            <!-- LP Dropdown -->
            <div class="col-span-4 bg-[#161616] p-3 rounded border border-gray-800">
                <div class="text-[9px] text-gray-500 uppercase font-bold mb-2">Select LP (Astroport)</div>
                <select id="astro-lp-select-normal" class="input-dark w-full text-[11px] mb-2" onchange="updateSelectedLpNormal()">
                    <option value="">-- Select LP --</option>
                </select>
                <div class="text-[9px] text-gray-500">
                    <div class="flex justify-between"><span>Last Epoch:</span><span id="normal-lp-last-epoch" class="text-green-400 font-mono">-</span></div>
                </div>
            </div>
            
            <!-- Liquidity Paste -->
            <div class="col-span-4 bg-[#161616] p-3 rounded border border-gray-800 flex flex-col gap-2">
                <div class="flex justify-between items-center">
                    <h3 class="text-cyan-400 font-bold text-[10px]">Paste 14d/30d Liquidity</h3>
                    <button onclick="clearPaste('normalLiqPaste')" class="text-[9px] text-red-400 hover:text-red-300">Clear</button>
                </div>
                <textarea id="normalLiqPaste" class="input-dark h-24 font-mono text-[8px]" placeholder='{"result":{"data":{"json":[{"series":[...]}]}}}'></textarea>
                <button onclick="parseNormalLiquidity()" class="btn-action bg-cyan-900/40 text-cyan-200 border border-cyan-900 text-[10px]">Merge Liquidity</button>
            </div>
            
            <!-- Volume Paste -->
            <div class="col-span-4 bg-[#161616] p-3 rounded border border-gray-800 flex flex-col gap-2">
                <div class="flex justify-between items-center">
                    <h3 class="text-purple-400 font-bold text-[10px]">Paste 14d/30d Volume</h3>
                    <button onclick="clearPaste('normalVolPaste')" class="text-[9px] text-red-400 hover:text-red-300">Clear</button>
                </div>
                <textarea id="normalVolPaste" class="input-dark h-24 font-mono text-[8px]" placeholder='{"result":{"data":{"json":[{"series":[...]}]}}}'></textarea>
                <button onclick="parseNormalVolume()" class="btn-action bg-purple-900/40 text-purple-200 border border-purple-900 text-[10px]">Merge Volume</button>
            </div>
        </div>
        
        <!-- LP Status Grid -->
        <div class="preview-card">
            <div class="flex justify-between items-center mb-2 border-b border-gray-800 pb-2">
                <h3 class="text-xs font-bold text-white">LP Update Status</h3>
            </div>
            <div id="astro-normal-lp-grid" class="grid grid-cols-4 gap-2 max-h-[300px] overflow-y-auto custom-scroll"></div>
        </div>
    </div>
</div>

<!-- WS 4: WHITEWHALE -->
<div id="ws-ww" class="workspace">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="bg-[#161616] p-3 rounded border border-gray-800 flex flex-col gap-2">
            <div class="flex justify-between items-center">
                <h3 class="text-green-400 font-bold text-xs">Skeleton Swap Data</h3>
                <button onclick="clearPaste('wwPaste')" class="text-[9px] text-red-400 hover:text-red-300">Clear</button>
            </div>
            <textarea id="wwPaste" class="input-dark h-64 font-mono text-[10px]" placeholder="Paste Skeleton Swap dashboard text..."></textarea>
            <button onclick="parseWW()" class="btn-action bg-green-900/40 text-green-200 border border-green-900">Parse Skeleton Swap</button>
        </div>
        <div class="preview-card flex flex-col">
            <div class="flex justify-between items-center mb-2 border-b border-gray-800 pb-2">
                <h3 class="text-xs font-bold text-white">Parsed Skeleton Swap</h3>
                <div class="text-[10px] text-gray-500">Items: <span id="ww-count" class="text-white font-mono">0</span></div>
            </div>
            <div class="grid grid-cols-12 gap-1 text-[9px] text-gray-500 uppercase font-bold px-2 py-1 bg-gray-900 rounded-t">
                <div class="col-span-5">Pool</div>
                <div class="col-span-2 text-right">Volume</div>
                <div class="col-span-2 text-right">Fees</div>
                <div class="col-span-3 text-right">APR</div>
            </div>
            <div id="ww-list" class="max-h-[500px] overflow-y-auto text-xs bg-[#0D0D0D] p-2 border border-gray-800 rounded-b custom-scroll space-y-0"></div>
        </div>
    </div>
</div>

<!-- WS: PRICES - Token Price Manager -->
<div id="ws-prices" class="workspace">
    <div class="bg-[#161616] border border-green-900/50 rounded-lg p-4 mb-4">
        <div class="flex justify-between items-center mb-3">
            <div class="flex items-center gap-3">
                <i class="fas fa-coins text-green-400 text-xl"></i>
                <div>
                    <h2 class="text-green-400 font-bold text-sm">Token Price Manager</h2>
                    <p class="text-gray-500 text-[10px]">Auto-fetch from CoinGecko + manual entry for unlisted tokens</p>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <div id="prices-fetch-status" class="px-3 py-1 rounded text-[10px] font-bold bg-gray-800 text-gray-400">
                    Not fetched
                </div>
                <button onclick="fetchAllPrices()" class="bg-green-900/30 hover:bg-green-900/50 text-green-400 px-3 py-1.5 rounded text-[10px] border border-green-900/50">
                    <i class="fas fa-sync-alt mr-1"></i> Fetch All Prices
                </button>
            </div>
        </div>
        
        <!-- Fetch Status -->
        <div class="grid grid-cols-4 gap-2 mb-4">
            <div class="bg-[#0D0D0D] rounded p-2 flex items-center justify-between text-[10px]">
                <span class="text-gray-500">CoinGecko API</span>
                <span id="price-status-coingecko" class="text-gray-600">-</span>
            </div>
            <div class="bg-[#0D0D0D] rounded p-2 flex items-center justify-between text-[10px]">
                <span class="text-gray-500">LST Ratios (Chain)</span>
                <span id="price-status-lst" class="text-gray-600">-</span>
            </div>
            <div class="bg-[#0D0D0D] rounded p-2 flex items-center justify-between text-[10px]">
                <span class="text-gray-500">Banner Config</span>
                <span id="price-status-config" class="text-gray-600">-</span>
            </div>
            <div class="bg-[#0D0D0D] rounded p-2 flex items-center justify-between text-[10px]">
                <span class="text-gray-500">Last Update</span>
                <span id="price-status-time" class="text-gray-600">-</span>
            </div>
        </div>
    </div>
    
    <!-- Banner Tokens (CoinGecko) -->
    <div class="grid grid-cols-2 gap-4 mb-4">
        <div class="bg-[#161616] p-3 rounded border border-green-800">
            <div class="flex justify-between items-center mb-3">
                <h3 class="text-green-400 font-bold text-xs">üåê Banner Tokens (CoinGecko)</h3>
                <span class="text-[9px] text-gray-500">Auto-fetched from API</span>
            </div>
            <div class="text-[9px] text-gray-400 mb-2">Select tokens to include in snapshot:</div>
            <div id="banner-tokens-list" class="space-y-1 max-h-[400px] overflow-y-auto custom-scroll">
                <!-- Populated by JS -->
                <div class="text-gray-600 text-[10px] italic">Click "Fetch All Prices" to load...</div>
            </div>
        </div>
        
        <!-- Additional Tokens (Manual) -->
        <div class="bg-[#161616] p-3 rounded border border-yellow-800">
            <div class="flex justify-between items-center mb-3">
                <h3 class="text-yellow-400 font-bold text-xs">‚úèÔ∏è Additional Tokens (Manual)</h3>
                <button onclick="addManualToken()" class="text-[9px] bg-yellow-900/30 text-yellow-400 px-2 py-1 rounded border border-yellow-900/50 hover:bg-yellow-900/50">
                    + Add Token
                </button>
            </div>
            <div class="text-[9px] text-gray-400 mb-2">Tokens not on CoinGecko (ampCAPA, ampROAR, etc.) - leave blank = "unknown"</div>
            <div id="manual-tokens-list" class="space-y-2 max-h-[400px] overflow-y-auto custom-scroll">
                <!-- Manual token entries -->
                <div class="grid grid-cols-12 gap-2 items-center bg-[#0D0D0D] rounded p-2">
                    <input type="text" id="manual-token-ampCAPA" class="col-span-3 input-dark text-[10px]" value="ampCAPA" readonly>
                    <div class="col-span-3 text-[9px] text-gray-500">= CAPA √ó ratio</div>
                    <input type="number" id="manual-price-ampCAPA" step="0.0001" class="col-span-3 input-dark text-[10px] text-right" placeholder="USD price">
                    <div class="col-span-2 text-[9px]">
                        <span id="manual-status-ampCAPA" class="text-gray-600">‚ùå Unknown</span>
                    </div>
                    <button onclick="calcDerivedPrice('ampCAPA', 'CAPA')" class="col-span-1 text-[9px] text-cyan-400 hover:text-cyan-300" title="Calculate from CAPA √ó ratio">
                        <i class="fas fa-calculator"></i>
                    </button>
                </div>
                <div class="grid grid-cols-12 gap-2 items-center bg-[#0D0D0D] rounded p-2">
                    <input type="text" id="manual-token-ampROAR" class="col-span-3 input-dark text-[10px]" value="ampROAR" readonly>
                    <div class="col-span-3 text-[9px] text-gray-500">= ROAR √ó ratio</div>
                    <input type="number" id="manual-price-ampROAR" step="0.0001" class="col-span-3 input-dark text-[10px] text-right" placeholder="USD price">
                    <div class="col-span-2 text-[9px]">
                        <span id="manual-status-ampROAR" class="text-gray-600">‚ùå Unknown</span>
                    </div>
                    <button onclick="calcDerivedPrice('ampROAR', 'ROAR')" class="col-span-1 text-[9px] text-cyan-400 hover:text-cyan-300" title="Calculate from ROAR √ó ratio">
                        <i class="fas fa-calculator"></i>
                    </button>
                </div>
            </div>
            <div id="additional-manual-tokens" class="space-y-2 mt-2">
                <!-- Dynamic manual tokens added here -->
            </div>
        </div>
    </div>
    
    <!-- LST Ratios Summary -->
    <div class="bg-[#161616] p-3 rounded border border-teal-800 mb-4">
        <div class="flex justify-between items-center mb-3">
            <h3 class="text-teal-400 font-bold text-xs">üìê LST Ratios (Auto-Fetched from Chain)</h3>
            <button onclick="fetchLstRatiosFromChain()" class="text-[9px] bg-teal-900/30 text-teal-400 px-2 py-1 rounded border border-teal-900/50 hover:bg-teal-900/50">
                <i class="fas fa-link mr-1"></i> Fetch from Chain
            </button>
        </div>
        <div class="grid grid-cols-6 gap-2" id="lst-ratios-summary">
            <div class="bg-[#0D0D0D] rounded p-2 text-center">
                <div class="text-[9px] text-gray-500">ampLUNA</div>
                <div id="lst-sum-ampLUNA" class="text-sm font-mono text-teal-400">--</div>
                <div id="lst-sum-ampLUNA-status" class="text-[8px] text-gray-600">pending</div>
            </div>
            <div class="bg-[#0D0D0D] rounded p-2 text-center">
                <div class="text-[9px] text-gray-500">arbLUNA</div>
                <div id="lst-sum-arbLUNA" class="text-sm font-mono text-orange-400">--</div>
                <div id="lst-sum-arbLUNA-status" class="text-[8px] text-gray-600">pending</div>
            </div>
            <div class="bg-[#0D0D0D] rounded p-2 text-center">
                <div class="text-[9px] text-gray-500">bLUNA</div>
                <div id="lst-sum-bLUNA" class="text-sm font-mono text-blue-400">--</div>
                <div id="lst-sum-bLUNA-status" class="text-[8px] text-gray-600">pending</div>
            </div>
            <div class="bg-[#0D0D0D] rounded p-2 text-center">
                <div class="text-[9px] text-gray-500">ampCAPA</div>
                <div id="lst-sum-ampCAPA" class="text-sm font-mono text-purple-400">--</div>
                <div id="lst-sum-ampCAPA-status" class="text-[8px] text-gray-600">pending</div>
            </div>
            <div class="bg-[#0D0D0D] rounded p-2 text-center">
                <div class="text-[9px] text-gray-500">ampROAR</div>
                <div id="lst-sum-ampROAR" class="text-sm font-mono text-yellow-400">--</div>
                <div id="lst-sum-ampROAR-status" class="text-[8px] text-gray-600">pending</div>
            </div>
            <div class="bg-[#0D0D0D] rounded p-2 text-center">
                <div class="text-[9px] text-gray-500">xASTRO</div>
                <div id="lst-sum-xASTRO" class="text-sm font-mono text-cyan-400">--</div>
                <div id="lst-sum-xASTRO-status" class="text-[8px] text-gray-600">pending</div>
            </div>
        </div>
    </div>
    
    <!-- Price Snapshot Preview -->
    <div class="preview-card">
        <div class="flex justify-between items-center mb-2 border-b border-gray-800 pb-2">
            <h3 class="text-xs font-bold text-white">üíæ Price Snapshot Preview</h3>
            <div class="flex gap-2">
                <span id="price-snapshot-count" class="text-[10px] text-gray-500">0 tokens</span>
                <button onclick="copyPriceSnapshot()" class="text-[9px] bg-gray-800 text-gray-300 px-2 py-1 rounded hover:bg-gray-700">
                    <i class="fas fa-copy mr-1"></i> Copy JSON
                </button>
            </div>
        </div>
        <pre id="price-snapshot-preview" class="text-[9px] text-gray-400 font-mono bg-[#0D0D0D] p-3 rounded max-h-[200px] overflow-auto custom-scroll">
{ "prices": {}, "lst_ratios": {}, "timestamp": null }
        </pre>
    </div>
</div>

<!-- WS: DASHBOARD STATS -->
<div id="ws-dashboard" class="workspace">
    <div class="bg-[#161616] border border-cyan-900/50 rounded-lg p-4 mb-4">
        <div class="flex justify-between items-center mb-3">
            <div class="flex items-center gap-3">
                <i class="fas fa-tachometer-alt text-cyan-400 text-xl"></i>
                <div>
                    <h2 class="text-cyan-400 font-bold text-sm">Dashboard Stats Snapshot</h2>
                    <p class="text-gray-500 text-[10px]">Capture dashboard tile data + aDAO TLA deposits for epoch snapshot</p>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <div id="dashboard-status" class="px-3 py-1 rounded text-[10px] font-bold bg-gray-800 text-gray-400">
                    Not captured
                </div>
                <button onclick="fetchDashboardData()" class="bg-cyan-900/30 hover:bg-cyan-900/50 text-cyan-400 px-3 py-1.5 rounded text-[10px] border border-cyan-900/50">
                    <i class="fas fa-download mr-1"></i> Fetch Live Data
                </button>
            </div>
        </div>
        
        <!-- Data Source Status -->
        <div class="grid grid-cols-5 gap-2 mb-4">
            <div class="bg-[#0D0D0D] rounded p-2 flex items-center justify-between text-[10px]">
                <span class="text-gray-500">On-Chain Stats</span>
                <span id="dash-status-chain" class="text-gray-600">-</span>
            </div>
            <div class="bg-[#0D0D0D] rounded p-2 flex items-center justify-between text-[10px]">
                <span class="text-gray-500">Treasury</span>
                <span id="dash-status-treasury" class="text-gray-600">-</span>
            </div>
            <div class="bg-[#0D0D0D] rounded p-2 flex items-center justify-between text-[10px]">
                <span class="text-gray-500">Prices</span>
                <span id="dash-status-prices" class="text-gray-600">-</span>
            </div>
            <div class="bg-[#0D0D0D] rounded p-2 flex items-center justify-between text-[10px]">
                <span class="text-gray-500">ampLUNA Rate</span>
                <span id="dash-status-ampluna" class="text-gray-600">-</span>
            </div>
            <div class="bg-[#0D0D0D] rounded p-2 flex items-center justify-between text-[10px]">
                <span class="text-gray-500">DAODAO</span>
                <span id="dash-status-daodao" class="text-gray-600">-</span>
            </div>
        </div>
    </div>
    
    <!-- Dashboard Tiles Grid -->
    <div class="grid grid-cols-4 gap-4 mb-4">
        <!-- NFT Stats -->
        <div class="bg-[#161616] p-3 rounded border border-gray-800">
            <h4 class="text-[10px] text-gray-500 uppercase mb-2">NFT Collection</h4>
            <div class="space-y-1 text-[11px]">
                <div class="flex justify-between"><span class="text-gray-400">Total Minted:</span><span id="dash-nft-minted" class="text-white font-mono">--</span></div>
                <div class="flex justify-between"><span class="text-gray-400">Unminted:</span><span id="dash-nft-unminted" class="text-white font-mono">--</span></div>
                <div class="flex justify-between"><span class="text-gray-400">Broken:</span><span id="dash-nft-broken" class="text-white font-mono">--</span></div>
            </div>
        </div>
        
        <!-- Backing Values -->
        <div class="bg-[#161616] p-3 rounded border border-gray-800">
            <h4 class="text-[10px] text-gray-500 uppercase mb-2">Backing Per NFT</h4>
            <div class="space-y-1 text-[11px]">
                <div class="flex justify-between"><span class="text-gray-400">ampLUNA:</span><span id="dash-backing-ampluna" class="text-cyan-400 font-mono">--</span></div>
                <div class="flex justify-between"><span class="text-gray-400">LUNA:</span><span id="dash-backing-luna" class="text-white font-mono">--</span></div>
                <div class="flex justify-between"><span class="text-gray-400">USD:</span><span id="dash-backing-usd" class="text-green-400 font-mono">--</span></div>
            </div>
        </div>
        
        <!-- DAO Stats -->
        <div class="bg-[#161616] p-3 rounded border border-gray-800">
            <h4 class="text-[10px] text-gray-500 uppercase mb-2">DAO Stats</h4>
            <div class="space-y-1 text-[11px]">
                <div class="flex justify-between"><span class="text-gray-400">DAODAO Staked:</span><span id="dash-dao-staked" class="text-white font-mono">--</span></div>
                <div class="flex justify-between"><span class="text-gray-400">Members:</span><span id="dash-dao-members" class="text-white font-mono">--</span></div>
                <div class="flex justify-between"><span class="text-gray-400">Treasury:</span><span id="dash-dao-treasury" class="text-green-400 font-mono">--</span></div>
            </div>
        </div>
        
        <!-- TLA Stats -->
        <div class="bg-[#161616] p-3 rounded border border-gray-800">
            <h4 class="text-[10px] text-gray-500 uppercase mb-2">TLA Deposits</h4>
            <div class="space-y-1 text-[11px]">
                <div class="flex justify-between"><span class="text-gray-400">Total USD:</span><span id="dash-tla-usd" class="text-green-400 font-mono">--</span></div>
                <div class="flex justify-between"><span class="text-gray-400">APR:</span><span id="dash-tla-apr" class="text-yellow-400 font-mono">--</span></div>
                <div class="flex justify-between"><span class="text-gray-400">VP:</span><span id="dash-tla-vp" class="text-cyan-400 font-mono">--</span></div>
            </div>
        </div>
    </div>
    
    <!-- Manual TLA Deposits Entry -->
    <div class="grid grid-cols-2 gap-4 mb-4">
        <div class="bg-[#161616] p-3 rounded border border-yellow-800">
            <div class="flex justify-between items-center mb-3">
                <h3 class="text-yellow-400 font-bold text-xs">‚úèÔ∏è Manual TLA Deposits Entry</h3>
                <span class="text-[9px] text-gray-500">If auto-fetch fails, enter from Eris TLA page</span>
            </div>
            
            <!-- Mode Toggle -->
            <div class="flex gap-2 mb-3">
                <button id="dash-mode-paste" onclick="setDashMode('paste')" class="flex-1 text-[10px] py-1.5 rounded bg-yellow-900/50 text-yellow-400 border border-yellow-700">Paste Mode</button>
                <button id="dash-mode-manual" onclick="setDashMode('manual')" class="flex-1 text-[10px] py-1.5 rounded bg-gray-800 text-gray-500 border border-gray-700">Manual Entry</button>
            </div>
            
            <!-- Paste Mode -->
            <div id="dash-paste-section">
                <textarea id="dash-tla-tokens-paste" class="input-dark h-20 font-mono text-[9px] mb-2" placeholder="Paste token balances from Eris TLA page..."></textarea>
                <textarea id="dash-tla-usd-paste" class="input-dark h-12 font-mono text-[9px] mb-2" placeholder="Paste: 14 765.85$ est. APR 58.53 %"></textarea>
                <button onclick="parseDashTla()" class="btn-action bg-yellow-900/30 text-yellow-300 border border-yellow-900/50">Parse TLA Data</button>
            </div>
            
            <!-- Manual Mode -->
            <div id="dash-manual-section" class="hidden">
                <div class="grid grid-cols-2 gap-2 mb-2">
                    <div>
                        <label class="text-[9px] text-gray-500">Total Deposit USD</label>
                        <input type="number" id="dash-manual-usd" step="0.01" class="input-dark text-[10px]" placeholder="14765.85">
                    </div>
                    <div>
                        <label class="text-[9px] text-gray-500">Est. APR %</label>
                        <input type="number" id="dash-manual-apr" step="0.01" class="input-dark text-[10px]" placeholder="58.53">
                    </div>
                </div>
                <div class="text-[9px] text-gray-500 mb-2">Token Balances:</div>
                <div class="grid grid-cols-4 gap-1 text-[9px]">
                    <input type="number" id="dash-manual-LUNA" class="input-dark" placeholder="LUNA">
                    <input type="number" id="dash-manual-ampLUNA" class="input-dark" placeholder="ampLUNA">
                    <input type="number" id="dash-manual-CAPA" class="input-dark" placeholder="CAPA">
                    <input type="number" id="dash-manual-ampCAPA" class="input-dark" placeholder="ampCAPA">
                    <input type="number" id="dash-manual-ROAR" class="input-dark" placeholder="ROAR">
                    <input type="number" id="dash-manual-ampROAR" class="input-dark" placeholder="ampROAR">
                    <input type="number" id="dash-manual-xASTRO" class="input-dark" placeholder="xASTRO">
                </div>
            </div>
        </div>
        
        <!-- Parsed TLA Preview -->
        <div class="bg-[#161616] p-3 rounded border border-gray-800">
            <h3 class="text-gray-400 font-bold text-xs mb-3">üìã Parsed TLA Deposits</h3>
            <div id="dash-tla-preview" class="text-[10px] text-gray-500">
                No data parsed yet
            </div>
        </div>
    </div>
    
    <!-- Dashboard Snapshot Preview -->
    <div class="preview-card">
        <div class="flex justify-between items-center mb-2 border-b border-gray-800 pb-2">
            <h3 class="text-xs font-bold text-white">üíæ Dashboard Snapshot Preview</h3>
            <button onclick="downloadDashboardSnapshot()" class="text-[9px] bg-cyan-900/30 text-cyan-300 px-2 py-1 rounded hover:bg-cyan-900/50 border border-cyan-900/50">
                <i class="fas fa-download mr-1"></i> Download Snapshot
            </button>
        </div>
        <pre id="dashboard-snapshot-preview" class="text-[9px] text-gray-400 font-mono bg-[#0D0D0D] p-3 rounded max-h-[200px] overflow-auto custom-scroll">
{ "timestamp": null, "tiles": {}, "tla_deposits": {} }
        </pre>
    </div>
</div>

<!-- WS: NFT STATS -->
<div id="ws-nft" class="workspace">
    <div class="bg-[#161616] border border-purple-900/50 rounded-lg p-4 mb-4">
        <div class="flex justify-between items-center mb-3">
            <div class="flex items-center gap-3">
                <i class="fas fa-images text-purple-400 text-xl"></i>
                <div>
                    <h2 class="text-purple-400 font-bold text-sm">NFT Collection Stats Snapshot</h2>
                    <p class="text-gray-500 text-[10px]">Capture BBL collection stats, listings, and epoch sales</p>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <div id="nft-status" class="px-3 py-1 rounded text-[10px] font-bold bg-gray-800 text-gray-400">
                    Not captured
                </div>
                <button onclick="fetchNftData()" class="bg-purple-900/30 hover:bg-purple-900/50 text-purple-400 px-3 py-1.5 rounded text-[10px] border border-purple-900/50">
                    <i class="fas fa-download mr-1"></i> Fetch from deving.zone
                </button>
            </div>
        </div>
        
        <!-- Prices for NFT -->
        <div class="bg-[#0D0D0D] rounded p-3 mb-3">
            <div class="flex justify-between items-center mb-2">
                <span class="text-[10px] text-gray-400 font-bold">NFT Sale Prices (for USD calculations)</span>
                <button onclick="loadNftPricesFromPriceManager()" class="text-[9px] text-green-400 hover:text-green-300">
                    <i class="fas fa-sync-alt mr-1"></i> Load from Price Manager
                </button>
            </div>
            <div class="grid grid-cols-6 gap-2">
                <div>
                    <label class="text-[8px] text-gray-500">LUNA</label>
                    <input type="number" id="nft-price-luna" step="0.0001" class="input-dark text-[10px]" placeholder="0.166">
                </div>
                <div>
                    <label class="text-[8px] text-gray-500">ampLUNA</label>
                    <input type="number" id="nft-price-ampluna" step="0.0001" class="input-dark text-[10px]" placeholder="0.315">
                </div>
                <div>
                    <label class="text-[8px] text-gray-500">bLUNA</label>
                    <input type="number" id="nft-price-bluna" step="0.0001" class="input-dark text-[10px]" placeholder="0.266">
                </div>
                <div>
                    <label class="text-[8px] text-gray-500">arbLUNA</label>
                    <input type="number" id="nft-price-arbluna" step="0.0001" class="input-dark text-[10px]" placeholder="0.446">
                </div>
                <div>
                    <label class="text-[8px] text-gray-500">SOLID</label>
                    <input type="number" id="nft-price-solid" step="0.0001" class="input-dark text-[10px]" placeholder="0.014">
                </div>
                <div>
                    <label class="text-[8px] text-gray-500">USDC</label>
                    <input type="number" id="nft-price-usdc" step="0.0001" class="input-dark text-[10px]" value="1.00">
                </div>
            </div>
        </div>
    </div>
    
    <!-- BBL Collection Data -->
    <div class="grid grid-cols-2 gap-4 mb-4">
        <div class="bg-[#161616] p-3 rounded border border-purple-800">
            <h3 class="text-purple-400 font-bold text-xs mb-3">ü¶Å BBL Collection Stats</h3>
            <textarea id="nft-bbl-collection-json" class="input-dark h-24 font-mono text-[9px] mb-2" placeholder='Paste BBL collection JSON from deving.zone API...'></textarea>
            <div class="flex gap-2">
                <button onclick="parseNftBblCollection()" class="btn-action flex-1 bg-purple-900/30 text-purple-300 border border-purple-900/50">Parse Collection</button>
                <span id="nft-bbl-collection-status" class="text-[9px] text-gray-500 self-center">-</span>
            </div>
            <div id="nft-bbl-collection-results" class="hidden mt-3 bg-[#0D0D0D] rounded p-2 text-[10px]">
                <div class="flex justify-between"><span class="text-gray-500">All-time Volume:</span><span id="nft-bbl-volume" class="text-purple-400 font-mono">--</span></div>
                <div class="flex justify-between"><span class="text-gray-500">Most Recent Sale:</span><span id="nft-bbl-recent" class="text-white font-mono">--</span></div>
            </div>
        </div>
        
        <div class="bg-[#161616] p-3 rounded border border-purple-800">
            <h3 class="text-purple-400 font-bold text-xs mb-3">üìã BBL Listings</h3>
            <textarea id="nft-bbl-listings-json" class="input-dark h-24 font-mono text-[9px] mb-2" placeholder='Paste BBL listings JSON...'></textarea>
            <div class="flex gap-2">
                <button onclick="parseNftBblListings()" class="btn-action flex-1 bg-purple-900/30 text-purple-300 border border-purple-900/50">Parse Listings</button>
                <span id="nft-bbl-listings-status" class="text-[9px] text-gray-500 self-center">-</span>
            </div>
            <div id="nft-bbl-floors" class="mt-3 bg-[#0D0D0D] rounded p-2 text-[10px] space-y-2">
                <div class="grid grid-cols-3 gap-2">
                    <div><label class="text-[8px] text-gray-500">Floor Unbroken ID</label><input type="text" id="nft-floor-unbroken-id" class="input-dark text-[9px]"></div>
                    <div><label class="text-[8px] text-gray-500">bLUNA</label><input type="number" id="nft-floor-unbroken-amount" class="input-dark text-[9px]"></div>
                    <div><label class="text-[8px] text-gray-500">USD</label><span id="nft-floor-unbroken-usd" class="text-green-400">--</span></div>
                </div>
                <div class="grid grid-cols-3 gap-2">
                    <div><label class="text-[8px] text-gray-500">Floor Broken ID</label><input type="text" id="nft-floor-broken-id" class="input-dark text-[9px]"></div>
                    <div><label class="text-[8px] text-gray-500">bLUNA</label><input type="number" id="nft-floor-broken-amount" class="input-dark text-[9px]"></div>
                    <div><label class="text-[8px] text-gray-500">USD</label><span id="nft-floor-broken-usd" class="text-green-400">--</span></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Epoch Sales -->
    <div class="grid grid-cols-2 gap-4 mb-4">
        <div class="bg-[#161616] p-3 rounded border border-orange-800">
            <h3 class="text-orange-400 font-bold text-xs mb-3">üî• BBL Epoch Sales</h3>
            <div class="grid grid-cols-4 gap-2 mb-2">
                <input type="text" id="nft-bbl-sale-id" class="input-dark text-[9px]" placeholder="NFT ID">
                <input type="number" id="nft-bbl-sale-amount" class="input-dark text-[9px]" placeholder="Amount">
                <select id="nft-bbl-sale-token" class="input-dark text-[9px]">
                    <option value="bLUNA">bLUNA</option>
                    <option value="LUNA">LUNA</option>
                    <option value="ampLUNA">ampLUNA</option>
                    <option value="USDC">USDC</option>
                </select>
                <button onclick="addNftBblSale()" class="btn-action text-[9px] !mt-0 bg-orange-900/30 text-orange-300">+ Add</button>
            </div>
            <div id="nft-bbl-sales-list" class="max-h-[150px] overflow-y-auto custom-scroll text-[9px] space-y-1">
                <div class="text-gray-600 italic">No sales added</div>
            </div>
        </div>
        
        <div class="bg-[#161616] p-3 rounded border border-cyan-800">
            <h3 class="text-cyan-400 font-bold text-xs mb-3">üöÄ Boost Epoch Sales</h3>
            <div class="grid grid-cols-4 gap-2 mb-2">
                <input type="text" id="nft-boost-sale-id" class="input-dark text-[9px]" placeholder="NFT ID">
                <input type="number" id="nft-boost-sale-amount" class="input-dark text-[9px]" placeholder="Amount">
                <select id="nft-boost-sale-token" class="input-dark text-[9px]">
                    <option value="LUNA">LUNA</option>
                    <option value="ampLUNA">ampLUNA</option>
                    <option value="bLUNA">bLUNA</option>
                    <option value="USDC">USDC</option>
                </select>
                <button onclick="addNftBoostSale()" class="btn-action text-[9px] !mt-0 bg-cyan-900/30 text-cyan-300">+ Add</button>
            </div>
            <div id="nft-boost-sales-list" class="max-h-[150px] overflow-y-auto custom-scroll text-[9px] space-y-1">
                <div class="text-gray-600 italic">No sales added</div>
            </div>
        </div>
    </div>
    
    <!-- NFT Snapshot Preview -->
    <div class="preview-card">
        <div class="flex justify-between items-center mb-2 border-b border-gray-800 pb-2">
            <h3 class="text-xs font-bold text-white">üíæ NFT Snapshot Preview</h3>
            <button onclick="downloadNftSnapshot()" class="text-[9px] bg-purple-900/30 text-purple-300 px-2 py-1 rounded hover:bg-purple-900/50 border border-purple-900/50">
                <i class="fas fa-download mr-1"></i> Download Snapshot
            </button>
        </div>
        <pre id="nft-snapshot-preview" class="text-[9px] text-gray-400 font-mono bg-[#0D0D0D] p-3 rounded max-h-[200px] overflow-auto custom-scroll">
{ "snapshot_time": null, "bbl": {}, "boost": {} }
        </pre>
    </div>
</div>

<!-- WS: TERRA NEWS -->
<div id="ws-news" class="workspace">
    <div class="bg-[#161616] border border-orange-900/50 rounded-lg p-4 mb-4">
        <div class="flex justify-between items-center mb-3">
            <div class="flex items-center gap-3">
                <i class="fas fa-newspaper text-orange-400 text-xl"></i>
                <div>
                    <h2 class="text-orange-400 font-bold text-sm">Terra Ecosystem News</h2>
                    <p class="text-gray-500 text-[10px]">Collect and organize news articles for the ecosystem</p>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <button onclick="loadNewsFromGithub()" class="bg-gray-800 hover:bg-gray-700 text-gray-300 px-3 py-1.5 rounded text-[10px] border border-gray-700">
                    <i class="fas fa-cloud-download-alt mr-1"></i> Load Existing
                </button>
                <button onclick="downloadNewsJson()" class="bg-orange-900/30 hover:bg-orange-900/50 text-orange-400 px-3 py-1.5 rounded text-[10px] border border-orange-900/50">
                    <i class="fas fa-download mr-1"></i> Download JSON
                </button>
            </div>
        </div>
    </div>
    
    <!-- Add New Article -->
    <div class="bg-[#161616] p-4 rounded border border-orange-800 mb-4">
        <h3 class="text-orange-400 font-bold text-xs mb-3">‚ûï Add New Article</h3>
        <div class="grid grid-cols-2 gap-4">
            <div class="space-y-2">
                <div>
                    <label class="text-[9px] text-gray-500">Title *</label>
                    <input type="text" id="news-title" class="input-dark text-[11px]" placeholder="Article title...">
                </div>
                <div>
                    <label class="text-[9px] text-gray-500">Source URL *</label>
                    <input type="url" id="news-url" class="input-dark text-[11px]" placeholder="https://...">
                </div>
                <div>
                    <label class="text-[9px] text-gray-500">Date</label>
                    <input type="date" id="news-date" class="input-dark text-[11px]">
                </div>
                <div>
                    <label class="text-[9px] text-gray-500">Tags (comma separated)</label>
                    <input type="text" id="news-tags" class="input-dark text-[11px]" placeholder="governance, update, tfl">
                </div>
            </div>
            <div class="space-y-2">
                <div>
                    <label class="text-[9px] text-gray-500">Summary / Content</label>
                    <textarea id="news-content" class="input-dark h-24 text-[11px]" placeholder="Article summary or key points..."></textarea>
                </div>
                <div>
                    <label class="text-[9px] text-gray-500">Image URLs (one per line)</label>
                    <textarea id="news-images" class="input-dark h-16 text-[11px]" placeholder="https://image1.jpg&#10;https://image2.jpg"></textarea>
                </div>
            </div>
        </div>
        <button onclick="addNewsArticle()" class="btn-action bg-orange-900/30 text-orange-300 border border-orange-900/50 mt-3">
            <i class="fas fa-plus mr-1"></i> Add Article
        </button>
    </div>
    
    <!-- Articles List -->
    <div class="preview-card">
        <div class="flex justify-between items-center mb-2 border-b border-gray-800 pb-2">
            <h3 class="text-xs font-bold text-white">üì∞ News Articles (<span id="news-count">0</span>)</h3>
            <button onclick="clearAllNews()" class="text-[9px] text-red-400 hover:text-red-300">Clear All</button>
        </div>
        <div id="news-articles-list" class="space-y-2 max-h-[400px] overflow-y-auto custom-scroll">
            <div class="text-gray-600 text-[10px] italic">No articles added yet</div>
        </div>
    </div>
</div>

<!-- WS: DAO PROPOSALS -->
<div id="ws-dao" class="workspace">
    <div class="bg-[#161616] border border-blue-900/50 rounded-lg p-4 mb-4">
        <div class="flex justify-between items-center mb-3">
            <div class="flex items-center gap-3">
                <i class="fas fa-landmark text-blue-400 text-xl"></i>
                <div>
                    <h2 class="text-blue-400 font-bold text-sm">DAO Proposal History</h2>
                    <p class="text-gray-500 text-[10px]">Track aDAO proposals, voting records, and outcomes</p>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <button onclick="loadProposalsFromGithub()" class="bg-gray-800 hover:bg-gray-700 text-gray-300 px-3 py-1.5 rounded text-[10px] border border-gray-700">
                    <i class="fas fa-cloud-download-alt mr-1"></i> Load Existing
                </button>
                <button onclick="fetchProposalsFromDaodao()" class="bg-blue-900/30 hover:bg-blue-900/50 text-blue-400 px-3 py-1.5 rounded text-[10px] border border-blue-900/50">
                    <i class="fas fa-sync-alt mr-1"></i> Fetch from DAODAO
                </button>
            </div>
        </div>
    </div>
    
    <!-- Add/Edit Proposal -->
    <div class="bg-[#161616] p-4 rounded border border-blue-800 mb-4">
        <h3 class="text-blue-400 font-bold text-xs mb-3">‚ûï Add/Edit Proposal</h3>
        <div class="grid grid-cols-3 gap-4">
            <div class="space-y-2">
                <div>
                    <label class="text-[9px] text-gray-500">Proposal ID *</label>
                    <input type="text" id="dao-prop-id" class="input-dark text-[11px]" placeholder="A-31">
                </div>
                <div>
                    <label class="text-[9px] text-gray-500">Title *</label>
                    <input type="text" id="dao-prop-title" class="input-dark text-[11px]" placeholder="Proposal title...">
                </div>
                <div>
                    <label class="text-[9px] text-gray-500">Status</label>
                    <select id="dao-prop-status" class="input-dark text-[11px]">
                        <option value="passed">‚úÖ Passed</option>
                        <option value="rejected">‚ùå Rejected</option>
                        <option value="executed">üü¢ Executed</option>
                        <option value="pending">‚è≥ Pending</option>
                        <option value="vetoed">üö´ Vetoed</option>
                    </select>
                </div>
            </div>
            <div class="space-y-2">
                <div>
                    <label class="text-[9px] text-gray-500">Date</label>
                    <input type="date" id="dao-prop-date" class="input-dark text-[11px]">
                </div>
                <div>
                    <label class="text-[9px] text-gray-500">DAODAO Link</label>
                    <input type="url" id="dao-prop-link" class="input-dark text-[11px]" placeholder="https://daodao.zone/...">
                </div>
                <div>
                    <label class="text-[9px] text-gray-500">Category</label>
                    <select id="dao-prop-category" class="input-dark text-[11px]">
                        <option value="governance">Governance</option>
                        <option value="treasury">Treasury</option>
                        <option value="investment">Investment</option>
                        <option value="operations">Operations</option>
                        <option value="other">Other</option>
                    </select>
                </div>
            </div>
            <div class="space-y-2">
                <div>
                    <label class="text-[9px] text-gray-500">Description/Summary</label>
                    <textarea id="dao-prop-description" class="input-dark h-20 text-[11px]" placeholder="What the proposal does..."></textarea>
                </div>
                <div class="grid grid-cols-3 gap-1">
                    <div>
                        <label class="text-[8px] text-gray-500">Yes %</label>
                        <input type="number" id="dao-prop-yes" class="input-dark text-[10px]" placeholder="85">
                    </div>
                    <div>
                        <label class="text-[8px] text-gray-500">No %</label>
                        <input type="number" id="dao-prop-no" class="input-dark text-[10px]" placeholder="10">
                    </div>
                    <div>
                        <label class="text-[8px] text-gray-500">Abstain %</label>
                        <input type="number" id="dao-prop-abstain" class="input-dark text-[10px]" placeholder="5">
                    </div>
                </div>
            </div>
        </div>
        <button onclick="addDaoProposal()" class="btn-action bg-blue-900/30 text-blue-300 border border-blue-900/50 mt-3">
            <i class="fas fa-plus mr-1"></i> Add Proposal
        </button>
    </div>
    
    <!-- Proposals List -->
    <div class="preview-card">
        <div class="flex justify-between items-center mb-2 border-b border-gray-800 pb-2">
            <h3 class="text-xs font-bold text-white">üèõÔ∏è Proposals (<span id="dao-count">0</span>)</h3>
            <div class="flex gap-2">
                <select id="dao-filter-status" class="input-dark text-[9px] w-24" onchange="renderDaoProposals()">
                    <option value="all">All</option>
                    <option value="passed">Passed</option>
                    <option value="rejected">Rejected</option>
                    <option value="executed">Executed</option>
                </select>
                <button onclick="downloadDaoJson()" class="text-[9px] bg-blue-900/30 text-blue-300 px-2 py-1 rounded border border-blue-900/50">
                    <i class="fas fa-download mr-1"></i> Export
                </button>
            </div>
        </div>
        <div id="dao-proposals-list" class="space-y-2 max-h-[400px] overflow-y-auto custom-scroll">
            <div class="text-gray-600 text-[10px] italic">No proposals added yet</div>
        </div>
    </div>
</div>

<script>
const $ = id => document.getElementById(id);
const setTxt = (id, v) => { const e = $(id); if(e) e.innerText = v; };
const setHtml = (id, v) => { const e = $(id); if(e) e.innerHTML = v; };
const clean = s => { if(!s)return 0; let m=1; if(/[\d\.]\s*[Kk]($|[\s\W])/.test(s))m=1e3; if(/[\d\.]\s*[Mm]($|[\s\W])/.test(s))m=1e6; return parseFloat(s.replace(/[^0-9\.]/g,''))*m||0; };
const fmt$ = n => '$'+n.toLocaleString(undefined,{maximumFractionDigits:0});

let store = {
    meta: { ep: 0, ph: 'end' },
    mode: 'staging', // 'staging' or 'normal'
    lpRegistry: {},  // { "LUNA-USDC": { bucket, sources: { Astroport: { vote_pct } }, active } }
    votion: { lockups: [], ratioArb: 2.4362, ratioAmp: 1.8707 },
    // Comprehensive LST ratios and APYs
    lstRatios: {
        ampLUNA: { ratio: 1.9015, base: 'LUNA', apy: 29.68, updated: null },
        arbLUNA: { ratio: 2.6873, base: 'LUNA', apy: 146.24, updated: null },
        bLUNA: { ratio: 1.6048, base: 'LUNA', apy: null, updated: null }, // bLUNA doesn't show APY on BBL
        ampCAPA: { ratio: 1.1055, base: 'CAPA', apy: 4.83, updated: null },
        ampROAR: { ratio: 1.1087, base: 'ROAR', apy: 9.92, updated: null },
        xASTRO: { ratio: 1.22, base: 'ASTRO', apy: 22.49, updated: null },
        chainStakingApr: 22.04,
        chainStakingAprDate: null,
        allUpdated: false
    },
    pdBribesHistory: [],
    pdNewProp: null,
    staging: {
        day1: null,
        day2: null,
        day3: null,
        day4: null
    },
    historical: { lps: {}, meta: {} },
    current: { lps: {}, meta: {} },
    ww: [],
    liveEpoch: null, // { epoch, end_time, phase, daysRemaining }
    prevExt: null    // Loaded previous ext file for reference
};

// GitHub URLs
const GITHUB_BASE = 'https://raw.githubusercontent.com/defipatriot/tla-ext_json_storage/main/';
const STAGING_URLS = {
    day1: GITHUB_BASE + 'tla_ext_staging_day1.json',
    day2: GITHUB_BASE + 'tla_ext_staging_day2.json',
    day3: GITHUB_BASE + 'tla_ext_staging_day3.json',
    day4: GITHUB_BASE + 'tla_ext_staging_day4.json'
};
const HISTORICAL_URL = GITHUB_BASE + 'tla_ext_historical.json';
const CURRENT_URL = GITHUB_BASE + 'tla_ext_current.json';
const PD_BRIBES_GITHUB_URL = GITHUB_BASE + 'tla_pd_bribes.json';
const STAKING_APR_CSV_URL = 'https://raw.githubusercontent.com/defipatriot/tla_json_storage/main/luna_staking_apr.csv';

// Epoch calculation constants
const EPOCH_ANCHOR_DATE = new Date(Date.UTC(2025, 10, 17, 0, 0, 0)); // Nov 17, 2025 = Epoch 160
const EPOCH_ANCHOR_NUM = 160;
const SECONDS_PER_WEEK = 604800;

let pasteStatus = { votion: false, pd: false, astro: false, ww: false };

function updatePasteStatus(id, done) {
    const el = $(id);
    if (el) {
        if (done) el.classList.add('status-done');
        else el.classList.remove('status-done');
    }
}

function clearPaste(id) {
    const el = $(id);
    if (el) el.value = '';
}

function parseRatioPaste() {
    let txt = $('ratioPaste').value;
    // Parse "1 ampLUNA = 1.8707 LUNA" or "1 arbLUNA = 2.4362 LUNA"
    let match = txt.match(/1\s*(amp|arb)LUNA\s*=\s*([\d\.]+)\s*LUNA/i);
    if (match) {
        let type = match[1].toLowerCase();
        let ratio = parseFloat(match[2]);
        if (type === 'amp') {
            $('ratioAmp').value = ratio;
            store.votion.ratioAmp = ratio;
            store.votion.ratioAmpUpdated = new Date().toISOString();
        } else if (type === 'arb') {
            $('ratioArb').value = ratio;
            store.votion.ratioArb = ratio;
            store.votion.ratioArbUpdated = new Date().toISOString();
        }
        $('ratioPaste').value = ''; // Clear after parse
        updateRatios();
        recalcVotion();
    }
}

function updateRatios() {
    // Track ratio updates
    store.votion.ratioArb = parseFloat($('ratioArb').value) || 2.4362;
    store.votion.ratioAmp = parseFloat($('ratioAmp').value) || 1.8707;
    
    // Also sync to LST ratios store
    store.lstRatios.arbLUNA.ratio = store.votion.ratioArb;
    store.lstRatios.ampLUNA.ratio = store.votion.ratioAmp;
    
    // Check if ratios were manually updated (different from defaults)
    const arbDefault = 2.4362;
    const ampDefault = 1.8707;
    const arbUpdated = Math.abs(store.votion.ratioArb - arbDefault) > 0.0001;
    const ampUpdated = Math.abs(store.votion.ratioAmp - ampDefault) > 0.0001;
    
    // Update status display
    let statusEl = $('ratio-status');
    if (statusEl) {
        if (arbUpdated && ampUpdated) {
            statusEl.innerText = `‚úì Both ratios updated`;
            statusEl.className = 'text-green-400 text-[8px]';
        } else if (arbUpdated || ampUpdated) {
            let which = arbUpdated ? 'arbLUNA' : 'ampLUNA';
            statusEl.innerText = `‚úì ${which} updated, check other`;
            statusEl.className = 'text-yellow-400 text-[8px]';
        } else {
            statusEl.innerText = 'Using default ratios - update from Eris!';
            statusEl.className = 'text-orange-400 text-[8px]';
        }
    }
    
    updateWorkflowStatus();
    recalcVotion();
}

// ============ LST RATIO FUNCTIONS ============

function updateLstRatio(token, value) {
    const ratio = parseFloat(value) || 0;
    if (token === 'chainStakingApr') {
        store.lstRatios.chainStakingApr = ratio;
        store.lstRatios.chainStakingAprDate = new Date().toISOString();
    } else if (store.lstRatios[token]) {
        store.lstRatios[token].ratio = ratio;
        store.lstRatios[token].updated = new Date().toISOString();
        
        // Sync ampLUNA/arbLUNA to votion ratios for VP calculation
        if (token === 'ampLUNA') {
            store.votion.ratioAmp = ratio;
            $('ratioAmp').value = ratio;
        } else if (token === 'arbLUNA') {
            store.votion.ratioArb = ratio;
            $('ratioArb').value = ratio;
        }
    }
    updateLstCardStatus(token);
    updateLstOverallStatus();
    updateWorkflowStatus();
}

function updateLstApy(token, value) {
    const apy = parseFloat(value) || null;
    if (store.lstRatios[token]) {
        store.lstRatios[token].apy = apy;
        store.lstRatios[token].updated = new Date().toISOString();
    }
    updateLstCardStatus(token);
    updateLstOverallStatus();
}

function parseLstPaste(token) {
    const pasteEl = $(`lst-paste-${token}`);
    if (!pasteEl) return;
    
    const txt = pasteEl.value;
    if (!txt.trim()) return;
    
    let ratio = null;
    let apy = null;
    
    // Parse based on token type
    if (token === 'ampLUNA' || token === 'arbLUNA') {
        // Eris format: "1 ampLUNA = 1.9015 LUNA" or "1 arbLUNA = 2.6873 LUNA"
        const ratioMatch = txt.match(/1\s*(amp|arb)LUNA\s*=\s*([\d\.]+)\s*LUNA/i);
        if (ratioMatch) ratio = parseFloat(ratioMatch[2]);
        
        // APY: "Amplified APY 29.68%" or "Arbitrage APY 146.24%"
        const apyMatch = txt.match(/(Amplified|Arbitrage)\s*APY[:\s]*([\d\.]+)\s*%/i);
        if (apyMatch) apy = parseFloat(apyMatch[2]);
    }
    else if (token === 'bLUNA') {
        // Backbone format: "1 LUNA = 0.623302 bLUNA" - need to invert
        const bbMatch = txt.match(/1\s*LUNA\s*=\s*([\d\.]+)\s*bLUNA/i);
        if (bbMatch) {
            const inverse = parseFloat(bbMatch[1]);
            if (inverse > 0) ratio = 1 / inverse;
        }
        // Also try direct format "1 bLUNA = X LUNA"
        const directMatch = txt.match(/1\s*bLUNA\s*=\s*([\d\.]+)\s*LUNA/i);
        if (directMatch) ratio = parseFloat(directMatch[1]);
        
        // APY from Backbone (if present)
        const apyMatch = txt.match(/APY[:\s]*([\d\.]+)\s*%/i);
        if (apyMatch) apy = parseFloat(apyMatch[1]);
    }
    else if (token === 'ampCAPA' || token === 'ampROAR') {
        // Eris format: "1 ampCAPA = 1.1055 CAPA" or "1 ampROAR = 1.1087 ROAR"
        const base = token === 'ampCAPA' ? 'CAPA' : 'ROAR';
        const ratioRegex = new RegExp(`1\\s*${token}\\s*=\\s*([\\d\\.]+)\\s*${base}`, 'i');
        const ratioMatch = txt.match(ratioRegex);
        if (ratioMatch) ratio = parseFloat(ratioMatch[1]);
        
        // APY
        const apyMatch = txt.match(/Amplified\s*APY[:\s]*([\d\.]+)\s*%/i);
        if (apyMatch) apy = parseFloat(apyMatch[1]);
    }
    else if (token === 'xASTRO') {
        // Astroport format: "1:1.22 xASTRO:ASTRO" or multiline with APY
        // Can be: "22.49%\nAPY\n1:1.22\nxASTRO:ASTRO"
        const astroMatch = txt.match(/1:([\d\.]+)\s*\n?\s*xASTRO:ASTRO/i);
        if (astroMatch) ratio = parseFloat(astroMatch[1]);
        
        // Also try "xASTRO:ASTRO = 1:1.22"
        const altMatch = txt.match(/xASTRO:ASTRO\s*=?\s*1:([\d\.]+)/i);
        if (altMatch) ratio = parseFloat(altMatch[1]);
        
        // Also try inline "1:1.22 xASTRO:ASTRO"
        const inlineMatch = txt.match(/1:([\d\.]+)\s+xASTRO:ASTRO/i);
        if (inlineMatch) ratio = parseFloat(inlineMatch[1]);
        
        // APY for xASTRO: "22.49% APY" or "22.49%\nAPY"
        const apyMatch = txt.match(/([\d\.]+)\s*%\s*\n?\s*APY/i);
        if (apyMatch) apy = parseFloat(apyMatch[1]);
    }
    
    // Update values if found
    if (ratio !== null && ratio > 0) {
        $(`lst-ratio-${token}`).value = ratio.toFixed(4);
        updateLstRatio(token, ratio);
    }
    if (apy !== null) {
        $(`lst-apy-${token}`).value = apy.toFixed(2);
        updateLstApy(token, apy);
    }
    
    // Clear paste box and update status
    if (ratio !== null || apy !== null) {
        pasteEl.value = '';
        updateLstCardStatus(token);
    }
}

function updateLstCardStatus(token) {
    const statusEl = $(`lst-status-${token}`);
    const cardEl = $(`lst-card-${token}`);
    if (!statusEl || !cardEl) return;
    
    const data = store.lstRatios[token];
    if (!data) return;
    
    const isUpdated = data.updated !== null;
    
    if (isUpdated) {
        statusEl.textContent = '‚úì updated';
        statusEl.className = 'text-[9px] px-2 py-0.5 rounded bg-green-900/50 text-green-400 text-center mb-2';
        cardEl.className = 'bg-[#161616] rounded-lg p-3 border-2 border-green-700';
    } else {
        statusEl.textContent = 'pending';
        statusEl.className = 'text-[9px] px-2 py-0.5 rounded bg-gray-800 text-gray-500 text-center mb-2';
        cardEl.className = 'bg-[#161616] rounded-lg p-3 border-2 border-gray-700';
    }
}

function updateLstOverallStatus() {
    const tokens = ['ampLUNA', 'arbLUNA', 'bLUNA', 'ampCAPA', 'ampROAR', 'xASTRO'];
    let updatedCount = 0;
    
    tokens.forEach(token => {
        if (store.lstRatios[token]?.updated) updatedCount++;
    });
    
    const allUpdated = updatedCount === tokens.length;
    store.lstRatios.allUpdated = allUpdated;
    
    const statusEl = $('lst-all-status');
    if (statusEl) {
        if (allUpdated) {
            statusEl.innerHTML = '<i class="fas fa-check-circle mr-1"></i> All Complete';
            statusEl.className = 'px-3 py-1 rounded text-[10px] font-bold bg-green-900/30 text-green-400 border border-green-700';
        } else {
            statusEl.innerHTML = `<i class="fas fa-exclamation-circle mr-1"></i> ${updatedCount}/${tokens.length} Complete`;
            statusEl.className = 'px-3 py-1 rounded text-[10px] font-bold bg-red-900/30 text-red-400 border border-red-700';
        }
    }
}

async function fetchChainStakingApr() {
    try {
        const resp = await fetch(STAKING_APR_CSV_URL);
        if (!resp.ok) throw new Error('Failed to fetch');
        
        const text = await resp.text();
        const lines = text.trim().split('\n');
        
        // Get last non-empty line (most recent APR)
        let lastLine = null;
        for (let i = lines.length - 1; i >= 0; i--) {
            if (lines[i].trim() && !lines[i].includes('title')) {
                lastLine = lines[i];
                break;
            }
        }
        
        if (lastLine) {
            // Parse CSV: "2025-12-19","22.0373"
            const match = lastLine.match(/"([^"]+)","([^"]+)"/);
            if (match) {
                const date = match[1];
                const apr = parseFloat(match[2]);
                
                $('lst-chain-apr').value = apr.toFixed(2);
                $('lst-chain-apr-date').textContent = `Last: ${date}`;
                
                store.lstRatios.chainStakingApr = apr;
                store.lstRatios.chainStakingAprDate = date;
            }
        }
    } catch (e) {
        console.error('Failed to fetch staking APR:', e);
        $('lst-chain-apr-date').textContent = 'Fetch failed';
    }
}

function initLstRatiosTab() {
    // Initialize values from store
    const tokens = ['ampLUNA', 'arbLUNA', 'bLUNA', 'ampCAPA', 'ampROAR', 'xASTRO'];
    tokens.forEach(token => {
        const data = store.lstRatios[token];
        if (data) {
            const ratioEl = $(`lst-ratio-${token}`);
            const apyEl = $(`lst-apy-${token}`);
            if (ratioEl) ratioEl.value = data.ratio;
            if (apyEl && data.apy !== null) apyEl.value = data.apy;
            updateLstCardStatus(token);
        }
    });
    
    // Sync ampLUNA/arbLUNA to Votion tab display
    $('ratioArb').value = store.lstRatios.arbLUNA.ratio;
    $('ratioAmp').value = store.lstRatios.ampLUNA.ratio;
    store.votion.ratioArb = store.lstRatios.arbLUNA.ratio;
    store.votion.ratioAmp = store.lstRatios.ampLUNA.ratio;
    
    $('lst-chain-apr').value = store.lstRatios.chainStakingApr;
    updateLstOverallStatus();
}

function updateWorkflowStatus() {
    // Step 1: LST Ratios (all 6 tokens)
    const tokens = ['ampLUNA', 'arbLUNA', 'bLUNA', 'ampCAPA', 'ampROAR', 'xASTRO'];
    let lstUpdatedCount = 0;
    tokens.forEach(token => {
        if (store.lstRatios[token]?.updated) lstUpdatedCount++;
    });
    const lstComplete = lstUpdatedCount === tokens.length;
    
    // Also check arbLUNA and ampLUNA specifically for Votion VP calculation
    const arbLunaUpdated = store.lstRatios.arbLUNA?.updated !== null;
    const ampLunaUpdated = store.lstRatios.ampLUNA?.updated !== null;
    const votionRatiosReady = arbLunaUpdated && ampLunaUpdated;
    
    let stepLst = $('step-lst');
    let stepLstVal = $('step-lst-val');
    if (stepLst) {
        if (lstComplete) {
            stepLst.className = 'px-2 py-0.5 rounded bg-green-900/50 text-green-300 border border-green-700 text-[10px] cursor-pointer font-bold';
            if (stepLstVal) stepLstVal.innerText = '‚úì All 6';
        } else if (lstUpdatedCount > 0) {
            stepLst.className = 'px-2 py-0.5 rounded bg-yellow-900/50 text-yellow-300 border border-yellow-700 text-[10px] cursor-pointer';
            if (stepLstVal) stepLstVal.innerText = `${lstUpdatedCount}/6`;
        } else {
            stepLst.className = 'px-2 py-0.5 rounded bg-red-900/50 text-red-300 border border-red-700 text-[10px] cursor-pointer';
            if (stepLstVal) stepLstVal.innerText = '0/6';
        }
    }
    
    // Step 2: Votion lockups
    let lockCount = store.votion.lockups?.length || 0;
    let stepVotion = $('step-votion');
    let stepVotionVal = $('step-votion-val');
    if (stepVotion) {
        if (lockCount >= 3 && votionRatiosReady) {
            stepVotion.className = 'px-2 py-0.5 rounded bg-green-900/50 text-green-300 border border-green-700 text-[10px] cursor-pointer font-bold';
            if (stepVotionVal) stepVotionVal.innerText = lockCount + ' locks ‚úì';
        } else if (lockCount > 0) {
            stepVotion.className = 'px-2 py-0.5 rounded bg-yellow-900/50 text-yellow-300 border border-yellow-700 text-[10px] cursor-pointer';
            if (stepVotionVal) stepVotionVal.innerText = lockCount + ' locks';
        } else {
            stepVotion.className = 'px-2 py-0.5 rounded bg-gray-800 text-gray-500 border border-gray-700 text-[10px] cursor-pointer';
            if (stepVotionVal) stepVotionVal.innerText = '0 locks';
        }
    }
    
    // Update votion checklist
    updateVotionChecklist();
    
    // Step 3: PD Bribes
    let epoch = store.meta.ep;
    let pdCovered = false;
    let pdRange = '';
    for (let b of store.pdBribesHistory || []) {
        if (epoch >= b.start_epoch && epoch <= b.end_epoch) {
            pdCovered = true;
            pdRange = `[${b.start_epoch}-${b.end_epoch}]`;
            break;
        }
    }
    
    let stepPd = $('step-pd');
    let stepPdVal = $('step-pd-val');
    if (stepPd) {
        if (pdCovered) {
            stepPd.className = 'px-2 py-0.5 rounded bg-green-900/50 text-green-300 border border-green-700 text-[10px] cursor-pointer font-bold';
            if (stepPdVal) stepPdVal.innerText = pdRange;
        } else {
            stepPd.className = 'px-2 py-0.5 rounded bg-red-900/50 text-red-300 border border-red-700 text-[10px] cursor-pointer';
            if (stepPdVal) stepPdVal.innerText = 'Missing!';
        }
    }
    
    // Step 4: Export readiness (require at minimum: arbLUNA + ampLUNA ratios, votion locks, PD coverage)
    let ready = votionRatiosReady && lockCount >= 3 && pdCovered;
    let stepExport = $('step-export');
    let stepExportVal = $('step-export-val');
    if (stepExport) {
        if (ready) {
            stepExport.className = 'px-2 py-0.5 rounded bg-green-900/50 text-green-300 border border-green-700 text-[10px] cursor-pointer font-bold animate-pulse';
            if (stepExportVal) stepExportVal.innerText = 'Ready!';
        } else {
            stepExport.className = 'px-2 py-0.5 rounded bg-gray-800 text-gray-500 border border-gray-700 text-[10px] cursor-pointer';
            let missing = [];
            if (!votionRatiosReady) missing.push('lst');
            if (lockCount < 3) missing.push('votion');
            if (!pdCovered) missing.push('pd');
            if (stepExportVal) stepExportVal.innerText = 'Need: ' + missing.join(', ');
        }
    }
}

function updateVotionChecklist() {
    // Check which lockup types we have
    let hasArbMax = false;
    let hasAmpMax = false;
    let hasOther = false;
    
    for (let lock of store.votion.lockups || []) {
        if (lock.type === 'arbLUNA' && lock.duration === 'Max') hasArbMax = true;
        else if (lock.type === 'ampLUNA' && lock.duration === 'Max') hasAmpMax = true;
        else hasOther = true;
    }
    
    let el1 = $('votion-checklist-arbmax');
    let el2 = $('votion-checklist-ampmax');
    let el3 = $('votion-checklist-other');
    
    if (el1) {
        el1.innerText = hasArbMax ? '‚úì arbLUNA Max' : '‚òê arbLUNA Max';
        el1.className = hasArbMax ? 'text-green-400 ml-2' : 'text-gray-600 ml-2';
    }
    if (el2) {
        el2.innerText = hasAmpMax ? '‚úì ampLUNA Max' : '‚òê ampLUNA Max';
        el2.className = hasAmpMax ? 'text-green-400 ml-2' : 'text-gray-600 ml-2';
    }
    if (el3) {
        el3.innerText = hasOther ? '‚úì Other' : '‚òê Other';
        el3.className = hasOther ? 'text-green-400 ml-2' : 'text-gray-600 ml-2';
    }
}

window.onload = async function() {
    // Fetch live epoch info first
    await fetchLiveEpochInfo();
    
    // Set initial working epoch from live data or calculate fallback
    if (store.liveEpoch) {
        $('extEpoch').value = store.liveEpoch.epoch;
        $('extPhase').value = store.liveEpoch.phase;
    } else {
        // Fallback calculation
        const anchorDate = new Date(Date.UTC(2025, 10, 17, 0, 0, 0)); 
        const now = new Date();
        const msPerWeek = 604800000;
        let diffTime = now.getTime() - anchorDate.getTime();
        let weeksPassed = Math.floor(diffTime / msPerWeek);
        let currentEp = 160 + weeksPassed;
        $('extEpoch').value = currentEp;
        $('extPhase').value = 'end';
    }
    updateMeta();
    
    // Initialize PD Bribes
    renderPdBribesHistory();
    updatePdCoverage();
    
    // Initialize mode and Astro tab
    setMode('staging');
    renderLpRegistry();
    updateAstroTab();
    
    // Initialize LST Ratios tab
    initLstRatiosTab();
    
    // Auto-fetch data from GitHub
    fetchAllFromGithub();
    
    // Initialize workflow status
    updateWorkflowStatus();
    
    // Start timer to update countdown every minute
    setInterval(updateLiveCountdown, 60000);
};

function updateLiveCountdown() {
    if (!store.liveEpoch || !store.liveEpoch.end_time) return;
    
    const now = new Date();
    const endTime = new Date(store.liveEpoch.end_time);
    const msRemaining = endTime - now;
    const daysRemaining = msRemaining / 86400000;
    
    if (daysRemaining < 0) {
        // Epoch ended, refresh data
        fetchLiveEpochInfo();
        return;
    }
    
    // Update days remaining
    store.liveEpoch.daysRemaining = daysRemaining;
    
    // Update phase if changed
    // Phase based on days REMAINING:
    // 5-7 remaining = START (0-2 days into epoch)
    // 2-5 remaining = MID (2-5 days into epoch)
    // 0-2 remaining = END (5-7 days into epoch)
    let newPhase = 'end';
    if (daysRemaining >= 5) newPhase = 'start';
    else if (daysRemaining > 2) newPhase = 'mid';
    
    if (newPhase !== store.liveEpoch.phase) {
        store.liveEpoch.phase = newPhase;
        let phaseEl = $('live-phase');
        setTxt('live-phase', newPhase.charAt(0).toUpperCase() + newPhase.slice(1));
        phaseEl.className = 'text-sm font-mono font-bold ' + 
            (newPhase === 'start' ? 'text-green-400' : newPhase === 'mid' ? 'text-yellow-400' : 'text-red-400');
        checkEpochMismatch();
    }
    
    // Update countdown display
    let days = Math.floor(daysRemaining);
    let hours = Math.floor((daysRemaining - days) * 24);
    let mins = Math.floor(((daysRemaining - days) * 24 - hours) * 60);
    setTxt('live-ends', `${days}d ${hours}h ${mins}m`);
}

function switchTab(t) {
    document.querySelectorAll('.tab-btn').forEach((b, i) => {
        b.classList.remove('active');
        if (b.textContent.toLowerCase().includes(t)) b.classList.add('active');
    });
    // Click doesn't always have event target in this context
    if (event && event.target) event.target.classList.add('active');
    document.querySelectorAll('.workspace').forEach(w => w.classList.remove('active'));
    let ws = $('ws-' + t);
    if (ws) ws.classList.add('active');
}

function updateMeta() {
    store.meta.ep = parseInt($('extEpoch').value) || 0;
    store.meta.ph = $('extPhase').value;
    setTxt('target-epoch', store.meta.ep);
    setTxt('target-phase', store.meta.ph.charAt(0).toUpperCase() + store.meta.ph.slice(1));
    // Update coverage when epoch changes
    updatePdCoverage();
    updateAstroStatus();
    updateWorkflowStatus();
    checkEpochMismatch();
}

// ============ LIVE EPOCH FUNCTIONS ============

const EPOCH_DATA_URL = 'https://raw.githubusercontent.com/defipatriot/tla_json_storage/main/epoch_1-300_date.json';
let epochData = [];

async function fetchLiveEpochInfo() {
    try {
        setTxt('live-epoch', '...');
        setTxt('live-ends', '...');
        setTxt('live-phase', '...');
        
        // Fetch epoch data from GitHub (same source as Core tool)
        let resp = await fetch(EPOCH_DATA_URL);
        if (!resp.ok) throw new Error('Failed to fetch epoch data');
        
        epochData = await resp.json();
        console.log('Loaded epoch data:', epochData.length, 'epochs');
        
        // Find current epoch
        const now = new Date();
        let currentEpoch = null;
        
        for (let ep of epochData) {
            let start = new Date(ep.start_time);
            let end = new Date(ep.end_time);
            
            if (now >= start && now < end) {
                currentEpoch = ep;
                break;
            }
        }
        
        // If we're past all epochs, use the last one
        if (!currentEpoch && epochData.length > 0) {
            currentEpoch = epochData[epochData.length - 1];
        }
        
        if (!currentEpoch) throw new Error('No epoch data found');
        
        // Calculate time remaining
        let endTime = new Date(currentEpoch.end_time);
        let msRemaining = endTime - now;
        let daysRemaining = msRemaining / 86400000;
        
        // Phase based on days REMAINING:
        // 5-7 remaining = START (0-2 days into epoch)
        // 2-5 remaining = MID (2-5 days into epoch)
        // 0-2 remaining = END (5-7 days into epoch)
        let phase = 'end';
        if (daysRemaining >= 5) phase = 'start';
        else if (daysRemaining > 2) phase = 'mid';
        
        // Store live info
        store.liveEpoch = {
            epoch: currentEpoch.epoch,
            end_time: endTime.toISOString(),
            daysRemaining: daysRemaining,
            phase: phase
        };
        
        // Update display
        setTxt('live-epoch', currentEpoch.epoch);
        
        // Format time remaining
        let days = Math.floor(daysRemaining);
        let hours = Math.floor((daysRemaining - days) * 24);
        let mins = Math.floor(((daysRemaining - days) * 24 - hours) * 60);
        setTxt('live-ends', `${days}d ${hours}h ${mins}m`);
        
        // Phase with color
        let phaseEl = $('live-phase');
        setTxt('live-phase', phase.charAt(0).toUpperCase() + phase.slice(1));
        phaseEl.className = 'text-sm font-mono font-bold ' + 
            (phase === 'start' ? 'text-green-400' : phase === 'mid' ? 'text-yellow-400' : 'text-red-400');
        
        checkEpochMismatch();
        console.log('Live epoch info:', store.liveEpoch);
        
    } catch (e) {
        console.error('Failed to fetch live epoch:', e);
        setTxt('live-epoch', 'ERR');
        setTxt('live-ends', '-');
        setTxt('live-phase', '-');
        
        // Fallback to calculated epoch
        const anchorDate = new Date(Date.UTC(2025, 10, 17, 0, 0, 0)); 
        const now = new Date();
        const msPerWeek = 604800000;
        let diffTime = now.getTime() - anchorDate.getTime();
        let weeksPassed = Math.floor(diffTime / msPerWeek);
        let currentEp = 160 + weeksPassed;
        
        // Calculate approximate days remaining in epoch
        let msIntoEpoch = diffTime % msPerWeek;
        let msRemaining = msPerWeek - msIntoEpoch;
        let daysRemaining = msRemaining / 86400000;
        
        // Phase based on days REMAINING
        let phase = 'end';
        if (daysRemaining >= 5) phase = 'start';
        else if (daysRemaining > 2) phase = 'mid';
        
        store.liveEpoch = {
            epoch: currentEp,
            daysRemaining: daysRemaining,
            phase: phase,
            isFallback: true
        };
        
        setTxt('live-epoch', currentEp + '*');
        let days = Math.floor(daysRemaining);
        let hours = Math.floor((daysRemaining - days) * 24);
        setTxt('live-ends', `~${days}d ${hours}h`);
        setTxt('live-phase', phase.charAt(0).toUpperCase() + phase.slice(1));
        $('live-phase').className = 'text-sm font-mono font-bold ' + 
            (phase === 'start' ? 'text-green-400' : phase === 'mid' ? 'text-yellow-400' : 'text-red-400');
    }
}

function syncToLive() {
    if (!store.liveEpoch) {
        alert('No live epoch data. Click refresh first.');
        return;
    }
    
    $('extEpoch').value = store.liveEpoch.epoch;
    $('extPhase').value = store.liveEpoch.phase;
    updateMeta();
    
    console.log('Synced to live:', store.liveEpoch.epoch, store.liveEpoch.phase);
}

function checkEpochMismatch() {
    let warningEl = $('epoch-mismatch-warning');
    if (!warningEl || !store.liveEpoch) {
        if (warningEl) warningEl.classList.add('hidden');
        return;
    }
    
    let workingEp = store.meta.ep;
    let workingPh = store.meta.ph;
    let liveEp = store.liveEpoch.epoch;
    let livePh = store.liveEpoch.phase;
    
    let warnings = [];
    
    // Check epoch mismatch
    if (workingEp !== liveEp) {
        warnings.push(`Epoch ${workingEp} ‚â† live ${liveEp}`);
    }
    
    // Check phase mismatch
    if (workingPh !== livePh) {
        warnings.push(`Phase "${workingPh}" ‚â† live "${livePh}"`);
    }
    
    if (warnings.length > 0) {
        setTxt('mismatch-text', warnings.join(' | '));
        warningEl.classList.remove('hidden');
    } else {
        warningEl.classList.add('hidden');
    }
}

// ============ LOAD PREVIOUS EXT ============

function loadPreviousExt(event) {
    let file = event.target.files[0];
    if (!file) return;
    
    let reader = new FileReader();
    reader.onload = function(e) {
        try {
            let data = JSON.parse(e.target.result);
            store.prevExt = data;
            
            // Display info
            let meta = data.meta || {};
            let votionPools = Object.keys(data.votion?.pools || {}).length;
            let info = `Ep ${meta.epoch || '?'} ${meta.phase || '?'} | ${votionPools} pools`;
            setTxt('prev-ext-status', info);
            $('prev-ext-status').className = 'text-purple-300 text-[9px] truncate';
            
            console.log('Loaded previous ext:', data);
            
            // Optionally pre-fill data from previous ext
            if (confirm(`Loaded Ep ${meta.epoch} ${meta.phase}.\n\nPre-fill Votion ratios from this file?`)) {
                if (data.votion?.ratios) {
                    if (data.votion.ratios.arbLUNA) {
                        $('ratioArb').value = data.votion.ratios.arbLUNA;
                        store.votion.ratioArb = data.votion.ratios.arbLUNA;
                    }
                    if (data.votion.ratios.ampLUNA) {
                        $('ratioAmp').value = data.votion.ratios.ampLUNA;
                        store.votion.ratioAmp = data.votion.ratios.ampLUNA;
                    }
                    updateRatios();
                }
            }
            
        } catch (err) {
            console.error('Failed to parse previous ext:', err);
            setTxt('prev-ext-status', 'Parse error');
            $('prev-ext-status').className = 'text-red-400 text-[9px] truncate';
        }
    };
    reader.readAsText(file);
}

// ============ EXPORT VALIDATION ============

function validateExport() {
    let issues = [];
    let warnings = [];
    
    // Check epoch is set
    if (!store.meta.ep || store.meta.ep === 0) {
        issues.push('Epoch not set');
    }
    
    // Check epoch matches live
    if (store.liveEpoch && store.meta.ep !== store.liveEpoch.epoch) {
        warnings.push(`Working epoch ${store.meta.ep} differs from live ${store.liveEpoch.epoch}`);
    }
    
    // Check phase matches live
    if (store.liveEpoch && store.meta.ph !== store.liveEpoch.phase) {
        warnings.push(`Working phase "${store.meta.ph}" differs from live "${store.liveEpoch.phase}"`);
    }
    
    // Check Votion data
    if (store.votion.lockups.length === 0) {
        issues.push('No Votion lockups captured');
    } else {
        // Check for major lockups
        let hasArbMax = store.votion.lockups.some(l => l.type === 'arbLUNA' && l.duration === 'Max');
        let hasAmpMax = store.votion.lockups.some(l => l.type === 'ampLUNA' && l.duration === 'Max');
        if (!hasArbMax) warnings.push('Missing arbLUNA Max lockup');
        if (!hasAmpMax) warnings.push('Missing ampLUNA Max lockup');
    }
    
    // Check PD Bribes coverage
    let pdCovered = store.pdBribesHistory.some(prop => 
        store.meta.ep >= prop.start_epoch && store.meta.ep <= prop.end_epoch
    );
    if (!pdCovered) {
        warnings.push(`PD Bribes don't cover epoch ${store.meta.ep}`);
    }
    
    // Check ratios are reasonable
    if (store.votion.ratioArb < 2 || store.votion.ratioArb > 3) {
        warnings.push(`arbLUNA ratio ${store.votion.ratioArb} seems unusual (expected 2.0-3.0)`);
    }
    if (store.votion.ratioAmp < 1.5 || store.votion.ratioAmp > 2.5) {
        warnings.push(`ampLUNA ratio ${store.votion.ratioAmp} seems unusual (expected 1.5-2.5)`);
    }
    
    return { issues, warnings, canExport: issues.length === 0 };
}

function downloadExtJson() {
    // Run validation
    let validation = validateExport();
    
    // Show issues/warnings
    if (validation.issues.length > 0) {
        alert('‚ùå Cannot export - critical issues:\n\n‚Ä¢ ' + validation.issues.join('\n‚Ä¢ '));
        return;
    }
    
    if (validation.warnings.length > 0) {
        let proceed = confirm(
            '‚ö†Ô∏è Export warnings:\n\n‚Ä¢ ' + validation.warnings.join('\n‚Ä¢ ') + 
            '\n\nProceed with export anyway?'
        );
        if (!proceed) return;
    }
    
    // Generate and download
    let data = getExportData();
    let jsonStr = JSON.stringify(data, null, 2);
    let blob = new Blob([jsonStr], { type: "application/json" });
    let url = URL.createObjectURL(blob);
    let a = document.createElement('a');
    a.href = url;
    a.download = `tla-ext-epoch-${store.meta.ep}-${store.meta.ph}.json`; 
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    // Update workflow status
    setTxt('step-export-val', '‚úì saved');
    $('step-export').classList.add('status-done');
}

// ============ MODE FUNCTIONS ============

function setMode(mode) {
    store.mode = mode;
    $('mode-staging').className = mode === 'staging' 
        ? 'px-2 py-1 text-[10px] rounded bg-yellow-900/50 text-yellow-400 border border-yellow-700'
        : 'px-2 py-1 text-[10px] rounded bg-gray-800 text-gray-500 border border-gray-700';
    $('mode-normal').className = mode === 'normal'
        ? 'px-2 py-1 text-[10px] rounded bg-green-900/50 text-green-400 border border-green-700'
        : 'px-2 py-1 text-[10px] rounded bg-gray-800 text-gray-500 border border-gray-700';
    updateAstroTab();
}

// ============ FETCH FUNCTIONS ============

async function fetchAllFromGithub() {
    await fetchStagingData();
    await fetchHistoricalData();
    await fetchCurrentData();
    await fetchPdBribesFromGithub();
}

async function fetchStagingData() {
    for (let day of ['day1', 'day2', 'day3', 'day4']) {
        try {
            console.log(`Fetching staging ${day}: ${STAGING_URLS[day]}`);
            let resp = await fetch(STAGING_URLS[day]);
            console.log(`Staging ${day} response: ${resp.status}`);
            if (resp.ok) {
                let data = await resp.json();
                console.log(`Staging ${day} loaded:`, data);
                store.staging[day] = data;
            } else {
                console.log(`Staging ${day} not OK: ${resp.status}`);
            }
        } catch (e) {
            console.log(`Staging ${day} error:`, e);
        }
    }
    updateStagingStatus();
}

async function fetchHistoricalData() {
    try {
        let resp = await fetch(HISTORICAL_URL);
        if (resp.ok) {
            store.historical = await resp.json();
            setTxt('fetch-historical', '‚úì');
        } else {
            setTxt('fetch-historical', '-');
        }
    } catch (e) {
        setTxt('fetch-historical', '‚úó');
    }
}

async function fetchCurrentData() {
    try {
        let resp = await fetch(CURRENT_URL);
        if (resp.ok) {
            store.current = await resp.json();
            setTxt('fetch-current', '‚úì');
        } else {
            setTxt('fetch-current', '-');
        }
    } catch (e) {
        setTxt('fetch-current', '‚úó');
    }
}

function updateStagingStatus() {
    let days = ['day1', 'day2', 'day3', 'day4'];
    let completed = days.filter(d => store.staging[d] !== null).length;
    setTxt('fetch-staging', `${completed}/4`);
    
    // Update individual day boxes
    days.forEach(day => {
        let data = store.staging[day];
        let statusEl = $(`staging-${day}-status`);
        let lpsEl = $(`staging-${day}-lps`);
        
        if (data && data.lps) {
            let lpCount = Object.keys(data.lps).length;
            if (statusEl) {
                statusEl.innerText = data.captureDate || 'Loaded';
                statusEl.className = 'text-[10px] text-green-400';
            }
            if (lpsEl) {
                lpsEl.innerText = `${lpCount} LPs`;
            }
        } else if (data) {
            // Data exists but no lps object
            if (statusEl) {
                statusEl.innerText = 'Loaded (no LPs)';
                statusEl.className = 'text-[10px] text-yellow-400';
            }
        } else {
            // No data
            if (statusEl) {
                statusEl.innerText = 'Not found';
                statusEl.className = 'text-[10px] text-gray-600';
            }
            if (lpsEl) {
                lpsEl.innerText = '0 LPs';
            }
        }
    });
}

// ============ LP REGISTRY FUNCTIONS ============

function parseVoteTab() {
    let txt = $('voteTabPaste').value;
    let lines = txt.split('\n').map(l => l.trim()).filter(l => l);
    
    store.lpRegistry = {};
    
    const BUCKETS = ['stable', 'project', 'bluechip', 'single'];
    let currentBucket = null;
    let i = 0;
    
    while (i < lines.length) {
        let line = lines[i];
        let lineLower = line.toLowerCase();
        
        // Check for bucket header
        if (BUCKETS.includes(lineLower)) {
            currentBucket = lineLower;
            i++;
            continue;
        }
        
        // Look for LP pattern: "LUNA-USDC LP" or similar
        if (line.includes(' LP') || line === 'ampCAPA' || line === 'xASTRO') {
            let lpName = line.replace(' LP', '').trim();
            
            // Look ahead for dex and vote %
            let dex = null;
            let votePct = 0;
            
            for (let k = 1; k <= 5 && i + k < lines.length; k++) {
                let next = lines[i + k];
                
                if (next === 'Astroport' || next === 'Skeleton Swap' || next === 'SkeletonSwap') {
                    dex = next === 'SkeletonSwap' ? 'Skeleton Swap' : next;  // Normalize
                }
                
                // VP line: "VP 15.85M  76.9 %"
                if (next.startsWith('VP ') && next.includes('%')) {
                    let pctMatch = next.match(/([\d\.]+)\s*%/);
                    if (pctMatch) {
                        votePct = parseFloat(pctMatch[1]);
                    }
                    
                    // We found the VP for this dex, create the entry
                    if (dex && lpName) {
                        // Use composite key: "LUNA-USDC|Astroport"
                        let key = `${lpName}|${dex}`;
                        
                        store.lpRegistry[key] = {
                            lp: lpName,
                            dex: dex,
                            bucket: currentBucket || 'unknown',
                            vote_pct: votePct,
                            active: votePct >= 1
                        };
                    }
                    
                    // Reset for next potential dex entry for same LP
                    dex = null;
                    votePct = 0;
                }
                
                // Stop at next LP
                if (k > 2 && (next.includes(' LP') || next === 'ampCAPA' || next === 'xASTRO' || BUCKETS.includes(next.toLowerCase()))) {
                    break;
                }
            }
        }
        i++;
    }
    
    $('voteTabPaste').value = '';
    renderLpRegistry();
    updateLpSummary();
    setTxt('fetch-lp', '‚úì');
    
    // Update Astroport dropdown
    updateAstroLpDropdown();
}

function renderLpRegistry() {
    let showActive = $('filter-active').checked;
    let showAstro = $('filter-astro').checked;
    let showWW = $('filter-ww').checked;
    
    let html = '';
    const BUCKETS = ['stable', 'project', 'bluechip', 'single'];
    
    BUCKETS.forEach(bucket => {
        let bucketLps = Object.entries(store.lpRegistry)
            .filter(([key, lp]) => lp.bucket === bucket)
            .filter(([key, lp]) => !showActive || lp.active)
            .filter(([key, lp]) => {
                if (lp.dex === 'Astroport' && !showAstro) return false;
                if ((lp.dex === 'Skeleton Swap' || lp.dex === 'SkeletonSwap') && !showWW) return false;
                return true;
            })
            .sort((a, b) => b[1].vote_pct - a[1].vote_pct);
        
        if (bucketLps.length === 0) return;
        
        let bucketColor = bucket === 'stable' ? 'blue' : bucket === 'project' ? 'purple' : bucket === 'bluechip' ? 'yellow' : 'green';
        
        html += `<div class="bg-${bucketColor}-900/20 border-l-2 border-${bucketColor}-500 p-2 rounded">
            <div class="text-[10px] font-bold text-${bucketColor}-400 uppercase mb-2">${bucket} (${bucketLps.length})</div>
            <div class="space-y-1">`;
        
        bucketLps.forEach(([key, lp]) => {
            let activeClass = lp.active ? 'text-white' : 'text-gray-500';
            let dexColor = lp.dex === 'Astroport' ? 'text-cyan-400' : 'text-blue-400';
            let dexLabel = lp.dex === 'Astroport' ? 'Astro' : 'SS';
            
            html += `<div class="flex items-center justify-between py-1 px-2 bg-[#0D0D0D] rounded text-[10px]">
                <span class="${activeClass} font-mono">${lp.lp}</span>
                <div class="flex items-center gap-3">
                    <span class="${dexColor}">${lp.vote_pct.toFixed(1)}% ${dexLabel}</span>
                </div>
            </div>`;
        });
        
        html += `</div></div>`;
    });
    
    setHtml('lp-registry-list', html || '<div class="text-gray-600 text-[10px] italic text-center py-8">No LPs loaded. Paste Vote tab data above.</div>');
}

function updateLpSummary() {
    let total = Object.keys(store.lpRegistry).length;
    let active = Object.values(store.lpRegistry).filter(lp => lp.active).length;
    let astro = Object.values(store.lpRegistry).filter(lp => lp.dex === 'Astroport').length;
    let ww = Object.values(store.lpRegistry).filter(lp => lp.dex === 'Skeleton Swap' || lp.dex === 'SkeletonSwap').length;
    
    setTxt('lp-total', total);
    setTxt('lp-active', active);
    setTxt('lp-astro', astro);
    setTxt('lp-ww', ww);
}

function exportLpRegistry() {
    let json = JSON.stringify({ lpRegistry: store.lpRegistry }, null, 2);
    let blob = new Blob([json], { type: 'application/json' });
    let url = URL.createObjectURL(blob);
    let a = document.createElement('a');
    a.href = url;
    a.download = 'tla_lp_registry.json';
    a.click();
    URL.revokeObjectURL(url);
}

function loadLpRegistryPaste() {
    let txt = prompt('Paste LP Registry JSON:');
    if (!txt) return;
    try {
        let data = JSON.parse(txt);
        if (data.lpRegistry) {
            store.lpRegistry = data.lpRegistry;
        }
        renderLpRegistry();
        updateLpSummary();
        updateAstroLpDropdown();
        setTxt('fetch-lp', '‚úì');
    } catch (e) {
        alert('Invalid JSON');
    }
}

function parseVotion() {
    let txt = $('votionPaste').value;
    if (!txt.trim()) return;
    
    let lines = txt.split('\n').map(l => l.trim()).filter(l => l);
    
    let ratioArb = parseFloat($('ratioArb').value) || 2.4362;
    let ratioAmp = parseFloat($('ratioAmp').value) || 1.8707;
    
    // Parse lockup info
    let lockup = {
        type: '',
        duration: '',
        amount: 0,
        luna: 0,
        vp: 0,
        usd: 0,
        apy: 0,
        period: 0,
        expectedRewards: 0,
        buckets: []
    };
    
    // Find lock type and duration: "arbLUNA - Max" or "ampLUNA - 3 Month"
    for (let i = 0; i < lines.length; i++) {
        let line = lines[i];
        if ((line.includes('arbLUNA -') || line.includes('ampLUNA -')) && !line.includes('%')) {
            lockup.type = line.includes('arbLUNA') ? 'arbLUNA' : 'ampLUNA';
            if (line.toLowerCase().includes('3 month')) lockup.duration = '3mo';
            else if (line.toLowerCase().includes('1 week') || line.toLowerCase().includes('week')) lockup.duration = '1wk';
            else if (line.toLowerCase().includes('max')) lockup.duration = 'Max';
            
            // Look ahead for amount, USD, APY
            for (let k = 1; k <= 12 && i + k < lines.length; k++) {
                let next = lines[i + k];
                if (next.includes(lockup.type) && !next.includes('-') && !next.includes('%') && lockup.amount === 0) {
                    lockup.amount = clean(next);
                }
                if (next.startsWith('$') && lockup.usd === 0) {
                    lockup.usd = clean(next);
                }
                if (next.includes('%') && !next.includes('‚Üí') && !next.includes('APY') && lockup.apy === 0) {
                    lockup.apy = parseFloat(next.replace(/[^0-9\.]/g, '')) || 0;
                }
                if (next === 'stable' || next === 'project' || next === 'bluechip' || next === 'single') break;
            }
            break;
        }
    }
    
    // Parse period
    for (let i = 0; i < lines.length; i++) {
        if (lines[i] === 'Period' && lines[i+1]) {
            lockup.period = parseInt(lines[i+1]) || 0;
        }
        if (lines[i].includes('Total Expected Rewards') && lines[i+1]) {
            lockup.expectedRewards = clean(lines[i+1]);
        }
    }
    
    // Calculate LUNA and VP
    if (lockup.amount > 0 && lockup.type) {
        let ratio = lockup.type === 'arbLUNA' ? ratioArb : ratioAmp;
        lockup.luna = lockup.amount * ratio;
        let vpMult = lockup.duration === 'Max' ? 10 : (lockup.duration === '3mo' ? 2 : 1);
        lockup.vp = lockup.luna * vpMult;
    }
    
    // Parse buckets and vote allocations
    const BUCKET_NAMES = ['stable', 'project', 'bluechip', 'single'];
    
    for (let i = 0; i < lines.length; i++) {
        let line = lines[i].toLowerCase();
        
        if (BUCKET_NAMES.includes(line)) {
            let bucketName = lines[i];
            let expectedRewards = 0;
            let pools = [];
            
            for (let k = 1; k <= 50 && i + k < lines.length; k++) {
                let next = lines[i + k];
                let nextLower = next.toLowerCase();
                
                if (BUCKET_NAMES.includes(nextLower) && k > 2) break;
                
                if (lines[i + k - 1] === 'Expected Rewards' && next.includes('$')) {
                    expectedRewards = clean(next);
                }
                
                // Pool detection - includes single assets like ampCAPA
                if ((next.includes(' LP') || next.match(/^[a-zA-Z]+-[a-zA-Z]+$/) || next === 'ampCAPA' || next === 'xASTRO') && !next.includes('$') && !next.includes('%')) {
                    let poolName = next.replace(' LP', '');
                    let currentPct = null;  // Use null to distinguish "not set" from "0%"
                    let optimizedPct = null;
                    
                    for (let m = 1; m <= 4 && i + k + m < lines.length; m++) {
                        let pctLine = lines[i + k + m];
                        if (pctLine.includes('%') && !pctLine.includes('‚Üí')) {
                            let pct = parseFloat(pctLine.replace(/[^0-9\.]/g, '')) || 0;
                            if (currentPct === null) currentPct = pct;
                            else if (optimizedPct === null) optimizedPct = pct;
                        }
                        if (pctLine === '‚Üí' && lines[i + k + m + 1]) {
                            optimizedPct = parseFloat(lines[i + k + m + 1].replace(/[^0-9\.]/g, '')) || 0;
                        }
                    }
                    
                    // Convert null to 0 for final values
                    currentPct = currentPct ?? 0;
                    optimizedPct = optimizedPct ?? 0;
                    
                    if (currentPct > 0 || optimizedPct > 0) {
                        pools.push({
                            name: poolName,
                            current: currentPct,
                            optimized: optimizedPct,
                            change: optimizedPct - currentPct
                        });
                    }
                }
            }
            
            if (pools.length > 0) {
                lockup.buckets.push({
                    name: bucketName,
                    expectedRewards: expectedRewards,
                    pools: pools
                });
            }
        }
    }
    
    // Only add if we got valid data
    if (lockup.type && lockup.amount > 0) {
        // Check for duplicate (same type + duration) and update
        let existingIdx = store.votion.lockups.findIndex(l => l.type === lockup.type && l.duration === lockup.duration);
        if (existingIdx >= 0) {
            store.votion.lockups[existingIdx] = lockup;
        } else {
            store.votion.lockups.push(lockup);
        }
        
        $('votionPaste').value = '';
        renderVotion();
        updateWorkflowStatus();
        pasteStatus.votion = true;
        updatePasteStatus('ps-votion', true);
    } else {
        alert('Could not parse lockup data. Make sure you copied the entire page.');
    }
}

function clearVotionLocks() {
    if (confirm('Clear all loaded Votion lockups?')) {
        store.votion.lockups = [];
        renderVotion();
        updateWorkflowStatus();
        pasteStatus.votion = false;
        updatePasteStatus('ps-votion', false);
    }
}

function recalcVotion() {
    let ratioArb = parseFloat($('ratioArb').value) || 2.4362;
    let ratioAmp = parseFloat($('ratioAmp').value) || 1.8707;
    store.votion.ratioArb = ratioArb;
    store.votion.ratioAmp = ratioAmp;
    
    store.votion.lockups.forEach(lockup => {
        let ratio = lockup.type === 'arbLUNA' ? ratioArb : ratioAmp;
        lockup.luna = lockup.amount * ratio;
        let vpMult = lockup.duration === 'Max' ? 10 : (lockup.duration === '3mo' ? 2 : 1);
        lockup.vp = lockup.luna * vpMult;
    });
    
    renderVotion();
    updateWorkflowStatus();
}

function removeLockup(idx) {
    store.votion.lockups.splice(idx, 1);
    renderVotion();
    updateWorkflowStatus();
    if (store.votion.lockups.length === 0) {
        pasteStatus.votion = false;
        updatePasteStatus('ps-votion', false);
    }
}

function renderVotion() {
    let totalVp = 0;
    let totalUsd = 0;
    let totalRew = 0;
    
    // Sort lockups: arbLUNA first, then by duration
    let sortedLockups = [...store.votion.lockups].sort((a, b) => {
        if (a.type !== b.type) return a.type === 'arbLUNA' ? -1 : 1;
        const durOrder = { 'Max': 0, '3mo': 1, '1wk': 2 };
        return durOrder[a.duration] - durOrder[b.duration];
    });
    
    let cardsHtml = '';
    
    sortedLockups.forEach((lockup, idx) => {
        totalVp += lockup.vp;
        totalUsd += lockup.usd;
        totalRew += lockup.expectedRewards;
        
        let typeColor = lockup.type === 'arbLUNA' ? 'orange' : 'cyan';
        let typeBorder = lockup.type === 'arbLUNA' ? 'border-orange-500' : 'border-cyan-500';
        let typeBg = lockup.type === 'arbLUNA' ? 'bg-orange-900/10' : 'bg-cyan-900/10';
        
        cardsHtml += `<div class="preview-card ${typeBg} border-l-4 ${typeBorder}">
            <!-- Header -->
            <div class="flex justify-between items-center mb-2 pb-2 border-b border-gray-800">
                <div class="flex items-center gap-3">
                    <span class="text-${typeColor}-400 font-bold text-sm">${lockup.type}</span>
                    <span class="text-gray-400 text-xs bg-gray-800 px-2 py-0.5 rounded">${lockup.duration}</span>
                    <span class="text-gray-500 text-[10px]">Period ${lockup.period}</span>
                </div>
                <button onclick="removeLockup(${idx})" class="text-red-400 hover:text-red-300 text-[10px]">‚úï Remove</button>
            </div>
            
            <!-- Stats Row -->
            <div class="grid grid-cols-5 gap-2 mb-3 text-[10px]">
                <div class="bg-gray-900/50 rounded p-2 text-center">
                    <div class="text-gray-500">Amount</div>
                    <div class="text-white font-mono">${lockup.amount.toLocaleString()}</div>
                </div>
                <div class="bg-gray-900/50 rounded p-2 text-center">
                    <div class="text-gray-500">LUNA Eq.</div>
                    <div class="text-gray-300 font-mono">${lockup.luna.toLocaleString(undefined,{maximumFractionDigits:0})}</div>
                </div>
                <div class="bg-gray-900/50 rounded p-2 text-center">
                    <div class="text-gray-500">Voting Power</div>
                    <div class="text-teal-400 font-mono font-bold">${lockup.vp.toLocaleString(undefined,{maximumFractionDigits:0})}</div>
                </div>
                <div class="bg-gray-900/50 rounded p-2 text-center">
                    <div class="text-gray-500">USD Value</div>
                    <div class="text-green-400 font-mono">${fmt$(lockup.usd)}</div>
                </div>
                <div class="bg-gray-900/50 rounded p-2 text-center">
                    <div class="text-gray-500">Est. Rewards</div>
                    <div class="text-green-400 font-mono">${fmt$(lockup.expectedRewards)}</div>
                </div>
            </div>
            
            <!-- Vote Allocations -->
            <div class="text-[9px]">`;
        
        lockup.buckets.forEach(bucket => {
            let bucketColor = bucket.name === 'stable' ? 'blue' : 
                              bucket.name === 'project' ? 'purple' :
                              bucket.name === 'bluechip' ? 'yellow' : 'green';
            
            cardsHtml += `<div class="mb-2">
                <div class="flex justify-between items-center bg-${bucketColor}-900/30 px-2 py-1 rounded-t border-l-2 border-${bucketColor}-500">
                    <span class="font-bold text-${bucketColor}-400 uppercase">${bucket.name}</span>
                    <span class="text-green-400 font-mono">${fmt$(bucket.expectedRewards)}</span>
                </div>
                <div class="bg-gray-900/30 rounded-b">`;
            
            bucket.pools.forEach(pool => {
                let changeColor = pool.change > 0 ? 'text-green-400' : (pool.change < 0 ? 'text-red-400' : 'text-gray-500');
                let changeStr = pool.change > 0 ? '+' + pool.change.toFixed(2) + '%' : pool.change.toFixed(2) + '%';
                let poolVotes = lockup.vp * (pool.optimized / 100);
                
                cardsHtml += `<div class="grid grid-cols-12 gap-1 px-2 py-0.5 border-b border-gray-800/30 hover:bg-white/5">
                    <div class="col-span-4 text-white truncate">${pool.name}</div>
                    <div class="col-span-2 text-right text-gray-500">${pool.current.toFixed(2)}%</div>
                    <div class="col-span-1 text-center text-gray-600">‚Üí</div>
                    <div class="col-span-2 text-right text-white">${pool.optimized.toFixed(2)}%</div>
                    <div class="col-span-2 text-right text-teal-400 font-mono">${poolVotes.toLocaleString(undefined,{maximumFractionDigits:0})}</div>
                    <div class="col-span-1 text-right ${changeColor}">${changeStr}</div>
                </div>`;
            });
            
            cardsHtml += `</div></div>`;
        });
        
        cardsHtml += `</div></div>`;
    });
    
    if (cardsHtml === '') {
        cardsHtml = '<div class="text-gray-600 text-[10px] italic text-center py-8 col-span-full border border-dashed border-gray-800 rounded">No lockups loaded. Paste each Votion lockup page and click "Add Lockup".</div>';
    }
    
    setHtml('votion-lockups', cardsHtml);
    setTxt('votion-lock-count', store.votion.lockups.length);
    setTxt('votion-total-vp', totalVp.toLocaleString(undefined,{maximumFractionDigits:0}));
    setTxt('votion-total-usd', fmt$(totalUsd));
    setTxt('votion-total-rew', fmt$(totalRew));
}

// ============ PD BRIBES FUNCTIONS ============

async function fetchPdBribesFromGithub() {
    setTxt('pd-fetch-status', '‚è≥');
    try {
        let resp = await fetch(PD_BRIBES_GITHUB_URL);
        if (!resp.ok) throw new Error('Failed to fetch');
        let data = await resp.json();
        store.pdBribesHistory = data;
        setTxt('pd-fetch-status', '‚úì');
        renderPdBribesHistory();
        updatePdCoverage();
    } catch (e) {
        setTxt('pd-fetch-status', '‚úó');
        console.error('Failed to fetch PD bribes:', e);
        alert('Failed to fetch from GitHub. You can paste the JSON manually.');
    }
}

function loadPdBribesJson() {
    let txt = $('pdJsonPaste').value.trim();
    if (!txt) return;
    try {
        let data = JSON.parse(txt);
        if (Array.isArray(data)) {
            store.pdBribesHistory = data;
            $('pdJsonPaste').value = '';
            renderPdBribesHistory();
            updatePdCoverage();
            pasteStatus.pd = true;
            updatePasteStatus('ps-pd', true);
        } else {
            alert('Invalid JSON format. Expected an array of props.');
        }
    } catch (e) {
        alert('Failed to parse JSON: ' + e.message);
    }
}

function parsePdBribes() {
    let txt = $('pdPaste').value;
    let lines = txt.split('\n').map(l => l.trim()).filter(l => l);
    
    let newProp = {
        epoch_range: '',
        start_epoch: 0,
        end_epoch: 0,
        bribes: []
    };
    
    // Parse epoch range: "Bribes for [160-163]:"
    for (let line of lines) {
        let epochMatch = line.match(/\[(\d+)[-‚Äì‚Äî](\d+)\]/);
        if (epochMatch) {
            newProp.start_epoch = parseInt(epochMatch[1]);
            newProp.end_epoch = parseInt(epochMatch[2]);
            newProp.epoch_range = `[${newProp.start_epoch}-${newProp.end_epoch}]`;
            break;
        }
    }
    
    // Parse gauges and pools
    let currentGauge = null;
    
    for (let i = 0; i < lines.length; i++) {
        let line = lines[i];
        
        // Gauge header
        let gaugeMatch = line.match(/^Gauge:\s*(\w+)/i) || line.match(/^(project|bluechip|single|stable):/i);
        if (gaugeMatch) {
            currentGauge = gaugeMatch[1].toLowerCase();
            continue;
        }
        
        // Pool line
        let hasPoolPattern = line.match(/^[\*\‚Ä¢\-]?\s*([A-Za-z0-9\.\-]+)\s*\([\d\.]+%\)/);
        
        if (currentGauge && hasPoolPattern) {
            let poolNameMatch = line.match(/^[\*\‚Ä¢\-]?\s*([A-Za-z0-9\.\-]+)\s*\(/);
            let scoreMatch = line.match(/\((\d+\.?\d*)%\)/);
            let usdMatch = line.match(/:\s*\$?\s*(\d+)\s*=/);
            let lunaMatch = line.match(/=\s*([\d,\.]+)\s*LUNA/i);
            
            if (poolNameMatch && scoreMatch && usdMatch) {
                newProp.bribes.push({
                    gauge: currentGauge,
                    pool: poolNameMatch[1].toUpperCase(),
                    percent: parseFloat(scoreMatch[1]),
                    usd_per_epoch: parseFloat(usdMatch[1]),
                    luna_per_epoch: lunaMatch ? parseFloat(lunaMatch[1].replace(/,/g, '')) : 0
                });
            }
        }
    }
    
    // Store as new prop and update preview
    if (newProp.start_epoch && newProp.bribes.length > 0) {
        store.pdNewProp = newProp;
        updateNewPropPreview();
        
        // Check if this prop already exists
        let existingIdx = store.pdBribesHistory.findIndex(p => 
            p.start_epoch === newProp.start_epoch && p.end_epoch === newProp.end_epoch
        );
        
        if (existingIdx >= 0) {
            if (confirm(`Prop ${newProp.epoch_range} already exists. Replace it?`)) {
                store.pdBribesHistory[existingIdx] = newProp;
            }
        } else {
            store.pdBribesHistory.push(newProp);
            // Sort by start_epoch
            store.pdBribesHistory.sort((a, b) => a.start_epoch - b.start_epoch);
        }
        
        $('pdPaste').value = '';
        renderPdBribesHistory();
        updatePdCoverage();
        pasteStatus.pd = true;
        updatePasteStatus('ps-pd', true);
    } else {
        alert('Could not parse prop data. Check format.');
    }
}

function updateNewPropPreview() {
    let prop = store.pdNewProp;
    if (!prop) {
        setTxt('pd-new-range', '-');
        setTxt('pd-new-count', '0');
        setTxt('pd-new-per-epoch', '$0');
        setTxt('pd-new-total', '$0');
        setTxt('pd-new-pools', '0');
        return;
    }
    
    let epochCount = prop.end_epoch - prop.start_epoch + 1;
    let perEpoch = prop.bribes.reduce((sum, b) => sum + b.usd_per_epoch, 0);
    
    setTxt('pd-new-range', prop.epoch_range);
    setTxt('pd-new-count', epochCount);
    setTxt('pd-new-per-epoch', fmt$(perEpoch));
    setTxt('pd-new-total', fmt$(perEpoch * epochCount));
    setTxt('pd-new-pools', prop.bribes.length);
}

function updatePdCoverage() {
    // Get current epoch from meta (or use a reasonable default)
    let currentEpoch = store.meta.ep || 161;
    setTxt('pd-current-epoch', currentEpoch);
    
    // Find all covered epochs
    let coveredEpochs = new Set();
    let coveringRange = null;
    store.pdBribesHistory.forEach(prop => {
        for (let e = prop.start_epoch; e <= prop.end_epoch; e++) {
            coveredEpochs.add(e);
            if (e === currentEpoch) {
                coveringRange = prop;
            }
        }
    });
    
    // Find range
    let minEpoch = Math.min(...coveredEpochs) || 0;
    let maxEpoch = Math.max(...coveredEpochs) || 0;
    
    if (coveredEpochs.size > 0) {
        setTxt('pd-covered-range', `${minEpoch} - ${maxEpoch}`);
    } else {
        setTxt('pd-covered-range', '-');
    }
    
    // Check if current epoch is covered
    let isCovered = coveredEpochs.has(currentEpoch);
    let light = $('pd-coverage-light');
    let alertBox = $('pd-alert-box');
    let successBox = $('pd-success-box');
    
    if (isCovered && coveringRange) {
        light.className = 'w-4 h-4 rounded-full bg-green-500 border-2 border-green-400 shadow-lg shadow-green-500/50';
        setTxt('pd-missing-epochs', 'None');
        
        // Show success box
        if (alertBox) alertBox.classList.add('hidden');
        if (successBox) {
            successBox.classList.remove('hidden');
            setTxt('pd-success-epoch', currentEpoch);
            setTxt('pd-success-range', coveringRange.epoch_range);
            let totalBribes = coveringRange.bribes.reduce((s, b) => s + (b.usd_per_epoch || 0), 0);
            setTxt('pd-success-bribes', '$' + totalBribes.toLocaleString());
        }
    } else {
        light.className = 'w-4 h-4 rounded-full bg-red-500 border-2 border-red-400 shadow-lg shadow-red-500/50 animate-pulse';
        
        // Find missing epochs between min and current
        let missing = [];
        for (let e = minEpoch; e <= currentEpoch; e++) {
            if (!coveredEpochs.has(e)) missing.push(e);
        }
        setTxt('pd-missing-epochs', missing.length > 5 ? `${missing.slice(0,5).join(', ')}... (+${missing.length - 5})` : missing.join(', ') || currentEpoch.toString());
        
        // Show alert box
        if (successBox) successBox.classList.add('hidden');
        if (alertBox) {
            alertBox.classList.remove('hidden');
            setTxt('pd-alert-epoch', currentEpoch);
            setTxt('pd-alert-epoch2', currentEpoch);
            // Suggest a range like [160-163]
            let suggestedStart = Math.floor(currentEpoch / 4) * 4;
            let suggestedEnd = suggestedStart + 3;
            setTxt('pd-alert-range', `${suggestedStart}-${suggestedEnd}`);
        }
    }
    
    // Update summary stats
    setTxt('pd-props-count', store.pdBribesHistory.length);
    setTxt('pd-total-epochs', coveredEpochs.size);
    
    let totalBribes = 0;
    store.pdBribesHistory.forEach(prop => {
        let epochCount = prop.end_epoch - prop.start_epoch + 1;
        let perEpoch = prop.bribes.reduce((sum, b) => sum + b.usd_per_epoch, 0);
        totalBribes += perEpoch * epochCount;
    });
    setTxt('pd-total-bribes', fmt$(totalBribes));
    
    // Update workflow status
    updateWorkflowStatus();
}

function renderPdBribesHistory() {
    let html = '';
    
    if (store.pdBribesHistory.length === 0) {
        html = '<div class="text-gray-600 text-[10px] italic text-center py-8">No props loaded. Fetch from GitHub or paste JSON.</div>';
        setHtml('pd-history', html);
        return;
    }
    
    // Render each prop as a collapsible card
    store.pdBribesHistory.forEach((prop, idx) => {
        let epochCount = prop.end_epoch - prop.start_epoch + 1;
        let perEpoch = prop.bribes.reduce((sum, b) => sum + b.usd_per_epoch, 0);
        let total = perEpoch * epochCount;
        
        // Group bribes by gauge
        let byGauge = {};
        prop.bribes.forEach(b => {
            if (!byGauge[b.gauge]) byGauge[b.gauge] = [];
            byGauge[b.gauge].push(b);
        });
        
        html += `<div class="bg-[#161616] border border-gray-800 rounded overflow-hidden">
            <div class="flex justify-between items-center px-3 py-2 bg-gray-900/50 cursor-pointer hover:bg-gray-800/50" onclick="togglePropDetails(${idx})">
                <div class="flex items-center gap-3">
                    <span class="text-orange-400 font-bold text-[11px]">${prop.epoch_range}</span>
                    <span class="text-gray-500 text-[9px]">${epochCount} epochs</span>
                    <span class="text-gray-500 text-[9px]">${prop.bribes.length} pools</span>
                </div>
                <div class="flex items-center gap-3">
                    <span class="text-green-400 font-mono text-[10px]">${fmt$(perEpoch)}/ep</span>
                    <span class="text-green-400 font-mono text-[10px] font-bold">${fmt$(total)} total</span>
                    <button onclick="event.stopPropagation(); removeProp(${idx})" class="text-red-400 hover:text-red-300 text-[10px] ml-2">‚úï</button>
                </div>
            </div>
            <div id="prop-details-${idx}" class="hidden px-3 py-2 space-y-1 text-[9px]">`;
        
        // Render gauges
        Object.entries(byGauge).forEach(([gauge, bribes]) => {
            let gaugeColor = gauge === 'stable' ? 'blue' : gauge === 'project' ? 'purple' : gauge === 'bluechip' ? 'yellow' : 'green';
            let gaugeTotal = bribes.reduce((sum, b) => sum + b.usd_per_epoch, 0);
            
            html += `<div class="bg-${gaugeColor}-900/20 border-l-2 border-${gaugeColor}-500 px-2 py-1">
                <div class="flex justify-between text-${gaugeColor}-400 font-bold uppercase">${gauge} <span class="font-mono">${fmt$(gaugeTotal)}/ep</span></div>`;
            
            bribes.forEach(b => {
                html += `<div class="flex justify-between text-gray-400 pl-2">
                    <span class="text-white">${b.pool}</span>
                    <span>${b.percent.toFixed(1)}% | ${fmt$(b.usd_per_epoch)} | ${b.luna_per_epoch.toLocaleString(undefined,{maximumFractionDigits:0})} LUNA</span>
                </div>`;
            });
            
            html += `</div>`;
        });
        
        html += `</div></div>`;
    });
    
    setHtml('pd-history', html);
    updatePdCoverage();
}

function togglePropDetails(idx) {
    let el = $(`prop-details-${idx}`);
    if (el) el.classList.toggle('hidden');
}

function removeProp(idx) {
    if (confirm(`Remove prop ${store.pdBribesHistory[idx].epoch_range}?`)) {
        store.pdBribesHistory.splice(idx, 1);
        renderPdBribesHistory();
    }
}

function clearAllPdBribes() {
    if (confirm('Clear all loaded props?')) {
        store.pdBribesHistory = [];
        store.pdNewProp = null;
        renderPdBribesHistory();
        updatePdCoverage();
        updateNewPropPreview();
        pasteStatus.pd = false;
        updatePasteStatus('ps-pd', false);
    }
}

function exportPdBribesJson() {
    if (store.pdBribesHistory.length === 0) {
        alert('No props to export');
        return;
    }
    
    let json = JSON.stringify(store.pdBribesHistory, null, 2);
    let blob = new Blob([json], { type: 'application/json' });
    let url = URL.createObjectURL(blob);
    let a = document.createElement('a');
    a.href = url;
    a.download = 'tla_pd_bribes.json';
    a.click();
    URL.revokeObjectURL(url);
}

function copyPdBribesJson() {
    if (store.pdBribesHistory.length === 0) {
        alert('No props to copy');
        return;
    }
    
    let json = JSON.stringify(store.pdBribesHistory, null, 2);
    navigator.clipboard.writeText(json).then(() => {
        alert('Copied tla_pd_bribes.json to clipboard!\n\n' + store.pdBribesHistory.length + ' bribe ranges ready to paste into GitHub.');
    }).catch(e => {
        console.error('Copy failed:', e);
        alert('Copy failed. Try using Download instead.');
    });
}

// ============ ASTROPORT FUNCTIONS ============

// Convert timestamp to epoch number
function timestampToEpoch(ts) {
    // ts is in seconds, anchor is Nov 17, 2025 = Epoch 160
    let anchorTs = EPOCH_ANCHOR_DATE.getTime() / 1000;
    let diffWeeks = Math.floor((ts - anchorTs) / SECONDS_PER_WEEK);
    return EPOCH_ANCHOR_NUM + diffWeeks;
}

// Get epoch start/end timestamps
function getEpochRange(epochNum) {
    let anchorTs = EPOCH_ANCHOR_DATE.getTime() / 1000;
    let weeksDiff = epochNum - EPOCH_ANCHOR_NUM;
    let startTs = anchorTs + (weeksDiff * SECONDS_PER_WEEK);
    let endTs = startTs + SECONDS_PER_WEEK;
    return { start: startTs, end: endTs };
}

// Format timestamp to date string
function formatDate(ts) {
    let d = new Date(ts * 1000);
    return d.toISOString().split('T')[0];
}

// Update Astroport tab based on mode
function updateAstroTab() {
    if (store.mode === 'staging') {
        $('astro-staging-mode').classList.remove('hidden');
        $('astro-normal-mode').classList.add('hidden');
        updateStagingDisplay();
    } else {
        $('astro-staging-mode').classList.add('hidden');
        $('astro-normal-mode').classList.remove('hidden');
        updateNormalDisplay();
    }
    updateAstroLpDropdown();
}

function updateAstroStatus() {
    updateAstroTab();
}

// ============ LP DROPDOWN ============

function updateAstroLpDropdown() {
    // Filter for Astroport LPs only
    let astroLps = Object.entries(store.lpRegistry)
        .filter(([key, lp]) => lp.dex === 'Astroport');
    
    // Sort by bucket order, then A-Z within bucket
    const BUCKET_ORDER = ['stable', 'project', 'bluechip', 'single'];
    astroLps.sort((a, b) => {
        let bucketA = BUCKET_ORDER.indexOf(a[1].bucket);
        let bucketB = BUCKET_ORDER.indexOf(b[1].bucket);
        if (bucketA === -1) bucketA = 99;
        if (bucketB === -1) bucketB = 99;
        if (bucketA !== bucketB) return bucketA - bucketB;
        // A-Z within bucket
        return a[1].lp.localeCompare(b[1].lp);
    });
    
    let html = '<option value="">-- Select LP --</option>';
    
    // Group by bucket
    let currentBucket = null;
    astroLps.forEach(([key, lp]) => {
        // Start new optgroup for each bucket
        if (lp.bucket !== currentBucket) {
            if (currentBucket !== null) html += '</optgroup>';
            let bucketLabel = lp.bucket.charAt(0).toUpperCase() + lp.bucket.slice(1);
            html += `<optgroup label="${bucketLabel}">`;
            currentBucket = lp.bucket;
        }
        
        let status = getStagingLpStatus(key);
        let icon = status.notAvailable ? '‚õî' :
                   status.isComplete ? 'üü¢' : 
                   status.daysCaptured.length > 0 ? 'üü°' : 
                   lp.active ? '‚ö™' : '‚¨ú';
        let rangeLabel = status.range !== 180 ? ` [${status.range}d]` : '';
        let naLabel = status.notAvailable ? ' (N/A)' : '';
        html += `<option value="${key}">${icon} ${lp.lp} (${lp.vote_pct.toFixed(1)}%)${rangeLabel}${naLabel}</option>`;
    });
    
    if (currentBucket !== null) html += '</optgroup>';
    
    // Update both dropdowns
    if ($('astro-lp-select')) setHtml('astro-lp-select', html);
    if ($('astro-lp-select-normal')) setHtml('astro-lp-select-normal', html);
}

function getStagingLpStatus(lpKey) {
    // Check ALL staging days for this LP
    let daysCaptured = [];
    let range = 180; // default
    let hasLiq = false;
    let hasVol = false;
    let notAvailable = false;
    
    ['day1', 'day2', 'day3', 'day4'].forEach((day, idx) => {
        let dayData = store.staging[day];
        if (dayData && dayData.lps && dayData.lps[lpKey]) {
            let lp = dayData.lps[lpKey];
            if (lp.range) range = lp.range;
            if (lp.notAvailable) notAvailable = true;
            if (lp.liquidity?.length > 0 || lp.volume?.length > 0) {
                daysCaptured.push(idx + 1);
            }
            if (lp.liquidity?.length > 0) hasLiq = true;
            if (lp.volume?.length > 0) hasVol = true;
        }
    });
    
    // Days needed based on range
    let daysNeeded = range === 180 ? 4 : range === 90 ? 2 : 1;
    let isComplete = (daysCaptured.length >= daysNeeded && hasLiq && hasVol) || notAvailable;
    
    return {
        liq: hasLiq,
        vol: hasVol,
        range: range,
        daysCaptured: daysCaptured,
        daysNeeded: daysNeeded,
        isComplete: isComplete,
        notAvailable: notAvailable
    };
}

function updateSelectedLp() {
    let lpKey = $('astro-lp-select').value;
    if (!lpKey) {
        setTxt('astro-lp-liq-status', '-');
        setTxt('astro-lp-vol-status', '-');
        setTxt('astro-lp-days-status', '-');
        return;
    }
    
    let status = getStagingLpStatus(lpKey);
    
    // Update range dropdown to match stored range
    if ($('astro-data-range')) {
        $('astro-data-range').value = status.range.toString();
    }
    
    // Check if marked as not available
    if (status.notAvailable) {
        setTxt('astro-lp-liq-status', '‚õî N/A');
        $('astro-lp-liq-status').className = 'text-yellow-400';
        setTxt('astro-lp-vol-status', '‚õî N/A');
        $('astro-lp-vol-status').className = 'text-yellow-400';
        setTxt('astro-lp-days-status', 'Marked unavailable');
        $('astro-lp-days-status').className = 'text-yellow-400';
        return;
    }
    
    // Current day status
    let currentDay = $('staging-current-day')?.value || 'day1';
    let dayData = store.staging[currentDay];
    let currentDayLiq = dayData?.lps?.[lpKey]?.liquidity?.length || 0;
    let currentDayVol = dayData?.lps?.[lpKey]?.volume?.length || 0;
    
    if (currentDayLiq > 0) {
        setTxt('astro-lp-liq-status', `‚úì ${currentDayLiq} pts`);
        $('astro-lp-liq-status').className = 'text-green-400';
    } else {
        setTxt('astro-lp-liq-status', 'Not captured');
        $('astro-lp-liq-status').className = 'text-gray-600';
    }
    
    if (currentDayVol > 0) {
        setTxt('astro-lp-vol-status', `‚úì ${currentDayVol} pts`);
        $('astro-lp-vol-status').className = 'text-green-400';
    } else {
        setTxt('astro-lp-vol-status', 'Not captured');
        $('astro-lp-vol-status').className = 'text-gray-600';
    }
    
    // Days status
    let daysStr = status.daysCaptured.length > 0 ? status.daysCaptured.join(',') : 'none';
    let daysClass = status.isComplete ? 'text-green-400' : 
                    status.daysCaptured.length > 0 ? 'text-yellow-400' : 'text-gray-600';
    setTxt('astro-lp-days-status', `${daysStr} / ${status.daysNeeded} needed`);
    $('astro-lp-days-status').className = daysClass;
}

// ============ STAGING MODE ============

function updateStagingDay() {
    updateSelectedLp();
    renderStagingLpGrid();
}

function updateStagingDisplay() {
    // Update day tracker cards
    ['day1', 'day2', 'day3', 'day4'].forEach(day => {
        let dayData = store.staging[day];
        let statusEl = $(`staging-${day}-status`);
        let lpsEl = $(`staging-${day}-lps`);
        let cardEl = $(`staging-${day}`);
        
        if (dayData && dayData.lps && Object.keys(dayData.lps).length > 0) {
            let lpCount = Object.keys(dayData.lps).length;
            let complete = Object.values(dayData.lps).filter(lp => 
                lp.liquidity?.length > 0 && lp.volume?.length > 0
            ).length;
            
            statusEl.textContent = dayData.captureDate || 'Captured';
            statusEl.className = 'text-[10px] text-green-400';
            lpsEl.textContent = `${complete}/${lpCount} LPs`;
            cardEl.className = 'bg-green-900/20 rounded p-3 border border-green-700';
        } else {
            statusEl.textContent = 'Not started';
            statusEl.className = 'text-[10px] text-gray-600';
            lpsEl.textContent = '0 LPs';
            cardEl.className = 'bg-[#0D0D0D] rounded p-3 border border-gray-800';
        }
    });
    
    // Check if we have at least some LPs and at least 1 day captured
    let hasData = ['day1', 'day2', 'day3', 'day4'].some(day => 
        store.staging[day] && store.staging[day].lps && Object.keys(store.staging[day].lps).length > 0
    );
    
    // Count how many LPs are fully complete based on their range
    let astroLps = Object.entries(store.lpRegistry).filter(([k, lp]) => lp.dex === 'Astroport');
    let completeLps = astroLps.filter(([key, lp]) => {
        let status = getStagingLpStatus(key);
        return status.isComplete;
    }).length;
    
    // Show finalize if we have any complete LPs
    if (completeLps > 0) {
        $('staging-finalize-section').classList.remove('hidden');
        setTxt('staging-ready-count', `${completeLps} LP${completeLps > 1 ? 's' : ''} ready`);
    } else {
        $('staging-finalize-section').classList.add('hidden');
    }
    
    renderStagingLpGrid();
}

function renderStagingLpGrid() {
    let currentDay = $('staging-current-day')?.value || 'day1';
    
    // Get all Astroport LPs from registry
    const BUCKET_ORDER = ['stable', 'project', 'bluechip', 'single'];
    let astroLps = Object.entries(store.lpRegistry)
        .filter(([key, lp]) => lp.dex === 'Astroport')
        .sort((a, b) => {
            // Sort by bucket order, then A-Z within bucket
            let bucketA = BUCKET_ORDER.indexOf(a[1].bucket);
            let bucketB = BUCKET_ORDER.indexOf(b[1].bucket);
            if (bucketA === -1) bucketA = 99;
            if (bucketB === -1) bucketB = 99;
            if (bucketA !== bucketB) return bucketA - bucketB;
            return a[1].lp.localeCompare(b[1].lp);
        });
    
    let html = '';
    let complete = 0;
    let activeComplete = 0;
    let activeTotal = astroLps.filter(([k, lp]) => lp.active).length;
    let notAvailableCount = 0;
    let currentBucket = null;
    
    astroLps.forEach(([key, lp]) => {
        let status = getStagingLpStatus(key);
        
        if (status.isComplete) {
            complete++;
            if (lp.active) activeComplete++;
        }
        if (status.notAvailable) notAvailableCount++;
        
        // Bucket header
        if (lp.bucket !== currentBucket) {
            if (currentBucket !== null) {
                html += '</div></div>'; // Close previous bucket
            }
            currentBucket = lp.bucket;
            let bucketColor = lp.bucket === 'stable' ? 'blue' : lp.bucket === 'project' ? 'purple' : lp.bucket === 'bluechip' ? 'yellow' : 'green';
            let bucketLabel = lp.bucket.charAt(0).toUpperCase() + lp.bucket.slice(1);
            html += `<div class="col-span-4 mb-2">
                <div class="text-[9px] font-bold text-${bucketColor}-400 uppercase mb-1 border-b border-${bucketColor}-900 pb-1">${bucketLabel}</div>
                <div class="grid grid-cols-4 gap-2">`;
        }
        
        // Color based on completion
        let bgClass = status.notAvailable ? 'bg-yellow-900/20 border-yellow-800' :
                      status.isComplete ? 'bg-green-900/30 border-green-700' : 
                      status.daysCaptured.length > 0 ? 'bg-yellow-900/30 border-yellow-700' :
                      'bg-[#0D0D0D] border-gray-800';
        
        let activeClass = lp.active ? 'text-white' : 'text-gray-500';
        let pctClass = lp.active ? 'text-green-400' : (lp.vote_pct >= 0.5 ? 'text-yellow-400' : 'text-gray-600');
        
        // Range badge
        let rangeBadge = status.range === 180 ? '180' : status.range === 90 ? '90' : '30';
        let rangeColor = status.range === 180 ? 'text-blue-400' : status.range === 90 ? 'text-cyan-400' : 'text-green-400';
        
        // Status display
        let statusDisplay = '';
        if (status.notAvailable) {
            statusDisplay = '<span class="text-yellow-400">‚õî N/A</span>';
        } else {
            let daysIndicator = `${status.daysCaptured.length}/${status.daysNeeded}`;
            statusDisplay = `<div class="flex gap-2">
                <span class="${status.liq ? 'text-cyan-400' : 'text-gray-600'}">L:${status.liq ? '‚úì' : '‚óã'}</span>
                <span class="${status.vol ? 'text-purple-400' : 'text-gray-600'}">V:${status.vol ? '‚úì' : '‚óã'}</span>
            </div>
            <div class="flex gap-1 items-center">
                <span class="${rangeColor} text-[7px]">${rangeBadge}d</span>
                <span class="${status.isComplete ? 'text-green-400' : 'text-gray-500'} text-[8px]">${daysIndicator}</span>
            </div>`;
        }
        
        html += `<div class="p-2 rounded border ${bgClass} text-[9px]">
            <div class="flex justify-between items-start">
                <div class="${activeClass} font-mono truncate flex-1" title="${lp.lp}">${lp.lp}</div>
                <span class="${pctClass} text-[8px] ml-1">${lp.vote_pct.toFixed(1)}%</span>
            </div>
            <div class="flex justify-between mt-1">
                ${statusDisplay}
            </div>
        </div>`;
    });
    
    // Close last bucket
    if (currentBucket !== null) {
        html += '</div></div>';
    }
    
    setHtml('astro-staging-lp-grid', html || '<div class="col-span-4 text-gray-600 italic text-center py-4">No LPs in registry. Parse Vote tab first.</div>');
    
    let naLabel = notAvailableCount > 0 ? ` (${notAvailableCount} N/A)` : '';
    setTxt('astro-staging-complete', `${activeComplete}/${activeTotal} active, ${complete}/${astroLps.length} total${naLabel}`);
    setTxt('astro-staging-total', '');
}

function detectDataRange(series) {
    // Check interval between first few points to determine range
    if (!series || series.length < 3) return 180; // default
    
    // Calculate average interval from first 5 points
    let intervals = [];
    for (let i = 1; i < Math.min(5, series.length); i++) {
        let diff = series[i].time - series[i-1].time;
        intervals.push(diff);
    }
    
    let avgInterval = intervals.reduce((a, b) => a + b, 0) / intervals.length;
    let avgDays = avgInterval / 86400; // convert to days
    
    // Determine range based on interval
    // 180d = ~4 day intervals (345600 sec)
    // 90d = ~2 day intervals (172800 sec)
    // 30d = ~1 day intervals (86400 sec)
    
    if (avgDays >= 3) return 180;      // 3-4+ day intervals = 180d
    if (avgDays >= 1.5) return 90;     // 1.5-3 day intervals = 90d
    return 30;                          // <1.5 day intervals = 30d
}

function captureStagingBoth() {
    let lpKey = $('astro-lp-select').value;
    let currentDay = $('staging-current-day').value;
    
    if (!lpKey) {
        alert('Please select an LP first');
        return;
    }
    
    let liqTxt = $('astroLiqPaste').value.trim();
    let volTxt = $('astroVolPaste').value.trim();
    
    if (!liqTxt && !volTxt) {
        alert('Please paste at least one data type (liquidity or volume)');
        return;
    }
    
    // Get LP name for display
    let lpName = store.lpRegistry[lpKey]?.lp || lpKey;
    
    // Initialize staging day if needed
    if (!store.staging[currentDay]) {
        store.staging[currentDay] = {
            captureDate: new Date().toISOString().split('T')[0],
            lps: {}
        };
    }
    
    if (!store.staging[currentDay].lps[lpKey]) {
        store.staging[currentDay].lps[lpKey] = {
            liquidity: [],
            volume: [],
            range: 180
        };
    }
    
    let liqCount = 0, volCount = 0;
    let detectedRange = null;
    
    // Parse liquidity if provided
    if (liqTxt) {
        try {
            let json = JSON.parse(liqTxt);
            let series = json?.result?.data?.json?.[0]?.series;
            if (series && Array.isArray(series)) {
                // Auto-detect range from data
                detectedRange = detectDataRange(series);
                
                let rawPoints = series.map(point => ({
                    ts: point.time,
                    v: point.value,
                    date: formatDate(point.time)
                }));
                store.staging[currentDay].lps[lpKey].liquidity = rawPoints;
                liqCount = rawPoints.length;
            }
        } catch (e) {
            alert('Failed to parse Liquidity JSON: ' + e.message);
            return;
        }
    }
    
    // Parse volume if provided
    if (volTxt) {
        try {
            let json = JSON.parse(volTxt);
            let series = json?.result?.data?.json?.[0]?.series;
            if (series && Array.isArray(series)) {
                // Auto-detect range from data (use this if liq didn't set it)
                if (!detectedRange) {
                    detectedRange = detectDataRange(series);
                }
                
                let rawPoints = series.map(point => ({
                    ts: point.time,
                    v: point.value,
                    date: formatDate(point.time)
                }));
                store.staging[currentDay].lps[lpKey].volume = rawPoints;
                volCount = rawPoints.length;
            }
        } catch (e) {
            alert('Failed to parse Volume JSON: ' + e.message);
            return;
        }
    }
    
    // Set auto-detected range
    if (detectedRange) {
        store.staging[currentDay].lps[lpKey].range = detectedRange;
        // Update dropdown to show detected range
        if ($('astro-data-range')) {
            $('astro-data-range').value = detectedRange.toString();
        }
    }
    
    // Calculate days needed based on detected range
    let daysNeeded = detectedRange === 180 ? 4 : detectedRange === 90 ? 2 : 1;
    
    // Clear paste boxes but KEEP the selection
    $('astroLiqPaste').value = '';
    $('astroVolPaste').value = '';
    
    // Update UI
    updateSelectedLp();
    updateStagingDisplay();
    updateAstroLpDropdown();
    
    alert(`Captured ${lpName}:\n‚Ä¢ Liquidity: ${liqCount} points\n‚Ä¢ Volume: ${volCount} points\n‚Ä¢ Detected: ${detectedRange}d data (${daysNeeded} days needed)`);
}

function parseStagingData(type) {
    captureStagingBoth();
}

function parseStagingLiquidity() {
    captureStagingBoth();
}

function parseStagingVolume() {
    captureStagingBoth();
}

function updateSelectedLpRange() {
    updateSelectedLp();
}

function clearLpData() {
    let lpKey = $('astro-lp-select').value;
    let currentDay = $('staging-current-day').value;
    
    if (!lpKey) {
        alert('Please select an LP first');
        return;
    }
    
    let lpName = store.lpRegistry[lpKey]?.lp || lpKey;
    
    if (!confirm(`Clear all data for ${lpName} on ${currentDay}?`)) {
        return;
    }
    
    if (store.staging[currentDay] && store.staging[currentDay].lps && store.staging[currentDay].lps[lpKey]) {
        delete store.staging[currentDay].lps[lpKey];
    }
    
    updateSelectedLp();
    updateStagingDisplay();
    updateAstroLpDropdown();
    
    alert(`Cleared ${lpName} data from ${currentDay}`);
}

function markLpNotAvailable() {
    let lpKey = $('astro-lp-select').value;
    let currentDay = $('staging-current-day').value;
    
    if (!lpKey) {
        alert('Please select an LP first');
        return;
    }
    
    let lpName = store.lpRegistry[lpKey]?.lp || lpKey;
    
    if (!confirm(`Mark ${lpName} as "Data Not Available"?\n\nThis will count as complete but flag it as unavailable.`)) {
        return;
    }
    
    // Initialize staging day if needed
    if (!store.staging[currentDay]) {
        store.staging[currentDay] = {
            captureDate: new Date().toISOString().split('T')[0],
            lps: {}
        };
    }
    
    // Set notAvailable flag
    store.staging[currentDay].lps[lpKey] = {
        liquidity: [],
        volume: [],
        range: 180,
        notAvailable: true,
        notAvailableDate: new Date().toISOString().split('T')[0]
    };
    
    updateSelectedLp();
    updateStagingDisplay();
    updateAstroLpDropdown();
    
    alert(`Marked ${lpName} as "Data Not Available"`);
}

function exportStagingDay() {
    let currentDay = $('staging-current-day').value;
    let dayData = store.staging[currentDay];
    
    if (!dayData || !dayData.lps || Object.keys(dayData.lps).length === 0) {
        alert('No data for current day');
        return;
    }
    
    let json = JSON.stringify(dayData, null, 2);
    let blob = new Blob([json], { type: 'application/json' });
    let url = URL.createObjectURL(blob);
    let a = document.createElement('a');
    a.href = url;
    a.download = `tla_ext_staging_${currentDay}.json`;
    a.click();
    URL.revokeObjectURL(url);
}

function loadStagingDayPaste() {
    let txt = prompt('Paste staging day JSON:');
    if (!txt) return;
    
    let currentDay = $('staging-current-day').value;
    
    try {
        let data = JSON.parse(txt);
        if (data.lps) {
            store.staging[currentDay] = data;
            updateStagingDisplay();
            updateAstroLpDropdown();
            alert(`Loaded staging data for ${currentDay}`);
        } else {
            alert('Invalid staging data format');
        }
    } catch (e) {
        alert('Invalid JSON: ' + e.message);
    }
}

function finalizeStaging() {
    // Get only LPs that are complete based on their range (includes notAvailable)
    let astroLps = Object.entries(store.lpRegistry).filter(([k, lp]) => lp.dex === 'Astroport');
    let completeLpKeys = astroLps
        .filter(([key, lp]) => getStagingLpStatus(key).isComplete)
        .map(([key, lp]) => key);
    
    // Separate notAvailable LPs
    let notAvailableLpKeys = completeLpKeys.filter(key => getStagingLpStatus(key).notAvailable);
    let dataLpKeys = completeLpKeys.filter(key => !getStagingLpStatus(key).notAvailable);
    
    if (completeLpKeys.length === 0) {
        alert('No LPs are fully complete based on their data range requirements.');
        return;
    }
    
    let naMsg = notAvailableLpKeys.length > 0 ? `\n(${notAvailableLpKeys.length} marked as N/A)` : '';
    if (!confirm(`Generate historical file from ${completeLpKeys.length} complete LP(s)?${naMsg}\n\nThis will calculate epoch averages from all raw points.`)) {
        return;
    }
    
    // Merge all days of raw data for COMPLETE LPs with data
    let allRawData = {}; // { lpKey: { liquidity: [], volume: [], range: X } }
    
    ['day1', 'day2', 'day3', 'day4'].forEach(day => {
        let dayData = store.staging[day];
        if (!dayData || !dayData.lps) return;
        
        Object.entries(dayData.lps).forEach(([lpKey, lpData]) => {
            // Only include complete LPs that have data
            if (!dataLpKeys.includes(lpKey)) return;
            
            if (!allRawData[lpKey]) {
                allRawData[lpKey] = { 
                    liquidity: [], 
                    volume: [],
                    range: lpData.range || 180
                };
            }
            
            if (lpData.liquidity) {
                allRawData[lpKey].liquidity.push(...lpData.liquidity);
            }
            if (lpData.volume) {
                allRawData[lpKey].volume.push(...lpData.volume);
            }
        });
    });
    
    // Dedupe by timestamp and calculate epoch averages
    let historical = {
        meta: {
            created: new Date().toISOString(),
            source: 'staging_finalize',
            lp_count: completeLpKeys.length,
            not_available_count: notAvailableLpKeys.length
        },
        lps: {}
    };
    
    Object.entries(allRawData).forEach(([lpKey, lpData]) => {
        historical.lps[lpKey] = {
            liquidity: { epochs: {}, raw: [] },
            volume: { epochs: {}, raw: [] },
            range: lpData.range
        };
        
        ['liquidity', 'volume'].forEach(type => {
            // Dedupe by timestamp
            let seen = new Set();
            let uniquePoints = lpData[type].filter(p => {
                if (seen.has(p.ts)) return false;
                seen.add(p.ts);
                return true;
            });
            
            // Store raw
            historical.lps[lpKey][type].raw = uniquePoints;
            
            // Group by epoch
            let epochData = {};
            uniquePoints.forEach(p => {
                let epoch = timestampToEpoch(p.ts);
                if (!epochData[epoch]) {
                    epochData[epoch] = { values: [], sum: 0, count: 0 };
                }
                epochData[epoch].values.push(p.v);
                epochData[epoch].sum += p.v;
                epochData[epoch].count++;
            });
            
            // Calculate averages for complete epochs
            let currentEpoch = store.meta.ep || timestampToEpoch(Date.now() / 1000);
            Object.entries(epochData).forEach(([ep, data]) => {
                let epochNum = parseInt(ep);
                let epochRange = getEpochRange(epochNum);
                let isComplete = (Date.now() / 1000) > epochRange.end;
                
                if (isComplete) {
                    historical.lps[lpKey][type].epochs[epochNum] = {
                        avg: Math.round((data.sum / data.count) * 100) / 100,
                        dataPoints: data.count,
                        startDate: formatDate(epochRange.start),
                        endDate: formatDate(epochRange.end)
                    };
                }
            });
        });
    });
    
    // Add notAvailable LPs with flag
    notAvailableLpKeys.forEach(lpKey => {
        historical.lps[lpKey] = {
            notAvailable: true,
            notAvailableDate: new Date().toISOString().split('T')[0],
            liquidity: { epochs: {}, raw: [] },
            volume: { epochs: {}, raw: [] }
        };
    });
    
    // Update epoch coverage in meta
    let allEpochs = new Set();
    Object.values(historical.lps).forEach(lp => {
        Object.keys(lp.liquidity.epochs).forEach(ep => allEpochs.add(parseInt(ep)));
        Object.keys(lp.volume.epochs).forEach(ep => allEpochs.add(parseInt(ep)));
    });
    
    if (allEpochs.size > 0) {
        historical.meta.epoch_start = Math.min(...allEpochs);
        historical.meta.epoch_end = Math.max(...allEpochs);
    }
    
    // Store and export
    store.historical = historical;
    
    let json = JSON.stringify(historical, null, 2);
    let blob = new Blob([json], { type: 'application/json' });
    let url = URL.createObjectURL(blob);
    let a = document.createElement('a');
    a.href = url;
    a.download = 'tla_ext_historical.json';
    a.click();
    URL.revokeObjectURL(url);
    
    alert('Historical file generated! Switch to Normal mode for weekly updates.');
}

// ============ NORMAL MODE ============

function updateNormalDisplay() {
    // Historical stats
    if (store.historical.meta) {
        setTxt('hist-epochs', `${store.historical.meta.epoch_start || '-'} - ${store.historical.meta.epoch_end || '-'}`);
        setTxt('hist-lps', store.historical.lps ? Object.keys(store.historical.lps).length : 0);
        setTxt('hist-updated', store.historical.meta.created?.split('T')[0] || '-');
    }
    
    // Current stats
    if (store.current.meta) {
        setTxt('curr-epochs', `${store.current.meta.epoch_start || '-'} - ${store.current.meta.epoch_end || '-'}`);
        setTxt('curr-lps', store.current.lps ? Object.keys(store.current.lps).length : 0);
        setTxt('curr-updated', store.current.meta.last_updated || '-');
    }
    
    // Update historical status (need/archive)
    updateHistoricalStatus();
    
    renderNormalLpGrid();
}

function updateHistoricalStatus() {
    let currentEpoch = store.meta.ep || 161;
    let histStart = store.historical.meta?.epoch_start || 0;
    let histEnd = store.historical.meta?.epoch_end || 0;
    
    // What epochs are needed? (from histEnd+1 to currentEpoch)
    let needEpochs = [];
    if (histEnd > 0 && histEnd < currentEpoch) {
        for (let e = histEnd + 1; e <= currentEpoch; e++) {
            needEpochs.push(e);
        }
    }
    
    // What epochs should be archived? (older than 180 days = ~26 epochs)
    let archiveEpochs = [];
    let archiveCutoff = currentEpoch - 26; // ~180 days
    if (histStart > 0 && histStart < archiveCutoff) {
        for (let e = histStart; e < archiveCutoff; e++) {
            archiveEpochs.push(e);
        }
    }
    
    // Update UI
    let needEl = $('hist-need-epochs');
    let archiveEl = $('hist-archive-epochs');
    
    if (needEl) {
        if (needEpochs.length > 0) {
            needEl.classList.remove('hidden');
            let needStr = needEpochs.length > 5 
                ? `Ep ${needEpochs[0]}-${needEpochs[needEpochs.length-1]}` 
                : needEpochs.map(e => e).join(', ');
            setTxt('hist-need-list', needStr);
        } else {
            needEl.classList.add('hidden');
        }
    }
    
    if (archiveEl) {
        if (archiveEpochs.length > 0) {
            archiveEl.classList.remove('hidden');
            let archiveStr = `Ep ${archiveEpochs[0]}${archiveEpochs.length > 1 ? '-' + archiveEpochs[archiveEpochs.length-1] : ''}`;
            setTxt('hist-archive-list', archiveStr);
        } else {
            archiveEl.classList.add('hidden');
        }
    }
}

async function fetchHistoricalFromGithub() {
    try {
        let resp = await fetch(HISTORICAL_URL);
        if (resp.ok) {
            store.historical = await resp.json();
            setTxt('fetch-historical', '‚úì');
            updateNormalDisplay();
        } else {
            setTxt('fetch-historical', '-');
        }
    } catch(e) {
        setTxt('fetch-historical', '‚úó');
        console.error('Failed to fetch historical:', e);
    }
}

function exportArchive() {
    // Extract epochs older than 180 days from historical
    let currentEpoch = store.meta.ep || 161;
    let archiveCutoff = currentEpoch - 26;
    
    if (!store.historical.lps || Object.keys(store.historical.lps).length === 0) {
        alert('No historical data loaded. Fetch from GitHub first.');
        return;
    }
    
    let archive = {
        meta: {
            archived_at: new Date().toISOString(),
            cutoff_epoch: archiveCutoff,
            source: 'tla_ext_historical'
        },
        lps: {}
    };
    
    let hasArchiveData = false;
    
    // Extract old epochs from each LP
    Object.entries(store.historical.lps).forEach(([lpKey, lpData]) => {
        let archiveLp = { liquidity: { epochs: {} }, volume: { epochs: {} } };
        
        // Liquidity epochs
        if (lpData.liquidity?.epochs) {
            Object.entries(lpData.liquidity.epochs).forEach(([ep, data]) => {
                if (parseInt(ep) < archiveCutoff) {
                    archiveLp.liquidity.epochs[ep] = data;
                    hasArchiveData = true;
                }
            });
        }
        
        // Volume epochs
        if (lpData.volume?.epochs) {
            Object.entries(lpData.volume.epochs).forEach(([ep, data]) => {
                if (parseInt(ep) < archiveCutoff) {
                    archiveLp.volume.epochs[ep] = data;
                    hasArchiveData = true;
                }
            });
        }
        
        // Only add LP if it has archive data
        if (Object.keys(archiveLp.liquidity.epochs).length > 0 || Object.keys(archiveLp.volume.epochs).length > 0) {
            archive.lps[lpKey] = archiveLp;
        }
    });
    
    if (!hasArchiveData) {
        alert('No epochs older than ' + archiveCutoff + ' to archive.');
        return;
    }
    
    // Find epoch range in archive
    let allEpochs = new Set();
    Object.values(archive.lps).forEach(lp => {
        Object.keys(lp.liquidity.epochs).forEach(ep => allEpochs.add(parseInt(ep)));
        Object.keys(lp.volume.epochs).forEach(ep => allEpochs.add(parseInt(ep)));
    });
    archive.meta.epoch_start = Math.min(...allEpochs);
    archive.meta.epoch_end = Math.max(...allEpochs);
    
    downloadJson(JSON.stringify(archive, null, 2), 'tla_ext_archive.json');
}

function updateSelectedLpNormal() {
    let lpKey = $('astro-lp-select-normal').value;
    if (!lpKey) {
        setTxt('normal-lp-last-epoch', '-');
        return;
    }
    
    let lastEpoch = 0;
    if (store.current.lps && store.current.lps[lpKey]) {
        let liqEpochs = Object.keys(store.current.lps[lpKey].liquidity?.epochs || {}).map(Number);
        let volEpochs = Object.keys(store.current.lps[lpKey].volume?.epochs || {}).map(Number);
        lastEpoch = Math.max(...liqEpochs, ...volEpochs, 0);
    }
    
    setTxt('normal-lp-last-epoch', lastEpoch || '-');
}

function renderNormalLpGrid() {
    // Show ALL Astroport LPs, not just active
    let astroLps = Object.entries(store.lpRegistry)
        .filter(([key, lp]) => lp.dex === 'Astroport')
        .sort((a, b) => {
            // Active first, then by vote %
            if (a[1].active !== b[1].active) return b[1].active - a[1].active;
            return b[1].vote_pct - a[1].vote_pct;
        });
    
    let html = '';
    let currentEpoch = store.meta.ep || 161;
    
    astroLps.forEach(([key, lp]) => {
        let lastEpoch = 0;
        if (store.current.lps && store.current.lps[key]) {
            let liqEpochs = Object.keys(store.current.lps[key].liquidity?.epochs || {}).map(Number);
            let volEpochs = Object.keys(store.current.lps[key].volume?.epochs || {}).map(Number);
            lastEpoch = Math.max(...liqEpochs, ...volEpochs, 0);
        }
        
        let upToDate = lastEpoch >= currentEpoch - 1;
        let bgClass = upToDate ? 'bg-green-900/30 border-green-700' : 
                      lastEpoch > 0 ? 'bg-yellow-900/30 border-yellow-700' :
                      'bg-[#0D0D0D] border-gray-800';
        
        let nameClass = lp.active ? 'text-white' : 'text-gray-500';
        let pctClass = lp.active ? 'text-green-400' : 'text-gray-600';
        
        html += `<div class="p-2 rounded border ${bgClass} text-[9px]">
            <div class="flex justify-between">
                <span class="${nameClass} font-mono truncate" title="${lp.lp}">${lp.lp}</span>
                <span class="${pctClass} text-[8px]">${lp.vote_pct.toFixed(1)}%</span>
            </div>
            <div class="text-gray-400 mt-1">Last: ${lastEpoch || '-'}</div>
        </div>`;
    });
    
    setHtml('astro-normal-lp-grid', html || '<div class="col-span-4 text-gray-600 italic text-center py-4">No LPs in registry.</div>');
}

function parseNormalData(type) {
    let pasteId = type === 'liquidity' ? 'normalLiqPaste' : 'normalVolPaste';
    let txt = $(pasteId).value.trim();
    let lpKey = $('astro-lp-select-normal').value;
    
    if (!lpKey) {
        alert('Please select an LP first');
        return;
    }
    
    if (!txt) {
        alert('Please paste data');
        return;
    }
    
    // Get LP name from key for display
    let lpName = store.lpRegistry[lpKey]?.lp || lpKey;
    
    try {
        let json = JSON.parse(txt);
        let series = json?.result?.data?.json?.[0]?.series;
        
        if (!series || !Array.isArray(series)) {
            alert('Invalid data format');
            return;
        }
        
        // Initialize current if needed
        if (!store.current.lps) store.current.lps = {};
        if (!store.current.lps[lpKey]) {
            store.current.lps[lpKey] = {
                liquidity: { epochs: {}, raw: [] },
                volume: { epochs: {}, raw: [] }
            };
        }
        
        // Parse and merge raw points
        let existing = new Set(store.current.lps[lpKey][type].raw.map(p => p.ts));
        let newPoints = series
            .filter(p => !existing.has(p.time))
            .map(p => ({ ts: p.time, v: p.value, date: formatDate(p.time) }));
        
        store.current.lps[lpKey][type].raw.push(...newPoints);
        
        // Recalculate epoch averages
        let epochData = {};
        store.current.lps[lpKey][type].raw.forEach(p => {
            let epoch = timestampToEpoch(p.ts);
            if (!epochData[epoch]) epochData[epoch] = { sum: 0, count: 0 };
            epochData[epoch].sum += p.v;
            epochData[epoch].count++;
        });
        
        let currentEpoch = store.meta.ep || timestampToEpoch(Date.now() / 1000);
        Object.entries(epochData).forEach(([ep, data]) => {
            let epochNum = parseInt(ep);
            let epochRange = getEpochRange(epochNum);
            let isComplete = (Date.now() / 1000) > epochRange.end;
            
            if (isComplete) {
                store.current.lps[lpKey][type].epochs[epochNum] = {
                    avg: Math.round((data.sum / data.count) * 100) / 100,
                    dataPoints: data.count,
                    startDate: formatDate(epochRange.start),
                    endDate: formatDate(epochRange.end)
                };
            }
        });
        
        // Update meta
        if (!store.current.meta) store.current.meta = {};
        store.current.meta.last_updated = new Date().toISOString().split('T')[0];
        
        $(pasteId).value = '';
        updateNormalDisplay();
        updateAstroLpDropdown();
        
        alert(`Merged ${newPoints.length} new ${type} points for ${lpName}`);
        
    } catch (e) {
        alert('Failed to parse: ' + e.message);
    }
}

function parseNormalLiquidity() {
    parseNormalData('liquidity');
}

function parseNormalVolume() {
    parseNormalData('volume');
}

// ============ EXPORT FUNCTIONS ============

function exportHistorical() {
    let json = JSON.stringify(store.historical, null, 2);
    downloadJson(json, 'tla_ext_historical.json');
}

function exportCurrent() {
    let json = JSON.stringify(store.current, null, 2);
    downloadJson(json, 'tla_ext_current.json');
}

function exportCombined() {
    // Merge historical and current
    let combined = {
        meta: {
            generated: new Date().toISOString(),
            source: 'tla-admin-ext'
        },
        lps: {}
    };
    
    // Add historical
    if (store.historical.lps) {
        Object.entries(store.historical.lps).forEach(([name, lp]) => {
            combined.lps[name] = JSON.parse(JSON.stringify(lp));
        });
    }
    
    // Merge current (overwrite epoch data, append raw)
    if (store.current.lps) {
        Object.entries(store.current.lps).forEach(([name, lp]) => {
            if (!combined.lps[name]) {
                combined.lps[name] = JSON.parse(JSON.stringify(lp));
            } else {
                ['liquidity', 'volume'].forEach(type => {
                    // Merge epochs
                    Object.assign(combined.lps[name][type].epochs, lp[type].epochs);
                    // Dedupe and merge raw
                    let existing = new Set(combined.lps[name][type].raw.map(p => p.ts));
                    let newRaw = lp[type].raw.filter(p => !existing.has(p.ts));
                    combined.lps[name][type].raw.push(...newRaw);
                });
            }
        });
    }
    
    // Calculate epoch coverage
    let allEpochs = new Set();
    Object.values(combined.lps).forEach(lp => {
        Object.keys(lp.liquidity?.epochs || {}).forEach(ep => allEpochs.add(parseInt(ep)));
        Object.keys(lp.volume?.epochs || {}).forEach(ep => allEpochs.add(parseInt(ep)));
    });
    
    if (allEpochs.size > 0) {
        combined.meta.epoch_start = Math.min(...allEpochs);
        combined.meta.epoch_end = Math.max(...allEpochs);
    }
    
    let json = JSON.stringify(combined, null, 2);
    downloadJson(json, 'tla_ext_combined.json');
}

function downloadJson(json, filename) {
    let blob = new Blob([json], { type: 'application/json' });
    let url = URL.createObjectURL(blob);
    let a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
    URL.revokeObjectURL(url);
}

function parseWW() {
    let txt = $('wwPaste').value;
    let lines = txt.split('\n').map(l => l.trim()).filter(l => l);
    
    store.ww = [];
    let i = 0;
    
    while (i < lines.length) {
        let line = lines[i];
        
        if ((line.includes('-') || line.includes('/')) && line.match(/[A-Z]{2,}/)) {
            let pool = line.replace(' LP', '').trim();
            let volume = 0;
            let fees = 0;
            let apr = '-';
            
            for (let k = 1; k <= 8 && i + k < lines.length; k++) {
                let next = lines[i + k];
                
                if (next.includes('$') && volume === 0) {
                    volume = clean(next);
                } else if (next.includes('$') && fees === 0) {
                    fees = clean(next);
                }
                if (next.includes('%')) {
                    apr = next;
                }
                if (k > 2 && (next.includes('-') || next.includes('/')) && next.match(/[A-Z]{2,}/) && !next.includes('$')) break;
            }
            
            if (pool && (volume > 0 || fees > 0)) {
                store.ww.push({ pool, volume, fees, apr });
            }
        }
        i++;
    }
    
    let html = '';
    store.ww.forEach(b => {
        html += `<div class="grid grid-cols-12 gap-1 border-b border-gray-800/50 py-1 text-gray-300 hover:bg-white/5 px-2">
            <div class="col-span-5 truncate text-white text-[10px]" title="${b.pool}">${b.pool}</div>
            <div class="col-span-2 text-right font-mono text-[9px] text-blue-300">${b.volume > 0 ? fmt$(b.volume) : '-'}</div>
            <div class="col-span-2 text-right font-mono text-[9px] text-green-300">${b.fees > 0 ? fmt$(b.fees) : '-'}</div>
            <div class="col-span-3 text-right text-[9px] text-yellow-400">${b.apr}</div>
        </div>`;
    });
    setHtml('ww-list', html || '<div class="text-center text-gray-600 italic py-4">No data parsed.</div>');
    setTxt('ww-count', store.ww.length);
    
    pasteStatus.ww = store.ww.length > 0;
    updatePasteStatus('ps-ww', pasteStatus.ww);
}

function getExportData() {
    // Aggregate votion pools from all lockups
    // Key insight: Each bucket uses 100% of lockup VP independently
    // So we sum VP amounts (not percentages) across all lockups for each pool
    
    let votionPools = {};
    let totalVp = 0;
    
    // First calculate total VP across all lockups
    store.votion.lockups.forEach(lockup => {
        totalVp += lockup.vp || 0;
    });
    
    console.log('Votion Export: Total VP from', store.votion.lockups.length, 'lockups:', totalVp.toLocaleString());
    
    // Now aggregate per-pool VP from all lockups
    // Helper to normalize pool name to match Vote page format
    // Vote page is source of truth - preserve its naming conventions
    function normalizePoolName(name) {
        // Remove LP suffix
        name = name.replace(' LP', '').trim();
        
        // Handle bridge suffix variations:
        // Votion sometimes uses "WBTCaxl" (no dot) vs "wBTC.axl" (with dot)
        // We normalize to include the dot: token.suffix
        
        // First, handle cases where suffix is attached without dot (WBTCaxl, WBTCosmo)
        // Only match if NOT preceded by a dot
        name = name.replace(/([^.])(atom|axl|osmo|wh)$/gi, (match, p1, p2) => p1 + '.' + p2.toLowerCase());
        
        // Now handle cases where suffix already has dot but wrong case (.ATOM -> .atom)
        name = name.replace(/\.(ATOM|AXL|OSMO|WH)/g, (match) => match.toLowerCase());
        
        // Handle token order - LUNA should be first for most pairs
        if (name.includes('-')) {
            let parts = name.split('-');
            
            // Only swap if LUNA itself is second (to put LUNA first)
            // Don't swap for ampLUNA, bLUNA - they stay as LUNA-ampLUNA, LUNA-bLUNA
            let secondBase = parts[1].replace(/\.(atom|axl|osmo|wh)$/i, '');
            if (secondBase === 'LUNA') {
                name = `LUNA-${parts[0]}`;
            }
        }
        
        return name;
    }
    
    store.votion.lockups.forEach(lockup => {
        let lockupVp = lockup.vp || 0;
        if (lockupVp === 0) return;
        
        console.log(`Processing ${lockup.type} ${lockup.duration}: ${lockupVp.toLocaleString()} VP`);
        
        lockup.buckets?.forEach(bucket => {
            let bucketName = (bucket.name || '').toLowerCase();
            
            bucket.pools?.forEach(pool => {
                // Normalize pool name to match Core tool format
                let poolName = normalizePoolName(pool.name);
                
                // Map to standard LP key format
                // All TLA pools are on Astroport
                let lpKey = `${poolName}|Astroport`;
                
                if (!votionPools[lpKey]) {
                    votionPools[lpKey] = {
                        current_vp: 0,
                        optimized_vp: 0,
                        current_pct: 0,
                        optimized_pct: 0,
                        bucket: bucketName,
                        lockup_contributions: []
                    };
                }
                
                // Calculate VP from this lockup's allocation
                let currentVp = lockupVp * (pool.current / 100);
                let optimizedVp = lockupVp * (pool.optimized / 100);
                
                votionPools[lpKey].current_vp += currentVp;
                votionPools[lpKey].optimized_vp += optimizedVp;
                
                // Track which lockups contribute (for debugging)
                votionPools[lpKey].lockup_contributions.push({
                    type: lockup.type,
                    duration: lockup.duration,
                    lockup_vp: lockupVp,
                    current_pct: pool.current,
                    optimized_pct: pool.optimized,
                    current_vp: currentVp,
                    optimized_vp: optimizedVp
                });
            });
        });
    });
    
    // Calculate percentages - since each bucket uses 100% of total VP,
    // the % within bucket equals % of total Votion VP
    Object.keys(votionPools).forEach(key => {
        if (totalVp > 0) {
            // This gives us the weighted average % within the bucket
            votionPools[key].current_pct = (votionPools[key].current_vp / totalVp) * 100;
            votionPools[key].optimized_pct = (votionPools[key].optimized_vp / totalVp) * 100;
        }
        // Round VP for cleaner output
        votionPools[key].current_vp = Math.round(votionPools[key].current_vp);
        votionPools[key].optimized_vp = Math.round(votionPools[key].optimized_vp);
    });
    
    console.log('Votion Export: Aggregated', Object.keys(votionPools).length, 'pools');
    
    // Aggregate PD bribes for current epoch - PER POOL
    let pdBribesForEpoch = {};
    let currentEpoch = store.meta.ep;
    
    store.pdBribesHistory.forEach(prop => {
        if (currentEpoch >= prop.start_epoch && currentEpoch <= prop.end_epoch) {
            prop.bribes?.forEach(bribe => {
                // Use pool name, not gauge (bucket)
                let lpKey = `${bribe.pool}|Astroport`;
                if (!pdBribesForEpoch[lpKey]) {
                    pdBribesForEpoch[lpKey] = { usd: 0, pct: 0, bucket: bribe.gauge };
                }
                pdBribesForEpoch[lpKey].usd += bribe.usd_per_epoch || 0;
                pdBribesForEpoch[lpKey].pct += bribe.percent || 0;
            });
        }
    });
    
    return {
        meta: {
            generated_at: new Date().toISOString(),
            epoch: store.meta.ep,
            phase: store.meta.ph,
            source: 'tla-admin-ext'
        },
        votion: {
            ratios: { arbLUNA: store.votion.ratioArb, ampLUNA: store.votion.ratioAmp },
            total_vp: Math.round(totalVp),
            pools: votionPools,
            lockups: store.votion.lockups // Keep raw lockups for reference
        },
        // Comprehensive LST ratios for dashboard snapshot
        lst_ratios: {
            snapshot_date: new Date().toISOString(),
            chain_staking_apr: store.lstRatios.chainStakingApr,
            chain_staking_apr_date: store.lstRatios.chainStakingAprDate,
            tokens: {
                ampLUNA: { ratio: store.lstRatios.ampLUNA.ratio, base: 'LUNA', apy: store.lstRatios.ampLUNA.apy },
                arbLUNA: { ratio: store.lstRatios.arbLUNA.ratio, base: 'LUNA', apy: store.lstRatios.arbLUNA.apy },
                bLUNA: { ratio: store.lstRatios.bLUNA.ratio, base: 'LUNA', apy: store.lstRatios.bLUNA.apy },
                ampCAPA: { ratio: store.lstRatios.ampCAPA.ratio, base: 'CAPA', apy: store.lstRatios.ampCAPA.apy },
                ampROAR: { ratio: store.lstRatios.ampROAR.ratio, base: 'ROAR', apy: store.lstRatios.ampROAR.apy },
                xASTRO: { ratio: store.lstRatios.xASTRO.ratio, base: 'ASTRO', apy: store.lstRatios.xASTRO.apy }
            }
        },
        pd_bribes: pdBribesForEpoch, // Simplified bribes for this epoch
        pd_bribes_master: store.pdBribesHistory, // Full bribe history
        astroport_data: store.astro,
        skeleton_swap_data: store.ww
    };
}

function clearAll() {
    if(confirm("Reset all Extension data?")) location.reload();
}

// ============================================
// PRICE MANAGER
// ============================================

const defaultBannerTokens = [
    { symbol: 'LUNA', geckoId: 'terra-luna-2', priority: 1 },
    { symbol: 'ampLUNA', geckoId: 'eris-amplified-luna', priority: 2 },
    { symbol: 'arbLUNA', geckoId: 'eris-arbitrage-luna', priority: 3 },
    { symbol: 'bLUNA', geckoId: 'backbone-labs-staked-luna', priority: 4 },
    { symbol: 'ROAR', geckoId: 'lion-dao', priority: 5 },
    { symbol: 'CAPA', geckoId: 'capapult', priority: 6 },
    { symbol: 'SOLID', geckoId: 'solid-2', priority: 7 },
    { symbol: 'xASTRO', geckoId: 'astroport-fi', priority: 8 },
    { symbol: 'wBTC', geckoId: 'eureka-bridged-wbtc-terra', priority: 9 },
    { symbol: 'ATOM', geckoId: 'cosmos', priority: 10 },
    { symbol: 'ETH', geckoId: 'ethereum', priority: 11 },
    { symbol: 'USDC', geckoId: 'usd-coin', priority: 12 }
];

let priceStore = {
    bannerTokens: [...defaultBannerTokens],
    prices: {},
    lstRatios: {},
    manualPrices: {},
    lastFetch: null,
    selectedTokens: {}
};
defaultBannerTokens.forEach(t => priceStore.selectedTokens[t.symbol] = true);

async function fetchAllPrices() {
    const statusEl = $('prices-fetch-status');
    if (!statusEl) return;
    statusEl.className = 'px-3 py-1 rounded text-[10px] font-bold bg-yellow-900/30 text-yellow-400';
    statusEl.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Fetching...';
    
    try {
        await fetchCoinGeckoPrices();
        await fetchLstRatiosFromChainForPrices();
        calculateDerivedPrices();
        renderBannerTokens();
        updateLstRatiosSummary();
        updatePriceSnapshotPreview();
        
        priceStore.lastFetch = new Date().toISOString();
        setTxt('price-status-time', new Date().toLocaleTimeString());
        
        statusEl.className = 'px-3 py-1 rounded text-[10px] font-bold bg-green-900/30 text-green-400';
        statusEl.innerHTML = '<i class="fas fa-check mr-1"></i> Fetched';
    } catch (error) {
        console.error('Price fetch error:', error);
        statusEl.className = 'px-3 py-1 rounded text-[10px] font-bold bg-red-900/30 text-red-400';
        statusEl.innerHTML = 'Error';
    }
}

async function fetchCoinGeckoPrices() {
    const geckoIds = priceStore.bannerTokens.map(t => t.geckoId).filter(Boolean).join(',');
    const url = `https://api.coingecko.com/api/v3/simple/price?ids=${geckoIds}&vs_currencies=usd`;
    setTxt('price-status-coingecko', '‚è≥');
    
    try {
        const response = await fetch(url);
        if (!response.ok) throw new Error('CoinGecko API failed');
        const data = await response.json();
        
        priceStore.bannerTokens.forEach(token => {
            if (token.geckoId && data[token.geckoId]?.usd) {
                priceStore.prices[token.symbol] = data[token.geckoId].usd;
            }
        });
        setTxt('price-status-coingecko', '‚úÖ');
    } catch (error) {
        setTxt('price-status-coingecko', '‚ùå');
        console.error('CoinGecko error:', error);
    }
}

async function fetchLstRatiosFromChainForPrices() {
    setTxt('price-status-lst', '‚è≥');
    try {
        const ampLunaQuery = btoa(JSON.stringify({ exchange_rates: {} }));
        const ampLunaUrl = `https://terra.publicnode.com/cosmwasm/wasm/v1/contract/terra10788fkzah89xrdm27zkj5yvhj9x3494lxawzm5qq3vvxcqz2yzaqyd3enk/smart/${ampLunaQuery}`;
        
        const ampLunaRes = await fetch(ampLunaUrl);
        if (ampLunaRes.ok) {
            const ampLunaData = await ampLunaRes.json();
            const rate = parseFloat(ampLunaData?.data?.exchange_rates?.[0]?.[1] || 0);
            if (rate > 0) {
                priceStore.lstRatios.ampLUNA = rate;
                setTxt('lst-sum-ampLUNA', rate.toFixed(4));
                const lstInput = $('lst-ratio-ampLUNA');
                if (lstInput) lstInput.value = rate.toFixed(4);
            }
        }
        
        priceStore.lstRatios.arbLUNA = store.lstRatios?.arbLUNA?.ratio || 2.6873;
        priceStore.lstRatios.bLUNA = store.lstRatios?.bLUNA?.ratio || 1.6048;
        priceStore.lstRatios.ampCAPA = store.lstRatios?.ampCAPA?.ratio || 1.1055;
        priceStore.lstRatios.ampROAR = store.lstRatios?.ampROAR?.ratio || 1.1087;
        priceStore.lstRatios.xASTRO = store.lstRatios?.xASTRO?.ratio || 1.22;
        
        setTxt('price-status-lst', '‚úÖ');
    } catch (error) {
        setTxt('price-status-lst', '‚ö†Ô∏è');
    }
}

function calculateDerivedPrices() {
    if (priceStore.prices.CAPA && priceStore.lstRatios.ampCAPA) {
        priceStore.manualPrices.ampCAPA = priceStore.prices.CAPA * priceStore.lstRatios.ampCAPA;
        const el = $('manual-price-ampCAPA');
        if (el) el.value = priceStore.manualPrices.ampCAPA.toFixed(6);
        setTxt('manual-status-ampCAPA', '‚úÖ Calculated');
    }
    if (priceStore.prices.ROAR && priceStore.lstRatios.ampROAR) {
        priceStore.manualPrices.ampROAR = priceStore.prices.ROAR * priceStore.lstRatios.ampROAR;
        const el = $('manual-price-ampROAR');
        if (el) el.value = priceStore.manualPrices.ampROAR.toFixed(6);
        setTxt('manual-status-ampROAR', '‚úÖ Calculated');
    }
}

function calcDerivedPrice(ampToken, baseToken) {
    const basePrice = priceStore.prices[baseToken];
    const ratio = priceStore.lstRatios[ampToken];
    if (!basePrice || !ratio) { alert(`Need ${baseToken} price and ${ampToken} ratio. Fetch prices first.`); return; }
    priceStore.manualPrices[ampToken] = basePrice * ratio;
    $(`manual-price-${ampToken}`).value = priceStore.manualPrices[ampToken].toFixed(6);
    setTxt(`manual-status-${ampToken}`, '‚úÖ Calculated');
    updatePriceSnapshotPreview();
}

function renderBannerTokens() {
    const container = $('banner-tokens-list');
    if (!container) return;
    let html = '';
    priceStore.bannerTokens.forEach(token => {
        const price = priceStore.prices[token.symbol];
        const checked = priceStore.selectedTokens[token.symbol] ? 'checked' : '';
        const priceDisplay = price ? `$${price < 0.01 ? price.toFixed(6) : price.toFixed(4)}` : '--';
        const statusClass = price ? 'text-green-400' : 'text-gray-600';
        html += `<div class="grid grid-cols-12 gap-2 items-center bg-[#0D0D0D] rounded p-2 text-[10px]">
            <input type="checkbox" ${checked} class="col-span-1" onchange="toggleTokenSelection('${token.symbol}', this.checked)">
            <span class="col-span-3 text-white font-medium">${token.symbol}</span>
            <span class="col-span-4 text-gray-500 truncate text-[9px]">${token.geckoId || '-'}</span>
            <span class="col-span-3 text-right font-mono ${statusClass}">${priceDisplay}</span>
            <span class="col-span-1 text-center">${price ? 'üü¢' : '‚ö™'}</span>
        </div>`;
    });
    container.innerHTML = html || '<div class="text-gray-600 text-[10px] italic">No tokens</div>';
}

function toggleTokenSelection(symbol, selected) { priceStore.selectedTokens[symbol] = selected; updatePriceSnapshotPreview(); }

function updateLstRatiosSummary() {
    Object.keys(priceStore.lstRatios).forEach(symbol => {
        const el = $(`lst-sum-${symbol}`);
        if (el && priceStore.lstRatios[symbol]) el.innerText = priceStore.lstRatios[symbol].toFixed(4);
    });
}

function updatePriceSnapshotPreview() {
    const snapshot = { prices: {}, lst_ratios: priceStore.lstRatios, timestamp: new Date().toISOString() };
    priceStore.bannerTokens.forEach(token => {
        if (priceStore.selectedTokens[token.symbol] && priceStore.prices[token.symbol]) {
            snapshot.prices[token.symbol] = priceStore.prices[token.symbol];
        }
    });
    Object.keys(priceStore.manualPrices).forEach(symbol => {
        if (priceStore.manualPrices[symbol]) snapshot.prices[symbol] = priceStore.manualPrices[symbol];
    });
    setTxt('price-snapshot-count', Object.keys(snapshot.prices).length + ' tokens');
    setTxt('price-snapshot-preview', JSON.stringify(snapshot, null, 2));
}

function copyPriceSnapshot() {
    navigator.clipboard.writeText($('price-snapshot-preview').innerText);
    alert('Copied!');
}

function addManualToken() {
    const symbol = prompt('Enter token symbol:');
    if (!symbol) return;
    const container = $('additional-manual-tokens');
    container.insertAdjacentHTML('beforeend', `<div class="grid grid-cols-12 gap-2 items-center bg-[#0D0D0D] rounded p-2" id="manual-row-${symbol}">
        <input type="text" class="col-span-3 input-dark text-[10px]" value="${symbol}" readonly>
        <div class="col-span-3 text-[9px] text-gray-500">Manual</div>
        <input type="number" id="manual-price-${symbol}" step="0.0001" class="col-span-3 input-dark text-[10px] text-right" placeholder="USD" onchange="updateManualPrice('${symbol}', this.value)">
        <span id="manual-status-${symbol}" class="col-span-2 text-[9px] text-gray-600">‚ùå</span>
        <button onclick="$('manual-row-${symbol}').remove();delete priceStore.manualPrices['${symbol}'];updatePriceSnapshotPreview()" class="col-span-1 text-red-400"><i class="fas fa-trash"></i></button>
    </div>`);
}

function updateManualPrice(symbol, value) {
    const price = parseFloat(value);
    if (price > 0) { priceStore.manualPrices[symbol] = price; setTxt(`manual-status-${symbol}`, '‚úÖ'); }
    else { delete priceStore.manualPrices[symbol]; setTxt(`manual-status-${symbol}`, '‚ùå'); }
    updatePriceSnapshotPreview();
}

// ============================================
// DASHBOARD STATS
// ============================================

let dashboardStore = { tiles: {}, tlaDeposits: null, mode: 'paste' };

function setDashMode(mode) {
    dashboardStore.mode = mode;
    $('dash-mode-paste').className = mode === 'paste' ? 'flex-1 text-[10px] py-1.5 rounded bg-yellow-900/50 text-yellow-400 border border-yellow-700' : 'flex-1 text-[10px] py-1.5 rounded bg-gray-800 text-gray-500 border border-gray-700';
    $('dash-mode-manual').className = mode === 'manual' ? 'flex-1 text-[10px] py-1.5 rounded bg-yellow-900/50 text-yellow-400 border border-yellow-700' : 'flex-1 text-[10px] py-1.5 rounded bg-gray-800 text-gray-500 border border-gray-700';
    $('dash-paste-section').classList.toggle('hidden', mode !== 'paste');
    $('dash-manual-section').classList.toggle('hidden', mode !== 'manual');
}

async function fetchDashboardData() {
    const statusEl = $('dashboard-status');
    if (!statusEl) return;
    statusEl.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Fetching...';
    
    try {
        setTxt('dash-status-chain', '‚è≥');
        const statsRes = await fetch('https://deving.zone/api/nft/stats/terra1tpl03d6mvh2emu7lwl3062w8h3f7e7q5xd7zcx');
        if (statsRes.ok) {
            const stats = await statsRes.json();
            dashboardStore.tiles.nft = {
                total_minted: stats.collection_stats?.num_tokens || 0,
                unminted: 10000 - (stats.collection_stats?.num_tokens || 0),
                broken_count: stats.nfts?.filter(n => n.special_trait === 'BROKEN').length || 0
            };
            setTxt('dash-nft-minted', dashboardStore.tiles.nft.total_minted.toLocaleString());
            setTxt('dash-nft-unminted', dashboardStore.tiles.nft.unminted.toLocaleString());
            setTxt('dash-nft-broken', dashboardStore.tiles.nft.broken_count.toLocaleString());
            setTxt('dash-status-chain', '‚úÖ');
        }
        
        setTxt('dash-status-prices', priceStore.prices.LUNA ? '‚úÖ' : '‚ö†Ô∏è Load Prices');
        setTxt('dash-status-ampluna', priceStore.lstRatios.ampLUNA ? '‚úÖ' : '‚ö†Ô∏è');
        setTxt('dash-status-daodao', '‚ö†Ô∏è Manual');
        setTxt('dash-status-treasury', '‚ö†Ô∏è Manual');
        statusEl.innerHTML = '‚ö†Ô∏è Partial';
        updateDashboardSnapshotPreview();
    } catch (e) {
        statusEl.innerHTML = '‚ùå Error';
    }
}

function parseDashTla() {
    const geckoIds = { 'LUNA': 'terra-luna-2', 'ampLUNA': 'eris-amplified-luna', 'CAPA': 'capapult', 'ROAR': 'lion-dao', 'xASTRO': 'astroport-fi' };
    const tokenBalances = [];
    let totalDeposit = 0, estApr = 0;
    
    if (dashboardStore.mode === 'paste') {
        const tokensText = $('dash-tla-tokens-paste')?.value?.trim() || '';
        const usdText = $('dash-tla-usd-paste')?.value?.trim() || '';
        
        if (tokensText) {
            tokensText.split('\n').forEach(line => {
                const parts = line.split(/\t+/);
                if (parts.length >= 2) {
                    const name = parts[0].trim(), amount = parseFloat(parts[1].trim());
                    if (name && !isNaN(amount)) tokenBalances.push({ name, amount, geckoId: geckoIds[name] || null });
                }
            });
        }
        if (usdText) {
            let m = usdText.match(/([\d\s,]+\.?\d*)\s*\$/);
            if (m) totalDeposit = parseFloat(m[1].replace(/[\s,]/g, ''));
            m = usdText.match(/APR\s*([\d.]+)\s*%/i);
            if (m) estApr = parseFloat(m[1]);
        }
    } else {
        totalDeposit = parseFloat($('dash-manual-usd')?.value) || 0;
        estApr = parseFloat($('dash-manual-apr')?.value) || 0;
        ['LUNA', 'ampLUNA', 'CAPA', 'ampCAPA', 'ROAR', 'ampROAR', 'xASTRO'].forEach(name => {
            const amount = parseFloat($(`dash-manual-${name}`)?.value) || 0;
            if (amount > 0) tokenBalances.push({ name, amount, geckoId: geckoIds[name] || null });
        });
    }
    
    dashboardStore.tlaDeposits = { totalDeposit, estApr, tokenBalances, snapshotDate: new Date().toISOString(), lstRatios: { ...priceStore.lstRatios } };
    
    setHtml('dash-tla-preview', `<div class="space-y-1">
        <div class="flex justify-between"><span class="text-gray-500">Total USD:</span><span class="text-green-400 font-mono">$${totalDeposit.toLocaleString()}</span></div>
        <div class="flex justify-between"><span class="text-gray-500">Est APR:</span><span class="text-yellow-400 font-mono">${estApr.toFixed(2)}%</span></div>
        <div class="border-t border-gray-800 pt-1 mt-1 text-[9px]">${tokenBalances.map(t => `<div class="flex justify-between"><span class="text-gray-400">${t.name}:</span><span class="text-white">${t.amount.toLocaleString()}</span></div>`).join('')}</div>
    </div>`);
    setTxt('dash-tla-usd', '$' + totalDeposit.toLocaleString());
    setTxt('dash-tla-apr', estApr.toFixed(2) + '%');
    updateDashboardSnapshotPreview();
}

function updateDashboardSnapshotPreview() {
    const snapshot = { timestamp: new Date().toISOString(), epoch: store.meta?.epoch, tiles: dashboardStore.tiles, tla_deposits: dashboardStore.tlaDeposits, prices_at_snapshot: { ...priceStore.prices, ...priceStore.manualPrices } };
    setTxt('dashboard-snapshot-preview', JSON.stringify(snapshot, null, 2));
}

function downloadDashboardSnapshot() {
    const epoch = store.meta?.epoch || 'unknown';
    const blob = new Blob([$('dashboard-snapshot-preview').innerText], { type: 'application/json' });
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `adao-snapshot_${epoch}_end.json`; a.click();
}

// ============================================
// NFT STATS
// ============================================

let nftStore = { bbl: { collection: null, listings: [], epochSales: [] }, boost: { epochSales: [] }, prices: {} };

function loadNftPricesFromPriceManager() {
    $('nft-price-luna').value = priceStore.prices.LUNA || '';
    $('nft-price-ampluna').value = priceStore.prices.ampLUNA || '';
    $('nft-price-bluna').value = priceStore.prices.bLUNA || '';
    $('nft-price-arbluna').value = priceStore.prices.arbLUNA || '';
    $('nft-price-solid').value = priceStore.prices.SOLID || '';
    updateNftFloorUsd();
}

function getNftPrices() {
    return { luna: parseFloat($('nft-price-luna')?.value) || 0, ampluna: parseFloat($('nft-price-ampluna')?.value) || 0, bluna: parseFloat($('nft-price-bluna')?.value) || 0, arbluna: parseFloat($('nft-price-arbluna')?.value) || 0, solid: parseFloat($('nft-price-solid')?.value) || 0, usdc: 1 };
}

function nftToUsd(amount, token) { const p = getNftPrices(); return amount * (p[token.toLowerCase()] || 0); }

function updateNftFloorUsd() {
    const p = getNftPrices();
    const ub = parseFloat($('nft-floor-unbroken-amount')?.value) || 0;
    const br = parseFloat($('nft-floor-broken-amount')?.value) || 0;
    setTxt('nft-floor-unbroken-usd', ub > 0 ? '$' + (ub * p.bluna).toFixed(2) : '--');
    setTxt('nft-floor-broken-usd', br > 0 ? '$' + (br * p.bluna).toFixed(2) : '--');
    updateNftSnapshotPreview();
}

async function fetchNftData() {
    const statusEl = $('nft-status');
    if (!statusEl) return;
    statusEl.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Fetching...';
    try {
        const res = await fetch('https://deving.zone/api/nft/meta/terra1tpl03d6mvh2emu7lwl3062w8h3f7e7q5xd7zcx');
        if (res.ok) {
            const data = await res.json();
            // Auto-fill collection JSON
            $('nft-bbl-collection-json').value = JSON.stringify(data);
            parseNftBblCollection();
            statusEl.innerHTML = '‚úÖ Fetched';
        }
    } catch (e) { statusEl.innerHTML = '‚ùå Error'; }
}

function parseNftBblCollection() {
    const json = $('nft-bbl-collection-json')?.value?.trim();
    if (!json) return;
    try {
        const data = JSON.parse(json);
        nftStore.bbl.collection = data;
        const p = getNftPrices();
        const volumeUSD = data.volume && p.bluna ? (data.volume * p.bluna).toFixed(2) : '?';
        setTxt('nft-bbl-volume', `${data.volume?.toLocaleString() || '?'} bLUNA ($${volumeUSD})`);
        setTxt('nft-bbl-recent', `#${data.last_sale_token_id || '?'} for ${data.last_sale_amount || '?'} bLUNA`);
        $('nft-bbl-collection-results')?.classList.remove('hidden');
        setTxt('nft-bbl-collection-status', '‚úÖ');
    } catch (e) { setTxt('nft-bbl-collection-status', '‚ùå ' + e.message); }
}

function parseNftBblListings() {
    const json = $('nft-bbl-listings-json')?.value?.trim();
    if (!json) return;
    try {
        const data = JSON.parse(json);
        if (data.nfts) {
            nftStore.bbl.listings = data.nfts;
            let floorBroken = null, floorUnbroken = null, floorBrokenId = null, floorUnbrokenId = null;
            data.nfts.forEach(nft => {
                const price = nft.auction?.reserve_price ? nft.auction.reserve_price / 1e6 : null;
                const isBroken = nft.special_trait === 'BROKEN';
                if (price) {
                    if (isBroken && (floorBroken === null || price < floorBroken)) { floorBroken = price; floorBrokenId = nft.nft_token_id; }
                    if (!isBroken && (floorUnbroken === null || price < floorUnbroken)) { floorUnbroken = price; floorUnbrokenId = nft.nft_token_id; }
                }
            });
            if (floorUnbroken !== null) { $('nft-floor-unbroken-id').value = floorUnbrokenId; $('nft-floor-unbroken-amount').value = floorUnbroken; }
            if (floorBroken !== null) { $('nft-floor-broken-id').value = floorBrokenId; $('nft-floor-broken-amount').value = floorBroken; }
            updateNftFloorUsd();
            setTxt('nft-bbl-listings-status', `‚úÖ ${data.nfts.length} listings`);
        }
    } catch (e) { setTxt('nft-bbl-listings-status', '‚ùå ' + e.message); }
}

function addNftBblSale() {
    const id = $('nft-bbl-sale-id')?.value?.trim(), amount = parseFloat($('nft-bbl-sale-amount')?.value) || 0, token = $('nft-bbl-sale-token')?.value;
    if (!id || !amount) return;
    nftStore.bbl.epochSales.push({ id, amount, token });
    $('nft-bbl-sale-id').value = ''; $('nft-bbl-sale-amount').value = '';
    renderNftBblSales();
}

function renderNftBblSales() {
    const list = $('nft-bbl-sales-list');
    if (!list) return;
    if (nftStore.bbl.epochSales.length === 0) { list.innerHTML = '<div class="text-gray-600 italic">No sales</div>'; return; }
    const p = getNftPrices();
    list.innerHTML = nftStore.bbl.epochSales.map((s, i) => {
        const usd = nftToUsd(s.amount, s.token);
        return `<div class="flex justify-between items-center bg-[#0D0D0D] rounded p-1">
            <span class="text-white">#${s.id}</span>
            <span class="text-orange-400">${s.amount} ${s.token}</span>
            <span class="text-green-400">$${usd.toFixed(2)}</span>
            <button onclick="nftStore.bbl.epochSales.splice(${i},1);renderNftBblSales()" class="text-red-400 text-[9px]">‚úï</button>
        </div>`;
    }).join('');
    updateNftSnapshotPreview();
}

function addNftBoostSale() {
    const id = $('nft-boost-sale-id')?.value?.trim(), amount = parseFloat($('nft-boost-sale-amount')?.value) || 0, token = $('nft-boost-sale-token')?.value;
    if (!id || !amount) return;
    nftStore.boost.epochSales.push({ id, amount, token });
    $('nft-boost-sale-id').value = ''; $('nft-boost-sale-amount').value = '';
    renderNftBoostSales();
}

function renderNftBoostSales() {
    const list = $('nft-boost-sales-list');
    if (!list) return;
    if (nftStore.boost.epochSales.length === 0) { list.innerHTML = '<div class="text-gray-600 italic">No sales</div>'; return; }
    list.innerHTML = nftStore.boost.epochSales.map((s, i) => {
        const usd = nftToUsd(s.amount, s.token);
        return `<div class="flex justify-between items-center bg-[#0D0D0D] rounded p-1">
            <span class="text-white">#${s.id}</span>
            <span class="text-cyan-400">${s.amount} ${s.token}</span>
            <span class="text-green-400">$${usd.toFixed(2)}</span>
            <button onclick="nftStore.boost.epochSales.splice(${i},1);renderNftBoostSales()" class="text-red-400 text-[9px]">‚úï</button>
        </div>`;
    }).join('');
    updateNftSnapshotPreview();
}

function updateNftSnapshotPreview() {
    const p = getNftPrices();
    const snapshot = {
        snapshot_time: new Date().toISOString(),
        epoch: store.meta?.epoch,
        prices_at_snapshot: p,
        bbl: {
            collection: nftStore.bbl.collection,
            floor_unbroken: { id: $('nft-floor-unbroken-id')?.value, bluna: parseFloat($('nft-floor-unbroken-amount')?.value) || 0 },
            floor_broken: { id: $('nft-floor-broken-id')?.value, bluna: parseFloat($('nft-floor-broken-amount')?.value) || 0 },
            epoch_sales: nftStore.bbl.epochSales.map(s => ({ ...s, usd: nftToUsd(s.amount, s.token) }))
        },
        boost: { epoch_sales: nftStore.boost.epochSales.map(s => ({ ...s, usd: nftToUsd(s.amount, s.token) })) }
    };
    setTxt('nft-snapshot-preview', JSON.stringify(snapshot, null, 2));
}

function downloadNftSnapshot() {
    const epoch = store.meta?.epoch || 'unknown';
    const blob = new Blob([$('nft-snapshot-preview').innerText], { type: 'application/json' });
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `nft-snapshot_${epoch}_end.json`; a.click();
}

// ============================================
// NEWS
// ============================================

let newsStore = { articles: [] };

function addNewsArticle() {
    const title = $('news-title')?.value?.trim();
    const url = $('news-url')?.value?.trim();
    if (!title || !url) { alert('Title and URL required'); return; }
    
    const article = {
        id: 'news-' + Date.now(),
        title,
        url,
        date: $('news-date')?.value || new Date().toISOString().split('T')[0],
        tags: ($('news-tags')?.value || '').split(',').map(t => t.trim()).filter(Boolean),
        content: $('news-content')?.value?.trim() || '',
        images: ($('news-images')?.value || '').split('\n').map(u => u.trim()).filter(Boolean),
        added_at: new Date().toISOString()
    };
    
    newsStore.articles.unshift(article);
    renderNewsArticles();
    
    // Clear form
    $('news-title').value = ''; $('news-url').value = ''; $('news-content').value = ''; $('news-tags').value = ''; $('news-images').value = '';
}

function renderNewsArticles() {
    const list = $('news-articles-list');
    setTxt('news-count', newsStore.articles.length);
    if (newsStore.articles.length === 0) { list.innerHTML = '<div class="text-gray-600 text-[10px] italic">No articles</div>'; return; }
    
    list.innerHTML = newsStore.articles.map((a, i) => `
        <div class="bg-[#0D0D0D] rounded p-3 border border-gray-800">
            <div class="flex justify-between items-start">
                <div class="flex-1">
                    <a href="${a.url}" target="_blank" class="text-orange-400 font-bold text-sm hover:text-orange-300">${a.title}</a>
                    <div class="text-[9px] text-gray-500 mt-1">${a.date} | ${a.tags.map(t => '<span class="bg-gray-800 px-1 rounded">' + t + '</span>').join(' ')}</div>
                    ${a.content ? '<p class="text-[10px] text-gray-400 mt-2">' + a.content.substring(0, 200) + (a.content.length > 200 ? '...' : '') + '</p>' : ''}
                </div>
                <button onclick="newsStore.articles.splice(${i},1);renderNewsArticles()" class="text-red-400 hover:text-red-300 ml-2"><i class="fas fa-trash"></i></button>
            </div>
        </div>
    `).join('');
}

function clearAllNews() { if (confirm('Clear all news?')) { newsStore.articles = []; renderNewsArticles(); } }

function downloadNewsJson() {
    const blob = new Blob([JSON.stringify({ version: 1, updated: new Date().toISOString(), articles: newsStore.articles }, null, 2)], { type: 'application/json' });
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'terra-news.json'; a.click();
}

async function loadNewsFromGithub() {
    try {
        const res = await fetch('https://raw.githubusercontent.com/defipatriot/tla_json_storage/main/terra-news.json');
        if (res.ok) {
            const data = await res.json();
            newsStore.articles = data.articles || [];
            renderNewsArticles();
            alert('Loaded ' + newsStore.articles.length + ' articles');
        }
    } catch (e) { alert('Could not load news: ' + e.message); }
}

// ============================================
// DAO PROPOSALS
// ============================================

let daoStore = { proposals: [] };

function addDaoProposal() {
    const id = $('dao-prop-id')?.value?.trim();
    const title = $('dao-prop-title')?.value?.trim();
    if (!id || !title) { alert('ID and Title required'); return; }
    
    const proposal = {
        id,
        title,
        status: $('dao-prop-status')?.value || 'passed',
        date: $('dao-prop-date')?.value || new Date().toISOString().split('T')[0],
        link: $('dao-prop-link')?.value?.trim() || '',
        category: $('dao-prop-category')?.value || 'governance',
        description: $('dao-prop-description')?.value?.trim() || '',
        votes: {
            yes: parseFloat($('dao-prop-yes')?.value) || 0,
            no: parseFloat($('dao-prop-no')?.value) || 0,
            abstain: parseFloat($('dao-prop-abstain')?.value) || 0
        },
        added_at: new Date().toISOString()
    };
    
    // Check if editing existing
    const existingIdx = daoStore.proposals.findIndex(p => p.id === id);
    if (existingIdx >= 0) {
        daoStore.proposals[existingIdx] = proposal;
    } else {
        daoStore.proposals.unshift(proposal);
    }
    renderDaoProposals();
    
    // Clear form
    $('dao-prop-id').value = ''; $('dao-prop-title').value = ''; $('dao-prop-description').value = '';
    $('dao-prop-link').value = ''; $('dao-prop-yes').value = ''; $('dao-prop-no').value = ''; $('dao-prop-abstain').value = '';
}

function renderDaoProposals() {
    const list = $('dao-proposals-list');
    const filter = $('dao-filter-status')?.value || 'all';
    const filtered = filter === 'all' ? daoStore.proposals : daoStore.proposals.filter(p => p.status === filter);
    setTxt('dao-count', daoStore.proposals.length);
    
    if (filtered.length === 0) { list.innerHTML = '<div class="text-gray-600 text-[10px] italic">No proposals</div>'; return; }
    
    const statusIcons = { passed: '‚úÖ', rejected: '‚ùå', executed: 'üü¢', pending: '‚è≥', vetoed: 'üö´' };
    
    list.innerHTML = filtered.map((p, i) => `
        <div class="bg-[#0D0D0D] rounded p-3 border border-gray-800">
            <div class="flex justify-between items-start">
                <div class="flex-1">
                    <div class="flex items-center gap-2">
                        <span class="text-blue-400 font-mono font-bold">${p.id}</span>
                        <span>${statusIcons[p.status] || ''}</span>
                        <span class="text-white font-medium">${p.title}</span>
                    </div>
                    <div class="text-[9px] text-gray-500 mt-1">${p.date} | ${p.category}</div>
                    ${p.description ? '<p class="text-[10px] text-gray-400 mt-2">' + p.description.substring(0, 150) + '</p>' : ''}
                    <div class="flex gap-3 mt-2 text-[9px]">
                        <span class="text-green-400">Yes: ${p.votes.yes}%</span>
                        <span class="text-red-400">No: ${p.votes.no}%</span>
                        <span class="text-gray-400">Abstain: ${p.votes.abstain}%</span>
                    </div>
                </div>
                <div class="flex gap-1">
                    ${p.link ? `<a href="${p.link}" target="_blank" class="text-blue-400 hover:text-blue-300"><i class="fas fa-external-link-alt"></i></a>` : ''}
                    <button onclick="editDaoProposal(${i})" class="text-yellow-400 hover:text-yellow-300 ml-2"><i class="fas fa-edit"></i></button>
                    <button onclick="daoStore.proposals.splice(${i},1);renderDaoProposals()" class="text-red-400 hover:text-red-300"><i class="fas fa-trash"></i></button>
                </div>
            </div>
        </div>
    `).join('');
}

function editDaoProposal(idx) {
    const p = daoStore.proposals[idx];
    $('dao-prop-id').value = p.id;
    $('dao-prop-title').value = p.title;
    $('dao-prop-status').value = p.status;
    $('dao-prop-date').value = p.date;
    $('dao-prop-link').value = p.link;
    $('dao-prop-category').value = p.category;
    $('dao-prop-description').value = p.description;
    $('dao-prop-yes').value = p.votes.yes;
    $('dao-prop-no').value = p.votes.no;
    $('dao-prop-abstain').value = p.votes.abstain;
}

function downloadDaoJson() {
    const blob = new Blob([JSON.stringify({ version: 1, updated: new Date().toISOString(), proposals: daoStore.proposals }, null, 2)], { type: 'application/json' });
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'adao-proposals.json'; a.click();
}

async function loadProposalsFromGithub() {
    try {
        const res = await fetch('https://raw.githubusercontent.com/defipatriot/tla_json_storage/main/adao-proposals.json');
        if (res.ok) {
            const data = await res.json();
            daoStore.proposals = data.proposals || [];
            renderDaoProposals();
            alert('Loaded ' + daoStore.proposals.length + ' proposals');
        }
    } catch (e) { alert('Could not load proposals: ' + e.message); }
}

async function fetchProposalsFromDaodao() {
    alert('DAODAO API fetch not yet implemented. Please add proposals manually or load from GitHub.');
}
</script>
</body>
</html>
