<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alliance DAO Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <script>
     window.va = window.va || function () { (window.va.q = window.va.q || []).push(arguments); };
    </script>
    <script src="/_vercel/insights/script.js" defer></script>
    
    <style>
        /* --- Base Styles --- */
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: #0D0D0D;
            color: #EAEAEA;
        }

        /* --- Card Styles --- */
        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            /* backdrop-filter: blur(10px); */ /* PERFORMANCE: Commented out, this is very expensive */
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .stat-card:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(45, 212, 191, 0.5);
        }
        .info-card {
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 1.5rem;
        }
        .info-card .icon {
            font-size: 1.75rem;
            margin-bottom: 0.75rem;
            color: #2dd4bf; /* teal-400 */
        }
        .info-card h3 {
            font-size: 1.125rem;
            font-weight: 700;
            color: #fff;
            margin-bottom: 0.5rem;
        }
        .info-card p, .info-card .link-text {
            font-size: 0.875rem;
            color: #9ca3af; /* gray-400 */
            line-height: 1.5;
            flex-grow: 1; /* Allows text to take up space */
        }
         .info-card .link-group {
            margin-top: 1rem;
        }
        .info-card a:hover .link-text, .info-card a:hover h3, .info-card .link-text a:hover {
            color: #2dd4bf;
        }
        .stat-card .subtext {
            min-height: 1.25rem; /* Ensures space is reserved for subtext */
        }

        /* --- Slider Styles --- */
        .slider-bar {
            display: flex;
            height: 0.75rem;
            border-radius: 9999px;
            overflow: hidden;
            position: relative;
        }
        .slider-fill-blue {
            background: linear-gradient(90deg, #00F2FE, #2889FC);
        }
        .slider-fill-gray {
            background-color: #374151; /* gray-700 */
        }

        /* --- Pulse Animation for Live Proposals --- */
        .pulse-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #4ade80; /* green-400 */
            animation: pulse 2s infinite;
            /* box-shadow: 0 0 0 0 rgba(74, 222, 128, 1); */ /* PERFORMANCE: Removed expensive shadow animation */
        }
        @keyframes pulse {
            0% { transform: scale(0.95); /* box-shadow: 0 0 0 0 rgba(74, 222, 128, 0.7); */ }
            70% { transform: scale(1); /* box-shadow: 0 0 0 10px rgba(74, 222, 128, 0); */ }
            100% { transform: scale(0.95); /* box-shadow: 0 0 0 0 rgba(74, 222, 128, 0); */ }
        }

        /* --- Red Static Dot for No Proposals --- */
        .static-dot-red {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #ef4444; /* red-500 */
        }
        
        /* --- Modal Styles (Generic) --- */
        .modal {
            transition: opacity 0.3s ease;
        }
        .modal.hidden {
            pointer-events: none;
        }
        .modal .modal-content {
            transition: transform 0.3s ease, opacity 0.3s ease;
            max-height: 90vh; /* Keep overall max height */
        }
        .modal.hidden .modal-content {
            transform: scale(0.95);
            opacity: 0;
        }

        /* --- NFT Explorer Modal Styles --- */
         .modal-backdrop {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex; align-items: center; justify-content: center;
            z-index: 50; 
            /* backdrop-filter: blur(4px); */ /* PERFORMANCE: Commented out, expensive */
        }
        .modal-content-explorer { /* Renamed to avoid conflict */
            background-color: #1f2937; border: 1px solid #4b5563;
            border-radius: 0.75rem; padding: 1.5rem;
            max-width: 90vw; max-height: 90vh;
            width: 500px; /* Specific width from explorer */
            overflow-y: auto;
            position: relative;
        }
        .modal-close-btn {
            position: absolute; top: 1rem; right: 1rem;
            color: #9ca3af; cursor: pointer;
        }
        .modal-close-btn:hover { color: #e5e7eb; }
        .control-btn { /* Style for download button */
            background-color: #374151; /* gray-700 */
            color: #e5e7eb; /* gray-200 */
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            border: 1px solid #4b5563; /* gray-600 */
            transition: background-color 0.2s;
            font-weight: 500;
        }
        .control-btn:hover:not(:disabled) {
            background-color: #4b5563; /* gray-600 */
        }
        
        /* --- Snapshot Link Style --- */
        #snapshot-link { /* Changed ID from snapshot-btn */
             cursor: pointer;
        }
        #snapshot-link.disabled { /* Style for disabled link */
             opacity: 0.5;
             cursor: not-allowed;
             text-decoration: none; /* Remove underline when disabled */
        }
        #snapshot-link.disabled:hover { /* Prevent hover effect when disabled */
             color: #9ca3af; /* gray-400 */
        }

    </style>
</head>
<body class="antialiased">

    <header class="py-4">
        <!-- Flex Container wrapping content. Mobile: Wrap allowed. Desktop: No Wrap. -->
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex flex-wrap md:flex-nowrap justify-between items-center">
            
            <!-- Left Logo: Mobile Order 1. Width 50% on mobile. -->
            <div class="flex-shrink-0 w-1/2 md:w-32 order-1">
                 <img src="https://raw.githubusercontent.com/defipatriot/aDAO-Image-Files/main/Alliance%20DAO%20Logo.png" alt="Alliance DAO Logo" class="h-12 md:h-16 w-auto" onerror="this.src='https://placehold.co/128x64/0D0D0D/EAEAEA?text=Logo'; this.onerror=null;">
            </div>

            <!-- Navigation: Mobile Order 3 (New Row). Full width on mobile. Desktop Order 2 (Center). -->
            <nav class="flex-1 w-full md:w-auto flex justify-center items-center gap-3 order-3 md:order-2 mt-4 md:mt-0">
                <!-- Buttons are smaller on mobile (text-xs/sm, less padding) to fit 3 in a row -->
                <a href="nft-explorer-index.html" class="bg-gray-800/50 hover:bg-gray-700/80 border border-gray-700 text-white font-bold py-2 px-3 text-xs sm:text-sm md:py-3 md:px-8 md:text-base rounded-lg shadow-lg transition-all transform hover:scale-105 whitespace-nowrap text-center">
                    NFT Explorer
                </a>
                 <a href="planet-map.html" class="bg-gray-800/50 hover:bg-gray-700/80 border border-gray-700 text-white font-bold py-2 px-3 text-xs sm:text-sm md:py-3 md:px-8 md:text-base rounded-lg shadow-lg transition-all transform hover:scale-105 whitespace-nowrap text-center">
                    Galaxy Map
                </a>
                <a href="tla-stats.html" class="bg-gray-800/50 hover:bg-gray-700/80 border border-gray-700 text-white font-bold py-2 px-3 text-xs sm:text-sm md:py-3 md:px-8 md:text-base rounded-lg shadow-lg transition-all transform hover:scale-105 whitespace-nowrap text-center">
                    TLA Stats
                </a>
            </nav>

            <!-- Right Logo: Mobile Order 2. Width 50% on mobile. Aligned Right. Desktop Order 3. -->
            <div class="w-1/2 md:w-32 flex-shrink-0 flex justify-end order-2 md:order-3">
                 <img src="https://raw.githubusercontent.com/defipatriot/aDAO-Image-Planets-Empty/main/Terra.PNG" alt="Terra Logo" class="h-12 md:h-16 w-auto" onerror="this.src='https://placehold.co/128x64/0D0D0D/EAEAEA?text=Logo'; this.onerror=null;">
            </div>
        </div>
    </header>

    <div class="py-2 border-b border-gray-800">
        <script src="https://widgets.coingecko.com/gecko-coin-price-marquee-widget.js"></script>
<gecko-coin-price-marquee-widget locale="en" dark-mode="true" outlined="true" coin-ids="terra-luna-2,eris-amplified-luna,eris-arbitrage-luna,backbone-labs-staked-luna,lion-dao,capapult,solid-2,astroport-fi,eureka-bridged-wbtc-terra,cosmos,ethereum" initial-currency="usd"></gecko-coin-price-marquee-widget>
    </div>


    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <div id="disclaimer-banner" class="bg-yellow-500/10 border border-yellow-400/30 text-yellow-300 px-4 py-3 rounded-lg relative mb-8 text-center" role="alert">
            <strong class="font-bold">Please Note:</strong>
            <span class="block sm:inline">Tiles with a <span class="inline-block w-2.5 h-2.5 rounded-full bg-red-500 mx-1 align-middle"></span> are from a snapshot. Tiles with a <span class="inline-block w-2.5 h-2.5 rounded-full bg-green-400 mx-1 align-middle"></span> are from a live feed.</span>
            <span id="close-banner" class="absolute top-0 bottom-0 right-0 px-4 py-3 cursor-pointer">
                <svg class="fill-current h-6 w-6 text-yellow-400" role="button" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><title>Close</title><path d="M14.348 14.849a1.2 1.2 0 0 1-1.697 0L10 11.819l-2.651 3.029a1.2 1.2 0 1 1-1.697-1.697l2.758-3.15-2.759-3.152a1.2 1.2 0 1 1-1.697-1.697L10 8.183l2.651-3.031a1.2 1.2 0 1 1-1.697 1.697l-2.758 3.152 2.758 3.15a1.2 1.2 0 0 1 0 1.698z"/></svg>
            </span>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <a href="ally.html" class="stat-card info-card rounded-xl group">
                <i class="fas fa-layer-group icon"></i>
                <h3 class="group-hover:text-teal-400">ALLY Rewards</h3>
                <p>A pioneering collection backed by LUNA staking rewards. Your share of the pool grows as others claim theirs.</p>
                <span class="link-text link-group">Learn More &rarr;</span>
            </a>
            <div class="flex flex-col gap-4">
                 <a href="tutorials.html" class="stat-card info-card rounded-xl group flex-1">
                      <i class="fas fa-video icon !mb-2"></i>
                      <h3 class="group-hover:text-teal-400 !mb-0">Tutorials & Guides</h3>
                 </a>
                 <a href="news.html" class="stat-card info-card rounded-xl group flex-1">
                      <i class="fas fa-newspaper icon !mb-2"></i>
                      <h3 class="group-hover:text-teal-400 !mb-0">Ecosystem News</h3>
                 </a>
            </div>
             <div class="flex flex-col gap-4">
                <a href="rarity-explained.html" class="stat-card info-card rounded-xl group flex-1">
                     <i class="fas fa-gem icon !mb-2"></i>
                     <h3 class="group-hover:text-teal-400 !mb-0">Rarity Info</h3>
                </a>
                <a href="release-history.html" class="stat-card info-card rounded-xl group flex-1">
                     <i class="fas fa-stream icon !mb-2"></i>
                     <h3 class="group-hover:text-teal-400 !mb-0">NFT Release History</h3>
                </a>
            </div>
            <div class="flex flex-col gap-4">
                <a href="links.html" class="stat-card info-card rounded-xl group flex-1">
                     <i class="fas fa-link icon !mb-2"></i>
                     <h3 class="group-hover:text-teal-400 !mb-0">Official Links</h3>
                </a>
                <a href="alliances.html" class="stat-card info-card rounded-xl group flex-1">
                     <i class="fas fa-handshake icon !mb-2"></i>
                     <h3 class="group-hover:text-teal-400 !mb-0">Our Alliances</h3>
                </a>
            </div>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <div class="stat-card p-4 rounded-xl">
                <div class="flex justify-between items-center text-sm font-medium text-gray-300">
                    <span>Un-minted</span>
                    <h3 class="text-base font-semibold text-gray-400">Mint Status</h3>
                    <span>Minted</span>
                </div>
                <div id="mint-slider" class="slider-bar mt-2">
                    </div>
                <div class="flex justify-between text-sm font-bold text-white mt-2">
                    <span id="unminted-count"><i class="fas fa-spinner fa-spin text-white"></i></span>
                    <span id="minted-percent" class="text-center text-cyan-400"><i class="fas fa-spinner fa-spin text-cyan-400"></i></span>
                    <span id="minted-count"><i class="fas fa-spinner fa-spin text-white"></i></span>
                </div>
            </div>
            <div class="stat-card p-4 rounded-xl">
                <div class="flex justify-between items-center text-sm font-medium text-gray-300">
                    <span>Un-Broken</span>
                    <h3 class="text-base font-semibold text-gray-400">Broken Status</h3>
                    <span>Broken</span>
                </div>
                <div id="broken-slider" class="slider-bar mt-2">
                    </div>
                <div class="flex justify-between text-sm font-bold text-white mt-2">
                    <span id="unbroken-count"><i class="fas fa-spinner fa-spin text-white"></i></span>
                    <div class="text-center">
                        <p id="broken-percent" class="text-cyan-400 text-xs"><i class="fas fa-spinner fa-spin text-cyan-400"></i></p>
                    </div>
                    <span id="broken-count"><i class="fas fa-spinner fa-spin text-white"></i></span>
                </div>
            </div>
        </div>

        <a href="graphs.html" class="stat-card rounded-xl group flex items-center justify-center text-center p-6 mb-8">
             <i class="fas fa-chart-line icon mr-4"></i>
             <div>
                 <h3 class="text-xl font-bold group-hover:text-teal-400">View Historical Data & Charts</h3>
                 <p class="text-gray-400">Explore detailed charts on backing, sales, and forward-looking projections.</p>
             </div>
        </a>

        <div class="grid grid-cols-2 md:grid-cols-4 gap-6 mb-8">
            <div id="daodao-staked-card" class="stat-card p-6 rounded-xl text-center cursor-pointer group">
                <div>
                    <h3 id="daodao-staked-title" class="text-md font-medium text-gray-400 flex justify-center items-center gap-2 group-hover:text-teal-400">DAODAO Staked</h3>
                    <p id="daodao-staked" class="text-3xl font-bold text-white mt-2"><i class="fas fa-spinner fa-spin text-cyan-400 text-2xl"></i></p>
                    <p id="daodao-staked-percentage" class="text-base font-semibold text-cyan-400 mt-1">&nbsp;</p>
                </div>
                <p class="subtext text-xs font-semibold mt-1 text-gray-500">Click to see details</p>
            </div>
            <div id="enterprise-staked-card" class="stat-card p-6 rounded-xl text-center cursor-pointer group">
                <div>
                    <h3 id="enterprise-staked-title" class="text-md font-medium text-gray-400 flex justify-center items-center gap-2 group-hover:text-teal-400">Enterprise Staked</h3>
                    <p id="enterprise-staked-holder" class="text-3xl font-bold text-white mt-2"><i class="fas fa-spinner fa-spin text-cyan-400 text-2xl"></i></p>
                </div>
                <p class="subtext text-xs font-semibold mt-1 text-gray-500">Click to see details</p>
            </div>
            <a href="https://daodao.zone/dao/terra1sffd4efk2jpdt894r04qwmtjqrrjfc52tmj6vkzjxqhd8qqu2drs3m5vzm/members" target="_blank" rel="noopener noreferrer" class="stat-card p-6 rounded-xl text-center group">
                <div>
                    <h3 id="dao-members-title" class="text-md font-medium text-gray-400 flex justify-center items-center gap-2">DAO Members</h3>
                    <p id="dao-members" class="text-3xl font-bold text-white mt-2"><i class="fas fa-spinner fa-spin text-cyan-400 text-2xl"></i></p>
                </div>
                 <p class="subtext text-xs font-semibold mt-1 text-gray-500">Click link to site</p>
            </a>
            <div id="dao-broken-card" class="stat-card p-6 rounded-xl text-center cursor-pointer group">
                 <div>
                    <h3 class="text-md font-medium text-gray-400 group-hover:text-teal-400">DAO Broken/Held NFTs</h3>
                    <p id="dao-broken-total" class="text-3xl font-bold text-white mt-2">1,000</p>
                </div>
                 <p class="subtext text-xs font-semibold mt-1 text-gray-500">Click to see details</p>
            </div>
            <div id="dao-treasury-card" class="stat-card p-6 rounded-xl text-center cursor-pointer group">
                <div>
                    <h3 id="dao-treasury-title" class="text-md font-medium text-gray-400 group-hover:text-teal-400 flex justify-center items-center gap-2">DAO Treasury</h3>
                    <p id="dao-treasury-total" class="text-3xl font-bold text-white mt-2"><i class="fas fa-spinner fa-spin text-cyan-400 text-2xl"></i></p>
                </div>
                <p class="subtext text-xs font-semibold mt-1 text-gray-500">Click to see details</p>
            </div>
             <div id="dao-tla-card" class="stat-card p-6 rounded-xl text-center cursor-pointer group">
                <div>
                    <h3 id="dao-tla-title" class="text-md font-medium text-gray-400 group-hover:text-teal-400 flex justify-center items-center gap-2">DAO TLA Deposits</h3>
                    <p id="dao-tla-total" class="text-3xl font-bold text-white mt-2"><i class="fas fa-spinner fa-spin text-cyan-400 text-2xl"></i></p>
                    <p id="dao-tla-apr" class="text-base font-semibold text-gray-300"><i class="fas fa-spinner fa-spin text-gray-300"></i></p>
                </div>
                 <p class="subtext text-xs font-semibold mt-1 text-gray-500">Click to see details</p>
            </div>
             <div id="dao-tla-vp-card" class="stat-card p-6 rounded-xl text-center cursor-pointer group">
                 <div>
                    <h3 id="dao-tla-vp-title" class="text-md font-medium text-gray-400 group-hover:text-teal-400 flex justify-center items-center gap-2">DAO TLA VP</h3>
                    <p id="dao-tla-vp" class="text-xl font-bold text-white mt-2">Details</p>
                    <p id="dao-tla-vp-usd" class="text-base font-semibold text-gray-300"><i class="fas fa-spinner fa-spin text-gray-300"></i></p>
                </div>
                 <p class="subtext text-xs font-semibold mt-1 text-gray-500">Click to see details</p>
            </div>
            <div id="unminted-backing-card" class="stat-card p-6 rounded-xl text-center cursor-pointer group">
                 <div>
                    <h3 id="unminted-nft-backing-title" class="text-md font-medium text-gray-400 group-hover:text-teal-400 flex justify-center items-center gap-2">Unminted NFT Backing</h3>
                    <p id="unminted-nft-backing-luna" class="text-xl font-bold text-white mt-2"><i class="fas fa-spinner fa-spin text-cyan-400 text-xl"></i></p>
                    <p id="unminted-nft-backing-usd" class="text-base font-semibold text-gray-300"><i class="fas fa-spinner fa-spin text-gray-300"></i></p>
                </div>
                 <p class="subtext text-xs font-semibold mt-1 text-gray-500">Click to see details</p>
            </div>

            <div class="stat-card p-6 rounded-xl text-center">
                <div>
                    <h3 id="backing-ampluna-title" class="text-md font-medium text-gray-400 flex justify-center items-center gap-2">Backing in ampLUNA</h3>
                    <div class="flex justify-center items-center gap-2 mt-2">
                        <p id="backing-per-nft-ampluna" class="text-3xl font-bold text-white"><i class="fas fa-spinner fa-spin text-cyan-400 text-2xl"></i></p>
                         <img src="https://raw.githubusercontent.com/defipatriot/aDAO-Image-Files/main/ampLuna.webp?raw=true" alt="ampLUNA" class="h-8 w-8" onerror="this.src='https://placehold.co/32x32/1f2937/EAEAEA?text=AL'; this.onerror=null;">
                    </div>
                </div>
                 <p id="backing-per-nft-change" class="subtext text-xs font-semibold mt-1 text-gray-500"><i class="fas fa-spinner fa-spin text-gray-500"></i></p>
            </div>
            <div class="stat-card p-6 rounded-xl text-center">
                <div>
                    <h3 id="backing-luna-live-title" class="text-md font-medium text-gray-400 flex justify-center items-center gap-2">Backing in LUNA</h3>
                    <div class="flex justify-center items-center gap-2 mt-2">
                        <p id="backing-per-nft-luna-live" class="text-3xl font-bold text-white"><i class="fas fa-spinner fa-spin text-cyan-400 text-2xl"></i></p>
                         <img src="https://raw.githubusercontent.com/defipatriot/aDAO-Image-Files/main/Luna.webp?raw=true" alt="LUNA" class="h-8 w-8" onerror="this.src='https://placehold.co/32x32/1f2937/EAEAEA?text=L'; this.onerror=null;">
                    </div>
                </div>
                <p id="live-ampluna-price-luna" class="subtext text-xs font-semibold mt-1 text-gray-500">&nbsp;</p> </div>
            <div class="stat-card p-6 rounded-xl text-center">
                <div>
                    <h3 id="backing-usd-title" class="text-md font-medium text-gray-400 flex justify-center items-center gap-2">Backing in USD</h3>
                    <p id="backing-per-nft-usd" class="text-3xl font-bold text-white mt-2"><i class="fas fa-spinner fa-spin text-cyan-400 text-2xl"></i></p>
                </div>
                <p id="live-luna-price" class="subtext text-xs font-semibold mt-1 text-gray-500"><i class="fas fa-spinner fa-spin text-gray-500"></i></p>
            </div>
            <div class="stat-card p-6 rounded-xl text-center">
                 <div>
                    <h3 id="avg-daily-gain-title" class="text-md font-medium text-gray-400 flex justify-center items-center gap-2">Avg Daily Gain Per NFT</h3>
                    <p id="avg-daily-gain" class="text-3xl font-bold text-white mt-2"><i class="fas fa-spinner fa-spin text-cyan-400 text-2xl"></i></p>
                </div>
                <p id="avg-daily-gain-subtext" class="subtext text-xs font-semibold mt-1 text-gray-500"><i class="fas fa-spinner fa-spin text-gray-500"></i></p>
            </div>
        </div>

       </main>

    
    <div id="daodaoModal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div class="modal-content bg-[#1a1a1a] border border-gray-700 rounded-xl shadow-xl w-full max-w-3xl relative text-white opacity-0 scale-95 p-8 flex flex-col"> <button class="modal-close absolute top-4 right-4 text-gray-400 hover:text-white text-3xl">&times;</button>
            <h3 class="text-2xl font-bold text-cyan-400 mb-4 flex-shrink-0">DAODAO Staking & Supply Details</h3> <div id="supply-breakdown" class="grid grid-cols-2 gap-x-8 gap-y-4 mb-6 p-4 bg-gray-800/50 rounded-lg border border-gray-700 text-sm flex-shrink-0"> <div class="flex justify-between border-b border-gray-600 pb-2">
                    <span class="text-gray-400">Total Minted:</span>
                    <span id="supply-minted" class="font-bold text-white"><i class="fas fa-spinner fa-spin"></i></span>
                </div>
                <div class="flex justify-between border-b border-gray-600 pb-2">
                    <span class="text-gray-400">DAO Controlled (Broken):</span>
                    <span id="supply-dao-controlled" class="font-bold text-white">1,000</span>
                </div>
                 <div class="col-span-2 border-t border-gray-700 my-2"></div>
                <div class="flex justify-between">
                    <span class="text-gray-400">Circulating Supply:</span>
                    <span id="supply-circulating" class="font-bold text-cyan-400"><i class="fas fa-spinner fa-spin"></i></span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-400">Liquid Supply:</span>
                    <span id="supply-liquid" class="font-bold text-green-400"><i class="fas fa-spinner fa-spin"></i></span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-400">DAODAO Staked:</span>
                    <span id="supply-daodao-staked" class="font-bold text-white"><i class="fas fa-spinner fa-spin"></i></span>
                </div>
                 <div class="flex justify-between">
                    <span class="text-gray-400">Enterprise Staked:</span>
                    <span id="supply-enterprise-staked" class="font-bold text-white"><i class="fas fa-spinner fa-spin"></i></span>
                </div>
            </div>

             <div class="border-t border-gray-700 pt-4 mt-4 flex flex-col min-h-0">
                <h4 class="font-bold text-lg text-white mb-2 flex-shrink-0">Top DAODAO Stakers (<span id="daodao-modal-holder-count"><i class="fas fa-spinner fa-spin"></i></span> NFTs)</h4>

                <div class="bg-gray-900 rounded-t-lg px-4 pt-2 pb-1">
                    <table class="w-full text-left text-sm">
                        <thead>
                            <tr>
                                <th class="p-2 w-3/4">Wallet Address</th>
                                <th class="p-2 w-1/4 text-right">NFTs Staked</th>
                            </tr>
                        </thead>
                    </table>
                </div>

                <div class="overflow-y-auto max-h-64 bg-gray-800/50 rounded-b-lg">
                    <div id="daodao-stakers-table" class="px-4 pb-2"> <div class="text-center p-4"><i class="fas fa-spinner fa-spin text-cyan-400 text-2xl"></i></div> </div>
                </div>
            </div>
        </div>
    </div>

    <div id="enterpriseModal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div class="modal-content bg-[#1a1a1a] border border-gray-700 rounded-xl shadow-xl w-full max-w-3xl relative text-white opacity-0 scale-95 p-8 flex flex-col"> <button class="modal-close absolute top-4 right-4 text-gray-400 hover:text-white text-3xl">&times;</button>
            <h3 class="text-2xl font-bold text-cyan-400 mb-4 flex-shrink-0">Enterprise Staking Details</h3> <div class="space-y-4 text-gray-300 flex flex-col min-h-0"> <div class="bg-blue-900/30 border border-blue-700 p-3 rounded-lg flex-shrink-0"> <p class="font-bold text-lg text-white">Action Required: Migrate Your NFTs</p>
                    <p>The Alliance DAO has officially migrated its governance from Enterprise to DAODAO. Any members who have not yet migrated their NFTs must do so to participate in governance proposals, promotions, and future DAO-distributed rewards.</p>
                </div>
                <a href="tutorials.html" class="inline-block bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg transition-colors mt-2 flex-shrink-0">View Migration Tutorial &rarr;</a> <div class="border-t border-gray-700 pt-4 mt-4 flex flex-col min-h-0">
                    <h4 class="font-bold text-lg text-white mb-2 flex-shrink-0">Holder Staking on Enterprise (<span id="enterprise-modal-holder-count"><i class="fas fa-spinner fa-spin"></i></span> NFTs)</h4>

                    <div class="bg-gray-900 rounded-t-lg px-4 pt-2 pb-1">
                        <table class="w-full text-left text-sm">
                            <thead>
                                <tr>
                                    <th class="p-2 w-3/4">Wallet Address</th>
                                    <th class="p-2 w-1/4 text-right">NFTs Staked</th>
                                </tr>
                            </thead>
                        </table>
                    </div>

                    <div class="overflow-y-auto max-h-64 bg-gray-800/50 rounded-b-lg">
                        <div id="enterprise-stakers-table" class="px-4 pb-2"> <div class="text-center p-4"><i class="fas fa-spinner fa-spin text-cyan-400 text-2xl"></i></div> </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="daoBrokenModal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden opacity-0">
         <div class="modal-content bg-[#1a1a1a] border border-gray-700 rounded-xl shadow-xl w-full max-w-2xl relative text-white opacity-0 scale-95 p-8">
            <button class="modal-close absolute top-4 right-4 text-gray-400 hover:text-white text-3xl">&times;</button>
            <h3 class="text-2xl font-bold text-cyan-400 mb-4">DAO Broken/Held NFTs</h3>
            <div class="space-y-4 text-gray-300">
                <p>The DAO currently holds 1,000 broken NFTs which are used for various purposes including liquidity and strategic reserves. These are held across three separate DAO wallets:</p>
                <ul class="list-disc list-inside space-y-2 bg-gray-800/50 p-4 rounded-lg">
                    <li><strong class="text-yellow-400">900 NFTs (Liquid):</strong> Held in two wallets, available for liquidity purposes.
                        <ul class="list-circle list-inside ml-6 text-sm">
                            <li>Wallet ending in: ...8ywv</li>
                            <li>Wallet ending in: ...417v</li>
                        </ul>
                    </li>
                    <li><strong class="text-green-400">100 NFTs (Staked):</strong> Held in the Enterprise staking wallet.
                         <ul class="list-circle list-inside ml-6 text-sm">
                             <li>Wallet ending in: ...6ugw</li>
                         </ul>
                    </li>
                </ul>
            </div>
        </div>
    </div>
    
    <div id="unmintedModal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden opacity-0">
         <div class="modal-content bg-[#1a1a1a] border border-gray-700 rounded-xl shadow-xl w-full max-w-2xl relative text-white opacity-0 scale-95 p-8">
            <button class="modal-close absolute top-4 right-4 text-gray-400 hover:text-white text-3xl">&times;</button>
            <h3 class="text-2xl font-bold text-cyan-400 mb-4">Unminted NFT Backing Calculation</h3>
            <div class="space-y-4 text-gray-300">
                <p>This value represents the total backing of all DAO-held NFTs that have not yet been minted. It is calculated by multiplying the total number of unminted NFTs by the live backing value per NFT.</p>
                <div class="bg-yellow-900/30 border border-yellow-700 p-3 rounded-lg text-sm">
                    <p><strong class="text-yellow-300">Important Note:</strong> The backing is a "worst-case" or baseline value. This calculation does not factor in additional value derived from the art, DAO Voting Power (VP), or the ability to stake the NFT to participate in governance and earn DAO-distributed rewards. For context, even a broken NFT has a current floor price of ~249 bLUNA, highlighting the significant value beyond its liquid backing.</p>

                </div>
                <div class="bg-gray-800/50 p-4 rounded-lg mt-4 text-center">
                     <p class="text-lg font-mono">
                        <span id="unminted-modal-count"><i class="fas fa-spinner fa-spin"></i></span> Unminted NFTs * <span id="unminted-modal-backing-luna"><i class="fas fa-spinner fa-spin"></i></span> LUNA
                        <br> = <strong class="text-cyan-400 text-xl" id="unminted-modal-total-luna"><i class="fas fa-spinner fa-spin"></i> LUNA</strong>
                    </p>
                    <hr class="border-gray-600 my-2">
                     <p class="text-lg font-mono">
                        <span id="unminted-modal-count-2"><i class="fas fa-spinner fa-spin"></i></span> Unminted NFTs * $<span id="unminted-modal-backing-usd"><i class="fas fa-spinner fa-spin"></i></span> USD
                        <br> = <strong class="text-cyan-400 text-xl" id="unminted-modal-total-usd"><i class="fas fa-spinner fa-spin"></i> USD</strong>
                    </p>
                </div>
            </div>
        </div>
    </div>
    
    <div id="treasuryModal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div class="modal-content bg-[#1a1a1a] border border-gray-700 rounded-xl shadow-xl w-full max-w-2xl relative text-white opacity-0 scale-95 p-8">
            <button class="modal-close absolute top-4 right-4 text-gray-400 hover:text-white text-3xl">&times;</button>
            <h3 class="text-2xl font-bold text-cyan-400 mb-4">DAO Treasury Details</h3>
            <div id="treasury-table-container" class="max-h-96 overflow-y-auto">
                 <div class="text-center p-4"><i class="fas fa-spinner fa-spin text-cyan-400 text-2xl"></i></div> </div>
            <a href="https://daodao.zone/dao/terra1sffd4efk2jpdt894r04qwmtjqrrjfc52tmj6vkzjxqhd8qqu2drs3m5vzm/treasury?url=https%3A%2F%2Fwww.erisprotocol.com" target="_blank" rel="noopener noreferrer" class="inline-block mt-6 bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg transition-colors w-full text-center">
                View Treasury on DAODAO &rarr;
            </a>
        </div>
    </div>
    
    <div id="tlaModal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div class="modal-content bg-[#1a1a1a] border border-gray-700 rounded-xl shadow-xl w-full max-w-3xl relative text-white opacity-0 scale-95 p-8 overflow-y-auto">
            <button class="modal-close absolute top-4 right-4 text-gray-400 hover:text-white text-3xl">&times;</button>
            <h3 class="text-2xl font-bold text-cyan-400 mb-4">DAO TLA Deposit Details</h3>
            <div class="text-center bg-gray-800/50 p-4 rounded-lg mb-4">
                 <p class="text-lg">Total Deposit Value (Snapshot)</p>
                 <p class="text-2xl font-bold text-white" id="tla-deposit-total-usd"><i class="fas fa-spinner fa-spin text-white text-2xl"></i></p>
                 <p class="text-md text-cyan-400" id="tla-deposit-total-apr"><i class="fas fa-spinner fa-spin text-cyan-400"></i></p>
                 <div class="mt-2 pt-2 border-t border-gray-600">
                    <p class="text-lg">Unclaimed Rewards</p>
                    <p class="text-xl font-bold text-white" id="tla-unclaimed-rewards"><i class="fas fa-spinner fa-spin text-white text-xl"></i></p>
                 </div>
            </div>
            <div class="bg-yellow-900/30 border border-yellow-700 p-3 rounded-lg text-sm mb-4">
                <p><strong class="text-yellow-300">Disclaimer:</strong> This data is a snapshot from <span id="tla-snapshot-date"></span>. The "Live Estimated Value" for underlying tokens is calculated using live CoinGecko prices and may not perfectly reflect the LP's current balance due to impermanent loss.</p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h4 class="font-bold text-lg text-white mb-2 text-center">Pools</h4>
                    <div id="tla-pools-container" class="space-y-2"> <div class="text-center p-4"><i class="fas fa-spinner fa-spin text-cyan-400 text-2xl"></i></div> </div>
                </div>
                <div>
                    <h4 class="font-bold text-lg text-white mb-2 text-center">Underlying Tokens</h4>
                    <div id="tla-tokens-container"> <div class="text-center p-4"><i class="fas fa-spinner fa-spin text-cyan-400 text-2xl"></i></div> </div>
                </div>
            </div>
             <a href="https://daodao.zone/dao/terra1sffd4efk2jpdt894r04qwmtjqrrjfc52tmj6vkzjxqhd8qqu2drs3m5vzm/apps?url=https%3A%2F%2Fwww.erisprotocol.com" target="_blank" rel="noopener noreferrer" class="inline-block mt-6 bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg transition-colors w-full text-center">
                View Deposits on Eris Protocol &rarr;
            </a>
        </div>
    </div>

    <div id="tlaVpModal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div class="modal-content bg-[#1a1a1a] border border-gray-700 rounded-xl shadow-xl w-full max-w-4xl relative text-white opacity-0 scale-95 p-8">
            <button class="modal-close absolute top-4 right-4 text-gray-400 hover:text-white text-3xl">&times;</button>
            <h3 class="text-2xl font-bold text-cyan-400 mb-4">DAO TLA VP Details</h3>
            <div class="space-y-4 text-gray-300">
                <div class="text-center bg-gray-800/50 p-4 rounded-lg">
                    <p class="text-lg">Total Voting Power</p>
                    <p class="text-2xl font-bold text-white">638,880 VP</p>
                    <p class="text-sm text-gray-400 mt-2">Live Underlying Value:</p>
                    <p class="text-lg font-bold text-white" id="tla-vp-modal-luna"><i class="fas fa-spinner fa-spin text-white text-lg"></i></p>
                    <p class="text-md text-cyan-400" id="tla-vp-modal-usd"><i class="fas fa-spinner fa-spin text-cyan-400"></i></p>
                    <p class="text-xs text-gray-500 mt-2">Last Adjusted: September 7th, 2025 (VP is static)</p>
                </div>
                <div id="tla-vp-locks-container">
                      <div class="text-center p-4"><i class="fas fa-spinner fa-spin text-cyan-400 text-2xl"></i></div> </div>
                <a href="https://daodao.zone/dao/terra1sffd4efk2jpdt894r04qwmtjqrrjfc52tmj6vkzjxqhd8qqu2drs3m5vzm/apps?url=https%3A%2F%2Fwww.erisprotocol.com" target="_blank" rel="noopener noreferrer" class="inline-block mt-4 bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg transition-colors w-full text-center">
                    View Locks on Eris Protocol &rarr;
                </a>
            </div>
        </div>
    </div>

    <div id="logoModal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div class="modal-content bg-[#1a1a1a] border border-gray-700 rounded-xl shadow-xl w-full max-w-4xl relative text-white opacity-0 scale-95 p-8 text-center">
            <button class="modal-close absolute top-4 right-4 text-gray-400 hover:text-white text-3xl">&times;</button>
            <h2 class="text-3xl font-bold text-white mb-6">Project & Alliance Logos</h2>
            <div id="logo-library-container" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 text-center max-h-96 overflow-y-auto p-4">
                 <div class="text-center p-4 col-span-full"><i class="fas fa-spinner fa-spin text-cyan-400 text-2xl"></i></div> </div>
            <a href="https://github.com/defipatriot/aDAO-Image-Files" target="_blank" rel="noopener noreferrer" class="inline-block mt-6 bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition-all transform hover:scale-105">
                View Full Library on GitHub
            </a>
        </div>
    </div>


    <footer class="border-t border-gray-800 mt-12 py-8">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center text-gray-500 text-sm">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
                <div><h4 class="font-bold text-gray-300 mb-2">Disclaimer</h4><p>This website is for informational purposes only and does not constitute financial advice. All data is provided "as is" without warranty. Please do your own research.</p></div>
                <div><h4 class="font-bold text-gray-300 mb-2">Project Origin</h4><p>This site is built and maintained by a council member, not at the direction of the council, but as a passionate community member looking to improve the optics of the collection.</p></div>
                <div><h4 class="font-bold text-gray-300 mb-2">Data Source</h4><p>Data on this site is a mix of live on-chain data and static snapshots. See the banner at the top for details.</p>
                </div>
                <div><h4 class="font-bold text-gray-300 mb-2">Transparency</h4><p>The plan is for the script used to retrieve on-chain data to be open-source. You will be able to view the public repository to see how information is retrieved.</p><a href="https://github.com/defipatriot" target="_blank" rel="noopener noreferrer" class="text-cyan-400 hover:underline mt-2 inline-block">View on GitHub</a></div>
            </div>
        </div>
    </footer>
    
    <footer class="py-6">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center text-gray-400">
            <div class="flex justify-center items-center space-x-6 mb-4">
                <a href="https://t.me/The_AllianceDAO" target="_blank" rel="noopener noreferrer" class="hover:text-white transition-colors"><i class="fab fa-telegram-plane text-3xl"></i></a>
                <a href="https://x.com/The_AllianceDAO" target="_blank" rel="noopener noreferrer" class="hover:text-white transition-colors"><i class="fab fa-twitter text-3xl"></i></a>
            </div>
            <div class="flex flex-wrap justify-center items-center space-x-6 text-sm">
                <a href="tutorials.html" class="hover:text-white hover:underline transition-colors">Tutorials</a>
                <a href="links.html" class="hover:text-white hover:underline transition-colors">Official Links</a>
                <a href="#" id="logo-modal-trigger" class="hover:text-white hover:underline transition-colors cursor-pointer">Logos</a>
                <a href="https://chainsco.pe/terra2/address/terra1phr9fngjv7a8an4dhmhd0u0f98wazxfnzccqtyheq4zqrrp4fpuqw3apw9" target="_blank" rel="noopener noreferrer" class="hover:text-white hover:underline transition-colors">NFT Contract</a>
                <a href="https://github.com/SCV-Security/PublicReports/blob/b819ec669f81e603caca261931e2a4aaca1cddf7/Alliance/Alliance%20DAO%20-%20NFT%20Collection%20Contract%20-%20Audit%20Report%20v1.0.pdf" target="_blank" rel="noopener noreferrer" class="hover:text-white hover:underline transition-colors">Contract Audit</a>
                <a id="snapshot-link" class="hover:text-white hover:underline transition-colors disabled">Download Snapshot</a>
                <a href="tla_tool.html" class="hover:text-white hover:underline transition-colors">TLA Tool</a>
            </div>
        </div>
    </footer>


    <script>
        // --- Global variable to store snapshot data ---
        let currentSnapshotData = null; 
        let isFetching = false; // Flag to prevent multiple downloads while fetching

        document.addEventListener('DOMContentLoaded', () => {

            // --- UI ELEMENTS ---
            const snapshotLink = document.getElementById('snapshot-link'); // Changed from snapshotBtn
            // Status message element removed

             // Initially disable link
             if (snapshotLink) {
                 snapshotLink.classList.add('disabled');
                 snapshotLink.setAttribute('aria-disabled', 'true');
             }


            // --- CENTRAL DATA OBJECT ---
            const dashboardData = {
              "lastUpdated": "2025-09-11T16:02:00Z",
              "statusSliders": {
                "mint": { "unMinted": 5828, "minted": 4172, "percentMinted": "41.72%" },
                "broken": { "unBroken": 8924, "broken": 1076, "percentBroken": "10.76%" }
              },
              "keyMetrics": {
                "daodaoStaked": 1476, 
                "daoMembers": 160,
                "enterpriseStakedHolder": 415,
                "backingInLuna": 109.97,
                "avgDailyGain": 0.21,
              },
              "tlaDeposits": {
                "snapshotDate": "2025-10-07T00:00:00Z",
                "totalDeposit": 10218.54,
                "estApr": 40.74,
                "unclaimedRewards": 289.72,
                "pools": [ /* ... pools data ... */ ],
                "tokenBalances": [ /* ... token balances ... */ ]
              }
            };
             // Simplified TLA data for brevity in example
            dashboardData.tlaDeposits.pools = [ { name: "Example Pool", platform: "Example", whiteValue: 1000, whiteApr: 10, orangeValue: 500, orangeApr: 15, rewards: 10 } ];
            dashboardData.tlaDeposits.tokenBalances = [ { name: "LUNA", amount: 1000, geckoId: "terra-luna-2"} ];
            
            const tokenLogos = { /* ... token logos ... */ 
                "LUNA": "https://raw.githubusercontent.com/defipatriot/aDAO-Image-Files/main/Luna.webp?raw=true",
                "ampLUNA": "https://raw.githubusercontent.com/defipatriot/aDAO-Image-Files/main/ampLuna.webp?raw=true",
                "ASTRO": "https://raw.githubusercontent.com/defipatriot/token_logo/main/Astro.webp?raw=true",
                "wBTC": "https://raw.githubusercontent.com/defipatriot/token_logo/main/wBTC.png?raw=true",
                "ATOM": "https://raw.githubusercontent.com/defipatriot/aDAO-Image-Files/main/atom.png?raw=true",
                "CAPA": "https://raw.githubusercontent.com/defipatriot/token_logo/main/capa.svg?raw=true",
                "xASTRO": "https://raw.githubusercontent.com/defipatriot/aDAO-Image-Files/main/astro.png?raw=true",
                "ROAR": "https://raw.githubusercontent.com/defipatriot/token_logo/main/ROAR_LOGO.png?raw=true",
                "SOLID": "https://raw.githubusercontent.com/defipatriot/token_logo/main/solid.svg?raw=true",
                "bLUNA": "https://raw.githubusercontent.com/defipatriot/token_logo/main/bLUNA.webp?raw=true",
                "USDC": "https://assets.coingecko.com/coins/images/6319/small/usdc.png",
                "arbLUNA": "https://raw.githubusercontent.com/defipatriot/token_logo/main/arbLuna.svg?raw=true",
                "ampCAPA": null, "ampROAR": null
            };
            const denomMap = { /* ... denom map ... */ 
                'uluna': { name: 'LUNA', geckoId: 'terra-luna-2', decimals: 6 },
                'ibc/8D8A7F7253615E5F76CB6252A1E1BD921D5EDB7BBAAF8913FB1C77FF125D9995': { name: 'ASTRO', geckoId: 'astroport-fi', decimals: 6 },
                'ibc/2C962DAB9F57FE0921435426AE75196009FAA1981BF86991203C8411F8980FDB': { name: 'USDC', geckoId: 'usd-coin', decimals: 6 },
                'ibc/88386AC48152D48B34B082648DF836F975506F0B57DBBFC10A54213B1BF484CB': { name: 'wBTC', geckoId: 'wrapped-bitcoin', decimals: 8 },
                'terra1ecgazyd0waaj3g7l9cmy5gulhxkps2gmxu9ghducvuypjq68mq2s5lvsct': { name: 'ampLUNA', geckoId: 'eris-amplified-luna', decimals: 6 },
                'terra17jnhankdf4jtr2g53v635q5k70g7g64x2s9w2s': { name: 'arbLUNA', geckoId: 'staked-luna-slinky', decimals: 6 },
                'terra1t4p3u8khpd7f8qzurwyafxt648dya6mp6vur3vaapswt6m24gkuqrfdhar': { name: 'CAPA', geckoId: 'capapult', decimals: 6 },
                'terra10aa3zdkrc7jwuf8ekl3zq7e7m42vmzqehcmu74e4egc7xkm5kr2s0muyst': { name: 'SOLID', geckoId: 'solid-2', decimals: 6 },
                'terra1lxx40s29qvkrcj8fsa3yzyehy7w50umdvvnls2r830rys6lu2zns63eelv': { name: 'ROAR', geckoId: 'lion-dao', decimals: 6 },
                'terra17aj4ty4sz4yhgm08na8drc0v03v2jwr3waxcqrwhajj729zhl7zqnpc0ml': { name: 'bLUNA', geckoId: 'backbone-labs-staked-luna', decimals: 6 }
            };


            // --- UI UPDATE FUNCTION ---
            function updateUI() {
                const lastUpdatedEl = document.getElementById('last-updated');
                if (lastUpdatedEl) lastUpdatedEl.textContent = new Date(dashboardData.lastUpdated).toUTCString();
                
                 // Mint Slider (Update with static data initially)
                const mintSliderEl = document.getElementById('mint-slider');
                const unmintedCountEl = document.getElementById('unminted-count');
                const mintedCountEl = document.getElementById('minted-count');
                const mintedPercentEl = document.getElementById('minted-percent');

                if (mintSliderEl && unmintedCountEl && mintedCountEl && mintedPercentEl) {
                    const percentMintedNum = parseFloat(dashboardData.statusSliders.mint.percentMinted);
                    mintSliderEl.innerHTML = `<div class="slider-fill-blue" style="width: ${100 - percentMintedNum}%;"></div><div class="slider-fill-gray" style="width: ${percentMintedNum}%;"></div>`;
                    if (unmintedCountEl.innerHTML.includes('fa-spinner')) unmintedCountEl.textContent = dashboardData.statusSliders.mint.unMinted.toLocaleString();
                    if (mintedCountEl.innerHTML.includes('fa-spinner')) mintedCountEl.textContent = dashboardData.statusSliders.mint.minted.toLocaleString();
                    if (mintedPercentEl.innerHTML.includes('fa-spinner')) mintedPercentEl.textContent = `${dashboardData.statusSliders.mint.percentMinted} Minted`;
                }
                
                 // --- FIX: Removed redundant static update for Avg Daily Gain ---
                 // The fetchLiveOnChainData's 'finally' block now handles this.
                 // --- END FIX ---

                fetchLiveOnChainData();
            }

            async function fetchLiveOnChainData() {
                 if (isFetching) return; 
                 isFetching = true;
                 console.log("DEBUG: Starting fetchLiveOnChainData..."); 
                 // Disable snapshot link during fetch
                 if (snapshotLink) {
                     snapshotLink.classList.add('disabled');
                     snapshotLink.setAttribute('aria-disabled', 'true');
                     // Optionally change text while loading
                     // snapshotLink.textContent = "Loading Data..."; 
                 }


                // ... (API URLs setup remains the same) ...
                 const onChainStatsUrl = 'https://deving.zone/en/nfts/alliance_daos.json';
                 const contractRewardsQuery = btoa(JSON.stringify({ all_nft_info: { token_id: "9068" } }));
                 const contractUrl = `https://terra.publicnode.com/cosmwasm/wasm/v1/contract/terra1phr9fngjv7a8an4dhmhd0u0f98wazxfnzccqtyheq4zqrrp4fpuqw3apw9/smart/${contractRewardsQuery}`;
                 const ampLunaRateQuery = btoa(JSON.stringify({ exchange_rates: {} }));
                 const ampLunaRateUrl = `https://terra.publicnode.com/cosmwasm/wasm/v1/contract/terra10788fkzah89xrdm27zkj5yvhj9x3494lxawzm5qq3vvxcqz2yzaqyd3enk/smart/${ampLunaRateQuery}`;
                 const treasuryWalletAddress = 'terra1sffd4efk2jpdt894r04qwmtjqrrjfc52tmj6vkzjxqhd8qqu2drs3m5vzm';
                 const nativeBalancesUrl = `https://terra.publicnode.com/cosmos/bank/v1beta1/balances/${treasuryWalletAddress}`;
                 const neededGeckoIds = new Set(['terra-luna-2', 'eris-amplified-luna']);
                 Object.values(denomMap).forEach(token => { if (token.geckoId) neededGeckoIds.add(token.geckoId); });
                 dashboardData.tlaDeposits.tokenBalances.forEach(token => { if (token.geckoId) neededGeckoIds.add(token.geckoId); });
                 neededGeckoIds.add('staked-luna-slinky');
                 const allGeckoIdsString = Array.from(neededGeckoIds).join(',');
                 const priceUrl = `https://api.coingecko.com/api/v3/simple/price?ids=${allGeckoIdsString}&vs_currencies=usd`;

                // --- Variables to store calculated results ---
                let snapshotResult = { timestamp: new Date().toISOString(), status: "partial" }; // Default status

                try {
                    console.log("DEBUG: Starting primary API fetches..."); 
                    const [statsResponse, contractResponse, ampLunaRateResponse, priceResponse] = await Promise.all([ /* ... fetches ... */ 
                        fetch(onChainStatsUrl).catch(e => { console.error("Stats Fetch Error:", e); return null; }),
                        fetch(contractUrl).catch(e => { console.error("Contract Fetch Error:", e); return null; }),
                        fetch(ampLunaRateUrl).catch(e => { console.error("ampLUNA Rate Fetch Error:", e); return null; }),
                        fetch(priceUrl).catch(e => { console.error("Price Fetch Error:", e); return null; })
                    ]);
                    console.log("DEBUG: Primary API fetches completed."); 

                    if (!statsResponse?.ok || !contractResponse?.ok || !ampLunaRateResponse?.ok || !priceResponse?.ok) {
                         console.error("DEBUG: One or more primary API requests failed."); 
                         throw new Error("Primary API requests failed");
                    }
                    console.log("DEBUG: All primary API responses OK."); 

                    const statsData = await statsResponse.json(); console.log("DEBUG: Parsed statsData."); 
                    const contractJson = await contractResponse.json(); console.log("DEBUG: Parsed contractJson."); 
                    const ampLunaRateData = await ampLunaRateResponse.json(); console.log("DEBUG: Parsed ampLunaRateData."); 
                    const priceData = await priceResponse.json(); console.log("DEBUG: Parsed priceData."); 

                    console.log("DEBUG: Starting treasury balance fetches..."); 
                    const balancePromises = [];
                    balancePromises.push(fetch(nativeBalancesUrl).then(res => res.ok ? res.json() : null).catch(() => null)); 
                    const queryMsg = btoa(JSON.stringify({ balance: { address: treasuryWalletAddress } }));
                    for (const denom in denomMap) {
                        if (denom.startsWith('terra1')) {
                            const url = `https://terra.publicnode.com/cosmwasm/wasm/v1/contract/${denom}/smart/${queryMsg}`;
                            balancePromises.push(
                                fetch(url)
                                .then(res => res.ok ? res.json() : Promise.reject(new Error(`Fetch failed for ${denom}`)))
                                .then(data => ({ denom, data }))
                                .catch(() => { return null; }) 
                            );
                        }
                    }
                    const balanceResults = await Promise.all(balancePromises);
                    console.log("DEBUG: Treasury balance fetches completed."); 
                    
                    const liveTreasuryAssets = [];
                    // ... (processing balanceResults remains the same) ...
                    const nativeBalancesResult = balanceResults[0];
                    if (nativeBalancesResult && nativeBalancesResult.balances) {
                         nativeBalancesResult.balances.forEach(balance => {
                            const tokenInfo = denomMap[balance.denom];
                            if (tokenInfo) {
                                liveTreasuryAssets.push({ ...tokenInfo, amount: Number(balance.amount) / Math.pow(10, tokenInfo.decimals || 0) });
                            }
                        });
                    } else { console.warn("DEBUG: Failed to load native treasury balances."); } 

                    for (let i = 1; i < balanceResults.length; i++) {
                        const result = balanceResults[i];
                        if (result && result.data && result.data.data && typeof result.data.data.balance === 'string') {
                             const tokenInfo = denomMap[result.denom];
                             if (tokenInfo) {
                                 const amount = Number(result.data.data.balance) / Math.pow(10, tokenInfo.decimals || 0);
                                 if (amount > 0) { liveTreasuryAssets.push({ ...tokenInfo, amount }); }
                             }
                        }
                    }
                    console.log("DEBUG: Processed treasury balances."); 

                    const { collection_stats, nfts } = statsData;
                    const lunaPriceUSD = priceData?.['terra-luna-2']?.usd;
                    if (typeof lunaPriceUSD !== 'number') { throw new Error("Invalid price data for LUNA"); }
                    console.log("DEBUG: LUNA price OK:", lunaPriceUSD); 

                    const ampLunaToLunaRate = parseFloat(ampLunaRateData?.data?.exchange_rates?.[0]?.[1]);
                     if (isNaN(ampLunaToLunaRate)) { throw new Error("Invalid ampLUNA exchange rate"); }
                    console.log("DEBUG: ampLUNA rate OK:", ampLunaToLunaRate); 

                    // --- Calculations for Snapshot & UI ---
                    const daodaoStakers = nfts.filter(nft => nft.daodao === true);
                    const daodaoCount = daodaoStakers.length;
                    const brokenCount = nfts.filter(nft => nft.broken).length;
                    const daoMembers = collection_stats?.unique_stakers || 0;
                    const daoEnterpriseWallet = 'terra1nn7yrgjzj6zvle7ms9vlpg4cj3kaxjls4g6ugw';
                    const enterpriseStakers = nfts.filter(nft => nft.enterprise === true && nft.owner !== daoEnterpriseWallet);
                    const enterpriseStakedByHolder = enterpriseStakers.length;
                    const mintedCount = dashboardData.statusSliders.mint.minted; // From static data
                    const unmintedCount = dashboardData.statusSliders.mint.unMinted; // From static data
                    const circulatingSupply = Math.max(0, mintedCount - 1000); // Assuming 1000 DAO broken
                    const rewardsAttribute = contractJson?.data?.info?.extension?.attributes?.find(attr => attr.trait_type === 'rewards');
                    const rewardsValue = rewardsAttribute?.value;
                    const liveAmpLunaBacking = rewardsValue ? Number(rewardsValue) / 1000000 : 0; 
                    const backingInLunaLive = liveAmpLunaBacking * ampLunaToLunaRate;
                    const backingInUSD = backingInLunaLive * lunaPriceUSD;
                    const unmintedBackingLuna = unmintedCount * backingInLunaLive;
                    const unmintedBackingUSD = unmintedCount * backingInUSD;

                    // Calculate Treasury Total USD (simplified from buildTreasuryTable)
                     let totalTreasuryUSD = 0;
                     liveTreasuryAssets.forEach(asset => {
                         let livePrice = null;
                         if (priceData && priceData[asset.geckoId]) { livePrice = priceData[asset.geckoId].usd; }
                         const liveValue = (typeof livePrice === 'number') ? asset.amount * livePrice : null;
                         if (liveValue !== null) { totalTreasuryUSD += liveValue; }
                     });
                     
                    // Calculate TLA VP USD (simplified from buildTlaVp)
                     let totalTlaVpUSD = 0;
                     const staticArbLunaToLunaRate = 2.3583; // Keep the static rate
                     const ratesAreValid = typeof lunaPriceUSD === 'number' && typeof ampLunaToLunaRate === 'number'; // Check only relevant rates
                      if (ratesAreValid) {
                         const arbLunaAmount = 27290; const ampLunaAmount = 413.03;
                         const underlyingLuna = (arbLunaAmount * staticArbLunaToLunaRate) + (ampLunaAmount * ampLunaToLunaRate);
                         totalTlaVpUSD = underlyingLuna * lunaPriceUSD;
                      } else {
                          totalTlaVpUSD = null; // Mark as error/unavailable
                      }


                    // --- Populate Snapshot Object ---
                    snapshotResult = {
                        timestamp: new Date().toISOString(),
                        status: "success", // Mark as successful
                        daoMembers: daoMembers,
                        daodaoStaked: daodaoCount,
                        enterpriseStaked: enterpriseStakedByHolder,
                        brokenNfts: brokenCount,
                        circulatingSupply: circulatingSupply,
                        backingPerNft_ampLUNA: liveAmpLunaBacking,
                        ampLUNA_LUNA_Ratio: ampLunaToLunaRate,
                        backingPerNft_LUNA: backingInLunaLive,
                        lunaPrice_USD: lunaPriceUSD,
                        backingPerNft_USD: backingInUSD,
                        unmintedNfts: unmintedCount,
                        unmintedTotalBacking_LUNA: unmintedBackingLuna,
                        unmintedTotalBacking_USD: unmintedBackingUSD,
                        treasuryTotal_USD: totalTreasuryUSD,
                        tlaDepositsTotal_USD: dashboardData.tlaDeposits.totalDeposit, // Using snapshot TLA total
                        tlaVpTotal_USD: totalTlaVpUSD, 
                        avgDailyGainPerNft_LUNA: dashboardData.keyMetrics.avgDailyGain // Using snapshot daily gain
                    };
                    console.log("DEBUG: Snapshot data compiled:", snapshotResult); // DEBUG LOG

                    // --- Update UI ---
                    console.log("DEBUG: Calling build/update UI functions..."); 
                    buildTreasuryTable(priceData, liveTreasuryAssets);
                    buildTlaVp(priceData, ampLunaToLunaRate);
                    buildTlaDeposits(priceData);
                    // ... (rest of the UI updates: staker tables, tiles, modals) ...
                    const enterpriseStakerCounts = enterpriseStakers.reduce((acc, nft) => { if(nft.owner) acc[nft.owner] = (acc[nft.owner] || 0) + 1; return acc; }, {});
                    buildStakerTable('enterprise-stakers-table', enterpriseStakerCounts);
                    const daodaoStakerCounts = daodaoStakers.reduce((acc, nft) => { if(nft.owner) acc[nft.owner] = (acc[nft.owner] || 0) + 1; return acc; }, {});
                    buildStakerTable('daodao-stakers-table', daodaoStakerCounts);
                    console.log("DEBUG: Built staker tables."); 

                    const totalLocked = daodaoCount + enterpriseStakedByHolder;
                    const daodaoLockedPercentage = circulatingSupply > 0 ? (daodaoCount / circulatingSupply) * 100 : 0;
                    const liquidSupply = Math.max(0, circulatingSupply - totalLocked);

                    updateTile('daodao-staked', daodaoCount.toLocaleString(), true);
                    const daodaoStakedPercentageEl = document.getElementById('daodao-staked-percentage');
                    if (daodaoStakedPercentageEl) daodaoStakedPercentageEl.textContent = `${daodaoLockedPercentage.toFixed(2)}% of Circulating`;

                    updateTile('dao-members', daoMembers.toLocaleString(), true);
                    updateTile('enterprise-staked-holder', enterpriseStakedByHolder.toLocaleString(), true, { titleId: 'enterprise-staked-title' });
                    
                     const supplyMintedEl = document.getElementById('supply-minted');
                     const supplyCirculatingEl = document.getElementById('supply-circulating');
                     const supplyLiquidEl = document.getElementById('supply-liquid');
                     const supplyDaodaoStakedEl = document.getElementById('supply-daodao-staked');
                     const supplyEnterpriseStakedEl = document.getElementById('supply-enterprise-staked');
                     const daodaoModalHolderCountEl = document.getElementById('daodao-modal-holder-count');
                     if(supplyMintedEl) supplyMintedEl.textContent = mintedCount.toLocaleString();
                     if(supplyCirculatingEl) supplyCirculatingEl.textContent = circulatingSupply.toLocaleString();
                     if(supplyLiquidEl) supplyLiquidEl.textContent = liquidSupply.toLocaleString();
                     if(supplyDaodaoStakedEl) supplyDaodaoStakedEl.textContent = daodaoCount.toLocaleString();
                     if(supplyEnterpriseStakedEl) supplyEnterpriseStakedEl.textContent = enterpriseStakedByHolder.toLocaleString();
                     if(daodaoModalHolderCountEl) daodaoModalHolderCountEl.textContent = daodaoCount.toLocaleString();

                     const unbrokenCountEl = document.getElementById('unbroken-count');
                     const brokenCountEl = document.getElementById('broken-count');
                     const brokenPercentEl = document.getElementById('broken-percent');
                     const brokenSliderEl = document.getElementById('broken-slider');
                     const totalNftsForBrokenCalc = 10000;
                     if (unbrokenCountEl) unbrokenCountEl.textContent = (totalNftsForBrokenCalc - brokenCount).toLocaleString();
                     if (brokenCountEl) brokenCountEl.textContent = brokenCount.toLocaleString();
                     if (brokenPercentEl) brokenPercentEl.textContent = `${(brokenCount / totalNftsForBrokenCalc * 100).toFixed(2)}% Broken`;
                     if (brokenSliderEl) {
                         const percentBrokenNum = brokenCount / totalNftsForBrokenCalc * 100;
                         brokenSliderEl.innerHTML = `<div class="slider-fill-blue" style="width: ${100 - percentBrokenNum}%;"></div><div class="slider-fill-gray" style="width: ${percentBrokenNum}%;"></div>`;
                     }

                    updateTile('backing-per-nft-ampluna', liveAmpLunaBacking.toFixed(4), true, { titleId: 'backing-ampluna-title', subtextId: 'backing-per-nft-change', subtext: `Ratio: ${ampLunaToLunaRate.toFixed(4)}` }); 
                    updateTile('backing-per-nft-luna-live', backingInLunaLive.toFixed(4), true, { titleId: 'backing-luna-live-title'}); 
                    updateTile('backing-per-nft-usd', `$${backingInUSD.toFixed(2)}`, true, { titleId: 'backing-usd-title', subtextId: 'live-luna-price', subtext: `@ $${lunaPriceUSD.toFixed(4)} / LUNA` });
                    updateTile('unminted-nft-backing-luna', `${unmintedBackingLuna.toLocaleString('en-US', {maximumFractionDigits: 0})} LUNA`, true, { titleId: 'unminted-nft-backing-title' });
                     const unmintedNftBackingUsdEl = document.getElementById('unminted-nft-backing-usd');
                     if (unmintedNftBackingUsdEl) unmintedNftBackingUsdEl.textContent = `$${unmintedBackingUSD.toLocaleString('en-US', {maximumFractionDigits: 0})} USD`;
                    
                     const unmintedModalCount1 = document.getElementById('unminted-modal-count');
                     const unmintedModalCount2 = document.getElementById('unminted-modal-count-2');
                     const unmintedModalBackingLuna = document.getElementById('unminted-modal-backing-luna');
                     const unmintedModalBackingUsd = document.getElementById('unminted-modal-backing-usd');
                     const unmintedModalTotalLuna = document.getElementById('unminted-modal-total-luna');
                     const unmintedModalTotalUsd = document.getElementById('unminted-modal-total-usd');
                     if(unmintedModalCount1) unmintedModalCount1.textContent = unmintedCount.toLocaleString();
                     if(unmintedModalCount2) unmintedModalCount2.textContent = unmintedCount.toLocaleString();
                     if(unmintedModalBackingLuna) unmintedModalBackingLuna.textContent = backingInLunaLive.toFixed(4);
                     if(unmintedModalBackingUsd) unmintedModalBackingUsd.textContent = backingInUSD.toFixed(4);
                     if(unmintedModalTotalLuna) unmintedModalTotalLuna.textContent = `${unmintedBackingLuna.toLocaleString('en-US', {maximumFractionDigits: 0})} LUNA`;
                     if(unmintedModalTotalUsd) unmintedModalTotalUsd.textContent = `$${unmintedBackingUSD.toLocaleString('en-US', {maximumFractionDigits: 0})} USD`;

                    console.log("DEBUG: UI updates triggered."); 

                    // Store the result globally
                    currentSnapshotData = snapshotResult; 
                     // Enable snapshot link and update text
                     if (snapshotLink) {
                         snapshotLink.classList.remove('disabled');
                         snapshotLink.removeAttribute('aria-disabled');
                         snapshotLink.textContent = "Download Snapshot"; // Change text back
                     }


                } catch (error) {
                    console.error("DEBUG: Failed to fetch or process live data:", error); 
                    // --- Update snapshot status on error ---
                     snapshotResult = { timestamp: new Date().toISOString(), status: "error", error: error.message };
                     currentSnapshotData = snapshotResult; 
                     // Keep snapshot link disabled and update text
                     if (snapshotLink) {
                         snapshotLink.classList.add('disabled');
                         snapshotLink.setAttribute('aria-disabled', 'true');
                         snapshotLink.textContent = "Snapshot Error"; 
                     }

                    // ... (rest of the error handling for UI remains the same) ...
                     const { keyMetrics } = dashboardData;
                     buildTreasuryTable(null, []); buildTlaVp(null, null); buildTlaDeposits(null); 
                     updateTile('daodao-staked', keyMetrics.daodaoStaked.toLocaleString(), false);
                     updateTile('dao-members', keyMetrics.daoMembers.toLocaleString(), false);
                     updateTile('enterprise-staked-holder', keyMetrics.enterpriseStakedHolder.toLocaleString(), false, { titleId: 'enterprise-staked-title'});
                     updateTile('backing-per-nft-ampluna', 'Error', false, { titleId: 'backing-ampluna-title', subtextId: 'backing-per-nft-change', subtext: 'Ratio: Error' });
                     updateTile('backing-per-nft-luna-live', keyMetrics.backingInLuna.toFixed(2), false, { titleId: 'backing-luna-live-title'});
                     updateTile('backing-per-nft-usd', 'Error', false, { titleId: 'backing-usd-title', subtextId: 'live-luna-price', subtext: 'Price Error' });
                     updateTile('unminted-nft-backing-luna', 'Error', false, { titleId: 'unminted-nft-backing-title' });
                      const unmintedNftBackingUsdEl = document.getElementById('unminted-nft-backing-usd'); if (unmintedNftBackingUsdEl) unmintedNftBackingUsdEl.textContent = 'Error';
                      const unmintedModalBackingLuna = document.getElementById('unminted-modal-backing-luna'); const unmintedModalBackingUsd = document.getElementById('unminted-modal-backing-usd'); const unmintedModalTotalLuna = document.getElementById('unminted-modal-total-luna'); const unmintedModalTotalUsd = document.getElementById('unminted-modal-total-usd');
                      if(unmintedModalBackingLuna) unmintedModalBackingLuna.textContent = 'Error'; if(unmintedModalBackingUsd) unmintedModalBackingUsd.textContent = 'Error'; if(unmintedModalTotalLuna) unmintedModalTotalLuna.textContent = 'Error'; if(unmintedModalTotalUsd) unmintedModalTotalUsd.textContent = 'Error';

                } finally {
                     isFetching = false; // Allow fetching again
                     console.log("DEBUG: Finished fetchLiveOnChainData attempt."); // DEBUG LOG
                      // Update static tiles regardless of success/failure, if needed
                       console.log("DEBUG: Updating static tiles (final check)..."); 
                       const { keyMetrics } = dashboardData;
                       // This is now the *only* place avg-daily-gain is updated
                       updateTile('avg-daily-gain', `+${keyMetrics.avgDailyGain}`, false, { titleId: 'avg-daily-gain-title'});
                        const avgDailyGainSubEl = document.getElementById('avg-daily-gain-subtext');
                        if (avgDailyGainSubEl && avgDailyGainSubEl.innerHTML.includes('fa-spinner')) {
                           avgDailyGainSubEl.textContent = `(Snapshot)`;
                        }
                       const daoBrokenTotalEl = document.getElementById('dao-broken-total'); if (daoBrokenTotalEl) daoBrokenTotalEl.textContent = (1000).toLocaleString(); 
                       const supplyDaoControlledEl = document.getElementById('supply-dao-controlled'); if (supplyDaoControlledEl) supplyDaoControlledEl.textContent = (1000).toLocaleString(); 
                       console.log("DEBUG: Finished static tile update check."); 
                }
            }
            
            // --- Helper Functions ---

            const showCopyToast = (text) => {
                let toast = document.getElementById('copy-toast');
                if (!toast) {
                    toast = document.createElement('div');
                    toast.id = 'copy-toast';
                    toast.className = 'fixed bottom-4 right-4 bg-teal-500 text-white px-4 py-2 rounded shadow-lg transform transition-all duration-300 translate-y-20 opacity-0 z-50';
                    document.body.appendChild(toast);
                }
                toast.textContent = text;
                toast.classList.remove('translate-y-20', 'opacity-0');
                setTimeout(() => {
                    toast.classList.add('translate-y-20', 'opacity-0');
                }, 3000);
            };

            const copyToClipboard = (textToCopy, typeName = 'Address') => {
                if (navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard.writeText(textToCopy)
                        .then(() => showCopyToast(`${typeName} copied!`))
                        .catch(() => fallbackCopy(textToCopy, typeName));
                } else {
                    fallbackCopy(textToCopy, typeName);
                }
            };

            const fallbackCopy = (textToCopy, typeName) => {
                const textArea = document.createElement("textarea");
                textArea.value = textToCopy;
                textArea.style.position = "fixed";
                textArea.style.left = "-9999px";
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    document.execCommand('copy');
                    showCopyToast(`${typeName} copied!`);
                } catch (err) {
                    console.error('Fallback copy failed', err);
                }
                document.body.removeChild(textArea);
            };

            function setupInfoModals() {
                 const modalTriggers = {
                    'daodao-staked-card': 'daodaoModal',
                    'enterprise-staked-card': 'enterpriseModal',
                    'dao-broken-card': 'daoBrokenModal',
                    'unminted-backing-card': 'unmintedModal',
                    'dao-treasury-card': 'treasuryModal',
                    'logo-modal-trigger': 'logoModal', 
                    'dao-tla-vp-card': 'tlaVpModal',
                    'dao-tla-card': 'tlaModal'
                };

                const openModal = (modalId) => {
                    const modal = document.getElementById(modalId);
                    if (modal) {
                        modal.classList.remove('hidden');
                        // Small timeout to allow display:block to apply before opacity transition
                        setTimeout(() => {
                            modal.classList.remove('opacity-0');
                            const content = modal.querySelector('.modal-content');
                            if (content) {
                                content.classList.remove('opacity-0', 'scale-95');
                            }
                        }, 10);
                    }
                };

                const closeModalFunc = (modal) => {
                    modal.classList.add('opacity-0');
                    const content = modal.querySelector('.modal-content');
                    if (content) {
                        content.classList.add('opacity-0', 'scale-95');
                    }
                    // Wait for transition to finish before hiding
                    setTimeout(() => {
                        modal.classList.add('hidden');
                    }, 300);
                };

                for (const triggerId in modalTriggers) {
                    const trigger = document.getElementById(triggerId);
                    if (trigger) {
                        trigger.addEventListener('click', (e) => {
                            // Prevent opening if clicking a link inside the card
                            if (e.target.tagName === 'A' || e.target.closest('a')) return;
                            openModal(modalTriggers[triggerId]);
                        });
                    }
                }

                document.querySelectorAll('.modal-close').forEach(button => {
                    button.addEventListener('click', function() {
                        const modal = this.closest('.modal');
                        closeModalFunc(modal);
                    });
                });

                 document.querySelectorAll('.modal').forEach(modal => {
                    modal.addEventListener('click', function(e) {
                        if (e.target === this) {
                            closeModalFunc(this);
                        }
                    });
                 });
            }

            function buildLogoModal() {
                 const container = document.getElementById('logo-library-container'); 
                 if (!container) return; 
                 
                 const logos = [
                    { "name": "Alliance DAO", "url": "https://raw.githubusercontent.com/defipatriot/aDAO-Image-Files/main/Alliance%20DAO%20Logo.png" }, 
                    { "name": "Alliance DAO (No BG)", "url": "https://raw.githubusercontent.com/defipatriot/aDAO-Image-Files/main/aDAO%20Logo%20No%20Background.png" }, 
                    { "name": "Alliance DAO (SVG)", "url": "https://raw.githubusercontent.com/defipatriot/aDAO-Image-Files/main/aDAO%20Logo.svg" }, 
                    { "name": "Enterprise Protocol", "url": "https://raw.githubusercontent.com/defipatriot/aDAO-Image-Files/main/Enterprise.jpg" }, 
                    { "name": "Boost", "url": "https://raw.githubusercontent.com/defipatriot/aDAO-Image-Files/main/Boost%20Logo.png" }, 
                    { "name": "BackBone Labs", "url": "https://raw.githubusercontent.com/defipatriot/aDAO-Image-Files/main/BBL%20No%20Background.png" }, 
                    { "name": "Terra", "url": "https://raw.githubusercontent.com/defipatriot/aDAO-Image-Planets-Empty/main/Terra.PNG" }
                 ];

                container.innerHTML = ''; 
                logos.forEach(logo => {
                    const div = document.createElement('div');
                    div.className = 'bg-gray-800/50 p-4 rounded-lg flex flex-col items-center justify-between h-full group hover:bg-gray-700/50 transition-colors';
                    div.innerHTML = `
                        <div class="h-24 w-full flex items-center justify-center mb-4 bg-black/20 rounded p-2">
                            <img src="${logo.url}" alt="${logo.name}" class="max-h-full max-w-full object-contain">
                        </div>
                        <h3 class="font-bold text-white mb-2">${logo.name}</h3>
                        <button class="copy-logo-url-btn bg-gray-700 hover:bg-cyan-600 text-white text-xs font-bold py-2 px-4 rounded transition-colors w-full" data-url="${logo.url}">
                            <i class="fas fa-copy mr-2"></i> Copy URL
                        </button>
                    `;
                    container.appendChild(div);
                });

                document.querySelectorAll('.copy-logo-url-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        copyToClipboard(this.dataset.url, 'Logo URL');
                    });
                });
            }
            
              function buildTreasuryTable(priceData, liveAssets) { /* ... no changes needed ... */ 
                 const container = document.getElementById('treasury-table-container');
                 const totalValueEl = document.getElementById('dao-treasury-total'); 
                 if (!container || !totalValueEl) { return; }
                
                let totalLiveUsd = 0;
                const valuedAssets = []; const unvaluedAssets = [];
                 liveAssets.forEach(asset => {
                    let livePrice = null;
                    if (priceData && priceData[asset.geckoId]) { livePrice = priceData[asset.geckoId].usd; }
                    const liveValue = (typeof livePrice === 'number') ? asset.amount * livePrice : null;
                    if (liveValue !== null) { valuedAssets.push({ ...asset, liveValue }); totalLiveUsd += liveValue; } 
                    else { unvaluedAssets.push({ ...asset, liveValue: null }); }
                });
                valuedAssets.sort((a, b) => b.liveValue - a.liveValue);
                unvaluedAssets.sort((a, b) => b.amount - a.amount); 
                const sortedAssets = [...valuedAssets, ...unvaluedAssets];
                let tableHtml = `<table class="w-full text-left text-sm"><thead class="sticky top-0 bg-gray-900 z-10"><tr><th class="p-2">Asset</th><th class="p-2 text-right">Amount</th><th class="p-2 text-right">Live Value (USD)</th></tr></thead><tbody>`;
                if (sortedAssets.length === 0) {
                     tableHtml += `<tr><td colspan="3" class="text-center p-4 text-gray-500">${priceData === null ? 'Failed to load treasury data.' : 'No assets found in treasury.'}</td></tr>`;
                 } else {
                     for(const asset of sortedAssets) {
                         let amountFormatted = asset.amount < 0.0001 && asset.amount > 0 ? asset.amount.toExponential(2) : asset.amount < 1 ? asset.amount.toFixed(6) : asset.amount.toLocaleString('en-US', { maximumFractionDigits: 2 }); 
                         const logoUrl = tokenLogos[asset.name];
                         const valueDisplay = asset.liveValue !== null ? '$' + asset.liveValue.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '<span class="text-gray-500">N/A</span>'; 
                         tableHtml += `
                             <tr class="border-t border-gray-700">
                                 <td class="p-2 font-bold flex items-center gap-2">
                                     ${logoUrl ? `<img src="${logoUrl}" alt="${asset.name}" class="h-5 w-5 rounded-full" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline-block';"> <span style="display:none;" class="h-5 w-5"></span>` : '<div class="h-5 w-5 inline-block"></div>'}
                                     <span>${asset.name}</span>
                                 </td>
                                 <td class="p-2 text-right font-mono">${amountFormatted}</td>
                                 <td class="p-2 text-right font-mono">${valueDisplay}</td>
                             </tr>`;
                     }
                 }
                tableHtml += `</tbody><tfoot class="sticky bottom-0 bg-gray-900 z-10"><tr class="border-t-2 border-cyan-400 font-bold"><td class="p-2">Total</td><td></td><td class="p-2 text-right font-mono text-cyan-400">${'$' + totalLiveUsd.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td></tr></tfoot></table>`;
                container.innerHTML = tableHtml;
                 if (totalValueEl.innerHTML.includes('fa-spinner')) { totalValueEl.textContent = '$' + totalLiveUsd.toLocaleString('en-US', {maximumFractionDigits: 0}); }
                 updateTile('dao-treasury-total', null, priceData !== null, { titleId: 'dao-treasury-title' }); 
            }
            function buildTlaDeposits(priceData) { /* ... no changes needed ... */ 
                 const tlaData = dashboardData.tlaDeposits;
                 const totalValueTileEl = document.getElementById('dao-tla-total');
                 const aprTileEl = document.getElementById('dao-tla-apr');
                 const modalTotalUsdEl = document.getElementById('tla-deposit-total-usd');
                 const modalTotalAprEl = document.getElementById('tla-deposit-total-apr');
                 const modalUnclaimedEl = document.getElementById('tla-unclaimed-rewards');
                 const snapshotDateEl = document.getElementById('tla-snapshot-date');
                 const poolsContainer = document.getElementById('tla-pools-container');
                 const tokensContainer = document.getElementById('tla-tokens-container');
                 if (!tlaData || !totalValueTileEl || !aprTileEl || !modalTotalUsdEl || !modalTotalAprEl || !modalUnclaimedEl || !snapshotDateEl || !poolsContainer || !tokensContainer) { if(totalValueTileEl) totalValueTileEl.textContent = 'Error'; if(aprTileEl) aprTileEl.textContent = ''; return; }
                 if (totalValueTileEl.innerHTML.includes('fa-spinner')) { totalValueTileEl.textContent = `$${tlaData.totalDeposit.toLocaleString('en-US', {minimumFractionDigits: 0})}`; }
                 if (aprTileEl.innerHTML.includes('fa-spinner')) { aprTileEl.textContent = `Est. APR ${tlaData.estApr.toFixed(2)}%`; }
                 updateTile('dao-tla-total', null, false, { titleId: 'dao-tla-title' }); 
                modalTotalUsdEl.textContent = `$${tlaData.totalDeposit.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                modalTotalAprEl.textContent = `Est. APR ${tlaData.estApr.toFixed(2)}%`;
                modalUnclaimedEl.textContent = `Unclaimed Rewards: $${tlaData.unclaimedRewards.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                snapshotDateEl.textContent = new Date(tlaData.snapshotDate).toLocaleDateString();
                let poolsHtml = '';
                tlaData.pools.forEach(pool => {
                    poolsHtml += `
                        <div class="bg-gray-800/50 p-3 rounded-lg text-sm">
                            <p class="font-bold text-white">${pool.name}</p>
                            <p class="text-xs text-gray-400">${pool.platform}</p>
                            <div class="border-t border-gray-600 mt-2 pt-2 space-y-1">
                                <div class="flex justify-between"><span>Non-Compounding:</span> <span class="font-mono">$${pool.whiteValue?.toLocaleString() || 'N/A'} @ ${pool.whiteApr?.toFixed(2) || 'N/A'}%</span></div>
                                ${pool.orangeValue ? `<div class="flex justify-between"><span class="text-yellow-400">Compounding:</span> <span class="font-mono text-yellow-400">$${pool.orangeValue.toLocaleString()} @ ${pool.orangeApr.toFixed(2)}%</span></div>` : ''}
                            </div></div>`; });
                poolsContainer.innerHTML = poolsHtml;
                let tokensHtml = '<table class="w-full text-left text-sm"><thead><tr><th class="p-1">Token</th><th class="p-1 text-right">Balance (Snapshot)</th><th class="p-1 text-right">Live Est. Value</th></tr></thead><tbody>';
                let totalLiveEstValue = 0;
                const ampRatios = { "ampCAPA": { ratio: 1.1055, baseGeckoId: 'capapult' }, "ampROAR": { ratio: 1.1087, baseGeckoId: 'lion-dao' } };
                 tlaData.tokenBalances.forEach(token => {
                     const logoUrl = tokenLogos[token.name]; let liveValue = null;
                     if (priceData) { 
                         const geckoId = token.geckoId;
                         if (geckoId && priceData[geckoId] && typeof priceData[geckoId].usd === 'number') { liveValue = token.amount * priceData[geckoId].usd; } 
                         else if (ampRatios[token.name]) {
                             const ratioInfo = ampRatios[token.name]; const baseTokenPrice = priceData[ratioInfo.baseGeckoId]?.usd;
                             if(typeof baseTokenPrice === 'number'){ const baseTokenAmount = token.amount * ratioInfo.ratio; liveValue = baseTokenAmount * baseTokenPrice; }
                         }
                          if (typeof liveValue === 'number') { totalLiveEstValue += liveValue; }
                     }
                      let amountFormatted = token.amount < 0.0001 && token.amount > 0 ? token.amount.toExponential(2) : token.amount < 1 ? token.amount.toFixed(6) : token.amount.toLocaleString('en-US', { maximumFractionDigits: 2 }); 
                     tokensHtml += `
                        <tr class="border-t border-gray-700">
                            <td class="p-1 font-bold flex items-center gap-2">
                                ${logoUrl ? `<img src="${logoUrl}" alt="${token.name}" class="h-5 w-5 rounded-full" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline-block';"><span style="display:none;" class="h-5 w-5"></span>` : '<div class="h-5 w-5 inline-block"></div>'} ${token.name}
                            </td> <td class="p-1 text-right font-mono">${amountFormatted}</td> <td class="p-1 text-right font-mono">${liveValue !== null ? '$' + liveValue.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '<span class="text-gray-500">N/A</span>'}</td>
                        </tr>`; });
                tokensHtml += `</tbody><tfoot class="sticky bottom-0 bg-gray-900 z-10"><tr class="border-t-2 border-cyan-400 font-bold"><td class="p-1" colspan="2">Total Live Est. Value</td><td class="p-1 text-right font-mono text-cyan-400">$${totalLiveEstValue.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td></tr></tfoot></table>`;
                tokensContainer.innerHTML = tokensHtml;
            }
            function buildTlaVp(priceData, ampLunaToLunaRate) { /* ... no changes needed ... */ 
                const container = document.getElementById('tla-vp-locks-container');
                 const mainTileValueEl = document.getElementById('dao-tla-vp'); 
                 const mainTileUsdEl = document.getElementById('dao-tla-vp-usd');
                 const modalLunaEl = document.getElementById('tla-vp-modal-luna');
                 const modalUsdEl = document.getElementById('tla-vp-modal-usd');
                 if (!container || !mainTileValueEl || !mainTileUsdEl || !modalLunaEl || !modalUsdEl) { if(mainTileUsdEl) mainTileUsdEl.textContent = 'Error'; return; }
                const lunaPriceUSD = priceData?.['terra-luna-2']?.usd;
                 const arbLunaGeckoId = 'staked-luna-slinky'; 
                 const arbLunaPriceUSD = priceData?.[arbLunaGeckoId]?.usd; 
                 const staticArbLunaToLunaRate = 2.3583; let effectiveArbLunaRate = staticArbLunaToLunaRate; 
                 const arbLunaToLunaRate = effectiveArbLunaRate;
                 const ratesAreValid = typeof lunaPriceUSD === 'number' && typeof ampLunaToLunaRate === 'number' && typeof arbLunaToLunaRate === 'number';
                const locks = [ { id: 600, asset: 'arbLUNA', amount: 27290, ratio: arbLunaToLunaRate, isLive: ratesAreValid, staticVp: 631570 }, { id: 711, asset: 'ampLUNA', amount: 413.03, ratio: ampLunaToLunaRate, isLive: ratesAreValid, staticVp: 7316.76 } ];
                let totalUnderlyingLuna = 0; let locksHtml = '';
                locks.forEach(lock => {
                    const logoUrl = tokenLogos[lock.asset]; const underlyingLuna = lock.amount * lock.ratio;
                    const usdValue = ratesAreValid ? underlyingLuna * lunaPriceUSD : null; totalUnderlyingLuna += underlyingLuna;
                    const ratioDot = lock.isLive ? '<span class="pulse-dot ml-1"></span>' : '<span class="static-dot-red ml-1"></span>';
                    locksHtml += `
                        <div class="bg-gray-800/50 p-4 rounded-lg grid grid-cols-1 md:grid-cols-5 gap-4 items-center text-center mt-2 text-sm">
                            <div class="font-bold text-lg text-white"><p>NFT #${lock.id}</p></div>
                            <div class="flex items-center justify-center gap-2"> ${logoUrl ? `<img src="${logoUrl}" alt="${lock.asset}" class="h-6 w-6 rounded-full" onerror="this.style.display='none';">` : '<div class="h-6 w-6"></div>'} <p class="font-bold text-white">${lock.amount.toLocaleString('en-US', {maximumFractionDigits:2})} ${lock.asset}</p> </div>
                            <div> <p class="text-sm text-gray-400">Underlying LUNA</p> <p class="font-bold text-white">${underlyingLuna.toLocaleString('en-US', {maximumFractionDigits:2})}</p> <p class="text-xs text-gray-500 flex items-center justify-center"> <span>(Ratio: ${lock.ratio.toFixed(4)})</span> ${ratioDot} </p> </div>
                             <div> <p class="text-sm text-gray-400">Value (USD)</p> <p class="font-bold text-white">${usdValue !== null ? '$' + usdValue.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : 'N/A'}</p> </div>
                             <div> <p class="text-sm text-gray-400">Voting Power</p> <p class="font-bold text-cyan-400">${(lock.staticVp / 1000).toFixed(2)}K VP</p> <p class="text-xs text-green-400">Max Locked (10x)</p> </div>
                        </div>`; });
                container.innerHTML = locksHtml;
                const totalUsdValue = ratesAreValid ? totalUnderlyingLuna * lunaPriceUSD : null; const totalStaticVp = 638880; 
                 if (mainTileUsdEl.innerHTML.includes('fa-spinner')) { mainTileUsdEl.textContent = totalUsdValue !== null ? `$${totalUsdValue.toLocaleString('en-US', {maximumFractionDigits: 0})}` : '...'; }
                 updateTile('dao-tla-vp-usd', null, ratesAreValid, { titleId: 'dao-tla-vp-title' }); 
                 modalLunaEl.textContent = `~${(totalUnderlyingLuna).toLocaleString('en-US', {maximumFractionDigits:2})} LUNA / TLA Lock`;
                 modalUsdEl.textContent = totalUsdValue !== null ? `(${totalUsdValue.toLocaleString('en-US', {style: 'currency', currency: 'USD'})})` : '(Live calculation unavailable)';
            }
            function buildStakerTable(tableId, stakerData) { /* ... no changes needed ... */ 
                const tableContainer = document.getElementById(tableId);
                if (!tableContainer) { return; }
                let tableHtml = `<table class="w-full text-left text-sm"><tbody>`; 
                const sortedStakers = Object.entries(stakerData).sort(([, a], [, b]) => b - a);
                if(sortedStakers.length > 0) {
                    for (const [address, count] of sortedStakers) {
                        const shortAddress = address.length > 15 ? `${address.substring(0, 6)}...${address.substring(address.length - 4)}` : address;
                        tableHtml += `<tr class="border-t border-gray-700">
                                         <td class="p-2 font-mono w-3/4" title="${address}">${shortAddress}</td>
                                         <td class="p-2 text-right font-bold w-1/4">${count}</td>
                                      </tr>`; }
                } else { tableHtml += `<tr><td colspan="2" class="text-center p-4 text-gray-500">No holder NFTs currently staked here.</td></tr>`; }
                tableHtml += `</tbody></table>`; 
                tableContainer.innerHTML = tableHtml; 
                 const totalCount = sortedStakers.reduce((sum, [, count]) => sum + count, 0); 
                 if (tableId === 'enterprise-stakers-table') {
                     const enterpriseCountEl = document.getElementById('enterprise-modal-holder-count');
                     if (enterpriseCountEl && enterpriseCountEl.innerHTML.includes('fa-spinner')) enterpriseCountEl.textContent = totalCount.toLocaleString();
                 }
                 if (tableId === 'daodao-stakers-table') {
                     const daodaoCountEl = document.getElementById('daodao-modal-holder-count');
                     if (daodaoCountEl && daodaoCountEl.innerHTML.includes('fa-spinner')) daodaoCountEl.textContent = totalCount.toLocaleString();
                 }
            }
            function updateTile(elementId, value, isLive, options = {}) { /* ... no changes needed ... */ 
                 const el = document.getElementById(elementId);
                 if (value !== null && value !== undefined && el) {
                     if (el.innerHTML.includes('fa-spinner') || value === 'Error') { el.textContent = value; }
                 }
                const titleId = options.titleId || `${elementId}-title`;
                const titleEl = document.getElementById(titleId);
                if (titleEl) {
                    const existingDot = titleEl.querySelector('.pulse-dot, .static-dot-red');
                    if (existingDot) existingDot.remove();
                    const newDot = document.createElement('span');
                    newDot.className = isLive ? 'pulse-dot ml-1' : 'static-dot-red ml-1';
                     if (!titleEl.querySelector('.pulse-dot, .static-dot-red')) { titleEl.appendChild(newDot); }
                }
                if (options.subtextId && options.subtext !== undefined) { 
                     const subtextEl = document.getElementById(options.subtextId);
                     if (subtextEl) {
                        if (subtextEl.innerHTML.includes('fa-spinner') || options.subtext === 'Error' || options.subtext === 'Ratio: Error') { 
                            subtextEl.textContent = options.subtext;
                        }
                     }
                }
            }
            // Removed placeholder constants here as they are now defined above.

            function setupInfoModalsPlaceholder() { /* REMOVED */ } 
            function buildLogoModalPlaceholder() { /* REMOVED */ }

             // --- Snapshot Download Function ---
             function downloadSnapshot() {
                 console.log("DEBUG: Download button clicked."); 
                 if (!currentSnapshotData) {
                     console.error("DEBUG: No snapshot data available to download."); 
                     // Optionally update link text briefly on error
                     if(snapshotLink) snapshotLink.textContent = "Error: No Data";
                     setTimeout(() => { if(snapshotLink) snapshotLink.textContent = "Snapshot Error"; }, 1500);
                     return;
                 }
                 if (currentSnapshotData.status !== "success") {
                     console.error("DEBUG: Snapshot data status is not 'success'.", currentSnapshotData); 
                     if(snapshotLink) snapshotLink.textContent = "Error: Fetch Failed";
                     setTimeout(() => { if(snapshotLink) snapshotLink.textContent = "Snapshot Error"; }, 1500);
                     return;
                 }

                 try {
                     const jsonString = JSON.stringify(currentSnapshotData, null, 2); 
                     const blob = new Blob([jsonString], { type: 'application/json' });
                     const url = URL.createObjectURL(blob);
                     const a = document.createElement('a');
                     a.style.display = 'none'; a.href = url;
                     const date = new Date(currentSnapshotData.timestamp).toISOString().split('T')[0];
                     a.download = `adao-snapshot-${date}.json`;
                     document.body.appendChild(a); a.click();
                     window.URL.revokeObjectURL(url); document.body.removeChild(a);
                     console.log("DEBUG: Snapshot download triggered."); 
                     // Optionally update link text briefly on success
                      if(snapshotLink) snapshotLink.textContent = "Downloaded!";
                      setTimeout(() => { if(snapshotLink) snapshotLink.textContent = "Download Snapshot"; }, 1500);

                 } catch (error) {
                      console.error("DEBUG: Error creating or downloading snapshot file:", error); 
                       if(snapshotLink) snapshotLink.textContent = "Download Error";
                       setTimeout(() => { if(snapshotLink) snapshotLink.textContent = "Download Snapshot"; }, 1500);
                 }
             }


            // --- Main Execution ---
            updateUI(); // Initial UI setup with static data & trigger live fetch
            setupInfoModals(); // Setup general info modals
            buildLogoModal(); // Build the logo modal content
            
            // --- Attach Snapshot Link Listener ---
             if (snapshotLink) {
                 snapshotLink.addEventListener('click', (e) => {
                     e.preventDefault(); // Prevent default link behavior
                     // Only download if not disabled
                     if (!snapshotLink.classList.contains('disabled')) {
                         downloadSnapshot();
                     }
                 });
             } else {
                 console.warn("Snapshot link not found.");
             }

            // --- Disclaimer Banner Logic ---
            const banner = document.getElementById('disclaimer-banner');
            const closeButton = document.getElementById('close-banner');
            if (banner && closeButton) {
                closeButton.addEventListener('click', () => {
                    banner.style.display = 'none';
                });
            }

        }); // End of main DOMContentLoaded listener

    </script>
</body>
</html>
