<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alliance DAO Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

    <script>
     window.va = window.va || function () { (window.va.q = window.va.q || []).push(arguments); };
    </script>
    <script src="/_vercel/insights/script.js" defer></script>
    
    <style>
        /* --- Base Styles --- */
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: #0D0D0D;
            color: #EAEAEA;
        }

        /* --- Card Styles --- */
        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            /* backdrop-filter: blur(10px); */ /* PERFORMANCE: Commented out, this is very expensive */
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .stat-card:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(45, 212, 191, 0.5);
        }
        .info-card {
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 1.5rem;
        }
        .info-card .icon {
            font-size: 1.75rem;
            margin-bottom: 0.75rem;
            color: #2dd4bf; /* teal-400 */
        }
        .info-card h3 {
            font-size: 1.125rem;
            font-weight: 700;
            color: #fff;
            margin-bottom: 0.5rem;
        }
        .info-card p, .info-card .link-text {
            font-size: 0.875rem;
            color: #9ca3af; /* gray-400 */
            line-height: 1.5;
            flex-grow: 1; /* Allows text to take up space */
        }
         .info-card .link-group {
            margin-top: 1rem;
        }
        .info-card a:hover .link-text, .info-card a:hover h3, .info-card .link-text a:hover {
            color: #2dd4bf;
        }
        .stat-card .subtext {
            min-height: 1.25rem; /* Ensures space is reserved for subtext */
        }

        /* --- Slider Styles --- */
        .slider-bar {
            display: flex;
            height: 0.75rem;
            border-radius: 9999px;
            overflow: hidden;
            position: relative;
        }
        .slider-fill-blue {
            background: linear-gradient(90deg, #00F2FE, #2889FC);
        }
        .slider-fill-gray {
            background-color: #374151; /* gray-700 */
        }

        /* --- Pulse Animation for Live Proposals --- */
        .pulse-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #4ade80; /* green-400 */
            animation: pulse 2s infinite;
            /* box-shadow: 0 0 0 0 rgba(74, 222, 128, 1); */ /* PERFORMANCE: Removed expensive shadow animation */
        }
        @keyframes pulse {
            0% { transform: scale(0.95); /* box-shadow: 0 0 0 0 rgba(74, 222, 128, 0.7); */ }
            70% { transform: scale(1); /* box-shadow: 0 0 0 10px rgba(74, 222, 128, 0); */ }
            100% { transform: scale(0.95); /* box-shadow: 0 0 0 0 rgba(74, 222, 128, 0); */ }
        }

        /* --- Red Static Dot for No Proposals --- */
        .static-dot-red {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #ef4444; /* red-500 */
        }
        
        /* --- Modal Styles (Generic) --- */
        .modal {
            transition: opacity 0.3s ease;
        }
        .modal.hidden {
            pointer-events: none;
        }
        .modal .modal-content {
            transition: transform 0.3s ease, opacity 0.3s ease;
            max-height: 90vh; /* Keep overall max height */
        }
        .modal.hidden .modal-content {
            transform: scale(0.95);
            opacity: 0;
        }

        /* --- NFT Explorer Modal Styles --- */
         .modal-backdrop {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex; align-items: center; justify-content: center;
            z-index: 50; 
            /* backdrop-filter: blur(4px); */ /* PERFORMANCE: Commented out, expensive */
        }
        .modal-content-explorer { /* Renamed to avoid conflict */
            background-color: #1f2937; border: 1px solid #4b5563;
            border-radius: 0.75rem; padding: 1.5rem;
            max-width: 90vw; max-height: 90vh;
            width: 500px; /* Specific width from explorer */
            overflow-y: auto;
            position: relative;
        }
        .modal-close-btn {
            position: absolute; top: 1rem; right: 1rem;
            color: #9ca3af; cursor: pointer;
        }
        .modal-close-btn:hover { color: #e5e7eb; }
        .control-btn { /* Style for download button */
            background-color: #374151; /* gray-700 */
            color: #e5e7eb; /* gray-200 */
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            border: 1px solid #4b5563; /* gray-600 */
            transition: background-color 0.2s;
            font-weight: 500;
        }
        .control-btn:hover:not(:disabled) {
            background-color: #4b5563; /* gray-600 */
        }
        
        /* --- Snapshot Link Style --- */
        #snapshot-link { /* Changed ID from snapshot-btn */
             cursor: pointer;
        }
        #snapshot-link.disabled { /* Style for disabled link */
             opacity: 0.5;
             cursor: not-allowed;
             text-decoration: none; /* Remove underline when disabled */
        }
        #snapshot-link.disabled:hover { /* Prevent hover effect when disabled */
             color: #9ca3af; /* gray-400 */
        }
        
        /* --- Chart Icon Style --- */
        .chart-icon {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(45, 212, 191, 0.1);
            border: 1px solid rgba(45, 212, 191, 0.3);
            border-radius: 4px;
            cursor: pointer;
            opacity: 0.6;
            transition: all 0.2s ease;
            z-index: 10;
        }
        .chart-icon:hover {
            opacity: 1;
            background: rgba(45, 212, 191, 0.2);
            border-color: rgba(45, 212, 191, 0.6);
        }
        .chart-icon i {
            font-size: 12px;
            color: #2dd4bf;
        }
        .stat-card {
            position: relative;
        }
        
        /* Chart point selection */
        .chart-point-selected {
            box-shadow: 0 0 10px rgba(45, 212, 191, 0.8);
        }

        /* --- NFT Marketplace Section Styles --- */
        .nft-mini-card {
            background: rgba(31, 41, 55, 0.8);
            border: 1px solid rgba(75, 85, 99, 0.5);
            border-radius: 0.5rem;
            overflow: hidden;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .nft-mini-card:hover {
            border-color: rgba(45, 212, 191, 0.5);
            transform: translateY(-2px);
        }
        .nft-mini-card img {
            width: 100%;
            aspect-ratio: 1;
            object-fit: cover;
        }
        .nft-mini-card .card-info {
            padding: 0.5rem;
            font-size: 0.75rem;
        }
        .nft-mini-card .nft-id {
            font-weight: 700;
            color: #fff;
        }
        .nft-mini-card .nft-price {
            color: #2dd4bf;
            font-family: monospace;
        }
        .nft-mini-card .nft-usd {
            color: #9ca3af;
            font-size: 0.65rem;
        }
        .nft-mini-card.broken-card {
            border-color: rgba(239, 68, 68, 0.3);
        }
        .nft-mini-card.broken-card:hover {
            border-color: rgba(239, 68, 68, 0.6);
        }
        .broken-badge {
            position: absolute;
            top: 4px;
            left: 4px;
            background: rgba(239, 68, 68, 0.9);
            color: white;
            font-size: 0.5rem;
            padding: 1px 4px;
            border-radius: 2px;
            font-weight: 700;
        }
        .marketplace-section {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 0.75rem;
            padding: 1.5rem;
        }
        .marketplace-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }
        .marketplace-header img {
            height: 24px;
            width: auto;
        }
        .marketplace-header h3 {
            font-size: 1rem;
            font-weight: 700;
            color: #fff;
        }
        .listing-column {
            min-height: 200px;
        }
        .listing-column h4 {
            font-size: 0.75rem;
            color: #9ca3af;
            margin-bottom: 0.5rem;
            padding-bottom: 0.25rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .listing-scroll {
            max-height: 280px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #4b5563 transparent;
        }
        .listing-scroll::-webkit-scrollbar {
            width: 4px;
        }
        .listing-scroll::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 2px;
        }
        .top10-btn {
            background: linear-gradient(135deg, rgba(234, 179, 8, 0.2), rgba(245, 158, 11, 0.1));
            border: 1px solid rgba(234, 179, 8, 0.3);
            color: #fbbf24;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .top10-btn:hover {
            background: linear-gradient(135deg, rgba(234, 179, 8, 0.3), rgba(245, 158, 11, 0.2));
            border-color: rgba(234, 179, 8, 0.5);
            transform: translateY(-1px);
        }
        .recent-sale-row {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem;
            background: rgba(31, 41, 55, 0.5);
            border-radius: 0.375rem;
            margin-bottom: 0.5rem;
            transition: background 0.2s;
        }
        .recent-sale-row:hover {
            background: rgba(31, 41, 55, 0.8);
        }
        .recent-sale-row img {
            width: 48px;
            height: 48px;
            border-radius: 0.25rem;
            object-fit: cover;
        }
        .sale-info {
            flex: 1;
            min-width: 0;
        }
        .sale-nft-id {
            font-weight: 700;
            color: #fff;
            font-size: 0.875rem;
        }
        .sale-date {
            font-size: 0.7rem;
            color: #6b7280;
        }
        .sale-price {
            text-align: right;
        }
        .sale-amount {
            font-family: monospace;
            color: #2dd4bf;
            font-size: 0.875rem;
            font-weight: 600;
        }
        .sale-usd {
            font-size: 0.7rem;
            color: #9ca3af;
        }
        .marketplace-badge {
            font-size: 0.6rem;
            padding: 1px 4px;
            border-radius: 2px;
            font-weight: 600;
        }
        .badge-bbl {
            background: rgba(139, 92, 246, 0.2);
            color: #a78bfa;
        }
        .badge-boost {
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
        }

    </style>
</head>
<body class="antialiased">

    <header class="py-4">
        <!-- Flex Container wrapping content. Mobile: Wrap allowed. Desktop: No Wrap. -->
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex flex-wrap md:flex-nowrap justify-between items-center">
            
            <!-- Left Logo: Mobile Order 1. Width 50% on mobile. -->
            <div class="flex-shrink-0 w-1/2 md:w-32 order-1">
                 <img src="https://raw.githubusercontent.com/defipatriot/aDAO-Image-Files/main/Alliance%20DAO%20Logo.png" alt="Alliance DAO Logo" class="h-12 md:h-16 w-auto" onerror="this.src='https://placehold.co/128x64/0D0D0D/EAEAEA?text=Logo'; this.onerror=null;">
            </div>

            <!-- Navigation: Mobile Order 3 (New Row). Full width on mobile. Desktop Order 2 (Center). -->
            <nav class="flex-1 w-full md:w-auto flex justify-center items-center gap-3 order-3 md:order-2 mt-4 md:mt-0">
                <!-- Buttons are smaller on mobile (text-xs/sm, less padding) to fit 3 in a row -->
                <a href="nft-explorer-index.html" class="bg-gray-800/50 hover:bg-gray-700/80 border border-gray-700 text-white font-bold py-2 px-3 text-xs sm:text-sm md:py-3 md:px-8 md:text-base rounded-lg shadow-lg transition-all transform hover:scale-105 whitespace-nowrap text-center">
                    NFT Explorer
                </a>
                 <a href="planet-map.html" class="bg-gray-800/50 hover:bg-gray-700/80 border border-gray-700 text-white font-bold py-2 px-3 text-xs sm:text-sm md:py-3 md:px-8 md:text-base rounded-lg shadow-lg transition-all transform hover:scale-105 whitespace-nowrap text-center">
                    Galaxy Map
                </a>
                <a href="tla-stats.html" class="bg-gray-800/50 hover:bg-gray-700/80 border border-gray-700 text-white font-bold py-2 px-3 text-xs sm:text-sm md:py-3 md:px-8 md:text-base rounded-lg shadow-lg transition-all transform hover:scale-105 whitespace-nowrap text-center">
                    TLA Stats
                </a>
            </nav>

            <!-- Right Logo: Mobile Order 2. Width 50% on mobile. Aligned Right. Desktop Order 3. -->
            <div class="w-1/2 md:w-32 flex-shrink-0 flex justify-end order-2 md:order-3">
                 <img src="https://raw.githubusercontent.com/defipatriot/aDAO-Image-Planets-Empty/main/Terra.PNG" alt="Terra Logo" class="h-12 md:h-16 w-auto" onerror="this.src='https://placehold.co/128x64/0D0D0D/EAEAEA?text=Logo'; this.onerror=null;">
            </div>
        </div>
    </header>

    <div class="py-2 border-b border-gray-800">
        <script src="https://widgets.coingecko.com/gecko-coin-price-marquee-widget.js"></script>
<gecko-coin-price-marquee-widget locale="en" dark-mode="true" outlined="true" coin-ids="terra-luna-2,eris-amplified-luna,eris-arbitrage-luna,backbone-labs-staked-luna,lion-dao,capapult,solid-2,astroport-fi,eureka-bridged-wbtc-terra,cosmos,ethereum" initial-currency="usd"></gecko-coin-price-marquee-widget>
    </div>


    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <div id="disclaimer-banner" class="bg-yellow-500/10 border border-yellow-400/30 text-yellow-300 px-4 py-3 rounded-lg relative mb-8 text-center" role="alert">
            <strong class="font-bold">Please Note:</strong>
            <span class="block sm:inline">Tiles with a <span class="inline-block w-2.5 h-2.5 rounded-full bg-red-500 mx-1 align-middle"></span> are from a snapshot. Tiles with a <span class="inline-block w-2.5 h-2.5 rounded-full bg-green-400 mx-1 align-middle"></span> are from a live feed.</span>
            <span id="close-banner" class="absolute top-0 bottom-0 right-0 px-4 py-3 cursor-pointer">
                <svg class="fill-current h-6 w-6 text-yellow-400" role="button" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><title>Close</title><path d="M14.348 14.849a1.2 1.2 0 0 1-1.697 0L10 11.819l-2.651 3.029a1.2 1.2 0 1 1-1.697-1.697l2.758-3.15-2.759-3.152a1.2 1.2 0 1 1-1.697-1.697L10 8.183l2.651-3.031a1.2 1.2 0 1 1-1.697 1.697l-2.758 3.152 2.758 3.15a1.2 1.2 0 0 1 0 1.698z"/></svg>
            </span>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <a href="ally.html" class="stat-card info-card rounded-xl group">
                <i class="fas fa-layer-group icon"></i>
                <h3 class="group-hover:text-teal-400">ALLY Rewards</h3>
                <p>A pioneering collection backed by LUNA staking rewards. Your share of the pool grows as others claim theirs.</p>
                <span class="link-text link-group">Learn More &rarr;</span>
            </a>
            <div class="flex flex-col gap-4">
                 <a href="tutorials.html" class="stat-card info-card rounded-xl group flex-1">
                      <i class="fas fa-video icon !mb-2"></i>
                      <h3 class="group-hover:text-teal-400 !mb-0">Tutorials & Guides</h3>
                 </a>
                 <a href="news.html" class="stat-card info-card rounded-xl group flex-1">
                      <i class="fas fa-newspaper icon !mb-2"></i>
                      <h3 class="group-hover:text-teal-400 !mb-0">Ecosystem News</h3>
                 </a>
            </div>
             <div class="flex flex-col gap-4">
                <a href="rarity-explained.html" class="stat-card info-card rounded-xl group flex-1">
                     <i class="fas fa-gem icon !mb-2"></i>
                     <h3 class="group-hover:text-teal-400 !mb-0">Rarity Info</h3>
                </a>
                <a href="release-history.html" class="stat-card info-card rounded-xl group flex-1">
                     <i class="fas fa-stream icon !mb-2"></i>
                     <h3 class="group-hover:text-teal-400 !mb-0">NFT Release History</h3>
                </a>
            </div>
            <div class="flex flex-col gap-4">
                <a href="links.html" class="stat-card info-card rounded-xl group flex-1">
                     <i class="fas fa-link icon !mb-2"></i>
                     <h3 class="group-hover:text-teal-400 !mb-0">Official Links</h3>
                </a>
                <a href="alliances.html" class="stat-card info-card rounded-xl group flex-1">
                     <i class="fas fa-handshake icon !mb-2"></i>
                     <h3 class="group-hover:text-teal-400 !mb-0">Our Alliances</h3>
                </a>
            </div>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <div class="stat-card p-4 rounded-xl">
                <div class="flex justify-between items-center text-sm font-medium text-gray-300">
                    <span>Un-minted</span>
                    <h3 class="text-base font-semibold text-gray-400">Mint Status</h3>
                    <span>Minted</span>
                </div>
                <div id="mint-slider" class="slider-bar mt-2">
                    </div>
                <div class="flex justify-between text-sm font-bold text-white mt-2">
                    <span id="unminted-count"><i class="fas fa-spinner fa-spin text-white"></i></span>
                    <span id="minted-percent" class="text-center text-cyan-400"><i class="fas fa-spinner fa-spin text-cyan-400"></i></span>
                    <span id="minted-count"><i class="fas fa-spinner fa-spin text-white"></i></span>
                </div>
            </div>
            <div class="stat-card p-4 rounded-xl">
                <div class="flex justify-between items-center text-sm font-medium text-gray-300">
                    <span>Un-Broken</span>
                    <h3 class="text-base font-semibold text-gray-400">Broken Status</h3>
                    <span>Broken</span>
                </div>
                <div id="broken-slider" class="slider-bar mt-2">
                    </div>
                <div class="flex justify-between text-sm font-bold text-white mt-2">
                    <span id="unbroken-count"><i class="fas fa-spinner fa-spin text-white"></i></span>
                    <div class="text-center">
                        <p id="broken-percent" class="text-cyan-400 text-xs"><i class="fas fa-spinner fa-spin text-cyan-400"></i></p>
                    </div>
                    <span id="broken-count"><i class="fas fa-spinner fa-spin text-white"></i></span>
                </div>
            </div>
        </div>

        <div id="unclaimed-rewards-card" class="stat-card rounded-xl p-6 mb-8">
             <div class="flex items-center justify-between mb-4">
                 <div class="flex items-center">
                     <i class="fas fa-coins icon mr-3 text-2xl text-yellow-400"></i>
                     <h3 class="text-xl font-bold text-white">DAO Unclaimed Rewards</h3>
                 </div>
                 <div class="flex items-center gap-2">
                     <span id="unclaimed-data-status" class="text-xs text-gray-500">Data from TLA Snapshot</span>
                     <span id="unclaimed-stale-warning" class="hidden text-xs bg-red-600/80 text-white px-2 py-0.5 rounded-full">
                         <i class="fas fa-exclamation-triangle mr-1"></i>Stale Data
                     </span>
                 </div>
             </div>
             <!-- Stale Data Alert Banner (hidden by default) -->
             <div id="unclaimed-stale-banner" class="hidden bg-red-900/50 border border-red-500 rounded-lg p-3 mb-4">
                 <div class="flex items-start gap-2">
                     <i class="fas fa-exclamation-circle text-red-400 mt-0.5"></i>
                     <div>
                         <p class="text-sm text-red-300 font-medium">Snapshot data is outdated</p>
                         <p id="unclaimed-stale-message" class="text-xs text-red-400/80 mt-1">Showing data from epoch <span id="stale-epoch-num">--</span>. Current epoch is <span id="current-epoch-num">--</span>. This data may not reflect recent claims or changes. Next snapshot will be captured at epoch end.</p>
                     </div>
                 </div>
             </div>
             
             <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                 <!-- Deposit Rewards -->
                 <div id="deposit-rewards-section" class="bg-gray-800/50 p-4 rounded-lg cursor-pointer hover:bg-gray-700/50 transition-colors group">
                     <div class="flex justify-between items-start mb-2">
                         <h4 class="text-sm font-bold text-green-400"><i class="fas fa-piggy-bank mr-1"></i> Deposit Rewards</h4>
                         <i class="fas fa-info-circle text-gray-500 group-hover:text-cyan-400 text-xs"></i>
                     </div>
                     <p id="deposit-usd-value" class="text-xl font-bold text-white">--</p>
                     <p id="deposit-ampluna-value" class="text-sm text-gray-400">-- ampLUNA</p>
                     <div class="mt-2 pt-2 border-t border-gray-700">
                         <p class="text-xs text-gray-500">Last: <span id="deposit-last-claim" class="text-gray-400">A-28 (Dec 17)</span></p>
                     </div>
                 </div>
                 
                 <!-- Vote Rewards -->
                 <div id="vote-rewards-section" class="bg-gray-800/50 p-4 rounded-lg cursor-pointer hover:bg-gray-700/50 transition-colors group">
                     <div class="flex justify-between items-start mb-2">
                         <h4 class="text-sm font-bold text-orange-400"><i class="fas fa-vote-yea mr-1"></i> Vote Rewards</h4>
                         <i class="fas fa-info-circle text-gray-500 group-hover:text-cyan-400 text-xs"></i>
                     </div>
                     <p id="vote-token-count" class="text-xl font-bold text-white">-- tokens</p>
                     <p id="vote-epochs-count" class="text-sm text-orange-400">-- epochs unclaimed</p>
                     <div class="mt-2 pt-2 border-t border-gray-700">
                         <p class="text-xs text-gray-500">Last: <span id="vote-last-claim" class="text-gray-400">A-29 (Dec 17)</span></p>
                     </div>
                 </div>
                 
                 <!-- Rebase -->
                 <div id="rebase-rewards-section" class="bg-gray-800/50 p-4 rounded-lg cursor-pointer hover:bg-gray-700/50 transition-colors group">
                     <div class="flex justify-between items-start mb-2">
                         <h4 class="text-sm font-bold text-cyan-400"><i class="fas fa-sync-alt mr-1"></i> Rebase</h4>
                         <i class="fas fa-info-circle text-gray-500 group-hover:text-cyan-400 text-xs"></i>
                     </div>
                     <p id="rebase-ampluna-value" class="text-xl font-bold text-white">--</p>
                     <p id="rebase-usd-value" class="text-sm text-gray-400">-- USD</p>
                     <div class="mt-2 pt-2 border-t border-gray-700">
                         <p class="text-xs text-gray-500">Last: <span id="rebase-last-claim" class="text-gray-400">A-26 (Sep 7)</span></p>
                     </div>
                 </div>
             </div>
             
             <!-- Lock Status Summary -->
             <div class="mt-4 pt-4 border-t border-gray-700 flex justify-between items-center">
                 <div class="text-sm">
                     <span class="text-gray-500">Locks:</span>
                     <span class="text-white ml-2">#600 (arbLUNA) + #711 (ampLUNA)</span>
                     <span class="text-cyan-400 ml-2">638.9K VP</span>
                 </div>
                 <button id="view-full-details-btn" class="text-xs bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-1 rounded transition-colors">
                     View Full Details
                 </button>
             </div>
        </div>

        <div class="grid grid-cols-2 md:grid-cols-4 gap-6 mb-8">
            <div id="daodao-staked-card" class="stat-card p-6 rounded-xl text-center cursor-pointer group">
                <div>
                    <h3 id="daodao-staked-title" class="text-md font-medium text-gray-400 flex justify-center items-center gap-2 group-hover:text-teal-400">DAODAO Staked</h3>
                    <p id="daodao-staked" class="text-3xl font-bold text-white mt-2"><i class="fas fa-spinner fa-spin text-cyan-400 text-2xl"></i></p>
                    <p id="daodao-staked-percentage" class="text-base font-semibold text-cyan-400 mt-1">&nbsp;</p>
                </div>
                <p class="subtext text-xs font-semibold mt-1 text-gray-500">Click to see details</p>
            </div>
            <div id="enterprise-staked-card" class="stat-card p-6 rounded-xl text-center cursor-pointer group">
                <div>
                    <h3 id="enterprise-staked-title" class="text-md font-medium text-gray-400 flex justify-center items-center gap-2 group-hover:text-teal-400">Enterprise Staked</h3>
                    <p id="enterprise-staked-holder" class="text-3xl font-bold text-white mt-2"><i class="fas fa-spinner fa-spin text-cyan-400 text-2xl"></i></p>
                </div>
                <p class="subtext text-xs font-semibold mt-1 text-gray-500">Click to see details</p>
            </div>
            <a href="https://daodao.zone/dao/terra1sffd4efk2jpdt894r04qwmtjqrrjfc52tmj6vkzjxqhd8qqu2drs3m5vzm/members" target="_blank" rel="noopener noreferrer" class="stat-card p-6 rounded-xl text-center group dao-members-link">
                <div>
                    <h3 id="dao-members-title" class="text-md font-medium text-gray-400 flex justify-center items-center gap-2">DAO Members</h3>
                    <p id="dao-members" class="text-3xl font-bold text-white mt-2"><i class="fas fa-spinner fa-spin text-cyan-400 text-2xl"></i></p>
                </div>
                 <p class="subtext text-xs font-semibold mt-1 text-gray-500">Click link to site</p>
            </a>
            <div id="dao-broken-card" class="stat-card p-6 rounded-xl text-center cursor-pointer group">
                 <div>
                    <h3 class="text-md font-medium text-gray-400 group-hover:text-teal-400">DAO Broken/Held NFTs</h3>
                    <p id="dao-broken-total" class="text-3xl font-bold text-white mt-2">1,000</p>
                </div>
                 <p class="subtext text-xs font-semibold mt-1 text-gray-500">Click to see details</p>
            </div>
            <div id="dao-treasury-card" class="stat-card p-6 rounded-xl text-center cursor-pointer group">
                <div>
                    <h3 id="dao-treasury-title" class="text-md font-medium text-gray-400 group-hover:text-teal-400 flex justify-center items-center gap-2">DAO Treasury</h3>
                    <p id="dao-treasury-total" class="text-3xl font-bold text-white mt-2"><i class="fas fa-spinner fa-spin text-cyan-400 text-2xl"></i></p>
                </div>
                <p class="subtext text-xs font-semibold mt-1 text-gray-500">Click to see details</p>
            </div>
             <div id="dao-tla-card" class="stat-card p-6 rounded-xl text-center cursor-pointer group">
                <div>
                    <h3 id="dao-tla-title" class="text-md font-medium text-gray-400 group-hover:text-teal-400 flex justify-center items-center gap-2">DAO TLA Deposits</h3>
                    <p id="dao-tla-total" class="text-3xl font-bold text-white mt-2"><i class="fas fa-spinner fa-spin text-cyan-400 text-2xl"></i></p>
                    <p id="dao-tla-apr" class="text-base font-semibold text-gray-300"><i class="fas fa-spinner fa-spin text-gray-300"></i></p>
                </div>
                 <p class="subtext text-xs font-semibold mt-1 text-gray-500">Click to see details</p>
            </div>
             <div id="dao-tla-vp-card" class="stat-card p-6 rounded-xl text-center cursor-pointer group">
                 <div>
                    <h3 id="dao-tla-vp-title" class="text-md font-medium text-gray-400 group-hover:text-teal-400 flex justify-center items-center gap-2">DAO TLA VP</h3>
                    <p id="dao-tla-vp" class="text-xl font-bold text-white mt-2"><i class="fas fa-spinner fa-spin text-cyan-400 text-xl"></i></p>
                    <p id="dao-tla-vp-usd" class="text-base font-semibold text-gray-300"><i class="fas fa-spinner fa-spin text-gray-300"></i></p>
                </div>
                 <p class="subtext text-xs font-semibold mt-1 text-gray-500">Click to see details</p>
            </div>
            <div id="unminted-backing-card" class="stat-card p-6 rounded-xl text-center cursor-pointer group">
                 <div>
                    <h3 id="unminted-nft-backing-title" class="text-md font-medium text-gray-400 group-hover:text-teal-400 flex justify-center items-center gap-2">Unminted NFT Backing</h3>
                    <p id="unminted-nft-backing-luna" class="text-xl font-bold text-white mt-2"><i class="fas fa-spinner fa-spin text-cyan-400 text-xl"></i></p>
                    <p id="unminted-nft-backing-usd" class="text-base font-semibold text-gray-300"><i class="fas fa-spinner fa-spin text-gray-300"></i></p>
                </div>
                 <p class="subtext text-xs font-semibold mt-1 text-gray-500">Click to see details</p>
            </div>

            <div class="stat-card p-6 rounded-xl text-center">
                <div>
                    <h3 id="backing-ampluna-title" class="text-md font-medium text-gray-400 flex justify-center items-center gap-2">Backing in ampLUNA</h3>
                    <div class="flex justify-center items-center gap-2 mt-2">
                        <p id="backing-per-nft-ampluna" class="text-3xl font-bold text-white"><i class="fas fa-spinner fa-spin text-cyan-400 text-2xl"></i></p>
                         <img src="https://raw.githubusercontent.com/defipatriot/aDAO-Image-Files/main/ampLuna.webp?raw=true" alt="ampLUNA" class="h-8 w-8" onerror="this.src='https://placehold.co/32x32/1f2937/EAEAEA?text=AL'; this.onerror=null;">
                    </div>
                </div>
                 <p id="backing-per-nft-change" class="subtext text-xs font-semibold mt-1 text-gray-500"><i class="fas fa-spinner fa-spin text-gray-500"></i></p>
            </div>
            <div class="stat-card p-6 rounded-xl text-center">
                <div>
                    <h3 id="backing-luna-live-title" class="text-md font-medium text-gray-400 flex justify-center items-center gap-2">Backing in LUNA</h3>
                    <div class="flex justify-center items-center gap-2 mt-2">
                        <p id="backing-per-nft-luna-live" class="text-3xl font-bold text-white"><i class="fas fa-spinner fa-spin text-cyan-400 text-2xl"></i></p>
                         <img src="https://raw.githubusercontent.com/defipatriot/aDAO-Image-Files/main/Luna.webp?raw=true" alt="LUNA" class="h-8 w-8" onerror="this.src='https://placehold.co/32x32/1f2937/EAEAEA?text=L'; this.onerror=null;">
                    </div>
                </div>
                <p id="live-ampluna-price-luna" class="subtext text-xs font-semibold mt-1 text-gray-500">&nbsp;</p> </div>
            <div class="stat-card p-6 rounded-xl text-center">
                <div>
                    <h3 id="backing-usd-title" class="text-md font-medium text-gray-400 flex justify-center items-center gap-2">Backing in USD</h3>
                    <p id="backing-per-nft-usd" class="text-3xl font-bold text-white mt-2"><i class="fas fa-spinner fa-spin text-cyan-400 text-2xl"></i></p>
                </div>
                <p id="live-luna-price" class="subtext text-xs font-semibold mt-1 text-gray-500"><i class="fas fa-spinner fa-spin text-gray-500"></i></p>
            </div>
            <div class="stat-card p-6 rounded-xl text-center">
                 <div>
                    <h3 id="avg-daily-gain-title" class="text-md font-medium text-gray-400 flex justify-center items-center gap-2">Avg Daily Gain Per NFT</h3>
                    <p id="avg-daily-gain" class="text-3xl font-bold text-white mt-2"><i class="fas fa-spinner fa-spin text-cyan-400 text-2xl"></i></p>
                </div>
                <p id="avg-daily-gain-subtext" class="subtext text-xs font-semibold mt-1 text-gray-500"><i class="fas fa-spinner fa-spin text-gray-500"></i></p>
            </div>
        </div>

        <!-- NFT Marketplace Section -->
        <div class="mt-8">
            <h2 class="text-xl font-bold text-white mb-6 flex items-center gap-3">
                <i class="fas fa-store text-cyan-400"></i>
                NFT Marketplace Activity
            </h2>
            
            <!-- Floor Prices & Volume Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <!-- BBL Marketplace -->
                <div class="marketplace-section">
                    <div class="marketplace-header">
                        <img src="https://raw.githubusercontent.com/defipatriot/aDAO-Image-Files/main/BBL%20No%20Background.png" alt="BBL" onerror="this.style.display='none'">
                        <h3>BBL Marketplace</h3>
                        <a href="https://app.backbonelabs.io/nfts/marketplace/collections/terra1phr9fngjv7a8an4dhmhd0u0f98wazxfnzccqtyheq4zqrrp4fpuqw3apw9" target="_blank" class="text-xs text-gray-500 hover:text-cyan-400 ml-auto">
                            <i class="fas fa-external-link-alt mr-1"></i>View
                        </a>
                    </div>
                    
                    <!-- Stats -->
                    <div class="bg-gray-800/50 rounded-lg p-3">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400 text-sm">All-Time Volume</span>
                            <div class="text-right">
                                <span id="bbl-volume-bluna" class="text-cyan-400 font-mono font-bold">--</span>
                                <span class="text-gray-500 text-xs ml-1">bLUNA</span>
                                <span id="bbl-volume-usd" class="text-green-400 text-xs ml-2">--</span>
                            </div>
                        </div>
                        <div class="flex justify-between items-center mt-2">
                            <span class="text-gray-400 text-sm">Total Sales</span>
                            <span id="bbl-total-sales" class="text-gray-400 text-sm">--</span>
                        </div>
                        <div class="flex justify-between items-center mt-2 pt-2 border-t border-gray-700">
                            <span class="text-gray-400 text-sm">Currently Listed</span>
                            <button id="bbl-listed-btn" class="text-cyan-400 text-sm hover:text-cyan-300 cursor-pointer font-bold">
                                <span id="bbl-listed-count">--</span> NFTs <i class="fas fa-chevron-right text-xs ml-1"></i>
                            </button>
                        </div>
                    </div>
                    <div class="text-[10px] text-gray-600 mt-2 text-center">
                        <i class="fas fa-database mr-1"></i>Listings from deving.zone (updated every 6 hours)
                    </div>
                </div>
                
                <!-- Boost Marketplace -->
                <div class="marketplace-section">
                    <div class="marketplace-header">
                        <img src="https://raw.githubusercontent.com/defipatriot/aDAO-Image-Files/main/Boost%20Logo.png" alt="Boost" onerror="this.style.display='none'">
                        <h3>Boost Marketplace</h3>
                        <a href="https://www.boostdao.io/ignite/permissionless-terra" target="_blank" class="text-xs text-gray-500 hover:text-cyan-400 ml-auto">
                            <i class="fas fa-external-link-alt mr-1"></i>View
                        </a>
                    </div>
                    
                    <!-- Stats -->
                    <div class="bg-gray-800/50 rounded-lg p-3">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400 text-sm">All-Time Volume</span>
                            <div class="text-right">
                                <span id="boost-volume-usd" class="text-green-400 font-mono font-bold">--</span>
                                <span class="text-gray-500 text-xs ml-1">USD</span>
                            </div>
                        </div>
                        <div class="flex justify-between items-center mt-2">
                            <span class="text-gray-400 text-sm">Total Sales</span>
                            <span id="boost-total-sales" class="text-gray-400 text-sm">--</span>
                        </div>
                        <div class="flex justify-between items-center mt-2 pt-2 border-t border-gray-700">
                            <span class="text-gray-400 text-sm">Currently Listed</span>
                            <span id="boost-listed-count" class="text-gray-400 text-sm">-- NFTs</span>
                        </div>
                    </div>
                    <div class="text-[10px] text-gray-600 mt-2 text-center">
                        <i class="fas fa-database mr-1"></i>Listings from deving.zone (updated every 6 hours)
                    </div>
                </div>
            </div>
            
            <!-- Recent Sales Section -->
            <div class="marketplace-section mb-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-bold text-white flex items-center gap-2">
                        <i class="fas fa-receipt text-green-400"></i>
                        Recent Sales
                    </h3>
                    <div class="flex gap-2">
                        <button id="sales-filter-all" class="text-xs px-3 py-1 rounded bg-cyan-600 text-white">All</button>
                        <button id="sales-filter-bbl" class="text-xs px-3 py-1 rounded bg-gray-700 text-gray-300 hover:bg-gray-600">BBL</button>
                        <button id="sales-filter-boost" class="text-xs px-3 py-1 rounded bg-gray-700 text-gray-300 hover:bg-gray-600">Boost</button>
                    </div>
                </div>
                <div id="recent-sales-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                    <div class="text-gray-500 text-sm text-center py-8 col-span-full"><i class="fas fa-spinner fa-spin"></i> Loading sales history...</div>
                </div>
                <div class="text-center mt-4">
                    <button id="load-more-sales" class="text-xs text-cyan-400 hover:text-cyan-300 hidden">
                        <i class="fas fa-chevron-down mr-1"></i> Show More Sales
                    </button>
                </div>
                <div class="text-[10px] text-gray-600 mt-2 text-center">
                    *"Now Broken" = NFT is currently broken; may not have been broken at time of sale
                </div>
            </div>
            
            <!-- Top 10 All Time Sales -->
            <div class="text-center">
                <button id="top10-sales-btn" class="top10-btn mx-auto">
                    <i class="fas fa-trophy"></i>
                    Top 10 All-Time Sales
                    <i class="fas fa-chevron-right text-sm"></i>
                </button>
            </div>
        </div>

       </main>

    
    <div id="daodaoModal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div class="modal-content bg-[#1a1a1a] border border-gray-700 rounded-xl shadow-xl w-full max-w-3xl relative text-white opacity-0 scale-95 p-8 flex flex-col"> <button class="modal-close absolute top-4 right-4 text-gray-400 hover:text-white text-3xl">&times;</button>
            <h3 class="text-2xl font-bold text-cyan-400 mb-4 flex-shrink-0">DAODAO Staking & Supply Details</h3> <div id="supply-breakdown" class="grid grid-cols-2 gap-x-8 gap-y-4 mb-6 p-4 bg-gray-800/50 rounded-lg border border-gray-700 text-sm flex-shrink-0"> <div class="flex justify-between border-b border-gray-600 pb-2">
                    <span class="text-gray-400">Total Minted:</span>
                    <span id="supply-minted" class="font-bold text-white"><i class="fas fa-spinner fa-spin"></i></span>
                </div>
                <div class="flex justify-between border-b border-gray-600 pb-2">
                    <span class="text-gray-400">DAO Controlled (Broken):</span>
                    <span id="supply-dao-controlled" class="font-bold text-white">1,000</span>
                </div>
                 <div class="col-span-2 border-t border-gray-700 my-2"></div>
                <div class="flex justify-between">
                    <span class="text-gray-400">Circulating Supply:</span>
                    <span id="supply-circulating" class="font-bold text-cyan-400"><i class="fas fa-spinner fa-spin"></i></span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-400">Liquid Supply:</span>
                    <span id="supply-liquid" class="font-bold text-green-400"><i class="fas fa-spinner fa-spin"></i></span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-400">DAODAO Staked:</span>
                    <span id="supply-daodao-staked" class="font-bold text-white"><i class="fas fa-spinner fa-spin"></i></span>
                </div>
                 <div class="flex justify-between">
                    <span class="text-gray-400">Enterprise Staked:</span>
                    <span id="supply-enterprise-staked" class="font-bold text-white"><i class="fas fa-spinner fa-spin"></i></span>
                </div>
            </div>

             <div class="border-t border-gray-700 pt-4 mt-4 flex flex-col min-h-0">
                <h4 class="font-bold text-lg text-white mb-2 flex-shrink-0">Top DAODAO Stakers (<span id="daodao-modal-holder-count"><i class="fas fa-spinner fa-spin"></i></span> NFTs)</h4>

                <div class="bg-gray-900 rounded-t-lg px-4 pt-2 pb-1">
                    <table class="w-full text-left text-sm">
                        <thead>
                            <tr>
                                <th class="p-2 w-3/4">Wallet Address</th>
                                <th class="p-2 w-1/4 text-right">NFTs Staked</th>
                            </tr>
                        </thead>
                    </table>
                </div>

                <div class="overflow-y-auto max-h-64 bg-gray-800/50 rounded-b-lg">
                    <div id="daodao-stakers-table" class="px-4 pb-2"> <div class="text-center p-4"><i class="fas fa-spinner fa-spin text-cyan-400 text-2xl"></i></div> </div>
                </div>
            </div>
        </div>
    </div>

    <div id="enterpriseModal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div class="modal-content bg-[#1a1a1a] border border-gray-700 rounded-xl shadow-xl w-full max-w-3xl relative text-white opacity-0 scale-95 p-8 flex flex-col"> <button class="modal-close absolute top-4 right-4 text-gray-400 hover:text-white text-3xl">&times;</button>
            <h3 class="text-2xl font-bold text-cyan-400 mb-4 flex-shrink-0">Enterprise Staking Details</h3> <div class="space-y-4 text-gray-300 flex flex-col min-h-0"> <div class="bg-blue-900/30 border border-blue-700 p-3 rounded-lg flex-shrink-0"> <p class="font-bold text-lg text-white">Action Required: Migrate Your NFTs</p>
                    <p>The Alliance DAO has officially migrated its governance from Enterprise to DAODAO. Any members who have not yet migrated their NFTs must do so to participate in governance proposals, promotions, and future DAO-distributed rewards.</p>
                </div>
                <a href="tutorials.html" class="inline-block bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg transition-colors mt-2 flex-shrink-0">View Migration Tutorial &rarr;</a> <div class="border-t border-gray-700 pt-4 mt-4 flex flex-col min-h-0">
                    <h4 class="font-bold text-lg text-white mb-2 flex-shrink-0">Holder Staking on Enterprise (<span id="enterprise-modal-holder-count"><i class="fas fa-spinner fa-spin"></i></span> NFTs)</h4>

                    <div class="bg-gray-900 rounded-t-lg px-4 pt-2 pb-1">
                        <table class="w-full text-left text-sm">
                            <thead>
                                <tr>
                                    <th class="p-2 w-3/4">Wallet Address</th>
                                    <th class="p-2 w-1/4 text-right">NFTs Staked</th>
                                </tr>
                            </thead>
                        </table>
                    </div>

                    <div class="overflow-y-auto max-h-64 bg-gray-800/50 rounded-b-lg">
                        <div id="enterprise-stakers-table" class="px-4 pb-2"> <div class="text-center p-4"><i class="fas fa-spinner fa-spin text-cyan-400 text-2xl"></i></div> </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="daoBrokenModal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden opacity-0">
         <div class="modal-content bg-[#1a1a1a] border border-gray-700 rounded-xl shadow-xl w-full max-w-2xl relative text-white opacity-0 scale-95 p-8">
            <button class="modal-close absolute top-4 right-4 text-gray-400 hover:text-white text-3xl">&times;</button>
            <h3 class="text-2xl font-bold text-cyan-400 mb-4">DAO Broken/Held NFTs</h3>
            <div class="space-y-4 text-gray-300">
                <p>The DAO currently holds 1,000 broken NFTs which are used for various purposes including liquidity and strategic reserves. These are held across three separate DAO wallets:</p>
                <ul class="list-disc list-inside space-y-2 bg-gray-800/50 p-4 rounded-lg">
                    <li><strong class="text-yellow-400">900 NFTs (Liquid):</strong> Held in two wallets, available for liquidity purposes.
                        <ul class="list-circle list-inside ml-6 text-sm">
                            <li>Wallet ending in: ...8ywv</li>
                            <li>Wallet ending in: ...417v</li>
                        </ul>
                    </li>
                    <li><strong class="text-green-400">100 NFTs (Staked):</strong> Held in the Enterprise staking wallet.
                         <ul class="list-circle list-inside ml-6 text-sm">
                             <li>Wallet ending in: ...6ugw</li>
                         </ul>
                    </li>
                </ul>
            </div>
        </div>
    </div>
    
    <div id="unmintedModal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden opacity-0">
         <div class="modal-content bg-[#1a1a1a] border border-gray-700 rounded-xl shadow-xl w-full max-w-3xl relative text-white opacity-0 scale-95 p-8 max-h-[90vh] overflow-y-auto">
            <button class="modal-close absolute top-4 right-4 text-gray-400 hover:text-white text-3xl">&times;</button>
            <h3 class="text-2xl font-bold text-cyan-400 mb-4">Unminted NFT Value Calculator</h3>
            <div class="space-y-4 text-gray-300">
                <p>This tool calculates the potential value of DAO-held unminted NFTs. The <strong class="text-yellow-300">baseline backing</strong> shows the worst-case value, while the <strong class="text-green-400">market value</strong> calculator shows potential value based on floor prices.</p>
                
                <!-- Baseline Backing Calculation -->
                <div class="bg-gray-800/50 p-4 rounded-lg">
                    <h4 class="text-lg font-bold text-yellow-400 mb-3"><i class="fas fa-shield-alt mr-2"></i>Baseline Backing Value</h4>
                    <p class="text-sm text-gray-400 mb-2">Minimum value based on liquid backing (worst-case scenario)</p>
                    <div class="grid grid-cols-2 gap-4 text-center">
                        <div>
                            <p class="text-sm text-gray-400">LUNA Value</p>
                            <p class="text-lg font-mono">
                                <span id="unminted-modal-count" class="text-white">--</span>  <span id="unminted-modal-backing-luna" class="text-white">--</span>
                            </p>
                            <p class="text-xl font-bold text-yellow-400" id="unminted-modal-total-luna">-- LUNA</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-400">USD Value</p>
                            <p class="text-lg font-mono">
                                <span id="unminted-modal-count-2" class="text-white">--</span>  $<span id="unminted-modal-backing-usd" class="text-white">--</span>
                            </p>
                            <p class="text-xl font-bold text-yellow-400" id="unminted-modal-total-usd">-- USD</p>
                        </div>
                    </div>
                </div>
                
                <!-- Market Value Calculator -->
                <div class="bg-green-900/20 border border-green-700 p-4 rounded-lg">
                    <h4 class="text-lg font-bold text-green-400 mb-3"><i class="fas fa-chart-line mr-2"></i>Market Value Calculator</h4>
                    <p class="text-sm text-gray-400 mb-3">Estimate value based on floor price (check marketplaces below for current prices)</p>
                    
                    <!-- Row 1: Floor Price Input -->
                    <div class="mb-4">
                        <label class="block text-sm text-gray-400 mb-2">Floor Price</label>
                        <div class="flex gap-2">
                            <input type="number" id="unminted-floor-price" class="flex-1 bg-gray-800 border border-gray-600 rounded px-3 py-2 text-white focus:border-green-400 focus:outline-none" placeholder="Enter floor price" step="0.01" oninput="calculateUnmintedMarketValue()">
                            <select id="unminted-price-token" class="bg-gray-800 border border-gray-600 rounded px-3 py-2 text-white focus:border-green-400 focus:outline-none" onchange="calculateUnmintedMarketValue()">
                                <option value="bLUNA">bLUNA</option>
                                <option value="LUNA">LUNA</option>
                                <option value="ampLUNA">ampLUNA</option>
                                <option value="arbLUNA">arbLUNA</option>
                                <option value="USD">USD</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Row 2: Discount Slider -->
                    <div class="mb-4">
                        <label class="block text-sm text-gray-400 mb-2">Discount for Fast/Mass Sale: <span id="unminted-discount-value" class="text-green-400 font-bold">0%</span></label>
                        <input type="range" id="unminted-discount-slider" min="0" max="50" value="0" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-green-500" oninput="updateUnmintedDiscount()">
                        <div class="flex justify-between text-xs text-gray-500 mt-1">
                            <span>0%</span>
                            <span>25%</span>
                            <span>50%</span>
                        </div>
                    </div>
                    
                    <!-- Row 3: NFT Type Selection -->
                    <div class="mb-4">
                        <label class="block text-sm text-gray-400 mb-2">NFT Type</label>
                        <div class="flex gap-2">
                            <button id="nft-type-unbroken" onclick="setNftType('unbroken')" class="flex-1 px-3 py-2 rounded bg-green-600 text-white text-sm font-medium transition-colors">
                                Unbroken (Full NFT)
                            </button>
                            <button id="nft-type-broken" onclick="setNftType('broken')" class="flex-1 px-3 py-2 rounded bg-gray-700 text-gray-400 text-sm font-medium transition-colors hover:bg-gray-600">
                                Broken (VP Only)
                            </button>
                        </div>
                        <p id="nft-type-description" class="text-xs text-gray-500 mt-1">Selling complete NFTs with art, backing, and VP</p>
                    </div>
                    
                    <!-- Calculated Market Value -->
                    <div id="unminted-market-result" class="bg-gray-800/50 p-4 rounded-lg hidden">
                        <div class="grid grid-cols-5 gap-2 text-center">
                            <div>
                                <p class="text-xs text-gray-400">Eff. Price</p>
                                <p id="unminted-effective-price" class="text-lg font-bold text-white">--</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-400">Backing</p>
                                <p id="unminted-backing-portion" class="text-lg font-bold text-yellow-400">--</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-400">Premium</p>
                                <p id="unminted-premium-portion" class="text-lg font-bold text-green-400">--</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-400">Total Value</p>
                                <p id="unminted-market-value" class="text-xl font-bold text-green-400">--</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-400">vs Backing</p>
                                <p id="unminted-vs-backing" class="text-lg font-bold text-cyan-400">--</p>
                            </div>
                        </div>
                        <p id="unminted-nft-count" class="text-center text-xs text-gray-500 mt-2">5,828 unminted NFTs</p>
                        
                        <!-- Treasury Impact Summary -->
                        <div id="unminted-treasury-impact" class="mt-4 pt-4 border-t border-gray-700">
                            <h5 class="text-sm font-bold text-cyan-400 mb-3"><i class="fas fa-landmark mr-1"></i>DAO Holdings + Unminted Value</h5>
                            
                            <!-- Current Holdings Breakdown -->
                            <div class="bg-gray-900/50 rounded-lg p-3 mb-3">
                                <p class="text-xs text-gray-400 mb-2">Current DAO Holdings (excl. NFTs)</p>
                                <div class="space-y-1 text-xs">
                                    <div class="flex justify-between">
                                        <span class="text-gray-500"><i class="fas fa-check-circle text-green-500 mr-1"></i>Treasury (Live)</span>
                                        <span id="unminted-treasury-live" class="font-mono text-white">--</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-500"><i class="fas fa-check-circle text-green-500 mr-1"></i>TLA Locks (Live)</span>
                                        <span id="unminted-locks-live" class="font-mono text-white">--</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span id="unminted-deposits-status" class="text-gray-500"><i class="fas fa-clock text-yellow-500 mr-1"></i>TLA Deposits (Snapshot)</span>
                                        <span id="unminted-deposits-value" class="font-mono text-white">--</span>
                                    </div>
                                    <div class="flex justify-between border-t border-gray-700 pt-1 mt-1">
                                        <span class="text-gray-400 font-medium">Total Holdings</span>
                                        <span id="unminted-current-treasury" class="font-mono font-bold text-white">--</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Potential with Unminted -->
                            <div class="grid grid-cols-2 gap-3 text-center">
                                <div class="bg-gray-900/50 rounded-lg p-3">
                                    <p class="text-xs text-gray-500">+ Unminted NFT Value</p>
                                    <p id="unminted-add-value" class="text-lg font-bold text-green-400">--</p>
                                </div>
                                <div class="bg-green-900/30 rounded-lg p-3 border border-green-600/30">
                                    <p class="text-xs text-gray-400">Potential Total</p>
                                    <p id="unminted-potential-total" class="text-xl font-bold text-green-300">--</p>
                                </div>
                            </div>
                            <p class="text-xs text-gray-600 mt-2 text-center">If DAO sold all unminted NFTs at this price</p>
                        </div>
                    </div>
                    </div>
                </div>
                
                <!-- Info Note -->
                <div class="bg-yellow-900/30 border border-yellow-700 p-3 rounded-lg text-sm">
                    <p><strong class="text-yellow-300">Note:</strong> Market value does not factor in DAO Voting Power (VP), staking rewards, or governance participation value. Even broken NFTs trade significantly above their liquid backing.</p>
                </div>
                
                <!-- Marketplace Links -->
                <div class="bg-gray-800/50 p-4 rounded-lg">
                    <h4 class="text-sm font-bold text-gray-400 mb-3"><i class="fas fa-store mr-2"></i>Find Floor Prices</h4>
                    <div class="flex flex-wrap gap-3">
                        <a href="https://app.backbonelabs.io/nfts/marketplace/collections/terra1phr9fngjv7a8an4dhmhd0u0f98wazxfnzccqtyheq4zqrrp4fpuqw3apw9" target="_blank" rel="noopener noreferrer" class="flex items-center gap-2 bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-lg transition-colors">
                            <img src="https://app.backbonelabs.io/favicon.ico" alt="Backbone" class="w-5 h-5 rounded" onerror="this.style.display='none'">
                            <span>Backbone Labs</span>
                            <i class="fas fa-external-link-alt text-xs text-gray-400"></i>
                        </a>
                        <a href="https://www.boostdao.io/ignite/permissionless-terra" target="_blank" rel="noopener noreferrer" class="flex items-center gap-2 bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-lg transition-colors">
                            <img src="https://www.boostdao.io/favicon.ico" alt="Boost" class="w-5 h-5 rounded" onerror="this.style.display='none'">
                            <span>Boost DAO</span>
                            <i class="fas fa-external-link-alt text-xs text-gray-400"></i>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="treasuryModal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div class="modal-content bg-[#1a1a1a] border border-gray-700 rounded-xl shadow-xl w-full max-w-2xl relative text-white opacity-0 scale-95 p-8">
            <button class="modal-close absolute top-4 right-4 text-gray-400 hover:text-white text-3xl">&times;</button>
            <h3 class="text-2xl font-bold text-cyan-400 mb-4">DAO Treasury Details</h3>
            <div id="treasury-table-container" class="max-h-96 overflow-y-auto">
                 <div class="text-center p-4"><i class="fas fa-spinner fa-spin text-cyan-400 text-2xl"></i></div> </div>
            <a href="https://daodao.zone/dao/terra1sffd4efk2jpdt894r04qwmtjqrrjfc52tmj6vkzjxqhd8qqu2drs3m5vzm/treasury?url=https%3A%2F%2Fwww.erisprotocol.com" target="_blank" rel="noopener noreferrer" class="inline-block mt-6 bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg transition-colors w-full text-center">
                View Treasury on DAODAO &rarr;
            </a>
        </div>
    </div>
    
    <div id="tlaModal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div class="modal-content bg-[#1a1a1a] border border-gray-700 rounded-xl shadow-xl w-full max-w-2xl relative text-white opacity-0 scale-95 p-8 overflow-y-auto">
            <button class="modal-close absolute top-4 right-4 text-gray-400 hover:text-white text-3xl">&times;</button>
            <h3 class="text-2xl font-bold text-cyan-400 mb-4">DAO TLA Deposit Details</h3>
            <div class="text-center bg-gray-800/50 p-4 rounded-lg mb-4">
                 <p class="text-lg">Total Deposit Value (Snapshot)</p>
                 <p class="text-2xl font-bold text-white" id="tla-deposit-total-usd"><i class="fas fa-spinner fa-spin text-white text-2xl"></i></p>
                 <p class="text-md text-cyan-400" id="tla-deposit-total-apr"><i class="fas fa-spinner fa-spin text-cyan-400"></i></p>
            </div>
            <div class="bg-yellow-900/30 border border-yellow-700 p-3 rounded-lg text-sm mb-4">
                <p><strong class="text-yellow-300">Disclaimer:</strong> This data is a snapshot from <span id="tla-snapshot-date">--</span>. Token values are calculated using live CoinGecko prices where available.</p>
            </div>
            <div>
                <h4 class="font-bold text-lg text-white mb-2 text-center">Underlying Tokens</h4>
                <div id="tla-tokens-container"> <div class="text-center p-4"><i class="fas fa-spinner fa-spin text-cyan-400 text-2xl"></i></div> </div>
            </div>
             <a href="https://daodao.zone/dao/terra1sffd4efk2jpdt894r04qwmtjqrrjfc52tmj6vkzjxqhd8qqu2drs3m5vzm/apps?url=https%3A%2F%2Fwww.erisprotocol.com" target="_blank" rel="noopener noreferrer" class="inline-block mt-6 bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg transition-colors w-full text-center">
                View Deposits on Eris Protocol &rarr;
            </a>
        </div>
    </div>

    <div id="tlaVpModal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div class="modal-content bg-[#1a1a1a] border border-gray-700 rounded-xl shadow-xl w-full max-w-5xl relative text-white opacity-0 scale-95 p-8 max-h-[90vh] overflow-y-auto">
            <button class="modal-close absolute top-4 right-4 text-gray-400 hover:text-white text-3xl">&times;</button>
            <h3 class="text-2xl font-bold text-cyan-400 mb-4">DAO TLA VP Details</h3>
            <div class="space-y-4 text-gray-300">
                
                <!-- VP Comparison Visual -->
                <div class="bg-gray-800/50 p-4 rounded-lg">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-center">
                        <!-- Current VP -->
                        <div class="text-center">
                            <p class="text-sm text-gray-400 mb-1">Current VP (Static)</p>
                            <p class="text-3xl font-bold text-white">638,880</p>
                            <p class="text-xs text-gray-500">Locked Sep 7, 2025</p>
                        </div>
                        
                        <!-- Arrow & Gain -->
                        <div class="text-center">
                            <div class="flex items-center justify-center gap-2">
                                <div class="h-px w-8 bg-gray-600 hidden md:block"></div>
                                <div class="bg-green-900/50 border border-green-600 rounded-lg px-4 py-2">
                                    <p class="text-xs text-green-400">If Adjusted Today</p>
                                    <p id="vp-potential-gain" class="text-xl font-bold text-green-400">+0 VP</p>
                                    <p id="vp-potential-gain-pct" class="text-xs text-green-300">+0%</p>
                                </div>
                                <div class="h-px w-8 bg-gray-600 hidden md:block"></div>
                            </div>
                        </div>
                        
                        <!-- Potential VP -->
                        <div class="text-center">
                            <p class="text-sm text-gray-400 mb-1">Potential VP</p>
                            <p id="vp-potential-total" class="text-3xl font-bold text-green-400">--</p>
                            <p class="text-xs text-gray-500">With current ratios</p>
                        </div>
                    </div>
                    
                    <!-- Visual Progress Bar -->
                    <div class="mt-4">
                        <div class="flex justify-between text-xs text-gray-500 mb-1">
                            <span>Current</span>
                            <span>Potential</span>
                        </div>
                        <div class="relative h-6 bg-gray-700 rounded-full overflow-hidden">
                            <!-- Current VP bar -->
                            <div id="vp-current-bar" class="absolute h-full bg-cyan-600 rounded-full transition-all duration-500" style="width: 100%"></div>
                            <!-- Potential VP bar (grows beyond) -->
                            <div id="vp-potential-bar" class="absolute h-full bg-green-500/30 border-r-2 border-green-400 rounded-full transition-all duration-500" style="width: 100%"></div>
                            <!-- Labels on bar -->
                            <div class="absolute inset-0 flex items-center justify-between px-3 text-xs font-bold">
                                <span class="text-white">638.9K</span>
                                <span id="vp-bar-potential" class="text-green-300">--</span>
                            </div>
                        </div>
                        <p class="text-xs text-gray-500 mt-2 text-center">
                            <i class="fas fa-info-circle mr-1"></i>
                            VP is recalculated when you add tokens to a lock. LST ratios increase over time from staking rewards.
                        </p>
                    </div>
                </div>
                
                <!-- Underlying Value -->
                <div class="bg-gray-800/50 p-4 rounded-lg">
                    <div class="grid grid-cols-2 gap-4 text-center">
                        <div>
                            <p class="text-sm text-gray-400">Live Underlying LUNA</p>
                            <p class="text-xl font-bold text-white" id="tla-vp-modal-luna"><i class="fas fa-spinner fa-spin text-white"></i></p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-400">USD Value</p>
                            <p class="text-xl font-bold text-cyan-400" id="tla-vp-modal-usd"><i class="fas fa-spinner fa-spin text-cyan-400"></i></p>
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mt-2 text-center">Last Adjusted: September 7th, 2025 (Prop A-26)</p>
                </div>
                
                <div id="tla-vp-locks-container">
                      <div class="text-center p-4"><i class="fas fa-spinner fa-spin text-cyan-400 text-2xl"></i></div> </div>
                
                <!-- Voting Allocation Section -->
                <div class="bg-gray-800/50 p-4 rounded-lg">
                    <h4 class="text-lg font-bold text-white mb-3"><i class="fas fa-vote-yea mr-2 text-cyan-400"></i>Current Vote Allocation by Bucket</h4>
                    <p class="text-xs text-gray-500 mb-4">TLA allows voting per bucket - each bucket can receive up to 100% of total VP</p>
                    
                    <!-- Bucket Summary -->
                    <div id="tla-bucket-summary" class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                        <div class="text-center p-2 rounded bg-blue-900/30 border border-blue-700">
                            <p class="text-xs text-blue-400">STABLE</p>
                            <p class="font-bold text-white" id="bucket-stable-pct">--</p>
                        </div>
                        <div class="text-center p-2 rounded bg-purple-900/30 border border-purple-700">
                            <p class="text-xs text-purple-400">PROJECT</p>
                            <p class="font-bold text-white" id="bucket-project-pct">--</p>
                        </div>
                        <div class="text-center p-2 rounded bg-yellow-900/30 border border-yellow-700">
                            <p class="text-xs text-yellow-400">BLUECHIP</p>
                            <p class="font-bold text-white" id="bucket-bluechip-pct">--</p>
                        </div>
                        <div class="text-center p-2 rounded bg-gray-700/50 border border-gray-600">
                            <p class="text-xs text-gray-400">SINGLE</p>
                            <p class="font-bold text-white" id="bucket-single-pct">--</p>
                        </div>
                    </div>
                    
                    <!-- Detailed Allocation -->
                    <div id="tla-vote-allocation" class="space-y-3 max-h-64 overflow-y-auto">
                        <div class="text-center p-4"><i class="fas fa-spinner fa-spin text-cyan-400"></i> Loading vote allocation...</div>
                    </div>
                </div>
                
                <a href="https://daodao.zone/dao/terra1sffd4efk2jpdt894r04qwmtjqrrjfc52tmj6vkzjxqhd8qqu2drs3m5vzm/apps?url=https%3A%2F%2Fwww.erisprotocol.com" target="_blank" rel="noopener noreferrer" class="inline-block mt-4 bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg transition-colors w-full text-center">
                    View Locks on Eris Protocol &rarr;
                </a>
            </div>
        </div>
    </div>

    <!-- Unclaimed Rewards Modal -->
    <div id="unclaimedRewardsModal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div class="modal-content bg-[#1a1a1a] border border-gray-700 rounded-xl shadow-xl w-full max-w-3xl relative text-white opacity-0 scale-95 p-8 max-h-[90vh] overflow-y-auto">
            <button class="modal-close absolute top-4 right-4 text-gray-400 hover:text-white text-3xl">&times;</button>
            <h3 class="text-2xl font-bold text-yellow-400 mb-4"><i class="fas fa-coins mr-2"></i>Unclaimed TLA Rewards</h3>
            
            <div class="space-y-4">
                <!-- Current Epoch + Stale Warning -->
                <div class="text-center text-sm text-gray-400">
                    Current Epoch: <span id="modal-current-epoch" class="text-cyan-400 font-bold">--</span>
                    <span id="modal-data-epoch" class="text-gray-500 ml-2"></span>
                </div>
                
                <!-- Stale Data Warning Banner in Modal -->
                <div id="modal-stale-banner" class="hidden bg-red-900/50 border border-red-500 rounded-lg p-3">
                    <div class="flex items-center gap-2 justify-center">
                        <i class="fas fa-exclamation-triangle text-red-400"></i>
                        <span class="text-sm text-red-300">Data is from epoch <span id="modal-stale-epoch">--</span>  rewards may have changed since then</span>
                    </div>
                </div>
                
                <!-- Rebase Rewards -->
                <div class="bg-gray-800/50 p-4 rounded-lg">
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="text-lg font-bold text-cyan-400"><i class="fas fa-sync-alt mr-2"></i>Rebase Rewards</h4>
                        <span class="text-xs text-gray-500">Last claimed: Sep 7, 2025 (A-26)</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">Unclaimed ampLUNA</span>
                        <span id="modal-unclaimed-rebase" class="text-xl font-bold text-white">--</span>
                    </div>
                </div>
                
                <!-- Deposit Rewards -->
                <div class="bg-gray-800/50 p-4 rounded-lg">
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="text-lg font-bold text-green-400"><i class="fas fa-piggy-bank mr-2"></i>Deposit Rewards</h4>
                        <span class="text-xs text-gray-500">Last claimed: Dec 17, 2025 (A-28)</span>
                    </div>
                    <div class="grid grid-cols-3 gap-4 text-center">
                        <div>
                            <p class="text-sm text-gray-400">ampLUNA</p>
                            <p id="modal-deposit-ampluna" class="text-lg font-bold text-white">--</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-400">Est. USD</p>
                            <p id="modal-deposit-usd" class="text-lg font-bold text-green-400">--</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-400">zAssets</p>
                            <p id="modal-deposit-zassets" class="text-lg font-bold text-purple-400">--</p>
                        </div>
                    </div>
                </div>
                
                <!-- Vote Rewards (Bribes) -->
                <div class="bg-gray-800/50 p-4 rounded-lg">
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="text-lg font-bold text-orange-400"><i class="fas fa-vote-yea mr-2"></i>Vote Rewards (Bribes)</h4>
                        <span id="modal-vote-epochs" class="text-xs text-gray-500">-- epochs</span>
                    </div>
                    <div id="modal-vote-rewards-list" class="space-y-1 text-sm max-h-32 overflow-y-auto">
                        <span class="text-gray-500">Loading...</span>
                    </div>
                </div>
                
                <!-- Lock Status -->
                <div class="bg-gray-800/50 p-4 rounded-lg">
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="text-lg font-bold text-white"><i class="fas fa-lock mr-2"></i>Lock Status</h4>
                        <span class="text-xs text-gray-500">Last adjusted: Sep 7, 2025 (A-26)</span>
                    </div>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between items-center py-2 border-b border-gray-700">
                            <span class="text-gray-400">Lock #600 (arbLUNA)</span>
                            <div class="text-right">
                                <span class="text-white font-mono">27,290</span>
                                <span class="text-gray-500 ml-2"> 631.57K VP</span>
                            </div>
                        </div>
                        <div class="flex justify-between items-center py-2 border-b border-gray-700">
                            <span class="text-gray-400">Lock #711 (ampLUNA)</span>
                            <div class="text-right">
                                <span class="text-white font-mono">413.03</span>
                                <span class="text-gray-500 ml-2"> 7.32K VP</span>
                            </div>
                        </div>
                        <div class="flex justify-between items-center py-2 text-cyan-400 font-bold">
                            <span>Total VP (Static)</span>
                            <span>638,890 VP</span>
                        </div>
                    </div>
                </div>
                
                <!-- Potential VP Gain -->
                <div id="potential-vp-gain" class="bg-green-900/30 border border-green-700 p-4 rounded-lg hidden">
                    <h4 class="text-lg font-bold text-green-400 mb-2"><i class="fas fa-bolt mr-2"></i>Potential VP Boost</h4>
                    <p class="text-sm text-gray-300">If locks were adjusted today (adding to existing locks), VP would increase due to LST ratio growth:</p>
                    <div class="mt-2 text-right">
                        <span class="text-green-400 font-bold text-xl" id="potential-vp-value">+XX,XXX VP</span>
                    </div>
                </div>
                
                <!-- Actions Summary -->
                <div class="bg-gray-900/50 p-4 rounded-lg text-sm">
                    <h4 class="font-bold text-gray-300 mb-2">Last Claim Actions (Prop A-26 - Sep 7, 2025)</h4>
                    <ul class="text-gray-500 space-y-1">
                        <li> Extended Lock #600 with +183.06 arbLUNA</li>
                        <li> Extended Lock #711 with +88.06 ampLUNA (from rebase)</li>
                        <li> Claimed TLA deposit rewards, vote bribes, rebase</li>
                        <li> Claimed LUNA staking rewards from LionDAO validator</li>
                    </ul>
                </div>
                
                <a href="https://daodao.zone/dao/terra1sffd4efk2jpdt894r04qwmtjqrrjfc52tmj6vkzjxqhd8qqu2drs3m5vzm/proposals" target="_blank" rel="noopener noreferrer" class="inline-block mt-4 bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg transition-colors w-full text-center">
                    View Proposals on DAODAO &rarr;
                </a>
            </div>
        </div>
    </div>

    <div id="logoModal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div class="modal-content bg-[#1a1a1a] border border-gray-700 rounded-xl shadow-xl w-full max-w-4xl relative text-white opacity-0 scale-95 p-8 text-center">
            <button class="modal-close absolute top-4 right-4 text-gray-400 hover:text-white text-3xl">&times;</button>
            <h2 class="text-3xl font-bold text-white mb-6">Project & Alliance Logos</h2>
            <div id="logo-library-container" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 text-center max-h-96 overflow-y-auto p-4">
                 <div class="text-center p-4 col-span-full"><i class="fas fa-spinner fa-spin text-cyan-400 text-2xl"></i></div> </div>
            <a href="https://github.com/defipatriot/aDAO-Image-Files" target="_blank" rel="noopener noreferrer" class="inline-block mt-6 bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition-all transform hover:scale-105">
                View Full Library on GitHub
            </a>
        </div>
    </div>

    <!-- Snapshot Modal -->
    <div id="snapshotModal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div class="modal-content bg-[#1a1a1a] border border-gray-700 rounded-xl shadow-xl w-full max-w-2xl relative text-white opacity-0 scale-95 p-8 max-h-[90vh] overflow-y-auto">
            <button class="modal-close absolute top-4 right-4 text-gray-400 hover:text-white text-3xl">&times;</button>
            <h2 class="text-2xl font-bold text-cyan-400 mb-4">Snapshot Manager</h2>
            
            <!-- Mode Toggle -->
            <div class="flex gap-2 mb-4">
                <button id="snapshot-mode-paste" onclick="setSnapshotMode('paste')" class="flex-1 px-3 py-2 rounded bg-cyan-600 text-white text-sm font-medium transition-colors">
                    <i class="fas fa-paste mr-1"></i>Paste from Eris
                </button>
                <button id="snapshot-mode-manual" onclick="setSnapshotMode('manual')" class="flex-1 px-3 py-2 rounded bg-gray-700 text-gray-400 text-sm font-medium transition-colors hover:bg-gray-600">
                    <i class="fas fa-keyboard mr-1"></i>Manual Entry
                </button>
            </div>
            
            <div class="space-y-6">
                <!-- PASTE MODE -->
                <div id="snapshot-paste-mode">
                    <!-- TLA Token Balances Input -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-300 mb-2">
                            TLA Token Balances <span class="text-gray-500">(paste tab-separated: TOKEN &lt;tab&gt; AMOUNT)</span>
                        </label>
                        <textarea id="tla-tokens-input" class="w-full h-40 bg-gray-800 border border-gray-600 rounded-lg p-3 text-white font-mono text-sm focus:border-cyan-400 focus:outline-none" placeholder="CAPA	290916.6598134378
LUNA	39155.8974720723
ROAR	1832769202.6573815
ampLUNA	12246.314451128243
ampCAPA	313947.96729
ampROAR	505786636.43734485
xASTRO	20607.544605"></textarea>
                    </div>
                    
                    <!-- TLA USD and APR Input -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-300 mb-2">
                            TLA Deposit Value & APR <span class="text-gray-500">(paste from Eris)</span>
                        </label>
                        <textarea id="tla-usd-input" class="w-full h-24 bg-gray-800 border border-gray-600 rounded-lg p-3 text-white font-mono text-sm focus:border-cyan-400 focus:outline-none" placeholder="Your deposit
14 765.85$
est. APR 58.53 %"></textarea>
                    </div>
                </div>
                
                <!-- MANUAL MODE -->
                <div id="snapshot-manual-mode" class="hidden">
                    <div class="bg-yellow-900/30 border border-yellow-700 p-3 rounded-lg text-sm mb-4">
                        <p><strong class="text-yellow-300"><i class="fas fa-exclamation-triangle mr-1"></i>Manual Mode:</strong> Use when Eris/DAODAO is unavailable. Enter values directly.</p>
                    </div>
                    
                    <!-- Manual TLA Deposit Value -->
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Total Deposit Value (USD)</label>
                            <input type="number" id="manual-deposit-usd" class="w-full bg-gray-800 border border-gray-600 rounded-lg p-3 text-white font-mono text-sm focus:border-cyan-400 focus:outline-none" placeholder="14765.85" step="0.01">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Est. APR (%)</label>
                            <input type="number" id="manual-apr" class="w-full bg-gray-800 border border-gray-600 rounded-lg p-3 text-white font-mono text-sm focus:border-cyan-400 focus:outline-none" placeholder="58.53" step="0.01">
                        </div>
                    </div>
                    
                    <!-- Manual Token Balances -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-300 mb-2">Token Balances</label>
                        <div class="grid grid-cols-2 gap-3">
                            <div class="flex items-center gap-2">
                                <span class="text-gray-400 w-20 text-sm">LUNA</span>
                                <input type="number" id="manual-token-LUNA" class="flex-1 bg-gray-800 border border-gray-600 rounded px-2 py-1.5 text-white font-mono text-sm focus:border-cyan-400 focus:outline-none" placeholder="39155.89" step="0.0001">
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-gray-400 w-20 text-sm">ampLUNA</span>
                                <input type="number" id="manual-token-ampLUNA" class="flex-1 bg-gray-800 border border-gray-600 rounded px-2 py-1.5 text-white font-mono text-sm focus:border-cyan-400 focus:outline-none" placeholder="12246.31" step="0.0001">
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-gray-400 w-20 text-sm">CAPA</span>
                                <input type="number" id="manual-token-CAPA" class="flex-1 bg-gray-800 border border-gray-600 rounded px-2 py-1.5 text-white font-mono text-sm focus:border-cyan-400 focus:outline-none" placeholder="290916.65" step="0.0001">
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-gray-400 w-20 text-sm">ampCAPA</span>
                                <input type="number" id="manual-token-ampCAPA" class="flex-1 bg-gray-800 border border-gray-600 rounded px-2 py-1.5 text-white font-mono text-sm focus:border-cyan-400 focus:outline-none" placeholder="313947.96" step="0.0001">
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-gray-400 w-20 text-sm">ROAR</span>
                                <input type="number" id="manual-token-ROAR" class="flex-1 bg-gray-800 border border-gray-600 rounded px-2 py-1.5 text-white font-mono text-sm focus:border-cyan-400 focus:outline-none" placeholder="1832769202" step="0.0001">
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-gray-400 w-20 text-sm">ampROAR</span>
                                <input type="number" id="manual-token-ampROAR" class="flex-1 bg-gray-800 border border-gray-600 rounded px-2 py-1.5 text-white font-mono text-sm focus:border-cyan-400 focus:outline-none" placeholder="505786636" step="0.0001">
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-gray-400 w-20 text-sm">xASTRO</span>
                                <input type="number" id="manual-token-xASTRO" class="flex-1 bg-gray-800 border border-gray-600 rounded px-2 py-1.5 text-white font-mono text-sm focus:border-cyan-400 focus:outline-none" placeholder="20607.54" step="0.0001">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Use Last Snapshot Values Button -->
                    <button onclick="loadLastSnapshotValues()" class="w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition-colors mb-4">
                        <i class="fas fa-history mr-2"></i>Load Last Snapshot Values
                    </button>
                </div>
                
                <!-- LST Ratios Status (auto-loaded from TLA ext file) -->
                <div id="lst-ratios-status" class="bg-gray-800/50 border border-gray-700 rounded-lg p-3">
                    <div class="flex justify-between items-center mb-2">
                        <label class="block text-sm font-medium text-gray-300">
                            LST Ratios <span class="text-gray-500">(from TLA ext file)</span>
                        </label>
                        <button onclick="loadLstRatiosFromExt()" class="text-xs bg-cyan-600 hover:bg-cyan-700 text-white px-2 py-1 rounded">
                            <i class="fas fa-sync-alt mr-1"></i>Refresh
                        </button>
                    </div>
                    <div id="lst-ratios-grid" class="grid grid-cols-3 gap-2 text-xs">
                        <div class="bg-gray-900 rounded p-2 text-center">
                            <span class="text-gray-500">ampLUNA</span>
                            <span id="lst-ratio-display-ampLUNA" class="block text-teal-400 font-mono">--</span>
                        </div>
                        <div class="bg-gray-900 rounded p-2 text-center">
                            <span class="text-gray-500">arbLUNA</span>
                            <span id="lst-ratio-display-arbLUNA" class="block text-orange-400 font-mono">--</span>
                        </div>
                        <div class="bg-gray-900 rounded p-2 text-center">
                            <span class="text-gray-500">bLUNA</span>
                            <span id="lst-ratio-display-bLUNA" class="block text-cyan-400 font-mono">--</span>
                        </div>
                        <div class="bg-gray-900 rounded p-2 text-center">
                            <span class="text-gray-500">ampCAPA</span>
                            <span id="lst-ratio-display-ampCAPA" class="block text-purple-400 font-mono">--</span>
                        </div>
                        <div class="bg-gray-900 rounded p-2 text-center">
                            <span class="text-gray-500">ampROAR</span>
                            <span id="lst-ratio-display-ampROAR" class="block text-yellow-400 font-mono">--</span>
                        </div>
                        <div class="bg-gray-900 rounded p-2 text-center">
                            <span class="text-gray-500">xASTRO</span>
                            <span id="lst-ratio-display-xASTRO" class="block text-blue-400 font-mono">--</span>
                        </div>
                    </div>
                    <p id="lst-ratios-source" class="text-xs text-gray-600 mt-2">Source: Not loaded</p>
                </div>
                
                <!-- Custom Token Prices Section -->
                <div class="bg-gray-800/50 border border-gray-700 rounded-lg p-3">
                    <div class="flex justify-between items-center mb-2">
                        <label class="block text-sm font-medium text-gray-300">
                            <i class="fas fa-dollar-sign mr-1 text-green-400"></i>Custom Token Prices <span class="text-gray-500">(manual entry)</span>
                        </label>
                        <button onclick="addCustomTokenRow()" class="text-xs bg-green-600 hover:bg-green-700 text-white px-2 py-1 rounded">
                            <i class="fas fa-plus mr-1"></i>Add Token
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mb-2">Add prices for tokens not in the CoinGecko banner (e.g., ampCAPA, ampROAR calculated from ratios)</p>
                    
                    <!-- Custom Token Rows Container -->
                    <div id="custom-token-rows" class="space-y-2">
                        <!-- Dynamic rows will be added here -->
                    </div>
                    
                    <!-- Quick Add Calculated LST Prices -->
                    <div class="mt-3 pt-3 border-t border-gray-700">
                        <p class="text-xs text-gray-400 mb-2">Quick add calculated LST prices (base price  ratio):</p>
                        <div class="flex flex-wrap gap-2">
                            <button onclick="addCalculatedLstPrice('ampCAPA')" class="text-xs bg-purple-700 hover:bg-purple-600 text-white px-2 py-1 rounded">
                                + ampCAPA
                            </button>
                            <button onclick="addCalculatedLstPrice('ampROAR')" class="text-xs bg-yellow-700 hover:bg-yellow-600 text-white px-2 py-1 rounded">
                                + ampROAR
                            </button>
                            <button onclick="addCalculatedLstPrice('xASTRO')" class="text-xs bg-blue-700 hover:bg-blue-600 text-white px-2 py-1 rounded">
                                + xASTRO
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Preview Section -->
                <div id="tla-preview" class="bg-gray-800/50 border border-gray-700 rounded-lg p-4 hidden">
                    <h4 class="font-bold text-white mb-2">Preview</h4>
                    <div id="tla-preview-content" class="text-sm text-gray-300 space-y-1"></div>
                </div>
                
                <!-- Parse Button -->
                <button id="parse-tla-btn" class="w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                    <i class="fas fa-eye mr-2"></i>Preview Parsed Data
                </button>
                
                <!-- Status Message -->
                <div id="snapshot-status" class="text-center text-sm hidden"></div>
                
                <!-- Action Buttons -->
                <div class="flex gap-4">
                    <button id="download-snapshot-btn" class="flex-1 bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-4 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        <i class="fas fa-download mr-2"></i>Download Snapshot
                    </button>
                </div>
                
                <!-- Info -->
                <div class="bg-blue-900/30 border border-blue-700 p-3 rounded-lg text-sm">
                    <p><strong class="text-blue-300">How to use:</strong></p>
                    <ol class="list-decimal list-inside mt-2 space-y-1 text-gray-300">
                        <li>Paste your TLA token balances from Eris (tab-separated)</li>
                        <li>Paste your deposit value and APR text</li>
                        <li>Click "Preview" to verify the data</li>
                        <li>Click "Download Snapshot" to save the weekly snapshot file</li>
                        <li>Upload the file to GitHub: <code class="bg-gray-800 px-1 rounded">adao_json_storage</code></li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <!-- Historical Chart Modal -->
    <div id="chartModal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div class="modal-content bg-[#1a1a1a] border border-gray-700 rounded-xl shadow-xl w-full max-w-4xl relative text-white opacity-0 scale-95 p-6 max-h-[90vh] overflow-y-auto">
            <button class="modal-close absolute top-4 right-4 text-gray-400 hover:text-white text-3xl">&times;</button>
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h2 id="chart-modal-title" class="text-2xl font-bold text-cyan-400">Historical Data</h2>
                    <p id="chart-modal-subtitle" class="text-gray-400 text-sm">Click two points on the chart to compare them</p>
                </div>
                <select id="chart-metric-select" class="bg-gray-800 border border-gray-600 text-white text-sm rounded-lg px-3 py-2 focus:border-cyan-400 focus:outline-none" onchange="switchChartMetric(this.value)">
                    <option value="backingPerNft_LUNA">Backing/NFT (LUNA)</option>
                    <option value="backingPerNft_USD">Backing/NFT (USD)</option>
                    <option value="backingPerNft_ampLUNA">Backing/NFT (ampLUNA)</option>
                    <option value="avgDailyGainPerNft_LUNA">Avg Daily Gain</option>
                    <option value="treasuryTotal_USD">Treasury (USD)</option>
                    <option value="tlaDepositsTotal_USD">TLA Deposits (USD)</option>
                    <option value="tlaVpTotal_LUNA">TLA Voting Power</option>
                    <option value="daodaoStaked">DAODAO Staked</option>
                    <option value="enterpriseStaked">Enterprise Staked</option>
                    <option value="daoMembers">DAO Members</option>
                    <option value="daoHeldNfts">DAO Held NFTs</option>
                    <option value="unmintedTotalBacking_LUNA">Unminted Backing</option>
                </select>
            </div>
            
            <!-- Secondary Axis Toggle (for TLA Deposits) -->
            <div id="chart-secondary-toggle" class="mb-3 hidden">
                <span class="text-gray-400 text-sm mr-2">Secondary Axis:</span>
                <div class="inline-flex bg-gray-800 rounded-lg p-1">
                    <button id="toggle-apr" onclick="toggleChartSecondary('apr')" class="px-3 py-1 text-xs rounded-md bg-cyan-600 text-white transition-colors">Est APR</button>
                    <button id="toggle-luna" onclick="toggleChartSecondary('luna')" class="px-3 py-1 text-xs rounded-md text-gray-400 hover:text-white transition-colors">LUNA Price</button>
                </div>
            </div>
            
            <!-- VP Gain Indicator (only for VP metrics) -->
            <div id="chart-vp-gain-indicator" class="mb-3 hidden">
                <div class="flex items-center justify-center gap-4">
                    <div class="text-center">
                        <p class="text-xs text-gray-400">Current VP</p>
                        <p id="chart-vp-current" class="text-lg font-bold text-cyan-400">--</p>
                    </div>
                    <div class="flex items-center">
                        <div class="h-px w-6 bg-gray-600"></div>
                        <div class="bg-purple-900/50 border border-purple-500 rounded-lg px-3 py-1 mx-2">
                            <p class="text-xs text-purple-300">If Adjusted</p>
                            <p id="chart-vp-gain" class="text-lg font-bold text-purple-400">+0 VP</p>
                        </div>
                        <div class="h-px w-6 bg-gray-600"></div>
                        <i class="fas fa-arrow-right text-purple-400 mx-2"></i>
                    </div>
                    <div class="text-center">
                        <p class="text-xs text-gray-400">Potential VP</p>
                        <p id="chart-vp-potential" class="text-lg font-bold text-purple-400">--</p>
                    </div>
                </div>
            </div>
            
            <!-- Chart Container -->
            <div class="bg-gray-800/50 rounded-lg p-4 mb-4">
                <canvas id="historyChart" height="250"></canvas>
            </div>
            
            <!-- Loading indicator -->
            <div id="chart-loading" class="text-center py-8 hidden">
                <i class="fas fa-spinner fa-spin text-cyan-400 text-3xl"></i>
                <p class="text-gray-400 mt-2">Loading historical data...</p>
            </div>
            
            <!-- No data message -->
            <div id="chart-no-data" class="text-center py-8 hidden">
                <i class="fas fa-database text-gray-600 text-3xl"></i>
                <p class="text-gray-400 mt-2">No historical data available yet</p>
            </div>
            
            <!-- Comparison Section -->
            <div id="chart-comparison" class="hidden">
                <h3 class="text-lg font-bold text-white mb-3 flex items-center gap-2">
                    <i class="fas fa-balance-scale text-cyan-400"></i> Comparison
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- Point A -->
                    <div id="comparison-point-a" class="bg-gray-800/50 border border-cyan-600 rounded-lg p-4">
                        <p class="text-xs text-cyan-400 font-bold mb-1">POINT A (Start)</p>
                        <p id="point-a-date" class="text-sm text-gray-400">Click a point...</p>
                        <p id="point-a-value" class="text-xl font-bold text-white">--</p>
                    </div>
                    <!-- Delta -->
                    <div class="bg-gray-800/50 border border-gray-600 rounded-lg p-4 flex flex-col items-center justify-center">
                        <p class="text-xs text-gray-400 font-bold mb-1">CHANGE</p>
                        <p id="comparison-delta" class="text-2xl font-bold text-white">--</p>
                        <p id="comparison-percent" class="text-sm text-gray-400">--</p>
                        <p id="comparison-days" class="text-xs text-gray-500 mt-1">--</p>
                    </div>
                    <!-- Point B -->
                    <div id="comparison-point-b" class="bg-gray-800/50 border border-teal-500 rounded-lg p-4">
                        <p class="text-xs text-teal-400 font-bold mb-1">POINT B (End)</p>
                        <p id="point-b-date" class="text-sm text-gray-400">Click another point...</p>
                        <p id="point-b-value" class="text-xl font-bold text-white">--</p>
                    </div>
                </div>
                <!-- Clear Selection Button -->
                <button id="clear-comparison" class="mt-3 text-sm text-gray-400 hover:text-white transition-colors">
                    <i class="fas fa-times mr-1"></i> Clear Selection
                </button>
            </div>
            
            <!-- Market Value Calculator (for Unminted Backing chart) -->
            <div id="chart-market-calc" class="hidden mt-4">
                <div class="bg-green-900/20 border border-green-700 p-4 rounded-lg">
                    <h4 class="text-md font-bold text-green-400 mb-3"><i class="fas fa-calculator mr-2"></i>Market Value Calculator</h4>
                    
                    <!-- Row 1: Floor Price and NFT Type -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                        <!-- Floor Price -->
                        <div>
                            <label class="block text-xs text-gray-400 mb-1">Floor Price</label>
                            <div class="flex gap-2">
                                <input type="number" id="chart-unminted-price" class="flex-1 bg-gray-800 border border-gray-600 rounded px-2 py-1.5 text-white text-sm focus:border-green-400 focus:outline-none" placeholder="Enter price" step="0.01" oninput="calculateChartUnmintedValue()">
                                <select id="chart-unminted-token" class="bg-gray-800 border border-gray-600 rounded px-2 py-1.5 text-white text-sm focus:border-green-400 focus:outline-none" onchange="calculateChartUnmintedValue()">
                                    <option value="bLUNA">bLUNA</option>
                                    <option value="LUNA">LUNA</option>
                                    <option value="ampLUNA">ampLUNA</option>
                                    <option value="arbLUNA">arbLUNA</option>
                                    <option value="USD">USD</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- NFT Type -->
                        <div>
                            <label class="block text-xs text-gray-400 mb-1">NFT Type</label>
                            <div class="flex gap-1">
                                <button id="chart-nft-unbroken" onclick="setChartNftType('unbroken')" class="flex-1 px-2 py-1.5 rounded bg-green-600 text-white text-xs font-medium">Unbroken</button>
                                <button id="chart-nft-broken" onclick="setChartNftType('broken')" class="flex-1 px-2 py-1.5 rounded bg-gray-700 text-gray-400 text-xs font-medium hover:bg-gray-600">Broken</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Row 2: Discount Slider -->
                    <div class="mb-3">
                        <label class="block text-xs text-gray-400 mb-1">Discount for Fast/Mass Sale: <span id="chart-unminted-discount-val" class="text-green-400 font-bold">0%</span></label>
                        <input type="range" id="chart-unminted-discount" min="0" max="50" value="0" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-green-500" oninput="updateChartUnmintedDiscount()">
                        <div class="flex justify-between text-[10px] text-gray-500 mt-1">
                            <span>0%</span>
                            <span>25%</span>
                            <span>50%</span>
                        </div>
                    </div>
                    
                    <!-- Results -->
                    <div id="chart-unminted-result" class="bg-gray-800/50 p-3 rounded-lg hidden">
                        <div class="grid grid-cols-5 gap-2 text-center">
                            <div>
                                <p class="text-[10px] text-gray-400">Eff. Price</p>
                                <p id="chart-unminted-eff-price" class="text-sm font-bold text-white">--</p>
                            </div>
                            <div>
                                <p class="text-[10px] text-gray-400">Backing</p>
                                <p id="chart-unminted-backing" class="text-sm font-bold text-yellow-400">--</p>
                            </div>
                            <div>
                                <p class="text-[10px] text-gray-400">Premium</p>
                                <p id="chart-unminted-premium-val" class="text-sm font-bold text-green-400">--</p>
                            </div>
                            <div>
                                <p class="text-[10px] text-gray-400">Total Value</p>
                                <p id="chart-unminted-total" class="text-lg font-bold text-green-400">--</p>
                            </div>
                            <div>
                                <p class="text-[10px] text-gray-400">vs Backing</p>
                                <p id="chart-unminted-vs-backing" class="text-sm font-bold text-cyan-400">--</p>
                            </div>
                        </div>
                        <p id="chart-unminted-count" class="text-center text-xs text-gray-500 mt-2">5,828 unminted NFTs</p>
                        
                        <!-- Treasury Impact Summary -->
                        <div id="chart-treasury-impact" class="mt-3 pt-3 border-t border-gray-700">
                            <h5 class="text-xs font-bold text-cyan-400 mb-2"><i class="fas fa-landmark mr-1"></i>DAO Holdings + Unminted</h5>
                            
                            <!-- Compact breakdown -->
                            <div class="bg-gray-900/50 rounded p-2 mb-2 text-[10px]">
                                <div class="flex justify-between"><span class="text-gray-500"><i class="fas fa-check-circle text-green-500 mr-1"></i>Treasury</span><span id="chart-treasury-live" class="font-mono text-white">--</span></div>
                                <div class="flex justify-between"><span class="text-gray-500"><i class="fas fa-check-circle text-green-500 mr-1"></i>TLA Locks</span><span id="chart-locks-live" class="font-mono text-white">--</span></div>
                                <div class="flex justify-between"><span id="chart-deposits-status" class="text-gray-500"><i class="fas fa-clock text-yellow-500 mr-1"></i>TLA Deposits</span><span id="chart-deposits-value" class="font-mono text-white">--</span></div>
                                <div class="flex justify-between border-t border-gray-700 pt-1 mt-1"><span class="text-gray-400">Total</span><span id="chart-current-treasury" class="font-mono font-bold text-white">--</span></div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-2 text-center text-xs">
                                <div class="bg-gray-900/50 rounded p-2">
                                    <p class="text-gray-500">+ Unminted</p>
                                    <p id="chart-unminted-add" class="font-bold text-green-400">--</p>
                                </div>
                                <div class="bg-green-900/30 rounded p-2 border border-green-600/30">
                                    <p class="text-gray-400">Potential</p>
                                    <p id="chart-potential-total" class="font-bold text-green-300">--</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Marketplace Links -->
                    <div class="flex gap-2 mt-3">
                        <a href="https://app.backbonelabs.io/nfts/marketplace/collections/terra1phr9fngjv7a8an4dhmhd0u0f98wazxfnzccqtyheq4zqrrp4fpuqw3apw9" target="_blank" class="text-xs text-gray-400 hover:text-white"><i class="fas fa-external-link-alt mr-1"></i>Backbone</a>
                        <a href="https://www.boostdao.io/ignite/permissionless-terra" target="_blank" class="text-xs text-gray-400 hover:text-white"><i class="fas fa-external-link-alt mr-1"></i>Boost DAO</a>
                    </div>
                </div>
            </div>
            
            <!-- Data Table -->
            <div class="mt-4">
                <h3 class="text-lg font-bold text-white mb-3 flex items-center gap-2">
                    <i class="fas fa-table text-cyan-400"></i> All Data Points
                </h3>
                <div class="max-h-48 overflow-y-auto">
                    <table class="w-full text-sm">
                        <thead class="sticky top-0 bg-gray-900">
                            <tr class="text-gray-400">
                                <th class="text-left p-2">Epoch</th>
                                <th class="text-left p-2">Date</th>
                                <th class="text-right p-2">Value</th>
                                <th class="text-right p-2">Change</th>
                            </tr>
                        </thead>
                        <tbody id="chart-data-table"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>


    <footer class="border-t border-gray-800 mt-12 py-8">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center text-gray-500 text-sm">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
                <div><h4 class="font-bold text-gray-300 mb-2">Disclaimer</h4><p>This website is for informational purposes only and does not constitute financial advice. All data is provided "as is" without warranty. Please do your own research.</p></div>
                <div><h4 class="font-bold text-gray-300 mb-2">Project Origin</h4><p>This site is built and maintained by a council member, not at the direction of the council, but as a passionate community member looking to improve the optics of the collection.</p></div>
                <div><h4 class="font-bold text-gray-300 mb-2">Data Source</h4><p>Data on this site is a mix of live on-chain data and static snapshots. See the banner at the top for details.</p>
                </div>
                <div><h4 class="font-bold text-gray-300 mb-2">Transparency</h4><p>The plan is for the script used to retrieve on-chain data to be open-source. You will be able to view the public repository to see how information is retrieved.</p><a href="https://github.com/defipatriot" target="_blank" rel="noopener noreferrer" class="text-cyan-400 hover:underline mt-2 inline-block">View on GitHub</a></div>
            </div>
        </div>
    </footer>
    
    <footer class="py-6">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center text-gray-400">
            <div class="flex justify-center items-center space-x-6 mb-4">
                <a href="https://t.me/The_AllianceDAO" target="_blank" rel="noopener noreferrer" class="hover:text-white transition-colors"><i class="fab fa-telegram-plane text-3xl"></i></a>
                <a href="https://x.com/The_AllianceDAO" target="_blank" rel="noopener noreferrer" class="hover:text-white transition-colors"><i class="fab fa-twitter text-3xl"></i></a>
            </div>
            <div class="flex flex-wrap justify-center items-center space-x-6 text-sm">
                <a href="tutorials.html" class="hover:text-white hover:underline transition-colors">Tutorials</a>
                <a href="links.html" class="hover:text-white hover:underline transition-colors">Official Links</a>
                <a href="#" id="logo-modal-trigger" class="hover:text-white hover:underline transition-colors cursor-pointer">Logos</a>
                <a href="https://chainsco.pe/terra2/address/terra1phr9fngjv7a8an4dhmhd0u0f98wazxfnzccqtyheq4zqrrp4fpuqw3apw9" target="_blank" rel="noopener noreferrer" class="hover:text-white hover:underline transition-colors">NFT Contract</a>
                <a href="https://github.com/SCV-Security/PublicReports/blob/b819ec669f81e603caca261931e2a4aaca1cddf7/Alliance/Alliance%20DAO%20-%20NFT%20Collection%20Contract%20-%20Audit%20Report%20v1.0.pdf" target="_blank" rel="noopener noreferrer" class="hover:text-white hover:underline transition-colors">Contract Audit</a>
                <a href="tla_tool.html" class="hover:text-white hover:underline transition-colors">TLA Tool</a>
            </div>
        </div>
    </footer>

    <!-- Top 10 Sales Modal -->
    <div id="top10Modal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div class="modal-content bg-[#1a1a1a] border border-yellow-600/30 rounded-xl shadow-xl w-full max-w-4xl relative text-white opacity-0 scale-95 p-6 max-h-[90vh] overflow-y-auto">
            <button class="modal-close absolute top-4 right-4 text-gray-400 hover:text-white text-3xl">&times;</button>
            <h3 class="text-2xl font-bold text-yellow-400 mb-2 flex items-center gap-3">
                <i class="fas fa-trophy"></i>
                Top 10 All-Time NFT Sales
            </h3>
            <p class="text-gray-400 text-sm mb-6">Highest value sales across BBL and Boost marketplaces</p>
            <div id="top10-sales-list" class="space-y-3">
                <div class="text-gray-500 text-center py-8"><i class="fas fa-spinner fa-spin"></i> Loading top sales...</div>
            </div>
            <div class="mt-6 pt-4 border-t border-gray-700 text-xs text-gray-500 text-center">
                <span id="top10-min-qualify">Minimum to qualify: Loading...</span>
            </div>
        </div>
    </div>


    <script>
        // --- Global variable to store snapshot data ---
        let currentSnapshotData = null; 
        let isFetching = false; // Flag to prevent multiple downloads while fetching
        let cachedPriceData = null; // Store price data for later use
        
        // --- Chart system globals ---
        let historicalSnapshots = []; // Cache of all fetched snapshots
        let historyChart = null; // Chart.js instance
        let chartSelectedPoints = []; // Selected points for comparison
        let currentChartMetric = null; // Current metric being displayed
        let calculatedAvgDailyGain = null; // Store the calculated avg daily gain

        document.addEventListener('DOMContentLoaded', () => {

            // --- CENTRAL DATA OBJECT ---
            const dashboardData = {
              "lastUpdated": "2025-09-11T16:02:00Z",
              "statusSliders": {
                "mint": { "unMinted": 5828, "minted": 4172, "percentMinted": "41.72%" },
                "broken": { "unBroken": 8924, "broken": 1076, "percentBroken": "10.76%" }
              },
              "keyMetrics": {
                "daodaoStaked": 1476, 
                "daoMembers": 160,
                "enterpriseStakedHolder": 415,
                "backingInLuna": 109.97,
                "avgDailyGain": 0.21,
              },
              "tlaDeposits": {
                "snapshotDate": null,
                "totalDeposit": 0,
                "estApr": 0,
                "tokenBalances": []
              }
            };
            
            // --- Function to fetch Avg Daily Gain from GitHub snapshots ---
            async function fetchAvgDailyGainFromGitHub() {
                const avgDailyGainEl = document.getElementById('avg-daily-gain');
                const avgDailyGainSubEl = document.getElementById('avg-daily-gain-subtext');
                const avgDailyGainTitleEl = document.getElementById('avg-daily-gain-title');
                
                try {
                    // Calculate current epoch number
                    const epochReferenceDate = new Date('2025-12-01T00:00:00Z');
                    const epochReferenceNumber = 162;
                    const now = new Date();
                    const msPerWeek = 7 * 24 * 60 * 60 * 1000;
                    const weeksDiff = Math.floor((now - epochReferenceDate) / msPerWeek);
                    const currentEpoch = epochReferenceNumber + weeksDiff;
                    
                    console.log(`DEBUG: Current epoch: ${currentEpoch}, fetching backing data`);
                    
                    // Try to get the latest backing from TLA v3 data
                    const tlaData = await fetchTlaData();
                    let newestBacking = null;
                    let newestTime = null;
                    let newestEpoch = null;
                    
                    if (tlaData?.dashboard?.nft_backing_per_nft || tlaData?.nft_stats?.backing_per_nft) {
                        const backing = tlaData.dashboard?.nft_backing_per_nft || tlaData.nft_stats?.backing_per_nft;
                        newestBacking = backing.LUNA_equivalent;
                        newestTime = new Date(tlaData.meta?.generated_at);
                        newestEpoch = tlaData.meta?.epoch;
                        console.log(`DEBUG: Got TLA v3 backing: ${newestBacking} LUNA from epoch ${newestEpoch}`);
                    }
                    
                    // Also try adao_json_storage for newest completed epoch
                    if (!newestBacking) {
                        const newestCompletedEpoch = currentEpoch - 1;
                        const baseUrl = 'https://raw.githubusercontent.com/defipatriot/adao_json_storage/main';
                        const newestUrl = `${baseUrl}/adao-snapshot_${newestCompletedEpoch}_end.json`;
                        const newestResponse = await fetch(newestUrl).catch(() => null);
                        if (newestResponse?.ok) {
                            const newestData = await newestResponse.json();
                            newestBacking = newestData.backingPerNft_LUNA;
                            newestTime = new Date(newestData.timestamp);
                            newestEpoch = newestCompletedEpoch;
                        }
                    }
                    
                    // Get last known good epoch (try 163, as 164 might be missing)
                    let olderBacking = null;
                    let olderTime = null;
                    let olderEpoch = null;
                    
                    const baseUrl = 'https://raw.githubusercontent.com/defipatriot/adao_json_storage/main';
                    // Try epochs in order: 163, 162, 161
                    for (const tryEpoch of [163, 162, 161]) {
                        if (tryEpoch >= newestEpoch) continue; // Skip if same or newer than our newest
                        const olderUrl = `${baseUrl}/adao-snapshot_${tryEpoch}_end.json`;
                        const olderResponse = await fetch(olderUrl).catch(() => null);
                        if (olderResponse?.ok) {
                            const olderData = await olderResponse.json();
                            olderBacking = olderData.backingPerNft_LUNA;
                            olderTime = new Date(olderData.timestamp);
                            olderEpoch = tryEpoch;
                            console.log(`DEBUG: Got older backing: ${olderBacking} LUNA from epoch ${tryEpoch}`);
                            break;
                        }
                    }
                    
                    if (!newestBacking || !olderBacking) {
                        console.warn("DEBUG: Could not get backing data from both epochs");
                        throw new Error("Backing data fetch failed");
                    }
                    
                    // Calculate backing difference
                    const backingDiff = newestBacking - olderBacking;
                    
                    // Calculate time difference in days
                    const timeDiffMs = newestTime - olderTime;
                    const timeDiffDays = timeDiffMs / (1000 * 60 * 60 * 24);
                    
                    // Calculate average daily gain
                    const avgDailyGain = timeDiffDays > 0 ? backingDiff / timeDiffDays : 0;
                    
                    // Store in global variable for snapshot export
                    calculatedAvgDailyGain = avgDailyGain;
                    
                    console.log(`DEBUG: E${olderEpoch}E${newestEpoch} Backing diff: ${backingDiff.toFixed(6)}, Days: ${timeDiffDays.toFixed(2)}, Avg Daily: ${avgDailyGain.toFixed(4)}`);
                    
                    // Update the tile with live data
                    if (avgDailyGainEl) {
                        const displayValue = avgDailyGain >= 0 ? `+${avgDailyGain.toFixed(2)}` : avgDailyGain.toFixed(2);
                        avgDailyGainEl.textContent = displayValue;
                    }
                    
                    if (avgDailyGainSubEl) {
                        const dayLabel = Math.round(timeDiffDays);
                        avgDailyGainSubEl.textContent = `${dayLabel}d Avg (E${olderEpoch}E${newestEpoch})`;
                    }
                    
                    // Update the title with green pulse dot (live indicator)
                    if (avgDailyGainTitleEl) {
                        const existingDot = avgDailyGainTitleEl.querySelector('.pulse-dot, .static-dot-red');
                        if (existingDot) existingDot.remove();
                        const newDot = document.createElement('span');
                        newDot.className = 'pulse-dot ml-1';
                        avgDailyGainTitleEl.appendChild(newDot);
                    }
                    
                    return true; // Success
                    
                } catch (error) {
                    console.error("DEBUG: Failed to fetch avg daily gain from GitHub:", error);
                    
                    // Fall back to static snapshot value
                    const { keyMetrics } = dashboardData;
                    if (avgDailyGainEl && avgDailyGainEl.innerHTML.includes('fa-spinner')) {
                        avgDailyGainEl.textContent = `+${keyMetrics.avgDailyGain}`;
                    }
                    if (avgDailyGainSubEl && avgDailyGainSubEl.innerHTML.includes('fa-spinner')) {
                        avgDailyGainSubEl.textContent = '(Snapshot)';
                    }
                    // Update with red static dot (snapshot indicator)
                    if (avgDailyGainTitleEl) {
                        const existingDot = avgDailyGainTitleEl.querySelector('.pulse-dot, .static-dot-red');
                        if (existingDot) existingDot.remove();
                        const newDot = document.createElement('span');
                        newDot.className = 'static-dot-red ml-1';
                        avgDailyGainTitleEl.appendChild(newDot);
                    }
                    
                    return false; // Failed
                }
            }
            
            // --- Function to fetch TLA data from GitHub snapshots ---
            async function fetchTlaFromGitHub() {
                try {
                    // Calculate current epoch number (same logic as avg daily gain)
                    const epochReferenceDate = new Date('2025-12-01T00:00:00Z');
                    const epochReferenceNumber = 162;
                    const now = new Date();
                    const msPerWeek = 7 * 24 * 60 * 60 * 1000;
                    const weeksDiff = Math.floor((now - epochReferenceDate) / msPerWeek);
                    const currentEpoch = epochReferenceNumber + weeksDiff;
                    const newestCompletedEpoch = currentEpoch - 1;
                    
                    console.log(`DEBUG: Fetching TLA data from epoch ${newestCompletedEpoch}`);
                    
                    const baseUrl = 'https://raw.githubusercontent.com/defipatriot/adao_json_storage/main';
                    const snapshotUrl = `${baseUrl}/adao-snapshot_${newestCompletedEpoch}_end.json`;
                    console.log(`DEBUG: TLA fetch URL: ${snapshotUrl}`);
                    
                    const response = await fetch(snapshotUrl);
                    console.log(`DEBUG: TLA fetch response status: ${response?.status}`);
                    
                    if (!response?.ok) {
                        console.warn("DEBUG: Could not fetch TLA snapshot");
                        return null;
                    }
                    
                    const snapshotData = await response.json();
                    console.log("DEBUG: TLA snapshot loaded, keys:", Object.keys(snapshotData));
                    
                    // Check if TLA data exists in the snapshot
                    if (snapshotData.tlaDeposits) {
                        console.log("DEBUG: TLA data found in snapshot:", snapshotData.tlaDeposits);
                        return {
                            data: snapshotData.tlaDeposits,
                            epoch: newestCompletedEpoch,
                            timestamp: snapshotData.timestamp
                        };
                    } else {
                        console.log("DEBUG: No tlaDeposits key found in snapshot");
                    }
                    
                    return null;
                } catch (error) {
                    console.error("DEBUG: Failed to fetch TLA from GitHub:", error);
                    return null;
                }
            }
            
            // --- Function to update TLA tile from GitHub data ---
            async function updateTlaFromGitHub() {
                const tlaResult = await fetchTlaFromGitHub();
                
                if (tlaResult && tlaResult.data) {
                    const tlaData = tlaResult.data;
                    
                    // Support both old format (totalDeposit, estApr, tokenBalances) 
                    // and new v3 format (dashboard.tla_deposits)
                    const deposits = tlaData.dashboard?.tla_deposits || tlaData;
                    
                    // Update the dashboardData with fetched TLA data
                    dashboardData.tlaDeposits.totalDeposit = deposits.total_usd || tlaData.totalDeposit || tlaData.totalDeposit_USD || dashboardData.tlaDeposits.totalDeposit;
                    dashboardData.tlaDeposits.estApr = deposits.apr || tlaData.estApr || dashboardData.tlaDeposits.estApr;
                    dashboardData.tlaDeposits.snapshotDate = tlaResult.timestamp;
                    
                    // Token balances - new format uses 'tokens' with 'symbol', old uses 'tokenBalances' with 'name'
                    const tokenBalances = deposits.tokens || tlaData.tokenBalances;
                    if (tokenBalances && Array.isArray(tokenBalances)) {
                        // Normalize to common format (use 'symbol' if available, else 'name')
                        dashboardData.tlaDeposits.tokenBalances = tokenBalances.map(t => ({
                            name: t.symbol || t.name,
                            amount: t.amount,
                            value: t.usd || t.value,
                            price: t.price
                        }));
                    }
                    
                    console.log(`DEBUG: Updated TLA data from epoch ${tlaResult.epoch}`);
                    return true;
                }
                
                return false;
            }
            
            // --- Parsed TLA data holder ---
            let parsedTlaData = null;
            
            // --- Chart System Configuration ---
            const chartMetrics = {
                'backingPerNft_LUNA': {
                    label: 'Backing per NFT (LUNA)',
                    format: (v) => v.toFixed(2) + ' LUNA',
                    color: '#f97316', // orange
                    tileId: 'backing-per-nft-luna-live',
                    usdKey: 'backingPerNft_USD',
                    usdLabel: 'USD Value',
                    usdColor: '#22c55e'
                },
                'backingPerNft_USD': {
                    label: 'Backing per NFT (USD)',
                    format: (v) => '$' + v.toFixed(2),
                    color: '#22c55e', // green
                    tileId: 'backing-per-nft-usd',
                    secondaryKey: 'backingPerNft_LUNA',
                    secondaryLabel: 'LUNA Amount',
                    secondaryColor: '#f97316',
                    secondaryFormat: (v) => v.toFixed(2) + ' LUNA',
                    showLunaPriceInTable: true
                },
                'backingPerNft_ampLUNA': {
                    label: 'Backing per NFT (ampLUNA)',
                    format: (v) => v.toFixed(4) + ' ampLUNA',
                    color: '#3b82f6', // blue
                    tileId: 'backing-per-nft-ampluna',
                    secondaryKey: 'ampLUNA_LUNA_Ratio',
                    secondaryLabel: 'ampLUNA/LUNA Ratio',
                    secondaryColor: '#8b5cf6',
                    secondaryFormat: (v) => v.toFixed(4) + 'x'
                },
                'avgDailyGainPerNft_LUNA': {
                    label: 'Avg Daily Gain (LUNA)',
                    format: (v) => '+' + v.toFixed(4) + ' LUNA',
                    color: '#10b981', // emerald
                    tileId: 'avg-daily-gain'
                },
                'treasuryTotal_USD': {
                    label: 'DAO Treasury (USD)',
                    format: (v) => '$' + v.toLocaleString('en-US', {maximumFractionDigits: 0}),
                    color: '#8b5cf6', // purple
                    tileId: 'dao-treasury-total',
                    secondaryKey: 'lunaPrice_USD',
                    secondaryLabel: 'LUNA Price',
                    secondaryColor: '#f97316',
                    secondaryFormat: (v) => '$' + v.toFixed(4)
                },
                'tlaDepositsTotal_USD': {
                    label: 'TLA Deposits (USD)',
                    format: (v) => '$' + v.toLocaleString('en-US', {maximumFractionDigits: 0}),
                    color: '#ec4899', // pink
                    tileId: 'dao-tla-total',
                    secondaryKey: 'lunaPrice_USD',
                    secondaryLabel: 'LUNA Price',
                    secondaryColor: '#f97316',
                    secondaryFormat: (v) => '$' + v.toFixed(4)
                },
                'tlaVpTotal_LUNA': {
                    label: 'TLA Voting Power',
                    format: (v) => v.toLocaleString('en-US', {maximumFractionDigits: 0}) + ' VP',
                    color: '#06b6d4', // cyan (aDAO color)
                    tileId: 'dao-tla-vp',
                    usdKey: 'tlaVpTotal_USD',
                    usdLabel: 'USD Value',
                    usdColor: '#22c55e',
                    isVpMetric: true, // Flag to use special VP table format
                    vpMultiplier: 1 // VP is now stored directly, no multiplier needed
                },
                'daodaoStaked': {
                    label: 'DAODAO Staked',
                    format: (v) => v.toLocaleString(),
                    color: '#06b6d4', // cyan
                    tileId: 'daodao-staked',
                    secondaryKey: 'daodaoStakedPercent',
                    secondaryLabel: '% of Circulating',
                    secondaryColor: '#f59e0b',
                    secondaryFormat: (v) => v.toFixed(2) + '%'
                },
                'enterpriseStaked': {
                    label: 'Enterprise Staked',
                    format: (v) => v.toLocaleString(),
                    color: '#14b8a6', // teal
                    tileId: 'enterprise-staked'
                },
                'daoMembers': {
                    label: 'DAO Members',
                    format: (v) => v.toLocaleString(),
                    color: '#f59e0b', // amber
                    tileId: 'dao-members'
                },
                'daoHeldNfts': {
                    label: 'DAO Broken/Held NFTs',
                    format: (v) => v.toLocaleString(),
                    color: '#6366f1', // indigo
                    tileId: 'dao-broken-total'
                },
                'unmintedTotalBacking_LUNA': {
                    label: 'Unminted NFT Backing (LUNA)',
                    format: (v) => v.toLocaleString('en-US', {maximumFractionDigits: 0}) + ' LUNA',
                    color: '#ef4444', // red
                    tileId: 'unminted-nft-backing-luna',
                    usdKey: 'unmintedTotalBacking_USD',
                    usdLabel: 'USD Value',
                    usdColor: '#22c55e'
                },
                'tlaDepositsApr': {
                    label: 'TLA Deposits APR',
                    format: (v) => v.toFixed(2) + '%',
                    color: '#06b6d4', // cyan
                    tileId: 'dao-tla-apr',
                    secondaryKey: 'tlaDepositsTotal_USD',
                    secondaryLabel: 'Deposit Value',
                    secondaryColor: '#ec4899',
                    secondaryFormat: (v) => '$' + v.toLocaleString('en-US', {maximumFractionDigits: 0})
                }
            };
            
            // --- Fetch all historical snapshots ---
            async function fetchAllSnapshots() {
                if (historicalSnapshots.length > 0) {
                    return historicalSnapshots; // Return cached data
                }
                
                const baseUrl = 'https://raw.githubusercontent.com/defipatriot/adao_json_storage/main';
                const tlaBaseUrl = 'https://raw.githubusercontent.com/defipatriot/tla_json_storage/main';
                const epochReferenceDate = new Date('2025-12-01T00:00:00Z');
                const epochReferenceNumber = 162;
                const now = new Date();
                const msPerWeek = 7 * 24 * 60 * 60 * 1000;
                const weeksDiff = Math.floor((now - epochReferenceDate) / msPerWeek);
                const currentEpoch = epochReferenceNumber + weeksDiff;
                
                // Try to fetch epochs from 160 to current (adjust range as needed)
                const startEpoch = 160;
                const endEpoch = currentEpoch;
                
                const fetchPromises = [];
                for (let epoch = startEpoch; epoch <= endEpoch; epoch++) {
                    fetchPromises.push(
                        (async () => {
                            // First try adao_json_storage (old format)
                            try {
                                const res = await fetch(`${baseUrl}/adao-snapshot_${epoch}_end.json`);
                                if (res.ok) {
                                    const data = await res.json();
                                    return { epoch, ...data, source: 'adao' };
                                }
                            } catch (e) {}
                            
                            // Then try tla_json_storage (v3 format)
                            try {
                                const res = await fetch(`${tlaBaseUrl}/tla-data-epoch-${epoch}-end.json`);
                                if (res.ok) {
                                    const data = await res.json();
                                    // Convert v3 format to chart-compatible format
                                    const backing = data.dashboard?.nft_backing_per_nft || data.nft_stats?.backing_per_nft || {};
                                    const tlaDeposits = data.dashboard?.tla_deposits || {};
                                    return {
                                        epoch,
                                        timestamp: data.meta?.generated_at,
                                        backingPerNft_LUNA: backing.LUNA_equivalent,
                                        backingPerNft_USD: backing.USD,
                                        backingPerNft_ampLUNA: backing.ampLUNA,
                                        tlaDeposits: {
                                            totalDeposit: tlaDeposits.total_usd,
                                            estApr: tlaDeposits.apr
                                        },
                                        tlaDepositsTotal_USD: tlaDeposits.total_usd,
                                        source: 'tla_v3'
                                    };
                                }
                            } catch (e) {}
                            
                            // Return placeholder for missing epochs
                            return { epoch, missing: true };
                        })()
                    );
                }
                
                const results = await Promise.all(fetchPromises);
                // Filter out missing epochs but keep track of them
                const validResults = results.filter(r => r !== null && !r.missing).sort((a, b) => a.epoch - b.epoch);
                const missingEpochs = results.filter(r => r?.missing).map(r => r.epoch);
                
                if (missingEpochs.length > 0) {
                    console.log(`DEBUG: Missing epochs: ${missingEpochs.join(', ')}`);
                }
                
                historicalSnapshots = validResults;
                console.log(`DEBUG: Loaded ${historicalSnapshots.length} historical snapshots (missing: ${missingEpochs.join(', ') || 'none'})`);
                return historicalSnapshots;
            }
            
            // --- Open chart modal for a specific metric ---
            async function openChartModal(metricKey) {
                const modal = document.getElementById('chartModal');
                const loading = document.getElementById('chart-loading');
                const noData = document.getElementById('chart-no-data');
                const comparison = document.getElementById('chart-comparison');
                const title = document.getElementById('chart-modal-title');
                const canvas = document.getElementById('historyChart');
                const metricSelect = document.getElementById('chart-metric-select');
                
                currentChartMetric = metricKey;
                chartSelectedPoints = [];
                
                // Show modal
                modal.classList.remove('hidden');
                setTimeout(() => {
                    modal.classList.remove('opacity-0');
                    modal.querySelector('.modal-content').classList.remove('opacity-0', 'scale-95');
                }, 10);
                
                // Update title and dropdown
                const metric = chartMetrics[metricKey];
                title.textContent = metric ? metric.label + ' History' : 'Historical Data';
                if (metricSelect) metricSelect.value = metricKey;
                
                // Show loading
                loading.classList.remove('hidden');
                noData.classList.add('hidden');
                comparison.classList.remove('hidden');
                canvas.style.display = 'none';
                
                // Reset comparison UI
                resetComparisonUI();
                
                // Fetch data
                const snapshots = await fetchAllSnapshots();
                loading.classList.add('hidden');
                
                if (snapshots.length === 0) {
                    noData.classList.remove('hidden');
                    return;
                }
                
                // Build chart data
                const chartData = snapshots.map(s => {
                    let value = null;
                    let secondaryValue = null;
                    
                    // Handle special cases
                    if (metricKey === 'tlaDepositsTotal_USD' && s.tlaDeposits) {
                        value = s.tlaDeposits.totalDeposit || s.tlaDepositsTotal_USD;
                    } else if (metricKey === 'tlaDepositsApr') {
                        // Get APR from tlaDeposits object
                        value = s.tlaDeposits?.estApr || null;
                        // Secondary is the deposit value
                        secondaryValue = s.tlaDeposits?.totalDeposit || s.tlaDepositsTotal_USD;
                    } else if (metricKey === 'tlaVpTotal_LUNA') {
                        // Try to get LUNA value, or calculate from USD/price
                        value = s.tlaVpTotal_LUNA;
                        if (!value && s.tlaVpTotal_USD && s.lunaPrice_USD) {
                            value = s.tlaVpTotal_USD / s.lunaPrice_USD; // Back-calculate LUNA from USD
                        }
                        if (metric.usdKey) secondaryValue = s[metric.usdKey];
                    } else if (metricKey === 'daoHeldNfts') {
                        // DAO held - use field if exists, or default to 1000
                        value = s.daoHeldNfts !== undefined ? s.daoHeldNfts : 1000;
                    } else if (metricKey === 'daodaoStaked') {
                        value = s.daodaoStaked;
                        // Calculate percentage
                        if (s.circulatingSupply && s.daodaoStaked) {
                            secondaryValue = (s.daodaoStaked / s.circulatingSupply) * 100;
                        }
                    } else {
                        value = s[metricKey];
                    }
                    
                    // Get secondary value based on metric config
                    if (metric.usdKey && !secondaryValue) {
                        secondaryValue = s[metric.usdKey];
                    } else if (metric.secondaryKey && !secondaryValue) {
                        if (metric.secondaryKey === 'daodaoStakedPercent') {
                            // Already calculated above
                        } else {
                            secondaryValue = s[metric.secondaryKey];
                        }
                    }
                    
                    return {
                        epoch: s.epoch,
                        timestamp: s.timestamp,
                        value: value,
                        secondaryValue: secondaryValue,
                        lunaPrice: s.lunaPrice_USD, // Store LUNA price for reference
                        estApr: s.tlaDeposits?.estApr || null, // Store APR for TLA Deposits toggle
                        unmintedCount: s.unmintedCount || s.statusSliders?.mint?.unMinted // Store unminted count for market value calc
                    };
                }).filter(d => d.value !== null && d.value !== undefined);
                
                // Show/hide secondary axis toggle for TLA Deposits
                const toggleEl = document.getElementById('chart-secondary-toggle');
                if (toggleEl) {
                    if (metricKey === 'tlaDepositsTotal_USD') {
                        toggleEl.classList.remove('hidden');
                        // Default to APR
                        window.chartSecondaryMode = 'apr';
                        updateToggleButtons('apr');
                    } else {
                        toggleEl.classList.add('hidden');
                        window.chartSecondaryMode = 'luna';
                    }
                }
                
                // Show/hide VP gain indicator
                const vpGainEl = document.getElementById('chart-vp-gain-indicator');
                if (vpGainEl) {
                    if (metricKey === 'tlaVpTotal_LUNA') {
                        const tlaVpData = window.tlaVpData || {};
                        const currentVp = tlaVpData.totalVp || 638900;
                        const potentialVp = tlaVpData.potentialVp || 651400;
                        const vpGain = potentialVp - currentVp;
                        
                        document.getElementById('chart-vp-current').textContent = (currentVp/1000).toFixed(1) + 'K';
                        document.getElementById('chart-vp-gain').textContent = '+' + (vpGain/1000).toFixed(1) + 'K';
                        document.getElementById('chart-vp-potential').textContent = (potentialVp/1000).toFixed(1) + 'K';
                        vpGainEl.classList.remove('hidden');
                    } else {
                        vpGainEl.classList.add('hidden');
                    }
                }
                
                // Show/hide market value calculator for unminted backing
                const marketCalcEl = document.getElementById('chart-market-calc');
                if (marketCalcEl) {
                    if (metricKey === 'unmintedTotalBacking_LUNA') {
                        marketCalcEl.classList.remove('hidden');
                        window.chartNftType = 'unbroken';
                        document.getElementById('chart-unminted-result')?.classList.add('hidden');
                    } else {
                        marketCalcEl.classList.add('hidden');
                    }
                }
                
                if (chartData.length === 0) {
                    noData.classList.remove('hidden');
                    return;
                }
                
                // Store chart data globally for toggle functionality
                window.currentChartData = chartData;
                
                canvas.style.display = 'block';
                buildChart(chartData, metric);
                await buildDataTable(chartData, metric);
            }
            
            // --- Switch chart metric without closing modal ---
            window.switchChartMetric = async function(metricKey) {
                if (!chartMetrics[metricKey]) return;
                
                const loading = document.getElementById('chart-loading');
                const noData = document.getElementById('chart-no-data');
                const title = document.getElementById('chart-modal-title');
                const canvas = document.getElementById('historyChart');
                
                currentChartMetric = metricKey;
                chartSelectedPoints = [];
                
                // Update title
                const metric = chartMetrics[metricKey];
                title.textContent = metric ? metric.label + ' History' : 'Historical Data';
                
                // Show loading
                loading.classList.remove('hidden');
                noData.classList.add('hidden');
                canvas.style.display = 'none';
                
                // Reset comparison UI
                resetComparisonUI();
                
                // Fetch data (should be cached)
                const snapshots = await fetchAllSnapshots();
                loading.classList.add('hidden');
                
                if (snapshots.length === 0) {
                    noData.classList.remove('hidden');
                    return;
                }
                
                // Build chart data
                const chartData = snapshots.map(s => {
                    let value = null;
                    let secondaryValue = null;
                    
                    if (metricKey === 'tlaDepositsTotal_USD' && s.tlaDeposits) {
                        value = s.tlaDeposits.totalDeposit || s.tlaDepositsTotal_USD;
                    } else if (metricKey === 'tlaDepositsApr') {
                        value = s.tlaDeposits?.estApr || null;
                        secondaryValue = s.tlaDeposits?.totalDeposit || s.tlaDepositsTotal_USD;
                    } else if (metricKey === 'tlaVpTotal_LUNA') {
                        value = s.tlaVpTotal_LUNA;
                        if (!value && s.tlaVpTotal_USD && s.lunaPrice_USD) {
                            value = s.tlaVpTotal_USD / s.lunaPrice_USD;
                        }
                        if (metric.usdKey) secondaryValue = s[metric.usdKey];
                    } else if (metricKey === 'daoHeldNfts') {
                        value = s.daoHeldNfts !== undefined ? s.daoHeldNfts : 1000;
                    } else if (metricKey === 'daodaoStaked') {
                        value = s.daodaoStaked;
                        if (s.circulatingSupply && s.daodaoStaked) {
                            secondaryValue = (s.daodaoStaked / s.circulatingSupply) * 100;
                        }
                    } else {
                        value = s[metricKey];
                    }
                    
                    if (metric.usdKey && !secondaryValue) {
                        secondaryValue = s[metric.usdKey];
                    } else if (metric.secondaryKey && !secondaryValue && metric.secondaryKey !== 'daodaoStakedPercent') {
                        secondaryValue = s[metric.secondaryKey];
                    }
                    
                    return {
                        epoch: s.epoch,
                        timestamp: s.timestamp,
                        value: value,
                        secondaryValue: secondaryValue,
                        lunaPrice: s.lunaPrice_USD,
                        estApr: s.tlaDeposits?.estApr || null
                    };
                }).filter(d => d.value !== null && d.value !== undefined);
                
                // Show/hide secondary axis toggle for TLA Deposits
                const toggleEl = document.getElementById('chart-secondary-toggle');
                if (toggleEl) {
                    if (metricKey === 'tlaDepositsTotal_USD') {
                        toggleEl.classList.remove('hidden');
                        window.chartSecondaryMode = 'apr';
                        updateToggleButtons('apr');
                    } else {
                        toggleEl.classList.add('hidden');
                        window.chartSecondaryMode = 'luna';
                    }
                }
                
                // Show/hide VP gain indicator
                const vpGainEl = document.getElementById('chart-vp-gain-indicator');
                if (vpGainEl) {
                    if (metricKey === 'tlaVpTotal_LUNA') {
                        const tlaVpData = window.tlaVpData || {};
                        const currentVp = tlaVpData.totalVp || 638900;
                        const potentialVp = tlaVpData.potentialVp || 651400;
                        const vpGain = potentialVp - currentVp;
                        
                        document.getElementById('chart-vp-current').textContent = (currentVp/1000).toFixed(1) + 'K';
                        document.getElementById('chart-vp-gain').textContent = '+' + (vpGain/1000).toFixed(1) + 'K';
                        document.getElementById('chart-vp-potential').textContent = (potentialVp/1000).toFixed(1) + 'K';
                        vpGainEl.classList.remove('hidden');
                    } else {
                        vpGainEl.classList.add('hidden');
                    }
                }
                
                if (chartData.length === 0) {
                    noData.classList.remove('hidden');
                    return;
                }
                
                window.currentChartData = chartData;
                
                canvas.style.display = 'block';
                buildChart(chartData, metric);
                await buildDataTable(chartData, metric);
            }
            
            // Update toggle button styles (global function for onclick)
            window.updateToggleButtons = function(mode) {
                const aprBtn = document.getElementById('toggle-apr');
                const lunaBtn = document.getElementById('toggle-luna');
                if (aprBtn && lunaBtn) {
                    if (mode === 'apr') {
                        aprBtn.className = 'px-3 py-1 text-xs rounded-md bg-cyan-600 text-white transition-colors';
                        lunaBtn.className = 'px-3 py-1 text-xs rounded-md text-gray-400 hover:text-white transition-colors';
                    } else {
                        lunaBtn.className = 'px-3 py-1 text-xs rounded-md bg-orange-600 text-white transition-colors';
                        aprBtn.className = 'px-3 py-1 text-xs rounded-md text-gray-400 hover:text-white transition-colors';
                    }
                }
            }
            
            // Toggle secondary axis between APR and LUNA Price (global function for onclick)
            window.toggleChartSecondary = function(mode) {
                window.chartSecondaryMode = mode;
                window.updateToggleButtons(mode);
                
                // Rebuild chart with new secondary data
                const metric = chartMetrics[currentChartMetric];
                if (metric && window.currentChartData) {
                    buildChart(window.currentChartData, metric);
                }
            }
            
            // --- Build Chart.js chart ---
            function buildChart(data, metric) {
                const ctx = document.getElementById('historyChart').getContext('2d');
                
                // Destroy existing chart
                if (historyChart) {
                    historyChart.destroy();
                }
                
                const labels = data.map(d => {
                    const date = new Date(d.timestamp);
                    return `E${d.epoch} (${date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })})`;
                });
                
                // For VP metrics, use the FIXED VP from TLA file (same for all epochs)
                const isVpMetric = metric.isVpMetric;
                let values;
                
                if (isVpMetric) {
                    // Get fixed VP from TLA data
                    const tlaVpData = window.tlaVpData || null;
                    const fixedTotalVp = tlaVpData?.totalVp || 638900;
                    // All data points show the same fixed VP (since no adjustments were made)
                    values = data.map(d => fixedTotalVp);
                } else {
                    values = data.map(d => d.value);
                }
                
                // Check for secondary data (either usdKey or secondaryKey)
                const hasSecondaryData = (metric.usdKey || metric.secondaryKey) && data.some(d => d.secondaryValue !== null && d.secondaryValue !== undefined);
                const secondaryValues = hasSecondaryData ? data.map(d => d.secondaryValue) : [];
                
                // For TLA Deposits, check toggle mode to determine secondary axis
                const isTlaDeposits = metric.label.includes('TLA Deposits');
                const useAprAsSecondary = isTlaDeposits && window.chartSecondaryMode === 'apr';
                
                // Determine secondary config based on toggle mode
                let secondaryLabel, secondaryColor, secondaryFormat, actualSecondaryValues;
                
                if (useAprAsSecondary) {
                    // Use Est APR as secondary
                    secondaryLabel = 'Est APR';
                    secondaryColor = '#06b6d4'; // cyan
                    secondaryFormat = (v) => v.toFixed(2) + '%';
                    actualSecondaryValues = data.map(d => d.estApr).filter(v => v !== null && v !== undefined);
                    // Only show if we have APR data
                    if (actualSecondaryValues.length === 0) {
                        actualSecondaryValues = [];
                    } else {
                        actualSecondaryValues = data.map(d => d.estApr);
                    }
                } else {
                    // Use LUNA Price or default secondary
                    secondaryLabel = isTlaDeposits ? 'LUNA Price' : (metric.usdLabel || metric.secondaryLabel || 'Secondary');
                    secondaryColor = isTlaDeposits ? '#f97316' : (metric.usdColor || metric.secondaryColor || '#22c55e');
                    secondaryFormat = isTlaDeposits ? ((v) => '$' + v.toFixed(4)) : (metric.secondaryFormat || ((v) => metric.usdKey ? '$' + v.toLocaleString('en-US', {maximumFractionDigits: 2}) : v.toFixed(4)));
                    actualSecondaryValues = isTlaDeposits ? data.map(d => d.lunaPrice) : secondaryValues;
                }
                
                const hasActualSecondaryData = actualSecondaryValues.length > 0 && actualSecondaryValues.some(v => v !== null && v !== undefined);
                
                // Build datasets
                const datasets = [{
                    label: isVpMetric ? 'Current VP (fixed)' : metric.label,
                    data: values,
                    borderColor: metric.color,
                    backgroundColor: metric.color + '20',
                    fill: false,
                    tension: 0.3,
                    pointRadius: 6,
                    pointHoverRadius: 10,
                    pointBackgroundColor: metric.color,
                    pointBorderColor: '#1a1a1a',
                    pointBorderWidth: 2,
                    yAxisID: 'y'
                }];
                
                // For VP metrics, add potential VP line and USD values on right axis
                if (isVpMetric) {
                    const tlaVpData = window.tlaVpData || null;
                    const potentialVp = tlaVpData?.potentialVp || 651400;
                    const currentVp = tlaVpData?.totalVp || 638900;
                    const vpGain = potentialVp - currentVp;
                    
                    // Potential VP line (flat dotted line at top) - purple to differentiate from USD
                    datasets.push({
                        label: `Potential VP (+${(vpGain/1000).toFixed(1)}K if adjusted)`,
                        data: data.map(d => potentialVp),
                        borderColor: '#a855f7', // purple
                        backgroundColor: '#a855f720',
                        fill: false,
                        tension: 0,
                        pointRadius: 0,
                        borderDash: [8, 4],
                        borderWidth: 2,
                        yAxisID: 'y'
                    });
                    
                    // USD Value on right axis - get from snapshot data
                    const usdValues = data.map((d, idx) => {
                        // For latest, use live USD
                        if (idx === data.length - 1 && tlaVpData?.totalUsd) {
                            return tlaVpData.totalUsd;
                        }
                        // For historical, use secondaryValue which should be tlaVpTotal_USD
                        return d.secondaryValue || null;
                    });
                    
                    const hasUsdData = usdValues.some(v => v !== null && v > 0);
                    if (hasUsdData) {
                        datasets.push({
                            label: 'USD Value',
                            data: usdValues,
                            borderColor: '#22c55e', // green
                            backgroundColor: '#22c55e20',
                            fill: false,
                            tension: 0.3,
                            pointRadius: 4,
                            pointHoverRadius: 8,
                            pointBackgroundColor: '#22c55e',
                            pointBorderColor: '#1a1a1a',
                            pointBorderWidth: 2,
                            borderDash: [3, 3],
                            yAxisID: 'y1'
                        });
                    }
                }
                
                // Add secondary dataset if available (but not for VP metrics - they have potential VP line instead)
                if (hasActualSecondaryData && !isVpMetric) {
                    datasets.push({
                        label: secondaryLabel,
                        data: actualSecondaryValues,
                        borderColor: secondaryColor,
                        backgroundColor: secondaryColor + '20',
                        fill: false,
                        tension: 0.3,
                        pointRadius: 4,
                        pointHoverRadius: 8,
                        pointBackgroundColor: secondaryColor,
                        pointBorderColor: '#1a1a1a',
                        pointBorderWidth: 2,
                        borderDash: [5, 5],
                        yAxisID: 'y1'
                    });
                }
                
                // Build scales
                const scales = {
                    x: {
                        grid: { color: '#374151' },
                        ticks: { color: '#9ca3af' }
                    },
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        grid: { color: '#374151' },
                        ticks: { 
                            color: metric.color,
                            callback: (value) => {
                                if (value >= 1000000) return (value/1000000).toFixed(1) + 'M';
                                if (value >= 1000) return (value/1000).toFixed(1) + 'K';
                                return value.toFixed(2);
                            }
                        },
                        title: {
                            display: true,
                            text: isVpMetric ? 'Voting Power' : metric.label.split('(')[0].trim(),
                            color: metric.color
                        }
                    }
                };
                
                // Add USD axis for VP metrics
                if (isVpMetric) {
                    scales.y1 = {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        grid: { drawOnChartArea: false },
                        ticks: { 
                            color: '#22c55e',
                            callback: (value) => {
                                if (value >= 1000000) return '$' + (value/1000000).toFixed(1) + 'M';
                                if (value >= 1000) return '$' + (value/1000).toFixed(1) + 'K';
                                return '$' + value.toFixed(0);
                            }
                        },
                        title: {
                            display: true,
                            text: 'USD Value',
                            color: '#22c55e'
                        }
                    };
                }
                
                // Add second Y axis for secondary data (non-VP metrics)
                if (hasActualSecondaryData && !isVpMetric) {
                    scales.y1 = {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        grid: { drawOnChartArea: false },
                        ticks: { 
                            color: secondaryColor,
                            callback: (value) => {
                                // Format based on type
                                if (useAprAsSecondary) {
                                    return value.toFixed(1) + '%';
                                } else if (isTlaDeposits) {
                                    return '$' + value.toFixed(3);
                                } else if (metric.usdKey) {
                                    if (value >= 1000000) return '$' + (value/1000000).toFixed(1) + 'M';
                                    if (value >= 1000) return '$' + (value/1000).toFixed(1) + 'K';
                                    return '$' + value.toFixed(2);
                                } else if (metric.secondaryKey === 'lunaPrice_USD') {
                                    return '$' + value.toFixed(3);
                                } else if (metric.secondaryKey === 'daodaoStakedPercent') {
                                    return value.toFixed(1) + '%';
                                } else if (metric.secondaryKey === 'ampLUNA_LUNA_Ratio') {
                                    return value.toFixed(3) + 'x';
                                } else {
                                    return value.toFixed(2);
                                }
                            }
                        },
                        title: {
                            display: true,
                            text: secondaryLabel,
                            color: secondaryColor
                        }
                    };
                }
                
                historyChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        },
                        onClick: (event, elements) => {
                            if (elements.length > 0) {
                                const index = elements[0].index;
                                handlePointClick(data[index], index);
                            }
                        },
                        plugins: {
                            legend: {
                                display: hasSecondaryData || isVpMetric, // Show legend for VP metrics
                                labels: { color: '#9ca3af' }
                            },
                            tooltip: {
                                backgroundColor: '#1a1a1a',
                                borderColor: metric.color,
                                borderWidth: 1,
                                titleColor: '#fff',
                                bodyColor: '#9ca3af',
                                callbacks: {
                                    label: (context) => {
                                        if (context.datasetIndex === 0) {
                                            // For VP metrics, show the actual VP value
                                            if (isVpMetric) {
                                                return 'Current: ' + (context.raw / 1000).toFixed(1) + 'K VP';
                                            }
                                            return metric.format(context.raw);
                                        } else if (isVpMetric && context.datasetIndex === 1) {
                                            return 'Potential: ' + (context.raw / 1000).toFixed(1) + 'K VP';
                                        } else {
                                            return secondaryFormat(context.raw);
                                        }
                                    },
                                    afterBody: (tooltipItems) => {
                                        // Add LUNA price context if available
                                        const index = tooltipItems[0].dataIndex;
                                        if (data[index].lunaPrice && !metric.secondaryKey?.includes('lunaPrice')) {
                                            return ['', 'LUNA: $' + data[index].lunaPrice.toFixed(4)];
                                        }
                                        return [];
                                    }
                                }
                            }
                        },
                        scales: scales
                    }
                });
            }
            
            // --- Build data table ---
            async function buildDataTable(data, metric) {
                const tbody = document.getElementById('chart-data-table');
                const thead = tbody.closest('table').querySelector('thead tr');
                
                // Determine table type based on metric
                const isVpMetric = metric.isVpMetric;
                const isTreasuryOrDeposits = metric.label.includes('Treasury') || metric.label.includes('TLA Deposits');
                const hasSecondary = metric.secondaryKey || metric.usdKey;
                
                let html = '';
                
                // === VP METRIC TABLE ===
                if (isVpMetric) {
                    // Get current VP data from TLA file (set by buildTlaVp)
                    const tlaVpData = window.tlaVpData || null;
                    const fixedTotalVp = tlaVpData?.totalVp || 638900;
                    const currentLunaPrice = window.cachedPriceData?.['terra-luna-2']?.usd || 0;
                    
                    // Get lock amounts for calculating underlying LUNA
                    const lockAmounts = tlaVpData?.locks || [
                        { asset: 'arbLUNA', amount: 27290 },
                        { asset: 'ampLUNA', amount: 413.03 }
                    ];
                    
                    if (thead) {
                        thead.innerHTML = `
                            <th class="text-left p-2">Epoch</th>
                            <th class="text-left p-2">Date</th>
                            <th class="text-right p-2">Current VP</th>
                            <th class="text-right p-2">Underlying LUNA</th>
                            <th class="text-right p-2">Potential VP</th>
                            <th class="text-right p-2">Value</th>
                        `;
                    }
                    
                    // Fetch snapshots to get historical ratios
                    const snapshots = await fetchAllSnapshots();
                    
                    for (let i = 0; i < data.length; i++) {
                        const d = data[i];
                        const date = new Date(d.timestamp);
                        const isLatest = (i === data.length - 1);
                        
                        // Find corresponding snapshot for this epoch
                        const snapshot = snapshots.find(s => s.epoch == d.epoch) || {};
                        
                        // Current VP is FIXED from TLA file
                        const currentVp = fixedTotalVp;
                        
                        // Check if we have REAL captured LST ratios in the NEW lst_ratios format
                        // OLD format (ampLUNA_LUNA_Ratio in snapshot root) doesn't count - that was auto-captured differently
                        const snapshotLstRatios = snapshot.tlaDeposits?.lstRatios || snapshot.lstRatios || {};
                        const hasNewFormatRatios = snapshotLstRatios.ampLUNA && snapshotLstRatios.arbLUNA;
                        
                        let underlyingLuna = null;
                        let potentialVp = null;
                        let hasValidRatios = false;
                        
                        if (isLatest && tlaVpData?.totalUnderlyingLuna) {
                            // Most recent - use live data
                            underlyingLuna = tlaVpData.totalUnderlyingLuna;
                            potentialVp = Math.floor(underlyingLuna * 10);
                            hasValidRatios = true;
                        } else if (hasNewFormatRatios) {
                            // Has properly captured LST ratios in new format
                            const ampRate = snapshotLstRatios.ampLUNA;
                            const arbRate = snapshotLstRatios.arbLUNA;
                            
                            underlyingLuna = 0;
                            lockAmounts.forEach(lock => {
                                if (lock.asset === 'arbLUNA') underlyingLuna += lock.amount * arbRate;
                                else if (lock.asset === 'ampLUNA') underlyingLuna += lock.amount * ampRate;
                            });
                            
                            if (underlyingLuna > 0) {
                                potentialVp = Math.floor(underlyingLuna * 10);
                                hasValidRatios = true;
                            }
                        }
                        // If no new format ratios, leave as null (will show red/blank)
                        
                        const boostPct = (hasValidRatios && potentialVp) ? (((potentialVp - fixedTotalVp) / fixedTotalVp) * 100).toFixed(1) : null;
                        
                        // Get USD value from TLA data locks (this IS captured in the tla-data file!)
                        let usdValue = null;
                        if (isLatest && tlaVpData?.totalUsd) {
                            // Live USD from current calculation
                            usdValue = tlaVpData.totalUsd;
                        } else {
                            // Try to get captured USD from snapshot
                            // Option 1: tlaVpLocks array with usd per lock
                            const tlaVpLocks = snapshot.tlaVpLocks || [];
                            if (tlaVpLocks.length > 0 && tlaVpLocks.some(l => l.usd)) {
                                usdValue = tlaVpLocks.reduce((sum, lock) => sum + (lock.usd || 0), 0);
                            }
                            // Option 2: tlaVpTotal_USD field
                            else if (snapshot.tlaVpTotal_USD && snapshot.tlaVpTotal_USD > 0) {
                                usdValue = snapshot.tlaVpTotal_USD;
                            }
                        }
                        
                        // Display for underlying LUNA
                        let underlyingDisplay, potentialDisplay, valueDisplay;
                        
                        if (hasValidRatios && underlyingLuna !== null) {
                            const liveIndicator = isLatest ? '<span class="pulse-dot ml-1"></span>' : '';
                            const liveLabel = isLatest ? '<span class="text-green-400 text-[9px]">LIVE</span>' : '<span class="text-gray-600 text-[9px]">@snap</span>';
                            underlyingDisplay = `
                                <span class="text-white">${underlyingLuna.toLocaleString('en-US', {maximumFractionDigits: 0})}</span>
                                ${liveIndicator}
                                <span class="block">${liveLabel}</span>`;
                            potentialDisplay = `
                                <span class="text-cyan-400">${(potentialVp / 1000).toFixed(1)}K</span>
                                <span class="text-green-400 text-[9px] block">+${boostPct}%</span>`;
                        } else {
                            // No valid ratios - show red/blank with tooltip
                            underlyingDisplay = `
                                <span class="text-red-400" title="LST ratios not captured in lst_ratios format">--</span>
                                <span class="text-red-400 text-[9px] block"> no ratio</span>`;
                            potentialDisplay = `
                                <span class="text-red-400" title="Cannot calculate without LST ratios">--</span>
                                <span class="text-red-400 text-[9px] block"></span>`;
                        }
                        
                        // Value display - use captured USD from locks
                        if (usdValue !== null && usdValue > 0) {
                            const liveIndicator = isLatest ? '<span class="pulse-dot ml-1"></span>' : '';
                            const label = isLatest ? '<span class="text-green-400 text-[9px]">LIVE</span>' : '<span class="text-gray-600 text-[9px]">@snap</span>';
                            valueDisplay = `<span class="text-green-400">$${usdValue.toLocaleString('en-US', {maximumFractionDigits: 0})}</span>${liveIndicator}
                                <span class="block">${label}</span>`;
                        } else {
                            valueDisplay = `<span class="text-red-400" title="USD value not captured">--</span>
                                <span class="text-red-400 text-[9px] block"></span>`;
                        }
                        
                        html += `
                            <tr class="border-t border-gray-700 hover:bg-gray-800/50 cursor-pointer ${isLatest ? 'bg-gray-800/30' : ''}" data-index="${i}" onclick="handlePointClick(chartDataGlobal[${i}], ${i})">
                                <td class="p-2 text-cyan-400 font-medium">E${d.epoch}</td>
                                <td class="p-2 text-gray-300">${date.toLocaleDateString()}</td>
                                <td class="p-2 text-right font-mono">
                                    <span class="text-purple-300">${(currentVp / 1000).toFixed(1)}K</span>
                                    <span class="text-gray-600 text-[9px] block">fixed</span>
                                </td>
                                <td class="p-2 text-right font-mono">${underlyingDisplay}</td>
                                <td class="p-2 text-right font-mono">${potentialDisplay}</td>
                                <td class="p-2 text-right font-mono">${valueDisplay}</td>
                            </tr>`;
                    }
                }
                // === TREASURY / TLA DEPOSITS TABLE (with Details button) ===
                else if (isTreasuryOrDeposits) {
                    // Fetch snapshots to get APR data
                    const snapshots = await fetchAllSnapshots();
                    const isTlaDeposits = metric.label.includes('TLA Deposits');
                    
                    if (thead) {
                        if (isTlaDeposits) {
                            thead.innerHTML = `
                                <th class="text-left p-2">Epoch</th>
                                <th class="text-left p-2">Date</th>
                                <th class="text-right p-2">Value</th>
                                <th class="text-right p-2">Est APR</th>
                                <th class="text-right p-2">LUNA Price</th>
                                <th class="text-center p-2">Details</th>
                            `;
                        } else {
                            thead.innerHTML = `
                                <th class="text-left p-2">Epoch</th>
                                <th class="text-left p-2">Date</th>
                                <th class="text-right p-2">Value</th>
                                <th class="text-right p-2">LUNA Price</th>
                                <th class="text-center p-2">Details</th>
                            `;
                        }
                    }
                    
                    for (let i = 0; i < data.length; i++) {
                        const d = data[i];
                        const date = new Date(d.timestamp);
                        const prevData = i > 0 ? data[i-1] : null;
                        
                        // Find corresponding snapshot for APR
                        const snapshot = snapshots.find(s => s.epoch == d.epoch) || {};
                        const prevSnapshot = i > 0 ? snapshots.find(s => s.epoch == data[i-1].epoch) : null;
                        
                        // Value with change
                        const valueChange = prevData ? d.value - prevData.value : 0;
                        const valueChangeClass = valueChange > 0 ? 'text-green-400' : valueChange < 0 ? 'text-red-400' : 'text-gray-500';
                        const sign = valueChange >= 0 ? '+' : '-';
                        const changeStr = prevData ? `<span class="${valueChangeClass} text-xs">${sign}$${Math.abs(valueChange).toLocaleString('en-US', {maximumFractionDigits: 0})}</span>` : '<span class="text-gray-600 text-xs">--</span>';
                        
                        // Est APR with % change (for TLA Deposits only)
                        let aprDisplay = '';
                        if (isTlaDeposits) {
                            const currentApr = snapshot.tlaDeposits?.estApr;
                            const prevApr = prevSnapshot?.tlaDeposits?.estApr;
                            
                            if (currentApr !== undefined && currentApr !== null) {
                                const aprStr = currentApr.toFixed(2) + '%';
                                if (prevApr !== undefined && prevApr !== null) {
                                    const aprDiff = currentApr - prevApr;
                                    const aprDiffClass = aprDiff > 0 ? 'text-green-400' : aprDiff < 0 ? 'text-red-400' : 'text-gray-400';
                                    const aprDiffStr = (aprDiff >= 0 ? '+' : '') + aprDiff.toFixed(2) + '%';
                                    aprDisplay = `<span class="text-cyan-400">${aprStr}</span> <span class="${aprDiffClass} text-xs">${aprDiffStr}</span>`;
                                } else {
                                    aprDisplay = `<span class="text-cyan-400">${aprStr}</span> <span class="text-gray-600 text-xs">--</span>`;
                                }
                            } else {
                                aprDisplay = '<span class="text-gray-600">--</span>';
                            }
                        }
                        
                        // LUNA price with % change
                        let lunaPriceDisplay = '<span class="text-gray-600">--</span>';
                        if (d.lunaPrice) {
                            const priceStr = '$' + d.lunaPrice.toFixed(4);
                            if (prevData && prevData.lunaPrice) {
                                const pctChg = ((d.lunaPrice - prevData.lunaPrice) / prevData.lunaPrice) * 100;
                                const pctClass = pctChg > 0 ? 'text-green-400' : pctChg < 0 ? 'text-red-400' : 'text-gray-400';
                                const pctStr = (pctChg >= 0 ? '+' : '') + pctChg.toFixed(2) + '%';
                                lunaPriceDisplay = `<span class="text-orange-400">${priceStr}</span> <span class="${pctClass} text-xs">${pctStr}</span>`;
                            } else {
                                lunaPriceDisplay = `<span class="text-orange-400">${priceStr}</span> <span class="text-gray-600 text-xs">--</span>`;
                            }
                        }
                        
                        if (isTlaDeposits) {
                            html += `
                                <tr class="border-t border-gray-700 hover:bg-gray-800/50" data-index="${i}" data-epoch="${d.epoch}">
                                    <td class="p-2 text-cyan-400 font-medium cursor-pointer" onclick="handlePointClick(chartDataGlobal[${i}], ${i})">E${d.epoch}</td>
                                    <td class="p-2 text-gray-300">${date.toLocaleDateString()}</td>
                                    <td class="p-2 text-right font-mono"><span class="text-white">${metric.format(d.value)}</span> ${changeStr}</td>
                                    <td class="p-2 text-right font-mono">${aprDisplay}</td>
                                    <td class="p-2 text-right font-mono">${lunaPriceDisplay}</td>
                                    <td class="p-2 text-center">
                                        <button class="details-btn px-2 py-1 text-xs bg-gray-700 hover:bg-cyan-700 rounded text-gray-300 hover:text-white transition-colors" data-epoch="${d.epoch}">
                                            <i class="fas fa-info-circle"></i>
                                        </button>
                                    </td>
                                </tr>`;
                        } else {
                            html += `
                                <tr class="border-t border-gray-700 hover:bg-gray-800/50" data-index="${i}" data-epoch="${d.epoch}">
                                    <td class="p-2 text-cyan-400 font-medium cursor-pointer" onclick="handlePointClick(chartDataGlobal[${i}], ${i})">E${d.epoch}</td>
                                    <td class="p-2 text-gray-300">${date.toLocaleDateString()}</td>
                                    <td class="p-2 text-right font-mono"><span class="text-white">${metric.format(d.value)}</span> ${changeStr}</td>
                                    <td class="p-2 text-right font-mono">${lunaPriceDisplay}</td>
                                    <td class="p-2 text-center">
                                        <button class="details-btn px-2 py-1 text-xs bg-gray-700 hover:bg-cyan-700 rounded text-gray-300 hover:text-white transition-colors" data-epoch="${d.epoch}">
                                            <i class="fas fa-info-circle"></i>
                                        </button>
                                    </td>
                                </tr>`;
                        }
                    }
                }
                // === STANDARD TABLE (all other metrics) ===
                else {
                    // Build header based on what secondary data we have
                    let headerHtml = `
                        <th class="text-left p-2">Epoch</th>
                        <th class="text-left p-2">Date</th>
                        <th class="text-right p-2">Value</th>
                    `;
                    
                    if (hasSecondary) {
                        const secondaryLabel = metric.usdLabel || metric.secondaryLabel || 'Secondary';
                        headerHtml += `<th class="text-right p-2">${secondaryLabel}</th>`;
                    }
                    
                    headerHtml += `<th class="text-right p-2">% Chg</th><th class="text-right p-2">Change</th>`;
                    
                    if (thead) {
                        thead.innerHTML = headerHtml;
                    }
                    
                    for (let i = 0; i < data.length; i++) {
                        const d = data[i];
                        const date = new Date(d.timestamp);
                        const prevData = i > 0 ? data[i-1] : null;
                        
                        // Value change
                        const valueChange = prevData ? d.value - prevData.value : 0;
                        const valueChangeClass = valueChange > 0 ? 'text-green-400' : valueChange < 0 ? 'text-red-400' : 'text-gray-500';
                        
                        // Percent change
                        let pctChangeDisplay = '--';
                        let pctChangeClass = 'text-gray-500';
                        if (prevData && prevData.value !== 0) {
                            const pctChg = ((d.value - prevData.value) / prevData.value) * 100;
                            pctChangeDisplay = (pctChg >= 0 ? '+' : '') + pctChg.toFixed(2) + '%';
                            pctChangeClass = pctChg > 0 ? 'text-green-400' : pctChg < 0 ? 'text-red-400' : 'text-gray-500';
                        }
                        
                        // Format change
                        let changeDisplay = '--';
                        if (prevData) {
                            const prefix = valueChange >= 0 ? '+' : '';
                            if (metric.label.includes('$') || metric.label.includes('USD')) {
                                changeDisplay = valueChange >= 0 ? '+$' + Math.abs(valueChange).toLocaleString('en-US', {maximumFractionDigits: 2}) : '-$' + Math.abs(valueChange).toLocaleString('en-US', {maximumFractionDigits: 2});
                            } else if (metric.label.includes('LUNA')) {
                                changeDisplay = prefix + valueChange.toFixed(2);
                            } else if (metric.label.includes('%')) {
                                changeDisplay = prefix + valueChange.toFixed(2) + '%';
                            } else {
                                changeDisplay = prefix + valueChange.toLocaleString();
                            }
                        }
                        
                        // Secondary value
                        let secondaryDisplay = '';
                        if (hasSecondary) {
                            const secondaryFormat = metric.secondaryFormat || ((v) => metric.usdKey ? '$' + v.toLocaleString('en-US', {maximumFractionDigits: 2}) : v.toFixed(4));
                            secondaryDisplay = d.secondaryValue !== null && d.secondaryValue !== undefined 
                                ? `<td class="p-2 text-right font-mono text-gray-400">${secondaryFormat(d.secondaryValue)}</td>`
                                : `<td class="p-2 text-right font-mono text-gray-600">--</td>`;
                        }
                        
                        html += `
                            <tr class="border-t border-gray-700 hover:bg-gray-800/50 cursor-pointer" data-index="${i}" onclick="handlePointClick(chartDataGlobal[${i}], ${i})">
                                <td class="p-2 text-cyan-400 font-medium">E${d.epoch}</td>
                                <td class="p-2 text-gray-300">${date.toLocaleDateString()}</td>
                                <td class="p-2 text-right font-mono text-white">${metric.format(d.value)}</td>
                                ${secondaryDisplay}
                                <td class="p-2 text-right font-mono ${pctChangeClass}">${pctChangeDisplay}</td>
                                <td class="p-2 text-right font-mono ${valueChangeClass}">${changeDisplay}</td>
                            </tr>`;
                    }
                }
                
                // Store data globally for click handlers
                window.chartDataGlobal = data;
                
                tbody.innerHTML = html;
                
                // Add click handlers for Details buttons (only for Treasury/Deposits tables)
                if (isTreasuryOrDeposits) {
                    tbody.querySelectorAll('.details-btn').forEach(btn => {
                        btn.addEventListener('click', async (e) => {
                            e.stopPropagation();
                            const epoch = btn.dataset.epoch;
                            await showEpochDetailsPopup(epoch, btn);
                        });
                    });
                }
            }
            
            // Show epoch details popup with token breakdown
            async function showEpochDetailsPopup(epoch, anchorEl) {
                // Find the snapshot data for this epoch
                const snapshots = await fetchAllSnapshots();
                const snapshot = snapshots.find(s => s.epoch == epoch);
                
                if (!snapshot) {
                    showMiniPopup(`Epoch ${epoch} Details`, '<p class="text-gray-500">No detailed data available for this epoch</p>', anchorEl);
                    return;
                }
                
                let content = `<div class="text-xs space-y-3">`;
                
                // Summary section
                content += `<div class="bg-gray-800/50 rounded p-2">`;
                content += `<div class="grid grid-cols-2 gap-x-4 gap-y-1">`;
                content += `<div><span class="text-gray-500">Treasury:</span> <span class="text-white font-mono">$${(snapshot.treasuryTotal_USD || 0).toLocaleString()}</span></div>`;
                content += `<div><span class="text-gray-500">LUNA:</span> <span class="text-orange-400 font-mono">$${(snapshot.lunaPrice_USD || 0).toFixed(4)}</span></div>`;
                if (snapshot.tlaDepositsTotal_USD) {
                    content += `<div><span class="text-gray-500">TLA Deposits:</span> <span class="text-pink-400 font-mono">$${snapshot.tlaDepositsTotal_USD.toLocaleString()}</span></div>`;
                }
                if (snapshot.backingPerNft_USD) {
                    content += `<div><span class="text-gray-500">Backing/NFT:</span> <span class="text-green-400 font-mono">$${snapshot.backingPerNft_USD.toFixed(2)}</span></div>`;
                }
                // Add APR if available
                if (snapshot.tlaDeposits?.estApr) {
                    content += `<div><span class="text-gray-500">Est. APR:</span> <span class="text-cyan-400 font-mono">${snapshot.tlaDeposits.estApr.toFixed(2)}%</span></div>`;
                }
                content += `</div></div>`;
                
                // TLA Deposits section - table with Amount, Value @ Snap, and Value Now
                content += `<div class="border-t border-gray-700 pt-2">`;
                content += `<div class="text-gray-400 font-medium mb-2">TLA Deposit Balances</div>`;
                content += `<table class="w-full text-[11px]">`;
                content += `<thead><tr class="text-gray-500 border-b border-gray-700"><th class="text-left py-1 pr-2">Token</th><th class="text-right py-1 px-1">Amount</th><th class="text-right py-1 px-1">@ Snap</th><th class="text-right py-1 pl-1">@ Now</th></tr></thead>`;
                content += `<tbody>`;
                
                if (snapshot.tlaDeposits?.tokenBalances && snapshot.tlaDeposits.tokenBalances.length > 0) {
                    // Get prices - try tokenPricesAtSnapshot first, then tokenPrices
                    const snapPrices = snapshot.tlaDeposits?.tokenPricesAtSnapshot || snapshot.tokenPrices || {};
                    
                    // Get LIVE prices from cached CoinGecko data
                    const livePrices = window.cachedPriceData || {};
                    const tokenToGeckoId = {
                        'LUNA': 'terra-luna-2',
                        'CAPA': 'capapult',
                        'ROAR': 'lion-dao',
                        'ASTRO': 'astroport-fi',
                        'ampLUNA': 'eris-amplified-luna',
                        'arbLUNA': null, // Calculated from ratio
                        'bLUNA': 'backbone-labs-staked-luna',
                        'xASTRO': null, // Calculated from ratio
                        'ampCAPA': null, // Calculated from ratio
                        'ampROAR': null // Calculated from ratio
                    };
                    
                    // Get LST ratios from snapshot (for snap values) and current (for live values)
                    const snapLstRatios = snapshot.tlaDeposits?.lstRatios || snapshot.lstRatios || snapshot.tlaDeposits?.ampRatios || {};
                    const currentLstRatios = window.lstRatios || {};
                    
                    const lstRatioMapSnap = {
                        'ampLUNA': { ratio: snapLstRatios.ampLUNA || snapshot.ampLUNA_LUNA_Ratio || 1.9015, baseName: 'LUNA', baseGecko: 'terra-luna-2' },
                        'arbLUNA': { ratio: snapLstRatios.arbLUNA || snapshot.arbLUNA_LUNA_Ratio || 2.6873, baseName: 'LUNA', baseGecko: 'terra-luna-2' },
                        'bLUNA': { ratio: snapLstRatios.bLUNA || 1.6048, baseName: 'LUNA', baseGecko: 'terra-luna-2' },
                        'ampCAPA': { ratio: snapLstRatios.ampCAPA || 1.1055, baseName: 'CAPA', baseGecko: 'capapult' },
                        'ampROAR': { ratio: snapLstRatios.ampROAR || 1.1087, baseName: 'ROAR', baseGecko: 'lion-dao' },
                        'xASTRO': { ratio: snapLstRatios.xASTRO || 1.22, baseName: 'ASTRO', baseGecko: 'astroport-fi' }
                    };
                    
                    const lstRatioMapLive = {
                        'ampLUNA': { ratio: currentLstRatios.ampLUNA || window.cachedAmpLunaRate || 1.9015, baseGecko: 'terra-luna-2' },
                        'arbLUNA': { ratio: currentLstRatios.arbLUNA || 2.6873, baseGecko: 'terra-luna-2' },
                        'bLUNA': { ratio: currentLstRatios.bLUNA || 1.6048, baseGecko: 'terra-luna-2' },
                        'ampCAPA': { ratio: currentLstRatios.ampCAPA || 1.1055, baseGecko: 'capapult' },
                        'ampROAR': { ratio: currentLstRatios.ampROAR || 1.1087, baseGecko: 'lion-dao' },
                        'xASTRO': { ratio: currentLstRatios.xASTRO || 1.22, baseGecko: 'astroport-fi' }
                    };
                    
                    let totalSnapValue = 0;
                    let totalLiveValue = 0;
                    
                    for (const token of snapshot.tlaDeposits.tokenBalances) {
                        const amtStr = token.amount >= 1000000 
                            ? (token.amount/1000000).toFixed(2) + 'M'
                            : token.amount >= 1000 
                                ? (token.amount/1000).toFixed(2) + 'K'
                                : token.amount.toFixed(2);
                        
                        // === SNAP VALUE ===
                        let snapPrice = snapPrices[token.name];
                        let snapSource = 'direct';
                        if (!snapPrice && lstRatioMapSnap[token.name]) {
                            const lstInfo = lstRatioMapSnap[token.name];
                            const basePrice = snapPrices[lstInfo.baseName];
                            if (basePrice) {
                                snapPrice = basePrice * lstInfo.ratio;
                                snapSource = 'ratio';
                            }
                        }
                        
                        let snapValueDisplay = '<span class="text-red-400" title="Price not captured for this epoch">--</span>';
                        if (snapPrice) {
                            const snapValue = token.amount * snapPrice;
                            totalSnapValue += snapValue;
                            const ratioIndicator = snapSource === 'ratio' ? '<span class="text-gray-600 text-[8px]">r</span>' : '';
                            snapValueDisplay = `<span class="text-gray-400">$${snapValue >= 1000 ? (snapValue/1000).toFixed(1) + 'K' : snapValue.toFixed(0)}</span>${ratioIndicator}`;
                        }
                        
                        // === LIVE VALUE ===
                        let livePrice = null;
                        let liveSource = 'direct';
                        const geckoId = tokenToGeckoId[token.name];
                        
                        if (geckoId && livePrices[geckoId]?.usd) {
                            livePrice = livePrices[geckoId].usd;
                        } else if (lstRatioMapLive[token.name]) {
                            // Calculate from base token  ratio
                            const lstInfo = lstRatioMapLive[token.name];
                            const basePrice = livePrices[lstInfo.baseGecko]?.usd;
                            if (basePrice) {
                                livePrice = basePrice * lstInfo.ratio;
                                liveSource = 'ratio';
                            }
                        }
                        
                        let liveValueDisplay = '<span class="text-yellow-400" title="Live price unavailable">--</span>';
                        if (livePrice) {
                            const liveValue = token.amount * livePrice;
                            totalLiveValue += liveValue;
                            // Check if ratio is from current epoch or stale
                            const isStaleRatio = liveSource === 'ratio' && !window.lstRatios?.isCurrentEpoch;
                            const ratioIndicator = liveSource === 'ratio' 
                                ? (isStaleRatio ? '<span class="text-yellow-400 text-[8px]" title="Using ratio from old epoch">r</span>' : '<span class="text-gray-600 text-[8px]">r</span>')
                                : '';
                            liveValueDisplay = `<span class="text-green-400">$${liveValue >= 1000 ? (liveValue/1000).toFixed(1) + 'K' : liveValue.toFixed(0)}</span>${ratioIndicator}`;
                        }
                        
                        content += `<tr class="border-b border-gray-800/50">
                            <td class="py-1.5 pr-2 text-gray-300">${token.name}</td>
                            <td class="py-1.5 px-1 text-right font-mono text-white">${amtStr}</td>
                            <td class="py-1.5 px-1 text-right font-mono">${snapValueDisplay}</td>
                            <td class="py-1.5 pl-1 text-right font-mono">${liveValueDisplay}</td>
                        </tr>`;
                    }
                    
                    // Total row
                    content += `<tr class="border-t border-gray-600 font-bold">
                        <td class="py-1.5 pr-2 text-gray-400" colspan="2">Total</td>
                        <td class="py-1.5 px-1 text-right font-mono text-gray-400">${totalSnapValue > 0 ? '$' + (totalSnapValue >= 1000 ? (totalSnapValue/1000).toFixed(1) + 'K' : totalSnapValue.toFixed(0)) : '--'}</td>
                        <td class="py-1.5 pl-1 text-right font-mono text-green-400">${totalLiveValue > 0 ? '$' + (totalLiveValue >= 1000 ? (totalLiveValue/1000).toFixed(1) + 'K' : totalLiveValue.toFixed(0)) : '--'}</td>
                    </tr>`;
                } else {
                    content += `<tr><td colspan="4" class="py-3 text-center text-gray-600">
                        <i class="fas fa-info-circle mr-1"></i>TLA data not captured for this epoch
                    </td></tr>`;
                }
                content += `</tbody></table>`;
                
                // Show note about ratio calculations
                content += `<p class="text-[9px] text-gray-600 mt-2"><span class="text-gray-500">r</span> = calculated from base token  ratio</p>`;
                
                content += `</div>`;
                content += `</div>`;
                
                showMiniPopup(`E${epoch} Snapshot Details`, content, anchorEl);
            }
            
            // --- Handle point click for comparison ---
            function handlePointClick(dataPoint, index) {
                const metric = chartMetrics[currentChartMetric];
                
                if (chartSelectedPoints.length === 0) {
                    // First point selected
                    chartSelectedPoints = [{ data: dataPoint, index }];
                    updateComparisonUI();
                } else if (chartSelectedPoints.length === 1) {
                    // Second point selected
                    chartSelectedPoints.push({ data: dataPoint, index });
                    // Sort so Point A is always earlier
                    chartSelectedPoints.sort((a, b) => a.index - b.index);
                    updateComparisonUI();
                } else {
                    // Reset and start new selection
                    chartSelectedPoints = [{ data: dataPoint, index }];
                    updateComparisonUI();
                }
            }
            
            // --- Update comparison UI ---
            function updateComparisonUI() {
                const metric = chartMetrics[currentChartMetric];
                const pointADate = document.getElementById('point-a-date');
                const pointAValue = document.getElementById('point-a-value');
                const pointBDate = document.getElementById('point-b-date');
                const pointBValue = document.getElementById('point-b-value');
                const delta = document.getElementById('comparison-delta');
                const percent = document.getElementById('comparison-percent');
                const days = document.getElementById('comparison-days');
                
                if (chartSelectedPoints.length >= 1) {
                    const a = chartSelectedPoints[0].data;
                    const dateA = new Date(a.timestamp);
                    pointADate.textContent = `E${a.epoch} - ${dateA.toLocaleDateString()}`;
                    pointAValue.textContent = metric.format(a.value);
                    document.getElementById('comparison-point-a').classList.add('ring-2', 'ring-cyan-400');
                }
                
                if (chartSelectedPoints.length >= 2) {
                    const a = chartSelectedPoints[0].data;
                    const b = chartSelectedPoints[1].data;
                    const dateA = new Date(a.timestamp);
                    const dateB = new Date(b.timestamp);
                    
                    pointBDate.textContent = `E${b.epoch} - ${dateB.toLocaleDateString()}`;
                    pointBValue.textContent = metric.format(b.value);
                    document.getElementById('comparison-point-b').classList.add('ring-2', 'ring-teal-400');
                    
                    // Calculate delta
                    const diff = b.value - a.value;
                    const pct = ((diff / a.value) * 100);
                    const daysDiff = Math.round((dateB - dateA) / (1000 * 60 * 60 * 24));
                    
                    const isPositive = diff > 0;
                    delta.textContent = (isPositive ? '+' : '') + metric.format(diff).replace(/^\$/, (isPositive ? '+$' : '$'));
                    delta.className = `text-2xl font-bold ${isPositive ? 'text-green-400' : diff < 0 ? 'text-red-400' : 'text-white'}`;
                    
                    percent.textContent = (isPositive ? '+' : '') + pct.toFixed(2) + '%';
                    percent.className = `text-sm ${isPositive ? 'text-green-400' : pct < 0 ? 'text-red-400' : 'text-gray-400'}`;
                    
                    days.textContent = `${daysDiff} days`;
                }
            }
            
            // --- Reset comparison UI ---
            function resetComparisonUI() {
                document.getElementById('point-a-date').textContent = 'Click a point...';
                document.getElementById('point-a-value').textContent = '--';
                document.getElementById('point-b-date').textContent = 'Click another point...';
                document.getElementById('point-b-value').textContent = '--';
                document.getElementById('comparison-delta').textContent = '--';
                document.getElementById('comparison-delta').className = 'text-2xl font-bold text-white';
                document.getElementById('comparison-percent').textContent = '--';
                document.getElementById('comparison-percent').className = 'text-sm text-gray-400';
                document.getElementById('comparison-days').textContent = '--';
                document.getElementById('comparison-point-a').classList.remove('ring-2', 'ring-cyan-400');
                document.getElementById('comparison-point-b').classList.remove('ring-2', 'ring-teal-400');
            }
            
            // --- Add chart icons to tiles ---
            function setupChartIcons() {
                const iconMappings = [
                    { tileSelector: '#backing-per-nft-luna-live', metric: 'backingPerNft_LUNA', parentSelector: '.stat-card' },
                    { tileSelector: '#backing-per-nft-usd', metric: 'backingPerNft_USD', parentSelector: '.stat-card' },
                    { tileSelector: '#backing-per-nft-ampluna', metric: 'backingPerNft_ampLUNA', parentSelector: '.stat-card' },
                    { tileSelector: '#avg-daily-gain', metric: 'avgDailyGainPerNft_LUNA', parentSelector: '.stat-card' },
                    { tileSelector: '#dao-treasury-total', metric: 'treasuryTotal_USD', parentSelector: '.stat-card' },
                    { tileSelector: '#dao-tla-total', metric: 'tlaDepositsTotal_USD', parentSelector: '.stat-card' },
                    { tileSelector: '#dao-tla-vp', metric: 'tlaVpTotal_LUNA', parentSelector: '.stat-card' },
                    { tileSelector: '#daodao-staked', metric: 'daodaoStaked', parentSelector: '.stat-card' },
                    { tileSelector: '#enterprise-staked-holder', metric: 'enterpriseStaked', parentSelector: '.stat-card' },
                    { tileSelector: '#dao-members', metric: 'daoMembers', parentSelector: '.stat-card' },
                    { tileSelector: '#dao-broken-total', metric: 'daoHeldNfts', parentSelector: '.stat-card' },
                    { tileSelector: '#unminted-nft-backing-luna', metric: 'unmintedTotalBacking_LUNA', parentSelector: '.stat-card' }
                ];
                
                iconMappings.forEach(mapping => {
                    const valueEl = document.querySelector(mapping.tileSelector);
                    if (valueEl) {
                        const card = valueEl.closest(mapping.parentSelector);
                        if (card && !card.querySelector('.chart-icon')) {
                            const icon = document.createElement('div');
                            icon.className = 'chart-icon';
                            icon.innerHTML = '<i class="fas fa-chart-line"></i>';
                            icon.title = 'View historical data';
                            icon.dataset.metric = mapping.metric;
                            icon.addEventListener('click', (e) => {
                                e.stopPropagation(); // Prevent tile modal from opening
                                e.preventDefault(); // Prevent link navigation for anchor tags
                                openChartModal(mapping.metric);
                            });
                            card.appendChild(icon);
                        }
                    }
                });
                
                // Setup clear comparison button
                const clearBtn = document.getElementById('clear-comparison');
                if (clearBtn) {
                    clearBtn.addEventListener('click', () => {
                        chartSelectedPoints = [];
                        resetComparisonUI();
                    });
                }
                
                // Add chart modal to close handlers
                const chartModal = document.getElementById('chartModal');
                if (chartModal) {
                    chartModal.querySelector('.modal-close').addEventListener('click', () => {
                        chartModal.classList.add('opacity-0');
                        chartModal.querySelector('.modal-content').classList.add('opacity-0', 'scale-95');
                        setTimeout(() => chartModal.classList.add('hidden'), 300);
                    });
                    chartModal.addEventListener('click', (e) => {
                        if (e.target === chartModal) {
                            chartModal.classList.add('opacity-0');
                            chartModal.querySelector('.modal-content').classList.add('opacity-0', 'scale-95');
                            setTimeout(() => chartModal.classList.add('hidden'), 300);
                        }
                    });
                }
            }
            
            // --- Snapshot Mode Toggle ---
            window.snapshotMode = 'paste';
            
            window.setSnapshotMode = function(mode) {
                window.snapshotMode = mode;
                const pasteBtn = document.getElementById('snapshot-mode-paste');
                const manualBtn = document.getElementById('snapshot-mode-manual');
                const pasteMode = document.getElementById('snapshot-paste-mode');
                const manualMode = document.getElementById('snapshot-manual-mode');
                
                if (mode === 'paste') {
                    pasteBtn.className = 'flex-1 px-3 py-2 rounded bg-cyan-600 text-white text-sm font-medium transition-colors';
                    manualBtn.className = 'flex-1 px-3 py-2 rounded bg-gray-700 text-gray-400 text-sm font-medium transition-colors hover:bg-gray-600';
                    pasteMode.classList.remove('hidden');
                    manualMode.classList.add('hidden');
                } else {
                    manualBtn.className = 'flex-1 px-3 py-2 rounded bg-yellow-600 text-white text-sm font-medium transition-colors';
                    pasteBtn.className = 'flex-1 px-3 py-2 rounded bg-gray-700 text-gray-400 text-sm font-medium transition-colors hover:bg-gray-600';
                    pasteMode.classList.add('hidden');
                    manualMode.classList.remove('hidden');
                }
            }
            
            window.loadLastSnapshotValues = function() {
                // Get the most recent snapshot from loaded data
                if (!dashboardData.snapshots || dashboardData.snapshots.length === 0) {
                    alert('No previous snapshots found');
                    return;
                }
                
                const lastSnapshot = dashboardData.snapshots[dashboardData.snapshots.length - 1];
                const tlaData = lastSnapshot.tlaDeposits;
                
                if (!tlaData) {
                    alert('No TLA data in last snapshot');
                    return;
                }
                
                // Fill in the manual fields
                document.getElementById('manual-deposit-usd').value = tlaData.totalDeposit || '';
                document.getElementById('manual-apr').value = tlaData.estApr || '';
                
                // Fill in token balances
                if (tlaData.tokenBalances) {
                    for (const token of tlaData.tokenBalances) {
                        const input = document.getElementById('manual-token-' + token.name);
                        if (input) {
                            input.value = token.amount || '';
                        }
                    }
                }
                
                // Show status
                const statusDiv = document.getElementById('snapshot-status');
                if (statusDiv) {
                    statusDiv.classList.remove('hidden');
                    statusDiv.className = 'text-center text-sm text-green-400';
                    statusDiv.innerHTML = `<i class="fas fa-check mr-1"></i>Loaded values from E${lastSnapshot.epoch} (${new Date(lastSnapshot.timestamp).toLocaleDateString()})`;
                }
            }
            
            // --- Custom Token Prices ---
            let customTokenPriceCounter = 0;
            window.customTokenPrices = {}; // Store custom prices
            
            window.addCustomTokenRow = function(tokenName = '', tokenPrice = '') {
                const container = document.getElementById('custom-token-rows');
                if (!container) return;
                
                const rowId = 'custom-token-row-' + (++customTokenPriceCounter);
                const row = document.createElement('div');
                row.id = rowId;
                row.className = 'flex items-center gap-2';
                row.innerHTML = `
                    <input type="text" 
                           class="flex-1 bg-gray-900 border border-gray-600 rounded px-2 py-1.5 text-white font-mono text-sm focus:border-green-400 focus:outline-none" 
                           placeholder="Token name (e.g., ampCAPA)" 
                           value="${tokenName}"
                           onchange="updateCustomTokenPrice('${rowId}')">
                    <span class="text-gray-500">$</span>
                    <input type="number" 
                           class="w-32 bg-gray-900 border border-gray-600 rounded px-2 py-1.5 text-white font-mono text-sm focus:border-green-400 focus:outline-none" 
                           placeholder="0.00" 
                           step="0.000001"
                           value="${tokenPrice}"
                           onchange="updateCustomTokenPrice('${rowId}')">
                    <button onclick="removeCustomTokenRow('${rowId}')" class="text-red-400 hover:text-red-300 px-2">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                container.appendChild(row);
                
                // Update storage
                if (tokenName && tokenPrice) {
                    window.customTokenPrices[tokenName] = parseFloat(tokenPrice);
                }
            }
            
            window.removeCustomTokenRow = function(rowId) {
                const row = document.getElementById(rowId);
                if (row) {
                    // Get token name before removing to clean up storage
                    const tokenInput = row.querySelector('input[type="text"]');
                    if (tokenInput && tokenInput.value) {
                        delete window.customTokenPrices[tokenInput.value];
                    }
                    row.remove();
                }
            }
            
            window.updateCustomTokenPrice = function(rowId) {
                const row = document.getElementById(rowId);
                if (!row) return;
                
                const inputs = row.querySelectorAll('input');
                const tokenName = inputs[0]?.value?.trim();
                const tokenPrice = parseFloat(inputs[1]?.value) || 0;
                
                // Clear old entries from this row (in case name changed)
                // This is a simple approach - just rebuild from all rows
                window.customTokenPrices = {};
                document.querySelectorAll('#custom-token-rows > div').forEach(r => {
                    const rowInputs = r.querySelectorAll('input');
                    const name = rowInputs[0]?.value?.trim();
                    const price = parseFloat(rowInputs[1]?.value) || 0;
                    if (name && price > 0) {
                        window.customTokenPrices[name] = price;
                    }
                });
                
                console.log('Custom token prices updated:', window.customTokenPrices);
            }
            
            window.addCalculatedLstPrice = function(token) {
                const lstRatios = window.lstRatios || {};
                const cachedPrices = window.cachedPriceData || {};
                
                // Define base token and ratio for each LST
                const lstConfig = {
                    'ampCAPA': { baseToken: 'capapult', ratio: lstRatios.ampCAPA },
                    'ampROAR': { baseToken: 'lion-dao', ratio: lstRatios.ampROAR },
                    'xASTRO': { baseToken: 'astroport-fi', ratio: lstRatios.xASTRO }
                };
                
                const config = lstConfig[token];
                if (!config) {
                    alert(`Unknown LST: ${token}`);
                    return;
                }
                
                const basePrice = cachedPrices[config.baseToken]?.usd;
                const ratio = config.ratio;
                
                if (!basePrice) {
                    alert(`Base token price not available for ${token}. Make sure CoinGecko prices are loaded.`);
                    return;
                }
                
                if (!ratio || ratio === 1) {
                    alert(`LST ratio not available for ${token}. Load ratios from TLA ext file first.`);
                    return;
                }
                
                const calculatedPrice = basePrice * ratio;
                
                // Check if already added
                const existing = Array.from(document.querySelectorAll('#custom-token-rows input[type="text"]'))
                    .find(input => input.value === token);
                
                if (existing) {
                    // Update existing row
                    const priceInput = existing.parentElement.querySelector('input[type="number"]');
                    if (priceInput) {
                        priceInput.value = calculatedPrice.toFixed(6);
                        window.customTokenPrices[token] = calculatedPrice;
                    }
                    alert(`Updated ${token}: $${calculatedPrice.toFixed(6)} (${config.baseToken} $${basePrice.toFixed(4)}  ratio ${ratio.toFixed(4)})`);
                } else {
                    // Add new row
                    window.addCustomTokenRow(token, calculatedPrice.toFixed(6));
                    alert(`Added ${token}: $${calculatedPrice.toFixed(6)} (${config.baseToken} $${basePrice.toFixed(4)}  ratio ${ratio.toFixed(4)})`);
                }
            }
            
            window.getCustomTokenPrices = function() {
                return window.customTokenPrices || {};
            }
            
            // --- Setup Snapshot Modal ---
            function setupSnapshotModal() {
                const tokensInput = document.getElementById('tla-tokens-input');
                const usdInput = document.getElementById('tla-usd-input');
                const parseBtn = document.getElementById('parse-tla-btn');
                const downloadBtn = document.getElementById('download-snapshot-btn');
                const previewDiv = document.getElementById('tla-preview');
                const previewContent = document.getElementById('tla-preview-content');
                const statusDiv = document.getElementById('snapshot-status');
                
                if (!parseBtn || !downloadBtn) return;
                
                // Parse button handler
                parseBtn.addEventListener('click', () => {
                    try {
                        const tokenBalances = [];
                        const geckoIds = {
                            'LUNA': 'terra-luna-2',
                            'ampLUNA': 'eris-amplified-luna',
                            'CAPA': 'capapult',
                            'ROAR': 'lion-dao',
                            'xASTRO': 'astroport-fi',
                            'ASTRO': 'astroport-fi',
                            'ampCAPA': null,
                            'ampROAR': null
                        };
                        
                        let totalDeposit = 0;
                        let estApr = 0;
                        
                        // Check which mode we're in
                        if (window.snapshotMode === 'manual') {
                            // MANUAL MODE - read from input fields
                            totalDeposit = parseFloat(document.getElementById('manual-deposit-usd').value) || 0;
                            estApr = parseFloat(document.getElementById('manual-apr').value) || 0;
                            
                            // Read token balances from manual inputs
                            const manualTokens = ['LUNA', 'ampLUNA', 'CAPA', 'ampCAPA', 'ROAR', 'ampROAR', 'xASTRO'];
                            for (const tokenName of manualTokens) {
                                const input = document.getElementById('manual-token-' + tokenName);
                                const amount = parseFloat(input?.value) || 0;
                                if (amount > 0) {
                                    tokenBalances.push({
                                        name: tokenName,
                                        amount: amount,
                                        geckoId: geckoIds[tokenName] || null
                                    });
                                }
                            }
                        } else {
                            // PASTE MODE - parse from textareas
                            const tokensText = tokensInput.value.trim();
                        
                            if (tokensText) {
                                const lines = tokensText.split('\n');
                                for (const line of lines) {
                                    const parts = line.split(/\t+/);
                                    if (parts.length >= 2) {
                                        const name = parts[0].trim();
                                        const amount = parseFloat(parts[1].trim());
                                        if (name && !isNaN(amount)) {
                                            tokenBalances.push({
                                                name: name,
                                                amount: amount,
                                                geckoId: geckoIds[name] || null
                                            });
                                        }
                                    }
                                }
                            }
                        
                            // Parse USD and APR
                            const usdText = usdInput.value.trim();
                        
                            if (usdText) {
                                // Extract USD value - handles multiple formats:
                                // "14 765.85$" (space thousands separator)
                                // "__15.25K__$" (with underscores and K/M/B multiplier)
                                // "14,765.85$" (comma thousands separator)
                            
                                // First try: number with spaces/commas followed by $
                                let usdMatch = usdText.match(/([\d\s,]+\.?\d*)\s*\$/);
                                if (usdMatch) {
                                    // Remove spaces and commas, parse as float
                                    let value = parseFloat(usdMatch[1].replace(/[\s,]/g, ''));
                                    totalDeposit = value;
                                } else {
                                    // Second try: __15.25K__$ format
                                    usdMatch = usdText.match(/__?([\d.,]+)([KMB])?__?\s*\$/i);
                                    if (usdMatch) {
                                        let value = parseFloat(usdMatch[1].replace(',', ''));
                                        const multiplier = usdMatch[2] ? { 'K': 1000, 'M': 1000000, 'B': 1000000000 }[usdMatch[2].toUpperCase()] : 1;
                                        totalDeposit = value * (multiplier || 1);
                                    }
                                }
                            
                                // Extract APR (e.g., "est. APR 58.53 %" or "est. APR 58.75 %")
                                const aprMatch = usdText.match(/APR\s*([\d.]+)\s*%/i);
                                if (aprMatch) {
                                    estApr = parseFloat(aprMatch[1]);
                                }
                            }
                        } // End paste mode
                        
                        // Get amp token ratios from inputs (only for tokens without CoinGecko prices)
                        // Use LST ratios from TLA ext file (loaded globally)
                        const lstRatios = window.lstRatios || {};
                        
                        parsedTlaData = {
                            tokenBalances: tokenBalances,
                            totalDeposit: totalDeposit,
                            estApr: estApr,
                            snapshotDate: new Date().toISOString(),
                            // Store all LST ratios for snapshot
                            lstRatios: {
                                ampLUNA: lstRatios.ampLUNA || window.cachedAmpLunaRate || 1.9015,
                                arbLUNA: lstRatios.arbLUNA || 2.6873,
                                bLUNA: lstRatios.bLUNA || 1.6048,
                                ampCAPA: lstRatios.ampCAPA || 1.1055,
                                ampROAR: lstRatios.ampROAR || 1.1087,
                                xASTRO: lstRatios.xASTRO || 1.22
                            },
                            // Keep legacy format for backwards compatibility
                            ampRatios: {
                                ampCAPA: lstRatios.ampCAPA || 1.1055,
                                ampROAR: lstRatios.ampROAR || 1.1087
                            }
                        };
                        
                        // Show preview
                        let previewHtml = `<p><strong>Total Deposit:</strong> $${totalDeposit.toLocaleString()}</p>`;
                        previewHtml += `<p><strong>Est. APR:</strong> ${estApr.toFixed(2)}%</p>`;
                        previewHtml += `<p><strong>LST Ratios:</strong> ampLUNA=${lstRatios.ampLUNA?.toFixed(4) || '--'}, arbLUNA=${lstRatios.arbLUNA?.toFixed(4) || '--'}, ampCAPA=${lstRatios.ampCAPA?.toFixed(4) || '--'}, ampROAR=${lstRatios.ampROAR?.toFixed(4) || '--'}, xASTRO=${lstRatios.xASTRO?.toFixed(4) || '--'}</p>`;
                        
                        // Show custom token prices if any
                        const customPrices = window.getCustomTokenPrices ? window.getCustomTokenPrices() : {};
                        const customPriceEntries = Object.entries(customPrices);
                        if (customPriceEntries.length > 0) {
                            previewHtml += `<p><strong>Custom Prices (${customPriceEntries.length}):</strong> `;
                            previewHtml += customPriceEntries.map(([name, price]) => `${name}=$${price.toFixed(6)}`).join(', ');
                            previewHtml += '</p>';
                        }
                        
                        previewHtml += `<p><strong>Tokens (${tokenBalances.length}):</strong></p>`;
                        previewHtml += '<ul class="list-disc list-inside ml-2">';
                        for (const token of tokenBalances) {
                            previewHtml += `<li>${token.name}: ${token.amount.toLocaleString()}</li>`;
                        }
                        previewHtml += '</ul>';
                        
                        previewContent.innerHTML = previewHtml;
                        previewDiv.classList.remove('hidden');
                        
                        // Enable download button if we have valid data
                        if (totalDeposit > 0 || tokenBalances.length > 0) {
                            downloadBtn.disabled = false;
                            statusDiv.textContent = ' Data parsed successfully!';
                            statusDiv.className = 'text-center text-sm text-green-400';
                            statusDiv.classList.remove('hidden');
                        }
                        
                    } catch (error) {
                        console.error("Parse error:", error);
                        statusDiv.textContent = ' Error parsing data: ' + error.message;
                        statusDiv.className = 'text-center text-sm text-red-400';
                        statusDiv.classList.remove('hidden');
                    }
                });
                
                // Download button handler
                downloadBtn.addEventListener('click', () => {
                    if (!currentSnapshotData) {
                        statusDiv.textContent = ' No live data available. Please wait for page to load.';
                        statusDiv.className = 'text-center text-sm text-red-400';
                        statusDiv.classList.remove('hidden');
                        return;
                    }
                    
                    try {
                        // Calculate current epoch for filename
                        const epochReferenceDate = new Date('2025-12-01T00:00:00Z');
                        const epochReferenceNumber = 162;
                        const now = new Date();
                        const msPerWeek = 7 * 24 * 60 * 60 * 1000;
                        const weeksDiff = Math.floor((now - epochReferenceDate) / msPerWeek);
                        const currentEpoch = epochReferenceNumber + weeksDiff;
                        
                        // Build the snapshot with TLA data
                        const snapshotToDownload = { ...currentSnapshotData };
                        
                        // Capture ALL token prices at snapshot time dynamically
                        const tokenPricesAtSnapshot = {};
                        if (cachedPriceData) {
                            // Human-readable name mapping
                            const geckoIdToName = {
                                'terra-luna-2': 'LUNA',
                                'eris-amplified-luna': 'ampLUNA',
                                'eris-arbitrage-luna': 'arbLUNA',
                                'staked-luna-slinky': 'arbLUNA_slinky',
                                'astroport-fi': 'xASTRO',
                                'capapult': 'CAPA',
                                'lion-dao': 'ROAR',
                                'solid-2': 'SOLID',
                                'eureka-bridged-wbtc-terra': 'wBTC',
                                'backbone-labs-staked-luna': 'bLUNA',
                                'cosmos': 'ATOM',
                                'ethereum': 'ETH',
                                'usd-coin': 'USDC'
                            };
                            // Capture all prices we have
                            for (const [geckoId, data] of Object.entries(cachedPriceData)) {
                                if (data?.usd) {
                                    const tokenName = geckoIdToName[geckoId] || geckoId;
                                    tokenPricesAtSnapshot[tokenName] = data.usd;
                                }
                            }
                        }
                        
                        // Add custom token prices (manually entered)
                        const customPrices = window.getCustomTokenPrices ? window.getCustomTokenPrices() : {};
                        for (const [tokenName, price] of Object.entries(customPrices)) {
                            if (tokenName && price > 0) {
                                tokenPricesAtSnapshot[tokenName] = price;
                            }
                        }
                        
                        // Add TLA data if parsed
                        if (parsedTlaData) {
                            snapshotToDownload.tlaDeposits = {
                                totalDeposit: parsedTlaData.totalDeposit,
                                totalDeposit_USD: parsedTlaData.totalDeposit,
                                estApr: parsedTlaData.estApr,
                                tokenBalances: parsedTlaData.tokenBalances,
                                snapshotDate: parsedTlaData.snapshotDate,
                                ampRatios: parsedTlaData.ampRatios,
                                tokenPricesAtSnapshot: tokenPricesAtSnapshot,
                                customTokenPrices: Object.keys(customPrices).length > 0 ? customPrices : undefined // Track which were custom
                            };
                            snapshotToDownload.tlaDepositsTotal_USD = parsedTlaData.totalDeposit;
                        }
                        
                        // Note: tokenPrices is already in currentSnapshotData from snapshotResult
                        
                        const jsonString = JSON.stringify(snapshotToDownload, null, 2);
                        const blob = new Blob([jsonString], { type: 'application/json' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.style.display = 'none';
                        a.href = url;
                        a.download = `adao-snapshot_${currentEpoch}_end.json`;
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        document.body.removeChild(a);
                        
                        statusDiv.textContent = ` Downloaded: adao-snapshot_${currentEpoch}_end.json`;
                        statusDiv.className = 'text-center text-sm text-green-400';
                        statusDiv.classList.remove('hidden');
                        
                    } catch (error) {
                        console.error("Download error:", error);
                        statusDiv.textContent = ' Error downloading: ' + error.message;
                        statusDiv.className = 'text-center text-sm text-red-400';
                        statusDiv.classList.remove('hidden');
                    }
                });
            }
            
            const tokenLogos = { /* ... token logos ... */ 
                "LUNA": "https://raw.githubusercontent.com/defipatriot/aDAO-Image-Files/main/Luna.webp?raw=true",
                "ampLUNA": "https://raw.githubusercontent.com/defipatriot/aDAO-Image-Files/main/ampLuna.webp?raw=true",
                "ASTRO": "https://raw.githubusercontent.com/defipatriot/token_logo/main/Astro.webp?raw=true",
                "wBTC": "https://raw.githubusercontent.com/defipatriot/token_logo/main/wBTC.png?raw=true",
                "ATOM": "https://raw.githubusercontent.com/defipatriot/aDAO-Image-Files/main/atom.png?raw=true",
                "CAPA": "https://raw.githubusercontent.com/defipatriot/token_logo/main/capa.svg?raw=true",
                "xASTRO": "https://raw.githubusercontent.com/defipatriot/aDAO-Image-Files/main/astro.png?raw=true",
                "ROAR": "https://raw.githubusercontent.com/defipatriot/token_logo/main/ROAR_LOGO.png?raw=true",
                "SOLID": "https://raw.githubusercontent.com/defipatriot/token_logo/main/solid.svg?raw=true",
                "bLUNA": "https://raw.githubusercontent.com/defipatriot/token_logo/main/bLUNA.webp?raw=true",
                "USDC": "https://assets.coingecko.com/coins/images/6319/small/usdc.png",
                "arbLUNA": "https://raw.githubusercontent.com/defipatriot/token_logo/main/arbLuna.svg?raw=true",
                "ampCAPA": null, "ampROAR": null
            };
            const denomMap = { /* ... denom map ... */ 
                'uluna': { name: 'LUNA', geckoId: 'terra-luna-2', decimals: 6 },
                'ibc/8D8A7F7253615E5F76CB6252A1E1BD921D5EDB7BBAAF8913FB1C77FF125D9995': { name: 'ASTRO', geckoId: 'astroport-fi', decimals: 6 },
                'ibc/2C962DAB9F57FE0921435426AE75196009FAA1981BF86991203C8411F8980FDB': { name: 'USDC', geckoId: 'usd-coin', decimals: 6 },
                'ibc/88386AC48152D48B34B082648DF836F975506F0B57DBBFC10A54213B1BF484CB': { name: 'wBTC', geckoId: 'wrapped-bitcoin', decimals: 8 },
                'terra1ecgazyd0waaj3g7l9cmy5gulhxkps2gmxu9ghducvuypjq68mq2s5lvsct': { name: 'ampLUNA', geckoId: 'eris-amplified-luna', decimals: 6 },
                'terra17jnhankdf4jtr2g53v635q5k70g7g64x2s9w2s': { name: 'arbLUNA', geckoId: 'staked-luna-slinky', decimals: 6 },
                'terra1t4p3u8khpd7f8qzurwyafxt648dya6mp6vur3vaapswt6m24gkuqrfdhar': { name: 'CAPA', geckoId: 'capapult', decimals: 6 },
                'terra10aa3zdkrc7jwuf8ekl3zq7e7m42vmzqehcmu74e4egc7xkm5kr2s0muyst': { name: 'SOLID', geckoId: 'solid-2', decimals: 6 },
                'terra1lxx40s29qvkrcj8fsa3yzyehy7w50umdvvnls2r830rys6lu2zns63eelv': { name: 'ROAR', geckoId: 'lion-dao', decimals: 6 },
                'terra17aj4ty4sz4yhgm08na8drc0v03v2jwr3waxcqrwhajj729zhl7zqnpc0ml': { name: 'bLUNA', geckoId: 'backbone-labs-staked-luna', decimals: 6 }
            };


            // --- UI UPDATE FUNCTION ---
            function updateUI() {
                const lastUpdatedEl = document.getElementById('last-updated');
                if (lastUpdatedEl) lastUpdatedEl.textContent = new Date(dashboardData.lastUpdated).toUTCString();
                
                 // Mint Slider (Update with static data initially)
                const mintSliderEl = document.getElementById('mint-slider');
                const unmintedCountEl = document.getElementById('unminted-count');
                const mintedCountEl = document.getElementById('minted-count');
                const mintedPercentEl = document.getElementById('minted-percent');

                if (mintSliderEl && unmintedCountEl && mintedCountEl && mintedPercentEl) {
                    const percentMintedNum = parseFloat(dashboardData.statusSliders.mint.percentMinted);
                    mintSliderEl.innerHTML = `<div class="slider-fill-blue" style="width: ${100 - percentMintedNum}%;"></div><div class="slider-fill-gray" style="width: ${percentMintedNum}%;"></div>`;
                    if (unmintedCountEl.innerHTML.includes('fa-spinner')) unmintedCountEl.textContent = dashboardData.statusSliders.mint.unMinted.toLocaleString();
                    if (mintedCountEl.innerHTML.includes('fa-spinner')) mintedCountEl.textContent = dashboardData.statusSliders.mint.minted.toLocaleString();
                    if (mintedPercentEl.innerHTML.includes('fa-spinner')) mintedPercentEl.textContent = `${dashboardData.statusSliders.mint.percentMinted} Minted`;
                }
                
                 // --- FIX: Removed redundant static update for Avg Daily Gain ---
                 // The fetchLiveOnChainData's 'finally' block now handles this.
                 // --- END FIX ---

                fetchLiveOnChainData();
            }

            async function fetchLiveOnChainData() {
                 if (isFetching) return; 
                 isFetching = true;
                 console.log("DEBUG: Starting fetchLiveOnChainData..."); 


                // ... (API URLs setup remains the same) ...
                 const onChainStatsUrl = 'https://deving.zone/en/nfts/alliance_daos.json';
                 const contractRewardsQuery = btoa(JSON.stringify({ all_nft_info: { token_id: "9068" } }));
                 const contractUrl = `https://terra.publicnode.com/cosmwasm/wasm/v1/contract/terra1phr9fngjv7a8an4dhmhd0u0f98wazxfnzccqtyheq4zqrrp4fpuqw3apw9/smart/${contractRewardsQuery}`;
                 const ampLunaRateQuery = btoa(JSON.stringify({ exchange_rates: {} }));
                 const ampLunaRateUrl = `https://terra.publicnode.com/cosmwasm/wasm/v1/contract/terra10788fkzah89xrdm27zkj5yvhj9x3494lxawzm5qq3vvxcqz2yzaqyd3enk/smart/${ampLunaRateQuery}`;
                 const treasuryWalletAddress = 'terra1sffd4efk2jpdt894r04qwmtjqrrjfc52tmj6vkzjxqhd8qqu2drs3m5vzm';
                 const nativeBalancesUrl = `https://terra.publicnode.com/cosmos/bank/v1beta1/balances/${treasuryWalletAddress}`;
                 const neededGeckoIds = new Set(['terra-luna-2', 'eris-amplified-luna']);
                 Object.values(denomMap).forEach(token => { if (token.geckoId) neededGeckoIds.add(token.geckoId); });
                 dashboardData.tlaDeposits.tokenBalances.forEach(token => { if (token.geckoId) neededGeckoIds.add(token.geckoId); });
                 neededGeckoIds.add('staked-luna-slinky');
                 
                 // Dynamically get all coin IDs from the CoinGecko banner widget
                 const bannerWidget = document.querySelector('gecko-coin-price-marquee-widget');
                 if (bannerWidget) {
                     const bannerCoins = bannerWidget.getAttribute('coin-ids');
                     if (bannerCoins) {
                         bannerCoins.split(',').forEach(coin => neededGeckoIds.add(coin.trim()));
                     }
                 }
                 
                 const allGeckoIdsString = Array.from(neededGeckoIds).join(',');
                 const priceUrl = `https://api.coingecko.com/api/v3/simple/price?ids=${allGeckoIdsString}&vs_currencies=usd`;

                // --- Variables to store calculated results ---
                let snapshotResult = { timestamp: new Date().toISOString(), status: "partial" }; // Default status

                try {
                    console.log("DEBUG: Starting primary API fetches..."); 
                    const [statsResponse, contractResponse, ampLunaRateResponse, priceResponse] = await Promise.all([ /* ... fetches ... */ 
                        fetch(onChainStatsUrl).catch(e => { console.error("Stats Fetch Error:", e); return null; }),
                        fetch(contractUrl).catch(e => { console.error("Contract Fetch Error:", e); return null; }),
                        fetch(ampLunaRateUrl).catch(e => { console.error("ampLUNA Rate Fetch Error:", e); return null; }),
                        fetch(priceUrl).catch(e => { console.error("Price Fetch Error:", e); return null; })
                    ]);
                    console.log("DEBUG: Primary API fetches completed."); 

                    if (!statsResponse?.ok || !contractResponse?.ok || !ampLunaRateResponse?.ok || !priceResponse?.ok) {
                         console.error("DEBUG: One or more primary API requests failed."); 
                         throw new Error("Primary API requests failed");
                    }
                    console.log("DEBUG: All primary API responses OK."); 

                    const statsData = await statsResponse.json(); console.log("DEBUG: Parsed statsData."); 
                    const contractJson = await contractResponse.json(); console.log("DEBUG: Parsed contractJson."); 
                    const ampLunaRateData = await ampLunaRateResponse.json(); console.log("DEBUG: Parsed ampLunaRateData."); 
                    const priceData = await priceResponse.json(); console.log("DEBUG: Parsed priceData."); 
                    cachedPriceData = priceData; // Cache for later use
                    window.cachedPriceData = priceData; // Also store globally for unclaimed rewards
                    
                    // Update volume displays now that we have prices (in case sales loaded first)
                    if (typeof updateVolumeDisplays === 'function') {
                        try { updateVolumeDisplays(); } catch(e) {}
                    }
                    
                    // Load ALL LST ratios from TLA ext file (for snapshot tool and price calculations)
                    await loadLstRatiosFromExt();
                    console.log("DEBUG: LST ratios loaded:", window.lstRatios);

                    console.log("DEBUG: Starting treasury balance fetches..."); 
                    const balancePromises = [];
                    balancePromises.push(fetch(nativeBalancesUrl).then(res => res.ok ? res.json() : null).catch(() => null)); 
                    const queryMsg = btoa(JSON.stringify({ balance: { address: treasuryWalletAddress } }));
                    for (const denom in denomMap) {
                        if (denom.startsWith('terra1')) {
                            const url = `https://terra.publicnode.com/cosmwasm/wasm/v1/contract/${denom}/smart/${queryMsg}`;
                            balancePromises.push(
                                fetch(url)
                                .then(res => res.ok ? res.json() : Promise.reject(new Error(`Fetch failed for ${denom}`)))
                                .then(data => ({ denom, data }))
                                .catch(() => { return null; }) 
                            );
                        }
                    }
                    const balanceResults = await Promise.all(balancePromises);
                    console.log("DEBUG: Treasury balance fetches completed."); 
                    
                    const liveTreasuryAssets = [];
                    // ... (processing balanceResults remains the same) ...
                    const nativeBalancesResult = balanceResults[0];
                    if (nativeBalancesResult && nativeBalancesResult.balances) {
                         nativeBalancesResult.balances.forEach(balance => {
                            const tokenInfo = denomMap[balance.denom];
                            if (tokenInfo) {
                                liveTreasuryAssets.push({ ...tokenInfo, amount: Number(balance.amount) / Math.pow(10, tokenInfo.decimals || 0) });
                            }
                        });
                    } else { console.warn("DEBUG: Failed to load native treasury balances."); } 

                    for (let i = 1; i < balanceResults.length; i++) {
                        const result = balanceResults[i];
                        if (result && result.data && result.data.data && typeof result.data.data.balance === 'string') {
                             const tokenInfo = denomMap[result.denom];
                             if (tokenInfo) {
                                 const amount = Number(result.data.data.balance) / Math.pow(10, tokenInfo.decimals || 0);
                                 if (amount > 0) { liveTreasuryAssets.push({ ...tokenInfo, amount }); }
                             }
                        }
                    }
                    console.log("DEBUG: Processed treasury balances."); 

                    const { collection_stats, nfts } = statsData;
                    const lunaPriceUSD = priceData?.['terra-luna-2']?.usd;
                    if (typeof lunaPriceUSD !== 'number') { throw new Error("Invalid price data for LUNA"); }
                    console.log("DEBUG: LUNA price OK:", lunaPriceUSD); 

                    const ampLunaToLunaRate = parseFloat(ampLunaRateData?.data?.exchange_rates?.[0]?.[1]);
                     if (isNaN(ampLunaToLunaRate)) { throw new Error("Invalid ampLUNA exchange rate"); }
                    console.log("DEBUG: ampLUNA rate OK:", ampLunaToLunaRate);
                    window.cachedAmpLunaRate = ampLunaToLunaRate; // Store globally for unclaimed rewards
                    
                    // Update global lstRatios with LIVE ampLUNA rate (from Eris contract)
                    if (window.lstRatios) {
                        window.lstRatios.ampLUNA = ampLunaToLunaRate;
                        window.lstRatios.ratioSources.ampLUNA = 'live';
                        // Update UI display - GREEN with checkmark for LIVE data
                        const ampLunaDisplay = document.getElementById('lst-ratio-display-ampLUNA');
                        if (ampLunaDisplay) {
                            ampLunaDisplay.textContent = ampLunaToLunaRate.toFixed(4) + ' ';
                            ampLunaDisplay.className = 'block text-green-400 font-mono';
                        }
                    } 

                    // --- Calculations for Snapshot & UI ---
                    const daodaoStakers = nfts.filter(nft => nft.daodao === true);
                    const daodaoCount = daodaoStakers.length;
                    const brokenCount = nfts.filter(nft => nft.broken).length;
                    const daoMembers = collection_stats?.unique_stakers || 0;
                    const daoEnterpriseWallet = 'terra1nn7yrgjzj6zvle7ms9vlpg4cj3kaxjls4g6ugw';
                    const enterpriseStakers = nfts.filter(nft => nft.enterprise === true && nft.owner !== daoEnterpriseWallet);
                    const enterpriseStakedByHolder = enterpriseStakers.length;
                    const mintedCount = dashboardData.statusSliders.mint.minted; // From static data
                    const unmintedCount = dashboardData.statusSliders.mint.unMinted; // From static data
                    const circulatingSupply = Math.max(0, mintedCount - 1000); // Assuming 1000 DAO broken
                    const rewardsAttribute = contractJson?.data?.info?.extension?.attributes?.find(attr => attr.trait_type === 'rewards');
                    const rewardsValue = rewardsAttribute?.value;
                    const liveAmpLunaBacking = rewardsValue ? Number(rewardsValue) / 1000000 : 0; 
                    const backingInLunaLive = liveAmpLunaBacking * ampLunaToLunaRate;
                    const backingInUSD = backingInLunaLive * lunaPriceUSD;
                    const unmintedBackingLuna = unmintedCount * backingInLunaLive;
                    const unmintedBackingUSD = unmintedCount * backingInUSD;

                    // Calculate Treasury Total USD (simplified from buildTreasuryTable)
                     let totalTreasuryUSD = 0;
                     liveTreasuryAssets.forEach(asset => {
                         let livePrice = null;
                         if (priceData && priceData[asset.geckoId]) { livePrice = priceData[asset.geckoId].usd; }
                         const liveValue = (typeof livePrice === 'number') ? asset.amount * livePrice : null;
                         if (liveValue !== null) { totalTreasuryUSD += liveValue; }
                     });
                     
                    // TLA VP - Get from global tlaVpData (populated by buildTlaVp from GitHub file)
                    // This ensures snapshot uses the same VP values shown on the tile
                    let totalTlaVpUSD = 0;
                    let totalTlaVpLUNA = 0;
                    const ratesAreValid = typeof lunaPriceUSD === 'number' && typeof ampLunaToLunaRate === 'number';
                    
                    if (window.tlaVpData) {
                        // Use VP data from GitHub TLA file (set by buildTlaVp)
                        totalTlaVpLUNA = window.tlaVpData.totalVp; // Actual VP from locks
                        totalTlaVpUSD = window.tlaVpData.totalUsd; // Live USD value
                    } else {
                        // Fallback if tlaVpData not available
                        const fixedTlaVp = 638900;
                        totalTlaVpLUNA = fixedTlaVp;
                        if (ratesAreValid) {
                            const underlyingLunaForValue = fixedTlaVp / 10;
                            totalTlaVpUSD = underlyingLunaForValue * lunaPriceUSD;
                        }
                    }


                    // --- Populate Snapshot Object ---
                    // Build token prices object for historical tracking
                    // Dynamically capture ALL prices from CoinGecko banner
                    const tokenPrices = {};
                    
                    // Human-readable name mapping for gecko IDs
                    const geckoIdToName = {
                        'terra-luna-2': 'LUNA',
                        'eris-amplified-luna': 'ampLUNA',
                        'eris-arbitrage-luna': 'arbLUNA',
                        'staked-luna-slinky': 'arbLUNA_slinky',
                        'astroport-fi': 'ASTRO',
                        'capapult': 'CAPA',
                        'lion-dao': 'ROAR',
                        'solid-2': 'SOLID',
                        'usd-coin': 'USDC',
                        'eureka-bridged-wbtc-terra': 'wBTC',
                        'backbone-labs-staked-luna': 'bLUNA',
                        'cosmos': 'ATOM',
                        'ethereum': 'ETH',
                        'wrapped-bitcoin': 'wBTC_wrapped'
                    };
                    
                    // Capture all prices we fetched
                    if (priceData) {
                        for (const [geckoId, data] of Object.entries(priceData)) {
                            if (data?.usd) {
                                const tokenName = geckoIdToName[geckoId] || geckoId; // Use mapping or fallback to geckoId
                                tokenPrices[tokenName] = data.usd;
                            }
                        }
                    }
                    
                    snapshotResult = {
                        timestamp: new Date().toISOString(),
                        status: "success", // Mark as successful
                        epoch: dashboardData?.tlaDeposits?.currentEpoch || null, // Store epoch for reference
                        daoMembers: daoMembers,
                        daodaoStaked: daodaoCount,
                        enterpriseStaked: enterpriseStakedByHolder,
                        brokenNfts: brokenCount, // Total broken (user + DAO)
                        daoHeldNfts: 1000, // DAO-held NFTs (static)
                        circulatingSupply: circulatingSupply,
                        backingPerNft_ampLUNA: liveAmpLunaBacking,
                        ampLUNA_LUNA_Ratio: ampLunaToLunaRate,
                        arbLUNA_LUNA_Ratio: window.cachedArbLunaRate || 2.6873, // From TLA ext file
                        backingPerNft_LUNA: backingInLunaLive,
                        lunaPrice_USD: lunaPriceUSD,
                        backingPerNft_USD: backingInUSD,
                        unmintedNfts: unmintedCount,
                        unmintedTotalBacking_LUNA: unmintedBackingLuna,
                        unmintedTotalBacking_USD: unmintedBackingUSD,
                        treasuryTotal_USD: totalTreasuryUSD,
                        tlaDepositsTotal_USD: dashboardData.tlaDeposits.totalDeposit, // Using snapshot TLA total
                        tlaVpTotal_LUNA: totalTlaVpLUNA,
                        tlaVpTotal_USD: totalTlaVpUSD,
                        // Store VP locks data for historical tracking (including USD value at snapshot time)
                        tlaVpLocks: window.tlaVpData?.locks ? window.tlaVpData.locks.map(l => {
                            // Calculate USD value for this lock
                            const lockUsd = l.directPrice ? l.amount * l.directPrice : null;
                            return {
                                id: l.id,
                                asset: l.asset,
                                amount: l.amount,
                                vp: l.staticVp,
                                ratio: l.ratio,
                                usd: lockUsd // Capture USD value at snapshot time
                            };
                        }) : null,
                        avgDailyGainPerNft_LUNA: calculatedAvgDailyGain, // Only use calculated value, no fallback to static
                        tokenPrices: tokenPrices // All token prices for historical tracking
                    };
                    console.log("DEBUG: Snapshot data compiled:", snapshotResult); // DEBUG LOG

                    // --- Update UI ---
                    console.log("DEBUG: Calling build/update UI functions..."); 
                    buildTreasuryTable(priceData, liveTreasuryAssets);
                    buildTlaVp(priceData, ampLunaToLunaRate);
                    await buildTlaDeposits(priceData);
                    // ... (rest of the UI updates: staker tables, tiles, modals) ...
                    const enterpriseStakerCounts = enterpriseStakers.reduce((acc, nft) => { if(nft.owner) acc[nft.owner] = (acc[nft.owner] || 0) + 1; return acc; }, {});
                    buildStakerTable('enterprise-stakers-table', enterpriseStakerCounts);
                    const daodaoStakerCounts = daodaoStakers.reduce((acc, nft) => { if(nft.owner) acc[nft.owner] = (acc[nft.owner] || 0) + 1; return acc; }, {});
                    buildStakerTable('daodao-stakers-table', daodaoStakerCounts);
                    console.log("DEBUG: Built staker tables."); 

                    const totalLocked = daodaoCount + enterpriseStakedByHolder;
                    const daodaoLockedPercentage = circulatingSupply > 0 ? (daodaoCount / circulatingSupply) * 100 : 0;
                    const liquidSupply = Math.max(0, circulatingSupply - totalLocked);

                    updateTile('daodao-staked', daodaoCount.toLocaleString(), true);
                    const daodaoStakedPercentageEl = document.getElementById('daodao-staked-percentage');
                    if (daodaoStakedPercentageEl) daodaoStakedPercentageEl.textContent = `${daodaoLockedPercentage.toFixed(2)}% of Circulating`;

                    updateTile('dao-members', daoMembers.toLocaleString(), true);
                    updateTile('enterprise-staked-holder', enterpriseStakedByHolder.toLocaleString(), true, { titleId: 'enterprise-staked-title' });
                    
                     const supplyMintedEl = document.getElementById('supply-minted');
                     const supplyCirculatingEl = document.getElementById('supply-circulating');
                     const supplyLiquidEl = document.getElementById('supply-liquid');
                     const supplyDaodaoStakedEl = document.getElementById('supply-daodao-staked');
                     const supplyEnterpriseStakedEl = document.getElementById('supply-enterprise-staked');
                     const daodaoModalHolderCountEl = document.getElementById('daodao-modal-holder-count');
                     if(supplyMintedEl) supplyMintedEl.textContent = mintedCount.toLocaleString();
                     if(supplyCirculatingEl) supplyCirculatingEl.textContent = circulatingSupply.toLocaleString();
                     if(supplyLiquidEl) supplyLiquidEl.textContent = liquidSupply.toLocaleString();
                     if(supplyDaodaoStakedEl) supplyDaodaoStakedEl.textContent = daodaoCount.toLocaleString();
                     if(supplyEnterpriseStakedEl) supplyEnterpriseStakedEl.textContent = enterpriseStakedByHolder.toLocaleString();
                     if(daodaoModalHolderCountEl) daodaoModalHolderCountEl.textContent = daodaoCount.toLocaleString();

                     const unbrokenCountEl = document.getElementById('unbroken-count');
                     const brokenCountEl = document.getElementById('broken-count');
                     const brokenPercentEl = document.getElementById('broken-percent');
                     const brokenSliderEl = document.getElementById('broken-slider');
                     const totalNftsForBrokenCalc = 10000;
                     if (unbrokenCountEl) unbrokenCountEl.textContent = (totalNftsForBrokenCalc - brokenCount).toLocaleString();
                     if (brokenCountEl) brokenCountEl.textContent = brokenCount.toLocaleString();
                     if (brokenPercentEl) brokenPercentEl.textContent = `${(brokenCount / totalNftsForBrokenCalc * 100).toFixed(2)}% Broken`;
                     if (brokenSliderEl) {
                         const percentBrokenNum = brokenCount / totalNftsForBrokenCalc * 100;
                         brokenSliderEl.innerHTML = `<div class="slider-fill-blue" style="width: ${100 - percentBrokenNum}%;"></div><div class="slider-fill-gray" style="width: ${percentBrokenNum}%;"></div>`;
                     }

                    updateTile('backing-per-nft-ampluna', liveAmpLunaBacking.toFixed(4), true, { titleId: 'backing-ampluna-title', subtextId: 'backing-per-nft-change', subtext: `Ratio: ${ampLunaToLunaRate.toFixed(4)}` }); 
                    updateTile('backing-per-nft-luna-live', backingInLunaLive.toFixed(4), true, { titleId: 'backing-luna-live-title'}); 
                    updateTile('backing-per-nft-usd', `$${backingInUSD.toFixed(2)}`, true, { titleId: 'backing-usd-title', subtextId: 'live-luna-price', subtext: `@ $${lunaPriceUSD.toFixed(4)} / LUNA` });
                    updateTile('unminted-nft-backing-luna', `${unmintedBackingLuna.toLocaleString('en-US', {maximumFractionDigits: 0})} LUNA`, true, { titleId: 'unminted-nft-backing-title' });
                     const unmintedNftBackingUsdEl = document.getElementById('unminted-nft-backing-usd');
                     if (unmintedNftBackingUsdEl) unmintedNftBackingUsdEl.textContent = `$${unmintedBackingUSD.toLocaleString('en-US', {maximumFractionDigits: 0})} USD`;
                    
                     const unmintedModalCount1 = document.getElementById('unminted-modal-count');
                     const unmintedModalCount2 = document.getElementById('unminted-modal-count-2');
                     const unmintedModalBackingLuna = document.getElementById('unminted-modal-backing-luna');
                     const unmintedModalBackingUsd = document.getElementById('unminted-modal-backing-usd');
                     const unmintedModalTotalLuna = document.getElementById('unminted-modal-total-luna');
                     const unmintedModalTotalUsd = document.getElementById('unminted-modal-total-usd');
                     if(unmintedModalCount1) unmintedModalCount1.textContent = unmintedCount.toLocaleString();
                     if(unmintedModalCount2) unmintedModalCount2.textContent = unmintedCount.toLocaleString();
                     if(unmintedModalBackingLuna) unmintedModalBackingLuna.textContent = backingInLunaLive.toFixed(4);
                     if(unmintedModalBackingUsd) unmintedModalBackingUsd.textContent = backingInUSD.toFixed(4);
                     if(unmintedModalTotalLuna) unmintedModalTotalLuna.textContent = `${unmintedBackingLuna.toLocaleString('en-US', {maximumFractionDigits: 0})} LUNA`;
                     if(unmintedModalTotalUsd) unmintedModalTotalUsd.textContent = `$${unmintedBackingUSD.toLocaleString('en-US', {maximumFractionDigits: 0})} USD`;

                    console.log("DEBUG: UI updates triggered."); 

                    // Store the result globally
                    currentSnapshotData = snapshotResult; 


                } catch (error) {
                    console.error("DEBUG: Failed to fetch or process live data:", error); 
                    // --- Update snapshot status on error ---
                     snapshotResult = { timestamp: new Date().toISOString(), status: "error", error: error.message };
                     currentSnapshotData = snapshotResult; 

                    // ... (rest of the error handling for UI remains the same) ...
                     const { keyMetrics } = dashboardData;
                     buildTreasuryTable(null, []); buildTlaVp(null, null); buildTlaDeposits(null); 
                     updateTile('daodao-staked', keyMetrics.daodaoStaked.toLocaleString(), false);
                     updateTile('dao-members', keyMetrics.daoMembers.toLocaleString(), false);
                     updateTile('enterprise-staked-holder', keyMetrics.enterpriseStakedHolder.toLocaleString(), false, { titleId: 'enterprise-staked-title'});
                     updateTile('backing-per-nft-ampluna', 'Error', false, { titleId: 'backing-ampluna-title', subtextId: 'backing-per-nft-change', subtext: 'Ratio: Error' });
                     updateTile('backing-per-nft-luna-live', keyMetrics.backingInLuna.toFixed(2), false, { titleId: 'backing-luna-live-title'});
                     updateTile('backing-per-nft-usd', 'Error', false, { titleId: 'backing-usd-title', subtextId: 'live-luna-price', subtext: 'Price Error' });
                     updateTile('unminted-nft-backing-luna', 'Error', false, { titleId: 'unminted-nft-backing-title' });
                      const unmintedNftBackingUsdEl = document.getElementById('unminted-nft-backing-usd'); if (unmintedNftBackingUsdEl) unmintedNftBackingUsdEl.textContent = 'Error';
                      const unmintedModalBackingLuna = document.getElementById('unminted-modal-backing-luna'); const unmintedModalBackingUsd = document.getElementById('unminted-modal-backing-usd'); const unmintedModalTotalLuna = document.getElementById('unminted-modal-total-luna'); const unmintedModalTotalUsd = document.getElementById('unminted-modal-total-usd');
                      if(unmintedModalBackingLuna) unmintedModalBackingLuna.textContent = 'Error'; if(unmintedModalBackingUsd) unmintedModalBackingUsd.textContent = 'Error'; if(unmintedModalTotalLuna) unmintedModalTotalLuna.textContent = 'Error'; if(unmintedModalTotalUsd) unmintedModalTotalUsd.textContent = 'Error';

                } finally {
                     isFetching = false; // Allow fetching again
                     console.log("DEBUG: Finished fetchLiveOnChainData attempt."); // DEBUG LOG
                      // Update static tiles regardless of success/failure, if needed
                       console.log("DEBUG: Updating static tiles (final check)..."); 
                       
                       // Fetch avg daily gain from GitHub snapshots (handles its own fallback to static)
                       fetchAvgDailyGainFromGitHub();
                       
                       // Fetch TLA data from GitHub snapshots and update tile
                       updateTlaFromGitHub().then(success => {
                           if (success) {
                               // Re-run buildTlaDeposits with the updated data and cached price data
                               buildTlaDeposits(cachedPriceData);
                               // Update the title indicator to show it's from snapshot
                               const tlaTitleEl = document.getElementById('dao-tla-title');
                               if (tlaTitleEl) {
                                   const existingDot = tlaTitleEl.querySelector('.pulse-dot, .static-dot-red');
                                   if (existingDot) existingDot.remove();
                                   const newDot = document.createElement('span');
                                   newDot.className = 'static-dot-red ml-1';
                                   tlaTitleEl.appendChild(newDot);
                               }
                               console.log("DEBUG: TLA tile updated from GitHub snapshot");
                           }
                       });
                       
                       const daoBrokenTotalEl = document.getElementById('dao-broken-total'); if (daoBrokenTotalEl) daoBrokenTotalEl.textContent = (1000).toLocaleString(); 
                       const supplyDaoControlledEl = document.getElementById('supply-dao-controlled'); if (supplyDaoControlledEl) supplyDaoControlledEl.textContent = (1000).toLocaleString(); 
                       console.log("DEBUG: Finished static tile update check."); 
                }
            }
            
            // --- Helper Functions ---

            const showCopyToast = (text) => {
                let toast = document.getElementById('copy-toast');
                if (!toast) {
                    toast = document.createElement('div');
                    toast.id = 'copy-toast';
                    toast.className = 'fixed bottom-4 right-4 bg-teal-500 text-white px-4 py-2 rounded shadow-lg transform transition-all duration-300 translate-y-20 opacity-0 z-50';
                    document.body.appendChild(toast);
                }
                toast.textContent = text;
                toast.classList.remove('translate-y-20', 'opacity-0');
                setTimeout(() => {
                    toast.classList.add('translate-y-20', 'opacity-0');
                }, 3000);
            };

            const copyToClipboard = (textToCopy, typeName = 'Address') => {
                if (navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard.writeText(textToCopy)
                        .then(() => showCopyToast(`${typeName} copied!`))
                        .catch(() => fallbackCopy(textToCopy, typeName));
                } else {
                    fallbackCopy(textToCopy, typeName);
                }
            };

            const fallbackCopy = (textToCopy, typeName) => {
                const textArea = document.createElement("textarea");
                textArea.value = textToCopy;
                textArea.style.position = "fixed";
                textArea.style.left = "-9999px";
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    document.execCommand('copy');
                    showCopyToast(`${typeName} copied!`);
                } catch (err) {
                    console.error('Fallback copy failed', err);
                }
                document.body.removeChild(textArea);
            };

            function setupInfoModals() {
                 const modalTriggers = {
                    'daodao-staked-card': 'daodaoModal',
                    'enterprise-staked-card': 'enterpriseModal',
                    'dao-broken-card': 'daoBrokenModal',
                    'unminted-backing-card': 'unmintedModal',
                    'dao-treasury-card': 'treasuryModal',
                    'logo-modal-trigger': 'logoModal', 
                    'dao-tla-vp-card': 'tlaVpModal',
                    'dao-tla-card': 'tlaModal',
                    'snapshot-link': 'snapshotModal'
                };

                const openModal = (modalId) => {
                    const modal = document.getElementById(modalId);
                    if (modal) {
                        modal.classList.remove('hidden');
                        // Small timeout to allow display:block to apply before opacity transition
                        setTimeout(() => {
                            modal.classList.remove('opacity-0');
                            const content = modal.querySelector('.modal-content');
                            if (content) {
                                content.classList.remove('opacity-0', 'scale-95');
                            }
                        }, 10);
                    }
                };

                const closeModalFunc = (modal) => {
                    modal.classList.add('opacity-0');
                    const content = modal.querySelector('.modal-content');
                    if (content) {
                        content.classList.add('opacity-0', 'scale-95');
                    }
                    // Wait for transition to finish before hiding
                    setTimeout(() => {
                        modal.classList.add('hidden');
                    }, 300);
                };

                for (const triggerId in modalTriggers) {
                    const trigger = document.getElementById(triggerId);
                    if (trigger) {
                        trigger.addEventListener('click', (e) => {
                            // For snapshot-link (span), don't check for a tags
                            if (triggerId === 'snapshot-link') {
                                e.preventDefault();
                                openModal(modalTriggers[triggerId]);
                                return;
                            }
                            // Prevent opening if clicking a link inside the card
                            if (e.target.tagName === 'A' || e.target.closest('a')) return;
                            openModal(modalTriggers[triggerId]);
                        });
                    }
                }

                document.querySelectorAll('.modal-close').forEach(button => {
                    button.addEventListener('click', function() {
                        const modal = this.closest('.modal');
                        closeModalFunc(modal);
                    });
                });

                 document.querySelectorAll('.modal').forEach(modal => {
                    modal.addEventListener('click', function(e) {
                        if (e.target === this) {
                            closeModalFunc(this);
                        }
                    });
                 });
            }

            function buildLogoModal() {
                 const container = document.getElementById('logo-library-container'); 
                 if (!container) return; 
                 
                 const logos = [
                    { "name": "Alliance DAO", "url": "https://raw.githubusercontent.com/defipatriot/aDAO-Image-Files/main/Alliance%20DAO%20Logo.png" }, 
                    { "name": "Alliance DAO (No BG)", "url": "https://raw.githubusercontent.com/defipatriot/aDAO-Image-Files/main/aDAO%20Logo%20No%20Background.png" }, 
                    { "name": "Alliance DAO (SVG)", "url": "https://raw.githubusercontent.com/defipatriot/aDAO-Image-Files/main/aDAO%20Logo.svg" }, 
                    { "name": "Enterprise Protocol", "url": "https://raw.githubusercontent.com/defipatriot/aDAO-Image-Files/main/Enterprise.jpg" }, 
                    { "name": "Boost", "url": "https://raw.githubusercontent.com/defipatriot/aDAO-Image-Files/main/Boost%20Logo.png" }, 
                    { "name": "BackBone Labs", "url": "https://raw.githubusercontent.com/defipatriot/aDAO-Image-Files/main/BBL%20No%20Background.png" }, 
                    { "name": "Terra", "url": "https://raw.githubusercontent.com/defipatriot/aDAO-Image-Planets-Empty/main/Terra.PNG" }
                 ];

                container.innerHTML = ''; 
                logos.forEach(logo => {
                    const div = document.createElement('div');
                    div.className = 'bg-gray-800/50 p-4 rounded-lg flex flex-col items-center justify-between h-full group hover:bg-gray-700/50 transition-colors';
                    div.innerHTML = `
                        <div class="h-24 w-full flex items-center justify-center mb-4 bg-black/20 rounded p-2">
                            <img src="${logo.url}" alt="${logo.name}" class="max-h-full max-w-full object-contain">
                        </div>
                        <h3 class="font-bold text-white mb-2">${logo.name}</h3>
                        <button class="copy-logo-url-btn bg-gray-700 hover:bg-cyan-600 text-white text-xs font-bold py-2 px-4 rounded transition-colors w-full" data-url="${logo.url}">
                            <i class="fas fa-copy mr-2"></i> Copy URL
                        </button>
                    `;
                    container.appendChild(div);
                });

                document.querySelectorAll('.copy-logo-url-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        copyToClipboard(this.dataset.url, 'Logo URL');
                    });
                });
            }
            
              function buildTreasuryTable(priceData, liveAssets) { /* ... no changes needed ... */ 
                 const container = document.getElementById('treasury-table-container');
                 const totalValueEl = document.getElementById('dao-treasury-total'); 
                 if (!container || !totalValueEl) { return; }
                
                let totalLiveUsd = 0;
                const valuedAssets = []; const unvaluedAssets = [];
                 liveAssets.forEach(asset => {
                    let livePrice = null;
                    if (priceData && priceData[asset.geckoId]) { livePrice = priceData[asset.geckoId].usd; }
                    const liveValue = (typeof livePrice === 'number') ? asset.amount * livePrice : null;
                    if (liveValue !== null) { valuedAssets.push({ ...asset, liveValue }); totalLiveUsd += liveValue; } 
                    else { unvaluedAssets.push({ ...asset, liveValue: null }); }
                });
                valuedAssets.sort((a, b) => b.liveValue - a.liveValue);
                unvaluedAssets.sort((a, b) => b.amount - a.amount); 
                const sortedAssets = [...valuedAssets, ...unvaluedAssets];
                let tableHtml = `<table class="w-full text-left text-sm"><thead class="sticky top-0 bg-gray-900 z-10"><tr><th class="p-2">Asset</th><th class="p-2 text-right">Amount</th><th class="p-2 text-right">Live Value (USD)</th></tr></thead><tbody>`;
                if (sortedAssets.length === 0) {
                     tableHtml += `<tr><td colspan="3" class="text-center p-4 text-gray-500">${priceData === null ? 'Failed to load treasury data.' : 'No assets found in treasury.'}</td></tr>`;
                 } else {
                     for(const asset of sortedAssets) {
                         let amountFormatted = asset.amount < 0.0001 && asset.amount > 0 ? asset.amount.toExponential(2) : asset.amount < 1 ? asset.amount.toFixed(6) : asset.amount.toLocaleString('en-US', { maximumFractionDigits: 2 }); 
                         const logoUrl = tokenLogos[asset.name];
                         const valueDisplay = asset.liveValue !== null ? '$' + asset.liveValue.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '<span class="text-gray-500">N/A</span>'; 
                         tableHtml += `
                             <tr class="border-t border-gray-700">
                                 <td class="p-2 font-bold flex items-center gap-2">
                                     ${logoUrl ? `<img src="${logoUrl}" alt="${asset.name}" class="h-5 w-5 rounded-full" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline-block';"> <span style="display:none;" class="h-5 w-5"></span>` : '<div class="h-5 w-5 inline-block"></div>'}
                                     <span>${asset.name}</span>
                                 </td>
                                 <td class="p-2 text-right font-mono">${amountFormatted}</td>
                                 <td class="p-2 text-right font-mono">${valueDisplay}</td>
                             </tr>`;
                     }
                 }
                tableHtml += `</tbody><tfoot class="sticky bottom-0 bg-gray-900 z-10"><tr class="border-t-2 border-cyan-400 font-bold"><td class="p-2">Total</td><td></td><td class="p-2 text-right font-mono text-cyan-400">${'$' + totalLiveUsd.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td></tr></tfoot></table>`;
                container.innerHTML = tableHtml;
                 if (totalValueEl.innerHTML.includes('fa-spinner')) { totalValueEl.textContent = '$' + totalLiveUsd.toLocaleString('en-US', {maximumFractionDigits: 0}); }
                 updateTile('dao-treasury-total', null, priceData !== null, { titleId: 'dao-treasury-title' });
                 
                 // Store live treasury value globally for calculator
                 window.liveTreasuryUsd = totalLiveUsd;
            }
            
            // --- Unminted NFT Market Value Calculator ---
            window.calculateUnmintedMarketValue = function() {
                const priceInput = document.getElementById('unminted-floor-price');
                const tokenSelect = document.getElementById('unminted-price-token');
                const discountSlider = document.getElementById('unminted-discount-slider');
                const resultDiv = document.getElementById('unminted-market-result');
                
                const floorPrice = parseFloat(priceInput?.value) || 0;
                const token = tokenSelect?.value || 'bLUNA';
                const discount = parseFloat(discountSlider?.value) || 0;
                
                if (floorPrice <= 0) {
                    resultDiv?.classList.add('hidden');
                    return;
                }
                
                resultDiv?.classList.remove('hidden');
                
                // Get NFT type (default to unbroken)
                const nftType = window.unmintedNftType || 'unbroken';
                
                // Get unminted count
                const unmintedCount = dashboardData.statusSliders?.mint?.unMinted || 5828;
                
                // Get token prices from cached CoinGecko data
                const prices = window.cachedPriceData || {};
                const lunaPrice = prices['terra-luna-2']?.usd || 0;
                
                // Get LST ratios
                const lstRatios = window.lstRatios || {};
                const bLunaRatio = lstRatios.bLUNA || 1.6048;
                const ampLunaRatio = lstRatios.ampLUNA || window.cachedAmpLunaRate || 1.9015;
                const arbLunaRatio = lstRatios.arbLUNA || 2.6873;
                
                // Calculate effective price in USD
                let priceInUsd = 0;
                let tokenPrice = 0;
                
                switch(token) {
                    case 'USD':
                        priceInUsd = floorPrice;
                        tokenPrice = 1;
                        break;
                    case 'LUNA':
                        tokenPrice = lunaPrice;
                        priceInUsd = floorPrice * lunaPrice;
                        break;
                    case 'bLUNA':
                        tokenPrice = lunaPrice * bLunaRatio;
                        priceInUsd = floorPrice * tokenPrice;
                        break;
                    case 'ampLUNA':
                        tokenPrice = lunaPrice * ampLunaRatio;
                        priceInUsd = floorPrice * tokenPrice;
                        break;
                    case 'arbLUNA':
                        tokenPrice = lunaPrice * arbLunaRatio;
                        priceInUsd = floorPrice * tokenPrice;
                        break;
                }
                
                // Apply discount
                const effectivePrice = priceInUsd * (1 - discount / 100);
                const totalMarketValue = effectivePrice * unmintedCount;
                
                // Get baseline backing value for comparison
                const backingPerNftLuna = dashboardData.keyMetrics?.backingInLuna || 137;
                const backingPerNftUsd = backingPerNftLuna * lunaPrice;
                const totalBackingUsd = backingPerNftUsd * unmintedCount;
                const vsBackingMultiple = totalBackingUsd > 0 ? totalMarketValue / totalBackingUsd : 0;
                
                // Calculate premium (market value above backing)
                const premiumPerNft = effectivePrice - backingPerNftUsd;
                const totalPremium = premiumPerNft * unmintedCount;
                
                // Update display
                const effectivePriceEl = document.getElementById('unminted-effective-price');
                const nftCountEl = document.getElementById('unminted-nft-count');
                const marketValueEl = document.getElementById('unminted-market-value');
                const vsBackingEl = document.getElementById('unminted-vs-backing');
                const backingPortionEl = document.getElementById('unminted-backing-portion');
                const premiumPortionEl = document.getElementById('unminted-premium-portion');
                
                if (effectivePriceEl) {
                    if (token === 'USD') {
                        effectivePriceEl.textContent = '$' + effectivePrice.toFixed(0);
                    } else {
                        const effectiveTokenPrice = floorPrice * (1 - discount / 100);
                        effectivePriceEl.innerHTML = `${effectiveTokenPrice.toFixed(1)}`;
                    }
                }
                
                if (nftCountEl) {
                    nftCountEl.textContent = unmintedCount.toLocaleString() + ' unminted NFTs';
                }
                
                // Backing portion
                if (backingPortionEl) {
                    backingPortionEl.textContent = totalBackingUsd >= 1000 ? '$' + (totalBackingUsd/1000).toFixed(0) + 'K' : '$' + totalBackingUsd.toFixed(0);
                }
                
                // Premium portion
                if (premiumPortionEl) {
                    const sign = totalPremium >= 0 ? '+' : '';
                    premiumPortionEl.textContent = sign + '$' + (Math.abs(totalPremium)/1000).toFixed(0) + 'K';
                    premiumPortionEl.className = totalPremium >= 0 ? 'text-lg font-bold text-green-400' : 'text-lg font-bold text-red-400';
                }
                
                if (marketValueEl) {
                    if (totalMarketValue >= 1000000) {
                        marketValueEl.textContent = '$' + (totalMarketValue / 1000000).toFixed(2) + 'M';
                    } else if (totalMarketValue >= 1000) {
                        marketValueEl.textContent = '$' + (totalMarketValue / 1000).toFixed(0) + 'K';
                    } else {
                        marketValueEl.textContent = '$' + totalMarketValue.toFixed(0);
                    }
                }
                
                if (vsBackingEl) {
                    vsBackingEl.textContent = vsBackingMultiple.toFixed(1) + 'x';
                    vsBackingEl.className = vsBackingMultiple > 1 ? 'text-lg font-bold text-green-400' : 'text-lg font-bold text-yellow-400';
                }
                
                // Update Treasury Impact section with LIVE data where possible
                // 1. Treasury - LIVE from buildTreasuryTable
                const liveTreasury = window.liveTreasuryUsd || 0;
                
                // 2. TLA Locks - LIVE from buildTlaVp
                const liveLocksUsd = window.tlaVpData?.totalUsd || 0;
                
                // 3. TLA Deposits - SNAPSHOT ONLY (may be stale)
                const tlaDataMeta = getTlaDataMeta();
                const tlaDepositsUsd = dashboardData.tlaDeposits?.totalDeposit || 0;
                const depositsAreStale = tlaDataMeta.isStale;
                
                // Calculate totals
                const knownHoldings = liveTreasury + liveLocksUsd;
                const currentTreasuryUsd = knownHoldings + tlaDepositsUsd;
                const potentialTotal = currentTreasuryUsd + totalMarketValue;
                
                // Update breakdown display
                const treasuryLiveEl = document.getElementById('unminted-treasury-live');
                const locksLiveEl = document.getElementById('unminted-locks-live');
                const depositsValueEl = document.getElementById('unminted-deposits-value');
                const depositsStatusEl = document.getElementById('unminted-deposits-status');
                const currentTreasuryEl = document.getElementById('unminted-current-treasury');
                const addValueEl = document.getElementById('unminted-add-value');
                const potentialTotalEl = document.getElementById('unminted-potential-total');
                
                // Format helper
                const formatUsd = (val) => val >= 1000 ? '$' + (val/1000).toFixed(1) + 'K' : '$' + val.toFixed(0);
                const formatUsdLarge = (val) => val >= 1000000 ? '$' + (val/1000000).toFixed(2) + 'M' : '$' + (val/1000).toFixed(1) + 'K';
                
                if (treasuryLiveEl) treasuryLiveEl.textContent = formatUsd(liveTreasury);
                if (locksLiveEl) locksLiveEl.textContent = formatUsd(liveLocksUsd);
                
                if (depositsValueEl) {
                    if (depositsAreStale) {
                        depositsValueEl.innerHTML = `<span class="text-yellow-400">${formatUsd(tlaDepositsUsd)}</span> <span class="text-yellow-500 text-[10px]">(E${tlaDataMeta.loadedEpoch})</span>`;
                    } else if (tlaDepositsUsd === 0) {
                        depositsValueEl.innerHTML = `<span class="text-red-400">Unknown</span>`;
                    } else {
                        depositsValueEl.textContent = formatUsd(tlaDepositsUsd);
                    }
                }
                
                if (depositsStatusEl) {
                    if (depositsAreStale) {
                        depositsStatusEl.innerHTML = '<i class="fas fa-exclamation-triangle text-yellow-500 mr-1"></i>TLA Deposits (Stale)';
                    } else if (tlaDepositsUsd === 0) {
                        depositsStatusEl.innerHTML = '<i class="fas fa-times-circle text-red-500 mr-1"></i>TLA Deposits (Missing)';
                    } else {
                        depositsStatusEl.innerHTML = '<i class="fas fa-check-circle text-green-500 mr-1"></i>TLA Deposits (Snapshot)';
                    }
                }
                
                if (currentTreasuryEl) {
                    if (depositsAreStale || tlaDepositsUsd === 0) {
                        currentTreasuryEl.innerHTML = `${formatUsd(currentTreasuryUsd)} <span class="text-yellow-500 text-[10px]">*</span>`;
                    } else {
                        currentTreasuryEl.textContent = formatUsd(currentTreasuryUsd);
                    }
                }
                
                if (addValueEl) addValueEl.textContent = '+' + formatUsdLarge(totalMarketValue);
                if (potentialTotalEl) potentialTotalEl.textContent = formatUsdLarge(potentialTotal);
            }
            
            // Set NFT type for market value calculation
            window.setNftType = function(type) {
                window.unmintedNftType = type;
                
                const unbrokenBtn = document.getElementById('nft-type-unbroken');
                const brokenBtn = document.getElementById('nft-type-broken');
                const descEl = document.getElementById('nft-type-description');
                
                if (type === 'unbroken') {
                    unbrokenBtn.className = 'flex-1 px-3 py-2 rounded bg-green-600 text-white text-sm font-medium transition-colors';
                    brokenBtn.className = 'flex-1 px-3 py-2 rounded bg-gray-700 text-gray-400 text-sm font-medium transition-colors hover:bg-gray-600';
                    if (descEl) descEl.textContent = 'Selling complete NFTs with art, backing, and VP';
                } else {
                    brokenBtn.className = 'flex-1 px-3 py-2 rounded bg-yellow-600 text-white text-sm font-medium transition-colors';
                    unbrokenBtn.className = 'flex-1 px-3 py-2 rounded bg-gray-700 text-gray-400 text-sm font-medium transition-colors hover:bg-gray-600';
                    if (descEl) descEl.textContent = 'Broken NFTs - selling VP/governance rights only (backing already extracted)';
                }
                
                calculateUnmintedMarketValue();
            }
            
            window.updateUnmintedDiscount = function() {
                const slider = document.getElementById('unminted-discount-slider');
                const valueEl = document.getElementById('unminted-discount-value');
                if (slider && valueEl) {
                    valueEl.textContent = slider.value + '%';
                }
                calculateUnmintedMarketValue();
            }
            
            // Chart modal calculator functions
            window.calculateChartUnmintedValue = function() {
                const priceInput = document.getElementById('chart-unminted-price');
                const tokenSelect = document.getElementById('chart-unminted-token');
                const discountSlider = document.getElementById('chart-unminted-discount');
                const resultDiv = document.getElementById('chart-unminted-result');
                
                const floorPrice = parseFloat(priceInput?.value) || 0;
                const token = tokenSelect?.value || 'bLUNA';
                const discount = parseFloat(discountSlider?.value) || 0;
                
                if (floorPrice <= 0) {
                    resultDiv?.classList.add('hidden');
                    return;
                }
                
                resultDiv?.classList.remove('hidden');
                
                const nftType = window.chartNftType || 'unbroken';
                const unmintedCount = dashboardData.statusSliders?.mint?.unMinted || 5828;
                const prices = window.cachedPriceData || {};
                const lunaPrice = prices['terra-luna-2']?.usd || 0;
                const lstRatios = window.lstRatios || {};
                const bLunaRatio = lstRatios.bLUNA || 1.6048;
                const ampLunaRatio = lstRatios.ampLUNA || window.cachedAmpLunaRate || 1.9015;
                const arbLunaRatio = lstRatios.arbLUNA || 2.6873;
                
                let priceInUsd = 0;
                switch(token) {
                    case 'USD': priceInUsd = floorPrice; break;
                    case 'LUNA': priceInUsd = floorPrice * lunaPrice; break;
                    case 'bLUNA': priceInUsd = floorPrice * lunaPrice * bLunaRatio; break;
                    case 'ampLUNA': priceInUsd = floorPrice * lunaPrice * ampLunaRatio; break;
                    case 'arbLUNA': priceInUsd = floorPrice * lunaPrice * arbLunaRatio; break;
                }
                
                const effectivePrice = priceInUsd * (1 - discount / 100);
                const totalMarketValue = effectivePrice * unmintedCount;
                const backingPerNftLuna = dashboardData.keyMetrics?.backingInLuna || 137;
                const backingPerNftUsd = backingPerNftLuna * lunaPrice;
                const totalBackingUsd = backingPerNftUsd * unmintedCount;
                const vsBackingMultiple = totalBackingUsd > 0 ? totalMarketValue / totalBackingUsd : 0;
                const totalPremium = totalMarketValue - totalBackingUsd;
                
                // Update display
                const effPriceEl = document.getElementById('chart-unminted-eff-price');
                const countEl = document.getElementById('chart-unminted-count');
                const totalEl = document.getElementById('chart-unminted-total');
                const vsBackingEl = document.getElementById('chart-unminted-vs-backing');
                const backingEl = document.getElementById('chart-unminted-backing');
                const premiumEl = document.getElementById('chart-unminted-premium-val');
                
                if (effPriceEl) {
                    const effTokenPrice = floorPrice * (1 - discount / 100);
                    effPriceEl.textContent = token === 'USD' ? '$' + effectivePrice.toFixed(0) : effTokenPrice.toFixed(1);
                }
                if (countEl) countEl.textContent = unmintedCount.toLocaleString() + ' unminted NFTs';
                if (backingEl) backingEl.textContent = '$' + (totalBackingUsd/1000).toFixed(0) + 'K';
                if (premiumEl) {
                    premiumEl.textContent = (totalPremium >= 0 ? '+' : '') + '$' + (Math.abs(totalPremium)/1000).toFixed(0) + 'K';
                    premiumEl.className = totalPremium >= 0 ? 'text-sm font-bold text-green-400' : 'text-sm font-bold text-red-400';
                }
                if (totalEl) {
                    totalEl.textContent = totalMarketValue >= 1000000 ? '$' + (totalMarketValue/1000000).toFixed(2) + 'M' : '$' + (totalMarketValue/1000).toFixed(0) + 'K';
                }
                if (vsBackingEl) {
                    vsBackingEl.textContent = vsBackingMultiple.toFixed(1) + 'x';
                    vsBackingEl.className = vsBackingMultiple > 1 ? 'text-sm font-bold text-green-400' : 'text-sm font-bold text-yellow-400';
                }
                
                // Update Treasury Impact section with LIVE data where possible
                const liveTreasury = window.liveTreasuryUsd || 0;
                const liveLocksUsd = window.tlaVpData?.totalUsd || 0;
                const tlaDataMeta = getTlaDataMeta();
                const tlaDepositsUsd = dashboardData.tlaDeposits?.totalDeposit || 0;
                const depositsAreStale = tlaDataMeta.isStale;
                
                const currentTreasuryUsd = liveTreasury + liveLocksUsd + tlaDepositsUsd;
                const potentialTotal = currentTreasuryUsd + totalMarketValue;
                
                const formatUsd = (val) => val >= 1000 ? '$' + (val/1000).toFixed(1) + 'K' : '$' + val.toFixed(0);
                const formatUsdLarge = (val) => val >= 1000000 ? '$' + (val/1000000).toFixed(2) + 'M' : '$' + (val/1000).toFixed(1) + 'K';
                
                const chartTreasuryLiveEl = document.getElementById('chart-treasury-live');
                const chartLocksLiveEl = document.getElementById('chart-locks-live');
                const chartDepositsValueEl = document.getElementById('chart-deposits-value');
                const chartDepositsStatusEl = document.getElementById('chart-deposits-status');
                const chartCurrentTreasuryEl = document.getElementById('chart-current-treasury');
                const chartUnmintedAddEl = document.getElementById('chart-unminted-add');
                const chartPotentialTotalEl = document.getElementById('chart-potential-total');
                
                if (chartTreasuryLiveEl) chartTreasuryLiveEl.textContent = formatUsd(liveTreasury);
                if (chartLocksLiveEl) chartLocksLiveEl.textContent = formatUsd(liveLocksUsd);
                
                if (chartDepositsValueEl) {
                    if (depositsAreStale) {
                        chartDepositsValueEl.innerHTML = `<span class="text-yellow-400">${formatUsd(tlaDepositsUsd)}</span>`;
                    } else if (tlaDepositsUsd === 0) {
                        chartDepositsValueEl.innerHTML = `<span class="text-red-400">--</span>`;
                    } else {
                        chartDepositsValueEl.textContent = formatUsd(tlaDepositsUsd);
                    }
                }
                
                if (chartDepositsStatusEl) {
                    if (depositsAreStale) {
                        chartDepositsStatusEl.innerHTML = '<i class="fas fa-exclamation-triangle text-yellow-500 mr-1"></i>TLA Deposits';
                    } else if (tlaDepositsUsd === 0) {
                        chartDepositsStatusEl.innerHTML = '<i class="fas fa-times-circle text-red-500 mr-1"></i>TLA Deposits';
                    } else {
                        chartDepositsStatusEl.innerHTML = '<i class="fas fa-check-circle text-green-500 mr-1"></i>TLA Deposits';
                    }
                }
                
                if (chartCurrentTreasuryEl) chartCurrentTreasuryEl.textContent = formatUsd(currentTreasuryUsd);
                if (chartUnmintedAddEl) chartUnmintedAddEl.textContent = '+' + formatUsdLarge(totalMarketValue);
                if (chartPotentialTotalEl) chartPotentialTotalEl.textContent = formatUsdLarge(potentialTotal);
            }
            
            window.updateChartUnmintedDiscount = function() {
                const slider = document.getElementById('chart-unminted-discount');
                const valueEl = document.getElementById('chart-unminted-discount-val');
                if (slider && valueEl) valueEl.textContent = slider.value + '%';
                calculateChartUnmintedValue();
            }
            
            window.setChartNftType = function(type) {
                window.chartNftType = type;
                const unbrokenBtn = document.getElementById('chart-nft-unbroken');
                const brokenBtn = document.getElementById('chart-nft-broken');
                if (type === 'unbroken') {
                    unbrokenBtn.className = 'flex-1 px-2 py-1.5 rounded bg-green-600 text-white text-xs font-medium';
                    brokenBtn.className = 'flex-1 px-2 py-1.5 rounded bg-gray-700 text-gray-400 text-xs font-medium hover:bg-gray-600';
                } else {
                    brokenBtn.className = 'flex-1 px-2 py-1.5 rounded bg-yellow-600 text-white text-xs font-medium';
                    unbrokenBtn.className = 'flex-1 px-2 py-1.5 rounded bg-gray-700 text-gray-400 text-xs font-medium hover:bg-gray-600';
                }
                calculateChartUnmintedValue();
            }
            
            async function buildTlaDeposits(priceData) {
                 // First try dashboardData.tlaDeposits, then fallback to fetchTlaData for v3 format
                 let tlaData = dashboardData.tlaDeposits;
                 let hasValidTlaData = tlaData && tlaData.tokenBalances && tlaData.tokenBalances.length > 0 && tlaData.totalDeposit > 0;
                 
                 // If no data from adao_json_storage, try the new tla_json_storage v3 format
                 if (!hasValidTlaData) {
                     const v3Data = await fetchTlaData();
                     if (v3Data?.dashboard?.tla_deposits) {
                         const deposits = v3Data.dashboard.tla_deposits;
                         tlaData = {
                             totalDeposit: deposits.total_usd || 0,
                             estApr: deposits.apr || 0,
                             tokenBalances: (deposits.tokens || []).map(t => ({
                                 name: t.symbol || t.name,
                                 amount: t.amount,
                                 value: t.usd || t.value,
                                 price: t.price
                             })),
                             snapshotDate: v3Data.meta?.generated_at,
                             tokenPricesAtSnapshot: v3Data.token_prices || {}
                         };
                         hasValidTlaData = tlaData.tokenBalances.length > 0 && tlaData.totalDeposit > 0;
                     }
                 }
                 
                 const totalValueTileEl = document.getElementById('dao-tla-total');
                 const aprTileEl = document.getElementById('dao-tla-apr');
                 const modalTotalUsdEl = document.getElementById('tla-deposit-total-usd');
                 const modalTotalAprEl = document.getElementById('tla-deposit-total-apr');
                 const snapshotDateEl = document.getElementById('tla-snapshot-date');
                 const tokensContainer = document.getElementById('tla-tokens-container');
                 
                 if (!hasValidTlaData) {
                     // No TLA data yet - show waiting message
                     if (totalValueTileEl) totalValueTileEl.textContent = '--';
                     if (aprTileEl) aprTileEl.textContent = 'Awaiting Snapshot';
                     if (modalTotalUsdEl) modalTotalUsdEl.textContent = 'Awaiting Snapshot Data';
                     if (modalTotalAprEl) modalTotalAprEl.textContent = '';
                     if (snapshotDateEl) snapshotDateEl.textContent = '--';
                     if (tokensContainer) tokensContainer.innerHTML = '<p class="text-center text-gray-500 p-4">No TLA data available yet.</p>';
                     updateTile('dao-tla-total', null, false, { titleId: 'dao-tla-title' }); 
                     return;
                 }
                 
                 // Update tile values (always update, don't check for spinner)
                 if (totalValueTileEl) { 
                     totalValueTileEl.textContent = `$${tlaData.totalDeposit.toLocaleString('en-US', {minimumFractionDigits: 0})}`; 
                 }
                 if (aprTileEl) { 
                     aprTileEl.textContent = `Est. APR ${tlaData.estApr.toFixed(2)}%`; 
                 }
                 updateTile('dao-tla-total', null, false, { titleId: 'dao-tla-title' }); 
                 
                 // Update modal header
                 if (modalTotalUsdEl) modalTotalUsdEl.textContent = `$${tlaData.totalDeposit.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                 if (modalTotalAprEl) modalTotalAprEl.textContent = `Est. APR ${tlaData.estApr.toFixed(2)}%`;
                 if (snapshotDateEl && tlaData.snapshotDate) snapshotDateEl.textContent = new Date(tlaData.snapshotDate).toLocaleDateString();
                 
                 // Build tokens table with Snap Value and Live Value columns
                 let tokensHtml = `
                    <table class="w-full text-left text-sm">
                        <thead>
                            <tr class="text-gray-500 text-xs">
                                <th class="p-1">Token</th>
                                <th class="p-1 text-right">Balance</th>
                                <th class="p-1 text-right">Snap Value</th>
                                <th class="p-1 text-right">Live Value</th>
                            </tr>
                        </thead>
                        <tbody>`;
                 let totalLiveEstValue = 0;
                 let totalSnapValue = tlaData.totalDeposit || 0; // Total from snapshot
                 
                 // Get snapshot token prices if available
                 const snapPrices = tlaData.tokenPricesAtSnapshot || {};
                 
                 // Use LST ratios from snapshot or global ratios
                 const snapshotLstRatios = tlaData.lstRatios || tlaData.ampRatios || {};
                 const globalRatios = window.lstRatios || {};
                 
                 // Build comprehensive LST ratio map with base token info
                 const lstRatioMap = { 
                     "ampLUNA": { ratio: snapshotLstRatios.ampLUNA || globalRatios.ampLUNA || window.cachedAmpLunaRate || 1.9015, baseGeckoId: 'terra-luna-2', baseName: 'LUNA' },
                     "arbLUNA": { ratio: snapshotLstRatios.arbLUNA || globalRatios.arbLUNA || 2.6873, baseGeckoId: 'terra-luna-2', baseName: 'LUNA' },
                     "bLUNA": { ratio: snapshotLstRatios.bLUNA || globalRatios.bLUNA || 1.6048, baseGeckoId: 'terra-luna-2', baseName: 'LUNA' },
                     "ampCAPA": { ratio: snapshotLstRatios.ampCAPA || globalRatios.ampCAPA || 1.1055, baseGeckoId: 'capapult', baseName: 'CAPA' }, 
                     "ampROAR": { ratio: snapshotLstRatios.ampROAR || globalRatios.ampROAR || 1.1087, baseGeckoId: 'lion-dao', baseName: 'ROAR' },
                     "xASTRO": { ratio: snapshotLstRatios.xASTRO || globalRatios.xASTRO || 1.22, baseGeckoId: 'astroport-fi', baseName: 'ASTRO' }
                 };
                 
                 // Token name to gecko ID mapping for snap prices
                 const tokenToSnapKey = {
                     'LUNA': 'LUNA', 'ampLUNA': 'ampLUNA', 'CAPA': 'CAPA', 'ROAR': 'ROAR', 'xASTRO': 'xASTRO', 'ASTRO': 'ASTRO'
                 };
                 
                 tlaData.tokenBalances.forEach(token => {
                     const logoUrl = tokenLogos[token.name]; 
                     let liveValue = null;
                     let snapValue = null;
                     let livePrice = null;
                     let snapPrice = null;
                     let livePriceDisplay = '<span class="text-gray-600">?</span>';
                     let snapPriceDisplay = '<span class="text-gray-600">?</span>';
                     
                     // Get snap price
                     const snapKey = tokenToSnapKey[token.name];
                     if (snapKey && snapPrices[snapKey]) {
                         snapPrice = snapPrices[snapKey];
                         snapValue = token.amount * snapPrice;
                     }
                     
                     // Get live price
                     if (priceData) { 
                         const geckoId = token.geckoId;
                         if (geckoId && priceData[geckoId] && typeof priceData[geckoId].usd === 'number') { 
                             livePrice = priceData[geckoId].usd;
                             liveValue = token.amount * livePrice; 
                         } else if (lstRatioMap[token.name]) {
                             // LST token - calculate price from base token  ratio
                             const ratioInfo = lstRatioMap[token.name]; 
                             const baseTokenPrice = priceData[ratioInfo.baseGeckoId]?.usd;
                             if (typeof baseTokenPrice === 'number') { 
                                 const baseTokenAmount = token.amount * ratioInfo.ratio; 
                                 liveValue = baseTokenAmount * baseTokenPrice;
                                 livePrice = baseTokenPrice * ratioInfo.ratio;
                             }
                             // Also calc snap value for LST tokens
                             const baseSnapPrice = snapPrices[ratioInfo.baseName];
                             if (baseSnapPrice) {
                                 snapPrice = baseSnapPrice * ratioInfo.ratio;
                                 snapValue = token.amount * snapPrice;
                             }
                         }
                         if (typeof liveValue === 'number') { totalLiveEstValue += liveValue; }
                     }
                     
                     // Format prices
                     const formatPrice = (p) => {
                         if (p === null) return '?';
                         if (p < 0.0000001) return '$' + p.toFixed(10);
                         if (p < 0.000001) return '$' + p.toFixed(9);
                         if (p < 0.00001) return '$' + p.toFixed(8);
                         if (p < 0.0001) return '$' + p.toFixed(7);
                         if (p < 0.01) return '$' + p.toFixed(6);
                         return '$' + p.toFixed(4);
                     };
                     
                     const formatValue = (v) => {
                         if (v === null) return '<span class="text-gray-500">--</span>';
                         return '$' + v.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                     };
                     
                     let amountFormatted = token.amount < 0.0001 && token.amount > 0 
                         ? token.amount.toExponential(2) 
                         : token.amount < 1 
                             ? token.amount.toFixed(6) 
                             : token.amount.toLocaleString('en-US', { maximumFractionDigits: 2 }); 
                     
                     tokensHtml += `
                        <tr class="border-t border-gray-700">
                            <td class="p-1 font-bold flex items-center gap-2">
                                ${logoUrl ? `<img src="${logoUrl}" alt="${token.name}" class="h-5 w-5 rounded-full" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline-block';"><span style="display:none;" class="h-5 w-5"></span>` : '<div class="h-5 w-5 inline-block"></div>'} ${token.name}
                            </td> 
                            <td class="p-1 text-right font-mono">${amountFormatted}</td>
                            <td class="p-1 text-right">
                                <span class="font-mono text-yellow-400">${formatValue(snapValue)}</span>
                                <span class="text-gray-600 text-[9px] block">@${formatPrice(snapPrice)}</span>
                            </td>
                            <td class="p-1 text-right">
                                <span class="font-mono text-green-400">${formatValue(liveValue)}</span>
                                <span class="text-gray-600 text-[9px] block">@${formatPrice(livePrice)}</span>
                            </td>
                        </tr>`; 
                 });
                 
                 tokensHtml += `</tbody>
                    <tfoot class="sticky bottom-0 bg-gray-900 z-10">
                        <tr class="border-t-2 border-cyan-400 font-bold">
                            <td class="p-1" colspan="2">Totals</td>
                            <td class="p-1 text-right font-mono text-yellow-400">$${totalSnapValue.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                            <td class="p-1 text-right font-mono text-cyan-400">$${totalLiveEstValue.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                        </tr>
                    </tfoot>
                </table>`;
                 tokensHtml += '<p class="text-xs text-gray-500 mt-2"><span class="text-yellow-400">Snap Value</span> = value at snapshot time | <span class="text-green-400">Live Value</span> = current CoinGecko price</p>';
                 if (tokensContainer) tokensContainer.innerHTML = tokensHtml;
            }
            
            // --- TLA Data Fetch (used by multiple functions) ---
            let cachedTlaData = null;
            let tlaDataMeta = { loadedEpoch: null, currentEpoch: null, isStale: false, epochsOld: 0 };
            
            // Calculate current epoch from reference data or formula
            async function getCurrentEpoch() {
                try {
                    // Try fetching epoch reference file
                    const epochRefUrl = 'https://raw.githubusercontent.com/defipatriot/tla_json_storage/main/epoch_1-300_date.json';
                    const response = await fetch(epochRefUrl);
                    if (response.ok) {
                        const epochs = await response.json();
                        const now = new Date();
                        // Find the epoch we're currently in
                        for (const ep of epochs) {
                            const start = new Date(ep.start_time);
                            const end = new Date(ep.end_time);
                            if (now >= start && now < end) {
                                return ep.epoch;
                            }
                        }
                        // If past all defined epochs, return the last one
                        return epochs[epochs.length - 1]?.epoch || 165;
                    }
                } catch (e) {
                    console.warn('Could not fetch epoch reference, using calculation');
                }
                // Fallback: calculate from known reference point
                // Epoch 162 started Dec 1, 2025 - each epoch is 7 days
                const epochReferenceDate = new Date('2025-12-01T00:00:00Z');
                const epochReferenceNumber = 162;
                const msPerWeek = 7 * 24 * 60 * 60 * 1000;
                const now = new Date();
                const weeksDiff = Math.floor((now - epochReferenceDate) / msPerWeek);
                return epochReferenceNumber + weeksDiff;
            }
            
            async function fetchTlaData() {
                if (cachedTlaData) return cachedTlaData;
                try {
                    // Get accurate current epoch
                    const currentEpoch = await getCurrentEpoch();
                    tlaDataMeta.currentEpoch = currentEpoch;
                    
                    // For TLA data, we want previous epoch (completed) since current is in progress
                    // Try: previous epoch first (most recent completed), then go back further
                    const epochsToTry = [currentEpoch - 1, currentEpoch - 2, currentEpoch - 3];
                    
                    for (let i = 0; i < epochsToTry.length; i++) {
                        const tryEpoch = epochsToTry[i];
                        const url = `https://raw.githubusercontent.com/defipatriot/tla_json_storage/main/tla-data-epoch-${tryEpoch}-end.json`;
                        try {
                            const response = await fetch(url);
                            if (response.ok) {
                                cachedTlaData = await response.json();
                                tlaDataMeta.loadedEpoch = tryEpoch;
                                tlaDataMeta.epochsOld = i; // 0 = previous epoch (expected), 1+ = stale
                                tlaDataMeta.isStale = i > 0; // Stale if we had to go back more than 1
                                console.log(`TLA Data loaded from epoch ${tryEpoch} (${i > 0 ? 'STALE - ' + i + ' epochs old' : 'current'})`);
                                return cachedTlaData;
                            }
                        } catch (e) {
                            continue; // Try next epoch
                        }
                    }
                    throw new Error('TLA data not found in last 3 epochs');
                } catch (error) {
                    console.error('Failed to fetch TLA data:', error);
                    return null;
                }
            }
            
            // Get TLA data metadata (for UI to check staleness)
            function getTlaDataMeta() {
                return tlaDataMeta;
            }
            
            // Cache for TLA ext data (LST ratios)
            let cachedTlaExtData = null;
            
            async function fetchTlaExtData() {
                if (cachedTlaExtData) return cachedTlaExtData;
                try {
                    const currentEpoch = dashboardData?.tlaDeposits?.currentEpoch || 163;
                    // TLA ext files are in a separate repo
                    const url = `https://raw.githubusercontent.com/defipatriot/tla-ext_json_storage/main/tla-ext-epoch-${currentEpoch}-end.json`;
                    const response = await fetch(url);
                    if (!response.ok) {
                        // Fallback to previous epoch
                        const prevUrl = `https://raw.githubusercontent.com/defipatriot/tla-ext_json_storage/main/tla-ext-epoch-${currentEpoch - 1}-end.json`;
                        const prevResponse = await fetch(prevUrl);
                        if (!prevResponse.ok) {
                            console.warn('TLA ext data not found, using defaults');
                            return null;
                        }
                        cachedTlaExtData = await prevResponse.json();
                        return cachedTlaExtData;
                    }
                    cachedTlaExtData = await response.json();
                    console.log('Loaded TLA ext data:', cachedTlaExtData?.meta?.epoch);
                    return cachedTlaExtData;
                } catch (error) {
                    console.error('Failed to fetch TLA ext data:', error);
                    return null;
                }
            }
            
            // Get arbLUNA ratio from TLA ext data or fallback
            // Note: ampLUNA ratio is fetched LIVE from Eris contract - don't replace it!
            // arbLUNA ratio can't be fetched live reliably, so we use TLA ext file
            async function getArbLunaRatio() {
                const tlaExtData = await fetchTlaExtData();
                // Try lst_ratios first (new format), then votion.ratios (old format)
                const ratio = tlaExtData?.lst_ratios?.tokens?.arbLUNA?.ratio 
                           || tlaExtData?.votion?.ratios?.arbLUNA 
                           || 2.6873; // Default fallback
                window.cachedArbLunaRate = ratio;
                return ratio;
            }
            
            // Store all LST ratios globally for use throughout the app
            window.lstRatios = {
                ampLUNA: null, // Set from LIVE Eris contract
                arbLUNA: null, // From TLA ext
                bLUNA: null,   // From TLA ext
                ampCAPA: null, // From TLA ext
                ampROAR: null, // From TLA ext
                xASTRO: null,  // From TLA ext
                source: null,
                epoch: null
            };
            
            // Load all LST ratios from TLA ext file and update UI
            async function loadLstRatiosFromExt() {
                const tlaExtData = await fetchTlaExtData();
                const currentEpoch = dashboardData?.tlaDeposits?.currentEpoch || 163;
                const extEpoch = tlaExtData?.meta?.epoch || null;
                
                // Check if TLA ext data is from the current epoch
                const isCurrentEpoch = extEpoch && extEpoch >= currentEpoch;
                const hasLstRatios = tlaExtData?.lst_ratios?.tokens;
                
                // Get ratios - try new format first, then old format
                const lstTokens = tlaExtData?.lst_ratios?.tokens || {};
                const votionRatios = tlaExtData?.votion?.ratios || {};
                
                // Track which ratios came from TLA ext vs defaults
                const ratioSources = {
                    ampLUNA: lstTokens.ampLUNA?.ratio ? 'ext' : (votionRatios.ampLUNA ? 'votion' : 'default'),
                    arbLUNA: lstTokens.arbLUNA?.ratio ? 'ext' : (votionRatios.arbLUNA ? 'votion' : 'default'),
                    bLUNA: lstTokens.bLUNA?.ratio ? 'ext' : 'default',
                    ampCAPA: lstTokens.ampCAPA?.ratio ? 'ext' : 'default',
                    ampROAR: lstTokens.ampROAR?.ratio ? 'ext' : 'default',
                    xASTRO: lstTokens.xASTRO?.ratio ? 'ext' : 'default'
                };
                
                // Update global ratios
                window.lstRatios = {
                    ampLUNA: lstTokens.ampLUNA?.ratio || votionRatios.ampLUNA || window.cachedAmpLunaRate || 1.9015,
                    arbLUNA: lstTokens.arbLUNA?.ratio || votionRatios.arbLUNA || 2.6873,
                    bLUNA: lstTokens.bLUNA?.ratio || 1.6048,
                    ampCAPA: lstTokens.ampCAPA?.ratio || 1.1055,
                    ampROAR: lstTokens.ampROAR?.ratio || 1.1087,
                    xASTRO: lstTokens.xASTRO?.ratio || 1.22,
                    source: tlaExtData ? 'TLA ext file' : 'defaults',
                    epoch: extEpoch,
                    isCurrentEpoch: isCurrentEpoch,
                    ratioSources: ratioSources
                };
                
                // Also update cached arbLUNA rate
                window.cachedArbLunaRate = window.lstRatios.arbLUNA;
                
                // Update UI displays with color coding
                const displayIds = ['ampLUNA', 'arbLUNA', 'bLUNA', 'ampCAPA', 'ampROAR', 'xASTRO'];
                displayIds.forEach(token => {
                    const el = document.getElementById(`lst-ratio-display-${token}`);
                    if (el) {
                        const ratio = window.lstRatios[token];
                        const source = ratioSources[token];
                        
                        // Color based on source and epoch freshness
                        // ampLUNA will be updated to green later when live rate comes in
                        if (token === 'ampLUNA') {
                            // ampLUNA gets live rate, show as pending until live fetch
                            el.textContent = ratio ? ratio.toFixed(4) : '--';
                            el.className = 'block text-yellow-400 font-mono'; // Yellow until live
                        } else if (source === 'ext' && isCurrentEpoch) {
                            // From current epoch TLA ext file - GREEN
                            el.textContent = ratio.toFixed(4) + ' ';
                            el.className = 'block text-green-400 font-mono';
                        } else if (source === 'ext' || source === 'votion') {
                            // From TLA ext but old epoch - YELLOW
                            el.textContent = ratio.toFixed(4);
                            el.className = 'block text-yellow-400 font-mono';
                        } else {
                            // Default/fallback value - RED
                            el.textContent = ratio.toFixed(4) + ' ';
                            el.className = 'block text-red-400 font-mono';
                        }
                    }
                });
                
                // Update source display
                const sourceEl = document.getElementById('lst-ratios-source');
                if (sourceEl) {
                    if (!tlaExtData) {
                        sourceEl.textContent = ' Using default values (TLA ext file not found)';
                        sourceEl.className = 'text-xs text-red-400 mt-2';
                    } else if (!isCurrentEpoch) {
                        sourceEl.textContent = ` Epoch ${extEpoch} data (current is ${currentEpoch}) - needs update!`;
                        sourceEl.className = 'text-xs text-yellow-400 mt-2';
                    } else if (!hasLstRatios) {
                        sourceEl.textContent = `Epoch ${extEpoch} (votion.ratios only - upload new format)`;
                        sourceEl.className = 'text-xs text-yellow-400 mt-2';
                    } else {
                        sourceEl.textContent = ` Epoch ${extEpoch} (lst_ratios) - Current!`;
                        sourceEl.className = 'text-xs text-green-400 mt-2';
                    }
                }
                
                console.log('LST ratios loaded:', window.lstRatios);
                return window.lstRatios;
            }
            
            // Calculate LST token price from base token price  ratio
            function getLstPrice(lstToken, basePrices) {
                const ratios = window.lstRatios || {};
                const baseTokenMap = {
                    'ampLUNA': { base: 'terra-luna-2', ratio: ratios.ampLUNA || 1.9015 },
                    'arbLUNA': { base: 'terra-luna-2', ratio: ratios.arbLUNA || 2.6873 },
                    'bLUNA': { base: 'terra-luna-2', ratio: ratios.bLUNA || 1.6048 },
                    'ampCAPA': { base: 'capapult', ratio: ratios.ampCAPA || 1.1055 },
                    'ampROAR': { base: 'lion-dao', ratio: ratios.ampROAR || 1.1087 },
                    'xASTRO': { base: 'astroport-fi', ratio: ratios.xASTRO || 1.22 }
                };
                
                const mapping = baseTokenMap[lstToken];
                if (!mapping) return null;
                
                const basePrice = basePrices?.[mapping.base]?.usd;
                if (!basePrice) return null;
                
                return basePrice * mapping.ratio;
            }
            
            function buildTlaVp(priceData, ampLunaToLunaRate) {
                const container = document.getElementById('tla-vp-locks-container');
                const mainTileValueEl = document.getElementById('dao-tla-vp'); 
                const mainTileUsdEl = document.getElementById('dao-tla-vp-usd');
                const modalLunaEl = document.getElementById('tla-vp-modal-luna');
                const modalUsdEl = document.getElementById('tla-vp-modal-usd');
                if (!container || !mainTileValueEl || !mainTileUsdEl || !modalLunaEl || !modalUsdEl) { 
                    if(mainTileUsdEl) mainTileUsdEl.textContent = 'Error'; 
                    return; 
                }
                
                // Show loading state
                mainTileValueEl.textContent = '...';
                mainTileUsdEl.textContent = '...';
                
                // Fetch TLA data from GitHub
                fetchTlaData().then(tlaData => {
                    const lunaPriceUSD = priceData?.['terra-luna-2']?.usd;
                    const ampLunaPriceUSD = priceData?.['eris-amplified-luna']?.usd;
                    const arbLunaPriceUSD = priceData?.['staked-luna-slinky']?.usd;
                    
                    // Get LST ratios from global (loaded from TLA ext file + live ampLUNA)
                    const lstRatios = window.lstRatios || {};
                    const liveAmpLunaRatio = ampLunaToLunaRate || lstRatios.ampLUNA || 1.9015;
                    const liveArbLunaRatio = lstRatios.arbLUNA || window.cachedArbLunaRate || 2.6873;
                    
                    const ratesAreValid = typeof lunaPriceUSD === 'number' && typeof liveAmpLunaRatio === 'number';
                    
                    // Track ratio sources for display
                    const ratioSources = {
                        ampLUNA: lstRatios.ratioSources?.ampLUNA || 'default',
                        arbLUNA: lstRatios.ratioSources?.arbLUNA || 'default'
                    };
                    
                    // Get locks from TLA data file (or use fallback)
                    // Support both old format (tlaData.locks array) and new v3 format (tlaData.locks.individual_locks)
                    let locks = [];
                    let totalStaticVp = 0;
                    
                    const locksArray = tlaData?.locks?.individual_locks || (Array.isArray(tlaData?.locks) ? tlaData.locks : null);
                    
                    if (locksArray && Array.isArray(locksArray)) {
                        // Use locks from GitHub TLA file
                        locks = locksArray.map(lock => {
                            const isArbLuna = lock.asset === 'arbLUNA' || lock.bucket === 'arbLUNA';
                            const isAmpLuna = lock.asset === 'ampLUNA' || lock.bucket === 'ampLUNA';
                            
                            // Use global LST ratios
                            let ratio, directPrice, ratioSource;
                            if (isArbLuna) {
                                ratio = liveArbLunaRatio;
                                directPrice = arbLunaPriceUSD;
                                ratioSource = ratioSources.arbLUNA;
                            } else if (isAmpLuna) {
                                ratio = liveAmpLunaRatio;
                                directPrice = ampLunaPriceUSD;
                                ratioSource = ratioSources.ampLUNA;
                            } else {
                                ratio = 1;
                                directPrice = lunaPriceUSD;
                                ratioSource = 'default';
                            }
                            
                            return {
                                id: lock.id,
                                asset: lock.asset || lock.bucket,
                                amount: lock.amount,
                                ratio: ratio,
                                ratioSource: ratioSource,
                                directPrice: directPrice,
                                isLive: ratioSource === 'live' || ratioSource === 'ext',
                                staticVp: lock.vp,
                                status: lock.status || 'Max Lock'
                            };
                        });
                        totalStaticVp = locks.reduce((sum, lock) => sum + (lock.staticVp || 0), 0);
                    } else {
                        // Fallback to hardcoded values if TLA data unavailable
                        locks = [
                            { id: 600, asset: 'arbLUNA', amount: 27290, ratio: liveArbLunaRatio, ratioSource: ratioSources.arbLUNA, directPrice: arbLunaPriceUSD, isLive: ratioSources.arbLUNA !== 'default', staticVp: 631570, status: 'Max Lock (Auto)' },
                            { id: 711, asset: 'ampLUNA', amount: 413.03, ratio: liveAmpLunaRatio, ratioSource: ratioSources.ampLUNA, directPrice: ampLunaPriceUSD, isLive: ratioSources.ampLUNA === 'live', staticVp: 7316.76, status: 'Max Lock (Auto)' }
                        ];
                        totalStaticVp = 638886.76;
                    }
                    
                    let totalUnderlyingLuna = 0;
                    let totalLiveUsd = 0;
                    let locksHtml = '';
                    
                    locks.forEach(lock => {
                        const logoUrl = tokenLogos[lock.asset];
                        const underlyingLuna = lock.amount * lock.ratio;
                        
                        // Calculate USD value directly from token price (more accurate)
                        const usdValue = (lock.directPrice && typeof lock.directPrice === 'number') 
                            ? lock.amount * lock.directPrice 
                            : (ratesAreValid ? underlyingLuna * lunaPriceUSD : null);
                        
                        totalUnderlyingLuna += underlyingLuna;
                        if (usdValue !== null) totalLiveUsd += usdValue;
                        
                        // Show ratio source status
                        let ratioStatusHtml = '';
                        if (lock.ratioSource === 'live') {
                            ratioStatusHtml = '<span class="pulse-dot ml-1" title="Live from Eris"></span>';
                        } else if (lock.ratioSource === 'ext' || lock.ratioSource === 'votion') {
                            ratioStatusHtml = '<span class="ml-1 text-yellow-400" title="From TLA ext file"></span>';
                        } else {
                            ratioStatusHtml = '<span class="static-dot-red ml-1" title="Default value - needs update"></span>';
                        }
                        
                        locksHtml += `
                            <div class="bg-gray-800/50 p-4 rounded-lg grid grid-cols-1 md:grid-cols-5 gap-4 items-center text-center mt-2 text-sm">
                                <div class="font-bold text-lg text-white">
                                    <p>Lock #${lock.id}</p>
                                    <p class="text-xs text-gray-500">${lock.status}</p>
                                </div>
                                <div class="flex items-center justify-center gap-2">
                                    ${logoUrl ? `<img src="${logoUrl}" alt="${lock.asset}" class="h-6 w-6 rounded-full" onerror="this.style.display='none';">` : '<div class="h-6 w-6"></div>'}
                                    <p class="font-bold text-white">${lock.amount.toLocaleString('en-US', {maximumFractionDigits:2})} ${lock.asset}</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-400">Underlying LUNA</p>
                                    <p class="font-bold text-white">${underlyingLuna.toLocaleString('en-US', {maximumFractionDigits:2})}</p>
                                    <p class="text-xs text-gray-500 flex items-center justify-center">
                                        <span>(Ratio: ${lock.ratio.toFixed(4)})</span> ${ratioStatusHtml}
                                    </p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-400">Value (USD)</p>
                                    <p class="font-bold text-green-400">${usdValue !== null ? '$' + usdValue.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : 'N/A'}</p>
                                    <p class="text-xs text-gray-600">Live</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-400">Voting Power</p>
                                    <p class="font-bold text-purple-400">${(lock.staticVp / 1000).toFixed(2)}K VP</p>
                                    <p class="text-xs text-cyan-400">Fixed at lock</p>
                                </div>
                            </div>`;
                    });
                    
                    // Add ratio status note
                    const ampStatus = ratioSources.ampLUNA === 'live' ? ' Live' : (ratioSources.ampLUNA === 'ext' ? ' Ext' : ' Default');
                    const arbStatus = ratioSources.arbLUNA === 'ext' || ratioSources.arbLUNA === 'votion' ? ' Ext' : ' Default';
                    locksHtml += `
                        <div class="text-xs text-gray-500 mt-3 text-center">
                            <span class="mr-4">ampLUNA ratio: ${ampStatus}</span>
                            <span>arbLUNA ratio: ${arbStatus}</span>
                        </div>`;
                    
                    container.innerHTML = locksHtml;
                    
                    // Update main tile - VP as primary (from TLA file), USD as secondary (live)
                    mainTileValueEl.textContent = (totalStaticVp / 1000).toFixed(1) + 'K VP';
                    mainTileUsdEl.textContent = totalLiveUsd > 0 ? `$${totalLiveUsd.toLocaleString('en-US', {maximumFractionDigits: 0})}` : '...';
                    updateTile('dao-tla-vp-usd', null, ratesAreValid, { titleId: 'dao-tla-vp-title' });
                    
                    // Modal values
                    modalLunaEl.textContent = `~${(totalUnderlyingLuna).toLocaleString('en-US', {maximumFractionDigits:1})} LUNA`;
                    modalUsdEl.textContent = totalLiveUsd > 0 ? `$${totalLiveUsd.toLocaleString('en-US', {maximumFractionDigits: 2})}` : '--';
                    
                    // Calculate and display VP comparison (potential if adjusted today)
                    const potentialVp = Math.floor(totalUnderlyingLuna * 10); // VP = underlying LUNA  10
                    const vpGain = potentialVp - totalStaticVp;
                    const vpGainPct = totalStaticVp > 0 ? ((vpGain / totalStaticVp) * 100).toFixed(1) : '0';
                    
                    // Update VP comparison visual elements
                    const potentialGainEl = document.getElementById('vp-potential-gain');
                    const potentialGainPctEl = document.getElementById('vp-potential-gain-pct');
                    const potentialTotalEl = document.getElementById('vp-potential-total');
                    const currentBarEl = document.getElementById('vp-current-bar');
                    const potentialBarEl = document.getElementById('vp-potential-bar');
                    const barPotentialEl = document.getElementById('vp-bar-potential');
                    
                    if (potentialGainEl) potentialGainEl.textContent = `+${vpGain.toLocaleString()} VP`;
                    if (potentialGainPctEl) potentialGainPctEl.textContent = `+${vpGainPct}%`;
                    if (potentialTotalEl) potentialTotalEl.textContent = potentialVp.toLocaleString();
                    
                    // Update progress bars
                    if (currentBarEl && potentialBarEl) {
                        const ratio = potentialVp / totalStaticVp;
                        currentBarEl.style.width = '96%';
                        potentialBarEl.style.width = (96 * ratio) + '%';
                    }
                    if (barPotentialEl) barPotentialEl.textContent = (potentialVp / 1000).toFixed(1) + 'K';
                    
                    // Store VP data globally for snapshot
                    window.tlaVpData = {
                        totalVp: totalStaticVp,
                        totalUnderlyingLuna: totalUnderlyingLuna,
                        totalUsd: totalLiveUsd,
                        potentialVp: potentialVp,
                        locks: locks
                    };
                    
                    // Load vote allocation
                    loadTlaVoteAllocation();
                }).catch(err => {
                    console.error('Error building TLA VP:', err);
                    mainTileValueEl.textContent = 'Error';
                    mainTileUsdEl.textContent = '--';
                });
            }
            
            async function loadTlaVoteAllocation() {
                const container = document.getElementById('tla-vote-allocation');
                if (!container) return;
                
                const tlaData = await fetchTlaData();
                // Support both old (tlaData.pools) and new (tlaData.vote.pools) format
                const pools = tlaData?.vote?.pools || tlaData?.pools;
                if (!tlaData || !pools) {
                    container.innerHTML = '<p class="text-gray-500 text-center">Vote allocation data unavailable</p>';
                    return;
                }
                
                // Get total VP from locks summary or calculate
                const totalVp = tlaData?.locks?.summary?.total_vp || 638880;
                const filteredPools = pools.filter(p => p.adao_vp > 0);
                
                // Group by bucket
                const buckets = {};
                const bucketColors = {
                    'STABLE': { bg: 'bg-blue-900/30', border: 'border-blue-700', text: 'text-blue-400' },
                    'PROJECT': { bg: 'bg-purple-900/30', border: 'border-purple-700', text: 'text-purple-400' },
                    'BLUECHIP': { bg: 'bg-yellow-900/30', border: 'border-yellow-700', text: 'text-yellow-400' },
                    'SINGLE': { bg: 'bg-gray-700/50', border: 'border-gray-600', text: 'text-gray-400' }
                };
                
                filteredPools.forEach(p => {
                    const bucket = p.bucket || 'UNKNOWN';
                    if (!buckets[bucket]) buckets[bucket] = { pools: [], total: 0 };
                    buckets[bucket].pools.push(p);
                    buckets[bucket].total += p.adao_vp;
                });
                
                // Update bucket summary
                ['STABLE', 'PROJECT', 'BLUECHIP', 'SINGLE'].forEach(bucket => {
                    const el = document.getElementById('bucket-' + bucket.toLowerCase() + '-pct');
                    if (el) {
                        const data = buckets[bucket];
                        if (data) {
                            const pct = (data.total / totalVp * 100).toFixed(1);
                            el.textContent = pct + '%';
                        } else {
                            el.textContent = '0%';
                        }
                    }
                });
                
                // Build detailed allocation HTML
                let html = '';
                ['STABLE', 'PROJECT', 'BLUECHIP', 'SINGLE'].forEach(bucket => {
                    const data = buckets[bucket];
                    if (!data || data.pools.length === 0) return;
                    
                    const colors = bucketColors[bucket] || bucketColors['SINGLE'];
                    const bucketPct = (data.total / totalVp * 100).toFixed(1);
                    
                    html += `
                        <div class="${colors.bg} ${colors.border} border rounded-lg p-3">
                            <div class="flex justify-between items-center mb-2">
                                <h5 class="font-bold ${colors.text}">${bucket}</h5>
                                <span class="text-sm text-white">${data.total.toLocaleString()} VP (${bucketPct}%)</span>
                            </div>
                            <div class="space-y-1 text-xs">
                    `;
                    
                    // Sort pools by VP descending
                    data.pools.sort((a, b) => b.adao_vp - a.adao_vp);
                    
                    data.pools.forEach(pool => {
                        const poolPct = (pool.adao_vp / data.total * 100).toFixed(1);
                        const barWidth = Math.max(5, poolPct);
                        html += `
                            <div class="flex items-center gap-2">
                                <div class="w-32 truncate text-gray-300" title="${pool.name}">${pool.name}</div>
                                <div class="flex-1 bg-gray-700 rounded-full h-2 overflow-hidden">
                                    <div class="h-full ${colors.bg.replace('/30', '')} rounded-full" style="width: ${barWidth}%"></div>
                                </div>
                                <div class="w-20 text-right text-gray-400">${pool.adao_vp.toLocaleString()}</div>
                                <div class="w-12 text-right text-gray-500">${poolPct}%</div>
                            </div>
                        `;
                    });
                    
                    html += `
                            </div>
                        </div>
                    `;
                });
                
                // Calculate unused VP
                const totalAllocated = Object.values(buckets).reduce((sum, b) => sum + b.total, 0);
                const avgUsed = totalAllocated / 4; // Average across 4 buckets
                
                container.innerHTML = html || '<p class="text-gray-500 text-center">No vote allocations found</p>';
            }
            function buildStakerTable(tableId, stakerData) { /* ... no changes needed ... */ 
                const tableContainer = document.getElementById(tableId);
                if (!tableContainer) { return; }
                let tableHtml = `<table class="w-full text-left text-sm"><tbody>`; 
                const sortedStakers = Object.entries(stakerData).sort(([, a], [, b]) => b - a);
                if(sortedStakers.length > 0) {
                    for (const [address, count] of sortedStakers) {
                        const shortAddress = address.length > 15 ? `${address.substring(0, 6)}...${address.substring(address.length - 4)}` : address;
                        tableHtml += `<tr class="border-t border-gray-700">
                                         <td class="p-2 font-mono w-3/4" title="${address}">${shortAddress}</td>
                                         <td class="p-2 text-right font-bold w-1/4">${count}</td>
                                      </tr>`; }
                } else { tableHtml += `<tr><td colspan="2" class="text-center p-4 text-gray-500">No holder NFTs currently staked here.</td></tr>`; }
                tableHtml += `</tbody></table>`; 
                tableContainer.innerHTML = tableHtml; 
                 const totalCount = sortedStakers.reduce((sum, [, count]) => sum + count, 0); 
                 if (tableId === 'enterprise-stakers-table') {
                     const enterpriseCountEl = document.getElementById('enterprise-modal-holder-count');
                     if (enterpriseCountEl && enterpriseCountEl.innerHTML.includes('fa-spinner')) enterpriseCountEl.textContent = totalCount.toLocaleString();
                 }
                 if (tableId === 'daodao-stakers-table') {
                     const daodaoCountEl = document.getElementById('daodao-modal-holder-count');
                     if (daodaoCountEl && daodaoCountEl.innerHTML.includes('fa-spinner')) daodaoCountEl.textContent = totalCount.toLocaleString();
                 }
            }
            function updateTile(elementId, value, isLive, options = {}) { /* ... no changes needed ... */ 
                 const el = document.getElementById(elementId);
                 if (value !== null && value !== undefined && el) {
                     if (el.innerHTML.includes('fa-spinner') || value === 'Error') { el.textContent = value; }
                 }
                const titleId = options.titleId || `${elementId}-title`;
                const titleEl = document.getElementById(titleId);
                if (titleEl) {
                    const existingDot = titleEl.querySelector('.pulse-dot, .static-dot-red');
                    if (existingDot) existingDot.remove();
                    const newDot = document.createElement('span');
                    newDot.className = isLive ? 'pulse-dot ml-1' : 'static-dot-red ml-1';
                     if (!titleEl.querySelector('.pulse-dot, .static-dot-red')) { titleEl.appendChild(newDot); }
                }
                if (options.subtextId && options.subtext !== undefined) { 
                     const subtextEl = document.getElementById(options.subtextId);
                     if (subtextEl) {
                        if (subtextEl.innerHTML.includes('fa-spinner') || options.subtext === 'Error' || options.subtext === 'Ratio: Error') { 
                            subtextEl.textContent = options.subtext;
                        }
                     }
                }
            }
            // Removed placeholder constants here as they are now defined above.

            function setupInfoModalsPlaceholder() { /* REMOVED */ } 
            function buildLogoModalPlaceholder() { /* REMOVED */ }

            // --- Unclaimed Rewards Functions ---
            // Note: Different rewards may be claimed at different times
            // Track last claim info for each type
            const lastClaimInfo = {
                deposit: { prop: 'A-28', date: 'Dec 17, 2025' },
                vote: { prop: 'A-29', date: 'Dec 17, 2025' },
                rebase: { prop: 'A-26', date: 'Sep 7, 2025' },
                locks: { prop: 'A-26', date: 'Sep 7, 2025' }
            };
            
            async function updateUnclaimedRewardsTile() {
                const tlaData = await fetchTlaData();
                if (!tlaData) return;
                
                // Check for stale data and update UI
                const meta = getTlaDataMeta();
                const staleBanner = document.getElementById('unclaimed-stale-banner');
                const staleWarning = document.getElementById('unclaimed-stale-warning');
                const dataStatus = document.getElementById('unclaimed-data-status');
                
                if (meta.isStale) {
                    // Show stale warning
                    if (staleBanner) staleBanner.classList.remove('hidden');
                    if (staleWarning) staleWarning.classList.remove('hidden');
                    if (dataStatus) dataStatus.textContent = `Epoch ${meta.loadedEpoch} data`;
                    
                    // Update banner message
                    const staleEpochEl = document.getElementById('stale-epoch-num');
                    const currentEpochEl = document.getElementById('current-epoch-num');
                    if (staleEpochEl) staleEpochEl.textContent = meta.loadedEpoch;
                    if (currentEpochEl) currentEpochEl.textContent = meta.currentEpoch;
                    
                    // Add yellow tint to the card sections to indicate stale
                    document.querySelectorAll('#unclaimed-rewards-card .bg-gray-800\\/50').forEach(el => {
                        el.classList.add('border', 'border-yellow-600/30');
                    });
                } else {
                    // Data is current - hide warnings
                    if (staleBanner) staleBanner.classList.add('hidden');
                    if (staleWarning) staleWarning.classList.add('hidden');
                    if (dataStatus) dataStatus.textContent = `Epoch ${meta.loadedEpoch} data`;
                    
                    document.querySelectorAll('#unclaimed-rewards-card .bg-gray-800\\/50').forEach(el => {
                        el.classList.remove('border', 'border-yellow-600/30');
                    });
                }
                
                // Get LUNA price for USD calculations
                const lunaPriceUSD = window.cachedPriceData?.['terra-luna-2']?.usd || 0.166;
                const ampLunaRatio = window.cachedAmpLunaRate || 1.9008;
                
                // Deposit Rewards - support both old (dao.rewards) and new (dashboard.unclaimed_rewards) format
                const depositRewards = tlaData.dashboard?.unclaimed_rewards || tlaData.dao?.rewards || {};
                const depositAmpLuna = depositRewards.ampLUNA || 0;
                const depositUsd = depositRewards.deposit_rewards_usd || depositRewards.usd || 0;
                const depositZAssets = depositRewards.zAssets || 0;
                
                document.getElementById('deposit-usd-value').textContent = `$${depositUsd.toLocaleString('en-US', {maximumFractionDigits: 0})}`;
                document.getElementById('deposit-ampluna-value').textContent = `${depositAmpLuna.toLocaleString('en-US', {maximumFractionDigits: 0})} ampLUNA`;
                
                // Vote Rewards - support both old (dao.vote_rewards) and new (dashboard.vote_rewards.by_token) format
                const voteRewards = tlaData.dashboard?.vote_rewards?.by_token || tlaData.dao?.vote_rewards || {};
                const voteTokenCount = Object.keys(voteRewards).filter(k => {
                    const val = voteRewards[k];
                    return typeof val === 'number' ? val > 0 : (val?.amount > 0 || val?.usd > 0);
                }).length;
                const unclaimedPeriods = tlaData.dashboard?.vote_rewards?.periods || tlaData.dao?.vote_reward_periods || [];
                
                document.getElementById('vote-token-count').textContent = `${voteTokenCount} tokens`;
                document.getElementById('vote-epochs-count').textContent = `${unclaimedPeriods.length} epochs (${unclaimedPeriods[0] || '?'}-${unclaimedPeriods[unclaimedPeriods.length-1] || '?'})`;
                
                // Rebase - support both old (vote.rebase) and new (dashboard.rebase.ampLUNA) format
                const rebase = tlaData.dashboard?.rebase?.ampLUNA || tlaData.vote?.rebase || 0;
                const rebaseUsd = tlaData.dashboard?.rebase?.usd || (rebase * ampLunaRatio * lunaPriceUSD);
                
                document.getElementById('rebase-ampluna-value').textContent = `${rebase.toLocaleString('en-US', {maximumFractionDigits: 2})} ampLUNA`;
                document.getElementById('rebase-usd-value').textContent = `~$${rebaseUsd.toLocaleString('en-US', {maximumFractionDigits: 0})} USD`;
            }
            
            function showMiniPopup(title, content, anchorEl) {
                // Remove any existing mini popup
                const existing = document.getElementById('mini-popup');
                if (existing) existing.remove();
                
                const popup = document.createElement('div');
                popup.id = 'mini-popup';
                popup.className = 'fixed bg-gray-900 border border-cyan-700 rounded-lg shadow-xl p-4 z-[100] min-w-[320px] max-w-lg';
                popup.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <h4 class="font-bold text-cyan-400">${title}</h4>
                        <button class="text-gray-400 hover:text-white text-lg leading-none ml-4" onclick="this.closest('#mini-popup').remove()">&times;</button>
                    </div>
                    <div class="text-sm max-h-[60vh] overflow-y-auto pr-2">${content}</div>
                `;
                
                document.body.appendChild(popup);
                
                // Position near anchor (account for popup size)
                const rect = anchorEl.getBoundingClientRect();
                const popupRect = popup.getBoundingClientRect();
                
                // Try to position below, but if not enough space, position above
                let top = rect.bottom + 10;
                if (top + popupRect.height > window.innerHeight - 20) {
                    top = rect.top - popupRect.height - 10;
                }
                
                // Center horizontally relative to anchor
                let left = rect.left + (rect.width / 2) - (popupRect.width / 2);
                // Keep within viewport
                left = Math.max(10, Math.min(left, window.innerWidth - popupRect.width - 10));
                
                popup.style.top = Math.max(10, top) + 'px';
                popup.style.left = left + 'px';
                
                // Close handlers
                const closePopup = () => {
                    popup.remove();
                    document.removeEventListener('click', handleClick);
                    window.removeEventListener('scroll', handleScroll);
                };
                
                const handleClick = (e) => {
                    if (!popup.contains(e.target) && !anchorEl.contains(e.target)) {
                        closePopup();
                    }
                };
                
                const handleScroll = () => {
                    closePopup();
                };
                
                setTimeout(() => {
                    document.addEventListener('click', handleClick);
                    window.addEventListener('scroll', handleScroll, { once: true });
                }, 100);
            }
            
            async function openUnclaimedRewardsModal() {
                const modal = document.getElementById('unclaimedRewardsModal');
                if (!modal) return;
                
                modal.classList.remove('hidden');
                setTimeout(() => {
                    modal.classList.remove('opacity-0');
                    modal.querySelector('.modal-content').classList.remove('opacity-0', 'scale-95');
                }, 10);
                
                const tlaData = await fetchTlaData();
                if (!tlaData) return;
                
                // Get metadata for staleness check
                const meta = getTlaDataMeta();
                const dataEpoch = meta.loadedEpoch || tlaData.meta?.epoch || 163;
                const currentEpoch = meta.currentEpoch || dataEpoch + 1;
                const lunaPriceUSD = window.cachedPriceData?.['terra-luna-2']?.usd || 0.166;
                const ampLunaRatio = window.cachedAmpLunaRate || 1.9008;
                
                // Update epoch display
                document.getElementById('modal-current-epoch').textContent = currentEpoch;
                const dataEpochEl = document.getElementById('modal-data-epoch');
                if (dataEpochEl) {
                    dataEpochEl.textContent = `(showing epoch ${dataEpoch} data)`;
                }
                
                // Show/hide stale banner in modal
                const modalStaleBanner = document.getElementById('modal-stale-banner');
                const modalStaleEpoch = document.getElementById('modal-stale-epoch');
                if (meta.isStale && modalStaleBanner) {
                    modalStaleBanner.classList.remove('hidden');
                    if (modalStaleEpoch) modalStaleEpoch.textContent = dataEpoch;
                } else if (modalStaleBanner) {
                    modalStaleBanner.classList.add('hidden');
                }
                
                // Rebase
                const rebase = tlaData.vote?.rebase || 0;
                document.getElementById('modal-unclaimed-rebase').textContent = `${rebase.toFixed(2)}`;
                
                // Deposit rewards
                const depositRewards = tlaData.dao?.rewards || {};
                document.getElementById('modal-deposit-ampluna').textContent = `${(depositRewards.ampLUNA || 0).toLocaleString('en-US', {maximumFractionDigits: 2})}`;
                document.getElementById('modal-deposit-usd').textContent = `$${(depositRewards.usd || 0).toLocaleString('en-US', {maximumFractionDigits: 2})}`;
                document.getElementById('modal-deposit-zassets').textContent = `${(depositRewards.zAssets || 0).toLocaleString('en-US', {maximumFractionDigits: 2})}`;
                
                // Vote rewards
                const voteRewards = tlaData.dao?.vote_rewards || {};
                const unclaimedPeriods = tlaData.dao?.vote_reward_periods || [];
                let voteRewardsHtml = '';
                Object.entries(voteRewards).forEach(([token, amount]) => {
                    if (amount > 0) {
                        const formattedAmount = amount >= 1000000 
                            ? (amount / 1000000).toFixed(2) + 'M' 
                            : amount >= 1000 
                                ? (amount / 1000).toFixed(2) + 'K'
                                : amount.toFixed(4);
                        voteRewardsHtml += `<div class="flex justify-between"><span class="text-gray-400">${token}</span><span class="text-white font-mono">${formattedAmount}</span></div>`;
                    }
                });
                document.getElementById('modal-vote-rewards-list').innerHTML = voteRewardsHtml || '<span class="text-gray-500">None</span>';
                document.getElementById('modal-vote-epochs').textContent = `${unclaimedPeriods.length} epochs (${unclaimedPeriods[0] || '?'}-${unclaimedPeriods[unclaimedPeriods.length-1] || '?'})`;
                
                // Potential VP gain - use cached ratios from TLA ext
                const arbLunaLocked = 27290;
                const ampLunaLocked = 413.03;
                const currentArbRatio = window.cachedArbLunaRate || 2.6873;
                const currentAmpRatio = ampLunaRatio;
                const lockedArbUnderlying = 63157;
                const lockedAmpUnderlying = 732;
                
                const currentTotalVP = ((arbLunaLocked * currentArbRatio) + (ampLunaLocked * currentAmpRatio)) * 10;
                const lockedTotalVP = (lockedArbUnderlying + lockedAmpUnderlying) * 10;
                const potentialGain = currentTotalVP - lockedTotalVP;
                
                if (potentialGain > 0) {
                    const gainEl = document.getElementById('potential-vp-gain');
                    const gainValueEl = document.getElementById('potential-vp-value');
                    if (gainEl && gainValueEl) {
                        gainEl.classList.remove('hidden');
                        gainValueEl.textContent = `+${potentialGain.toLocaleString('en-US', {maximumFractionDigits: 0})} VP`;
                    }
                }
            }
            
            function setupUnclaimedRewards() {
                // Setup click handlers for mini popups
                const depositSection = document.getElementById('deposit-rewards-section');
                if (depositSection) {
                    depositSection.addEventListener('click', async (e) => {
                        const tlaData = await fetchTlaData();
                        // Support both old (dao.rewards) and new (dashboard.unclaimed_rewards) format
                        const rewards = tlaData?.dashboard?.unclaimed_rewards || tlaData?.dao?.rewards || {};
                        
                        // Get current prices
                        const ampLunaPrice = window.cachedPriceData?.['eris-amplified-luna']?.usd || null;
                        const ampLunaRatio = window.cachedAmpLunaRate || 1.9008;
                        const lunaPrice = window.cachedPriceData?.['terra-luna-2']?.usd || null;
                        
                        // Calculate current value for ampLUNA
                        const ampLunaAmount = rewards.ampLUNA || 0;
                        const ampLunaCurrentValue = ampLunaPrice ? ampLunaAmount * ampLunaPrice : null;
                        
                        // Snap value is stored in deposit_rewards_usd (new) or usd (old)
                        const snapUsdValue = rewards.deposit_rewards_usd || rewards.usd || 0;
                        // Calculate implied snap price (if we have amount and value)
                        const snapAmpLunaPrice = ampLunaAmount > 0 ? (snapUsdValue / ampLunaAmount) : null;
                        
                        // Format prices
                        const formatPrice = (p) => p ? '$' + p.toFixed(4) : '?';
                        const formatValue = (v) => v !== null ? '$' + v.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '--';
                        
                        const content = `
                            <table class="w-full text-xs">
                                <thead>
                                    <tr class="text-gray-500 border-b border-gray-700">
                                        <th class="text-left py-1">Token</th>
                                        <th class="text-right py-1">Amount</th>
                                        <th class="text-right py-1">Snap Value</th>
                                        <th class="text-right py-1">Live Value</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr class="border-b border-gray-800">
                                        <td class="py-1.5 text-white font-medium">ampLUNA</td>
                                        <td class="py-1.5 text-right font-mono text-gray-300">${ampLunaAmount.toLocaleString('en-US', {maximumFractionDigits: 2})}</td>
                                        <td class="py-1.5 text-right">
                                            <span class="text-yellow-400 font-mono">${formatValue(snapUsdValue)}</span>
                                            <span class="text-gray-600 text-[9px] block">@${formatPrice(snapAmpLunaPrice)}</span>
                                        </td>
                                        <td class="py-1.5 text-right">
                                            <span class="text-green-400 font-mono">${formatValue(ampLunaCurrentValue)}</span>
                                            <span class="text-gray-600 text-[9px] block">@${formatPrice(ampLunaPrice)}</span>
                                        </td>
                                    </tr>
                                    <tr class="border-b border-gray-800">
                                        <td class="py-1.5 text-white font-medium">zAssets</td>
                                        <td class="py-1.5 text-right font-mono text-purple-400">${(rewards.zAssets || 0).toLocaleString('en-US', {maximumFractionDigits: 2})}</td>
                                        <td class="py-1.5 text-right text-gray-500" colspan="2">
                                            <span class="text-[9px]">Converts to ampLUNA on claim</span>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                            <div class="border-t border-gray-700 pt-2 mt-2 text-[10px] text-gray-500">
                                Last claimed: <span class="text-white">${lastClaimInfo.deposit.prop}</span> (${lastClaimInfo.deposit.date})
                            </div>
                        `;
                        showMiniPopup('Deposit Rewards', content, depositSection);
                    });
                }
                
                const voteSection = document.getElementById('vote-rewards-section');
                if (voteSection) {
                    voteSection.addEventListener('click', async (e) => {
                        const tlaData = await fetchTlaData();
                        // Support both old (dao.vote_rewards) and new (dashboard.vote_rewards.by_token) format
                        const voteRewards = tlaData?.dashboard?.vote_rewards?.by_token || tlaData?.dao?.vote_rewards || {};
                        const periods = tlaData?.dashboard?.vote_rewards?.periods || tlaData?.dao?.vote_reward_periods || [];
                        
                        // Token price mapping - includes variations of token names
                        const tokenGeckoIds = {
                            'LUNA': 'terra-luna-2',
                            'ASTRO': 'astroport-fi',
                            'CAPA': 'capapult',
                            'ROAR': 'lion-dao',
                            'SOLID': 'solid-2',
                            'wBTC': 'eureka-bridged-wbtc-terra',
                            'wBTC.atom': 'eureka-bridged-wbtc-terra',
                            'ampLUNA': 'eris-amplified-luna'
                        };
                        
                        let tokensHtml = '';
                        let totalSnapValue = 0;
                        let totalLiveValue = 0;
                        
                        Object.entries(voteRewards).forEach(([token, data]) => {
                            // Support both old format (data is number) and new format (data is {amount, price, usd})
                            const amount = typeof data === 'number' ? data : (data?.amount || 0);
                            if (amount > 0) {
                                const geckoId = tokenGeckoIds[token];
                                const livePrice = geckoId ? window.cachedPriceData?.[geckoId]?.usd : null;
                                const liveValue = livePrice ? amount * livePrice : null;
                                
                                if (liveValue !== null) totalLiveValue += liveValue;
                                
                                // Format amount
                                const formatted = amount >= 1000000 
                                    ? (amount/1000000).toFixed(2) + 'M' 
                                    : amount >= 1000 
                                        ? (amount/1000).toFixed(2) + 'K' 
                                        : amount < 0.01 
                                            ? amount.toFixed(6)
                                            : amount.toFixed(2);
                                
                                const priceStr = livePrice ? '$' + (livePrice < 0.0001 ? livePrice.toFixed(8) : livePrice.toFixed(4)) : '?';
                                const valueStr = liveValue !== null ? '$' + liveValue.toFixed(2) : '--';
                                
                                tokensHtml += `
                                    <tr class="border-b border-gray-800">
                                        <td class="py-1 text-white">${token}</td>
                                        <td class="py-1 text-right font-mono text-gray-300">${formatted}</td>
                                        <td class="py-1 text-right">
                                            <span class="text-green-400 font-mono">${valueStr}</span>
                                            <span class="text-gray-600 text-[9px] block">@${priceStr}</span>
                                        </td>
                                    </tr>`;
                            }
                        });
                        
                        const content = `
                            <table class="w-full text-xs">
                                <thead>
                                    <tr class="text-gray-500 border-b border-gray-700">
                                        <th class="text-left py-1">Token</th>
                                        <th class="text-right py-1">Amount</th>
                                        <th class="text-right py-1">Live Value</th>
                                    </tr>
                                </thead>
                                <tbody class="max-h-48 overflow-y-auto">
                                    ${tokensHtml || '<tr><td colspan="3" class="text-gray-500 text-center py-2">No tokens</td></tr>'}
                                </tbody>
                                <tfoot>
                                    <tr class="border-t border-cyan-700">
                                        <td colspan="2" class="py-1.5 font-bold text-gray-400">Total Live Est.</td>
                                        <td class="py-1.5 text-right font-mono font-bold text-cyan-400">$${totalLiveValue.toFixed(2)}</td>
                                    </tr>
                                </tfoot>
                            </table>
                            <div class="border-t border-gray-700 pt-2 mt-2">
                                <div class="text-[10px] text-orange-400">Unclaimed epochs: ${periods.length} (${periods[0] || '?'}-${periods[periods.length-1] || '?'})</div>
                                <div class="text-[10px] text-gray-500 mt-1">Last claimed: <span class="text-white">${lastClaimInfo.vote.prop}</span> (${lastClaimInfo.vote.date})</div>
                            </div>
                        `;
                        showMiniPopup('Vote Rewards', content, voteSection);
                    });
                }
                
                const rebaseSection = document.getElementById('rebase-rewards-section');
                if (rebaseSection) {
                    rebaseSection.addEventListener('click', async (e) => {
                        const tlaData = await fetchTlaData();
                        // Support both old (vote.rebase) and new (dashboard.rebase.ampLUNA) format
                        const rebaseAmount = tlaData?.dashboard?.rebase?.ampLUNA || tlaData?.vote?.rebase || 0;
                        
                        // Get current prices
                        const ampLunaPrice = window.cachedPriceData?.['eris-amplified-luna']?.usd || null;
                        const ampLunaRatio = window.cachedAmpLunaRate || 1.9008;
                        const lunaPrice = window.cachedPriceData?.['terra-luna-2']?.usd || null;
                        
                        // Calculate values
                        const underlyingLuna = rebaseAmount * ampLunaRatio;
                        const liveValue = ampLunaPrice ? rebaseAmount * ampLunaPrice : null;
                        
                        // Format helpers
                        const formatPrice = (p) => p ? '$' + p.toFixed(4) : '?';
                        const formatValue = (v) => v !== null ? '$' + v.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '--';
                        
                        const content = `
                            <table class="w-full text-xs">
                                <thead>
                                    <tr class="text-gray-500 border-b border-gray-700">
                                        <th class="text-left py-1">Asset</th>
                                        <th class="text-right py-1">Amount</th>
                                        <th class="text-right py-1">Live Value</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr class="border-b border-gray-800">
                                        <td class="py-1.5 text-white font-medium">ampLUNA</td>
                                        <td class="py-1.5 text-right font-mono text-cyan-400">${rebaseAmount.toLocaleString('en-US', {maximumFractionDigits: 2})}</td>
                                        <td class="py-1.5 text-right">
                                            <span class="text-green-400 font-mono">${formatValue(liveValue)}</span>
                                            <span class="text-gray-600 text-[9px] block">@${formatPrice(ampLunaPrice)}</span>
                                        </td>
                                    </tr>
                                    <tr class="border-b border-gray-800">
                                        <td class="py-1.5 text-gray-400"> Underlying</td>
                                        <td class="py-1.5 text-right font-mono text-gray-300">~${underlyingLuna.toLocaleString('en-US', {maximumFractionDigits: 2})} LUNA</td>
                                        <td class="py-1.5 text-right text-gray-500 text-[9px]">
                                            @${ampLunaRatio.toFixed(4)}x ratio
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                            <div class="bg-cyan-900/30 border border-cyan-800 rounded p-2 mt-3 text-[10px] text-cyan-300">
                                <i class="fas fa-info-circle mr-1"></i> Rebase adds to Lock #711 (ampLUNA)
                            </div>
                            <div class="border-t border-gray-700 pt-2 mt-2 text-[10px] text-gray-500">
                                Last claimed: <span class="text-white">${lastClaimInfo.rebase.prop}</span> (${lastClaimInfo.rebase.date})
                            </div>
                        `;
                        showMiniPopup('Rebase Rewards', content, rebaseSection);
                    });
                }
                
                // Full details button
                const fullDetailsBtn = document.getElementById('view-full-details-btn');
                if (fullDetailsBtn) {
                    fullDetailsBtn.addEventListener('click', () => {
                        openUnclaimedRewardsModal();
                    });
                }
                
                // Modal close handlers
                const modal = document.getElementById('unclaimedRewardsModal');
                if (modal) {
                    modal.querySelector('.modal-close').addEventListener('click', () => {
                        modal.classList.add('opacity-0');
                        modal.querySelector('.modal-content').classList.add('opacity-0', 'scale-95');
                        setTimeout(() => modal.classList.add('hidden'), 300);
                    });
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            modal.classList.add('opacity-0');
                            modal.querySelector('.modal-content').classList.add('opacity-0', 'scale-95');
                            setTimeout(() => modal.classList.add('hidden'), 300);
                        }
                    });
                }
                
                // Initial fetch
                updateUnclaimedRewardsTile();
            }

            // --- NFT Marketplace Section ---
            function setupNftMarketplace() {
                const CLOUDFLARE_CDN = 'https://imagedelivery.net/v_zOWVQCPb7Xpcbu-gQC1A/alliance_dao';
                const STATUS_URL = 'https://deving.zone/en/nfts/alliance_daos.json';
                const SALES_BASE_URL = 'https://raw.githubusercontent.com/defipatriot/adao_json_storage/main/';
                const BBL_CONTRACT = 'terra1phr9fngjv7a8an4dhmhd0u0f98wazxfnzccqtyheq4zqrrp4fpuqw3apw9';
                
                let nftStatusData = null;  // deving.zone data
                let salesData = null;       // Sales history
                let displayedSalesCount = 12;
                let salesFilter = 'all';
                let bblListedNfts = [];     // BBL listed NFTs from deving.zone
                
                // Get NFT image URL
                function getNftImageUrl(nftId) {
                    return `${CLOUDFLARE_CDN}/${nftId}.png/public`;
                }
                
                // Load NFT status from deving.zone
                async function loadNftStatus() {
                    try {
                        const response = await fetch(STATUS_URL);
                        if (!response.ok) throw new Error('Failed to fetch');
                        nftStatusData = await response.json();
                        processListings();
                    } catch (err) {
                        console.error('NFT status fetch error:', err);
                        document.getElementById('bbl-listed-count').textContent = 'Error';
                        document.getElementById('boost-listed-count').textContent = 'Error';
                    }
                }
                
                // Process listings from deving.zone
                function processListings() {
                    if (!nftStatusData?.nfts) return;
                    
                    bblListedNfts = [];
                    let boostCount = 0;
                    
                    nftStatusData.nfts.forEach(nft => {
                        if (nft.bbl) {
                            bblListedNfts.push({ id: nft.id, broken: nft.broken });
                        }
                        if (nft.boost) {
                            boostCount++;
                        }
                    });
                    
                    // Update counts
                    document.getElementById('bbl-listed-count').textContent = bblListedNfts.length;
                    document.getElementById('boost-listed-count').textContent = `${boostCount} NFTs`;
                    
                    // Setup BBL listed button
                    setupBblListedModal();
                    
                    // Re-render recent sales to update broken status
                    if (salesData) {
                        renderRecentSales();
                    }
                }
                
                // Setup BBL listed modal
                function setupBblListedModal() {
                    const btn = document.getElementById('bbl-listed-btn');
                    if (!btn) return;
                    
                    btn.addEventListener('click', () => {
                        showBblListedModal();
                    });
                }
                
                // Show modal with all BBL listed NFTs
                function showBblListedModal() {
                    const existingModal = document.getElementById('bbl-listed-modal');
                    if (existingModal) existingModal.remove();
                    
                    // Sort: unbroken first, then by ID
                    const sorted = [...bblListedNfts].sort((a, b) => {
                        if (a.broken !== b.broken) return a.broken ? 1 : -1;
                        return a.id - b.id;
                    });
                    
                    const unbrokenCount = sorted.filter(n => !n.broken).length;
                    const brokenCount = sorted.filter(n => n.broken).length;
                    
                    let listHtml = sorted.map(nft => {
                        const nftUrl = `https://app.backbonelabs.io/nfts/marketplace/collections/${BBL_CONTRACT}/${nft.id}`;
                        const brokenBadge = nft.broken 
                            ? '<span class="absolute top-1 left-1 bg-red-500 text-white text-[6px] px-1 py-0.5 rounded font-bold">BROKEN</span>'
                            : '';
                        return `
                            <a href="${nftUrl}" target="_blank" class="flex items-center gap-3 p-2 bg-gray-800/50 rounded-lg hover:bg-gray-700 transition-colors">
                                <div class="relative">
                                    ${brokenBadge}
                                    <img src="${getNftImageUrl(nft.id)}" alt="#${nft.id}" class="w-12 h-12 rounded object-cover"
                                         onerror="this.src='https://placehold.co/48x48/1f2937/666?text=${nft.id}'">
                                </div>
                                <div class="flex-1">
                                    <div class="font-bold text-white">#${nft.id}</div>
                                    <div class="text-xs text-gray-400">${nft.broken ? 'Broken' : 'Unbroken'}</div>
                                </div>
                                <i class="fas fa-external-link-alt text-gray-500"></i>
                            </a>
                        `;
                    }).join('');
                    
                    const modal = document.createElement('div');
                    modal.id = 'bbl-listed-modal';
                    modal.className = 'fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/70';
                    modal.innerHTML = `
                        <div class="bg-gray-900 rounded-xl border border-gray-700 max-w-md w-full max-h-[80vh] overflow-hidden">
                            <div class="p-4 border-b border-gray-700 flex items-center justify-between">
                                <h3 class="text-lg font-bold text-white">BBL Listed NFTs</h3>
                                <button class="text-gray-400 hover:text-white text-2xl">&times;</button>
                            </div>
                            <div class="p-3 bg-gray-800/50 flex gap-4 text-sm">
                                <span class="text-cyan-400"><span class="font-bold">${unbrokenCount}</span> Unbroken</span>
                                <span class="text-red-400"><span class="font-bold">${brokenCount}</span> Broken</span>
                            </div>
                            <div class="p-4 overflow-y-auto max-h-[55vh] space-y-2">
                                ${listHtml}
                            </div>
                            <div class="p-3 border-t border-gray-700 text-center">
                                <a href="https://app.backbonelabs.io/nfts/marketplace/collections/${BBL_CONTRACT}" target="_blank" 
                                   class="text-cyan-400 hover:text-cyan-300 text-sm">
                                    <i class="fas fa-external-link-alt mr-1"></i>View all on BBL Marketplace
                                </a>
                            </div>
                        </div>
                    `;
                    
                    document.body.appendChild(modal);
                    modal.querySelector('button').addEventListener('click', () => modal.remove());
                    modal.addEventListener('click', (e) => { if (e.target === modal) modal.remove(); });
                }
                
                // Load sales history
                async function loadSalesHistory() {
                    const currentYear = new Date().getFullYear();
                    
                    try {
                        const response = await fetch(`${SALES_BASE_URL}nft-sales-${currentYear}.json`);
                        if (!response.ok) throw new Error('No sales file');
                        salesData = await response.json();
                        
                        updateVolumeDisplays();
                        renderRecentSales();
                        setupTop10Modal();
                    } catch (err) {
                        console.error('Sales history fetch error:', err);
                        document.getElementById('recent-sales-container').innerHTML = 
                            '<div class="text-gray-500 text-sm text-center py-8 col-span-full">No sales data available</div>';
                    }
                }
                
                // Update volume displays
                function updateVolumeDisplays() {
                    if (!salesData?.cumulative_totals) return;
                    
                    const bblVolume = salesData.cumulative_totals.bbl?.total_volume_bluna || 0;
                    const bblSales = salesData.cumulative_totals.bbl?.total_sales || 0;
                    const boostVolume = salesData.cumulative_totals.boost?.total_volume_usd || 0;
                    const boostSales = salesData.cumulative_totals.boost?.total_sales || 0;
                    
                    const formatVolume = (v) => v >= 1000 ? (v/1000).toFixed(1) + 'K' : v.toFixed(1);
                    
                    // Get bLUNA price for USD conversion - try multiple sources
                    let bLunaPrice = window.cachedPriceData?.['backbone-labs-staked-luna']?.usd || 0;
                    
                    // If not available from main price fetch, try to calculate from LUNA price and ratio
                    if (bLunaPrice === 0) {
                        const lunaPrice = window.cachedPriceData?.['terra-luna-2']?.usd || 0;
                        const bLunaRatio = window.lstRatios?.bLUNA || 1.6048; // bLUNA to LUNA ratio
                        if (lunaPrice > 0) {
                            bLunaPrice = lunaPrice * bLunaRatio;
                        }
                    }
                    
                    const bblVolumeUsd = bblVolume * bLunaPrice;
                    
                    // Format USD volume
                    const formatUsd = (v) => v >= 1000 ? '$' + (v/1000).toFixed(1) + 'K' : '$' + v.toFixed(0);
                    
                    const bblVolumeEl = document.getElementById('bbl-volume-bluna');
                    bblVolumeEl.textContent = formatVolume(bblVolume);
                    
                    // Add USD value next to bLUNA
                    const usdSpan = document.getElementById('bbl-volume-usd');
                    if (usdSpan) {
                        if (bLunaPrice > 0) {
                            usdSpan.textContent = formatUsd(bblVolumeUsd);
                        } else {
                            // Price not available yet - will be updated when prices load
                            usdSpan.textContent = '--';
                        }
                    }
                    
                    document.getElementById('bbl-total-sales').textContent = `${bblSales} sales`;
                    document.getElementById('boost-volume-usd').textContent = `$${boostVolume.toFixed(2)}`;
                    document.getElementById('boost-total-sales').textContent = `${boostSales} sales`;
                }
                
                // Create sale row - shows current broken status (may differ from time of sale)
                function createSaleRow(sale, marketplace) {
                    const row = document.createElement('div');
                    row.className = 'recent-sale-row cursor-pointer';
                    
                    const date = new Date(sale.timestamp);
                    const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: '2-digit' });
                    
                    // Check deving.zone data for CURRENT broken status
                    const nftStatus = nftStatusData?.nfts?.find(n => n.id === sale.nft_id);
                    const isBroken = nftStatus?.broken || false;
                    
                    let usdStr = '';
                    if (marketplace === 'boost' && sale.usd_at_time) {
                        usdStr = `<div class="sale-usd">$${sale.usd_at_time.toFixed(2)}</div>`;
                    }
                    
                    // Show current broken status clearly
                    const brokenIndicator = isBroken 
                        ? '<div class="text-red-400 text-[10px] italic">Now Broken*</div>'
                        : '';
                    
                    row.innerHTML = `
                        <div class="relative">
                            <img src="${getNftImageUrl(sale.nft_id)}" alt="NFT #${sale.nft_id}" loading="lazy"
                                 class="w-12 h-12 rounded object-cover"
                                 onerror="this.src='https://placehold.co/48x48/1f2937/666?text=${sale.nft_id}'">
                        </div>
                        <div class="sale-info">
                            <div class="sale-nft-id">#${sale.nft_id} <span class="marketplace-badge ${marketplace === 'bbl' ? 'badge-bbl' : 'badge-boost'}">${marketplace.toUpperCase()}</span></div>
                            <div class="sale-date">${dateStr}</div>
                        </div>
                        <div class="sale-price text-right">
                            <div class="sale-amount">${sale.amount.toLocaleString()} ${sale.token}</div>
                            ${usdStr}
                            ${brokenIndicator}
                        </div>
                    `;
                    
                    row.addEventListener('click', () => window.open(`nft-explorer-index.html?id=${sale.nft_id}`, '_blank'));
                    return row;
                }
                
                // Render recent sales
                function renderRecentSales() {
                    if (!salesData?.sales) return;
                    
                    const container = document.getElementById('recent-sales-container');
                    const loadMoreBtn = document.getElementById('load-more-sales');
                    
                    let allSales = [];
                    
                    if (salesFilter === 'all' || salesFilter === 'bbl') {
                        (salesData.sales.bbl || []).forEach(s => allSales.push({ ...s, marketplace: 'bbl' }));
                    }
                    if (salesFilter === 'all' || salesFilter === 'boost') {
                        (salesData.sales.boost || []).forEach(s => allSales.push({ ...s, marketplace: 'boost' }));
                    }
                    
                    allSales.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    
                    container.innerHTML = '';
                    
                    if (allSales.length === 0) {
                        container.innerHTML = '<div class="text-gray-500 text-sm text-center py-8 col-span-full">No sales found</div>';
                        loadMoreBtn.classList.add('hidden');
                        return;
                    }
                    
                    allSales.slice(0, displayedSalesCount).forEach(sale => {
                        container.appendChild(createSaleRow(sale, sale.marketplace));
                    });
                    
                    if (allSales.length > displayedSalesCount) {
                        loadMoreBtn.classList.remove('hidden');
                        loadMoreBtn.textContent = `Show More (${allSales.length - displayedSalesCount} remaining)`;
                    } else {
                        loadMoreBtn.classList.add('hidden');
                    }
                }
                
                // Setup filter buttons
                function setupFilterButtons() {
                    const allBtn = document.getElementById('sales-filter-all');
                    const bblBtn = document.getElementById('sales-filter-bbl');
                    const boostBtn = document.getElementById('sales-filter-boost');
                    const loadMoreBtn = document.getElementById('load-more-sales');
                    
                    const setActive = (activeBtn) => {
                        [allBtn, bblBtn, boostBtn].forEach(btn => {
                            btn.className = btn === activeBtn 
                                ? 'text-xs px-3 py-1 rounded bg-cyan-600 text-white'
                                : 'text-xs px-3 py-1 rounded bg-gray-700 text-gray-300 hover:bg-gray-600';
                        });
                    };
                    
                    allBtn.addEventListener('click', () => { salesFilter = 'all'; displayedSalesCount = 12; setActive(allBtn); renderRecentSales(); });
                    bblBtn.addEventListener('click', () => { salesFilter = 'bbl'; displayedSalesCount = 12; setActive(bblBtn); renderRecentSales(); });
                    boostBtn.addEventListener('click', () => { salesFilter = 'boost'; displayedSalesCount = 12; setActive(boostBtn); renderRecentSales(); });
                    loadMoreBtn.addEventListener('click', () => { displayedSalesCount += 12; renderRecentSales(); });
                }
                
                // Setup Top 10 modal
                function setupTop10Modal() {
                    const btn = document.getElementById('top10-sales-btn');
                    const modal = document.getElementById('top10Modal');
                    const closeBtn = modal.querySelector('.modal-close');
                    const listContainer = document.getElementById('top10-sales-list');
                    const minQualify = document.getElementById('top10-min-qualify');
                    
                    btn.addEventListener('click', () => {
                        modal.classList.remove('hidden');
                        setTimeout(() => {
                            modal.classList.remove('opacity-0');
                            modal.querySelector('.modal-content').classList.remove('opacity-0', 'scale-95');
                        }, 10);
                        renderTop10List(listContainer, minQualify);
                    });
                    
                    const closeModal = () => {
                        modal.classList.add('opacity-0');
                        modal.querySelector('.modal-content').classList.add('opacity-0', 'scale-95');
                        setTimeout(() => modal.classList.add('hidden'), 300);
                    };
                    
                    closeBtn.addEventListener('click', closeModal);
                    modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
                }
                
                // Render Top 10 sales list
                function renderTop10List(container, minQualifyEl) {
                    const top10 = salesData?.top_10_sales_all_time;
                    
                    if (!top10?.sales) {
                        container.innerHTML = '<div class="text-gray-500 text-center py-8">No top sales data available</div>';
                        return;
                    }
                    
                    container.innerHTML = '';
                    
                    top10.sales.forEach((sale) => {
                        if (!sale) return;
                        
                        const row = document.createElement('div');
                        row.className = 'flex items-center gap-4 p-3 bg-gray-800/50 rounded-lg hover:bg-gray-800 transition-colors cursor-pointer';
                        
                        let rankClass = 'text-gray-400';
                        let rankIcon = '';
                        if (sale.rank === 1) { rankClass = 'text-yellow-400'; rankIcon = ''; }
                        else if (sale.rank === 2) { rankClass = 'text-gray-300'; rankIcon = ''; }
                        else if (sale.rank === 3) { rankClass = 'text-amber-600'; rankIcon = ''; }
                        
                        row.innerHTML = `
                            <div class="w-8 text-center font-bold ${rankClass} text-lg">${rankIcon || '#' + sale.rank}</div>
                            <img src="${getNftImageUrl(sale.nft_id)}" alt="NFT #${sale.nft_id}" 
                                 class="w-16 h-16 rounded-lg object-cover"
                                 onerror="this.src='https://placehold.co/64x64/1f2937/666?text=${sale.nft_id}'">
                            <div class="flex-1 min-w-0">
                                <div class="font-bold text-white text-lg">#${sale.nft_id}</div>
                                <div class="text-sm text-gray-400">${sale.date}  ${sale.marketplace.toUpperCase()}</div>
                            </div>
                            <div class="text-right">
                                <div class="font-mono text-cyan-400 font-bold">${sale.amount.toLocaleString()} ${sale.token}</div>
                                <div class="text-green-400 font-semibold">$${sale.usd_value.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                                <div class="text-xs text-gray-500">@$${sale.luna_price.toFixed(4)}/LUNA</div>
                            </div>
                        `;
                        
                        row.addEventListener('click', () => window.open(`nft-explorer-index.html?id=${sale.nft_id}`, '_blank'));
                        container.appendChild(row);
                    });
                    
                    if (top10.minimum_usd_to_qualify) {
                        minQualifyEl.textContent = `Minimum to qualify: $${top10.minimum_usd_to_qualify.toFixed(2)} USD`;
                    }
                }
                
                // Initialize
                setupFilterButtons();
                loadNftStatus();      // Load deving.zone for listing counts
                loadSalesHistory();   // Load sales history for volume/sales
            }


            // --- Main Execution ---
            updateUI(); // Initial UI setup with static data & trigger live fetch
            setupInfoModals(); // Setup general info modals
            buildLogoModal(); // Build the logo modal content
            setupSnapshotModal(); // Setup snapshot modal functionality
            setupChartIcons(); // Setup historical chart icons on tiles
            setupUnclaimedRewards(); // Setup unclaimed rewards tile and modal
            setupNftMarketplace(); // Setup NFT marketplace section

            // --- Disclaimer Banner Logic ---
            const banner = document.getElementById('disclaimer-banner');
            const closeButton = document.getElementById('close-banner');
            if (banner && closeButton) {
                closeButton.addEventListener('click', () => {
                    banner.style.display = 'none';
                });
            }

        }); // End of main DOMContentLoaded listener

    </script>
</body>
</html>
