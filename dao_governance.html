<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Governance | Alliance DAO</title>
    
    <!-- Favicons -->
    <link rel="icon" type="image/x-icon" href="https://raw.githubusercontent.com/defipatriot/aDAO-Image-Files/main/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="https://raw.githubusercontent.com/defipatriot/aDAO-Image-Files/main/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://raw.githubusercontent.com/defipatriot/aDAO-Image-Files/main/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="https://raw.githubusercontent.com/defipatriot/aDAO-Image-Files/main/apple-touch-icon.png">
    
    <!-- SEO -->
    <meta name="description" content="Alliance DAO governance history and member participation tracking.">
    <meta property="og:title" content="Governance | Alliance DAO">
    <meta property="og:image" content="https://raw.githubusercontent.com/defipatriot/aDAO-Image-Files/main/android-chrome-512x512.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { font-family: 'Outfit', sans-serif; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        
        :root {
            --bg-deep: #0a0b0f;
            --glass: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 255, 255, 0.08);
            --accent-cyan: #06b6d4;
            --accent-purple: #a855f7;
            --accent-green: #10b981;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #475569;
        }
        
        body { background: var(--bg-deep); min-height: 100vh; color: var(--text-primary); }
        
        @media (min-width: 1400px) { html { font-size: 19px; } }
        @media (min-width: 1800px) { html { font-size: 21px; } }
        
        .max-w-7xl { max-width: 1400px !important; }
        @media (min-width: 1600px) { .max-w-7xl { max-width: 1550px !important; } }
        @media (min-width: 1920px) { .max-w-7xl { max-width: 1750px !important; } }
        
        .bg-mesh {
            position: fixed; inset: 0; z-index: -1;
            background: 
                radial-gradient(ellipse 80% 50% at 20% 40%, rgba(6, 182, 212, 0.12), transparent),
                radial-gradient(ellipse 60% 40% at 80% 60%, rgba(168, 85, 247, 0.08), transparent),
                radial-gradient(ellipse 50% 30% at 50% 80%, rgba(16, 185, 129, 0.06), transparent);
            animation: meshMove 25s ease-in-out infinite;
        }
        @keyframes meshMove { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        
        .glass-card {
            background: var(--glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
        }
        
        .stat-box { text-align: center; padding: 20px 16px; }
        .stat-value {
            font-size: 1.75rem; font-weight: 700;
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .stat-label { font-size: 0.7rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 4px; }
        
        .tab-btn {
            position: relative; padding: 12px 24px; color: var(--text-secondary);
            font-weight: 500; cursor: pointer; border-radius: 8px 8px 0 0; transition: all 0.3s;
        }
        .tab-btn::after {
            content: ''; position: absolute; bottom: 0; left: 50%; width: 0; height: 2px;
            background: linear-gradient(90deg, var(--accent-cyan), var(--accent-purple));
            transition: all 0.3s; transform: translateX(-50%);
        }
        .tab-btn:hover { color: var(--text-primary); background: rgba(255,255,255,0.03); }
        .tab-btn.active { color: var(--text-primary); background: rgba(255,255,255,0.05); }
        .tab-btn.active::after { width: 60%; }
        
        .tab-content { display: none; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: block; }
        
        .status-executed { background: linear-gradient(135deg, #065f46, #047857); }
        .status-rejected { background: linear-gradient(135deg, #7f1d1d, #991b1b); }
        .status-vetoed { background: linear-gradient(135deg, #78350f, #92400e); }
        
        .grade-A { background: linear-gradient(135deg, #065f46, #047857); }
        .grade-B { background: linear-gradient(135deg, #1e40af, #1d4ed8); }
        .grade-C { background: linear-gradient(135deg, #78350f, #92400e); }
        .grade-D { background: linear-gradient(135deg, #7f1d1d, #991b1b); }
        .grade-F { background: linear-gradient(135deg, #4a044e, #701a75); }
        
        .rank-1 { background: linear-gradient(135deg, #fbbf24, #f59e0b); color: #0a0b0f; }
        .rank-2 { background: linear-gradient(135deg, #94a3b8, #64748b); color: #0a0b0f; }
        .rank-3 { background: linear-gradient(135deg, #c2885c, #a1693b); color: #0a0b0f; }
        
        .proposal-card, .member-card {
            background: rgba(15, 17, 23, 0.6);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            transition: all 0.3s;
        }
        .proposal-card:hover, .member-card:hover {
            background: rgba(20, 24, 32, 0.8);
            border-color: rgba(6, 182, 212, 0.3);
        }
        
        .vote-bar { height: 8px; border-radius: 4px; background: rgba(255,255,255,0.1); overflow: hidden; }
        .vote-bar-fill { height: 100%; }
        
        .vote-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }
        .vote-dot.yes { background: #22c55e; }
        .vote-dot.no { background: #ef4444; }
        .vote-dot.abstain { background: #6b7280; color: white; font-weight: bold; }
        .vote-dot.missed { background: transparent; border: 1px solid #374151; }
        
        .filter-btn {
            padding: 8px 16px; border-radius: 8px; font-size: 0.75rem; font-weight: 500;
            color: var(--text-secondary); background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.08); cursor: pointer; transition: all 0.2s;
        }
        .filter-btn:hover { background: rgba(255,255,255,0.06); }
        .filter-btn.active { background: rgba(6, 182, 212, 0.15); border-color: rgba(6, 182, 212, 0.4); color: var(--accent-cyan); }
        
        .sort-btn {
            padding: 4px 12px; border-radius: 6px; font-size: 0.7rem;
            color: var(--text-secondary); background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.08); cursor: pointer; transition: all 0.2s;
        }
        .sort-btn:hover { background: rgba(255,255,255,0.06); }
        .sort-btn.active { background: rgba(168, 85, 247, 0.15); border-color: rgba(168, 85, 247, 0.4); color: #c084fc; }
        
        .controversial-badge { background: rgba(245, 158, 11, 0.15); border: 1px solid rgba(245, 158, 11, 0.4); color: #fbbf24; padding: 2px 8px; border-radius: 12px; font-size: 10px; font-weight: 600; }
        
        .expand-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease; }
        .expand-content.expanded { max-height: 2000px; }
        
        .action-badge {
            background: rgba(168, 85, 247, 0.15); border: 1px solid rgba(168, 85, 247, 0.3);
            color: #c084fc; padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 600;
        }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: var(--text-muted); border-radius: 3px; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-in { animation: fadeIn 0.4s ease forwards; }
    </style>
</head>
<body>
    <div class="bg-mesh"></div>
    
    <!-- Header -->
    <header class="sticky top-0 z-50 backdrop-blur-xl bg-[#0a0b0f]/80 border-b border-white/5">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between flex-wrap gap-4">
                <div class="flex items-center gap-3">
                    <a href="index.html" class="hover:opacity-80 transition-opacity flex flex-col items-center">
                        <img src="https://raw.githubusercontent.com/defipatriot/aDAO-Image-Files/main/aDAO%20Logo%20No%20Background.png" alt="Alliance DAO" class="h-10 object-contain">
                        <span class="text-[9px] text-gray-500 hover:text-cyan-400 mt-0.5"><i class="fas fa-arrow-left mr-1"></i>Dashboard</span>
                    </a>
                    <div>
                        <h1 class="text-xl font-bold">Governance</h1>
                        <p class="text-xs text-gray-500">
                            by <span class="text-cyan-400">The Alliance DAO</span>
                        </p>
                    </div>
                </div>
                <!-- Nav Links -->
                <nav class="hidden md:flex items-center gap-2">
                    <a href="nft-explorer-index.html" class="text-xs text-gray-400 hover:text-cyan-400 px-3 py-1.5 rounded hover:bg-white/5 transition">NFT Explorer</a>
                    <a href="tla-stats.html" class="text-xs text-gray-400 hover:text-cyan-400 px-3 py-1.5 rounded hover:bg-white/5 transition">TLA Stats</a>
                    <a href="dao_governance.html" class="text-xs text-cyan-400 bg-cyan-400/10 px-3 py-1.5 rounded">DAO</a>
                </nav>
                <div class="flex items-center gap-4">
                    <div id="load-status" class="text-xs text-gray-500"><i class="fas fa-circle-notch fa-spin mr-1"></i> Loading...</div>
                    <button onclick="loadFromGitHub()" class="text-xs bg-white/5 hover:bg-white/10 border border-white/10 px-4 py-2 rounded-lg transition">
                        <i class="fas fa-sync-alt mr-1"></i> Refresh
                    </button>
                </div>
            </div>
        </div>
    </header>
    
    <!-- Stats -->
    <section id="stats-bar" class="max-w-7xl mx-auto px-4 py-6 hidden">
        <div class="glass-card grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 divide-x divide-white/5">
            <div class="stat-box"><div class="stat-label">Total Proposals</div><div id="stat-total" class="stat-value mono">-</div></div>
            <div class="stat-box"><div class="stat-label">Executed</div><div id="stat-executed" class="stat-value mono" style="background: linear-gradient(135deg, #10b981, #34d399); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">-</div></div>
            <div class="stat-box"><div class="stat-label">Rejected</div><div id="stat-rejected" class="stat-value mono" style="background: linear-gradient(135deg, #ef4444, #f87171); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">-</div></div>
            <div class="stat-box"><div class="stat-label">On-Chain Actions</div><div id="stat-actions" class="stat-value mono">-</div></div>
            <div class="stat-box"><div class="stat-label">Unique Voters</div><div id="stat-voters" class="stat-value mono" style="background: linear-gradient(135deg, #f59e0b, #fbbf24); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">-</div></div>
            <div class="stat-box"><div class="stat-label">Avg Participation</div><div id="stat-participation" class="stat-value mono">-</div></div>
        </div>
    </section>
    
    <!-- Tabs -->
    <nav id="tabs-nav" class="max-w-7xl mx-auto px-4 hidden">
        <div class="flex gap-1 border-b border-white/10">
            <div class="tab-btn active" data-tab="proposals" onclick="switchTab('proposals')"><i class="fas fa-landmark mr-2"></i>Proposals</div>
            <div class="tab-btn" data-tab="members" onclick="switchTab('members')"><i class="fas fa-users mr-2"></i>Member Participation</div>
        </div>
    </nav>

    <!-- Main -->
    <main class="max-w-7xl mx-auto px-4 py-6">
        <div id="loading-state" class="text-center py-20">
            <div class="text-6xl mb-6">üèõÔ∏è</div>
            <h2 class="text-2xl font-bold text-gray-400 mb-4">Loading Governance Data</h2>
            <div class="inline-block w-8 h-8 border-4 border-cyan-500 border-t-transparent rounded-full animate-spin"></div>
        </div>

        <!-- PROPOSALS TAB -->
        <div id="tab-proposals" class="tab-content">
            <div class="flex flex-wrap items-center gap-3 mb-4">
                <span class="text-xs text-gray-500"><i class="fas fa-filter mr-1"></i>Filter:</span>
                <button onclick="filterProposals('all')" class="filter-btn active" data-filter="all">All</button>
                <button onclick="filterProposals('executed')" class="filter-btn" data-filter="executed"><i class="fas fa-check-circle mr-1 text-green-400"></i>Executed</button>
                <button onclick="filterProposals('rejected')" class="filter-btn" data-filter="rejected"><i class="fas fa-times-circle mr-1 text-red-400"></i>Rejected</button>
                <button onclick="filterProposals('vetoed')" class="filter-btn" data-filter="vetoed"><i class="fas fa-ban mr-1 text-orange-400"></i>Vetoed</button>
                <div class="flex-1"></div>
                <div class="relative">
                    <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 text-xs"></i>
                    <input type="text" id="search-input" placeholder="Search..." class="text-xs bg-white/5 border border-white/10 rounded-lg pl-8 pr-3 py-2 w-48 focus:outline-none focus:border-cyan-500/50" oninput="searchProposals(this.value)">
                </div>
            </div>
            <div id="proposals-list" class="space-y-4"></div>
        </div>

        <!-- MEMBERS TAB -->
        <div id="tab-members" class="tab-content">
            <!-- Community Notice -->
            <div class="glass-card p-4 mb-6 border-l-4 border-cyan-500">
                <h4 class="text-sm font-semibold text-cyan-400 mb-2"><i class="fas fa-handshake mr-2"></i>Connecting With Our Community</h4>
                <p class="text-xs text-gray-400 leading-relaxed">
                    We encourage members to use <span class="text-gray-300">consistent names across DAODAO, X/Twitter, and Telegram</span> ‚Äî this helps us connect with voters and understand the direction our community wants the DAO to go. 
                    When we see "DeFi_Patriot" vote, we can find that same person in our chat groups to discuss governance decisions.
                </p>
                <p class="text-xs text-gray-500 mt-2 leading-relaxed">
                    <i class="fas fa-lock mr-1 text-green-500"></i>
                    <span class="text-gray-400">We fully respect privacy</span> ‚Äî this is voluntary and we're not asking for real identities. 
                    Pseudonyms are fine! The goal is simply knowing that 10 votes represent 10 real community members, not one person with multiple wallets.
                </p>
                <p class="text-xs text-gray-500 mt-2 leading-relaxed">
                    <i class="fas fa-info-circle mr-1 text-yellow-500"></i>
                    <span class="text-gray-400">Why it matters:</span> Anyone can create multiple wallets and vote as "different members." 
                    Consistent social presence helps us gauge authentic community sentiment ‚Äî are 10 people really saying this, or is it 1 person 10 times?
                </p>
                <div class="flex gap-3 mt-3">
                    <a href="https://daodao.zone/dao/terra1yqv0af2267wgq8cff2wmrlypafnmcysy74qfp8ph7mhwxag50xjqrrlhrt/members" target="_blank" class="text-xs text-purple-400 hover:text-purple-300"><i class="fas fa-user-edit mr-1"></i>Set DAODAO Name</a>
                </div>
            </div>
            
            <!-- VP Concentration Chart -->
            <div class="glass-card p-4 mb-6">
                <h4 class="text-sm font-semibold text-gray-400 mb-3"><i class="fas fa-chart-pie mr-2 text-purple-400"></i>Voting Power Distribution</h4>
                <div class="flex items-center gap-6">
                    <div id="vp-chart" class="w-32 h-32 relative"></div>
                    <div id="vp-stats" class="flex-1 text-xs space-y-1"></div>
                </div>
            </div>
            
            <div class="flex flex-wrap items-center gap-4 text-xs mb-4">
                <span class="text-gray-500"><i class="fas fa-award mr-1"></i>Tiers:</span>
                <span class="px-3 py-1 rounded-lg grade-A font-semibold">üèÜ Champion 80%+</span>
                <span class="px-3 py-1 rounded-lg grade-B font-semibold">‚≠ê Active 60-79%</span>
                <span class="px-3 py-1 rounded-lg grade-C font-semibold">üëç Regular 40-59%</span>
                <span class="px-3 py-1 rounded-lg grade-D font-semibold">üå± Contributor 20-39%</span>
                <span class="px-3 py-1 rounded-lg grade-F font-semibold">üëã Observer &lt;20%</span>
                <div class="flex-1"></div>
                <span class="flex items-center gap-1"><span class="vote-dot yes"></span>Yes</span>
                <span class="flex items-center gap-1"><span class="vote-dot no"></span>No</span>
                <span class="flex items-center gap-1"><span class="vote-dot abstain flex items-center justify-center text-[8px]">A</span>Abstain</span>
                <span class="flex items-center gap-1"><span class="vote-dot missed"></span>Missed</span>
            </div>
            <div id="top-performers" class="mb-6"></div>
            <div class="mb-4 flex flex-wrap items-center gap-4">
                <div class="relative inline-block">
                    <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 text-xs"></i>
                    <input type="text" id="member-search" placeholder="Search members..." class="text-xs bg-white/5 border border-white/10 rounded-lg pl-8 pr-3 py-2 w-64 focus:outline-none focus:border-cyan-500/50" oninput="filterMembers(this.value)">
                </div>
                <div class="flex items-center gap-2">
                    <span class="text-xs text-gray-500">Sort:</span>
                    <button onclick="sortMembers('participation')" class="sort-btn active" data-sort="participation">Participation</button>
                    <button onclick="sortMembers('vp')" class="sort-btn" data-sort="vp">Voting Power</button>
                    <button onclick="sortMembers('name')" class="sort-btn" data-sort="name">Name</button>
                </div>
            </div>
            <div class="glass-card overflow-hidden"><div id="members-table"></div></div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="border-t border-white/5 py-6 mt-8">
        <div class="max-w-7xl mx-auto px-4 text-center text-xs text-gray-500">
            <p>
                <a href="https://daodao.zone/dao/terra1yqv0af2267wgq8cff2wmrlypafnmcysy74qfp8ph7mhwxag50xjqrrlhrt" target="_blank" class="text-purple-400 hover:text-purple-300 mr-3"><i class="fas fa-external-link-alt mr-1"></i>DAODAO</a>
                ‚Ä¢
                <a href="https://github.com/defipatriot/adao_json_storage" target="_blank" class="text-cyan-400 hover:text-cyan-300 ml-3"><i class="fab fa-github mr-1"></i>Data Source</a>
            </p>
        </div>
    </footer>

    <script>
        let governanceData = null, memberStats = [], proposalList = [], memberNames = {}, currentFilter = 'all', searchQuery = '';
        const DAO_CONTRACT = 'terra1yqv0af2267wgq8cff2wmrlypafnmcysy74qfp8ph7mhwxag50xjqrrlhrt';
        const GOVERNANCE_URL = 'https://raw.githubusercontent.com/defipatriot/adao_json_storage/main/alliance_dao-governance-export.json';
        const MEMBERS_URL = 'https://raw.githubusercontent.com/defipatriot/adao_json_storage/main/members.csv';

        document.addEventListener('DOMContentLoaded', () => { loadFromGitHub(); initTabFromHash(); });

        async function loadFromGitHub() {
            document.getElementById('load-status').innerHTML = '<i class="fas fa-circle-notch fa-spin mr-1"></i> Loading...';
            try {
                await fetchMemberNames();
                const response = await fetch(GOVERNANCE_URL);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                governanceData = await response.json();
                document.getElementById('load-status').innerHTML = '<i class="fas fa-check-circle mr-1 text-green-400"></i> Loaded';
                calculateParticipation();
                renderDashboard();
            } catch (err) {
                console.error(err);
                document.getElementById('load-status').innerHTML = '<i class="fas fa-exclamation-circle mr-1 text-red-400"></i> Error';
            }
        }

        async function fetchMemberNames() {
            try {
                const response = await fetch(MEMBERS_URL);
                if (response.ok) {
                    const csv = await response.text();
                    csv.trim().split('\n').slice(1).forEach(line => {
                        const [addr, name] = line.split(',').map(s => s.trim());
                        if (name && name !== 'null') memberNames[addr] = name;
                    });
                }
            } catch (e) {}
        }

        function getMemberName(addr) { return memberNames[addr] || governanceData?.members?.[addr]?.name || null; }

        function calculateParticipation() {
            const props = Object.values(governanceData.proposals || {});
            proposalList = props.sort((a, b) => parseInt(a.id?.replace(/\D/g,'') || 0) - parseInt(b.id?.replace(/\D/g,'') || 0));
            const voterMap = {};
            proposalList.forEach(prop => {
                (prop.voters || []).forEach(v => {
                    if (!voterMap[v.address]) voterMap[v.address] = { address: v.address, name: getMemberName(v.address) || v.name, votes: {}, totalVotes: 0, yesVotes: 0, noVotes: 0, abstainVotes: 0, votingPower: 0 };
                    voterMap[v.address].votes[prop.id] = v.vote;
                    voterMap[v.address].totalVotes++;
                    voterMap[v.address].votingPower = Math.max(voterMap[v.address].votingPower, v.power || 0);
                    if (v.vote === 'yes') voterMap[v.address].yesVotes++;
                    else if (v.vote === 'no') voterMap[v.address].noVotes++;
                    else if (v.vote === 'abstain') voterMap[v.address].abstainVotes++;
                });
            });
            const totalProps = proposalList.length;
            memberStats = Object.values(voterMap).map(m => {
                const rate = totalProps > 0 ? (m.totalVotes / totalProps) * 100 : 0;
                let grade, gradeClass;
                if (rate >= 80) { grade = 'üèÜ'; gradeClass = 'grade-A'; }
                else if (rate >= 60) { grade = '‚≠ê'; gradeClass = 'grade-B'; }
                else if (rate >= 40) { grade = 'üëç'; gradeClass = 'grade-C'; }
                else if (rate >= 20) { grade = 'üå±'; gradeClass = 'grade-D'; }
                else { grade = 'üëã'; gradeClass = 'grade-F'; }
                return { ...m, participationRate: rate, grade, gradeClass };
            }).sort((a, b) => b.participationRate - a.participationRate);
        }

        function renderDashboard() {
            document.getElementById('loading-state').classList.add('hidden');
            document.getElementById('stats-bar').classList.remove('hidden');
            document.getElementById('tabs-nav').classList.remove('hidden');
            document.getElementById('tab-proposals').classList.add('active');

            const props = Object.values(governanceData.proposals || {});
            document.getElementById('stat-total').textContent = props.length;
            document.getElementById('stat-executed').textContent = props.filter(p => p.status?.toLowerCase() === 'executed').length;
            document.getElementById('stat-rejected').textContent = props.filter(p => ['rejected','vetoed'].includes(p.status?.toLowerCase())).length;
            document.getElementById('stat-actions').textContent = props.reduce((s, p) => s + (p.rawData?.length || 0), 0);
            document.getElementById('stat-voters').textContent = memberStats.filter(m => m.totalVotes > 0).length;
            document.getElementById('stat-participation').textContent = (memberStats.length > 0 ? memberStats.reduce((s, m) => s + m.participationRate, 0) / memberStats.length : 0).toFixed(1) + '%';

            renderProposals();
            renderTopPerformers();
            renderMembersTable();
            renderVPChart();
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.dataset.tab === tabId));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.toggle('active', c.id === 'tab-' + tabId));
            window.location.hash = tabId;
        }

        function initTabFromHash() { if (window.location.hash === '#members') switchTab('members'); }

        // === PROPOSALS ===
        function renderProposals() {
            let props = Object.values(governanceData.proposals || {}).sort((a, b) => parseInt(b.id?.replace(/\D/g,'') || 0) - parseInt(a.id?.replace(/\D/g,'') || 0));
            if (currentFilter !== 'all') props = props.filter(p => p.status?.toLowerCase() === currentFilter);
            if (searchQuery) { const q = searchQuery.toLowerCase(); props = props.filter(p => p.title?.toLowerCase().includes(q) || p.description?.toLowerCase().includes(q) || p.id?.toLowerCase().includes(q)); }
            document.getElementById('proposals-list').innerHTML = props.map((p, i) => renderProposalCard(p, i)).join('');
        }

        function renderProposalCard(prop, idx) {
            const statusClass = { executed: 'status-executed', rejected: 'status-rejected', vetoed: 'status-vetoed' }[prop.status?.toLowerCase()] || 'bg-gray-700';
            const statusIcon = { executed: 'fa-check', rejected: 'fa-times', vetoed: 'fa-ban' }[prop.status?.toLowerCase()] || 'fa-question';
            const votes = prop.votes || { yes: 0, no: 0, abstain: 0 };
            const total = votes.yes + votes.no + votes.abstain;
            const yesP = total > 0 ? votes.yes / total * 100 : 0;
            const noP = total > 0 ? votes.no / total * 100 : 0;
            const absP = total > 0 ? votes.abstain / total * 100 : 0;
            const turnout = prop.turnout || 0;
            const ts = prop.timestamp ? new Date(prop.timestamp).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' }) : '';
            const verified = prop.crossCheck?.verified;
            
            // Check if controversial (close vote - winning margin < 20%)
            const winningPct = Math.max(yesP, noP);
            const losingPct = Math.min(yesP, noP);
            const isControversial = total > 0 && noP > 0 && (winningPct - losingPct) < 20;
            
            // DAODAO link
            const daodaoLink = `https://daodao.zone/dao/${DAO_CONTRACT}/proposals/${prop.id}`;

            return `
            <div class="proposal-card animate-in" style="animation-delay:${idx*0.03}s">
                <div class="p-4 cursor-pointer" onclick="toggleExpand('prop-${prop.id}')">
                    <div class="flex items-start gap-4">
                        <div class="w-14 h-14 rounded-xl ${statusClass} flex items-center justify-center flex-shrink-0">
                            <span class="font-bold text-lg">${prop.id}</span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-start justify-between gap-4">
                                <div class="flex-1 min-w-0">
                                    <h3 class="font-semibold text-white">${prop.title || 'Untitled'}</h3>
                                    <div class="flex items-center gap-3 mt-1 text-xs text-gray-400">
                                        <span><i class="fas ${statusIcon} mr-1"></i>${prop.status}</span>
                                        ${ts ? `<span>‚Ä¢ ${ts}</span>` : ''}
                                        <span>‚Ä¢ <i class="fas fa-users mr-1"></i>${prop.voters?.length || 0} voters</span>
                                    </div>
                                </div>
                                <div class="flex items-center gap-2 flex-shrink-0">
                                    ${isControversial ? '<span class="controversial-badge"><i class="fas fa-balance-scale mr-1"></i>Close Vote</span>' : ''}
                                    ${verified ? '<span class="text-green-400 text-xs"><i class="fas fa-shield-alt mr-1"></i>Verified</span>' : ''}
                                    <span class="action-badge">${prop.rawData?.length || 0} action${(prop.rawData?.length || 0) !== 1 ? 's' : ''}</span>
                                    <i class="fas fa-chevron-down text-gray-500 text-sm transition-transform" id="chevron-${prop.id}"></i>
                                </div>
                            </div>
                            <div class="mt-3">
                                <div class="vote-bar"><div class="flex h-full"><div class="vote-bar-fill bg-green-500" style="width:${yesP}%"></div><div class="vote-bar-fill bg-red-500" style="width:${noP}%"></div><div class="vote-bar-fill bg-gray-500" style="width:${absP}%"></div></div></div>
                                <div class="flex justify-between items-center mt-1.5 text-[11px]">
                                    <div class="flex items-center gap-4">
                                        <span class="text-green-400"><i class="fas fa-thumbs-up mr-1"></i>${votes.yes} Yes</span>
                                        <span class="text-red-400"><i class="fas fa-thumbs-down mr-1"></i>${votes.no} No</span>
                                        <span class="text-gray-400"><i class="fas fa-minus mr-1"></i>${votes.abstain} Abstain</span>
                                    </div>
                                    <span class="text-gray-500 mono">${turnout}% turnout</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="prop-${prop.id}" class="expand-content">
                    <div class="border-t border-white/5 p-4 space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-black/20 rounded-lg p-3">
                                <h4 class="text-xs font-semibold text-gray-400 mb-3"><i class="fas fa-chart-pie mr-1"></i>Vote Results</h4>
                                <div class="space-y-2 text-left">
                                    <div class="flex justify-between"><span class="text-xs text-gray-400">Yes</span><span class="text-green-400 mono text-sm">${votes.yes} VP <span class="text-gray-500">(${yesP.toFixed(1)}%)</span></span></div>
                                    <div class="flex justify-between"><span class="text-xs text-gray-400">No</span><span class="text-red-400 mono text-sm">${votes.no} VP <span class="text-gray-500">(${noP.toFixed(1)}%)</span></span></div>
                                    <div class="flex justify-between"><span class="text-xs text-gray-400">Abstain</span><span class="text-gray-400 mono text-sm">${votes.abstain} VP <span class="text-gray-500">(${absP.toFixed(1)}%)</span></span></div>
                                </div>
                            </div>
                            <div class="bg-black/20 rounded-lg p-3">
                                <h4 class="text-xs font-semibold text-gray-400 mb-3"><i class="fas fa-check-double mr-1"></i>Thresholds</h4>
                                <div class="space-y-2 text-left">
                                    <div class="flex justify-between"><span class="text-xs text-gray-400">Turnout</span><span class="mono text-sm">${turnout}% <span class="text-green-400">‚úì</span></span></div>
                                    <div class="flex justify-between"><span class="text-xs text-gray-400">Quorum</span><span class="mono text-sm">${prop.quorum || 10}% <span class="text-green-400">‚úì</span></span></div>
                                    <div class="flex justify-between"><span class="text-xs text-gray-400">Passing</span><span class="mono text-sm">Majority (&gt;50%) <span class="text-green-400">‚úì</span></span></div>
                                </div>
                            </div>
                        </div>
                        ${prop.description ? `<div><h4 class="text-xs font-semibold text-gray-400 mb-2"><i class="fas fa-file-alt mr-1"></i>Description</h4><div class="text-sm text-gray-300 whitespace-pre-wrap bg-black/20 rounded-lg p-4 max-h-48 overflow-y-auto text-left">${escapeHtml(prop.description)}</div></div>` : ''}
                        ${prop.decodedRawActions?.length ? `<div><h4 class="text-xs font-semibold text-gray-400 mb-2"><i class="fas fa-bolt mr-1"></i>On-Chain Actions</h4><div class="space-y-2">${prop.decodedRawActions.map((a, i) => `<div class="bg-black/20 rounded-lg p-3 text-xs border-l-2 border-purple-500/50 text-left"><div class="flex justify-between"><span class="text-purple-400 font-semibold">#${i+1} ${a.type||'unknown'}${a.action?'.'+a.action:''}</span><span class="text-gray-500 mono text-[10px]">${a.contractName||a.contract?.slice(0,16)+'...'||''}</span></div>${a.decodedMsg?`<div class="mt-2 text-cyan-300">${formatMsg(a.decodedMsg)}</div>`:''}</div>`).join('')}</div></div>` : ''}
                        ${prop.voters?.length ? `<div><h4 class="text-xs font-semibold text-gray-400 mb-2"><i class="fas fa-vote-yea mr-1"></i>Voters (${prop.voters.length})</h4><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2">${prop.voters.slice(0,12).map(v => `<div class="bg-black/20 rounded-lg p-2 text-xs flex items-center justify-between"><div class="flex items-center gap-2"><span class="${v.vote==='yes'?'text-green-400':v.vote==='no'?'text-red-400':'text-gray-400'}"><i class="fas ${v.vote==='yes'?'fa-check':v.vote==='no'?'fa-times':'fa-minus'}"></i></span><span class="${v.name?'text-cyan-400':'text-gray-500'}">${v.name||v.address?.slice(0,10)+'...'}</span></div><span class="text-purple-400 mono text-[10px]">${v.power||0} VP</span></div>`).join('')}${prop.voters.length>12?`<div class="text-xs text-gray-500 p-2">+${prop.voters.length-12} more</div>`:''}</div></div>` : ''}
                        <div class="flex flex-wrap gap-4 text-xs text-gray-500 pt-2 border-t border-white/5">
                            <a href="${daodaoLink}" target="_blank" class="hover:text-purple-400"><i class="fas fa-external-link-alt mr-1"></i>View on DAODAO</a>
                            ${prop.txHash ? `<a href="https://chainsco.pe/terra2/tx/${prop.txHash}" target="_blank" class="hover:text-cyan-400"><i class="fas fa-link mr-1"></i>TX: ${prop.txHash.slice(0,12)}...</a>` : ''}
                            ${prop.blockHeight ? `<span><i class="fas fa-cube mr-1"></i>Block: ${prop.blockHeight}</span>` : ''}
                        </div>
                    </div>
                </div>
            </div>`;
        }

        function toggleExpand(id) {
            const el = document.getElementById(id);
            const chev = document.getElementById('chevron-' + id.replace('prop-', ''));
            if (el) { el.classList.toggle('expanded'); if (chev) chev.style.transform = el.classList.contains('expanded') ? 'rotate(180deg)' : ''; }
        }

        function filterProposals(f) { currentFilter = f; document.querySelectorAll('.filter-btn').forEach(b => b.classList.toggle('active', b.dataset.filter === f)); renderProposals(); }
        function searchProposals(q) { searchQuery = q; renderProposals(); }
        function formatMsg(msg) { if (!msg) return ''; const k = Object.keys(msg)[0], v = msg[k]; if (k === 'vote' && v.gauge) return `Vote on ${v.gauge} gauge (${v.votes?.length||0} pools)`; return typeof v === 'object' ? `${k}: ${JSON.stringify(v).slice(0,100)}...` : `${k}: ${v}`; }
        function escapeHtml(t) { const d = document.createElement('div'); d.textContent = t; return d.innerHTML; }

        // === MEMBERS ===
        function renderTopPerformers() {
            const top5 = memberStats.filter(m => m.totalVotes > 0).slice(0, 5);
            document.getElementById('top-performers').innerHTML = `
                <h3 class="text-lg font-semibold mb-4"><i class="fas fa-trophy text-yellow-400 mr-2"></i>Top Participants</h3>
                <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                    ${top5.map((m, i) => `<div class="glass-card p-4 text-center animate-in" style="animation-delay:${i*0.1}s"><div class="w-10 h-10 rounded-lg flex items-center justify-center text-lg font-bold mx-auto mb-2 ${i<3?`rank-${i+1}`:'bg-white/10'}">${i+1}</div><div class="text-sm font-semibold text-cyan-400 truncate">${m.name||m.address.slice(0,10)+'...'}</div><div class="mt-2"><span class="text-xl font-bold ${m.gradeClass} px-3 py-1 rounded-lg">${m.grade}</span></div><div class="text-xs text-gray-400 mt-2 mono">${m.participationRate.toFixed(1)}%</div><div class="text-[10px] text-gray-500">${m.totalVotes}/${proposalList.length} votes</div></div>`).join('')}
                </div>`;
        }

        function renderMembersTable(filter = '') {
            let filtered = memberStats;
            if (filter) { const q = filter.toLowerCase(); filtered = memberStats.filter(m => m.name?.toLowerCase().includes(q) || m.address.toLowerCase().includes(q)); }
            document.getElementById('members-table').innerHTML = filtered.map((m, i) => `
                <div class="member-card border-b border-white/5 last:border-0 cursor-pointer" onclick="toggleMember('mem-${i}')">
                    <div class="p-3">
                        <div class="flex items-center gap-4">
                            <div class="w-8 text-center text-xs text-gray-500 mono">#${memberStats.indexOf(m)+1}</div>
                            <div class="w-10"><span class="text-sm font-bold ${m.gradeClass} px-2 py-0.5 rounded">${m.grade}</span></div>
                            <div class="flex-1 min-w-0"><div class="font-medium ${m.name?'text-white':'text-gray-400'} truncate">${m.name||m.address.slice(0,16)+'...'}</div>${m.name?`<div class="text-[10px] text-gray-600 mono">${m.address.slice(0,12)}...</div>`:''}</div>
                            <div class="flex items-center gap-6 text-xs">
                                <div class="text-center"><div class="text-cyan-400 font-semibold mono">${m.participationRate.toFixed(1)}%</div><div class="text-[10px] text-gray-500">rate</div></div>
                                <div class="text-center"><div class="text-green-400 mono">${m.yesVotes}</div><div class="text-[10px] text-gray-500">yes</div></div>
                                <div class="text-center"><div class="text-red-400 mono">${m.noVotes}</div><div class="text-[10px] text-gray-500">no</div></div>
                                <div class="text-center"><div class="text-gray-400 mono">${m.abstainVotes}</div><div class="text-[10px] text-gray-500">abstain</div></div>
                                <div class="text-center"><div class="text-purple-400 mono">${m.votingPower}</div><div class="text-[10px] text-gray-500">VP</div></div>
                            </div>
                            <div class="hidden md:flex items-center gap-0.5">${proposalList.slice(-15).map(p => `<span class="vote-dot ${m.votes[p.id]==='yes'?'yes':m.votes[p.id]==='no'?'no':m.votes[p.id]==='abstain'?'abstain':'missed'}" title="${p.id}"></span>`).join('')}</div>
                            <i class="fas fa-chevron-down text-gray-500 text-xs"></i>
                        </div>
                    </div>
                    <div id="mem-${i}" class="expand-content">
                        <div class="px-3 pb-3"><div class="bg-black/20 rounded-lg p-3">
                            <div class="text-xs text-gray-400 mb-2"><i class="fas fa-history mr-1"></i>Complete Voting History</div>
                            <div class="flex flex-wrap gap-1">${proposalList.map(p => `<div class="vote-dot ${m.votes[p.id]==='yes'?'yes':m.votes[p.id]==='no'?'no':m.votes[p.id]==='abstain'?'abstain':'missed'} w-6 h-6 flex items-center justify-center text-[10px]" title="${p.id}: ${m.votes[p.id]||'missed'}">${m.votes[p.id]==='yes'?'‚úì':m.votes[p.id]==='no'?'‚úó':m.votes[p.id]==='abstain'?'A':''}</div>`).join('')}</div>
                            <div class="mt-2 text-[10px] text-gray-500">${proposalList.map(p => p.id).join(' ‚Ä¢ ')}</div>
                        </div></div>
                    </div>
                </div>`).join('');
        }

        function toggleMember(id) { const el = document.getElementById(id); if (el) el.classList.toggle('expanded'); }
        function filterMembers(q) { renderMembersTable(q); }
        
        let currentSort = 'participation';
        function sortMembers(sortBy) {
            currentSort = sortBy;
            document.querySelectorAll('.sort-btn').forEach(b => b.classList.toggle('active', b.dataset.sort === sortBy));
            
            if (sortBy === 'participation') {
                memberStats.sort((a, b) => b.participationRate - a.participationRate);
            } else if (sortBy === 'vp') {
                memberStats.sort((a, b) => b.votingPower - a.votingPower);
            } else if (sortBy === 'name') {
                memberStats.sort((a, b) => {
                    const nameA = (a.name || a.address).toLowerCase();
                    const nameB = (b.name || b.address).toLowerCase();
                    return nameA.localeCompare(nameB);
                });
            }
            renderMembersTable();
        }
        
        function renderVPChart() {
            const container = document.getElementById('vp-chart');
            const statsContainer = document.getElementById('vp-stats');
            
            // Get top VP holders
            const sorted = [...memberStats].sort((a, b) => b.votingPower - a.votingPower);
            const totalVP = sorted.reduce((s, m) => s + m.votingPower, 0);
            
            if (totalVP === 0) {
                container.innerHTML = '<div class="text-gray-500 text-xs">No VP data</div>';
                return;
            }
            
            const top5 = sorted.slice(0, 5);
            const othersVP = sorted.slice(5).reduce((s, m) => s + m.votingPower, 0);
            
            // Calculate percentages
            const segments = top5.map((m, i) => ({
                name: m.name || m.address.slice(0, 8) + '...',
                vp: m.votingPower,
                pct: (m.votingPower / totalVP * 100).toFixed(1),
                color: ['#06b6d4', '#a855f7', '#10b981', '#f59e0b', '#3b82f6'][i]
            }));
            
            if (othersVP > 0) {
                segments.push({ name: 'Others', vp: othersVP, pct: (othersVP / totalVP * 100).toFixed(1), color: '#475569' });
            }
            
            // Create CSS conic gradient
            let gradientParts = [];
            let currentAngle = 0;
            segments.forEach(seg => {
                const angle = (seg.vp / totalVP) * 360;
                gradientParts.push(`${seg.color} ${currentAngle}deg ${currentAngle + angle}deg`);
                currentAngle += angle;
            });
            
            container.innerHTML = `
                <div class="w-full h-full rounded-full" style="background: conic-gradient(${gradientParts.join(', ')})"></div>
                <div class="absolute inset-0 flex items-center justify-center">
                    <div class="w-16 h-16 rounded-full bg-[#0a0b0f] flex items-center justify-center">
                        <div class="text-center">
                            <div class="text-xs font-bold text-white">${totalVP}</div>
                            <div class="text-[8px] text-gray-500">Total VP</div>
                        </div>
                    </div>
                </div>
            `;
            
            // Stats breakdown
            const top1Pct = sorted[0] ? (sorted[0].votingPower / totalVP * 100).toFixed(1) : 0;
            const top3Pct = sorted.slice(0, 3).reduce((s, m) => s + m.votingPower, 0) / totalVP * 100;
            const top5Pct = sorted.slice(0, 5).reduce((s, m) => s + m.votingPower, 0) / totalVP * 100;
            
            statsContainer.innerHTML = `
                <div class="grid grid-cols-2 gap-x-4 gap-y-1">
                    ${segments.map(s => `
                        <div class="flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full" style="background: ${s.color}"></span>
                            <span class="text-gray-400 truncate">${s.name}</span>
                        </div>
                        <div class="text-right mono">${s.pct}%</div>
                    `).join('')}
                </div>
                <div class="mt-3 pt-3 border-t border-white/10 space-y-1">
                    <div class="flex justify-between"><span class="text-gray-500">Top holder:</span><span class="mono ${top1Pct > 50 ? 'text-red-400' : top1Pct > 30 ? 'text-yellow-400' : 'text-green-400'}">${top1Pct}%</span></div>
                    <div class="flex justify-between"><span class="text-gray-500">Top 3:</span><span class="mono ${top3Pct > 70 ? 'text-yellow-400' : 'text-gray-300'}">${top3Pct.toFixed(1)}%</span></div>
                    <div class="flex justify-between"><span class="text-gray-500">Top 5:</span><span class="mono text-gray-300">${top5Pct.toFixed(1)}%</span></div>
                </div>
            `;
        }
    </script>
    <script defer src="/_vercel/insights/script.js"></script>
</body>
</html>
