<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TLA Admin (Core) | Alliance DAO</title>
<meta name="description" content="Internal admin tool for managing TLA data collection and epoch snapshots. Not the public dashboard.">
<meta name="robots" content="noindex, nofollow">

<!-- Favicon -->
<link rel="icon" type="image/x-icon" href="https://raw.githubusercontent.com/defipatriot/aDAO-Image-Files/main/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://raw.githubusercontent.com/defipatriot/aDAO-Image-Files/main/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://raw.githubusercontent.com/defipatriot/aDAO-Image-Files/main/favicon-32x32.png">
<link rel="apple-touch-icon" sizes="180x180" href="https://raw.githubusercontent.com/defipatriot/aDAO-Image-Files/main/apple-touch-icon.png">

<!-- OG Meta -->
<meta property="og:title" content="TLA Admin Tool | Alliance DAO">
<meta property="og:description" content="Internal admin tool for TLA data collection">
<meta property="og:image" content="https://raw.githubusercontent.com/defipatriot/aDAO-Image-Files/main/android-chrome-512x512.png">
<meta property="og:type" content="website">

<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<!-- Vercel Analytics -->
<script defer src="/_vercel/insights/script.js"></script>
<style>
    body { font-family: 'Inter', monospace; background: #0D0D0D; color: #EAEAEA; }
    .input-dark { background: #1A1A1A; border: 1px solid #333; color: white; padding: 8px; border-radius: 6px; width: 100%; font-family: monospace; font-size: 0.75rem; resize: vertical; }
    .input-dark:focus { border-color: #2dd4bf; outline: none; }
    .tab-btn { padding: 8px 16px; border-radius: 6px; font-weight: 600; cursor: pointer; background: #1f2937; border: 1px solid #374151; color: #9ca3af; font-size: 0.8rem; transition: all 0.2s; }
    .tab-btn:hover { background: #374151; color: white; }
    .tab-btn.active { background: #2dd4bf; color: #000; border-color: #2dd4bf; }
    .workspace { display: none; } .workspace.active { display: block; }
    .preview-card { background: #111; border: 1px solid #333; border-radius: 8px; padding: 16px; }
    .btn-action { background: #333; color: white; padding: 6px; border-radius: 6px; font-size: 0.75rem; width: 100%; margin-top: 8px; transition: 0.2s; font-weight: 600; }
    .btn-action:hover { background: #444; }
    .custom-scroll::-webkit-scrollbar { width: 6px; }
    .custom-scroll::-webkit-scrollbar-track { background: #0d0d0d; }
    .custom-scroll::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
    .filter-checkbox { accent-color: #2dd4bf; cursor: pointer; }
    .vote-grid { display: grid; grid-template-columns: 180px 65px 100px 100px 70px 80px 70px 85px 85px 70px 85px 60px 120px 110px 80px; gap: 8px; align-items: center; }
    .liq-grid { display: grid; grid-template-columns: 190px 100px 65px 110px 110px 75px 85px 85px 110px 110px 110px 110px; gap: 8px; align-items: center; }
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 50; justify-content: center; align-items: center; }
    .modal-overlay.open { display: flex; }
    .modal-box { background: #1A1A1A; border: 1px solid #333; padding: 20px; border-radius: 8px; width: 800px; max-height: 80vh; overflow-y: auto; }
</style>
</head>
<body class="p-4 w-full max-w-[1600px] mx-auto min-h-screen flex flex-col">

<!-- ADMIN TOOL NOTICE -->
<div class="bg-amber-900/30 border border-amber-600/50 rounded-lg px-4 py-2 mb-4 flex items-center gap-3">
    <i class="fas fa-tools text-amber-400"></i>
    <div class="flex-grow">
        <span class="text-amber-400 font-bold text-xs">INTERNAL ADMIN TOOL</span>
        <span class="text-amber-200/70 text-xs ml-2">For data collection & epoch snapshots. Looking for the dashboard?</span>
    </div>
    <a href="https://www.thealliancedao.com/tla-stats.html" target="_blank" class="bg-cyan-600 hover:bg-cyan-500 text-white px-3 py-1 rounded text-xs font-bold transition-colors flex items-center gap-1">
        <i class="fas fa-chart-line"></i> View TLA Stats
    </a>
</div>

<!-- HEADER -->
<header class="flex flex-col gap-4 mb-4 pb-4 border-b border-gray-800">
    <div class="flex justify-between items-start">
        <div class="flex flex-col">
            <h1 class="text-xl font-bold text-cyan-400 flex items-center gap-2">
                <i class="fas fa-layer-group"></i> TLA Admin <span class="text-gray-500 text-sm">Core</span>
                <span id="live-epoch" class="text-xs bg-gray-800 text-white px-2 py-0.5 rounded border border-gray-700 font-mono ml-2">Epoch ...</span>
            </h1>
            <div class="flex gap-4 mt-1 text-[10px] font-mono text-gray-500">
                <span class="flex items-center gap-1"><i class="far fa-clock text-cyan-600"></i> Ends: <span id="epoch-timer" class="text-gray-300">...</span> <span id="epoch-phase" class="text-yellow-400 font-bold ml-1">...</span></span>
                <span class="flex items-center gap-1"><i class="fas fa-sync text-green-600"></i> Rewards: <span id="reward-timer" class="text-gray-300">...</span></span>
                <div class="flex gap-3 ml-4 border-l border-gray-700 pl-4 text-[10px]">
                    <span id="status-epoch-file" class="text-red-500 font-bold">Epoch File</span>
                    <span class="text-gray-600">|</span>
                    <div class="flex gap-3">
                        <div class="flex flex-col items-center">
                            <span id="status-historical" class="text-gray-500 cursor-pointer font-semibold" title="tla_ext_historical.json">Historical</span>
                            <span id="status-historical-date" class="text-[8px] text-gray-600">-</span>
                        </div>
                        <div class="flex flex-col items-center">
                            <span id="status-archive" class="text-gray-500 cursor-pointer font-semibold" title="tla_ext_archive.json">Archive</span>
                            <span id="status-archive-date" class="text-[8px] text-gray-600">-</span>
                        </div>
                        <div class="flex flex-col items-center">
                            <span id="status-epoch-ext" class="text-gray-500 cursor-pointer font-semibold" title="tla-ext-epoch-{ep}-{phase}.json">Ep Ext</span>
                            <span id="status-epoch-ext-date" class="text-[8px] text-gray-600">-</span>
                        </div>
                        <div class="flex flex-col items-center">
                            <span id="status-pd-bribes" class="text-gray-500 cursor-pointer font-semibold" title="tla_pd_bribes.json">PD Bribes</span>
                            <span id="status-pd-bribes-date" class="text-[8px] text-gray-600">-</span>
                        </div>
                        <div class="flex flex-col items-center">
                            <span id="status-metadata" class="text-gray-500 cursor-pointer font-semibold" title="tla_metadata.json">Metadata</span>
                            <span id="status-metadata-date" class="text-[8px] text-gray-600">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="flex gap-2">
            <a href="https://raw.githack.com/defipatriot/aDAO-links-site/main/tla-tool_ext.html" target="_blank" class="bg-teal-900/30 hover:bg-teal-900/50 text-teal-300 border border-teal-700 px-3 py-1.5 rounded text-xs font-bold transition-colors flex items-center gap-1" title="Open Extensions Tool">
                üìä Extensions
            </a>
            <button onclick="clearAll()" class="bg-red-900/20 hover:bg-red-900/40 text-red-400 border border-red-900/50 px-3 py-1.5 rounded text-xs font-bold transition-colors">Clear All</button>
            <button onclick="copyExportJson()" class="bg-gray-800 hover:bg-gray-700 text-white border border-gray-600 px-3 py-1.5 rounded text-xs font-bold transition-colors">Copy JSON</button>
            <button onclick="downloadCoreJson()" class="bg-cyan-900/50 hover:bg-cyan-800 text-cyan-200 border border-cyan-700 px-3 py-1.5 rounded text-xs font-bold transition-colors">Download JSON</button>
        </div>
    </div>
</header>

<!-- SESSION MANAGER -->
<div class="bg-[#161616] border border-gray-800 rounded-lg p-3 mb-6">
    <div class="flex items-center gap-4 mb-3">
        <div class="flex-shrink-0 text-cyan-500 text-xl"><i class="fas fa-database"></i></div>
        <div class="flex-grow">
            <h3 class="text-xs font-bold text-gray-400 uppercase">Session Manager</h3>
            <p class="text-[10px] text-gray-600" id="load-msg">Looking for latest snapshot...</p>
        </div>
        <div class="flex items-center gap-2">
            <input type="number" id="historyEpoch" placeholder="Ep" class="input-dark w-16 text-center font-mono" onchange="updateGithubLink()">
            <select id="historyPhase" class="input-dark w-20 text-xs" onchange="updateGithubLink()">
                <option value="end">End</option>
                <option value="mid">Mid</option>
                <option value="start">Start</option>
            </select>
            <button onclick="fetchCoreData()" class="bg-cyan-900/30 hover:bg-cyan-900/50 text-cyan-200 border border-cyan-800 px-3 py-1.5 rounded text-xs font-bold transition-colors">Load Data</button>
        </div>
    </div>
    
    <!-- Paste Status Tracker -->
    <div class="border-t border-gray-800 pt-2">
        <div class="text-[9px] text-gray-500 uppercase font-bold mb-1">Paste Progress</div>
        <div class="flex gap-2 flex-wrap text-[9px] font-mono">
            <span id="ps-vote" class="px-2 py-0.5 rounded bg-gray-800 text-gray-500 border border-gray-700">Vote Page</span>
            <span id="ps-vote-rew" class="px-2 py-0.5 rounded bg-gray-800 text-gray-500 border border-gray-700">Vote Rewards</span>
            <span class="text-gray-700">|</span>
            <span id="ps-liq-active" class="px-2 py-0.5 rounded bg-gray-800 text-gray-500 border border-gray-700">Liq Active</span>
            <span id="ps-liq-inactive" class="px-2 py-0.5 rounded bg-gray-800 text-gray-500 border border-gray-700">Liq Inactive</span>
            <span id="ps-liq-dep" class="px-2 py-0.5 rounded bg-gray-800 text-gray-500 border border-gray-700">Deposits</span>
            <span id="ps-liq-rew" class="px-2 py-0.5 rounded bg-gray-800 text-gray-500 border border-gray-700">Unclaimed</span>
            <span class="text-gray-700">|</span>
            <span id="ps-locks" class="px-2 py-0.5 rounded bg-gray-800 text-gray-500 border border-gray-700">Locks</span>
            <span class="text-gray-700">|</span>
            <span id="ps-ext" class="px-2 py-0.5 rounded bg-gray-800 text-gray-500 border border-gray-700">Ext Data</span>
        </div>
    </div>
    
    <!-- Ext Data Manual Load -->
    <div id="ext-manual-load" class="border-t border-gray-800 pt-2 mt-2 hidden">
        <div class="flex items-center gap-3">
            <div class="text-[9px] text-teal-400 uppercase font-bold">Load Ext Data Manually</div>
            <input type="file" id="ext-file-input" accept=".json" class="text-[10px] text-gray-400" onchange="loadExtFromFile(event)">
            <button onclick="toggleExtPaste()" class="text-[9px] text-teal-400 hover:text-teal-200 underline">or paste JSON</button>
        </div>
        <div id="ext-paste-area" class="hidden mt-2">
            <textarea id="ext-paste" class="input-dark h-20 text-[10px]" placeholder="Paste tla_ext_historical.json or tla_ext_combined.json content here..."></textarea>
            <button onclick="loadExtFromPaste()" class="btn-action bg-teal-900/40 text-teal-200 border border-teal-900 mt-1">Load Ext JSON</button>
        </div>
    </div>
    
    <!-- JSON Export Controls -->
    <div class="border-t border-gray-800 pt-2 mt-2">
        <div class="flex justify-between items-center">
            <div>
                <div class="text-[9px] text-red-400 uppercase font-bold mb-1">‚ö†Ô∏è JSON Export - Data Exclusion</div>
                <div class="text-[8px] text-gray-400">Grade Against controls scoring comparisons. Export controls JSON output.</div>
            </div>
            <div class="flex gap-4">
                <!-- Grade Against Filters -->
                <div class="flex flex-col gap-1">
                    <span class="text-[8px] text-purple-400 font-bold uppercase">Grade Against</span>
                    <div class="flex gap-2 text-[10px] font-bold text-gray-400 bg-purple-900/20 px-2 py-1 rounded border border-purple-900/50">
                        <label class="flex items-center gap-1 hover:text-white cursor-pointer"><input type="checkbox" id="grade-astro" class="filter-checkbox" checked onchange="renderVoteTable()"> Astro</label>
                        <label class="flex items-center gap-1 hover:text-white cursor-pointer"><input type="checkbox" id="grade-ww" class="filter-checkbox" checked onchange="renderVoteTable()">SS</label>
                        <label class="flex items-center gap-1 hover:text-white cursor-pointer"><input type="checkbox" id="grade-inactive" class="filter-checkbox" checked onchange="renderVoteTable()"> Inactive</label>
                    </div>
                </div>
                <!-- Export Filters -->
                <div class="flex flex-col gap-1">
                    <span class="text-[8px] text-red-400 font-bold uppercase">Include in Export</span>
                    <div class="flex gap-2 text-[10px] font-bold text-gray-400 bg-red-900/20 px-2 py-1 rounded border border-red-900/50">
                        <label class="flex items-center gap-1 hover:text-white cursor-pointer"><input type="checkbox" id="export-astro" class="filter-checkbox" checked> Astro</label>
                        <label class="flex items-center gap-1 hover:text-white cursor-pointer"><input type="checkbox" id="export-ww" class="filter-checkbox" checked>SS</label>
                        <label class="flex items-center gap-1 hover:text-white cursor-pointer"><input type="checkbox" id="export-inactive" class="filter-checkbox" checked> Inactive</label>
                        <label class="flex items-center gap-1 hover:text-white cursor-pointer text-cyan-400"><input type="checkbox" id="export-adao" class="filter-checkbox" checked onchange="renderVoteTable()"> aDAO</label>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- TABS -->
<div class="flex gap-2 mb-4 border-b border-gray-800 pb-1">
    <div class="tab-btn active" onclick="switchTab('vote')">1. Vote</div>
    <div class="tab-btn" onclick="switchTab('liquidity')">2. Liquidity</div>
    <div class="tab-btn" onclick="switchTab('locks')">3. Locks</div>
    <div class="tab-btn" onclick="switchTab('config')">‚öôÔ∏è Config</div>
</div>

<!-- WS 1: VOTE -->
<div id="ws-vote" class="workspace active">
    <div class="flex flex-col gap-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="bg-[#161616] p-3 rounded border border-gray-800">
                <div class="flex justify-between items-center mb-1">
                    <h3 class="text-orange-400 font-bold text-xs">1. Vote Page</h3>
                    <div class="flex items-center gap-2">
                        <span id="status-vote-page" class="text-[9px] text-gray-600 font-bold">PENDING</span>
                        <button onclick="clearPaste('votePaste')" class="text-[9px] text-red-400 hover:text-red-300">Clear</button>
                    </div>
                </div>
                <textarea id="votePaste" class="input-dark h-32" placeholder="Ctrl+A / Ctrl+C on TLA Vote Page connected to aDAO through DAODAO"></textarea>
                <button onclick="parseVote()" class="btn-action bg-cyan-900/40 text-cyan-200 border border-cyan-900">Parse Vote</button>
            </div>
            <div class="bg-[#161616] p-3 rounded border border-gray-800">
                <div class="flex justify-between items-center mb-1">
                    <h3 class="text-cyan-400 font-bold text-xs">2. Rewards Popup</h3>
                    <div class="flex items-center gap-2">
                        <span id="status-rewards" class="text-[9px] text-gray-600 font-bold">PENDING</span>
                        <button onclick="clearPaste('voteRewardsPaste')" class="text-[9px] text-red-400 hover:text-red-300">Clear</button>
                    </div>
                </div>
                <textarea id="voteRewardsPaste" class="input-dark h-32" placeholder="Select and copy txt from Claim pop-up"></textarea>
                <button onclick="parseVoteRewards()" class="btn-action">Parse Rewards</button>
            </div>
        </div>

        <div class="preview-card flex flex-col">
            <div class="flex flex-col gap-3 mb-4 border-b border-gray-700 pb-3">
                <!-- Row 1: Title -->
                <h3 class="text-lg font-bold text-white">Vote Dashboard</h3>
                
                <!-- Row 2: Epoch Info | DEX Tables | aDAO Stats -->
                <div class="grid grid-cols-12 gap-4 items-start">
                    <!-- Left: Epoch Info -->
                    <div class="col-span-2 flex flex-col gap-1">
                        <div class="text-[10px] text-gray-500 flex flex-col gap-1 bg-gray-900/50 p-2 rounded border border-gray-800">
                            <div class="flex justify-between"><span>Epoch:</span><span id="vote-ep" class="text-white font-bold">0</span></div>
                            <div class="flex justify-between"><span>Ends:</span><span id="vote-end" class="text-white">-</span></div>
                            <div class="flex justify-between"><span>Phase:</span><span id="vote-phase" class="text-yellow-400 font-bold">-</span></div>
                        </div>
                        <div class="text-[10px] text-orange-400 font-bold mt-1">
                            Total TLA VP: <span id="vote-tvp" class="text-orange-300">-</span>
                        </div>
                    </div>
                    
                    <!-- Center: DEX Comparison Tables -->
                    <div class="col-span-6 grid grid-cols-2 gap-2">
                        <!-- Astroport Table -->
                        <div class="bg-blue-900/20 border border-blue-900/50 rounded p-2">
                            <div class="text-[10px] font-bold text-blue-400 mb-1 border-b border-blue-900/50 pb-1">Astroport</div>
                            <div class="grid grid-cols-2 gap-x-2 gap-y-0.5 text-[9px]">
                                <span class="text-gray-500">Active LPs:</span><span id="dex-astro-active" class="text-white text-right">0</span>
                                <span class="text-gray-500">Inactive LPs:</span><span id="dex-astro-inactive" class="text-gray-400 text-right">0</span>
                                <span class="text-gray-500">Total Depth:</span><span id="dex-astro-depth" class="text-blue-300 text-right">$0</span>
                                <span class="text-gray-500">TLA Vote %:</span><span id="dex-astro-tla-pct" class="text-orange-400 text-right">0%</span>
                                <span class="text-gray-500">aDAO Vote %:</span><span id="dex-astro-adao-pct" class="text-cyan-400 text-right">0%</span>
                            </div>
                        </div>
                        <!-- Skeleton Swap Table -->
                        <div class="bg-green-900/20 border border-green-900/50 rounded p-2">
                            <div class="text-[10px] font-bold text-green-400 mb-1 border-b border-green-900/50 pb-1">Skeleton Swap</div>
                            <div class="grid grid-cols-2 gap-x-2 gap-y-0.5 text-[9px]">
                                <span class="text-gray-500">Active LPs:</span><span id="dex-ww-active" class="text-white text-right">0</span>
                                <span class="text-gray-500">Inactive LPs:</span><span id="dex-ww-inactive" class="text-gray-400 text-right">0</span>
                                <span class="text-gray-500">Total Depth:</span><span id="dex-ww-depth" class="text-green-300 text-right">$0</span>
                                <span class="text-gray-500">TLA Vote %:</span><span id="dex-ww-tla-pct" class="text-orange-400 text-right">0%</span>
                                <span class="text-gray-500">aDAO Vote %:</span><span id="dex-ww-adao-pct" class="text-cyan-400 text-right">0%</span>
                            </div>
                        </div>
                        <!-- Ext Data Legend -->
                        <div id="ext-data-legend" class="col-span-2 mt-1 text-[8px] text-gray-500 hidden">
                            <span class="text-teal-400">Teal</span> = 4Ep avg from ext data |
                            <span class="text-green-400">üü¢+50</span> Priority |
                            <span class="text-yellow-400">üü°+20</span> Opportunity |
                            <span class="text-gray-400">‚ö™0</span> Balanced |
                            <span class="text-blue-400">üîµ-20</span> Supported |
                            <span class="text-red-400">üî¥-50</span> Over-hyped
                        </div>
                        <!-- Votion Summary -->
                        <div id="votion-summary" class="col-span-2 mt-2 p-2 bg-purple-900/20 border border-purple-800/50 rounded hidden">
                            <div class="flex justify-between items-center text-[10px]">
                                <div class="flex items-center gap-2">
                                    <span class="text-purple-400 font-bold">‚ö° VOTION</span>
                                    <span class="text-gray-400">Total VP:</span>
                                    <span id="votion-total-vp" class="text-purple-300 font-mono font-bold">-</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="text-gray-400">% of TLA:</span>
                                    <span id="votion-tla-pct" class="text-purple-300 font-mono font-bold">-</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="text-gray-400">Source:</span>
                                    <span id="votion-source" class="text-gray-500 font-mono">-</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Right: aDAO Stats -->
                    <div class="col-span-4 flex gap-3 justify-end">
                        <div class="text-center border-r border-gray-700 pr-3">
                            <div class="text-[9px] text-gray-500 uppercase">aDAO VP</div>
                            <div id="vote-adao-vp" class="text-sm text-cyan-400 font-bold font-mono">-</div>
                        </div>
                        <div class="text-center border-r border-gray-700 pr-3">
                            <div class="text-[9px] text-gray-500 uppercase">aDAO %</div>
                            <div id="vote-adao-pct" class="text-sm text-cyan-400 font-bold font-mono">-</div>
                        </div>
                        <div class="text-center border-r border-gray-700 pr-3">
                            <div class="text-[9px] text-gray-500 uppercase">Rebase</div>
                            <div id="vote-rebase" class="text-sm text-cyan-400 font-bold font-mono">0</div>
                        </div>
                        <div class="text-center">
                            <div class="text-[9px] text-gray-500 uppercase">Unclaimed</div>
                            <button onclick="togModal('vote-rew',1)" id="vote-claim" class="text-sm text-cyan-400 font-bold font-mono hover:underline hover:text-white cursor-pointer underline decoration-dotted">$0</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-indigo-900/20 text-indigo-200 rounded-t border-b border-gray-800">
                <div class="vote-grid text-[11px] uppercase font-bold px-3 py-2 whitespace-nowrap">
                    <div class="truncate" title="pool_name">Pool</div>
                    <div class="text-center text-gray-500" title="pool_status (active/inactive)">Status</div>
                    <div class="text-right text-teal-400 cursor-help" title="4-Epoch Average Liquidity" onclick="showScoreInfo('4ep-liq')">4Ep Liq</div>
                    <div class="text-right text-teal-400 cursor-help" title="4-Epoch Average Volume" onclick="showScoreInfo('4ep-vol')">4Ep Vol</div>
                    <div class="text-right text-yellow-400 cursor-help" title="Capital Efficiency = Vol/Liq" onclick="showScoreInfo('efficiency')">Effic</div>
                    <div class="text-right cursor-help" title="APR: Green=Non-Amp, Yellow=Amplified" onclick="showScoreInfo('apr')"><span class="text-green-400">APR</span>/<span class="text-yellow-400">üî•</span></div>
                    <div class="text-right text-cyan-400 cursor-help" title="Access Score (asset + bridge + LUNA)" onclick="showScoreInfo('access')">Access</div>
                    <div class="text-right text-purple-400" title="Votion Current Epoch (VP + %)">Vot Now</div>
                    <div class="text-right text-purple-300" title="Votion Next Epoch Optimization (VP + %)">Vot Next</div>
                    <div class="text-right text-blue-400" title="Expected Vote Change (Next - Now)">Œî Vote</div>
                    <div class="text-right text-green-400" title="Bribes: PD (green) / Total (yellow)">Bribes</div>
                    <div class="text-right text-orange-300 cursor-help" title="Support Score" onclick="showScoreInfo('support')">Supp</div>
                    <div class="text-right text-orange-400" title="TLA VP + Vote %">TLA Vote</div>
                    <div class="text-right text-cyan-400 adao-col" title="aDAO VP + Vote %">aDAO</div>
                    <div class="text-right text-emerald-400 cursor-help" title="aDAO Opportunity Score" onclick="showScoreInfo('adao-score')">Score</div>
                </div>
            </div>
            <div id="vote-list" class="max-h-[600px] overflow-y-auto text-xs bg-[#0D0D0D] p-2 border border-gray-800 rounded-b custom-scroll space-y-1"></div>
        </div>
    </div>
</div>

<!-- WS 2: LIQUIDITY -->
<div id="ws-liquidity" class="workspace">
    <div class="flex flex-col gap-4">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="bg-[#161616] p-3 rounded border border-gray-800">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-cyan-400 font-bold text-xs">1. Full Page Text</h3>
                    <div class="flex items-center gap-2">
                        <button onclick="clearPaste('liqFullPage')" class="text-[9px] text-red-400 hover:text-red-300">Clear</button>
                    </div>
                </div>
                <div class="flex items-center gap-2 mb-2 p-1.5 bg-gray-900 rounded border border-gray-700">
                    <label class="flex items-center gap-1 text-[10px] text-gray-400 cursor-pointer">
                        <input type="checkbox" id="liqInactiveToggle" class="w-3 h-3"> Inactive Pools
                    </label>
                    <button onclick="skipInactive()" class="text-[9px] text-yellow-400 hover:text-yellow-300 ml-auto">Skip Inactive</button>
                </div>
                <textarea id="liqFullPage" class="input-dark h-20" placeholder="Ctrl+A on Liquidity page..."></textarea>
                <button onclick="parseLiquidity()" class="btn-action text-cyan-200 bg-cyan-900/40 border border-cyan-900">Parse Pools</button>
            </div>
            <div class="bg-[#161616] p-3 rounded border border-gray-800">
                <div class="flex justify-between items-center mb-1">
                    <h3 class="text-blue-400 font-bold text-xs">2. Deposits Popup</h3>
                    <button onclick="clearPaste('liqDeposits')" class="text-[9px] text-red-400 hover:text-red-300">Clear</button>
                </div>
                <textarea id="liqDeposits" class="input-dark h-24" placeholder="Paste Token List..."></textarea>
                <button onclick="parseDeposits()" class="btn-action">Parse Deposits</button>
            </div>
            <div class="bg-[#161616] p-3 rounded border border-gray-800">
                <div class="flex justify-between items-center mb-1">
                    <h3 class="text-green-400 font-bold text-xs">3. Unclaimed Popup</h3>
                    <button onclick="clearPaste('liqRewards')" class="text-[9px] text-red-400 hover:text-red-300">Clear</button>
                </div>
                <textarea id="liqRewards" class="input-dark h-24" placeholder="zAssets..."></textarea>
                <button onclick="parseRewards()" class="btn-action">Parse Rewards</button>
            </div>
        </div>
        <div class="preview-card flex flex-col">
            <!-- Row 1: TLA Global | DEX Tables | aDAO Stats -->
            <div class="grid grid-cols-12 gap-3 mb-3 border-b border-gray-700 pb-3">
                <!-- TLA Global -->
                <div class="col-span-2 px-2">
                    <h3 class="text-xs font-bold text-orange-400 mb-1">TLA Global</h3>
                    <div class="flex justify-between text-[10px] text-gray-400"><span>TVL</span><span id="tla-tvl" class="text-white font-mono">$0</span></div>
                    <div class="flex justify-between text-[10px] text-gray-400"><span>Rew/Yr</span><span id="tla-rew" class="text-green-400 font-mono">$0</span></div>
                    <div class="flex justify-between text-[10px] text-gray-400"><span>Rew/Ep</span><span id="tla-rew-ep" class="text-green-400 font-mono">$0</span></div>
                </div>
                
                <!-- DEX Tables -->
                <div class="col-span-6 grid grid-cols-2 gap-2">
                    <!-- Astroport -->
                    <div class="bg-blue-900/20 border border-blue-900/50 rounded p-2">
                        <div class="text-[10px] font-bold text-blue-400 mb-1 border-b border-blue-900/50 pb-1">Astroport</div>
                        <div class="grid grid-cols-2 gap-x-2 gap-y-0.5 text-[9px]">
                            <span class="text-gray-500">Active LPs:</span><span id="liq-astro-active" class="text-white text-right">0</span>
                            <span class="text-gray-500">Total Depth:</span><span id="liq-astro-depth" class="text-blue-300 text-right">$0</span>
                            <span class="text-gray-500">TLA Staked:</span><span id="liq-astro-stk" class="text-orange-400 text-right">$0</span>
                            <span class="text-gray-500">TLA % Depth:</span><span id="liq-astro-pct" class="text-orange-300 text-right">0%</span>
                            <span class="text-gray-500">% of TVL:</span><span id="liq-astro-tvl" class="text-white font-bold text-right">0%</span>
                        </div>
                    </div>
                    <!-- Skeleton Swap -->
                    <div class="bg-green-900/20 border border-green-900/50 rounded p-2">
                        <div class="text-[10px] font-bold text-green-400 mb-1 border-b border-green-900/50 pb-1">Skeleton Swap</div>
                        <div class="grid grid-cols-2 gap-x-2 gap-y-0.5 text-[9px]">
                            <span class="text-gray-500">Active LPs:</span><span id="liq-ww-active" class="text-white text-right">0</span>
                            <span class="text-gray-500">Total Depth:</span><span id="liq-ww-depth" class="text-green-300 text-right">$0</span>
                            <span class="text-gray-500">TLA Staked:</span><span id="liq-ww-stk" class="text-orange-400 text-right">$0</span>
                            <span class="text-gray-500">TLA % Depth:</span><span id="liq-ww-pct" class="text-orange-300 text-right">0%</span>
                            <span class="text-gray-500">% of TVL:</span><span id="liq-ww-tvl" class="text-white font-bold text-right">0%</span>
                        </div>
                    </div>
                </div>
                
                <!-- aDAO Stats -->
                <div class="col-span-4 grid grid-cols-2 gap-2">
                    <div class="px-2 border-l border-gray-800">
                        <div class="flex justify-between items-center mb-1">
                            <h3 class="text-xs font-bold text-cyan-400">aDAO Deposits</h3>
                            <button onclick="togModal('token',1)" class="text-[9px] bg-gray-800 px-1 rounded hover:text-white text-cyan-400">View</button>
                        </div>
                        <div class="flex justify-between text-[10px] text-gray-400"><span>Total</span><span id="dao-dep" class="text-white font-mono">$0</span></div>
                        <div class="flex justify-between text-[10px] text-gray-400"><span>Avg APR</span><span id="dao-apr" class="text-green-400 font-mono">0%</span></div>
                    </div>
                    <div class="px-2 border-l border-gray-800">
                        <h3 class="text-xs font-bold text-green-400 mb-1">Unclaimed</h3>
                        <div class="flex justify-between text-[10px] text-gray-400"><span>Total</span><span id="dao-usd" class="text-green-400 font-mono">$0</span></div>
                        <div class="text-[9px] text-gray-500 mt-1">
                            <span>zAssets: <span id="dao-rew-z" class="text-white">0</span></span>
                            <span class="ml-2">amp: <span id="dao-rew-amp" class="text-white">0</span></span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Table Header -->
            <div class="bg-cyan-900/20 text-cyan-200 rounded-t border-b border-gray-800">
                <div class="liq-grid text-[11px] uppercase font-bold px-3 py-2 whitespace-nowrap">
                    <div title="pool_name">Pool</div>
                    <div class="text-center" title="dex_name">Dex</div>
                    <div class="text-center text-gray-500" title="lp_type (pcl/stable/xyk)">Type</div>
                    <div class="text-right text-gray-500" title="dex_depth_usd">Depth</div>
                    <div class="text-right text-orange-400" title="tla_staked_usd">TLA Stk</div>
                    <div class="text-right text-orange-400" title="tla_depth_pct (TLA Staked / Dex Depth)">TLA %</div>
                    <div class="text-right text-green-400" title="apr_non_amplified">APR</div>
                    <div class="text-right text-yellow-400" title="apr_amplified">üî• APR</div>
                    <div class="text-right text-green-400" title="rewards_usd_year">Rew/Yr</div>
                    <div class="text-right text-green-400" title="rewards_usd_epoch (Rew/Yr √∑ 52)">Rew/Ep</div>
                    <div class="text-right text-cyan-400" title="adao_deposit_non_amp_usd">aDAO</div>
                    <div class="text-right text-yellow-400" title="adao_deposit_amplified_usd">üî• aDAO</div>
                </div>
            </div>
            <div id="liq-list" class="max-h-[600px] overflow-y-auto text-xs bg-[#0D0D0D] p-2 border border-gray-800 rounded-b custom-scroll"></div>
        </div>
    </div>
</div>

<!-- WS 3: LOCKS -->
<div id="ws-locks" class="workspace">
    <div class="flex flex-col gap-4">
        <div class="bg-[#161616] p-3 rounded border border-gray-800">
            <div class="flex justify-between items-center mb-1">
                <h3 class="text-purple-400 font-bold text-xs">Locks Page</h3>
                <button onclick="clearPaste('locksPaste')" class="text-[9px] text-red-400 hover:text-red-300">Clear</button>
            </div>
            <textarea id="locksPaste" class="input-dark h-32" placeholder="Paste locks page content..."></textarea>
            <button onclick="parseLocks()" class="btn-action bg-purple-900/40 text-purple-200 border border-purple-900">Parse Locks</button>
        </div>
        <div class="preview-card flex flex-col">
            <div class="flex justify-between mb-6 border-b border-gray-700 pb-4">
                <div class="text-center px-4 w-1/3 border-r border-gray-800">
                    <div class="text-[10px] text-gray-500 uppercase mb-1">ADAO Voting Power</div>
                    <div id="locks-vp" class="text-xl font-bold text-purple-400 font-mono">0 VP</div>
                </div>
                <div class="text-center px-4 w-1/3 border-r border-gray-800">
                    <div class="text-[10px] text-gray-500 uppercase mb-1">Power Factor</div>
                    <div id="locks-factor" class="text-xl font-bold text-white font-mono">-</div>
                </div>
                <div class="text-center px-4 w-1/3">
                    <div class="text-[10px] text-gray-500 uppercase mb-1">Underlying Assets</div>
                    <div id="locks-assets" class="text-xl font-bold text-white font-mono">-</div>
                </div>
            </div>
            <!-- Locks Table Header -->
            <div class="bg-purple-900/20 text-purple-200 rounded-t border-b border-gray-800 mb-1">
                <div class="grid grid-cols-12 gap-2 text-[8px] uppercase font-bold px-2 py-2">
                    <div class="col-span-1" title="lock_id">Lock</div>
                    <div class="col-span-2 text-gray-500" title="lock_status">Status</div>
                    <div class="col-span-3" title="locked_amount + asset_type">Amount</div>
                    <div class="col-span-3 text-right text-green-400" title="usd_value">USD Value</div>
                    <div class="col-span-3 text-right" title="voting_power">Voting Power</div>
                </div>
            </div>
            <div id="locks-list" class="space-y-0 max-h-[550px] overflow-y-auto custom-scroll pr-2 bg-[#0D0D0D] border border-gray-800 rounded-b p-2">
                <div class="text-center text-gray-600 italic text-xs pt-10">No locks parsed yet...</div>
            </div>
        </div>
    </div>
</div>

<!-- WS 4: CONFIG -->
<div id="ws-config" class="workspace">
    <div class="flex flex-col gap-4">
        <div class="bg-amber-900/20 border border-amber-700/50 rounded-lg p-4 mb-2">
            <div class="flex items-center gap-2 text-amber-400 font-bold text-sm mb-2">
                <span>‚öôÔ∏è</span> Site Configuration Editor
            </div>
            <p class="text-gray-400 text-xs">Edit key values below, then click "Copy Config JSON" to get the updated configuration. Replace the config in your GitHub repo to update the site.</p>
        </div>
        
        <!-- Config Sections -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
            
            <!-- General Settings -->
            <div class="bg-[#161616] p-4 rounded border border-gray-800">
                <h3 class="text-cyan-400 font-bold text-sm mb-3 border-b border-gray-700 pb-2">üìä General Settings</h3>
                <div class="space-y-3">
                    <div>
                        <label class="text-[10px] text-gray-500 uppercase">Current Epoch</label>
                        <input type="number" id="cfg-epoch" class="input-dark w-full" value="161">
                    </div>
                    <div>
                        <label class="text-[10px] text-gray-500 uppercase">Default Phase</label>
                        <select id="cfg-phase" class="input-dark w-full">
                            <option value="end" selected>End (Snapshot)</option>
                            <option value="start">Start</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- GitHub URLs -->
            <div class="bg-[#161616] p-4 rounded border border-gray-800">
                <h3 class="text-purple-400 font-bold text-sm mb-3 border-b border-gray-700 pb-2">üîó GitHub Data URLs</h3>
                <div class="space-y-3">
                    <div>
                        <label class="text-[10px] text-gray-500 uppercase">Main Data Repo</label>
                        <input type="text" id="cfg-baseUrl" class="input-dark w-full text-xs" value="https://raw.githubusercontent.com/defipatriot/tla_json_storage/main">
                    </div>
                    <div>
                        <label class="text-[10px] text-gray-500 uppercase">Extensions Repo</label>
                        <input type="text" id="cfg-extUrl" class="input-dark w-full text-xs" value="https://raw.githubusercontent.com/defipatriot/tla-ext_json_storage/main">
                    </div>
                    <div>
                        <label class="text-[10px] text-gray-500 uppercase">aDAO Repo</label>
                        <input type="text" id="cfg-adaoUrl" class="input-dark w-full text-xs" value="https://raw.githubusercontent.com/defipatriot/adao_json_storage/main">
                    </div>
                </div>
            </div>
            
            <!-- Scoring Weights -->
            <div class="bg-[#161616] p-4 rounded border border-gray-800">
                <h3 class="text-green-400 font-bold text-sm mb-3 border-b border-gray-700 pb-2">‚öñÔ∏è Scoring Weights</h3>
                <p class="text-[10px] text-gray-500 mb-3">aDAO Score = (Access √ó W1) + (Performance √ó W2) + ((100-Support) √ó W3)</p>
                <div class="space-y-3">
                    <div class="flex items-center gap-2">
                        <label class="text-[10px] text-gray-400 w-28">Access Weight</label>
                        <input type="number" id="cfg-accessWeight" class="input-dark w-20 text-center" value="0.15" step="0.05" min="0" max="1">
                        <span class="text-gray-500 text-xs">(15%)</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <label class="text-[10px] text-gray-400 w-28">Performance Weight</label>
                        <input type="number" id="cfg-perfWeight" class="input-dark w-20 text-center" value="0.55" step="0.05" min="0" max="1">
                        <span class="text-gray-500 text-xs">(55%)</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <label class="text-[10px] text-gray-400 w-28">Support Weight</label>
                        <input type="number" id="cfg-supportWeight" class="input-dark w-20 text-center" value="0.30" step="0.05" min="0" max="1">
                        <span class="text-gray-500 text-xs">(30%)</span>
                    </div>
                    <div id="weight-total" class="text-[10px] text-gray-500 mt-2">Total: 100%</div>
                </div>
            </div>
            
            <!-- Origin Scores -->
            <div class="bg-[#161616] p-4 rounded border border-gray-800">
                <h3 class="text-amber-400 font-bold text-sm mb-3 border-b border-gray-700 pb-2">üåç Origin Base Scores</h3>
                <div class="space-y-2">
                    <div class="flex items-center gap-2">
                        <label class="text-[10px] text-cyan-400 w-32">üîÑ Terra LSD</label>
                        <input type="number" id="cfg-origin-lsd" class="input-dark w-16 text-center" value="85">
                    </div>
                    <div class="flex items-center gap-2">
                        <label class="text-[10px] text-green-400 w-32">üè† Terra Native</label>
                        <input type="number" id="cfg-origin-native" class="input-dark w-16 text-center" value="80">
                    </div>
                    <div class="flex items-center gap-2">
                        <label class="text-[10px] text-purple-400 w-32">‚öõÔ∏è IBC Native</label>
                        <input type="number" id="cfg-origin-ibc" class="input-dark w-16 text-center" value="70">
                    </div>
                    <div class="flex items-center gap-2">
                        <label class="text-[10px] text-blue-400 w-32">üíµ Bridged Stable</label>
                        <input type="number" id="cfg-origin-stable" class="input-dark w-16 text-center" value="65">
                    </div>
                    <div class="flex items-center gap-2">
                        <label class="text-[10px] text-yellow-400 w-32">üåâ Eureka Bridge</label>
                        <input type="number" id="cfg-origin-eureka" class="input-dark w-16 text-center" value="55">
                    </div>
                    <div class="flex items-center gap-2">
                        <label class="text-[10px] text-orange-400 w-32">üî∂ Axelar/Osmosis</label>
                        <input type="number" id="cfg-origin-axelar" class="input-dark w-16 text-center" value="50">
                    </div>
                </div>
            </div>
            
            <!-- Asset Class Bonuses -->
            <div class="bg-[#161616] p-4 rounded border border-gray-800">
                <h3 class="text-blue-400 font-bold text-sm mb-3 border-b border-gray-700 pb-2">üè∑Ô∏è Asset Class Bonuses</h3>
                <div class="space-y-2">
                    <div class="flex items-center gap-2">
                        <label class="text-[10px] text-gray-400 w-32">Stablecoin</label>
                        <input type="number" id="cfg-class-stable" class="input-dark w-16 text-center" value="5">
                    </div>
                    <div class="flex items-center gap-2">
                        <label class="text-[10px] text-gray-400 w-32">Bluechip (BTC/ETH)</label>
                        <input type="number" id="cfg-class-bluechip" class="input-dark w-16 text-center" value="5">
                    </div>
                    <div class="flex items-center gap-2">
                        <label class="text-[10px] text-gray-400 w-32">LSD</label>
                        <input type="number" id="cfg-class-lsd" class="input-dark w-16 text-center" value="5">
                    </div>
                    <div class="flex items-center gap-2">
                        <label class="text-[10px] text-gray-400 w-32">RWA (PAXG)</label>
                        <input type="number" id="cfg-class-rwa" class="input-dark w-16 text-center" value="5">
                    </div>
                    <div class="flex items-center gap-2">
                        <label class="text-[10px] text-gray-400 w-32">Core/DeFi</label>
                        <input type="number" id="cfg-class-core" class="input-dark w-16 text-center" value="0">
                    </div>
                </div>
            </div>
            
            <!-- DEX Configuration -->
            <div class="bg-[#161616] p-4 rounded border border-gray-800">
                <h3 class="text-red-400 font-bold text-sm mb-3 border-b border-gray-700 pb-2">üè¶ DEX Configuration</h3>
                <div class="space-y-3">
                    <div>
                        <label class="text-[10px] text-gray-500 uppercase">Primary DEX Name</label>
                        <input type="text" id="cfg-dex1-name" class="input-dark w-full" value="Astroport">
                    </div>
                    <div>
                        <label class="text-[10px] text-gray-500 uppercase">Primary DEX Link</label>
                        <input type="text" id="cfg-dex1-link" class="input-dark w-full text-xs" value="https://app.astroport.fi/pools">
                    </div>
                    <div>
                        <label class="text-[10px] text-gray-500 uppercase">Secondary DEX Name</label>
                        <input type="text" id="cfg-dex2-name" class="input-dark w-full" value="Skeleton Swap">
                    </div>
                    <div>
                        <label class="text-[10px] text-gray-500 uppercase">Secondary DEX Link</label>
                        <input type="text" id="cfg-dex2-link" class="input-dark w-full text-xs" value="https://app.skeleton_swap.money/terra/pools">
                    </div>
                    <div class="flex items-center gap-2 mt-2">
                        <input type="checkbox" id="cfg-dex2-enabled" class="filter-checkbox">
                        <label class="text-[10px] text-gray-400">Secondary DEX Link Enabled</label>
                    </div>
                </div>
            </div>
            
        </div>
        
        <!-- Export Buttons -->
        <div class="flex gap-3 mt-4">
            <button onclick="copyConfigJSON()" class="btn-action bg-emerald-900/50 text-emerald-300 border border-emerald-700 flex items-center gap-2">
                <span>üìã</span> Copy Config JSON
            </button>
            <button onclick="resetConfigDefaults()" class="btn-action bg-gray-800 text-gray-400 border border-gray-700">
                Reset to Defaults
            </button>
        </div>
        
        <!-- JSON Preview -->
        <div class="bg-[#0D0D0D] p-4 rounded border border-gray-800 mt-2">
            <div class="flex justify-between items-center mb-2">
                <h4 class="text-gray-400 font-bold text-xs">Generated Config JSON</h4>
                <span id="config-copy-status" class="text-[10px] text-emerald-400 hidden">‚úì Copied!</span>
            </div>
            <pre id="config-preview" class="text-[10px] text-gray-500 font-mono overflow-x-auto max-h-60 overflow-y-auto">Click "Copy Config JSON" to generate...</pre>
        </div>
    </div>
</div>

<!-- aDAO Strategy Panel (Collapsible) -->
<div class="max-w-[1400px] mx-auto mt-4 px-2">
    <div class="bg-gray-900/50 border border-emerald-800 rounded-lg overflow-hidden">
        <div class="flex justify-between items-center px-4 py-2 bg-emerald-900/30 cursor-pointer" onclick="toggleStrategyPanel()">
            <div class="flex items-center gap-2">
                <span class="text-emerald-400 font-bold text-sm">üéØ aDAO Strategy Recommendations</span>
                <span class="text-[10px] text-gray-500">(Vote Optimization, Bribe Candidates, Activation Targets)</span>
            </div>
            <div class="flex items-center gap-3">
                <button onclick="event.stopPropagation(); generateStrategy()" class="text-[10px] bg-emerald-800 hover:bg-emerald-700 px-2 py-1 rounded">Generate</button>
                <span id="strategy-toggle" class="text-gray-400">‚ñº</span>
            </div>
        </div>
        <div id="strategy-panel" class="hidden p-4">
            <div class="grid grid-cols-2 gap-4">
                <!-- Vote Optimization -->
                <div class="bg-gray-900/50 rounded border border-gray-700 p-3">
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="text-sm font-bold text-orange-400">üìä Optimized Vote Allocation</h4>
                        <button onclick="copyVoteStrategy()" class="text-[10px] bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded">üìã Copy</button>
                    </div>
                    <div id="vote-optimization" class="space-y-3 text-[11px] max-h-[400px] overflow-y-auto custom-scroll">
                        <div class="text-gray-500 italic">Click "Generate" to calculate recommendations</div>
                    </div>
                </div>
                
                <!-- Bribe Candidates & Activation Targets -->
                <div class="space-y-4">
                    <!-- Bribe Candidates -->
                    <div class="bg-gray-900/50 rounded border border-gray-700 p-3">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-sm font-bold text-green-400">üí∞ Bribe Candidates</h4>
                            <button onclick="copyBribeCandidates()" class="text-[10px] bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded">üìã Copy for Prop</button>
                        </div>
                        <div id="bribe-candidates" class="space-y-2 text-[11px]">
                            <div class="text-gray-500 italic">Click "Generate" to identify candidates</div>
                        </div>
                    </div>
                    
                    <!-- Activation Targets (Inactive pools worth supporting) -->
                    <div class="bg-gray-900/50 rounded border border-gray-700 p-3">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-sm font-bold text-purple-400">üöÄ Activation Targets</h4>
                            <span class="text-[9px] text-gray-500">Inactive pools worth bringing to 1%+</span>
                        </div>
                        <div id="activation-targets" class="space-y-2 text-[11px]">
                            <div class="text-gray-500 italic">Click "Generate" to find targets</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Metadata Manager (Collapsible) -->
<div class="max-w-[1400px] mx-auto mt-4 px-2">
    <div class="bg-gray-900/50 border border-gray-800 rounded-lg overflow-hidden">
        <div class="flex justify-between items-center px-4 py-2 bg-gray-800/50 cursor-pointer" onclick="toggleMetadataPanel()">
            <div class="flex items-center gap-2">
                <span class="text-cyan-400 font-bold text-sm">üìä Asset Metadata Manager</span>
                <span class="text-[10px] text-gray-500">(CoinGecko, Multi-DEX, Bridge info)</span>
            </div>
            <div class="flex items-center gap-3">
                <span id="meta-status" class="text-[10px] text-gray-500">0 assets</span>
                <span id="meta-toggle" class="text-gray-400">‚ñº</span>
            </div>
        </div>
        <div id="metadata-panel" class="hidden p-4">
            <div class="grid grid-cols-3 gap-4">
                <!-- Asset List -->
                <div class="col-span-2 bg-gray-900/50 rounded border border-gray-700 p-3">
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="text-sm font-bold text-white">Assets</h4>
                        <div class="flex gap-2">
                            <input type="text" id="meta-search" placeholder="Search assets..." 
                                class="bg-gray-800 border border-gray-700 rounded px-2 py-1 text-xs w-32"
                                oninput="filterMetaAssets()">
                            <button onclick="addNewAsset()" class="text-[10px] bg-cyan-800 hover:bg-cyan-700 px-2 py-1 rounded">+ Add</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-12 gap-1 text-[7px] uppercase text-gray-500 font-bold mb-2 px-2">
                        <div class="col-span-2">Asset</div>
                        <div class="col-span-1 text-center" title="Naming matches actual path">Name</div>
                        <div class="col-span-1 text-center" title="CoinGecko status">CG</div>
                        <div class="col-span-1 text-center" title="Easy to find in Skip.go">Skip</div>
                        <div class="col-span-1 text-center" title="On multiple DEXs">DEX</div>
                        <div class="col-span-2 text-center" title="Value to chain treasury">Treasury</div>
                        <div class="col-span-1 text-center">Score</div>
                        <div class="col-span-2 text-center">Actions</div>
                    </div>
                    <div id="meta-asset-list" class="max-h-[350px] overflow-y-auto custom-scroll space-y-1">
                        <div class="text-center text-gray-600 italic text-xs py-4">
                            Load from GitHub or extract from parsed pools
                        </div>
                    </div>
                </div>
                
                <!-- Controls -->
                <div class="space-y-3">
                    <div class="bg-gray-900/50 rounded border border-gray-700 p-3">
                        <h4 class="text-sm font-bold text-white mb-2">Data Source</h4>
                        <button onclick="loadMetadataFromGitHub()" class="w-full text-[10px] bg-purple-800 hover:bg-purple-700 px-3 py-2 rounded mb-2">
                            üì• Load from GitHub
                        </button>
                        <button onclick="extractAssetsFromPools()" class="w-full text-[10px] bg-gray-700 hover:bg-gray-600 px-3 py-2 rounded">
                            üîÑ Extract from Parsed Pools
                        </button>
                    </div>
                    
                    <div class="bg-gray-900/50 rounded border border-gray-700 p-3">
                        <h4 class="text-sm font-bold text-white mb-2">Export</h4>
                        <button onclick="downloadMetadata()" class="w-full text-[10px] bg-green-800 hover:bg-green-700 px-3 py-2 rounded mb-2">
                            üíæ Download JSON
                        </button>
                        <button onclick="copyMetadata()" class="w-full text-[10px] bg-blue-800 hover:bg-blue-700 px-3 py-2 rounded">
                            üìã Copy to Clipboard
                        </button>
                    </div>
                    
                    <div class="bg-gray-900/50 rounded border border-gray-700 p-3">
                        <h4 class="text-sm font-bold text-white mb-2">Origin Types</h4>
                        <div class="text-[8px] space-y-0.5">
                            <div><span class="text-green-400">üè† terra_native</span> - Built on Terra (80)</div>
                            <div><span class="text-cyan-400">üîÑ terra_lsd</span> - Terra LSDs (85)</div>
                            <div><span class="text-purple-400">‚öõÔ∏è ibc</span> - Standard IBC (70)</div>
                            <div><span class="text-yellow-400">üåâ bridge_eureka</span> - Skip (.atom) (55)</div>
                            <div><span class="text-orange-400">üî∂ bridge_axelar</span> - Axelar (.axl) (50)</div>
                            <div><span class="text-orange-300">üü† bridge_osmosis</span> - Osmosis (.osmo) (50)</div>
                            <div><span class="text-blue-400">üíµ stable_native</span> - Native stables (65)</div>
                            <div><span class="text-gray-500">‚ùì unknown</span> - Not classified (30)</div>
                        </div>
                    </div>
                    
                    <div class="bg-gray-900/50 rounded border border-gray-700 p-3">
                        <h4 class="text-sm font-bold text-white mb-2">Scoring</h4>
                        <div class="text-[8px] space-y-0.5">
                            <div><span class="text-green-400">‚úì Name</span> - TLA = Actual (+10)</div>
                            <div><span class="text-red-400">‚úó Name</span> - Mismatch (-10)</div>
                            <div><span class="text-green-400">‚úì Skip</span> - Easy to find (+5)</div>
                            <div><span class="text-red-400">‚úó Skip</span> - Confusing (-5)</div>
                            <div><span class="text-purple-400">‚òë DEX</span> - Multi-DEX (+5)</div>
                        </div>
                    </div>
                    
                    <div class="bg-gray-900/50 rounded border border-gray-700 p-3">
                        <h4 class="text-sm font-bold text-white mb-2">Treasury Value</h4>
                        <div class="text-[8px] space-y-0.5">
                            <div><span class="text-yellow-400">üèÜ High</span> - BTC, ETH, stables (+5)</div>
                            <div><span class="text-blue-400">üëç Medium</span> - LSDs, useful (+0)</div>
                            <div><span class="text-gray-400">üëé Low</span> - Protocol tokens (-5)</div>
                        </div>
                    </div>
                    
                    <div class="bg-gray-900/50 rounded border border-gray-700 p-3">
                        <h4 class="text-sm font-bold text-white mb-2">CoinGecko</h4>
                        <div class="text-[8px] space-y-0.5">
                            <div><span class="text-green-400">‚úì</span> - Terra ID (+15)</div>
                            <div><span class="text-yellow-400">‚óã</span> - Chain only (+5)</div>
                            <div><span class="text-red-400">‚úó</span> - Not listed (-15)</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- GitHub Info -->
            <div class="mt-3 p-2 bg-gray-800/50 rounded border border-gray-700 text-[10px] text-gray-400">
                <strong>GitHub:</strong> After editing, download the JSON and replace <code class="bg-gray-900 px-1 rounded">tla_metadata.json</code> in your repository.
                Expected URL: <code class="bg-gray-900 px-1 rounded">https://raw.githubusercontent.com/defipatriot/tla_json_storage/main/tla_metadata.json</code>
            </div>
        </div>
    </div>
</div>

<!-- Modals -->
<div id="token-modal" class="modal-overlay" onclick="if(event.target===this)togModal('token',0)">
    <div class="modal-box"><div class="flex justify-between border-b border-gray-700 pb-2 mb-2"><h3 class="font-bold">Tokens</h3><span onclick="togModal('token',0)" class="cursor-pointer">‚úï</span></div><div id="mod-tok-list" class="space-y-1 text-xs"></div></div>
</div>

<div id="vote-rew-modal" class="modal-overlay" onclick="if(event.target===this)togModal('vote-rew',0)">
    <div class="modal-box">
        <div class="flex justify-between border-b border-gray-700 pb-2 mb-2">
            <h3 class="font-bold text-cyan-400">Vote Rewards</h3>
            <span onclick="togModal('vote-rew',0)" class="cursor-pointer">‚úï</span>
        </div>
        <div class="bg-gray-900 p-2 rounded border border-gray-800 mb-3 text-[10px]">
            <div class="flex justify-between mb-1">
                <span class="text-gray-500">Periods:</span>
                <span id="mod-vote-periods" class="text-white font-mono">-</span>
            </div>
            <div class="flex justify-between">
                <span class="text-gray-500">Unclaimed:</span>
                <span id="mod-vote-epoch-count" class="text-yellow-400 font-bold">-</span>
            </div>
        </div>
        <div id="mod-vote-list" class="space-y-1 text-xs"></div>
    </div>
</div>

<div id="incentives-modal" class="modal-overlay" onclick="if(event.target===this)togModal('incentives',0)">
    <div class="modal-box w-[800px] flex flex-col"><div class="flex justify-between border-b border-gray-700 pb-2 mb-2"><h3 class="font-bold text-green-400">Incentives Detail</h3><span onclick="togModal('incentives',0)" class="cursor-pointer">‚úï</span></div>
        <div class="mb-3 text-[10px] text-gray-400 bg-gray-900 p-2 rounded border border-gray-800 font-bold" id="mod-inc-bucket-title">All Buckets</div>
        <div class="grid grid-cols-12 gap-1 text-[9px] text-gray-500 uppercase font-bold border-b border-gray-700 pb-1 mb-2">
            <div class="col-span-5">Pool</div>
            <div class="col-span-2 text-right">Bribes</div>
            <div class="col-span-2 text-right text-green-400">Total</div>
            <div class="col-span-3 text-right text-blue-400">vAPR</div>
        </div>
        <div id="mod-inc-content" class="space-y-1 text-[10px] max-h-[60vh] overflow-y-auto custom-scroll flex-grow"></div>
    </div>
</div>

<script>
// === UTILITIES ===
const $ = id => document.getElementById(id);
const setTxt = (id, v) => { const e = $(id); if(e) e.innerText = v; };
const setHtml = (id, v) => { const e = $(id); if(e) e.innerHTML = v; };
const togModal = (id, show) => { const el = $(id+'-modal'); if(el) el.classList.toggle('open', show); };
const fmt$ = n => '$' + (n || 0).toLocaleString(undefined, {maximumFractionDigits: 0});
const fmtVp = n => {
    if (!n || n === 0) return '-';
    if (n >= 1e6) return (n / 1e6).toFixed(2) + 'M';
    if (n >= 1e3) return (n / 1e3).toFixed(1) + 'K';
    return n.toLocaleString();
};

// Unified number parser: handles K/M suffixes, strips non-numeric
function parseNum(s) {
    if (!s) return 0;
    let str = String(s);
    let mult = 1;
    if (/[\d\.]\s*[Kk]\b/.test(str)) mult = 1e3;
    if (/[\d\.]\s*[Mm]\b/.test(str)) mult = 1e6;
    return parseFloat(str.replace(/[^0-9\.]/g, '')) * mult || 0;
}

// Clear paste box
function clearPaste(id) {
    const el = $(id);
    if (el) el.value = '';
}

// Update paste status indicator
function updatePasteStatus(id, done) {
    const el = $(id);
    if (el) {
        if (done) {
            el.className = 'px-2 py-0.5 rounded bg-green-900/50 text-green-400 border border-green-700';
        } else {
            el.className = 'px-2 py-0.5 rounded bg-gray-800 text-gray-500 border border-gray-700';
        }
    }
}

// Skip inactive liquidity step
function skipInactive() {
    pasteStatus.liqInactive = true;
    updatePasteStatus('ps-liq-inactive', true);
}

const BUCKET_ORDER = ['STABLE', 'PROJECT', 'BLUECHIP', 'SINGLE'];

// === DATA STORE ===
let store = {
    dao: { dep: 0, apr: 0, rew: {z: 0, amp: 0, usd: 0}, toks: [], vRew: {}, vRewPeriods: [], lVp: 0, lFac: 0, lAst: 0, locks: [] },
    tla: { tvl: 0, rewYr: 0, pools: [], inactivePools: [] },
    vote: { ep: 0, end: '-', pools: [], tvp: 0, reb: 0, usd: 0 },
    ext: { lps: {}, meta: {}, loaded: false }
};

// Paste completion status
let pasteStatus = {
    vote: false,
    voteRew: false,
    liqActive: false,
    liqInactive: false,
    liqDep: false,
    liqRew: false,
    locks: false,
    ext: false
};

// === EPOCH DATA ===
let epochData = []; // Will be loaded from GitHub
let currentEpochInfo = null;

// === INIT ===
window.onload = async function() {
    await loadEpochData();
    await loadExtData();
    await findLatestSnapshot();
    setInterval(updateTimers, 1000);
    updateTimers();
    updateGithubLink();
};

async function loadEpochData() {
    const url = 'https://raw.githubusercontent.com/defipatriot/tla_json_storage/main/epoch_1-300_date.json';
    const statusEl = $('status-epoch-file');
    
    try {
        let res = await fetch(url);
        if (!res.ok) throw new Error("Failed to fetch");
        epochData = await res.json();
        
        // Success - turn green
        if (statusEl) {
            statusEl.className = 'text-green-500 font-bold';
            statusEl.innerText = 'Epoch File ‚úì';
        }
        
        findCurrentEpoch();
    } catch(e) {
        console.error("Failed to load epoch data:", e);
        // Failed - turn red
        if (statusEl) {
            statusEl.className = 'text-red-500 font-bold';
            statusEl.innerText = 'Epoch File ‚úó';
        }
    }
}

async function loadExtData() {
    // Build URL based on current epoch and phase
    let epoch = currentEpochInfo?.epoch || store.vote.ep || 161;
    let endTime = currentEpochInfo?.end_time ? new Date(currentEpochInfo.end_time) : null;
    let phase = 'mid'; // Default
    
    if (endTime) {
        let msUntilEnd = endTime - new Date();
        let daysLeft = msUntilEnd / 86400000; // Decimal days (not floored)
        if (daysLeft >= 5) phase = 'start';
        else if (daysLeft > 2) phase = 'mid';
        else phase = 'end';
    }
    
    console.log('Ext data: epoch=' + epoch + ', phase=' + phase);
    
    const extBaseUrl = 'https://raw.githubusercontent.com/defipatriot/tla-ext_json_storage/main/';
    const mainBaseUrl = 'https://raw.githubusercontent.com/defipatriot/tla_json_storage/main/';
    
    // Check each file individually
    const files = {
        historical: {
            url: extBaseUrl + 'tla_ext_historical.json',
            statusEl: $('status-historical'),
            dateEl: $('status-historical-date'),
            dateField: 'meta.epoch_start,meta.epoch_end', // Special: show epoch range
            loaded: false,
            data: null
        },
        archive: {
            url: extBaseUrl + 'tla_ext_archive.json',
            statusEl: $('status-archive'),
            dateEl: $('status-archive-date'),
            dateField: 'meta.epoch_start,meta.epoch_end', // Special: show epoch range
            loaded: false,
            data: null
        },
        epochExt: {
            // Try all phases in order: end, mid, start
            urls: [
                extBaseUrl + `tla-ext-epoch-${epoch}-end.json`,
                extBaseUrl + `tla-ext-epoch-${epoch}-mid.json`,
                extBaseUrl + `tla-ext-epoch-${epoch}-start.json`
            ],
            url: extBaseUrl + `tla-ext-epoch-${epoch}-${phase}.json`, // Default
            statusEl: $('status-epoch-ext'),
            dateEl: $('status-epoch-ext-date'),
            dateField: 'meta.generated_at',
            loaded: false,
            data: null
        },
        pdBribes: {
            url: extBaseUrl + 'tla_pd_bribes.json',
            statusEl: $('status-pd-bribes'),
            dateEl: $('status-pd-bribes-date'),
            dateField: null, // Array, check last item
            loaded: false,
            data: null
        },
        metadata: {
            url: mainBaseUrl + 'tla_metadata.json',
            statusEl: $('status-metadata'),
            dateEl: $('status-metadata-date'),
            dateField: 'updated',
            loaded: false,
            data: null
        }
    };
    
    // Format date helper
    function formatDate(dateStr) {
        if (!dateStr) return '-';
        // If it looks like an epoch range like "[160-163]", return as-is
        if (dateStr.startsWith('[') || dateStr.startsWith('Ep ')) {
            return dateStr;
        }
        try {
            let d = new Date(dateStr);
            if (isNaN(d.getTime())) return dateStr; // Not a valid date, return as-is
            let now = new Date();
            let diffDays = Math.floor((now - d) / 86400000);
            let dateShort = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            if (diffDays === 0) return 'today';
            if (diffDays === 1) return 'yesterday';
            if (diffDays < 7) return diffDays + 'd ago';
            return dateShort;
        } catch(e) {
            return dateStr || '-';
        }
    }
    
    // Update status element helper
    function setFileStatus(el, dateEl, status, filename, dateStr) {
        if (el) {
            if (status === 'loading') {
                el.className = 'text-yellow-500 cursor-pointer font-semibold';
                el.title = 'Loading ' + filename + '...';
            } else if (status === 'found') {
                el.className = 'text-green-500 font-bold cursor-pointer';
                el.title = filename + ' ‚úì';
            } else if (status === 'missing') {
                el.className = 'text-red-500 cursor-pointer font-semibold';
                el.title = filename + ' ‚úó (not found)';
            } else if (status === 'none') {
                el.className = 'text-gray-500 cursor-pointer font-semibold';
                el.title = filename + ' (none yet)';
            } else if (status === 'error') {
                el.className = 'text-orange-500 cursor-pointer font-semibold';
                el.title = filename + ' (error loading)';
            }
        }
        if (dateEl) {
            if (status === 'found' && dateStr) {
                dateEl.innerText = formatDate(dateStr);
                dateEl.className = 'text-[8px] text-gray-400';
            } else if (status === 'missing') {
                dateEl.innerText = 'missing';
                dateEl.className = 'text-[8px] text-red-600';
            } else if (status === 'none') {
                dateEl.innerText = 'none';
                dateEl.className = 'text-[8px] text-gray-600';
            } else {
                dateEl.innerText = '-';
                dateEl.className = 'text-[8px] text-gray-600';
            }
        }
    }
    
    // Check each file
    for (let [key, file] of Object.entries(files)) {
        // Special handling for epochExt - try multiple phase URLs
        if (key === 'epochExt' && file.urls) {
            let found = false;
            for (let tryUrl of file.urls) {
                let filename = tryUrl.split('/').pop();
                setFileStatus(file.statusEl, file.dateEl, 'loading', filename, null);
                
                try {
                    let fetchUrl = tryUrl + '?t=' + Date.now();
                    console.log('Trying epochExt:', tryUrl);
                    let res = await fetch(fetchUrl, { cache: 'no-store' });
                    
                    if (res.ok) {
                        let jsonData;
                        try {
                            jsonData = await res.json();
                        } catch (parseErr) {
                            console.warn('JSON parse failed for', filename, parseErr);
                            continue; // Try next URL
                        }
                        
                        // Validate structure
                        if (!jsonData.meta || !jsonData.votion) {
                            console.warn('epochExt missing expected structure:', Object.keys(jsonData));
                            continue; // Try next URL
                        }
                        
                        file.data = jsonData;
                        file.loaded = true;
                        file.url = tryUrl; // Store which URL worked
                        
                        let dateStr = jsonData.meta?.generated_at || null;
                        setFileStatus(file.statusEl, file.dateEl, 'found', filename, dateStr);
                        console.log('Found epochExt:', filename);
                        found = true;
                        break;
                    }
                } catch(e) {
                    console.log('Failed to fetch', tryUrl, e.message);
                }
            }
            
            if (!found) {
                let filename = `tla-ext-epoch-${epoch}-*.json`;
                setFileStatus(file.statusEl, file.dateEl, 'missing', filename, null);
                console.log('No epochExt found for epoch', epoch);
            }
            continue; // Skip normal processing for epochExt
        }
        
        let filename = file.url.split('/').pop();
        setFileStatus(file.statusEl, file.dateEl, 'loading', filename, null);
        
        try {
            // Add cache-busting parameter
            let fetchUrl = file.url + '?t=' + Date.now();
            console.log('Fetching:', file.url);
            let res = await fetch(fetchUrl, { cache: 'no-store' });
            console.log('Response:', filename, 'status=' + res.status, 'ok=' + res.ok);
            if (res.ok) {
                let jsonData;
                try {
                    jsonData = await res.json();
                } catch (parseErr) {
                    console.error('JSON parse failed for', filename, parseErr);
                    setFileStatus(file.statusEl, file.dateEl, 'error', filename + ' (invalid JSON)', null);
                    continue;
                }
                
                // Validate epochExt has expected structure
                if (key === 'epochExt') {
                    if (!jsonData.meta || !jsonData.votion) {
                        console.warn('epochExt missing expected structure:', Object.keys(jsonData));
                        setFileStatus(file.statusEl, file.dateEl, 'error', filename + ' (invalid format)', null);
                        continue;
                    }
                }
                
                file.data = jsonData;
                file.loaded = true;
                
                // Extract date from data
                let dateStr = null;
                if (file.dateField && file.dateField.includes(',')) {
                    // Special case: epoch range like "meta.epoch_start,meta.epoch_end"
                    let [startField, endField] = file.dateField.split(',');
                    let startParts = startField.split('.');
                    let endParts = endField.split('.');
                    let startVal = file.data;
                    let endVal = file.data;
                    for (let p of startParts) startVal = startVal?.[p];
                    for (let p of endParts) endVal = endVal?.[p];
                    if (startVal && endVal) {
                        dateStr = `Ep ${startVal}-${endVal}`;
                    }
                } else if (file.dateField) {
                    let parts = file.dateField.split('.');
                    let val = file.data;
                    for (let p of parts) {
                        val = val?.[p];
                    }
                    dateStr = val;
                } else if (key === 'pdBribes' && Array.isArray(file.data) && file.data.length > 0) {
                    // For PD bribes array, show the last epoch range covered
                    let lastRange = file.data[file.data.length - 1];
                    dateStr = lastRange?.epoch_range || ('Ep ' + lastRange?.start_epoch + '-' + lastRange?.end_epoch);
                }
                
                setFileStatus(file.statusEl, file.dateEl, 'found', filename, dateStr);
                console.log('Found:', filename);
            } else {
                // For archive, show "none" instead of "missing" since it's expected
                let displayStatus = key === 'archive' ? 'none' : 'missing';
                setFileStatus(file.statusEl, file.dateEl, displayStatus, filename + ' (HTTP ' + res.status + ')', null);
                console.log('Missing:', filename, 'HTTP', res.status);
            }
        } catch(e) {
            setFileStatus(file.statusEl, file.dateEl, 'error', filename + ' (' + e.message + ')', null);
            console.error('Error loading:', file.url, e);
        }
    }
    
    // Apply historical data (has lps for 4Ep averages)
    if (files.historical.loaded && files.historical.data?.lps) {
        store.ext.lps = files.historical.data.lps;
        store.ext.meta = files.historical.data.meta || {};
        store.ext.loaded = true;
        console.log('Applied historical lps:', Object.keys(store.ext.lps).length, 'LPs');
    }
    
    // Apply archive data (older epochs)
    if (files.archive.loaded && files.archive.data?.lps) {
        store.ext.archive = files.archive.data;
        console.log('Applied archive:', Object.keys(files.archive.data.lps).length, 'LPs');
    }
    
    // Apply epoch ext data (votion, pd_bribes)
    if (files.epochExt.loaded && files.epochExt.data) {
        store.ext.votion = files.epochExt.data.votion || null;
        store.ext.pdBribesEpoch = files.epochExt.data.pd_bribes || null;
        console.log('Applied epoch ext data: votion=' + !!store.ext.votion + ', pd_bribes=' + !!store.ext.pdBribesEpoch);
    }
    
    // Apply PD bribes master file
    if (files.pdBribes.loaded && files.pdBribes.data) {
        store.ext.pdBribesMaster = files.pdBribes.data;
        console.log('Applied PD bribes master:', store.ext.pdBribesMaster.length, 'ranges');
    }
    
    // Apply metadata
    if (files.metadata.loaded && files.metadata.data) {
        store.ext.metadata = files.metadata.data;
        console.log('Applied metadata:', Object.keys(store.ext.metadata.assets || {}).length, 'assets');
    }
    
    // Show legend if we have lps data
    if (store.ext.loaded) {
        let legend = $('ext-data-legend');
        if (legend) legend.classList.remove('hidden');
        
        // Re-render vote table to apply ext data
        if (store.vote.pools.length > 0) {
            applyExtDataToPools();
            renderVoteTable();
        }
    }
}

function showExtManualLoad() {
    let el = $('ext-manual-load');
    if (el) el.classList.remove('hidden');
}

function toggleExtPaste() {
    let el = $('ext-paste-area');
    if (el) el.classList.toggle('hidden');
}

function loadExtFromFile(event) {
    let file = event.target.files[0];
    if (!file) return;
    
    let reader = new FileReader();
    reader.onload = function(e) {
        try {
            let data = JSON.parse(e.target.result);
            applyExtData(data);
        } catch(err) {
            alert('Error parsing ext JSON file: ' + err.message);
        }
    };
    reader.readAsText(file);
}

function loadExtFromPaste() {
    let txt = $('ext-paste').value;
    if (!txt.trim()) {
        alert('Please paste ext JSON data first');
        return;
    }
    
    try {
        let data = JSON.parse(txt);
        applyExtData(data);
    } catch(err) {
        alert('Error parsing ext JSON: ' + err.message);
    }
}

function applyExtData(data) {
    store.ext.lps = data.lps || {};
    store.ext.meta = data.meta || {};
    store.ext.loaded = true;
    
    // Update paste progress status
    updatePasteStatus('ps-ext', true);
    
    // Show legend
    let legend = $('ext-data-legend');
    if (legend) legend.classList.remove('hidden');
    
    // Hide manual load section
    let manualEl = $('ext-manual-load');
    if (manualEl) manualEl.classList.add('hidden');
    
    // Re-render vote table to apply ext data
    if (store.vote.pools.length > 0) {
        applyExtDataToPools();
        renderVoteTable();
    }
    
    alert('Ext data loaded: ' + Object.keys(store.ext.lps).length + ' LPs');
}

function applyExtDataToPools() {
    if (!store.ext.loaded && !store.ext.votion && !store.ext.pdBribesEpoch) return;
    
    // Get current epoch for looking up data
    let targetEpoch = store.vote.ep || currentEpochInfo?.epoch || 0;
    
    // Get votion data - handle both old (lockups) and new (pools) formats
    let votionTotalVp = store.ext.votion?.total_vp || 0;
    let votionPools = store.ext.votion?.pools || {};
    let votionRatios = store.ext.votion?.ratios || {};
    
    // If we have lockups but no pools, aggregate from lockups (old format)
    if (store.ext.votion?.lockups && Object.keys(votionPools).length === 0) {
        store.ext.votion.lockups.forEach(lockup => {
            votionTotalVp += lockup.vp || 0;
            
            lockup.buckets?.forEach(bucket => {
                bucket.pools?.forEach(pool => {
                    let poolName = pool.name
                        .replace(' LP', '')
                        .replace(/\.(atom|axl|osmo|wh)/gi, '')
                        .trim();
                    
                    // Normalize LUNA position - only swap if LUNA itself is second
                    if (poolName.includes('-')) {
                        let parts = poolName.split('-');
                        if (parts[1] === 'LUNA') {
                            poolName = `LUNA-${parts[0]}`;
                        }
                    }
                    
                    let lpKey = `${poolName}|Astroport`;
                    
                    if (!votionPools[lpKey]) {
                        votionPools[lpKey] = { current_pct: 0, current_vp: 0, optimized_pct: 0, optimized_vp: 0 };
                    }
                    
                    let lockupVp = lockup.vp || 0;
                    votionPools[lpKey].current_vp += lockupVp * (pool.current / 100);
                    votionPools[lpKey].optimized_vp += lockupVp * (pool.optimized / 100);
                });
            });
        });
        
        // Calculate percentages
        Object.keys(votionPools).forEach(key => {
            if (votionTotalVp > 0) {
                votionPools[key].current_pct = (votionPools[key].current_vp / votionTotalVp) * 100;
                votionPools[key].optimized_pct = (votionPools[key].optimized_vp / votionTotalVp) * 100;
            }
            votionPools[key].current_vp = Math.round(votionPools[key].current_vp);
            votionPools[key].optimized_vp = Math.round(votionPools[key].optimized_vp);
        });
        
        console.log('Aggregated votion from lockups:', Object.keys(votionPools).length, 'pools, total VP:', votionTotalVp.toLocaleString());
    }
    
    // Get PD bribes from epoch ext file (not master)
    let pdBribesEpoch = store.ext.pdBribesEpoch || {};
    
    // Helper to find votion pool with flexible matching
    function findVotionPool(poolName, dexName) {
        // Normalize for comparison - lowercase, ensure dot before suffix
        function normalize(name) {
            // Handle suffix attached without dot (WBTCaxl -> wbtc.axl)
            // Only add dot if not preceded by one
            name = name.replace(/([^.])(atom|axl|osmo|wh)$/gi, (m, p1, p2) => p1 + '.' + p2.toLowerCase());
            // Lowercase the dot-suffix
            name = name.replace(/\.(ATOM|AXL|OSMO|WH)/g, (m) => m.toLowerCase());
            // Lowercase everything for comparison
            return name.toLowerCase();
        }
        
        function hasBridgeSuffix(name) {
            return /\.(atom|axl|osmo|wh)$/i.test(name);
        }
        
        function stripSuffix(name) {
            return name.replace(/\.(atom|axl|osmo|wh)$/gi, '');
        }
        
        let normPoolName = normalize(poolName);
        let poolHasSuffix = hasBridgeSuffix(normPoolName);
        
        // Build list of search variations (exact + swapped order)
        let searchVariants = [normPoolName];
        if (normPoolName.includes('-')) {
            let parts = normPoolName.split('-');
            searchVariants.push(`${parts[1]}-${parts[0]}`);
        }
        
        // PASS 1: Try exact match (including suffix)
        for (let key of Object.keys(votionPools)) {
            let [keyPool, keyDex] = key.split('|');
            if (keyDex !== dexName) continue;
            
            let normKeyPool = normalize(keyPool);
            for (let variant of searchVariants) {
                if (normKeyPool === variant) {
                    return votionPools[key];
                }
            }
        }
        
        // PASS 2: If vote pool has NO suffix, try matching against votion pools WITH suffix
        // This handles cases like Vote: "LUNA-PAXG" matching Votion: "LUNA-PAXG.atom"
        if (!poolHasSuffix) {
            let matches = [];
            for (let key of Object.keys(votionPools)) {
                let [keyPool, keyDex] = key.split('|');
                if (keyDex !== dexName) continue;
                
                let normKeyPool = normalize(keyPool);
                let normKeyNoSuffix = stripSuffix(normKeyPool);
                
                for (let variant of searchVariants) {
                    if (normKeyNoSuffix === variant) {
                        matches.push({ key, pool: votionPools[key] });
                    }
                }
            }
            
            // Only use fallback if exactly one match found
            if (matches.length === 1) {
                console.log(`Votion fallback: ${poolName} -> ${matches[0].key} (vote has no suffix)`);
                return matches[0].pool;
            } else if (matches.length > 1) {
                console.log(`Votion ambiguous: ${poolName} matches ${matches.length} pools, skipping`);
            }
        }
        
        return null;
    }
    
    store.vote.pools.forEach(p => {
        // Create key to match ext data: "LUNA-USDC|Astroport"
        // Single-sided assets (ampCAPA, xASTRO) are still on Astroport
        // Use helper functions that handle all DEX name variants (White Whale, Skeleton Swap, etc.)
        let dexName = isAstroport(p.d) ? 'Astroport' : 
                      isSkeletonSwap(p.d) ? 'Skeleton Swap' : null;
        if (!dexName) return;
        
        let lpKey = `${p.n}|${dexName}`;
        let extLp = store.ext.lps?.[lpKey];
        
        // === APPLY LIQUIDITY/VOLUME FROM HISTORICAL ===
        if (extLp && !extLp.notAvailable) {
            let liqData = null, volData = null;
            
            for (let ep = targetEpoch; ep >= targetEpoch - 5 && ep > 0; ep--) {
                if (!liqData && extLp.liquidity?.epochs?.[ep]) {
                    liqData = extLp.liquidity.epochs[ep];
                }
                if (!volData && extLp.volume?.epochs?.[ep]) {
                    volData = extLp.volume.epochs[ep];
                }
                if (liqData && volData) break;
            }
            
            if (liqData && (!p.dp || p.dp === 0)) {
                p.dp = liqData.avg;
                p.dpSource = 'ext';
            }
            if (volData && (!p.vol || p.vol === 0)) {
                p.vol = volData.avg;
                p.volSource = 'ext';
            }
        }
        
        // === APPLY VOTION DATA FROM EPOCH EXT ===
        let votionPool = findVotionPool(p.n, dexName);
        if (votionPool) {
            p.votNowVp = votionPool.current_vp || 0;
            p.votNowPct = votionPool.current_pct || 0;
            p.votNextVp = votionPool.optimized_vp || 0;
            p.votNextPct = votionPool.optimized_pct || 0;
            p.votionSource = 'ext';
        }
        
        // === APPLY PD BRIBES FROM EPOCH EXT ===
        // PD bribes are stored per-LP in ext file (e.g., "LUNA-USDC|Astroport")
        // Try exact match first, then flexible matching
        let pdBribe = pdBribesEpoch[lpKey];
        
        if (!pdBribe) {
            // Try flexible matching - normalize and compare
            let normPoolName = p.n.toLowerCase().replace(/\.(atom|axl|osmo|wh)/gi, '');
            for (let pdKey of Object.keys(pdBribesEpoch)) {
                let [pdPool, pdDex] = pdKey.split('|');
                if (pdDex !== dexName) continue;
                
                let normPdPool = pdPool.toLowerCase().replace(/\.(atom|axl|osmo|wh)/gi, '');
                if (normPdPool === normPoolName) {
                    pdBribe = pdBribesEpoch[pdKey];
                    console.log(`PD bribe match: ${p.n} -> ${pdPool}`);
                    break;
                }
                // Try swapped order
                if (normPoolName.includes('-')) {
                    let parts = normPoolName.split('-');
                    let swapped = `${parts[1]}-${parts[0]}`;
                    if (normPdPool === swapped) {
                        pdBribe = pdBribesEpoch[pdKey];
                        console.log(`PD bribe match (swapped): ${p.n} -> ${pdPool}`);
                        break;
                    }
                }
            }
        }
        
        if (pdBribe) {
            p.incPD = pdBribe.usd || 0;
            p.incPDPct = pdBribe.pct || 0;
            p.incPDSource = 'ext';
        }
        
        // === CALCULATE OTHER BRIBES ===
        // incTotal = total bribes from Vote page
        // incPD = PD bribes from ext file
        // incOther = incTotal - incPD (other non-PD bribes)
        if (p.incTotal > 0 && p.incPD > 0) {
            p.incOther = Math.max(0, p.incTotal - p.incPD);
        } else if (p.incTotal > 0 && !p.incPD) {
            // Have total but no PD data - can't determine breakdown
            p.incOther = 0;
        }
        
        // === APPLY INCENTIVES FROM LIQUIDITY PASTE ===
        // Case-insensitive matching for pool names
        let pnLower = p.n.toLowerCase().replace(/\.(atom|axl|osmo|wh)/gi, '');
        let liqPool = store.tla.pools?.find(lp => {
            let lpNormLower = (lp.normName || '').toLowerCase().replace(/\.(atom|axl|osmo|wh)/gi, '');
            if (lpNormLower !== pnLower) return false;
            // Use helper functions to match DEX
            if (isSkeletonSwap(dexName) && isSkeletonSwap(lp.dex)) return true;
            if (isAstroport(dexName) && isAstroport(lp.dex)) return true;
            return false;
        });
        if (!liqPool) {
            liqPool = store.tla.inactivePools?.find(lp => {
                let lpNormLower = (lp.normName || '').toLowerCase().replace(/\.(atom|axl|osmo|wh)/gi, '');
                if (lpNormLower !== pnLower) return false;
                if (isSkeletonSwap(dexName) && isSkeletonSwap(lp.dex)) return true;
                if (isAstroport(dexName) && isAstroport(lp.dex)) return true;
                return false;
            });
        }
        
        if (liqPool) {
            // Apply APR from liquidity data
            if (!p.aprNon || p.aprNon === 0) p.aprNon = liqPool.aprNon || 0;
            if (!p.aprAmp || p.aprAmp === 0) p.aprAmp = liqPool.aprAmp || 0;
            
            // Note: liqPool.rYr is TOTAL yearly rewards which includes all incentives
            // We don't use it for incOther because we can't distinguish sources
            // incPD comes from the Vote page or ext file and is the weekly PD bribe amount
        } else if (store.tla.pools?.length > 0) {
            // Debug: log failed matches
            console.log(`APR no match: ${p.n} (${dexName}) - searched ${store.tla.pools.length} pools`);
        }
    });
    
    if (votionRatios.arbLUNA || votionRatios.ampLUNA) {
        store.ext.votionRatios = votionRatios;
    }
    
    // Update Votion summary display
    updateVotionSummary(votionTotalVp, Object.keys(votionPools).length);
    
    console.log('Applied ext data to pools: votion=' + Object.keys(votionPools).length + 
                ', pdBribes=' + Object.keys(pdBribesEpoch).length);
}

function updateVotionSummary(totalVp, poolCount) {
    let summaryEl = $('votion-summary');
    if (!summaryEl) return;
    
    if (totalVp > 0) {
        summaryEl.classList.remove('hidden');
        
        // Format VP
        let vpStr = totalVp >= 1000000 ? (totalVp / 1000000).toFixed(2) + 'M' :
                    totalVp >= 1000 ? (totalVp / 1000).toFixed(0) + 'K' : 
                    totalVp.toLocaleString();
        setTxt('votion-total-vp', vpStr);
        
        // Calculate % of TLA
        let tlaPct = store.vote.tvp > 0 ? (totalVp / store.vote.tvp * 100).toFixed(1) + '%' : '-';
        setTxt('votion-tla-pct', tlaPct);
        
        // Show source info
        let phase = store.ext.votion?.phase || store.ext.meta?.phase || 'ext';
        let epoch = store.ext.votion?.epoch || store.ext.meta?.epoch || store.vote.ep;
        setTxt('votion-source', `Ep ${epoch} ${phase} (${poolCount} pools)`);
    } else {
        summaryEl.classList.add('hidden');
    }
}

// ============ aDAO SCORING SYSTEM ============

function get4EpochAverage(lpKey, type) {
    // type = 'liquidity' or 'volume'
    if (!store.ext.loaded || !store.ext.lps[lpKey]) return null;
    
    let extLp = store.ext.lps[lpKey];
    if (extLp.notAvailable) return null;
    
    let targetEpoch = store.vote.ep || currentEpochInfo?.epoch || 0;
    let epochs = extLp[type]?.epochs || {};
    
    // Get up to 4 previous epochs (not current)
    let values = [];
    for (let ep = targetEpoch - 1; ep >= targetEpoch - 4 && ep > 0; ep--) {
        if (epochs[ep]?.avg) {
            values.push({ epoch: ep, avg: epochs[ep].avg });
        }
    }
    
    if (values.length === 0) return null;
    
    let sum = values.reduce((s, v) => s + v.avg, 0);
    return {
        avg: sum / values.length,
        epochs: values,
        count: values.length
    };
}

function getPoolApr(poolName, dex) {
    // Find APR from liquidity paste data
    // Case-insensitive matching
    let poolNameLower = poolName.toLowerCase().replace(/\.(atom|axl|osmo|wh)/gi, '');
    let liqPool = store.tla.pools.find(p => {
        let pnLower = (p.normName || '').toLowerCase().replace(/\.(atom|axl|osmo|wh)/gi, '');
        if (pnLower !== poolNameLower) return false;
        // Use helper functions to match DEX
        if (isSkeletonSwap(dex) && isSkeletonSwap(p.dex)) return true;
        if (isAstroport(dex) && isAstroport(p.dex)) return true;
        return false;
    });
    if (!liqPool) {
        liqPool = store.tla.inactivePools?.find(p => {
            let pnLower = (p.normName || '').toLowerCase().replace(/\.(atom|axl|osmo|wh)/gi, '');
            if (pnLower !== poolNameLower) return false;
            if (isSkeletonSwap(dex) && isSkeletonSwap(p.dex)) return true;
            if (isAstroport(dex) && isAstroport(p.dex)) return true;
            return false;
        });
    }
    return {
        non: liqPool?.aprNon || 0,
        amp: liqPool?.aprAmp || 0
    };
}

function calculateAprFactor(apr) {
    // Target APR = 50% non-amplified
    // Returns bonus/penalty based on distance from target
    if (!apr || apr === 0) return 0; // No data, neutral
    
    if (apr < 40) return 10;      // Needs help
    if (apr < 50) return 5;       // Slightly under target
    if (apr <= 55) return 0;      // At target (50-55 neutral zone)
    if (apr <= 60) return -5;     // Slightly over
    if (apr <= 70) return -15;    // Doing well
    if (apr <= 80) return -25;    // Very healthy
    return -35;                    // Thriving, definitely shift focus
}

// ============ ACCESS SCORE SYSTEM ============

const ASSET_TIERS = {
    // Blue Chip - Store of value, attracts serious capital
    bluechip: { assets: ['BTC', 'wBTC', 'ETH', 'wETH', 'PAXG'], points: 3, label: 'Blue Chip' },
    // Major Stables - Essential trading infrastructure
    stables: { assets: ['USDC', 'USDT', 'EURe', 'DAI'], points: 2.5, label: 'Major Stable' },
    // Ecosystem Core - Heart of Terra/Cosmos
    core: { assets: ['LUNA', 'ATOM', 'INJ'], points: 2.5, label: 'Ecosystem Core' },
    // Native Terra Projects - Supporting local builders
    native: { assets: ['ROAR', 'CAPA', 'SOLID', 'ASTRO', 'FUEL', 'xASTRO', 'ampCAPA'], points: 2, label: 'Native Terra' },
    // Protocol LSDs - Useful derivatives
    lsd: { assets: ['ampLUNA', 'arbLUNA', 'bLUNA', 'stLUNA', 'stATOM', 'boneLUNA'], points: 1.5, label: 'Protocol LSD' },
    // Cross-chain assets - Brings outside liquidity
    crosschain: { assets: ['wBNB', 'wstETH', 'SWTH'], points: 1, label: 'Cross-chain' }
};

const BRIDGE_QUALITY = {
    'native': { points: 3, label: 'Native (no bridge)' },
    '.atom': { points: 2.5, label: 'IBC/Skip (.atom)' },
    '.axl': { points: 2, label: 'Axelar (.axl)' },
    '.osmo': { points: 1.5, label: 'Osmosis (.osmo)' },
    '.wh': { points: 1, label: 'Wormhole (.wh)' }
};

function getAssetTier(assetName) {
    // Strip bridge suffix for matching
    let base = assetName.replace(/\.(atom|axl|osmo|wh)$/i, '');
    
    // Check metadata first (if loaded)
    let meta = assetMetadata[assetName] || assetMetadata[base];
    if (meta && meta.category) {
        let categoryPoints = {
            'bluechip': 3, 'stable': 2.5, 'core': 2.5, 'native': 2, 'lsd': 1.5, 'cross': 1, 'unknown': 0.5
        };
        let categoryLabels = {
            'bluechip': 'Blue Chip', 'stable': 'Stable', 'core': 'Core', 'native': 'Native Terra', 
            'lsd': 'LSD', 'cross': 'Cross-chain', 'unknown': 'Unknown'
        };
        return { 
            tier: meta.category, 
            points: categoryPoints[meta.category] || 0.5, 
            label: categoryLabels[meta.category] || 'Unknown',
            fromMetadata: true
        };
    }
    
    // Fallback to hardcoded ASSET_TIERS
    for (let [tier, data] of Object.entries(ASSET_TIERS)) {
        if (data.assets.some(a => base.toUpperCase().includes(a.toUpperCase()))) {
            return { tier, ...data };
        }
    }
    return { tier: 'unknown', points: 0.5, label: 'Unknown' };
}

function getBridgeQuality(assetName) {
    // Check metadata first (if loaded)
    let meta = assetMetadata[assetName];
    if (meta && meta.bridge) {
        let bridgeData = BRIDGE_QUALITY[meta.bridge] || BRIDGE_QUALITY['native'];
        return { suffix: meta.bridge, ...bridgeData, fromMetadata: true };
    }
    
    // Fallback to suffix detection
    let match = assetName.match(/\.(atom|axl|osmo|wh)$/i);
    if (match) {
        let suffix = '.' + match[1].toLowerCase();
        return { suffix, ...BRIDGE_QUALITY[suffix] };
    }
    // Native asset (no bridge)
    return { suffix: 'native', ...BRIDGE_QUALITY['native'] };
}

function getLunaBenefit(asset1, asset2) {
    let hasLuna = asset1.toUpperCase() === 'LUNA' || asset2.toUpperCase() === 'LUNA';
    let hasLsd = ['ampLUNA', 'arbLUNA', 'bLUNA', 'stLUNA', 'boneLUNA'].some(l => 
        asset1.toUpperCase().includes(l.toUpperCase()) || asset2.toUpperCase().includes(l.toUpperCase())
    );
    
    if (hasLuna) {
        // Check what LUNA is paired with
        let other = asset1.toUpperCase() === 'LUNA' ? asset2 : asset1;
        let otherTier = getAssetTier(other);
        
        if (otherTier.tier === 'bluechip') return { points: 3, label: 'LUNA + Blue Chip', reason: 'Attracts value TO Luna' };
        if (otherTier.tier === 'stables') return { points: 2.5, label: 'LUNA + Stable', reason: 'Trading infrastructure' };
        if (otherTier.tier === 'native') return { points: 2.5, label: 'LUNA + Native Terra', reason: 'Supporting ecosystem' };
        if (otherTier.tier === 'core') return { points: 2.5, label: 'LUNA + Ecosystem', reason: 'Cosmos connectivity' };
        if (otherTier.tier === 'lsd') return { points: 2, label: 'LUNA + LSD', reason: 'LSD utility' };
        return { points: 2, label: 'LUNA + Other', reason: 'Still benefits LUNA' };
    }
    
    if (hasLsd) {
        return { points: 1.5, label: 'LSD Pair', reason: 'Indirect LUNA support' };
    }
    
    // Check for stable-stable
    let tier1 = getAssetTier(asset1);
    let tier2 = getAssetTier(asset2);
    if (tier1.tier === 'stables' && tier2.tier === 'stables') {
        return { points: 1, label: 'Stable-Stable', reason: 'Useful but not LUNA focused' };
    }
    
    return { points: 0.5, label: 'Non-LUNA Pair', reason: 'Minimal ecosystem benefit' };
}

// Get detailed score breakdown for a single asset
function getAssetScoreDetails(assetName, meta) {
    if (!meta || !meta.actual_path) {
        return {
            name: assetName,
            score: 30,
            source: 'no_metadata',
            issues: ['‚ö†Ô∏è No metadata configured'],
            positives: [],
            notes: [],
            breakdown: {}
        };
    }
    
    let origin = ORIGIN_TYPES[meta.origin] || ORIGIN_TYPES.unknown;
    let assetClass = ASSET_CLASSES[meta.asset_class] || ASSET_CLASSES.unknown;
    let cg = CG_STATUS[meta.cg_status] || CG_STATUS.cg_none;
    let treasury = TREASURY_VALUE[meta.treasury_value] || TREASURY_VALUE.medium;
    let namingOk = isNamingAccurate(meta);
    
    let breakdown = {
        origin: { label: origin.label, base: origin.baseScore },
        assetClass: { label: assetClass.label, bonus: assetClass.bonus },
        cg: { label: cg.label, score: cg.score },
        treasury: { label: treasury.label, score: treasury.score },
        naming: { accurate: namingOk, score: namingOk ? 10 : -10, actual: meta.actual_path },
        skip: { clear: meta.skip_clear, score: meta.skip_clear ? 5 : -5 },
        multiDex: { enabled: meta.multi_dex, score: meta.multi_dex ? 5 : 0 }
    };
    
    let total = origin.baseScore + assetClass.bonus + cg.score + treasury.score + 
                breakdown.naming.score + breakdown.skip.score + breakdown.multiDex.score;
    total = Math.max(0, Math.min(100, total));
    
    // Identify issues (things that hurt the score)
    let issues = [];
    let positives = [];
    
    // Origin issues
    if (origin.baseScore < 50) {
        issues.push(`üî¥ ${origin.label} origin (-${85 - origin.baseScore} from native)`);
    } else if (origin.baseScore < 70) {
        issues.push(`üü° ${origin.label} origin (not native)`);
    } else {
        positives.push(`‚úÖ ${origin.label} origin`);
    }
    
    // CoinGecko
    if (cg.score < 0) {
        issues.push(`üî¥ Not on CoinGecko (${cg.score})`);
    } else if (cg.score > 5) {
        positives.push(`‚úÖ Listed on CG Terra (${cg.score > 0 ? '+' : ''}${cg.score})`);
    } else if (cg.score > 0) {
        positives.push(`‚úÖ Listed on CG (${cg.score > 0 ? '+' : ''}${cg.score})`);
    }
    
    // Naming
    if (!namingOk) {
        issues.push(`üî¥ Name mismatch: shows "${assetName}" but is "${meta.actual_path}" (-10)`);
    } else {
        positives.push(`‚úÖ Naming accurate (+10)`);
    }
    
    // Skip.go clarity
    if (!meta.skip_clear) {
        issues.push(`üü° Skip.go routing confusing (-5)`);
    }
    
    // Treasury value
    if (treasury.score < 0) {
        issues.push(`üü° Low treasury value (${treasury.score})`);
    } else if (treasury.score > 0) {
        positives.push(`‚úÖ High treasury value (+${treasury.score})`);
    }
    
    // Multi-DEX
    if (meta.multi_dex) {
        positives.push(`‚úÖ Multi-DEX available (+5)`);
    }
    
    // Add acquisition note if present
    let notes = [];
    if (meta.acquisition_note) {
        notes.push(`üìù ${meta.acquisition_note}`);
    }
    if (meta.acquisition === 'hard') {
        issues.push(`üî¥ Hard to acquire`);
    } else if (meta.acquisition === 'medium') {
        issues.push(`üü° Medium difficulty to acquire`);
    }
    
    return {
        name: assetName,
        score: total,
        source: 'metadata',
        origin: meta.origin,
        assetClass: meta.asset_class,
        issues: issues,
        positives: positives,
        notes: notes,
        breakdown: breakdown
    };
}

function calculatePoolAccessScore(poolName) {
    // Parse pool name: "LUNA-USDC" or "wBTC.axl-wBTC.osmo"
    let parts = poolName.split('-');
    if (parts.length !== 2) return { total: 50, breakdown: { error: 'Could not parse pool name' } };
    
    let [asset1, asset2] = parts;
    
    // Check if we have metadata for these assets
    let meta1 = assetMetadata[asset1];
    let meta2 = assetMetadata[asset2];
    
    // Get detailed breakdown for each asset
    let details1 = getAssetScoreDetails(asset1, meta1);
    let details2 = getAssetScoreDetails(asset2, meta2);
    
    let hasMetadata = details1.source === 'metadata' && details2.source === 'metadata';
    let avgScore = (details1.score + details2.score) / 2;
    
    // LUNA benefit bonus
    let lunaBenefit = 0;
    let lunaLabel = '';
    let lunaAssets = ['LUNA', 'ampLUNA', 'stLUNA', 'boneLUNA', 'arbLUNA', 'bLUNA'];
    let hasLuna = lunaAssets.includes(asset1) || lunaAssets.includes(asset2);
    
    if (hasLuna && hasMetadata) {
        let otherMeta = lunaAssets.includes(asset1) ? meta2 : meta1;
        
        if (otherMeta?.asset_class === 'stable') {
            lunaBenefit = 5;
            lunaLabel = 'LUNA + Stable (+5)';
        } else if (otherMeta?.asset_class === 'bluechip') {
            lunaBenefit = 5;
            lunaLabel = 'LUNA + Bluechip (+5)';
        } else if (otherMeta?.asset_class === 'lsd') {
            lunaBenefit = 3;
            lunaLabel = 'LUNA + LSD (+3)';
        } else {
            lunaBenefit = 2;
            lunaLabel = 'LUNA pair (+2)';
        }
    }
    
    let total = Math.min(100, avgScore + lunaBenefit);
    
    // Combine all issues and notes (with fallbacks for undefined)
    let allIssues = [...(details1.issues || []), ...(details2.issues || [])];
    let allPositives = [...(details1.positives || []), ...(details2.positives || [])];
    let allNotes = [...(details1.notes || []), ...(details2.notes || [])];
    
    return {
        total: total,
        raw: avgScore,
        max: 100,
        source: hasMetadata ? 'metadata' : 'fallback',
        breakdown: {
            asset1: details1,
            asset2: details2,
            assetAvg: avgScore,
            lunaBenefit: { label: lunaLabel, points: lunaBenefit },
            allIssues: allIssues,
            allPositives: allPositives,
            allNotes: allNotes
        }
    };
}

function calculateScoresForBucket(bucketName, filterSettings = null) {
    // Get all pools in this bucket
    let bucketPools = store.vote.pools.filter(p => p.b === bucketName);
    if (bucketPools.length === 0) return;
    
    // Apply filters if provided (for relative ranking)
    let poolsForRanking = bucketPools;
    if (filterSettings) {
        poolsForRanking = bucketPools.filter(p => {
            let isAct = p.vps >= 1;
            let isAstroOrSingle = isAstroport(p.d);
            if (isAstroOrSingle && !filterSettings.showAstro) return false;
            if (isSkeletonSwap(p.d) && !filterSettings.showWW) return false;
            if (!isAct && !filterSettings.showInactive) return false;
            return true;
        });
    }
    
    // Calculate 4Ep averages, efficiency, and access score for each pool
    bucketPools.forEach(p => {
        // Single-sided assets (ampCAPA, xASTRO) are still on Astroport
        // Use helper functions that handle all DEX name variants
        let dexName = isAstroport(p.d) ? 'Astroport' : 
                      isSkeletonSwap(p.d) ? 'Skeleton Swap' : null;
        if (!dexName) return;
        
        let lpKey = `${p.n}|${dexName}`;
        
        // Get 4-epoch averages - but PRESERVE existing data if already loaded from file
        if (!p.liq4Ep) {
            p.liq4Ep = get4EpochAverage(lpKey, 'liquidity');
        }
        if (!p.vol4Ep) {
            p.vol4Ep = get4EpochAverage(lpKey, 'volume');
        }
        
        // Calculate efficiency (vol/liq ratio)
        let liqAvg = p.liq4Ep?.avg || p.dp || 0;
        let volAvg = p.vol4Ep?.avg || p.vol || 0;
        p.efficiency = liqAvg > 0 ? (volAvg / liqAvg) : 0;
        
        // Get APR from liquidity data - but PRESERVE existing if already loaded
        if (!p.aprNon || p.aprNon === 0) {
            let aprData = getPoolApr(p.n, dexName);
            if (aprData.non > 0) p.aprNon = aprData.non;
            if (aprData.amp > 0) p.aprAmp = aprData.amp;
        }
        p.aprFactor = calculateAprFactor(p.aprNon);
        
        // Calculate Access Score
        p.accessData = calculatePoolAccessScore(p.n);
        p.accessScore = p.accessData.total;
    });
    
    // Rank within filtered pool set (for relative scoring)
    // This makes rankings relative to what's currently visible
    let withLiq = poolsForRanking.filter(p => (p.liq4Ep?.avg || p.dp) > 0);
    let withVol = poolsForRanking.filter(p => (p.vol4Ep?.avg || p.vol) > 0);
    let withEff = poolsForRanking.filter(p => p.efficiency > 0);
    let withInc = poolsForRanking.filter(p => p.inc > 0);
    let withVot = poolsForRanking.filter(p => (p.votNowPct || 0) > 0);
    let withTla = poolsForRanking.filter(p => p.vps > 0);
    
    // Sort and assign ranks (higher value = higher rank)
    withLiq.sort((a, b) => (b.liq4Ep?.avg || b.dp) - (a.liq4Ep?.avg || a.dp));
    withVol.sort((a, b) => (b.vol4Ep?.avg || b.vol) - (a.vol4Ep?.avg || a.vol));
    withEff.sort((a, b) => b.efficiency - a.efficiency);
    withInc.sort((a, b) => b.inc - a.inc);
    withVot.sort((a, b) => (b.votNowPct || 0) - (a.votNowPct || 0));
    withTla.sort((a, b) => b.vps - a.vps);
    
    // Assign percentile ranks (0-100)
    bucketPools.forEach(p => {
        p.liqRank = withLiq.length > 0 ? (1 - withLiq.indexOf(p) / withLiq.length) * 100 : 0;
        p.volRank = withVol.length > 0 ? (1 - withVol.indexOf(p) / withVol.length) * 100 : 0;
        p.effRank = withEff.length > 0 ? (1 - withEff.indexOf(p) / withEff.length) * 100 : 0;
        p.incRank = withInc.length > 0 ? (1 - withInc.indexOf(p) / withInc.length) * 100 : 0;
        p.votRank = withVot.length > 0 ? (1 - withVot.indexOf(p) / withVot.length) * 100 : 0;
        p.tlaRank = withTla.length > 0 ? (1 - withTla.indexOf(p) / withTla.length) * 100 : 0;
        
        // Fix -0 and pools not in list
        if (withLiq.indexOf(p) === -1) p.liqRank = 0;
        if (withVol.indexOf(p) === -1) p.volRank = 0;
        if (withEff.indexOf(p) === -1) p.effRank = 0;
        if (withInc.indexOf(p) === -1) p.incRank = 0;
        if (withVot.indexOf(p) === -1) p.votRank = 0;
        if (withTla.indexOf(p) === -1) p.tlaRank = 0;
    });
    
    // Calculate Performance Score (0-100)
    // 35% Efficiency, 25% Volume, 20% Liquidity, 15% Access, 5% History
    bucketPools.forEach(p => {
        p.performanceScore = 
            (p.effRank * 0.35) +
            (p.volRank * 0.25) +
            (p.liqRank * 0.20) +
            (p.accessScore * 0.15) + // Access score (now 15%)
            (0 * 0.05);  // History score placeholder (now 5%)
        
        // Calculate Support Score (0-100)
        // 40% Bribes, 30% TLA Vote, 30% Votion Dominance
        // Votion Dominance = what % of TLA votes come from Votion (high = dependent on Votion)
        let votionDominance = p.vps > 0 ? Math.min(100, (p.votNowPct / p.vps) * 100) : 0;
        p.votionDominance = votionDominance;
        
        p.supportScore = 
            (p.incRank * 0.40) +
            (p.tlaRank * 0.30) +
            (votionDominance * 0.30);  // High dominance = high support from Votion
        
        // Calculate aDAO Opportunity Score
        // Performance - Support + APR Factor
        p.adaoScore = p.performanceScore - p.supportScore + (p.aprFactor || 0);
        
        // Clamp to reasonable range
        p.adaoScore = Math.max(-100, Math.min(100, p.adaoScore));
    });
}

function calculateAllScores(filterSettings = null) {
    BUCKET_ORDER.forEach(bucket => {
        calculateScoresForBucket(bucket, filterSettings);
    });
}

// Recalculate scores after loading historical data from file
// Uses raw metrics already in pools but recalculates access/performance/adao scores using current metadata
function recalculateScoresFromLoadedData() {
    console.log('Recalculating scores from loaded data...');
    
    BUCKET_ORDER.forEach(bucketName => {
        let bucketPools = store.vote.pools.filter(p => p.b === bucketName);
        if (bucketPools.length === 0) return;
        
        // Step 1: Recalculate access score for each pool using current metadata
        bucketPools.forEach(p => {
            p.accessData = calculatePoolAccessScore(p.n);
            p.accessScore = p.accessData.total;
            
            // Recalculate efficiency from loaded 4ep data
            let liqAvg = p.liq4Ep?.avg || p.dp || 0;
            let volAvg = p.vol4Ep?.avg || p.vol || 0;
            if (liqAvg > 0) {
                p.efficiency = volAvg / liqAvg;
            }
            
            // Calculate APR factor
            if (p.aprNon > 0) {
                p.aprFactor = calculateAprFactor(p.aprNon);
            }
        });
        
        // Step 2: Rank within bucket (active pools only for ranking)
        let poolsForRanking = bucketPools.filter(p => p.vps >= 1);
        
        let withLiq = poolsForRanking.filter(p => (p.liq4Ep?.avg || p.dp) > 0);
        let withVol = poolsForRanking.filter(p => (p.vol4Ep?.avg || p.vol) > 0);
        let withEff = poolsForRanking.filter(p => p.efficiency > 0);
        let withInc = poolsForRanking.filter(p => p.inc > 0);
        let withVot = poolsForRanking.filter(p => (p.votNowPct || 0) > 0);
        let withTla = poolsForRanking.filter(p => p.vps > 0);
        
        // Sort by value (higher = better rank)
        withLiq.sort((a, b) => (b.liq4Ep?.avg || b.dp) - (a.liq4Ep?.avg || a.dp));
        withVol.sort((a, b) => (b.vol4Ep?.avg || b.vol) - (a.vol4Ep?.avg || a.vol));
        withEff.sort((a, b) => b.efficiency - a.efficiency);
        withInc.sort((a, b) => b.inc - a.inc);
        withVot.sort((a, b) => (b.votNowPct || 0) - (a.votNowPct || 0));
        withTla.sort((a, b) => b.vps - a.vps);
        
        // Assign percentile ranks
        bucketPools.forEach(p => {
            p.liqRank = withLiq.length > 0 && withLiq.indexOf(p) !== -1 ? (1 - withLiq.indexOf(p) / withLiq.length) * 100 : 0;
            p.volRank = withVol.length > 0 && withVol.indexOf(p) !== -1 ? (1 - withVol.indexOf(p) / withVol.length) * 100 : 0;
            p.effRank = withEff.length > 0 && withEff.indexOf(p) !== -1 ? (1 - withEff.indexOf(p) / withEff.length) * 100 : 0;
            p.incRank = withInc.length > 0 && withInc.indexOf(p) !== -1 ? (1 - withInc.indexOf(p) / withInc.length) * 100 : 0;
            p.votRank = withVot.length > 0 && withVot.indexOf(p) !== -1 ? (1 - withVot.indexOf(p) / withVot.length) * 100 : 0;
            p.tlaRank = withTla.length > 0 && withTla.indexOf(p) !== -1 ? (1 - withTla.indexOf(p) / withTla.length) * 100 : 0;
        });
        
        // Step 3: Calculate composite scores
        bucketPools.forEach(p => {
            // Performance Score: 35% Efficiency, 25% Volume, 20% Liquidity, 15% Access, 5% History
            p.performanceScore = 
                (p.effRank * 0.35) +
                (p.volRank * 0.25) +
                (p.liqRank * 0.20) +
                (p.accessScore * 0.15) +
                (0 * 0.05);  // History placeholder
            
            // Support Score: 40% Bribes, 30% TLA Vote, 30% Votion Dominance
            let votionDominance = p.vps > 0 ? Math.min(100, (p.votNowPct / p.vps) * 100) : 0;
            p.votionDominance = votionDominance;
            
            p.supportScore = 
                (p.incRank * 0.40) +
                (p.tlaRank * 0.30) +
                (votionDominance * 0.30);
            
            // aDAO Opportunity Score
            p.adaoScore = p.performanceScore - p.supportScore + (p.aprFactor || 0);
            p.adaoScore = Math.max(-100, Math.min(100, p.adaoScore));
        });
        
        console.log(`  ${bucketName}: ${bucketPools.length} pools recalculated`);
    });
    
    console.log('Score recalculation complete');
}

function getScoreColor(score) {
    if (score >= 50) return 'text-green-400';
    if (score >= 20) return 'text-yellow-400';
    if (score >= -20) return 'text-gray-400';
    if (score >= -50) return 'text-blue-400';
    return 'text-red-400';
}

function getScoreIcon(score) {
    if (score >= 50) return 'üü¢';
    if (score >= 20) return 'üü°';
    if (score >= -20) return '‚ö™';
    if (score >= -50) return 'üîµ';
    return 'üî¥';
}

function showScoreInfo(type) {
    let title = '', content = '';
    
    switch(type) {
        case '4ep-liq':
            title = '4-Epoch Average Liquidity';
            content = `
                <p class="mb-3">Average liquidity over the last 4 epochs (approximately 28 days), calculated from Astroport chart data captured via the Extensions tool.</p>
                <p class="mb-3"><strong>Why it matters:</strong> Shows the pool's sustained liquidity commitment, not just a point-in-time snapshot.</p>
                <p class="mb-3"><strong>Data source:</strong> tla_ext_combined.json from the Extensions tool staging process.</p>
                <p class="text-teal-400"><span class="text-[12px]">‚¨°</span> indicates data from ext tool (epoch averages)</p>
            `;
            break;
        case '4ep-vol':
            title = '4-Epoch Average Volume';
            content = `
                <p class="mb-3">Average trading volume over the last 4 epochs, showing consistent usage patterns.</p>
                <p class="mb-3"><strong>Why it matters:</strong> Volume indicates real utility - people are actually using this pool for trades. High volume = valuable to the chain.</p>
                <p class="mb-3"><strong>Weight in scoring:</strong> 25% of Performance Score (volume is a strong signal of LP value)</p>
            `;
            break;
        case 'efficiency':
            title = 'Capital Efficiency (Vol/Liq Ratio)';
            content = `
                <p class="mb-3">How hard the pool's liquidity is working. Calculated as: Average Volume √∑ Average Liquidity</p>
                <p class="mb-3"><strong>Example:</strong> A pool with $50K liquidity doing $20K/day volume (0.4 efficiency) is more valuable than one with $500K liquidity doing $5K/day (0.01 efficiency).</p>
                <p class="mb-3"><strong>Weight in scoring:</strong> 35% of Performance Score (the most important metric)</p>
                <p class="text-yellow-400">Higher efficiency = pool is working harder for the chain</p>
            `;
            break;
        case 'apr':
            title = 'Non-Amplified APR';
            content = `
                <p class="mb-3">The base APR before amplification multipliers. From liquidity paste data.</p>
                <p class="mb-3"><strong>TLA Target:</strong> 50% non-amplified APR</p>
                <p class="mb-3"><strong>APR Factor applied to score:</strong></p>
                <ul class="list-disc list-inside text-[11px] space-y-1 mb-3">
                    <li>&lt;40% ‚Üí +10 (needs help)</li>
                    <li>40-50% ‚Üí +5 (slightly under)</li>
                    <li>50-55% ‚Üí 0 (at target)</li>
                    <li>55-60% ‚Üí -5 (slightly over)</li>
                    <li>60-70% ‚Üí -15 (doing well)</li>
                    <li>70-80% ‚Üí -25 (very healthy)</li>
                    <li>&gt;80% ‚Üí -35 (thriving, shift focus)</li>
                </ul>
                <p class="text-green-400">This creates automatic rebalancing toward underperforming LPs</p>
            `;
            break;
        case 'access':
            title = 'Access Score (15% of Performance)';
            content = `
                <p class="mb-3">Measures how accessible and valuable this LP is based on asset metadata. Each asset is scored 0-100, then averaged for the pool.</p>
                
                <p class="mb-2 font-bold text-white">1. Origin Base Score (30-85 pts)</p>
                <div class="text-[10px] mb-3 pl-2 border-l border-gray-600">
                    <div>üè† <span class="text-green-400">Terra Native (85)</span>: LUNA, ROAR, CAPA, SOLID</div>
                    <div>üîí <span class="text-green-300">Terra LSD (80)</span>: ampLUNA, stLUNA, bLUNA</div>
                    <div>‚öõÔ∏è <span class="text-cyan-300">IBC (70)</span>: ATOM, ASTRO via IBC</div>
                    <div>üíµ <span class="text-blue-300">Stable Native (65)</span>: USDC.noble, USDT.kava</div>
                    <div>üåâ <span class="text-yellow-300">Bridge Eureka (50)</span>: .atom suffix</div>
                    <div>üîó <span class="text-orange-300">Bridge Axelar (45)</span>: .axl suffix</div>
                    <div>üì¶ <span class="text-red-300">Bridge Osmosis (40)</span>: .osmo suffix</div>
                    <div>‚ùì <span class="text-gray-500">Unknown (30)</span>: Not configured</div>
                </div>
                
                <p class="mb-2 font-bold text-white">2. Asset Class Bonus (+0 to +5)</p>
                <div class="text-[10px] mb-3 pl-2 border-l border-gray-600">
                    <div>üèÜ <span class="text-yellow-300">Bluechip (+5)</span>: BTC, ETH, PAXG</div>
                    <div>üíµ <span class="text-green-300">Stable (+5)</span>: USDC, USDT, EURe</div>
                    <div>‚öõÔ∏è <span class="text-purple-300">Core (+5)</span>: LUNA, ATOM</div>
                    <div>üîí <span class="text-cyan-300">LSD (+3)</span>: ampLUNA, stLUNA</div>
                    <div>üîß <span class="text-gray-300">DeFi/Native (0)</span>: Protocol tokens</div>
                </div>
                
                <p class="mb-2 font-bold text-white">3. CoinGecko Status (-15 to +15)</p>
                <div class="text-[10px] mb-3 pl-2 border-l border-gray-600">
                    <div>‚úÖ <span class="text-green-400">Listed on Terra (+15)</span>: Best visibility</div>
                    <div>‚úì <span class="text-blue-300">Listed Other Chain (+5)</span>: Has CG presence</div>
                    <div>‚ùå <span class="text-red-400">Not Listed (-15)</span>: Hard to find info</div>
                </div>
                
                <p class="mb-2 font-bold text-white">4. Other Factors</p>
                <div class="text-[10px] mb-3 pl-2 border-l border-gray-600">
                    <div>üìõ <span class="text-green-400">Naming Accurate (+10)</span> / <span class="text-red-400">Mismatch (-10)</span></div>
                    <div>üß≠ <span class="text-green-400">Skip.go Clear (+5)</span> / <span class="text-red-400">Confusing (-5)</span></div>
                    <div>üîÑ <span class="text-blue-300">Multi-DEX Available (+5)</span></div>
                    <div>üí∞ <span class="text-yellow-300">Treasury Value High (+5)</span> / <span class="text-gray-400">Low (-5)</span></div>
                </div>
                
                <p class="mb-2 font-bold text-white">5. LUNA Pair Bonus (+2 to +5)</p>
                <div class="text-[10px] mb-3 pl-2 border-l border-gray-600">
                    <div><span class="text-green-400">LUNA + Stable/Bluechip (+5)</span></div>
                    <div><span class="text-cyan-300">LUNA + LSD (+3)</span></div>
                    <div><span class="text-gray-300">Other LUNA pair (+2)</span></div>
                </div>
                
                <div class="bg-emerald-900/30 border border-emerald-700 p-2 rounded mt-3">
                    <p class="text-emerald-400 text-[10px]"><strong>Click on any pool row</strong> to see detailed breakdown with specific issues that hurt the score and what could be fixed!</p>
                </div>
            `;
            break;
        case 'support':
            title = 'Support Score';
            content = `
                <p class="mb-3">How much attention this LP is already getting from other sources.</p>
                <p class="mb-3"><strong>Components (0-100):</strong></p>
                <ul class="list-disc list-inside text-[11px] space-y-1 mb-3">
                    <li>40% - PD Bribes rank (incentives from eris/PD)</li>
                    <li>30% - Votion % rank (automated VP direction)</li>
                    <li>30% - TLA Vote % rank (current vote share)</li>
                </ul>
                <p class="mb-3"><strong>Higher support = already getting attention</strong></p>
                <p class="text-orange-300">aDAO looks for LPs with LOW support scores relative to their performance</p>
            `;
            break;
        case 'adao-score':
            title = 'aDAO Opportunity Score';
            content = `
                <p class="mb-3 text-lg font-bold text-emerald-300">The Bottom Line: Should aDAO support this LP?</p>
                
                <div class="bg-gray-800/50 p-3 rounded mb-3">
                    <p class="text-[11px] text-gray-300 italic mb-2">"aDAO acts as a balance of power in TLA governance. We use data-driven analysis to support high-performing LPs that aren't getting attention from PD bribes or Votion, and help promising projects grow."</p>
                </div>
                
                <p class="mb-2 font-bold text-white">Formula:</p>
                <div class="font-mono text-[11px] bg-gray-900 p-2 rounded mb-3">
                    aDAO Score = Performance - Support + APR Factor
                </div>
                
                <p class="mb-2 font-bold text-white">Performance Score (0-100):</p>
                <div class="text-[10px] mb-3 pl-2 border-l border-gray-600">
                    <div>35% - Efficiency (Vol/Liq ratio) - Is capital working hard?</div>
                    <div>25% - Volume rank - Are people actually using it?</div>
                    <div>20% - Liquidity rank - Is there commitment?</div>
                    <div>15% - Access Score - Asset quality, bridge safety, LUNA benefit</div>
                    <div>5% - History Score - Stability over time (TBD)</div>
                </div>
                
                <p class="mb-2 font-bold text-white">Support Score (0-100):</p>
                <div class="text-[10px] mb-3 pl-2 border-l border-gray-600">
                    <div>40% - PD Bribes rank - Eris/PD attention</div>
                    <div>30% - Votion % rank - Automated VP direction</div>
                    <div>30% - TLA Vote % rank - Current vote share</div>
                </div>
                
                <p class="mb-2 font-bold text-white">APR Factor (Target: 50%):</p>
                <div class="text-[10px] mb-3 pl-2 border-l border-gray-600">
                    <div>LPs under 50% APR get a boost (needs help)</div>
                    <div>LPs over 50% APR get a penalty (shift focus elsewhere)</div>
                    <div>Creates automatic rebalancing toward underperformers</div>
                </div>
                
                <p class="mb-2 font-bold text-white">Score Interpretation:</p>
                <div class="space-y-1 text-[11px] mb-3">
                    <div>üü¢ <span class="text-green-400">+50 to +100</span> - High priority: Strong performer, underserved</div>
                    <div>üü° <span class="text-yellow-400">+20 to +50</span> - Opportunity: Worth considering</div>
                    <div>‚ö™ <span class="text-gray-400">-20 to +20</span> - Balanced: Getting fair support</div>
                    <div>üîµ <span class="text-blue-400">-50 to -20</span> - Over-supported: Already has attention</div>
                    <div>üî¥ <span class="text-red-400">Below -50</span> - Over-hyped: Getting way more than deserved</div>
                </div>
                
                <div class="bg-emerald-900/30 border border-emerald-700 p-2 rounded">
                    <p class="text-emerald-400 text-[11px]"><strong>Our Mission:</strong> Be the thoughtful voice that supports native Terra projects, rewards efficient LPs, and ensures fair distribution of TLA votes across the ecosystem. üè†</p>
                </div>
            `;
            break;
    }
    
    // Create modal
    let modal = document.createElement('div');
    modal.className = 'modal-overlay open';
    modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
    modal.innerHTML = `
        <div class="modal-box max-w-lg">
            <div class="flex justify-between items-center mb-4 border-b border-gray-700 pb-2">
                <h3 class="text-lg font-bold text-white">${title}</h3>
                <button onclick="this.closest('.modal-overlay').remove()" class="text-gray-500 hover:text-white text-xl">&times;</button>
            </div>
            <div class="text-sm text-gray-300">${content}</div>
        </div>
    `;
    document.body.appendChild(modal);
}

function showPoolScoreDetails(poolName, dex) {
    // Match pool using helper functions for DEX comparison
    let p = store.vote.pools.find(pool => {
        if (pool.n !== poolName) return false;
        if (isSkeletonSwap(dex) && isSkeletonSwap(pool.d)) return true;
        if (isAstroport(dex) && isAstroport(pool.d)) return true;
        if (dex === 'Single' && pool.d.includes('Single')) return true;
        return false;
    });
    if (!p) return;
    
    let liq4EpStr = p.liq4Ep ? `$${(p.liq4Ep.avg/1000).toFixed(1)}K (${p.liq4Ep.count} epochs)` : 'N/A';
    let vol4EpStr = p.vol4Ep ? `$${(p.vol4Ep.avg/1000).toFixed(1)}K (${p.vol4Ep.count} epochs)` : 'N/A';
    
    // Access score breakdown
    let accessHtml = '';
    if (p.accessData && p.accessData.breakdown) {
        let b = p.accessData.breakdown;
        
        if (p.accessData.source === 'metadata') {
            // Detailed metadata-based scoring
            let a1 = b.asset1;
            let a2 = b.asset2;
            
            accessHtml = `
                <div class="space-y-2 text-[10px]">
                    <!-- Asset 1 -->
                    <div class="bg-gray-900/50 p-1.5 rounded">
                        <div class="flex justify-between font-bold">
                            <span class="text-white">${a1.name}</span>
                            <span class="text-cyan-400">${a1.score}/100</span>
                        </div>
                        <div class="text-[9px] text-gray-400">${a1.origin || 'unknown'} ‚Ä¢ ${a1.assetClass || 'unknown'}</div>
                    </div>
                    
                    <!-- Asset 2 -->
                    <div class="bg-gray-900/50 p-1.5 rounded">
                        <div class="flex justify-between font-bold">
                            <span class="text-white">${a2.name}</span>
                            <span class="text-cyan-400">${a2.score}/100</span>
                        </div>
                        <div class="text-[9px] text-gray-400">${a2.origin || 'unknown'} ‚Ä¢ ${a2.assetClass || 'unknown'}</div>
                    </div>
                    
                    <!-- Average and LUNA Benefit -->
                    <div class="flex justify-between border-t border-gray-700 pt-1">
                        <span class="text-gray-500">Asset Avg:</span>
                        <span class="text-yellow-300">${b.assetAvg.toFixed(0)}/100</span>
                    </div>
                    ${b.lunaBenefit && b.lunaBenefit.points > 0 ? `
                    <div class="flex justify-between">
                        <span class="text-gray-500">LUNA Benefit:</span>
                        <span class="text-green-300">${b.lunaBenefit.label}</span>
                    </div>` : ''}
                    
                    <!-- Issues Section -->
                    ${b.allIssues && b.allIssues.length > 0 ? `
                    <div class="mt-2 pt-1 border-t border-red-900/50">
                        <div class="text-red-400 font-bold text-[9px] mb-1">Issues:</div>
                        ${b.allIssues.map(i => `<div class="text-[9px] text-red-300/80">${i}</div>`).join('')}
                    </div>` : ''}
                    
                    <!-- Notes Section -->
                    ${b.allNotes && b.allNotes.length > 0 ? `
                    <div class="mt-1 pt-1 border-t border-yellow-900/50">
                        <div class="text-yellow-400 font-bold text-[9px] mb-1">Notes:</div>
                        ${b.allNotes.map(n => `<div class="text-[9px] text-yellow-300/80">${n}</div>`).join('')}
                    </div>` : ''}
                    
                    <!-- Positives Section (collapsed) -->
                    ${b.allPositives && b.allPositives.length > 0 ? `
                    <div class="mt-1 pt-1 border-t border-green-900/50">
                        <div class="text-green-400 font-bold text-[9px] mb-1">Positives:</div>
                        ${b.allPositives.slice(0, 3).map(p => `<div class="text-[9px] text-green-300/80">${p}</div>`).join('')}
                        ${b.allPositives.length > 3 ? `<div class="text-[9px] text-gray-500">+${b.allPositives.length - 3} more...</div>` : ''}
                    </div>` : ''}
                </div>
            `;
        } else {
            // Fallback when no metadata
            accessHtml = `
                <div class="space-y-1 text-[10px]">
                    <div class="flex justify-between"><span class="text-gray-500">${b.asset1?.name || 'Asset 1'}:</span><span class="text-white">${b.asset1?.score || '?'}/100</span></div>
                    <div class="flex justify-between"><span class="text-gray-500">${b.asset2?.name || 'Asset 2'}:</span><span class="text-white">${b.asset2?.score || '?'}/100</span></div>
                    <div class="flex justify-between"><span class="text-gray-500">Asset Avg:</span><span class="text-yellow-300">${b.assetAvg?.toFixed(0) || '?'}/100</span></div>
                    <div class="mt-2 pt-1 border-t border-yellow-900/50">
                        <div class="text-yellow-400 text-[9px]">‚ö†Ô∏è No metadata configured for one or both assets</div>
                        <div class="text-gray-500 text-[9px]">Using fallback scoring - configure metadata in Asset Metadata Manager for accurate scores</div>
                    </div>
                </div>
            `;
        }
    }
    
    let modal = document.createElement('div');
    modal.className = 'modal-overlay open';
    modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
    modal.innerHTML = `
        <div class="modal-box max-w-3xl">
            <div class="flex justify-between items-center mb-4 border-b border-gray-700 pb-2">
                <h3 class="text-lg font-bold text-white">${poolName} <span class="text-sm text-gray-500">(${p.d})</span></h3>
                <button onclick="this.closest('.modal-overlay').remove()" class="text-gray-500 hover:text-white text-xl">&times;</button>
            </div>
            
            <div class="grid grid-cols-3 gap-3 text-sm">
                <div class="bg-gray-800/50 p-3 rounded">
                    <h4 class="text-teal-400 font-bold mb-2 border-b border-gray-700 pb-1">Performance Metrics</h4>
                    <div class="space-y-1 text-[10px]">
                        <div class="flex justify-between"><span class="text-gray-500">4Ep Avg Liquidity:</span><span class="text-teal-300">${liq4EpStr}</span></div>
                        <div class="flex justify-between"><span class="text-gray-500">4Ep Avg Volume:</span><span class="text-teal-300">${vol4EpStr}</span></div>
                        <div class="flex justify-between"><span class="text-gray-500">Efficiency (Vol/Liq):</span><span class="text-yellow-400">${p.efficiency?.toFixed(3) || 'N/A'}</span></div>
                        <div class="flex justify-between"><span class="text-gray-500">Non-Amp APR:</span><span class="text-green-400">${p.aprNon ? p.aprNon.toFixed(1) + '%' : 'N/A'}</span></div>
                        <div class="flex justify-between"><span class="text-gray-500">Amplified APR:</span><span class="text-yellow-400">${p.aprAmp ? 'üî•' + p.aprAmp.toFixed(1) + '%' : 'N/A'}</span></div>
                    </div>
                    <div class="mt-2 pt-2 border-t border-gray-700 text-[10px]">
                        <div class="flex justify-between"><span class="text-gray-500">Efficiency Rank:</span><span>${p.effRank?.toFixed(0) || 0}% (√ó0.35)</span></div>
                        <div class="flex justify-between"><span class="text-gray-500">Volume Rank:</span><span>${p.volRank?.toFixed(0) || 0}% (√ó0.25)</span></div>
                        <div class="flex justify-between"><span class="text-gray-500">Liquidity Rank:</span><span>${p.liqRank?.toFixed(0) || 0}% (√ó0.20)</span></div>
                        <div class="flex justify-between"><span class="text-gray-500">Access Score:</span><span>${p.accessScore?.toFixed(0) || 0}% (√ó0.15)</span></div>
                        <div class="flex justify-between"><span class="text-gray-500">History Score:</span><span class="text-gray-600">TBD (√ó0.05)</span></div>
                    </div>
                    <div class="mt-2 pt-2 border-t border-gray-700 font-bold text-[11px]">
                        <div class="flex justify-between"><span>Performance:</span><span class="text-white">${p.performanceScore?.toFixed(1) || 0}</span></div>
                    </div>
                </div>
                
                <div class="bg-gray-800/50 p-3 rounded">
                    <h4 class="text-orange-300 font-bold mb-2 border-b border-gray-700 pb-1">Support Metrics</h4>
                    <div class="space-y-1 text-[10px]">
                        <div class="flex justify-between"><span class="text-gray-500">PD Bribes:</span><span class="text-green-400">${fmt$(p.incPD)}</span></div>
                        ${p.incOther > 0 ? `<div class="flex justify-between"><span class="text-gray-500">Other Bribes:</span><span class="text-yellow-400">${fmt$(p.incOther)}</span></div>` : ''}
                        ${p.incTotal > p.incPD ? `<div class="flex justify-between"><span class="text-gray-500">Total Bribes:</span><span class="text-white">${fmt$(p.incTotal)}</span></div>` : ''}
                        <div class="flex justify-between"><span class="text-gray-500">Votion Now:</span><span class="text-purple-400">${p.votNowPct?.toFixed(2) || 0}%</span></div>
                        <div class="flex justify-between"><span class="text-gray-500">Votion Next:</span><span class="text-purple-300">${p.votNextPct?.toFixed(2) || 0}%</span></div>
                        <div class="flex justify-between"><span class="text-gray-500">Votion Dominance:</span><span class="${(p.votionDominance || 0) > 50 ? 'text-red-400' : 'text-gray-300'}">${p.votionDominance?.toFixed(0) || 0}%</span></div>
                        <div class="flex justify-between"><span class="text-gray-500">TLA Vote %:</span><span class="text-orange-400">${p.vps?.toFixed(2) || 0}%</span></div>
                    </div>
                    <div class="mt-2 pt-2 border-t border-gray-700 text-[10px]">
                        <div class="flex justify-between"><span class="text-gray-500">Bribes Rank:</span><span>${p.incRank?.toFixed(0) || 0}% (√ó0.40)</span></div>
                        <div class="flex justify-between"><span class="text-gray-500">TLA Rank:</span><span>${p.tlaRank?.toFixed(0) || 0}% (√ó0.30)</span></div>
                        <div class="flex justify-between"><span class="text-gray-500">Votion Dominance:</span><span>${p.votionDominance?.toFixed(0) || 0}% (√ó0.30)</span></div>
                    </div>
                    <div class="mt-2 pt-2 border-t border-gray-700 font-bold text-[11px]">
                        <div class="flex justify-between"><span>Support:</span><span class="text-white">${p.supportScore?.toFixed(1) || 0}</span></div>
                    </div>
                </div>
                
                <div class="bg-gray-800/50 p-3 rounded">
                    <h4 class="text-cyan-400 font-bold mb-2 border-b border-gray-700 pb-1">Access Score Breakdown</h4>
                    ${accessHtml || '<div class="text-gray-500 text-[10px]">No data</div>'}
                    <div class="mt-2 pt-2 border-t border-gray-700 font-bold text-[11px]">
                        <div class="flex justify-between"><span>Access:</span><span class="text-white">${p.accessScore?.toFixed(0) || 0}/100</span></div>
                    </div>
                </div>
            </div>
            
            <div class="mt-4 bg-emerald-900/30 border border-emerald-800 p-3 rounded">
                <h4 class="text-emerald-400 font-bold mb-2">aDAO Opportunity Calculation</h4>
                <div class="grid grid-cols-2 gap-4">
                    <div class="text-[11px] font-mono space-y-1">
                        <div>Performance Score: <span class="text-white">${p.performanceScore?.toFixed(1) || 0}</span></div>
                        <div>- Support Score: <span class="text-white">${p.supportScore?.toFixed(1) || 0}</span></div>
                        <div>+ APR Factor: <span class="${p.aprFactor >= 0 ? 'text-green-400' : 'text-red-400'}">${p.aprFactor >= 0 ? '+' : ''}${p.aprFactor || 0}</span> <span class="text-gray-500">(APR: ${p.aprNon?.toFixed(1) || '?'}%)</span></div>
                        <div class="border-t border-emerald-800 pt-1 mt-1 text-lg">
                            = <span class="${getScoreColor(p.adaoScore)} font-bold">${getScoreIcon(p.adaoScore)} ${p.adaoScore?.toFixed(1) || 0}</span>
                        </div>
                    </div>
                    <div class="text-[10px] text-gray-400">
                        <div class="font-bold text-white mb-1">Score Interpretation:</div>
                        <div>üü¢ +50 to +100: High priority</div>
                        <div>üü° +20 to +50: Opportunity</div>
                        <div>‚ö™ -20 to +20: Balanced</div>
                        <div>üîµ -50 to -20: Over-supported</div>
                        <div>üî¥ Below -50: Over-hyped</div>
                    </div>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

// ============ METADATA MANAGER ============

let assetMetadata = {};
const METADATA_GITHUB_URL = 'https://raw.githubusercontent.com/defipatriot/tla_json_storage/main/tla_metadata.json';

// Origin types - how does asset get to Terra?
const ORIGIN_TYPES = {
    terra_native:    { label: 'üè† Terra Native', color: 'text-green-400', baseScore: 80 },
    terra_lsd:       { label: 'üîÑ Terra LSD', color: 'text-cyan-400', baseScore: 85 },
    ibc:             { label: '‚öõÔ∏è IBC', color: 'text-purple-400', baseScore: 70 },
    bridge_eureka:   { label: 'üåâ Eureka', color: 'text-yellow-400', baseScore: 55 },
    bridge_axelar:   { label: 'üî∂ Axelar', color: 'text-orange-400', baseScore: 50 },
    bridge_osmosis:  { label: 'üü† Osmosis', color: 'text-orange-300', baseScore: 50 },
    stable_native:   { label: 'üíµ Stable', color: 'text-blue-400', baseScore: 65 },
    unknown:         { label: '‚ùì Unknown', color: 'text-gray-500', baseScore: 30 }
};

// Asset classes
const ASSET_CLASSES = {
    stable:    { label: 'Stable', desc: 'USDC, USDT, EURe', color: 'text-green-300', bonus: 5 },
    bluechip:  { label: 'Bluechip', desc: 'BTC, ETH, PAXG', color: 'text-yellow-300', bonus: 5 },
    lsd:       { label: 'LSD', desc: 'Liquid staking', color: 'text-cyan-300', bonus: 5 },
    core:      { label: 'Core', desc: 'LUNA, ATOM', color: 'text-purple-300', bonus: 0 },
    native:    { label: 'Native', desc: 'Terra ecosystem', color: 'text-orange-300', bonus: 0 },
    defi:      { label: 'DeFi', desc: 'Protocol tokens', color: 'text-blue-300', bonus: 0 },
    unknown:   { label: 'Unknown', desc: 'Not classified', color: 'text-gray-500', bonus: 0 }
};

// CoinGecko status
const CG_STATUS = {
    cg_terra:  { label: '‚úì Terra', color: 'text-green-400', score: 15 },
    cg_chain:  { label: '‚óã Chain', color: 'text-yellow-400', score: 5 },
    cg_none:   { label: '‚úó None', color: 'text-red-400', score: -15 }
};

// Acquisition difficulty
const ACQUISITION = {
    easy:   { label: '‚úì Easy', color: 'text-green-400', desc: 'Simple IBC or already on Terra' },
    medium: { label: '‚óê Medium', color: 'text-yellow-400', desc: 'Bridge with clear path' },
    hard:   { label: '‚úó Hard', color: 'text-red-400', desc: 'Multiple steps, confusing options' }
};

// Treasury value
const TREASURY_VALUE = {
    high:   { label: 'üèÜ High', color: 'text-yellow-400', score: 5, desc: 'BTC, ETH, stables - chain wants these' },
    medium: { label: 'üëç Medium', color: 'text-blue-400', score: 0, desc: 'Useful assets' },
    low:    { label: 'üëé Low', color: 'text-gray-400', score: -5, desc: 'Protocol/ecosystem tokens' }
};

function toggleMetadataPanel() {
    let panel = $('metadata-panel');
    let toggle = $('meta-toggle');
    if (panel.classList.contains('hidden')) {
        panel.classList.remove('hidden');
        toggle.innerText = '‚ñ≤';
    } else {
        panel.classList.add('hidden');
        toggle.innerText = '‚ñº';
    }
}

function extractAssetsFromPools() {
    let assets = new Set();
    store.vote.pools.forEach(p => {
        p.n.split('-').forEach(a => { if (a && a.length > 0) assets.add(a.trim()); });
    });
    store.tla.pools.forEach(p => {
        (p.normName || p.name).split('-').forEach(a => { if (a && a.length > 0) assets.add(a.trim()); });
    });
    assets.forEach(asset => {
        if (!assetMetadata[asset]) assetMetadata[asset] = createDefaultAssetMeta(asset);
    });
    renderMetaAssetList();
    updateMetaStatus();
    alert(`Extracted ${assets.size} unique assets from parsed pools`);
}

function createDefaultAssetMeta(asset) {
    return {
        tla_name: asset,
        actual_path: '',  // Blank - user must fill in
        origin: 'unknown',
        acquisition: 'hard',
        acquisition_note: '',
        cg_status: 'cg_none',  // Default to worst case
        skip_clear: false,
        asset_class: 'unknown',
        treasury_value: 'low',
        multi_dex: false,
        notes: ''
    };
}

// Naming accurate is ALWAYS calculated, not stored
function isNamingAccurate(meta) {
    if (!meta.actual_path || meta.actual_path === '') return false;
    return meta.tla_name === meta.actual_path;
}

function detectOrigin(asset) {
    let base = asset.replace(/\.(atom|axl|osmo|wh)$/i, '').toUpperCase();
    if (asset.match(/\.atom$/i)) return 'bridge_eureka';
    if (asset.match(/\.axl$/i)) return 'bridge_axelar';
    if (asset.match(/\.osmo$/i)) return 'bridge_osmosis';
    if (['AMPLUNA', 'ARBLUNA', 'BLUNA', 'STLUNA', 'BONELUNA', 'AMPROAR', 'AMPCAPA'].includes(base)) return 'terra_lsd';
    if (['ROAR', 'CAPA', 'SOLID', 'FUEL', 'SWTH'].includes(base)) return 'terra_native';
    if (['USDC', 'USDT', 'EURE'].includes(base)) return 'stable_native';
    if (['ATOM', 'INJ', 'ASTRO', 'XASTRO', 'STATOM', 'LUNA'].includes(base)) return 'ibc';
    if (['BTC', 'WBTC', 'ETH', 'WETH', 'PAXG'].includes(base)) return 'bridge_eureka';
    return 'unknown';
}

function detectAssetClass(asset) {
    let base = asset.replace(/\.(atom|axl|osmo|wh)$/i, '').toUpperCase();
    if (['BTC', 'WBTC', 'ETH', 'WETH', 'PAXG'].includes(base)) return 'bluechip';
    if (['USDC', 'USDT', 'EURE', 'DAI', 'SOLID'].includes(base)) return 'stable';
    if (['LUNA', 'ATOM'].includes(base)) return 'core';
    if (['ROAR', 'CAPA', 'FUEL', 'SWTH'].includes(base)) return 'native';
    if (['AMPLUNA', 'ARBLUNA', 'BLUNA', 'STLUNA', 'BONELUNA', 'STATOM', 'AMPROAR', 'AMPCAPA', 'XASTRO'].includes(base)) return 'lsd';
    if (['ASTRO', 'INJ'].includes(base)) return 'defi';
    return 'unknown';
}

function detectActualPath(asset) {
    if (asset.match(/\.(atom|axl|osmo|wh|noble)$/i)) return asset;
    let base = asset.toUpperCase();
    if (['USDC', 'USDT'].includes(base)) return asset + '.noble';
    if (['PAXG'].includes(base)) return asset + '.atom';
    if (['WSTETH', 'WETH', 'WBNB'].includes(base)) return asset + '.axl';
    return asset;
}

function detectNamingAccurate(asset) {
    return asset === detectActualPath(asset);
}

function detectAcquisition(origin) {
    if (['terra_native', 'terra_lsd', 'ibc'].includes(origin)) return 'easy';
    if (['bridge_eureka', 'bridge_axelar', 'bridge_osmosis'].includes(origin)) return 'medium';
    if (origin === 'stable_native') return 'hard';
    return 'hard';
}

function detectTreasuryValue(assetClass) {
    if (['bluechip', 'stable', 'core'].includes(assetClass)) return 'high';
    if (['lsd'].includes(assetClass)) return 'medium';
    return 'low';
}

function calculateAccessScore(meta) {
    let origin = ORIGIN_TYPES[meta.origin] || ORIGIN_TYPES.unknown;
    let assetClass = ASSET_CLASSES[meta.asset_class] || ASSET_CLASSES.unknown;
    let cg = CG_STATUS[meta.cg_status] || CG_STATUS.cg_none;
    let treasury = TREASURY_VALUE[meta.treasury_value] || TREASURY_VALUE.medium;
    let score = origin.baseScore + assetClass.bonus + cg.score + treasury.score;
    
    // Naming accurate is calculated, not stored
    if (isNamingAccurate(meta)) score += 10; else score -= 10;
    
    if (meta.skip_clear) score += 5; else score -= 5;
    if (meta.multi_dex) score += 5;
    return Math.max(0, Math.min(100, score));
}

function renderMetaAssetList() {
    let container = $('meta-asset-list');
    if (!container) return;
    let search = $('meta-search')?.value?.toLowerCase() || '';
    let assets = Object.keys(assetMetadata).sort();
    if (search) assets = assets.filter(a => a.toLowerCase().includes(search));
    if (assets.length === 0) {
        container.innerHTML = '<div class="text-center text-gray-600 italic text-xs py-4">No assets found</div>';
        return;
    }
    let html = '';
    assets.forEach(asset => {
        let meta = assetMetadata[asset];
        let score = calculateAccessScore(meta);
        let namingOk = isNamingAccurate(meta);
        let scoreColor = score >= 80 ? 'text-green-400' : score >= 60 ? 'text-yellow-400' : 'text-red-400';
        let namingColor = namingOk ? 'text-green-400' : 'text-red-400';
        let namingIcon = namingOk ? '‚úì' : '‚úó';
        let skipColor = meta.skip_clear ? 'text-green-400' : 'text-red-400';
        let skipIcon = meta.skip_clear ? '‚úì' : '‚úó';
        let treasuryInfo = TREASURY_VALUE[meta.treasury_value] || TREASURY_VALUE.medium;
        let cgInfo = CG_STATUS[meta.cg_status] || CG_STATUS.cg_none;
        let needsSetup = !meta.actual_path || meta.origin === 'unknown' || meta.asset_class === 'unknown';
        html += `
        <div class="grid grid-cols-12 gap-1 items-center px-2 py-1 hover:bg-gray-800/50 rounded text-[8px] ${needsSetup ? 'bg-yellow-900/20' : !namingOk ? 'bg-red-900/10' : ''}">
            <div class="col-span-2">
                <div class="font-mono text-white font-bold">${needsSetup ? '‚ö†Ô∏è ' : ''}${asset}</div>
                ${meta.actual_path && !namingOk ? '<div class="text-[7px] text-gray-500">‚Üí ' + meta.actual_path + '</div>' : ''}
                ${!meta.actual_path ? '<div class="text-[7px] text-yellow-500 italic">needs setup</div>' : ''}
            </div>
            <div class="col-span-1 text-center ${namingColor}" title="${namingOk ? 'Name matches' : meta.actual_path ? 'Should be: ' + meta.actual_path : 'Path not set'}">${namingIcon}</div>
            <div class="col-span-1 text-center ${cgInfo.color}" title="CoinGecko: ${cgInfo.label}">${cgInfo.label.charAt(0)}</div>
            <div class="col-span-1 text-center ${skipColor}" title="Skip.go ${meta.skip_clear ? 'clear' : 'confusing'}">${skipIcon}</div>
            <div class="col-span-1 text-center" title="Multi-DEX">
                <input type="checkbox" ${meta.multi_dex ? 'checked' : ''} 
                    onchange="toggleMetaField('${asset}', 'multi_dex', this.checked); renderMetaAssetList();"
                    class="w-3 h-3 accent-purple-500">
            </div>
            <div class="col-span-2 text-center text-[7px] ${treasuryInfo.color}">${treasuryInfo.label}</div>
            <div class="col-span-1 text-center font-bold ${scoreColor}">${score}</div>
            <div class="col-span-2 text-center">
                <button onclick="editAssetDetails('${asset}')" class="text-blue-400 hover:text-white">‚úèÔ∏è</button>
                <button onclick="deleteAsset('${asset}')" class="text-red-400 hover:text-white ml-1">üóëÔ∏è</button>
            </div>
        </div>`;
    });
    container.innerHTML = html;
}

function filterMetaAssets() { renderMetaAssetList(); }
function toggleMetaField(asset, field, value) { if (assetMetadata[asset]) assetMetadata[asset][field] = value; }
function updateMetaField(asset, field, value) { if (assetMetadata[asset]) { assetMetadata[asset][field] = value; renderMetaAssetList(); } }
function deleteAsset(asset) { if (confirm('Delete ' + asset + '?')) { delete assetMetadata[asset]; renderMetaAssetList(); updateMetaStatus(); } }
function addNewAsset() {
    let asset = prompt('Enter asset symbol (e.g., LUNA, wBTC.axl):');
    if (!asset) return;
    asset = asset.trim();
    if (assetMetadata[asset]) { alert('Asset already exists!'); return; }
    assetMetadata[asset] = createDefaultAssetMeta(asset);
    renderMetaAssetList();
    updateMetaStatus();
}

function editAssetDetails(asset) {
    let meta = assetMetadata[asset];
    if (!meta) return;
    let score = calculateAccessScore(meta);
    let namingOk = isNamingAccurate(meta);
    let modal = document.createElement('div');
    modal.className = 'modal-overlay open';
    modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
    modal.innerHTML = `
        <div class="modal-box max-w-xl">
            <div class="flex justify-between items-center mb-4 border-b border-gray-700 pb-2">
                <h3 class="text-lg font-bold text-white">Edit: ${asset}</h3>
                <button onclick="this.closest('.modal-overlay').remove()" class="text-gray-500 hover:text-white text-xl">&times;</button>
            </div>
            <div class="grid grid-cols-3 gap-4 mb-4">
                <div class="bg-gray-900 p-3 rounded border border-gray-800 text-center">
                    <div class="text-gray-500 text-[10px]">Access Score</div>
                    <div id="edit-score-display" class="text-2xl font-bold ${score >= 80 ? 'text-green-400' : score >= 60 ? 'text-yellow-400' : 'text-red-400'}">${score}</div>
                </div>
                <div class="bg-gray-900 p-3 rounded border border-gray-800 text-center">
                    <div class="text-gray-500 text-[10px]">TLA Name</div>
                    <div class="text-lg font-mono text-white">${meta.tla_name}</div>
                </div>
                <div class="bg-gray-900 p-3 rounded border border-gray-800 text-center">
                    <div class="text-gray-500 text-[10px]">Naming Status</div>
                    <div id="edit-naming-status" class="text-lg font-bold ${namingOk ? 'text-green-400' : 'text-red-400'}">${namingOk ? '‚úì Match' : '‚úó Mismatch'}</div>
                </div>
            </div>
            <div class="bg-gray-900/50 p-3 rounded border border-gray-700 mb-3">
                <h4 class="text-xs font-bold text-white mb-2">üè∑Ô∏è Identity</h4>
                <div>
                    <label class="block text-gray-400 text-[10px] mb-1">Actual Path (what it really is - leave same as TLA if accurate)</label>
                    <input type="text" id="edit-actual-path" value="${meta.actual_path || ''}" 
                        placeholder="e.g., USDC.noble, wBTC.atom, or same as TLA name if accurate"
                        oninput="updateNamingStatus('${asset}')"
                        class="w-full bg-gray-800 border border-gray-700 rounded px-2 py-1 text-sm font-mono">
                    <div class="text-[9px] text-gray-500 mt-1">
                        If TLA shows "USDC" but it's really "USDC.noble", enter "USDC.noble" here.
                        If TLA shows "wBTC.atom" and that's accurate, enter "wBTC.atom".
                    </div>
                </div>
            </div>
            <div class="bg-gray-900/50 p-3 rounded border border-gray-700 mb-3">
                <h4 class="text-xs font-bold text-white mb-2">üõí Acquisition</h4>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-gray-400 text-[10px] mb-1">Origin</label>
                        <select id="edit-origin" class="w-full bg-gray-800 border border-gray-700 rounded px-2 py-1 text-sm">
                            ${Object.entries(ORIGIN_TYPES).map(([k, v]) => '<option value="' + k + '" ' + (meta.origin === k ? 'selected' : '') + '>' + v.label + ' (' + v.baseScore + ')</option>').join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-400 text-[10px] mb-1">Difficulty</label>
                        <select id="edit-acquisition" class="w-full bg-gray-800 border border-gray-700 rounded px-2 py-1 text-sm">
                            ${Object.entries(ACQUISITION).map(([k, v]) => '<option value="' + k + '" ' + (meta.acquisition === k ? 'selected' : '') + '>' + v.label + ' - ' + v.desc + '</option>').join('')}
                        </select>
                    </div>
                </div>
                <div class="mt-2">
                    <input type="text" id="edit-acquisition-note" value="${meta.acquisition_note || ''}" placeholder="Acquisition notes (e.g., Must select Noble, route to Terra)" class="w-full bg-gray-800 border border-gray-700 rounded px-2 py-1 text-xs">
                </div>
            </div>
            <div class="bg-gray-900/50 p-3 rounded border border-gray-700 mb-3">
                <h4 class="text-xs font-bold text-white mb-2">üîç Discoverability</h4>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-gray-400 text-[10px] mb-1">CoinGecko</label>
                        <select id="edit-cg" class="w-full bg-gray-800 border border-gray-700 rounded px-2 py-1 text-sm">
                            ${Object.entries(CG_STATUS).map(([k, v]) => '<option value="' + k + '" ' + (meta.cg_status === k ? 'selected' : '') + '>' + v.label + ' (' + (v.score >= 0 ? '+' : '') + v.score + ')</option>').join('')}
                        </select>
                    </div>
                    <div class="flex items-end">
                        <div class="flex items-center gap-2 bg-gray-800 p-2 rounded w-full">
                            <input type="checkbox" id="edit-skip-clear" ${meta.skip_clear ? 'checked' : ''} class="accent-green-500">
                            <label class="text-xs">Skip.go Clear (+5/-5)</label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-900/50 p-3 rounded border border-yellow-900/50 mb-3">
                <h4 class="text-xs font-bold text-yellow-400 mb-2">üí∞ Value to Chain (10% take rate)</h4>
                <div class="grid grid-cols-3 gap-3">
                    <div>
                        <label class="block text-gray-400 text-[10px] mb-1">Asset Class</label>
                        <select id="edit-class" class="w-full bg-gray-800 border border-gray-700 rounded px-2 py-1 text-sm">
                            ${Object.entries(ASSET_CLASSES).map(([k, v]) => '<option value="' + k + '" ' + (meta.asset_class === k ? 'selected' : '') + '>' + v.label + ' - ' + v.desc + ' (+' + v.bonus + ')</option>').join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-400 text-[10px] mb-1">Treasury Value</label>
                        <select id="edit-treasury" class="w-full bg-gray-800 border border-gray-700 rounded px-2 py-1 text-sm">
                            ${Object.entries(TREASURY_VALUE).map(([k, v]) => '<option value="' + k + '" ' + (meta.treasury_value === k ? 'selected' : '') + '>' + v.label + ' (' + (v.score >= 0 ? '+' : '') + v.score + ')</option>').join('')}
                        </select>
                    </div>
                    <div class="flex items-end">
                        <div class="flex items-center gap-2 bg-gray-800 p-2 rounded w-full">
                            <input type="checkbox" id="edit-multi-dex" ${meta.multi_dex ? 'checked' : ''} class="accent-purple-500">
                            <label class="text-xs text-purple-400">Multi-DEX (+5)</label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="mb-3">
                <textarea id="edit-notes" rows="2" placeholder="General notes..." class="w-full bg-gray-800 border border-gray-700 rounded px-2 py-1 text-xs">${meta.notes || ''}</textarea>
            </div>
            <button onclick="saveAssetDetails('${asset}')" class="w-full bg-green-700 hover:bg-green-600 py-2 rounded font-bold">Save</button>
        </div>`;
    document.body.appendChild(modal);
}

function updateNamingStatus(asset) {
    let tlaName = asset;
    let actualPath = $('edit-actual-path')?.value || '';
    let namingOk = actualPath && tlaName === actualPath;
    let statusEl = $('edit-naming-status');
    if (statusEl) {
        statusEl.textContent = namingOk ? '‚úì Match' : '‚úó Mismatch';
        statusEl.className = 'text-lg font-bold ' + (namingOk ? 'text-green-400' : 'text-red-400');
    }
}

function saveAssetDetails(asset) {
    let meta = assetMetadata[asset];
    if (!meta) return;
    meta.actual_path = $('edit-actual-path')?.value || '';
    // naming_accurate is calculated from tla_name === actual_path, not stored
    meta.origin = $('edit-origin')?.value || 'unknown';
    meta.acquisition = $('edit-acquisition')?.value || 'hard';
    meta.acquisition_note = $('edit-acquisition-note')?.value || '';
    meta.cg_status = $('edit-cg')?.value || 'cg_none';
    meta.skip_clear = $('edit-skip-clear')?.checked || false;
    meta.asset_class = $('edit-class')?.value || 'unknown';
    meta.treasury_value = $('edit-treasury')?.value || 'medium';
    meta.multi_dex = $('edit-multi-dex')?.checked || false;
    meta.notes = $('edit-notes')?.value || '';
    document.querySelector('.modal-overlay.open')?.remove();
    renderMetaAssetList();
    updateMetaStatus();
}

function updateMetaStatus() {
    let count = Object.keys(assetMetadata).length;
    let needsSetup = Object.values(assetMetadata).filter(m => !m.actual_path || m.origin === 'unknown' || m.asset_class === 'unknown').length;
    let namingIssues = Object.values(assetMetadata).filter(m => !isNamingAccurate(m)).length;
    let avg = count > 0 ? Math.round(Object.values(assetMetadata).reduce((s, m) => s + calculateAccessScore(m), 0) / count) : 0;
    setTxt('meta-status', count + ' assets (' + needsSetup + ' need setup, ' + namingIssues + ' naming issues, avg: ' + avg + ')');
}

async function loadMetadataFromGitHub() {
    try {
        let resp = await fetch(METADATA_GITHUB_URL + '?t=' + Date.now());
        if (!resp.ok) throw new Error('Failed');
        let data = await resp.json();
        if (data.assets) {
            Object.entries(data.assets).forEach(([asset, meta]) => {
                // v4 format has actual_path
                if (meta.actual_path !== undefined) {
                    assetMetadata[asset] = {
                        tla_name: meta.tla_name || asset,
                        actual_path: meta.actual_path,
                        origin: meta.origin || 'unknown',
                        acquisition: meta.acquisition || 'hard',
                        acquisition_note: meta.acquisition_note || '',
                        cg_status: meta.cg_status || 'cg_none',
                        skip_clear: meta.skip_clear || false,
                        asset_class: meta.asset_class || 'unknown',
                        treasury_value: meta.treasury_value || 'low',
                        multi_dex: meta.multi_dex || false,
                        notes: meta.notes || ''
                    };
                }
                // Older formats - create with basic info
                else {
                    assetMetadata[asset] = {
                        tla_name: asset,
                        actual_path: asset, // Assume accurate if not specified
                        origin: meta.origin || 'unknown',
                        acquisition: 'hard',
                        acquisition_note: '',
                        cg_status: meta.cg_status || 'cg_none',
                        skip_clear: false,
                        asset_class: meta.asset_class || 'unknown',
                        treasury_value: 'low',
                        multi_dex: false,
                        notes: meta.notes || ''
                    };
                }
            });
        }
        renderMetaAssetList();
        updateMetaStatus();
        alert('Loaded ' + Object.keys(assetMetadata).length + ' assets');
    } catch (e) {
        console.error('Load error:', e);
        alert('Failed to load from GitHub');
    }
}

function downloadMetadata() {
    let assets = {};
    Object.entries(assetMetadata).forEach(([a, m]) => { 
        assets[a] = { 
            ...m, 
            naming_accurate: isNamingAccurate(m),
            access_score: calculateAccessScore(m) 
        }; 
    });
    let data = { version: 4, updated: new Date().toISOString(), score_formula: 'origin + class + cg + treasury + naming(¬±10) + skip(¬±5) + multidex(+5)', assets };
    let blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    let url = URL.createObjectURL(blob);
    let a = document.createElement('a'); a.href = url; a.download = 'tla_metadata.json'; a.click();
    URL.revokeObjectURL(url);
}

function copyMetadata() {
    let assets = {};
    Object.entries(assetMetadata).forEach(([a, m]) => { 
        assets[a] = { 
            ...m, 
            naming_accurate: isNamingAccurate(m),
            access_score: calculateAccessScore(m) 
        }; 
    });
    let data = { version: 4, updated: new Date().toISOString(), score_formula: 'origin + class + cg + treasury + naming(¬±10) + skip(¬±5) + multidex(+5)', assets };
    navigator.clipboard.writeText(JSON.stringify(data, null, 2)).then(() => alert('Copied!'));
}

function getPoolAccessScore(poolName) {
    let parts = poolName.split('-');
    if (parts.length < 2) return 50;
    let s1 = assetMetadata[parts[0]] ? calculateAccessScore(assetMetadata[parts[0]]) : 30;
    let s2 = assetMetadata[parts[1]] ? calculateAccessScore(assetMetadata[parts[1]]) : 30;
    return Math.min(s1, s2);
}


// ============ ADAO STRATEGY ============

function toggleStrategyPanel() {
    let panel = $('strategy-panel');
    let toggle = $('strategy-toggle');
    if (panel.classList.contains('hidden')) {
        panel.classList.remove('hidden');
        toggle.innerText = '‚ñ≤';
    } else {
        panel.classList.add('hidden');
        toggle.innerText = '‚ñº';
    }
}

function generateStrategy() {
    if (store.vote.pools.length === 0) {
        alert('Please parse Vote data first');
        return;
    }
    
    calculateAllScores();
    generateVoteOptimization();
    generateBribeCandidates();
    generateActivationTargets();
}

function generateVoteOptimization() {
    let html = '';
    
    BUCKET_ORDER.forEach(bucket => {
        let pools = store.vote.pools.filter(p => p.b === bucket && p.vps >= 1); // Active only for vote allocation
        if (pools.length === 0) return;
        
        // Sort by aDAO score (highest first)
        pools.sort((a, b) => (b.adaoScore || 0) - (a.adaoScore || 0));
        
        // Calculate recommended allocation in 10% chunks
        let totalChunks = 10; // 100% = 10 chunks of 10%
        let allocations = [];
        let remainingChunks = totalChunks;
        
        pools.forEach((p, idx) => {
            if (remainingChunks <= 0) {
                allocations.push({ pool: p, recommended: 0 });
                return;
            }
            
            let chunks = 0;
            if (p.adaoScore >= 30) {
                chunks = Math.min(4, remainingChunks); // Max 40% for top scorers
            } else if (p.adaoScore >= 10) {
                chunks = Math.min(3, remainingChunks); // Max 30%
            } else if (p.adaoScore >= 0) {
                chunks = Math.min(2, remainingChunks); // Max 20%
            } else if (p.adaoScore >= -20) {
                chunks = Math.min(1, remainingChunks); // Max 10%
            }
            // Negative scores below -20 get 0
            
            remainingChunks -= chunks;
            allocations.push({ pool: p, recommended: chunks * 10 });
        });
        
        // Distribute any remaining chunks to top pools
        let i = 0;
        while (remainingChunks > 0 && allocations.length > 0) {
            if (allocations[i].recommended < 50) { // Cap at 50%
                allocations[i].recommended += 10;
                remainingChunks--;
            }
            i = (i + 1) % allocations.length;
            if (i === 0 && allocations.every(a => a.recommended >= 50)) break;
        }
        
        // Build HTML
        html += `<div class="border-b border-gray-700 pb-2 mb-2">
            <div class="text-[10px] font-bold text-gray-400 uppercase mb-2">${bucket}</div>
            <div class="grid grid-cols-5 gap-1 text-[9px] text-gray-500 mb-1 px-1">
                <div class="col-span-2">Pool</div>
                <div class="text-right">Score</div>
                <div class="text-right">Now</div>
                <div class="text-right">Rec</div>
            </div>`;
        
        allocations.filter(a => a.recommended > 0 || a.pool.ms > 0).forEach(a => {
            let p = a.pool;
            let current = p.ms || 0;
            let diff = a.recommended - current;
            let diffColor = diff > 0 ? 'text-green-400' : diff < 0 ? 'text-red-400' : 'text-gray-500';
            let diffStr = diff > 0 ? `+${diff.toFixed(0)}%` : diff < 0 ? `${diff.toFixed(0)}%` : '-';
            
            html += `<div class="grid grid-cols-5 gap-1 px-1 py-0.5 hover:bg-gray-800/50 rounded">
                <div class="col-span-2 truncate text-white">${p.n}</div>
                <div class="text-right ${getScoreColor(p.adaoScore)}">${p.adaoScore?.toFixed(0) || 0}</div>
                <div class="text-right text-cyan-400">${current.toFixed(0)}%</div>
                <div class="text-right font-bold ${diffColor}">${a.recommended}%</div>
            </div>`;
        });
        
        html += `</div>`;
    });
    
    setHtml('vote-optimization', html);
}

function generateBribeCandidates() {
    let html = '';
    let candidates = [];
    
    BUCKET_ORDER.forEach(bucket => {
        // Include both active AND inactive pools for bribe consideration
        let pools = store.vote.pools.filter(p => p.b === bucket);
        if (pools.length === 0) return;
        
        // Score for bribe worthiness:
        // - High aDAO score
        // - Native Terra bonus
        // - Currently low bribes
        // - Minimum liquidity ($25K+)
        pools.forEach(p => {
            let bribeScore = (p.adaoScore || 0);
            
            // Native Terra bonus (+15)
            let isNative = p.n.match(/ROAR|CAPA|SOLID|ASTRO|FUEL/i);
            if (isNative) bribeScore += 15;
            
            // Low current bribes bonus (+10 if <$10)
            if (p.incPD < 10) bribeScore += 10;
            
            // Penalize if already getting lots of bribes
            if (p.incPD > 50) bribeScore -= 20;
            
            // Minimum liquidity check
            let liq = p.liq4Ep?.avg || p.dp || 0;
            if (liq < 25000) bribeScore -= 50; // Heavy penalty for tiny pools
            
            p.bribeScore = bribeScore;
            p.isNative = isNative;
        });
        
        // Sort by bribe score and pick top
        pools.sort((a, b) => (b.bribeScore || 0) - (a.bribeScore || 0));
        let best = pools[0];
        
        if (best) {
            let statusBadge = best.vps < 1 ? '<span class="text-red-400 text-[9px]">INACT</span>' : '';
            let nativeBadge = best.isNative ? '<span class="text-orange-400">üè†</span>' : '';
            
            candidates.push({ bucket, pool: best });
            
            html += `<div class="flex justify-between items-center py-1 px-2 bg-gray-800/50 rounded">
                <div>
                    <span class="text-gray-500 text-[10px] w-20 inline-block">${bucket}:</span>
                    <span class="text-white font-bold">${best.n}</span>
                    ${nativeBadge} ${statusBadge}
                </div>
                <div class="text-right">
                    <span class="${getScoreColor(best.adaoScore)}">${best.adaoScore?.toFixed(0) || 0}</span>
                </div>
            </div>`;
        }
    });
    
    // Store for copy function
    window.bribeCandidates = candidates;
    
    setHtml('bribe-candidates', html);
}

function generateActivationTargets() {
    let html = '';
    
    // Find inactive pools (< 1% votes) that have good potential
    let inactivePools = store.vote.pools.filter(p => p.vps < 1);
    
    if (inactivePools.length === 0) {
        html = '<div class="text-gray-500 italic">No inactive pools found</div>';
        setHtml('activation-targets', html);
        return;
    }
    
    // Score them by potential
    inactivePools.forEach(p => {
        let activationScore = 0;
        
        // Access score matters (good assets, good bridge, LUNA benefit)
        activationScore += (p.accessScore || 0) * 0.4;
        
        // Native Terra bonus
        if (p.n.match(/ROAR|CAPA|SOLID|ASTRO|FUEL/i)) activationScore += 20;
        
        // Has some liquidity (not dead)
        let liq = p.liq4Ep?.avg || p.dp || 0;
        if (liq > 50000) activationScore += 15;
        else if (liq > 25000) activationScore += 10;
        else if (liq > 10000) activationScore += 5;
        
        // Has some volume (people actually trade)
        let vol = p.vol4Ep?.avg || p.vol || 0;
        if (vol > 10000) activationScore += 15;
        else if (vol > 5000) activationScore += 10;
        
        // Low APR = needs help
        if (p.aprNon && p.aprNon < 40) activationScore += 10;
        
        p.activationScore = activationScore;
    });
    
    // Sort and take top 5
    inactivePools.sort((a, b) => (b.activationScore || 0) - (a.activationScore || 0));
    let topTargets = inactivePools.slice(0, 5);
    
    topTargets.forEach(p => {
        let liq = p.liq4Ep?.avg || p.dp || 0;
        let nativeBadge = p.n.match(/ROAR|CAPA|SOLID|ASTRO|FUEL/i) ? '<span class="text-orange-400">üè†</span>' : '';
        
        html += `<div class="flex justify-between items-center py-1 px-2 bg-gray-800/30 rounded">
            <div class="flex items-center gap-2">
                <span class="text-white font-bold">${p.n}</span>
                ${nativeBadge}
                <span class="text-[9px] text-gray-500">${p.d.includes('Single') ? 'Single' : isAstroport(p.d) ? 'Astro' : 'SS'}</span>
            </div>
            <div class="text-right text-[10px]">
                <span class="text-teal-400">${fmt$(liq)}</span>
                <span class="text-gray-500 mx-1">|</span>
                <span class="text-cyan-400">${p.accessScore?.toFixed(0) || '?'} acc</span>
            </div>
        </div>`;
    });
    
    setHtml('activation-targets', html);
}

function copyVoteStrategy() {
    let text = 'aDAO VOTE OPTIMIZATION\n';
    text += '='.repeat(40) + '\n\n';
    
    BUCKET_ORDER.forEach(bucket => {
        let pools = store.vote.pools.filter(p => p.b === bucket && p.vps >= 1);
        if (pools.length === 0) return;
        
        pools.sort((a, b) => (b.adaoScore || 0) - (a.adaoScore || 0));
        
        text += `${bucket}\n`;
        text += '-'.repeat(20) + '\n';
        
        pools.filter(p => (p.adaoScore || 0) > -20).slice(0, 5).forEach(p => {
            text += `${p.n}: Score ${p.adaoScore?.toFixed(0) || 0}\n`;
        });
        text += '\n';
    });
    
    navigator.clipboard.writeText(text).then(() => {
        alert('Vote strategy copied!');
    });
}

function copyBribeCandidates() {
    if (!window.bribeCandidates || window.bribeCandidates.length === 0) {
        alert('Generate strategy first');
        return;
    }
    
    let text = 'aDAO BRIBE ALLOCATION PROPOSAL\n';
    text += '='.repeat(40) + '\n\n';
    text += 'Vote for ONE pool to receive aDAO-sponsored bribes:\n\n';
    
    window.bribeCandidates.forEach(c => {
        let native = c.pool.isNative ? ' üè†' : '';
        text += `‚ñ° ${c.bucket}: ${c.pool.n}${native}\n`;
    });
    
    text += '\n[Bribes distributed over 4 epochs]\n';
    
    navigator.clipboard.writeText(text).then(() => {
        alert('Bribe proposal copied!');
    });
}

function findCurrentEpoch() {
    const now = new Date();
    
    // Find which epoch we're currently in
    for (let ep of epochData) {
        let start = new Date(ep.start_time);
        let end = new Date(ep.end_time);
        
        if (now >= start && now < end) {
            currentEpochInfo = ep;
            store.vote.ep = ep.epoch;
            
            // Set the epoch input field
            if ($('historyEpoch')) {
                $('historyEpoch').value = ep.epoch;
            }
            return;
        }
    }
    
    // If we're past all epochs in the file, use the last one
    if (epochData.length > 0) {
        currentEpochInfo = epochData[epochData.length - 1];
        store.vote.ep = currentEpochInfo.epoch;
        if ($('historyEpoch')) {
            $('historyEpoch').value = currentEpochInfo.epoch;
        }
    }
}

function updateTimers() {
    const now = new Date();
    
    if (currentEpochInfo) {
        // Display current epoch
        setTxt('live-epoch', `Epoch ${currentEpochInfo.epoch}`);
        
        // Calculate time until epoch ends
        const endTime = new Date(currentEpochInfo.end_time);
        const msUntilEnd = endTime - now;
        const daysLeft = msUntilEnd / 86400000; // Decimal days (not floored)
        
        setTxt('epoch-timer', formatTimeDiff(msUntilEnd));
        
        // Calculate phase based on days REMAINING until epoch ends:
        // 5-7 days remaining = 0-2 days into epoch = START
        // 2-5 days remaining = 2-5 days into epoch = MID  
        // 0-2 days remaining = 5-7 days into epoch = END
        let phase = 'End';
        let phaseColor = 'text-red-400';
        if (daysLeft >= 5) {
            phase = 'Start';
            phaseColor = 'text-green-400';
        } else if (daysLeft > 2) {
            phase = 'Mid';
            phaseColor = 'text-yellow-400';
        }
        const phaseEl = $('epoch-phase');
        if (phaseEl) {
            phaseEl.innerText = phase;
            phaseEl.className = phaseColor + ' font-bold ml-1';
        }
        
        // Calculate time until rewards update
        const rewardsTime = new Date(currentEpochInfo.rewards_update);
        const msUntilRewards = rewardsTime - now;
        
        if (msUntilRewards > 0) {
            setTxt('reward-timer', formatTimeDiff(msUntilRewards));
        } else {
            setTxt('reward-timer', 'Updated ‚úì');
        }
        
        // Check if epoch ended and we need to refresh
        if (msUntilEnd <= 0) {
            findCurrentEpoch(); // Move to next epoch
        }
    } else {
        setTxt('live-epoch', 'Epoch ...');
        setTxt('epoch-timer', 'Loading...');
        setTxt('epoch-phase', '...');
        setTxt('reward-timer', 'Loading...');
    }
}

function formatTimeDiff(ms) {
    if (ms < 0) return "0d 0h 0m";
    let d = Math.floor(ms / 86400000);
    let h = Math.floor((ms % 86400000) / 3600000);
    let m = Math.floor((ms % 3600000) / 60000);
    return `${d}d ${h}h ${m}m`;
}

// === SESSION MANAGER ===
async function findLatestSnapshot() {
    const msg = $('load-msg');
    if (msg) msg.innerText = "Searching for latest snapshot...";
    
    // Start from current epoch (from epoch file) or fallback
    let startEp = currentEpochInfo ? currentEpochInfo.epoch : 165;
    const phases = ["end", "mid", "start"];
    const base = "https://raw.githubusercontent.com/defipatriot/tla_json_storage/main/tla-data-epoch";
    
    // Check up to 10 epochs back
    for (let ep = startEp; ep >= startEp - 10; ep--) {
        for (let ph of phases) {
            try {
                let res = await fetch(`${base}-${ep}-${ph}.json`, { method: 'HEAD' });
                if (res.ok) {
                    $('historyEpoch').value = ep;
                    $('historyPhase').value = ph;
                    updateGithubLink();
                    if (msg) {
                        msg.innerText = `Found: Epoch ${ep} (${ph})`;
                        msg.className = "text-[10px] text-green-400 font-bold";
                    }
                    return { epoch: ep, phase: ph };
                }
            } catch(err) {}
        }
    }
    
    if (msg) {
        msg.innerText = "No snapshots found";
        msg.className = "text-[10px] text-red-400 font-bold";
    }
    return null;
}

function checkExtData() {
    // TODO: Check if ext data file exists
}

function updateGithubLink() {
    const ep = $('historyEpoch')?.value || '';
    const ph = $('historyPhase')?.value?.toLowerCase() || 'end';
    const fileName = `tla-data-epoch-${ep}-${ph}.json`;
    const linkEl = $('github-link');
    if (linkEl) {
        linkEl.innerHTML = `<i class="fab fa-github"></i> ${fileName}`;
        linkEl.href = `https://github.com/defipatriot/tla_json_storage/blob/main/${fileName}`;
    }
}

async function fetchCoreData() {
    let ep = $('historyEpoch').value;
    let ph = $('historyPhase').value;
    let url = `https://raw.githubusercontent.com/defipatriot/tla_json_storage/main/tla-data-epoch-${ep}-${ph}.json`;
    
    try {
        let res = await fetch(url);
        if (!res.ok) throw new Error("File not found");
        let d = await res.json();
        
        // Check if it's new v2 format or old format
        if (d.meta && d.meta.version === "2.0") {
            // NEW FORMAT (v2.0)
            store.vote.ep = d.vote.epoch;
            store.vote.end = d.vote.end_time || 'Loaded from file';
            store.vote.tvp = d.vote.tvp;
            store.vote.reb = d.vote.rebase || 0;
            store.vote.usd = d.vote.rewards_usd || 0;
            
            store.vote.pools = (d.pools || []).map(p => ({
                n: p.name,
                // Normalize DEX names when loading (handles White Whale -> Skeleton Swap, etc.)
                d: normalizeDexName(p.dex),
                b: p.bucket || "UNKNOWN",
                tvp: p.vp || 0,
                dp: p.depth || 0,
                mvp: p.adao_vp || 0,
                vps: p.vote_pct || 0,
                ms: p.adao_pct || 0,
                inc: p.bribes_total || 0,
                incTotal: p.bribes_total || 0,
                incPD: p.bribes_pd || 0,
                incOther: p.bribes_other || 0,
                aprNon: p.apr_non || 0,
                aprAmp: p.apr_amp || 0,
                aprFactor: p.apr_factor || 0,
                votNowVp: p.votion_now_vp || 0,
                votNowPct: p.votion_now_pct || 0,
                votNextVp: p.votion_next_vp || 0,
                votNextPct: p.votion_next_pct || 0,
                liq4Ep: p.liq_4ep_avg > 0 ? { avg: p.liq_4ep_avg, count: p.liq_4ep_count || 4 } : null,
                vol4Ep: p.vol_4ep_avg > 0 ? { avg: p.vol_4ep_avg, count: p.vol_4ep_count || 4 } : null,
                efficiency: p.efficiency || 0,
                // DON'T load scores from file - will be recalculated with current metadata
                // Old file values preserved for reference:
                _oldAccessScore: p.access_score || 0,
                _oldAdaoScore: p.adao_score || 0,
                // These are still valid from file (don't depend on access score):
                performanceScore: null, // Will be recalculated
                supportScore: p.support_score || 0  // Support doesn't depend on access, can keep
            }));
            
            // Debug: Log 4ep data loading
            let poolsWithLiq4Ep = store.vote.pools.filter(p => p.liq4Ep).length;
            let poolsWithVol4Ep = store.vote.pools.filter(p => p.vol4Ep).length;
            console.log(`Loaded pools: ${store.vote.pools.length}`);
            console.log(`Pools with liq4Ep: ${poolsWithLiq4Ep}`);
            console.log(`Pools with vol4Ep: ${poolsWithVol4Ep}`);
            if (store.vote.pools[0]) {
                console.log('First pool:', store.vote.pools[0].n, 'liq4Ep:', store.vote.pools[0].liq4Ep);
            }
            
            // Load DAO data if present
            if (d.dao) {
                store.dao.lVp = d.dao.locked_vp || 0;
                store.dao.lFac = d.dao.power_factor || 0;
                store.dao.lAst = d.dao.underlying_assets || 0;
                store.dao.dep = d.dao.deposit_usd || 0;
                store.dao.apr = d.dao.deposit_apr || 0;
                
                if (d.dao.rewards) {
                    store.dao.rew = {
                        usd: d.dao.rewards.usd || 0,
                        z: d.dao.rewards.zAssets || 0,
                        amp: d.dao.rewards.ampLUNA || 0
                    };
                }
                
                if (d.dao.locks) {
                    store.dao.locks = d.dao.locks.map(l => ({
                        id: l.id,
                        amt: l.amount,
                        asset: l.asset || 'LUNA',
                        bucket: l.bucket,
                        vp: l.vp,
                        usd: l.usd,
                        status: l.status || 'Unknown'
                    }));
                }
                
                if (d.dao.tokens) {
                    store.dao.toks = d.dao.tokens;
                }
                
                // Load vote rewards
                if (d.dao.vote_rewards) {
                    store.dao.vRew = d.dao.vote_rewards;
                }
                if (d.dao.vote_reward_periods) {
                    store.dao.vRewPeriods = d.dao.vote_reward_periods;
                }
            }
            
            // Load TLA liquidity data if present
            if (d.tla) {
                store.tla.tvl = d.tla.tvl || 0;
                store.tla.rewYr = d.tla.rewards_yr || 0;
                
                if (d.tla.pools) {
                    store.tla.pools = d.tla.pools.map(p => ({
                        name: p.name,
                        normName: p.normalized_name || p.name,
                        dex: p.dex,
                        type: p.type,
                        bucket: p.bucket,
                        depth: p.depth || 0,
                        stk: p.tla_staked || 0,
                        aprNon: p.apr_non_amp || 0,
                        aprAmp: p.apr_amplified || 0,
                        rYr: p.rewards_per_year || 0,
                        adaoNon: p.adao_deposit_non_amp || 0,
                        adaoAmp: p.adao_deposit_amplified || 0
                    }));
                }
                
                if (d.tla.inactive_pools) {
                    store.tla.inactivePools = d.tla.inactive_pools.map(p => ({
                        name: p.name,
                        normName: p.normalized_name || p.name,
                        dex: p.dex,
                        type: p.type,
                        bucket: p.bucket,
                        depth: p.depth || 0,
                        stk: p.tla_staked || 0,
                        aprNon: p.apr_non_amp || 0,
                        aprAmp: p.apr_amplified || 0
                    }));
                }
            }
            
            // Mark ext data as loaded from file
            store.ext.loaded = true;
            store.ext.source = 'epoch_file';
            
            // Check what data was actually in the file and set flags
            let hasVotionData = store.vote.pools.some(p => p.votNowVp > 0 || p.votNextVp > 0);
            let hasBribesData = store.vote.pools.some(p => p.incPD > 0 || p.incTotal > 0);
            let has4EpData = store.vote.pools.some(p => p.liq4Ep || p.vol4Ep);
            
            // Set flags so validation knows we have this data
            if (hasVotionData) {
                store.ext.votion = { loaded_from_file: true };
            }
            if (hasBribesData) {
                store.ext.pdBribesEpoch = { loaded_from_file: true };
            }
            if (has4EpData) {
                store.ext.lps = { loaded_from_file: true };
            }
            
            // Auto-load metadata for access scoring (silent, no alert)
            let metaLoaded = 0;
            try {
                let metaResp = await fetch(METADATA_GITHUB_URL + '?t=' + Date.now());
                if (metaResp.ok) {
                    let metaData = await metaResp.json();
                    if (metaData.assets) {
                        Object.entries(metaData.assets).forEach(([asset, meta]) => {
                            assetMetadata[asset] = meta;
                        });
                        metaLoaded = Object.keys(assetMetadata).length;
                        console.log(`Loaded metadata: ${metaLoaded} assets`);
                    }
                }
            } catch (e) {
                console.log('Metadata not loaded - using fallback scoring');
            }
            
            // RECALCULATE all scores using fresh metadata
            // This ignores old access_score/adao_score from file and recalculates
            recalculateScoresFromLoadedData();
            
            // Update UI
            updatePasteStatus('ps-vote', true, 'from file');
            updatePasteStatus('ps-liq-active', true, 'from file');
            
            // Render all tables (after scores recalculated)
            renderVoteTable();
            renderLocks();
            renderLiquidityTable();
            
            // Update additional UI elements
            updateDaoUIFromLoad();
            
            alert(`‚úÖ Loaded Epoch ${ep} (${ph}) - v2.0 format\n\n` +
                  `üìä ${d.pools.length} pools\n` +
                  `üîí ${d.dao?.locks?.length || 0} locks\n` +
                  `üíß ${d.tla?.pools?.length || 0} TLA pools\n` +
                  `üè∑Ô∏è ${metaLoaded} asset metadata\n` +
                  `üîÑ Scores recalculated with current metadata`);
            
        } else {
            // OLD FORMAT (v1)
            if (d.vote_data) {
                store.vote.ep = d.vote_data.epoch;
                store.vote.end = d.vote_data.ends_in;
                store.vote.tvp = d.vote_data.total_voting_power;
                store.vote.reb = d.vote_data.adao_rebase || 0;
                store.vote.usd = d.vote_data.adao_unclaimed_rewards || 0;
                store.vote.pools = (d.vote_data.pools || []).map(p => ({
                    n: p.pool_name,
                    d: normalizeDexName(p.dex || p.dex_name),
                    b: p.bucket || "UNKNOWN",
                    tvp: p.tla_total_votes || 0,
                    dp: p.pool_depth || 0,
                    mvp: p.adao_vote_vp || 0,
                    vps: parseFloat(p.tla_vote_share || 0),
                    ms: parseFloat(p.adao_vote_share || 0),
                    inc: p.total_bribes || 0,
                    apr: '-'
                }));
                
                updatePasteStatus('ps-vote', true, 'v1');
                renderVoteTable();
            }
            
            if (d.locks) {
                store.dao.lVp = d.locks.adao_voting_power || 0;
                store.dao.lFac = d.locks.power_factor || 0;
                store.dao.lAst = d.locks.underlying_assets || 0;
                store.dao.locks = (d.locks.items || []).map(l => ({
                    id: l.id,
                    amt: l.amount,
                    asset: l.asset || 'LUNA',
                    vp: l.voting_power,
                    usd: l.usd_value,
                    status: l.status || 'Unknown'
                }));
                renderLocks();
            }
            
            alert(`‚úÖ Loaded Epoch ${ep} (${ph}) - v1 format`);
        }
        
    } catch(e) {
        console.error('Load error:', e);
        alert("‚ùå Could not load: " + e.message);
    }
}

// Helper to update paste status with optional label
function updatePasteStatus(id, success, label = '') {
    let el = $(id);
    if (!el) return;
    if (success) {
        el.classList.remove('bg-gray-800', 'text-gray-500', 'border-gray-700');
        el.classList.add('bg-green-900/50', 'text-green-400', 'border-green-700');
        if (label) {
            el.textContent = el.textContent.split(' ')[0] + ' ‚úì';
        }
    } else {
        el.classList.remove('bg-green-900/50', 'text-green-400', 'border-green-700');
        el.classList.add('bg-gray-800', 'text-gray-500', 'border-gray-700');
    }
}

// Update DAO UI elements after loading from file
function updateDaoUIFromLoad() {
    // Update unclaimed rewards details
    if (store.dao.rew) {
        setTxt('dao-rew-z', (store.dao.rew.z || 0).toLocaleString());
        setTxt('dao-rew-amp', (store.dao.rew.amp || 0).toLocaleString());
        setTxt('dao-usd', fmt$(store.dao.rew.usd || 0));
    }
    
    // Update vote rewards modal
    if (store.dao.vRewPeriods && store.dao.vRewPeriods.length > 0) {
        let first = Math.min(...store.dao.vRewPeriods);
        let last = Math.max(...store.dao.vRewPeriods);
        let count = store.dao.vRewPeriods.length;
        setTxt('mod-vote-periods', `${first} - ${last}`);
        setTxt('mod-vote-epoch-count', `${count} Epochs`);
    } else {
        setTxt('mod-vote-periods', '-');
        setTxt('mod-vote-epoch-count', '-');
    }
    
    // Update vote rewards list in modal
    if (store.dao.vRew && Object.keys(store.dao.vRew).length > 0) {
        let html = Object.entries(store.dao.vRew).map(([token, amount]) => {
            let formatted = amount < 1 ? amount.toFixed(6) : amount.toLocaleString(undefined, {maximumFractionDigits: 2});
            return `<div class="flex justify-between py-1"><span class="text-gray-400">${token}</span><span class="text-green-400 font-mono">${formatted}</span></div>`;
        }).join('');
        setHtml('mod-vote-list', html);
    }
    
    // Update tokens modal
    if (store.dao.toks && store.dao.toks.length > 0) {
        setHtml('mod-tok-list', store.dao.toks.map(t => 
            `<div class="flex justify-between py-1"><span class="text-gray-400">${t.s}</span><span class="font-mono text-white">${t.a?.toLocaleString() || t.a}</span></div>`
        ).join(''));
    }
}

// === TAB SWITCHING ===
function switchTab(t) {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    event.target.classList.add('active');
    document.querySelectorAll('.workspace').forEach(w => w.classList.remove('active'));
    $('ws-' + t)?.classList.add('active');
}

// === CONFIG EDITOR ===
function generateConfigJSON() {
    const config = {
        version: 1,
        updated: new Date().toISOString().split('T')[0],
        general: {
            currentEpoch: parseInt($('cfg-epoch')?.value) || 161,
            defaultPhase: $('cfg-phase')?.value || 'end'
        },
        urls: {
            baseUrl: $('cfg-baseUrl')?.value || '',
            extUrl: $('cfg-extUrl')?.value || '',
            adaoUrl: $('cfg-adaoUrl')?.value || ''
        },
        scoring: {
            weights: {
                access: parseFloat($('cfg-accessWeight')?.value) || 0.15,
                performance: parseFloat($('cfg-perfWeight')?.value) || 0.55,
                support: parseFloat($('cfg-supportWeight')?.value) || 0.30
            },
            origin: {
                terra_lsd: parseInt($('cfg-origin-lsd')?.value) || 85,
                terra_native: parseInt($('cfg-origin-native')?.value) || 80,
                ibc_native: parseInt($('cfg-origin-ibc')?.value) || 70,
                bridged_stable: parseInt($('cfg-origin-stable')?.value) || 65,
                bridge_eureka: parseInt($('cfg-origin-eureka')?.value) || 55,
                bridge_axelar: parseInt($('cfg-origin-axelar')?.value) || 50
            },
            assetClass: {
                stable: parseInt($('cfg-class-stable')?.value) || 5,
                bluechip: parseInt($('cfg-class-bluechip')?.value) || 5,
                lsd: parseInt($('cfg-class-lsd')?.value) || 5,
                rwa: parseInt($('cfg-class-rwa')?.value) || 5,
                core: parseInt($('cfg-class-core')?.value) || 0
            }
        },
        dex: {
            primary: {
                name: $('cfg-dex1-name')?.value || 'Astroport',
                link: $('cfg-dex1-link')?.value || ''
            },
            secondary: {
                name: $('cfg-dex2-name')?.value || 'Skeleton Swap',
                link: $('cfg-dex2-link')?.value || '',
                enabled: $('cfg-dex2-enabled')?.checked || false
            }
        }
    };
    return config;
}

function copyConfigJSON() {
    const config = generateConfigJSON();
    const jsonStr = JSON.stringify(config, null, 2);
    
    // Show in preview
    $('config-preview').textContent = jsonStr;
    
    // Copy to clipboard
    navigator.clipboard.writeText(jsonStr).then(() => {
        const status = $('config-copy-status');
        status.classList.remove('hidden');
        setTimeout(() => status.classList.add('hidden'), 2000);
    });
}

function resetConfigDefaults() {
    // General
    $('cfg-epoch').value = 161;
    $('cfg-phase').value = 'end';
    
    // URLs
    $('cfg-baseUrl').value = 'https://raw.githubusercontent.com/defipatriot/tla_json_storage/main';
    $('cfg-extUrl').value = 'https://raw.githubusercontent.com/defipatriot/tla-ext_json_storage/main';
    $('cfg-adaoUrl').value = 'https://raw.githubusercontent.com/defipatriot/adao_json_storage/main';
    
    // Weights
    $('cfg-accessWeight').value = 0.15;
    $('cfg-perfWeight').value = 0.55;
    $('cfg-supportWeight').value = 0.30;
    
    // Origin scores
    $('cfg-origin-lsd').value = 85;
    $('cfg-origin-native').value = 80;
    $('cfg-origin-ibc').value = 70;
    $('cfg-origin-stable').value = 65;
    $('cfg-origin-eureka').value = 55;
    $('cfg-origin-axelar').value = 50;
    
    // Asset class
    $('cfg-class-stable').value = 5;
    $('cfg-class-bluechip').value = 5;
    $('cfg-class-lsd').value = 5;
    $('cfg-class-rwa').value = 5;
    $('cfg-class-core').value = 0;
    
    // DEX
    $('cfg-dex1-name').value = 'Astroport';
    $('cfg-dex1-link').value = 'https://app.astroport.fi/pools';
    $('cfg-dex2-name').value = 'Skeleton Swap';
    $('cfg-dex2-link').value = 'https://app.skeleton_swap.money/terra/pools';
    $('cfg-dex2-enabled').checked = false;
    
    $('config-preview').textContent = 'Click "Copy Config JSON" to generate...';
}

// Update weight total display
document.addEventListener('DOMContentLoaded', () => {
    const updateWeightTotal = () => {
        const a = parseFloat($('cfg-accessWeight')?.value) || 0;
        const p = parseFloat($('cfg-perfWeight')?.value) || 0;
        const s = parseFloat($('cfg-supportWeight')?.value) || 0;
        const total = ((a + p + s) * 100).toFixed(0);
        const el = $('weight-total');
        if (el) {
            el.textContent = `Total: ${total}%`;
            el.className = total == 100 ? 'text-[10px] text-green-400 mt-2' : 'text-[10px] text-red-400 mt-2';
        }
    };
    
    ['cfg-accessWeight', 'cfg-perfWeight', 'cfg-supportWeight'].forEach(id => {
        $(id)?.addEventListener('input', updateWeightTotal);
    });
});

// === VOTE PARSING ===
function normalizeName(name) {
    if (!name.includes('-')) return name;
    let parts = name.split('-');
    // Only swap if LUNA itself is second (to put LUNA first)
    // Don't swap for ampLUNA, bLUNA - they stay as LUNA-ampLUNA, LUNA-bLUNA
    if (parts[1] === 'LUNA') return `LUNA-${parts[0]}`;
    return name;
}

// Normalize DEX names - handles White Whale -> Skeleton Swap transition
// Accepts: White Whale, WhiteWhale, whitewhale, WW, ww, Skeleton, Skeleton Swap, SS, ss, etc.
function normalizeDexName(dexName) {
    if (!dexName) return dexName;
    let lower = dexName.toLowerCase().trim();
    
    // Skeleton Swap / White Whale variants -> "Skeleton Swap"
    if (lower.includes('white') || lower.includes('whale') || 
        lower === 'ww' || lower.includes('skeleton') || lower === 'ss') {
        return 'Skeleton Swap';
    }
    
    // Astroport variants
    if (lower.includes('astro') && !lower.includes('single')) {
        return 'Astroport';
    }
    
    // Single-sided (Astroport single asset staking)
    if (lower === 'single' || lower.includes('single')) {
        return 'Single (Astroport)';
    }
    
    return dexName; // Return as-is if no match
}

// Check if DEX is Skeleton Swap (handles all variants)
function isSkeletonSwap(dexName) {
    if (!dexName) return false;
    let lower = dexName.toLowerCase();
    return lower.includes('white') || lower.includes('whale') || 
           lower === 'ww' || lower.includes('skeleton') || lower === 'ss';
}

// Check if DEX is Astroport (including Single)
function isAstroport(dexName) {
    if (!dexName) return false;
    let lower = dexName.toLowerCase();
    return lower.includes('astro') || lower === 'single';
}

function parseVote() {
    try {
        let txt = $('votePaste').value;
        
        // === HEADER DATA ===
        let m;
        if (m = txt.match(/For Epoch\s*(\d+)/)) store.vote.ep = parseInt(m[1]);
        if (m = txt.match(/ends\s*\n?\s*in\s*(\d+)\s*day/i)) store.vote.end = m[1] + ' days';
        if (m = txt.match(/Total Voting Power\s*\n?\s*([\d\.]+)([KkMm])?VP/i)) store.vote.tvp = parseNum(m[1] + (m[2] || ''));
        if (m = txt.match(/Your Voting Power\s*\n?\s*([\d\.]+)([KkMm]?)VP/i)) store.dao.lVp = parseNum(m[1] + (m[2] || ''));
        if (m = txt.match(/Rebase\s*\n?\s*([\d\.,]+)/i)) store.vote.reb = parseNum(m[1]);
        if (m = txt.match(/Vote Rewards\s*\n?\s*\$\s*([\d\.,]+)/i)) store.vote.usd = parseNum(m[1]);

        // === POOL PARSING ===
        let lines = txt.split('\n').map(l => l.trim());
        store.vote.pools = [];
        let currentBucket = "UNKNOWN";
        
        for (let i = 0; i < lines.length; i++) {
            let l = lines[i];
            if (!l) continue;

            // Bucket headers - only if next line is "Pool" (to avoid confusing with "Single" DEX type)
            if (BUCKET_ORDER.includes(l.toUpperCase())) {
                // Check next line to confirm it's a bucket header, not a DEX
                let nextLine = lines[i + 1]?.trim();
                if (nextLine === 'Pool') {
                    currentBucket = l.toUpperCase();
                    continue;
                }
            }

            // Skip nav/junk lines
            if (/^(LIQUIDITY|VOTE|LOCK|INCENTIVIZE|DASHBOARD|AMPLIFY|GOV|ARBITRAGE|ALLIANCE|icon)/i.test(l)) continue;

            // DEX line = start of pool (pool name is previous line)
            // Match all DEX variants: Astroport, Skeleton Swap, White Whale, WhiteWhale, WW, Single
            let dexMatch = l.match(/^(Astroport|Skeleton\s*Swap|White\s*Whale|WhiteWhale|WW|Single)/i);
            if (dexMatch && i > 0) {
                let poolName = lines[i-1];
                if (!poolName || /^icon/i.test(poolName)) continue;
                
                // Normalize the DEX name (White Whale -> Skeleton Swap, etc.)
                let normalizedDex = normalizeDexName(dexMatch[1]);
                
                // Debug: log single asset detection
                if (dexMatch[1].toLowerCase() === 'single') {
                    console.log('Found Single asset:', poolName, '-> DEX line:', l);
                }
                
                let p = { 
                    n: normalizeName(poolName.replace(' LP', '')), 
                    d: normalizedDex,  // Use normalized DEX name
                    b: currentBucket, 
                    tvp: 0, dp: 0, vol: 0, mvp: 0, vps: 0, ms: 0,
                    // Bribes
                    inc: 0, incPD: 0, incOther: 0, incTotal: 0,
                    // Votion
                    votNowVp: 0, votNowPct: 0, votNextVp: 0, votNextPct: 0,
                    apr: '-'
                };
                
                // Scan forward until "Create locks" (end of pool block)
                for (let k = i + 1; k < i + 20; k++) {
                    let x = lines[k];
                    if (!x) continue;
                    if (x === 'Create locks') break;
                    
                    // Total VP: "VP 15.85M  76.9 %"
                    if (x.startsWith('VP ')) {
                        let vpM = x.match(/VP\s*([\d\.]+)([KkMm]?)\s+([\d\.]+)\s*%/);
                        if (vpM) {
                            p.tvp = parseNum(vpM[1] + (vpM[2] || ''));
                            p.vps = parseFloat(vpM[3]);
                        }
                    }
                    // Depth: "Depth $ 562.97K"
                    else if (x.startsWith('Depth')) {
                        p.dp = parseNum(x);
                    }
                    // Incentives: "$ 16.94" (starts with $) - This is TOTAL bribes from Vote page
                    else if (x.startsWith('$')) {
                        let bribeVal = parseNum(x);
                        p.inc = bribeVal;
                        p.incTotal = bribeVal; // Total bribes from Vote page
                        // incPD will be set from ext file, incOther = incTotal - incPD
                    }
                    // After "Extend locks" comes user VP
                    else if (x === 'Extend locks') {
                        let userVpLine = lines[k + 1];
                        let userShareLine = lines[k + 2];
                        if (userVpLine?.match(/VP$/i)) {
                            p.mvp = parseNum(userVpLine);
                        }
                        if (userShareLine?.match(/^[\d\.,]+\s*%$/)) {
                            p.ms = parseFloat(userShareLine);
                        }
                    }
                    // vAPR: first standalone % line (not a range with -)
                    else if (x.match(/^[\d\.]+\s*%$/) && p.apr === '-') {
                        p.apr = x;
                    }
                }
                
                store.vote.pools.push(p);
            }
        }
        
        // Debug: log all parsed pools
        console.log('Vote parsing complete. Pools by DEX:');
        let byDex = {};
        store.vote.pools.forEach(p => {
            let dex = isAstroport(p.d) ? (p.d.includes('Single') ? 'Single' : 'Astroport') : 'Skeleton Swap';
            if (!byDex[dex]) byDex[dex] = [];
            byDex[dex].push(p.n);
        });
        Object.entries(byDex).forEach(([dex, pools]) => {
            console.log(`  ${dex}: ${pools.length} pools -`, pools.join(', '));
        });
        
        setTxt('status-vote-page', "PARSED");
        $('status-vote-page').className = "text-[9px] text-green-400 font-bold";
        pasteStatus.vote = true;
        updatePasteStatus('ps-vote', true);
        applyExtDataToPools();
        renderVoteTable();
    } catch(e) {
        console.error(e);
        alert("Error parsing vote data. Check console.");
    }
}

function renderVoteTable() {
    setTxt('vote-ep', store.vote.ep);
    setTxt('vote-end', store.vote.end);
    setTxt('vote-tvp', store.vote.tvp.toLocaleString(undefined, {maximumFractionDigits: 0}));
    setTxt('vote-adao-vp', store.dao.lVp ? store.dao.lVp.toLocaleString() : '-');
    
    // Calculate aDAO percentage of total TLA
    if (store.vote.tvp > 0 && store.dao.lVp > 0) {
        setTxt('vote-adao-pct', ((store.dao.lVp / store.vote.tvp) * 100).toFixed(2) + '%');
    } else {
        setTxt('vote-adao-pct', '-');
    }
    
    // Calculate phase from epoch end time (most accurate) or ends string
    let totalDays = 0;
    
    if (currentEpochInfo?.end_time) {
        // Use exact epoch end time for precision
        let endTime = new Date(currentEpochInfo.end_time);
        let msUntilEnd = endTime - new Date();
        totalDays = msUntilEnd / 86400000; // Decimal days
    } else {
        // Fallback to parsed ends string
        let daysMatch = store.vote.end.match(/(\d+)\s*d/i);
        let hoursMatch = store.vote.end.match(/(\d+)\s*h/i);
        if (daysMatch) totalDays += parseInt(daysMatch[1]);
        if (hoursMatch) totalDays += parseInt(hoursMatch[1]) / 24;
    }
    
    let phase = 'End', phaseColor = 'text-red-400';
    if (totalDays >= 5) { phase = 'Start'; phaseColor = 'text-green-400'; }
    else if (totalDays > 2) { phase = 'Mid'; phaseColor = 'text-yellow-400'; }
    
    const phaseEl = $('vote-phase');
    if (phaseEl) { 
        // Show phase and ext file status
        let extPhase = store.ext.votion ? (store.ext.meta?.phase || 'loaded') : 'none';
        let extIndicator = store.ext.votion ? ` <span class="text-[9px] text-gray-500">(ext: ${extPhase})</span>` : '';
        phaseEl.innerHTML = phase + extIndicator; 
        phaseEl.className = phaseColor + ' font-bold'; 
    }
    
    setTxt('vote-rebase', store.vote.reb.toLocaleString() + ' amp');
    setTxt('vote-claim', fmt$(store.vote.usd));

    // Read GRADE filter settings (affects scoring/ranking)
    let gradeAstro = $('grade-astro')?.checked ?? true;
    let gradeWW = $('grade-ww')?.checked ?? true;
    let gradeInactive = $('grade-inactive')?.checked ?? true;
    
    // Read EXPORT filter settings (affects JSON output only)
    let exportAstro = $('export-astro')?.checked ?? true;
    let exportWW = $('export-ww')?.checked ?? true;
    let exportInactive = $('export-inactive')?.checked ?? true;
    let showADAO = $('export-adao')?.checked ?? true;
    
    let gradeSettings = { showAstro: gradeAstro, showWW: gradeWW, showInactive: gradeInactive };

    // Calculate all aDAO scores with current GRADE filter settings
    // Scores are ranked relative to what's selected for grading
    calculateAllScores(gradeSettings);

    // === CALCULATE DEX STATS ===
    let dexStats = {
        astro: { active: 0, inactive: 0, depth: 0, tlaVp: 0, adaoVp: 0 },
        ww: { active: 0, inactive: 0, depth: 0, tlaVp: 0, adaoVp: 0 }
    };
    
    let totalTlaVp = 0;
    let totalAdaoVp = 0;
    
    store.vote.pools.forEach(p => {
        let isActive = p.vps >= 1;
        totalTlaVp += p.tvp;
        totalAdaoVp += p.mvp;
        
        if (isAstroport(p.d)) {
            if (isActive) dexStats.astro.active++; else dexStats.astro.inactive++;
            dexStats.astro.depth += p.dp;
            dexStats.astro.tlaVp += p.tvp;
            dexStats.astro.adaoVp += p.mvp;
        }
        if (isSkeletonSwap(p.d)) {
            if (isActive) dexStats.ww.active++; else dexStats.ww.inactive++;
            dexStats.ww.depth += p.dp;
            dexStats.ww.tlaVp += p.tvp;
            dexStats.ww.adaoVp += p.mvp;
        }
    });
    
    // Update DEX tables
    setTxt('dex-astro-active', dexStats.astro.active);
    setTxt('dex-astro-inactive', dexStats.astro.inactive);
    setTxt('dex-astro-depth', fmt$(dexStats.astro.depth));
    setTxt('dex-astro-tla-pct', totalTlaVp > 0 ? ((dexStats.astro.tlaVp / totalTlaVp) * 100).toFixed(1) + '%' : '0%');
    setTxt('dex-astro-adao-pct', totalAdaoVp > 0 ? ((dexStats.astro.adaoVp / totalAdaoVp) * 100).toFixed(1) + '%' : '0%');
    
    setTxt('dex-ww-active', dexStats.ww.active);
    setTxt('dex-ww-inactive', dexStats.ww.inactive);
    setTxt('dex-ww-depth', fmt$(dexStats.ww.depth));
    setTxt('dex-ww-tla-pct', totalTlaVp > 0 ? ((dexStats.ww.tlaVp / totalTlaVp) * 100).toFixed(1) + '%' : '0%');
    setTxt('dex-ww-adao-pct', totalAdaoVp > 0 ? ((dexStats.ww.adaoVp / totalAdaoVp) * 100).toFixed(1) + '%' : '0%');

    // === RENDER POOL TABLE ===
    // Sort: by bucket, then Active A-Z, then Inactive A-Z
    let sortedPools = [...store.vote.pools].sort((a, b) => {
        // 1. By bucket order
        let biA = BUCKET_ORDER.indexOf(a.b); if (biA === -1) biA = 99;
        let biB = BUCKET_ORDER.indexOf(b.b); if (biB === -1) biB = 99;
        if (biA !== biB) return biA - biB;
        
        // 2. Active pools first (vps >= 1)
        let aActive = a.vps >= 1 ? 0 : 1;
        let bActive = b.vps >= 1 ? 0 : 1;
        if (aActive !== bActive) return aActive - bActive;
        
        // 3. Alphabetical by name
        return a.n.localeCompare(b.n);
    });

    let finalHtml = '';
    document.querySelectorAll('.adao-col').forEach(el => el.style.display = showADAO ? '' : 'none');

    BUCKET_ORDER.forEach(bucketName => {
        let bucketPools = sortedPools.filter(p => p.b === bucketName);
        if (bucketPools.length === 0) return;

        // Determine which pools are included in grading (for visual indicator)
        bucketPools.forEach(p => {
            let isAct = p.vps >= 1;
            let isAstroOrSingle = isAstroport(p.d);
            let isWW = isSkeletonSwap(p.d);
            
            p.includedInGrade = true;
            if (isAstroOrSingle && !gradeAstro) p.includedInGrade = false;
            if (isWW && !gradeWW) p.includedInGrade = false;
            if (!isAct && !gradeInactive) p.includedInGrade = false;
        });

        // Calculate totals from ALL pools in bucket
        let bTlaVp = bucketPools.reduce((s, p) => s + p.tvp, 0);
        let bAdaoVp = bucketPools.reduce((s, p) => s + p.mvp, 0);
        let bVoteShare = bucketPools.reduce((s, p) => s + p.vps, 0);
        let bAdaoShare = bucketPools.reduce((s, p) => s + p.ms, 0);
        let bIncentives = bucketPools.reduce((s, p) => s + p.inc, 0);

        finalHtml += `<div class="bg-[#1f2937] border-y border-gray-700 py-1 mt-2 mb-1"><div class="flex justify-between items-center px-2"><span class="text-gray-300 font-bold text-[10px] tracking-widest uppercase">${bucketName}</span></div></div>`;

        // Render ALL pools (not filtered)
        bucketPools.forEach(p => {
            let isAct = p.vps >= 1;
            let isAstroOrSingle = isAstroport(p.d);
            
            // Dim pools not included in grading
            let rowOpacity = p.includedInGrade ? '' : 'opacity-40';
            let gradeIndicator = p.includedInGrade ? '' : '<span class="text-[8px] text-gray-500 ml-1">(not graded)</span>';

            let dexColor = isAstroOrSingle ? 'text-blue-600' : 'text-green-400';
            let inactiveText = p.vps < 1 ? '<span class="text-red-500 font-bold text-[11px]">INACT</span>' : '';
            
            // 4Ep averages
            let liq4Ep = p.liq4Ep?.avg || 0;
            let vol4Ep = p.vol4Ep?.avg || 0;
            let liq4EpStr = liq4Ep > 0 ? fmt$(liq4Ep) : '-';
            let vol4EpStr = vol4Ep > 0 ? fmt$(vol4Ep) : '-';
            let liq4EpTitle = p.liq4Ep ? `${p.liq4Ep.count} epochs avg` : 'No ext data';
            let vol4EpTitle = p.vol4Ep ? `${p.vol4Ep.count} epochs avg` : 'No ext data';
            
            // Efficiency
            let effStr = p.efficiency > 0 ? p.efficiency.toFixed(2) : '-';
            let effColor = p.efficiency >= 0.3 ? 'text-green-400' : p.efficiency >= 0.1 ? 'text-yellow-400' : 'text-gray-500';
            
            // Access score
            let accStr = p.accessScore ? p.accessScore.toFixed(0) : '-';
            let accColor = p.accessScore >= 70 ? 'text-green-400' : p.accessScore >= 50 ? 'text-cyan-400' : p.accessScore >= 30 ? 'text-yellow-400' : 'text-gray-500';
            let accTitle = 'No access data';
            if (p.accessData?.source === 'metadata') {
                let b = p.accessData.breakdown;
                let issueCount = b.allIssues?.length || 0;
                accTitle = `${b.asset1.name}: ${b.asset1.score} | ${b.asset2.name}: ${b.asset2.score}`;
                if (issueCount > 0) accTitle += ` | ‚ö†Ô∏è ${issueCount} issues`;
            } else if (p.accessData?.breakdown) {
                accTitle = 'No metadata - using fallback scoring';
            }
            
            // Support score
            let suppStr = p.supportScore?.toFixed(0) || '0';
            let suppColor = p.supportScore >= 60 ? 'text-red-400' : p.supportScore >= 30 ? 'text-yellow-400' : 'text-gray-400';
            
            // aDAO Score
            let scoreStr = p.adaoScore?.toFixed(0) || '0';
            let scoreColor = getScoreColor(p.adaoScore || 0);
            let scoreIcon = getScoreIcon(p.adaoScore || 0);
            
            // APR display (both non and amp)
            let aprNonStr = p.aprNon > 0 ? p.aprNon.toFixed(0) + '%' : '-';
            let aprAmpStr = p.aprAmp > 0 ? p.aprAmp.toFixed(0) + '%' : '';
            let aprColor = p.aprNon < 40 ? 'text-red-400' : p.aprNon < 55 ? 'text-green-400' : p.aprNon < 70 ? 'text-yellow-400' : 'text-orange-400';
            
            let dexShort = p.d.includes('Single') ? 'Single' : isAstroport(p.d) ? 'Astro' : 'SS';
            let dexFull = p.d.includes('Single') ? 'Single' : isAstroport(p.d) ? 'Astroport' : 'Skeleton Swap';
            
            finalHtml += `
            <div class="vote-grid border-b border-gray-800/50 py-2 hover:bg-white/5 px-2 cursor-pointer ${rowOpacity}" onclick="showPoolScoreDetails('${p.n}', '${dexShort}')">
                <div class="flex flex-col justify-center">
                    <div class="flex items-center gap-1">
                        <span class="text-white text-[12px] font-bold truncate" title="${p.n}">${p.n}</span>
                        ${gradeIndicator}
                    </div>
                    <span class="text-[10px] ${dexColor}">${dexFull}</span>
                </div>
                <div class="text-center text-[11px]">${inactiveText}</div>
                <div class="text-right font-mono text-teal-400 text-[11px]" title="${liq4EpTitle}">${liq4EpStr}</div>
                <div class="text-right font-mono text-teal-400 text-[11px]" title="${vol4EpTitle}">${vol4EpStr}</div>
                <div class="text-right font-mono ${effColor} text-[11px]" title="Vol/Liq ratio">${effStr}</div>
                <div class="text-right flex flex-col leading-tight" title="Non-amp / Amplified APR">
                    <span class="font-mono ${aprColor} text-[11px]">${aprNonStr}</span>
                    ${aprAmpStr ? `<span class="font-mono text-yellow-500 text-[10px]">üî•${aprAmpStr}</span>` : ''}
                </div>
                <div class="text-right font-mono ${accColor} text-[11px]" title="${accTitle}">${accStr}</div>
                <div class="text-right flex flex-col leading-tight" title="Votion Current Epoch">
                    ${p.votNowVp > 0 ? `<span class="text-purple-400 font-mono text-[11px] font-bold">${fmtVp(p.votNowVp)}</span><span class="text-purple-400/70 font-mono text-[10px]">${p.votNowPct.toFixed(2)}%</span>` : '<span class="text-gray-600 text-[11px]">-</span>'}
                </div>
                <div class="text-right flex flex-col leading-tight" title="Votion Next Epoch Optimization">
                    ${p.votNextVp > 0 ? `<span class="text-purple-300 font-mono text-[11px] font-bold">${fmtVp(p.votNextVp)}</span><span class="text-purple-300/70 font-mono text-[10px]">${p.votNextPct.toFixed(2)}%</span>` : '<span class="text-gray-600 text-[11px]">-</span>'}
                </div>
                <div class="text-right flex flex-col leading-tight" title="Vote Change">
                    ${(() => {
                        let changeVp = (p.votNextVp || 0) - (p.votNowVp || 0);
                        let changePct = (p.votNextPct || 0) - (p.votNowPct || 0);
                        if (changeVp === 0 && changePct === 0 && p.votNowVp === 0) return '<span class="text-gray-600 text-[11px]">-</span>';
                        let color = changeVp > 0 ? 'text-green-400' : changeVp < 0 ? 'text-red-400' : 'text-gray-500';
                        let sign = changeVp > 0 ? '+' : '';
                        return `<span class="${color} font-mono text-[11px] font-bold">${sign}${fmtVp(changeVp)}</span><span class="${color}/70 font-mono text-[10px]">${sign}${changePct.toFixed(2)}%</span>`;
                    })()}
                </div>
                <div class="text-right flex flex-col leading-tight" title="Total: ${fmt$(p.incTotal || 0)} | PD: ${fmt$(p.incPD || 0)} | Other: ${fmt$(p.incOther || 0)}">
                    ${p.incTotal > 0 ? `
                        <span class="text-green-400 font-mono text-[11px]">${fmt$(p.incTotal)}</span>
                        ${p.incPD > 0 && p.incOther > 0 ? `<span class="text-gray-500 font-mono text-[9px]">${fmt$(p.incPD)} PD</span>` : 
                          p.incPD > 0 ? `<span class="text-green-600 font-mono text-[9px]">PD</span>` : ''}
                    ` : (p.incPD > 0 ? `
                        <span class="text-green-400 font-mono text-[11px]">${fmt$(p.incPD)}</span>
                        <span class="text-green-600 font-mono text-[9px]">PD</span>
                    ` : '<span class="text-gray-600 text-[11px]">-</span>')}
                </div>
                <div class="text-right font-mono ${suppColor} text-[11px]" title="Support score">${suppStr}</div>
                <div class="text-right flex flex-col leading-tight">
                    <span class="text-orange-400 font-mono text-[11px] font-bold">${p.tvp.toLocaleString()}</span>
                    <span class="text-orange-400/70 font-mono text-[10px]">${p.vps.toFixed(2)}%</span>
                </div>
                <div class="text-right flex flex-col leading-tight adao-col" style="${showADAO ? '' : 'display:none;'}">
                    ${p.mvp > 0 ? `<span class="text-cyan-400 font-mono text-[11px] font-bold">${p.mvp.toLocaleString()}</span><span class="text-cyan-400/70 font-mono text-[10px]">${p.ms.toFixed(2)}%</span>` : '<span class="text-gray-700 text-[11px]">-</span>'}
                </div>
                <div class="text-right font-mono ${scoreColor} text-[12px] font-bold" title="aDAO Opportunity Score">${scoreIcon}${scoreStr}</div>
            </div>`;
        });

        // Calculate Votion totals for bucket (from ALL pools)
        let bVotNowVp = bucketPools.reduce((s, p) => s + (p.votNowVp || 0), 0);
        let bVotNowPct = bucketPools.reduce((s, p) => s + (p.votNowPct || 0), 0);
        let bVotNextVp = bucketPools.reduce((s, p) => s + (p.votNextVp || 0), 0);
        let bVotNextPct = bucketPools.reduce((s, p) => s + (p.votNextPct || 0), 0);
        
        // Calculate bucket averages for new metrics (from ALL pools)
        let poolsWithScores = bucketPools.filter(p => p.adaoScore !== undefined);
        let avgScore = poolsWithScores.length > 0 
            ? poolsWithScores.reduce((s, p) => s + p.adaoScore, 0) / poolsWithScores.length 
            : 0;

        finalHtml += `
        <div class="vote-grid bg-indigo-900/40 border-t border-indigo-800 py-2 px-2 font-bold mt-1">
            <div class="text-[11px] text-gray-400 uppercase tracking-widest">${bucketName} TOTALS</div>
            <div></div>
            <div></div>
            <div></div>
            <div></div>
            <div></div>
            <div></div>
            <div class="text-right flex flex-col leading-tight">
                ${bVotNowVp > 0 ? `<span class="text-purple-300 font-mono text-[10px]">${fmtVp(bVotNowVp)}</span><span class="text-purple-300/70 font-mono text-[9px]">${bVotNowPct.toFixed(2)}%</span>` : '<span class="text-gray-600">-</span>'}
            </div>
            <div class="text-right flex flex-col leading-tight">
                ${bVotNextVp > 0 ? `<span class="text-purple-200 font-mono text-[10px]">${fmtVp(bVotNextVp)}</span><span class="text-purple-200/70 font-mono text-[9px]">${bVotNextPct.toFixed(2)}%</span>` : '<span class="text-gray-600">-</span>'}
            </div>
            <div class="text-right flex flex-col leading-tight">
                ${(() => {
                    let changeVp = bVotNextVp - bVotNowVp;
                    let changePct = bVotNextPct - bVotNowPct;
                    if (changeVp === 0 && bVotNowVp === 0) return '<span class="text-gray-600">-</span>';
                    let color = changeVp > 0 ? 'text-green-400' : changeVp < 0 ? 'text-red-400' : 'text-gray-500';
                    let sign = changeVp > 0 ? '+' : '';
                    return `<span class="${color} font-mono text-[10px]">${sign}${fmtVp(changeVp)}</span><span class="${color}/70 font-mono text-[9px]">${sign}${changePct.toFixed(2)}%</span>`;
                })()}
            </div>
            <div class="text-right font-mono text-[11px] text-green-400">${fmt$(bIncentives)}</div>
            <div></div>
            <div class="text-right flex flex-col leading-tight">
                <span class="text-orange-300 font-mono text-[11px]">${bTlaVp.toLocaleString()}</span>
                <span class="text-orange-300/70 font-mono text-[10px]">${bVoteShare.toFixed(2)}%</span>
            </div>
            <div class="text-right flex flex-col leading-tight adao-col" style="${showADAO ? '' : 'display:none;'}">
                <span class="text-cyan-300 font-mono text-[11px]">${bAdaoVp.toLocaleString()}</span>
                <span class="text-cyan-300/70 font-mono text-[10px]">${bAdaoShare.toFixed(2)}%</span>
            </div>
            <div class="text-right font-mono text-[11px] ${getScoreColor(avgScore)}">Avg: ${avgScore.toFixed(0)}</div>
        </div>`;
    });

    setHtml('vote-list', finalHtml);
}

function showIncentives(bucketName) {
    setTxt('mod-inc-bucket-title', "Incentives Breakdown (All Buckets)");
    let html = '';
    let totalInc = 0;
    
    BUCKET_ORDER.forEach(bn => {
        let bucketPools = store.vote.pools.filter(p => p.b === bn && p.inc > 0).sort((a, b) => b.inc - a.inc);
        if (bucketPools.length > 0) {
            html += `<div class="text-[9px] font-bold text-gray-500 uppercase border-b border-gray-800 mt-3 mb-1 px-1">${bn}</div>`;
            bucketPools.forEach(p => {
                totalInc += p.inc;
                html += `<div class="grid grid-cols-12 gap-1 border-b border-gray-800 py-1 hover:bg-gray-800/50 px-1">
                    <div class="col-span-5 truncate text-white" title="${p.n}">${p.n}</div>
                    <div class="col-span-2 text-right text-purple-400">-</div>
                    <div class="col-span-2 text-right text-green-400 font-bold">${fmt$(p.inc)}</div>
                    <div class="col-span-3 text-right text-blue-400">${p.apr}</div>
                </div>`;
            });
        }
    });
    
    if (!html) html = '<div class="text-center text-gray-500 py-4">No incentives found.</div>';
    html += `<div class="grid grid-cols-12 gap-1 text-[9px] text-white uppercase font-bold border-t border-gray-700 pt-2 mt-2 bg-gray-900/90 p-2 rounded">
        <div class="col-span-5">TOTAL</div><div class="col-span-2"></div>
        <div class="col-span-2 text-right text-green-400">${fmt$(totalInc)}</div><div class="col-span-3"></div>
    </div>`;

    setHtml('mod-inc-content', html);
    togModal('incentives', 1);
}

function parseVoteRewards() {
    let txt = $('voteRewardsPaste').value;
    let lines = txt.split('\n').map(x => x.trim()).filter(x => x);
    
    store.dao.vRew = {};
    store.dao.vRewPeriods = [];
    
    let skipNext = false; // Skip lines after "Tx fee"
    
    lines.forEach(x => {
        // Skip "Tx fee" section
        if (x.includes('Tx fee')) {
            skipNext = true;
            return;
        }
        if (skipNext && /LUNA/.test(x)) {
            skipNext = false;
            return; // Skip the fee amount line
        }
        skipNext = false;
        
        // Skip headers and buttons
        if (x.includes('Claim') || x.includes('Claiming') || x.includes('participating')) return;
        
        // Parse periods line: "150,151,152,153,154,155,156,157,158,159,160"
        if (/^\d+(,\d+)+$/.test(x)) {
            store.dao.vRewPeriods = x.split(',').map(n => parseInt(n.trim())).filter(n => !isNaN(n));
            return;
        }
        
        // Parse reward lines: "11 891.29 ASTRO" or "0.00013 wBTC.atom" or "15.06M ROAR"
        // Handle spaces in numbers and M/K suffixes
        let m = x.match(/^([\d\s]+\.?\d*)\s*([MKmk])?\s+([a-zA-Z][a-zA-Z0-9\.]+)/);
        if (m) {
            let numStr = m[1].replace(/\s/g, ''); // Remove spaces from number
            let val = parseFloat(numStr);
            let suffix = m[2]?.toUpperCase();
            let token = m[3];
            
            // Handle M/K suffix
            if (suffix === 'M') val *= 1e6;
            if (suffix === 'K') val *= 1e3;
            
            if (!isNaN(val) && val > 0) {
                store.dao.vRew[token] = val;
            }
        }
    });
    
    // Update modal - Periods
    if (store.dao.vRewPeriods.length > 0) {
        let first = Math.min(...store.dao.vRewPeriods);
        let last = Math.max(...store.dao.vRewPeriods);
        let count = store.dao.vRewPeriods.length;
        setTxt('mod-vote-periods', `${first} - ${last}`);
        setTxt('mod-vote-epoch-count', `${count} Epochs`);
    } else {
        setTxt('mod-vote-periods', '-');
        setTxt('mod-vote-epoch-count', '-');
    }
    
    // Update modal - Token list
    let html = Object.entries(store.dao.vRew).map(([token, amount]) => {
        // Format with appropriate decimals (more for small numbers)
        let formatted = amount < 1 ? amount.toFixed(6) : amount.toLocaleString(undefined, {maximumFractionDigits: 2});
        return `<div class="flex justify-between border-b border-gray-800 py-1">
            <span class="text-gray-400">${token}</span>
            <span class="font-mono text-white">${formatted}</span>
        </div>`;
    }).join('');
    setHtml('mod-vote-list', html || '<div class="text-gray-500">No rewards parsed</div>');
    
    setTxt('status-rewards', "PARSED");
    $('status-rewards').className = "text-[9px] text-green-400 font-bold";
    pasteStatus.voteRew = true;
    updatePasteStatus('ps-vote-rew', true);
}

// === LIQUIDITY PARSING ===
function parseLiquidity() {
    let txt = $('liqFullPage').value;
    let isInactive = $('liqInactiveToggle').checked;
    let lines = txt.split('\n').map(l => l.trim());

    if (!isInactive) {
        let m;
        if (m = txt.match(/TVL[\s\n]+([$\d\.\,\s]+[KkMm]?)/i)) store.tla.tvl = parseNum(m[1]);
        if (m = txt.match(/Rewards per year[\s\n]+([$\d\.\,\s]+[KkMm]?)/i)) store.tla.rewYr = parseNum(m[1]);
        if (m = txt.match(/(Your|Total) Deposit[\s\n]*([$\d\.,\s]+)/i)) store.dao.dep = parseNum(m[2]);
        if (m = txt.match(/(est\. APR|Avg APR)[\s\n]*([\d\.]+)\s*%/i)) store.dao.apr = parseFloat(m[2]);
        
        // Parse unclaimed rewards - format: "Rewards\n406.82$" or "Rewards\n$ 406.82"
        if (m = txt.match(/Rewards[\s\n]+([\d\s\.,]+)\s*\$/i)) {
            store.dao.rew.usd = parseNum(m[1]);
        } else if (m = txt.match(/Rewards[\s\n]+\$\s*([\d\s\.,]+)/i)) {
            store.dao.rew.usd = parseNum(m[1]);
        }
    }

    let parsedPools = [];
    lines.forEach((l, i) => {
        // Match DEX line format: "Astroport - pcl" or "WhiteWhale - stable" or "Skeleton Swap - xyk"
        // Include all variants of White Whale / Skeleton Swap
        if (l.match(/^(Astroport|WhiteWhale|White\s*Whale|Skeleton\s*Swap|Single)/i)) {
            let dexParts = l.split('-').map(x => x.trim());
            let dexRaw = dexParts[0];
            let dex = normalizeDexName(dexRaw); // Normalize to "Skeleton Swap" if WhiteWhale
            let lpType = dexParts[1]?.toLowerCase() || '?';
            
            // Normalize LP type
            if (lpType.includes('pcl')) lpType = 'pcl';
            else if (lpType.includes('stable')) lpType = 'stable';
            else if (lpType.includes('xyk')) lpType = 'xyk';
            else if (lpType.includes('concentrated')) lpType = 'pcl';
            
            let poolName = lines[i-1]?.trim() || '';
            if (!poolName || /^icon/i.test(poolName)) return;
            
            // Normalize pool name for matching
            let normName = normalizeName(poolName.replace(' LP', ''));
            
            // Find bucket from vote data
            let bucket = 'UNKNOWN';
            
            // Single-sided pools go to SINGLE bucket
            if (dex === 'Single' || dex === 'Single (Astroport)' || lpType === 'single') {
                bucket = 'SINGLE';
            } else {
                // Use helper functions to match DEX - handles both WhiteWhale and Skeleton Swap
                let votePool = store.vote.pools.find(vp => {
                    if (vp.n !== normName) return false;
                    // Both should be Skeleton Swap after normalization
                    if (isSkeletonSwap(dex) && isSkeletonSwap(vp.d)) return true;
                    if (isAstroport(dex) && isAstroport(vp.d)) return true;
                    return false;
                });
                if (votePool) bucket = votePool.b;
            }
            
            let p = { 
                name: poolName, 
                normName: normName,
                dex: dex,  // Already normalized above
                type: lpType, 
                bucket: bucket,
                depth: 0, 
                stk: 0, 
                aprNon: 0,      // Non-amplified APR
                aprAmp: 0,      // Amplified APR
                rYr: 0,         // Rewards per year
                adaoNon: 0,     // Non-amp aDAO deposit
                adaoAmp: 0,     // Amplified aDAO deposit
                inactive: isInactive 
            };
            
            let foundDepth = false;
            let foundStk = false;
            let foundRewards = false;
            let adaoDeposits = [];
            
            for (let k = 1; k < 20; k++) {
                // Stop at next pool - include all DEX variants
                if (lines[i+k+1]?.match(/^(Astroport|WhiteWhale|White\s*Whale|Skeleton\s*Swap|Single)/i)) break;
                let nl = lines[i+k];
                if (!nl) continue;
                
                // Depth line
                if (nl.startsWith('Depth')) {
                    p.depth = parseNum(nl);
                    foundDepth = true;
                    continue;
                }
                
                // TLA Staked - first $ after Depth (not Rewards line)
                if (foundDepth && !foundStk && nl.startsWith('$') && !nl.includes('Rewards')) {
                    p.stk = parseNum(nl);
                    foundStk = true;
                    continue;
                }
                
                // APR with % = Non-amplified (e.g., "54.09 %")
                if (foundStk && !foundRewards && nl.match(/^[\d\s\.]+%$/)) {
                    p.aprNon = parseFloat(nl.replace(/[^\d\.]/g, ''));
                    continue;
                }
                
                // APR without % = Amplified (e.g., "70.20" - just a number, possibly with spaces)
                if (foundStk && !foundRewards && nl.match(/^[\d\s\.]+$/) && !nl.startsWith('$')) {
                    let val = parseFloat(nl.replace(/\s/g, ''));
                    if (val > 0 && val < 500) { // Reasonable APR range
                        p.aprAmp = val;
                    }
                    continue;
                }
                
                // Rewards line
                if (nl.startsWith('Rewards')) {
                    p.rYr = parseNum(nl);
                    foundRewards = true;
                    continue;
                }
                
                // aDAO deposits - $ lines after Rewards
                if (foundRewards && nl.match(/^\$\s*[\d\s\.,]+/)) {
                    adaoDeposits.push(parseNum(nl));
                    continue;
                }
                
                // Stop at Deposit/Amplify buttons
                if (nl === 'Deposit' || nl === 'Amplify') break;
            }
            
            // Assign aDAO deposits based on APR types found
            if (adaoDeposits.length > 0) {
                if (p.aprNon > 0 && p.aprAmp > 0) {
                    // Both APR types: first is non-amp, second is amp
                    p.adaoNon = adaoDeposits[0] || 0;
                    p.adaoAmp = adaoDeposits[1] || 0;
                } else if (p.aprNon > 0) {
                    // Only non-amp APR: deposit is non-amp
                    p.adaoNon = adaoDeposits[0] || 0;
                } else if (p.aprAmp > 0) {
                    // Only amp APR: deposit is amp
                    p.adaoAmp = adaoDeposits[0] || 0;
                } else {
                    // Fallback: assume non-amp
                    p.adaoNon = adaoDeposits[0] || 0;
                }
            }
            
            if (p.depth > 0 || p.stk > 0) parsedPools.push(p);
        }
    });
    
    if (isInactive) {
        store.tla.inactivePools = parsedPools;
        pasteStatus.liqInactive = true;
        updatePasteStatus('ps-liq-inactive', true);
    } else {
        store.tla.pools = parsedPools;
        pasteStatus.liqActive = true;
        updatePasteStatus('ps-liq-active', true);
    }
    renderLiquidityTable();
    
    // Re-apply ext data to update APR on vote pools
    if (store.ext.loaded) {
        applyExtDataToPools();
        renderVoteTable();
    }
}

function renderLiquidityTable() {
    setTxt('tla-tvl', fmt$(store.tla.tvl));
    setTxt('tla-rew', fmt$(store.tla.rewYr));
    setTxt('tla-rew-ep', fmt$(store.tla.rewYr / 52));
    setTxt('dao-dep', fmt$(store.dao.dep));
    setTxt('dao-apr', store.dao.apr + '%');
    setTxt('dao-usd', fmt$(store.dao.rew.usd || 0));
    
    // Use arrays directly - don't combine and re-filter
    let activePools = [...(store.tla.pools || [])];
    let inactivePools = [...(store.tla.inactivePools || [])];
    
    // Calculate DEX stats from active pools only
    let dexStats = {
        astro: { count: 0, depth: 0, stk: 0 },
        ww: { count: 0, depth: 0, stk: 0 }
    };
    
    activePools.forEach(p => {
        if (isAstroport(p.dex)) {
            dexStats.astro.count++;
            dexStats.astro.depth += p.depth;
            dexStats.astro.stk += p.stk;
        } else if (isSkeletonSwap(p.dex)) {
            dexStats.ww.count++;
            dexStats.ww.depth += p.depth;
            dexStats.ww.stk += p.stk;
        }
    });
    
    // Update DEX stat displays
    setTxt('liq-astro-active', dexStats.astro.count);
    setTxt('liq-astro-depth', fmt$(dexStats.astro.depth));
    setTxt('liq-astro-stk', fmt$(dexStats.astro.stk));
    setTxt('liq-astro-pct', dexStats.astro.depth > 0 ? ((dexStats.astro.stk / dexStats.astro.depth) * 100).toFixed(1) + '%' : '0%');
    
    setTxt('liq-ww-active', dexStats.ww.count);
    setTxt('liq-ww-depth', fmt$(dexStats.ww.depth));
    setTxt('liq-ww-stk', fmt$(dexStats.ww.stk));
    setTxt('liq-ww-pct', dexStats.ww.depth > 0 ? ((dexStats.ww.stk / dexStats.ww.depth) * 100).toFixed(1) + '%' : '0%');
    
    // Calculate % of TVL for each DEX
    let totalDexStk = dexStats.astro.stk + dexStats.ww.stk;
    setTxt('liq-astro-tvl', totalDexStk > 0 ? ((dexStats.astro.stk / totalDexStk) * 100).toFixed(1) + '%' : '0%');
    setTxt('liq-ww-tvl', totalDexStk > 0 ? ((dexStats.ww.stk / totalDexStk) * 100).toFixed(1) + '%' : '0%');
    
    // Sort active by bucket, then alphabetically within bucket
    activePools.sort((a, b) => {
        let biA = BUCKET_ORDER.indexOf(a.bucket); if (biA === -1) biA = 99;
        let biB = BUCKET_ORDER.indexOf(b.bucket); if (biB === -1) biB = 99;
        if (biA !== biB) return biA - biB;
        return a.name.localeCompare(b.name);
    });
    
    // Sort inactive by TLA Staked (stk) descending - most deposits first
    inactivePools.sort((a, b) => (b.stk || 0) - (a.stk || 0));
    
    let html = '';
    let grandTotals = { depth: 0, stk: 0, rYr: 0, adaoNon: 0, adaoAmp: 0 };
    
    // Render active pools by bucket with subtotals
    let currentBucket = null;
    let bucketPools = [];
    
    const renderBucketSubtotal = (bucket, pools) => {
        let totals = pools.reduce((acc, p) => {
            acc.depth += p.depth;
            acc.stk += p.stk;
            acc.rYr += p.rYr;
            acc.adaoNon += p.adaoNon || 0;
            acc.adaoAmp += p.adaoAmp || 0;
            return acc;
        }, { depth: 0, stk: 0, rYr: 0, adaoNon: 0, adaoAmp: 0 });
        
        let tlaPct = totals.depth > 0 ? ((totals.stk / totals.depth) * 100) : 0;
        
        // Add to grand totals
        grandTotals.depth += totals.depth;
        grandTotals.stk += totals.stk;
        grandTotals.rYr += totals.rYr;
        grandTotals.adaoNon += totals.adaoNon;
        grandTotals.adaoAmp += totals.adaoAmp;
        
        return `<div class="liq-grid bg-gray-800/60 border-t border-gray-600 py-1.5 px-2">
            <div class="text-[11px] text-gray-400 font-bold">${bucket} Total</div>
            <div></div><div></div>
            <div class="text-right font-mono text-[11px] text-gray-300">${fmt$(totals.depth)}</div>
            <div class="text-right font-mono text-[11px] text-orange-300">${fmt$(totals.stk)}</div>
            <div class="text-right font-mono text-[11px] text-orange-200">${tlaPct.toFixed(1)}%</div>
            <div></div><div></div>
            <div class="text-right font-mono text-[11px] text-green-300">${fmt$(totals.rYr)}</div>
            <div class="text-right font-mono text-[11px] text-green-300">${fmt$(totals.rYr / 52)}</div>
            <div class="text-right font-mono text-[11px] text-cyan-300">${totals.adaoNon > 0 ? fmt$(totals.adaoNon) : '-'}</div>
            <div class="text-right font-mono text-[11px] text-yellow-300">${totals.adaoAmp > 0 ? fmt$(totals.adaoAmp) : '-'}</div>
        </div>`;
    };
    
    activePools.forEach((p, idx) => {
        // New bucket - render previous bucket's subtotal first
        if (p.bucket !== currentBucket) {
            if (currentBucket && bucketPools.length > 0) {
                html += renderBucketSubtotal(currentBucket, bucketPools);
            }
            currentBucket = p.bucket;
            bucketPools = [];
            
            html += `<div class="bg-[#1f2937] border-y border-gray-700 py-1 mt-2 mb-1">
                <div class="flex justify-between items-center px-2">
                    <span class="text-gray-300 font-bold text-[10px] tracking-widest uppercase">${currentBucket}</span>
                </div>
            </div>`;
        }
        
        bucketPools.push(p);
        
        let dexColor = isAstroport(p.dex) ? 'text-blue-500' : (p.dex === 'Single' ? 'text-purple-400' : 'text-green-400');
        let tlaDepthPct = p.depth > 0 ? ((p.stk / p.depth) * 100) : 0;
        
        html += `<div class="liq-grid border-b border-gray-800/50 py-1.5 hover:bg-white/5 px-2">
            <div class="flex flex-col justify-center">
                <span class="text-white text-[12px] font-bold truncate" title="${p.name}">${p.normName || p.name}</span>
            </div>
            <div class="text-center text-[11px] ${dexColor}">${p.dex === 'Single' ? 'Single' : isAstroport(p.dex) ? 'Astroport' : 'Skeleton Swap'}</div>
            <div class="text-center text-[11px] text-gray-500">${p.type}</div>
            <div class="text-right font-mono text-[11px] text-gray-400">${fmt$(p.depth)}</div>
            <div class="text-right font-mono text-[11px] text-orange-400">${fmt$(p.stk)}</div>
            <div class="text-right font-mono text-[11px] text-orange-300">${tlaDepthPct > 0 ? tlaDepthPct.toFixed(1) + '%' : '-'}</div>
            <div class="text-right font-mono text-[11px] text-green-400">${p.aprNon > 0 ? p.aprNon.toFixed(1) + '%' : '-'}</div>
            <div class="text-right font-mono text-[11px] text-yellow-400">${p.aprAmp > 0 ? p.aprAmp.toFixed(1) + '%' : '-'}</div>
            <div class="text-right font-mono text-[11px] text-green-400">${fmt$(p.rYr)}</div>
            <div class="text-right font-mono text-[11px] text-green-400">${fmt$(p.rYr / 52)}</div>
            <div class="text-right font-mono text-[11px] text-cyan-400">${p.adaoNon > 0 ? fmt$(p.adaoNon) : '-'}</div>
            <div class="text-right font-mono text-[11px] text-yellow-400">${p.adaoAmp > 0 ? fmt$(p.adaoAmp) : '-'}</div>
        </div>`;
    });
    
    // Last bucket subtotal
    if (currentBucket && bucketPools.length > 0) {
        html += renderBucketSubtotal(currentBucket, bucketPools);
    }
    
    // Render inactive pools at bottom
    if (inactivePools.length > 0) {
        html += `<div class="bg-red-900/30 border-y border-red-900/50 py-1 mt-4 mb-1">
            <div class="flex justify-between items-center px-2">
                <span class="text-red-400 font-bold text-[10px] tracking-widest uppercase">INACTIVE POOLS (${inactivePools.length})</span>
                <span class="text-[9px] text-gray-500">Sorted by TLA Deposits</span>
            </div>
        </div>`;
        
        let inactiveTotals = { depth: 0, stk: 0, rYr: 0, adaoNon: 0, adaoAmp: 0 };
        
        inactivePools.forEach(p => {
            let dexColor = isAstroport(p.dex) ? 'text-blue-500' : (p.dex === 'Single' ? 'text-purple-400' : 'text-green-400');
            let tlaDepthPct = p.depth > 0 ? ((p.stk / p.depth) * 100) : 0;
            
            inactiveTotals.depth += p.depth;
            inactiveTotals.stk += p.stk;
            inactiveTotals.rYr += p.rYr;
            inactiveTotals.adaoNon += p.adaoNon || 0;
            inactiveTotals.adaoAmp += p.adaoAmp || 0;
            
            html += `<div class="liq-grid border-b border-gray-800/50 py-1.5 hover:bg-white/5 px-2 opacity-60">
                <div class="flex flex-col justify-center">
                    <span class="text-white text-[11px] font-bold truncate" title="${p.name}">${p.normName || p.name}</span>
                    <span class="text-gray-600 text-[9px]">${p.bucket}</span>
                </div>
                <div class="text-center text-[10px] ${dexColor}">${p.dex === 'Single' ? 'Single' : isAstroport(p.dex) ? 'Astro' : 'SS'}</div>
                <div class="text-center text-[10px] text-gray-500">${p.type}</div>
                <div class="text-right font-mono text-[10px] text-gray-400">${fmt$(p.depth)}</div>
                <div class="text-right font-mono text-[10px] text-orange-400">${fmt$(p.stk)}</div>
                <div class="text-right font-mono text-[10px] text-orange-300">${tlaDepthPct > 0 ? tlaDepthPct.toFixed(1) + '%' : '-'}</div>
                <div class="text-right font-mono text-[10px] text-green-400">${p.aprNon > 0 ? p.aprNon.toFixed(1) + '%' : '-'}</div>
                <div class="text-right font-mono text-[10px] text-yellow-400">${p.aprAmp > 0 ? p.aprAmp.toFixed(1) + '%' : '-'}</div>
                <div class="text-right font-mono text-[10px] text-green-400">${fmt$(p.rYr)}</div>
                <div class="text-right font-mono text-[10px] text-green-400">${fmt$(p.rYr / 52)}</div>
                <div class="text-right font-mono text-[10px] text-cyan-400">${p.adaoNon > 0 ? fmt$(p.adaoNon) : '-'}</div>
                <div class="text-right font-mono text-[10px] text-yellow-400">${p.adaoAmp > 0 ? fmt$(p.adaoAmp) : '-'}</div>
            </div>`;
        });
        
        // Inactive subtotal
        let inactivePct = inactiveTotals.depth > 0 ? ((inactiveTotals.stk / inactiveTotals.depth) * 100) : 0;
        html += `<div class="liq-grid bg-red-900/30 border-t border-red-800 py-1.5 px-2">
            <div class="text-[11px] text-red-300 font-bold">Inactive Total</div>
            <div></div><div></div>
            <div class="text-right font-mono text-[11px] text-gray-400">${fmt$(inactiveTotals.depth)}</div>
            <div class="text-right font-mono text-[11px] text-orange-300">${fmt$(inactiveTotals.stk)}</div>
            <div class="text-right font-mono text-[11px] text-orange-200">${inactivePct.toFixed(1)}%</div>
            <div></div><div></div>
            <div class="text-right font-mono text-[11px] text-green-300">${fmt$(inactiveTotals.rYr)}</div>
            <div class="text-right font-mono text-[11px] text-green-300">${fmt$(inactiveTotals.rYr / 52)}</div>
            <div class="text-right font-mono text-[11px] text-cyan-300">${inactiveTotals.adaoNon > 0 ? fmt$(inactiveTotals.adaoNon) : '-'}</div>
            <div class="text-right font-mono text-[11px] text-yellow-300">${inactiveTotals.adaoAmp > 0 ? fmt$(inactiveTotals.adaoAmp) : '-'}</div>
        </div>`;
        
        // Add inactive to grand totals
        grandTotals.depth += inactiveTotals.depth;
        grandTotals.stk += inactiveTotals.stk;
        grandTotals.rYr += inactiveTotals.rYr;
        grandTotals.adaoNon += inactiveTotals.adaoNon;
        grandTotals.adaoAmp += inactiveTotals.adaoAmp;
    }
    
    // Grand Total
    let grandPct = grandTotals.depth > 0 ? ((grandTotals.stk / grandTotals.depth) * 100) : 0;
    html += `<div class="liq-grid bg-indigo-900/50 border-t-2 border-indigo-500 py-2 px-2 mt-3">
        <div class="text-[12px] text-white font-bold uppercase">Grand Total</div>
        <div></div><div></div>
        <div class="text-right font-mono text-[12px] text-white font-bold">${fmt$(grandTotals.depth)}</div>
        <div class="text-right font-mono text-[12px] text-orange-400 font-bold">${fmt$(grandTotals.stk)}</div>
        <div class="text-right font-mono text-[12px] text-orange-300 font-bold">${grandPct.toFixed(1)}%</div>
        <div></div><div></div>
        <div class="text-right font-mono text-[12px] text-green-400 font-bold">${fmt$(grandTotals.rYr)}</div>
        <div class="text-right font-mono text-[12px] text-green-400 font-bold">${fmt$(grandTotals.rYr / 52)}</div>
        <div class="text-right font-mono text-[12px] text-cyan-400 font-bold">${grandTotals.adaoNon > 0 ? fmt$(grandTotals.adaoNon) : '-'}</div>
        <div class="text-right font-mono text-[12px] text-yellow-400 font-bold">${grandTotals.adaoAmp > 0 ? fmt$(grandTotals.adaoAmp) : '-'}</div>
    </div>`;
    
    setHtml('liq-list', html || '<div class="text-gray-500 text-center py-4">No pools parsed. Parse Vote tab first for bucket assignments.</div>');
}

function parseDeposits() {
    let raw = $('liqDeposits').value.trim();
    store.dao.toks = raw.split('\n').map(l => {
        let p = l.trim().split(/\s+/);
        if (p.length < 2) return null;
        let val = parseFloat(p[0]);
        return isNaN(val) ? { s: p[0], a: parseNum(p[1]) } : { s: p[1], a: parseNum(p[0]) };
    }).filter(x => x);
    
    setHtml('mod-tok-list', store.dao.toks.map(t => 
        `<div class="flex justify-between border-b border-gray-800"><span class="text-gray-400">${t.s}</span><span class="font-mono">${t.a.toLocaleString()}</span></div>`
    ).join(''));
    
    pasteStatus.liqDep = true;
    updatePasteStatus('ps-liq-dep', true);
}

function parseRewards() {
    let txt = $('liqRewards').value;
    let zMatch = txt.match(/zAssets\s*([\d\s\.,]+)/); if (zMatch) store.dao.rew.z = parseNum(zMatch[1]);
    let ampMatch = txt.match(/Received\s*([\d\s\.,]+)\s*ampLUNA/); if (ampMatch) store.dao.rew.amp = parseNum(ampMatch[1]);
    setTxt('dao-rew-z', store.dao.rew.z.toLocaleString());
    setTxt('dao-rew-amp', store.dao.rew.amp.toLocaleString());
    
    pasteStatus.liqRew = true;
    updatePasteStatus('ps-liq-rew', true);
}

// === LOCKS PARSING ===
function parseLocks() {
    let t = $('locksPaste').value;
    
    // Parse VP - handle spaces in numbers
    let vpMatch = t.match(/Your Voting Power\s*([\d\.\s,KkMm]+)\s*VP/);
    if (vpMatch) store.dao.lVp = parseNum(vpMatch[1]);
    
    // Parse factor & assets
    let facMatch = t.match(/Power Factor\s*([\d\.]+)\s*x/i);
    if (facMatch) store.dao.lFac = parseFloat(facMatch[1]);
    
    // Parse underlying assets - handle ~63.88K__LUNA__ format
    let astMatch = t.match(/Underlying Assets\s*~?([\d\.\s,KkMm]+)/i);
    if (astMatch) store.dao.lAst = parseNum(astMatch[1]);
    
    store.dao.locks = [];
    let chunks = t.split(/Lock #/i);
    for (let i = 1; i < chunks.length; i++) {
        let c = chunks[i];
        let idMatch = c.match(/^(\d+)/);
        if (!idMatch) continue;
        
        let id = idMatch[1];
        let amtMatch = c.match(/([\d\.\s,]+[KkMm]?)\s+(arbLUNA|ampLUNA|bLUNA|LUNA)/);
        let amt = amtMatch ? parseNum(amtMatch[1]) : 0;
        let asset = amtMatch ? amtMatch[2] : 'Unknown';
        
        // Determine bucket from asset type
        let bucket = 'LUNA';
        if (asset === 'arbLUNA') bucket = 'arbLUNA';
        else if (asset === 'ampLUNA') bucket = 'ampLUNA';
        else if (asset === 'bLUNA') bucket = 'bLUNA';
        
        let vpMatchC = c.match(/([\d\.\s,]+[KkMm]?)\s*VP/);
        let vp = vpMatchC ? parseNum(vpMatchC[1]) : 0;
        
        // Handle European number format: $ 4 968.73 (spaces in numbers)
        let usdMatch = c.match(/\$\s*([\d\s,\.]+)/);
        let usd = usdMatch ? parseNum(usdMatch[1]) : 0;
        
        let status = c.toLowerCase().includes('auto max-lock') ? "Max Lock (Auto)" : "Manual";
        store.dao.locks.push({ id, amt, asset, bucket, vp, usd, status });
    }
    
    pasteStatus.locks = true;
    updatePasteStatus('ps-locks', true);
    renderLocks();
}

function renderLocks() {
    // Update header stats
    setTxt('locks-vp', store.dao.lVp.toLocaleString() + ' VP');
    setTxt('locks-factor', store.dao.lFac ? store.dao.lFac.toFixed(2) + 'x' : '-');
    setTxt('locks-assets', store.dao.lAst ? store.dao.lAst.toLocaleString() + ' LUNA' : '-');
    
    // Group locks by bucket
    const LOCK_BUCKETS = ['arbLUNA', 'ampLUNA', 'bLUNA', 'LUNA'];
    let html = '';
    let grandTotals = { amt: 0, usd: 0, vp: 0 };
    
    LOCK_BUCKETS.forEach(bucket => {
        let bucketLocks = store.dao.locks.filter(l => l.bucket === bucket);
        if (bucketLocks.length === 0) return;
        
        // Bucket header
        let bucketColor = bucket === 'arbLUNA' ? 'text-orange-400' : 
                          bucket === 'ampLUNA' ? 'text-cyan-400' : 
                          bucket === 'bLUNA' ? 'text-green-400' : 'text-purple-400';
        
        html += `<div class="bg-[#1f2937] border-y border-gray-700 py-1 mt-2 mb-1">
            <div class="px-2">
                <span class="${bucketColor} font-bold text-[10px] tracking-widest uppercase">${bucket}</span>
                <span class="text-gray-500 text-[9px] ml-2">(${bucketLocks.length} lock${bucketLocks.length > 1 ? 's' : ''})</span>
            </div>
        </div>`;
        
        let bucketTotals = { amt: 0, usd: 0, vp: 0 };
        
        bucketLocks.forEach(l => {
            bucketTotals.amt += l.amt;
            bucketTotals.usd += l.usd;
            bucketTotals.vp += l.vp;
            
            html += `<div class="grid grid-cols-12 gap-2 text-[10px] border-b border-gray-800/50 py-1 hover:bg-white/5 px-1">
                <div class="col-span-1 text-purple-400 font-bold">#${l.id}</div>
                <div class="col-span-2 text-gray-500 text-[9px]">${l.status}</div>
                <div class="col-span-3 text-white font-mono">${l.amt.toLocaleString()} <span class="${bucketColor}">${l.asset}</span></div>
                <div class="col-span-3 text-right text-green-400 font-mono">${fmt$(l.usd)}</div>
                <div class="col-span-3 text-right text-white font-bold font-mono">${l.vp.toLocaleString()} VP</div>
            </div>`;
        });
        
        // Bucket subtotal
        html += `<div class="grid grid-cols-12 gap-2 text-[9px] bg-gray-800/50 py-1 px-1 border-t border-gray-600">
            <div class="col-span-3 text-gray-400 font-bold">${bucket} Total</div>
            <div class="col-span-3 text-gray-300 font-mono">${bucketTotals.amt.toLocaleString()}</div>
            <div class="col-span-3 text-right text-green-300 font-mono">${fmt$(bucketTotals.usd)}</div>
            <div class="col-span-3 text-right text-gray-300 font-bold font-mono">${bucketTotals.vp.toLocaleString()} VP</div>
        </div>`;
        
        grandTotals.amt += bucketTotals.amt;
        grandTotals.usd += bucketTotals.usd;
        grandTotals.vp += bucketTotals.vp;
    });
    
    // Grand total
    if (store.dao.locks.length > 0) {
        html += `<div class="grid grid-cols-12 gap-2 text-[10px] bg-indigo-900/50 py-2 px-1 mt-3 border-t-2 border-indigo-500">
            <div class="col-span-6 text-white font-bold uppercase">Grand Total</div>
            <div class="col-span-3 text-right text-green-400 font-mono font-bold">${fmt$(grandTotals.usd)}</div>
            <div class="col-span-3 text-right text-white font-bold font-mono">${grandTotals.vp.toLocaleString()} VP</div>
        </div>`;
    }
    
    setHtml('locks-list', html || '<div class="text-center text-gray-600 italic text-xs pt-10">No locks parsed yet...</div>');
}

// === GLOBAL ACTIONS ===
function clearAll() {
    if (confirm("Clear all data?")) location.reload();
}

function getPhaseString() {
    if (!currentEpochInfo) return 'unknown';
    let now = new Date();
    let endTime = new Date(currentEpochInfo.end_time);
    let daysLeft = (endTime - now) / 86400000;
    if (daysLeft >= 5) return 'start';
    if (daysLeft > 2) return 'mid';
    return 'end';
}

function buildExportData() {
    // Get export filter settings
    let exportAstro = $('export-astro')?.checked ?? true;
    let exportWW = $('export-ww')?.checked ?? true;
    let exportInactive = $('export-inactive')?.checked ?? true;
    
    // Filter pools based on export settings
    let exportPools = store.vote.pools.filter(p => {
        let isAct = p.vps >= 1;
        let isAstroOrSingle = isAstroport(p.d);
        let isWW = isSkeletonSwap(p.d);
        
        if (isAstroOrSingle && !exportAstro) return false;
        if (isWW && !exportWW) return false;
        if (!isAct && !exportInactive) return false;
        return true;
    });
    
    return {
        meta: {
            version: '2.0',
            epoch: store.vote.ep,
            phase: getPhaseString(),
            generated_at: new Date().toISOString(),
            source: 'TLA Admin Core',
            export_filters: {
                astroport: exportAstro,
                skeleton_swap: exportWW,
                inactive: exportInactive
            }
        },
        vote: {
            epoch: store.vote.ep,
            tvp: store.vote.tvp,
            rebase: store.vote.reb,
            rewards_usd: store.vote.usd,
            end_time: store.vote.end,
            pool_count: exportPools.length,
            total_pool_count: store.vote.pools.length
        },
        pools: exportPools.map(p => ({
            name: p.n,
            dex: p.d.includes('Single') ? 'Single' : isAstroport(p.d) ? 'Astroport' : 'Skeleton Swap',
            dex_raw: p.d,
            bucket: p.b,
            is_active: p.vps >= 1,
            // TLA Vote data
            vp: p.tvp,
            vote_pct: p.vps,
            depth: p.dp,
            // aDAO data
            adao_vp: p.mvp,
            adao_pct: p.ms,
            // APR data
            apr_non: p.aprNon || 0,
            apr_amp: p.aprAmp || 0,
            apr_factor: p.aprFactor || 0,
            // Bribes
            bribes_total: p.incTotal || 0,
            bribes_pd: p.incPD || 0,
            bribes_other: p.incOther || 0,
            // Votion
            votion_now_vp: p.votNowVp || 0,
            votion_now_pct: p.votNowPct || 0,
            votion_next_vp: p.votNextVp || 0,
            votion_next_pct: p.votNextPct || 0,
            votion_change_vp: (p.votNextVp || 0) - (p.votNowVp || 0),
            votion_change_pct: (p.votNextPct || 0) - (p.votNowPct || 0),
            // 4-Epoch averages
            liq_4ep_avg: p.liq4Ep?.avg || 0,
            liq_4ep_count: p.liq4Ep?.count || 0,
            vol_4ep_avg: p.vol4Ep?.avg || 0,
            vol_4ep_count: p.vol4Ep?.count || 0,
            efficiency: p.efficiency || 0,
            // Scoring
            access_score: p.accessScore || 0,
            performance_score: p.performanceScore || 0,
            support_score: p.supportScore || 0,
            adao_score: p.adaoScore || 0,
            included_in_grade: p.includedInGrade ?? true
        })),
        dao: {
            // Locked voting power
            locked_vp: store.dao.lVp || 0,
            power_factor: store.dao.lFac || 0,
            underlying_assets: store.dao.lAst || 0,
            // Deposits
            deposit_usd: store.dao.dep || 0,
            deposit_apr: store.dao.apr || 0,
            // Unclaimed rewards
            rewards: {
                usd: store.dao.rew?.usd || 0,
                zAssets: store.dao.rew?.z || 0,
                ampLUNA: store.dao.rew?.amp || 0
            },
            // Vote rewards
            vote_rewards: store.dao.vRew || {},
            vote_reward_periods: store.dao.vRewPeriods || [],
            // Tokens/Rebase
            tokens: store.dao.toks || [],
            // Individual locks
            locks: (store.dao.locks || []).map(l => ({
                id: l.id,
                amount: l.amt,
                asset: l.asset,
                bucket: l.bucket,
                vp: l.vp,
                usd: l.usd,
                status: l.status
            })),
            // Vote allocations - computed from pool data (pools where aDAO has votes)
            allocations: store.vote.pools
                .filter(p => p.mvp > 0)
                .map(p => ({
                    pool: p.n,
                    dex: p.d.includes('Single') ? 'Single' : isAstroport(p.d) ? 'Astroport' : 'Skeleton Swap',
                    bucket: p.b,
                    vp: p.mvp,
                    pct: p.ms
                }))
                .sort((a, b) => b.vp - a.vp)
        },
        tla: {
            tvl: store.tla.tvl || 0,
            rewards_yr: store.tla.rewYr || 0,
            rewards_per_epoch: (store.tla.rewYr || 0) / 52,
            // Active pools with full data
            pools: (store.tla.pools || []).map(p => ({
                name: p.name,
                normalized_name: p.normName,
                dex: p.dex,
                type: p.type,
                bucket: p.bucket,
                depth: p.depth || 0,
                tla_staked: p.stk || 0,
                apr_non_amp: p.aprNon || 0,
                apr_amplified: p.aprAmp || 0,
                rewards_per_year: p.rYr || 0,
                adao_deposit_non_amp: p.adaoNon || 0,
                adao_deposit_amplified: p.adaoAmp || 0
            })),
            // Inactive pools
            inactive_pools: (store.tla.inactivePools || []).map(p => ({
                name: p.name,
                normalized_name: p.normName,
                dex: p.dex,
                type: p.type,
                bucket: p.bucket,
                depth: p.depth || 0,
                tla_staked: p.stk || 0,
                apr_non_amp: p.aprNon || 0,
                apr_amplified: p.aprAmp || 0,
                rewards_per_year: p.rYr || 0,
                adao_deposit_non_amp: p.adaoNon || 0,
                adao_deposit_amplified: p.adaoAmp || 0
            })),
            pool_count: store.tla.pools?.length || 0,
            inactive_pool_count: store.tla.inactivePools?.length || 0
        },
        // Include ext data summary
        ext_data: {
            loaded: store.ext.loaded || false,
            votion_available: !!store.ext.votion,
            votion_total_vp: store.ext.votion?.total_vp || 0,
            votion_pool_count: Object.keys(store.ext.votion?.pools || {}).length,
            pd_bribes_available: !!store.ext.pdBribesEpoch,
            historical_lp_count: Object.keys(store.ext.lps || {}).length
        },
        // Validation summary
        validation: validateExportData()
    };
}

function validateExportData() {
    let issues = [];
    let warnings = [];
    
    // Check Vote data
    if (!store.vote.ep) issues.push('No epoch detected from Vote page');
    if (!store.vote.tvp) issues.push('No total voting power detected');
    if (store.vote.pools.length === 0) issues.push('No pools parsed from Vote page');
    
    // Check ext data - but recognize data loaded from file is valid
    if (!store.ext.loaded) warnings.push('Ext data not loaded from GitHub');
    if (!store.ext.votion) warnings.push('No Votion data available');
    if (!store.ext.pdBribesEpoch) warnings.push('No PD bribes data for this epoch');
    if (Object.keys(store.ext.lps || {}).length === 0 && !store.ext.lps?.loaded_from_file) {
        warnings.push('No historical LP data available');
    }
    
    // Check for pools with missing data
    // Note: Many pools legitimately have 0 Votion votes - only warn if NO pools have votion data
    let poolsWithVotion = store.vote.pools.filter(p => p.votNowVp > 0 || p.votNextVp > 0).length;
    let poolsWithApr = store.vote.pools.filter(p => p.aprNon > 0).length;
    let poolsWith4Ep = store.vote.pools.filter(p => p.liq4Ep).length;
    
    // Only warn about missing data if we have VERY little data
    if (poolsWithVotion === 0 && store.ext.votion) {
        warnings.push('Votion data loaded but no pools matched');
    }
    if (poolsWithApr < store.vote.pools.length * 0.3) {
        warnings.push(`Only ${poolsWithApr}/${store.vote.pools.length} pools have APR data`);
    }
    if (poolsWith4Ep < store.vote.pools.length * 0.3) {
        warnings.push(`Only ${poolsWith4Ep}/${store.vote.pools.length} pools have 4-epoch averages`);
    }
    
    // Check DAO allocations
    if (!store.dao.lVp) warnings.push('No aDAO voting power detected');
    
    return {
        valid: issues.length === 0,
        ready_for_export: issues.length === 0 && warnings.length <= 2,
        issues: issues,
        warnings: warnings,
        summary: {
            vote_parsed: !!store.vote.ep,
            ext_loaded: store.ext.loaded,
            votion_matched: store.vote.pools.filter(p => p.votNowVp > 0).length,
            apr_matched: store.vote.pools.filter(p => p.aprNon > 0).length,
            historical_matched: store.vote.pools.filter(p => p.liq4Ep).length
        }
    };
}

function downloadCoreJson() {
    let data = buildExportData();
    let s = data.validation.summary;
    
    // Build a helpful summary message
    let summaryLines = [
        `üìä ${store.vote.pools.length} pools`,
        `üéØ ${s.votion_matched} with Votion data`,
        `üìà ${s.apr_matched} with APR data`,
        `üìâ ${s.historical_matched} with 4-epoch history`,
        `üîí ${store.dao.locks?.length || 0} aDAO locks`,
        `üíß ${store.tla.pools?.length || 0} TLA liquidity pools`,
        `üè∑Ô∏è ${Object.keys(assetMetadata).length} asset metadata`,
        `üîÑ Scores recalculated with current metadata`
    ];
    
    // Check validation
    if (!data.validation.valid) {
        let msg = '‚ùå Export has critical issues:\n\n' + data.validation.issues.join('\n');
        if (!confirm(msg + '\n\nExport anyway?')) return;
    } else if (data.validation.warnings.length > 0) {
        let msg = '‚ö†Ô∏è Export warnings:\n' + data.validation.warnings.join('\n');
        msg += '\n\n‚úÖ Data summary:\n' + summaryLines.join('\n');
        msg += '\n\nContinue with export?';
        if (!confirm(msg)) return;
    } else {
        // All good - show summary
        let msg = '‚úÖ Export ready!\n\n' + summaryLines.join('\n');
        msg += '\n\nProceed with download?';
        if (!confirm(msg)) return;
    }
    
    let jsonStr = JSON.stringify(data, null, 2);
    let blob = new Blob([jsonStr], { type: 'application/json' });
    let url = URL.createObjectURL(blob);
    let a = document.createElement('a');
    a.href = url;
    a.download = `tla-data-epoch-${store.vote.ep || 'unknown'}-${getPhaseString() || 'unknown'}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    // Show summary
    alert(`Export complete!\n\nPools: ${data.pools.length}\nVotion matched: ${data.validation.summary.votion_matched}\nAPR matched: ${data.validation.summary.apr_matched}\nHistorical: ${data.validation.summary.historical_matched}`);
}

function copyExportJson() {
    let data = buildExportData();
    let jsonStr = JSON.stringify(data, null, 2);
    navigator.clipboard.writeText(jsonStr).then(() => {
        alert('JSON copied to clipboard!\n\nPools: ' + data.pools.length);
    }).catch(err => {
        console.error('Copy failed:', err);
        alert('Copy failed - check console');
    });
}


</script>
</body>
</html>
