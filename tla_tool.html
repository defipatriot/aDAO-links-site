<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TLA Admin (Core) | Alliance DAO</title>
<meta name="description" content="Internal admin tool for managing TLA data collection and epoch snapshots. Not the public dashboard.">
<meta name="robots" content="noindex, nofollow">

<!-- Favicon -->
<link rel="icon" type="image/x-icon" href="https://raw.githubusercontent.com/defipatriot/aDAO-Image-Files/main/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://raw.githubusercontent.com/defipatriot/aDAO-Image-Files/main/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://raw.githubusercontent.com/defipatriot/aDAO-Image-Files/main/favicon-32x32.png">
<link rel="apple-touch-icon" sizes="180x180" href="https://raw.githubusercontent.com/defipatriot/aDAO-Image-Files/main/apple-touch-icon.png">

<!-- OG Meta -->
<meta property="og:title" content="TLA Admin Tool | Alliance DAO">
<meta property="og:description" content="Internal admin tool for TLA data collection">
<meta property="og:image" content="https://raw.githubusercontent.com/defipatriot/aDAO-Image-Files/main/android-chrome-512x512.png">
<meta property="og:type" content="website">

<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<!-- Vercel Analytics -->
<script defer src="/_vercel/insights/script.js"></script>
<style>
    body { font-family: 'Inter', monospace; background: #0D0D0D; color: #EAEAEA; }
    .input-dark { background: #1A1A1A; border: 1px solid #333; color: white; padding: 8px; border-radius: 6px; width: 100%; font-family: monospace; font-size: 0.75rem; resize: vertical; }
    .input-dark:focus { border-color: #2dd4bf; outline: none; }
    .tab-btn { padding: 8px 16px; border-radius: 6px; font-weight: 600; cursor: pointer; background: #1f2937; border: 1px solid #374151; color: #9ca3af; font-size: 0.8rem; transition: all 0.2s; display: flex; align-items: center; gap: 6px; }
    .tab-btn:hover { background: #374151; color: white; }
    .tab-btn.active { background: #2dd4bf; color: #000; border-color: #2dd4bf; }
    .tab-btn.active .tab-status { color: #000; }
    
    /* Tab status indicators */
    .tab-status { font-size: 10px; }
    .tab-incomplete .tab-status { color: #ef4444; }
    .tab-complete .tab-status { color: #22c55e; }
    .tab-partial .tab-status { color: #eab308; }
    
    /* Complete tab styling */
    .tab-btn.tab-complete { background: #14532d; border-color: #22c55e; color: #86efac; }
    .tab-btn.tab-complete:hover { background: #166534; }
    .tab-btn.tab-complete.active { background: #22c55e; color: #000; }
    
    /* Incomplete tab styling */
    .tab-btn.tab-incomplete { background: #1f2937; border-color: #374151; color: #9ca3af; }
    
    /* Partial tab styling */
    .tab-btn.tab-partial { background: #422006; border-color: #a16207; color: #fde047; }
    .tab-btn.tab-partial:hover { background: #713f12; }
    .tab-btn.tab-partial.active { background: #eab308; color: #000; border-color: #eab308; }
    
    .workspace { display: none; } .workspace.active { display: block; }
    .preview-card { background: #111; border: 1px solid #333; border-radius: 8px; padding: 16px; }
    .btn-action { background: #333; color: white; padding: 6px; border-radius: 6px; font-size: 0.75rem; width: 100%; margin-top: 8px; transition: 0.2s; font-weight: 600; }
    .btn-action:hover { background: #444; }
    .custom-scroll::-webkit-scrollbar { width: 6px; }
    .custom-scroll::-webkit-scrollbar-track { background: #0d0d0d; }
    .custom-scroll::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
    .filter-checkbox { accent-color: #2dd4bf; cursor: pointer; }
    .vote-grid { display: grid; grid-template-columns: 180px 65px 100px 100px 70px 80px 70px 85px 85px 70px 85px 60px 120px 110px 80px; gap: 8px; align-items: center; }
    .liq-grid { display: grid; grid-template-columns: 190px 100px 65px 110px 110px 75px 85px 85px 110px 110px 110px 110px; gap: 8px; align-items: center; }
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 50; justify-content: center; align-items: center; }
    .modal-overlay.open { display: flex; }
    .modal-box { background: #1A1A1A; border: 1px solid #333; padding: 20px; border-radius: 8px; width: 800px; max-height: 80vh; overflow-y: auto; }
</style>
</head>
<body class="p-4 w-full max-w-[1600px] mx-auto min-h-screen flex flex-col">

<!-- ADMIN TOOL NOTICE -->
<div class="bg-amber-900/30 border border-amber-600/50 rounded-lg px-4 py-2 mb-4 flex items-center gap-3">
    <i class="fas fa-tools text-amber-400"></i>
    <div class="flex-grow">
        <span class="text-amber-400 font-bold text-xs">INTERNAL ADMIN TOOL</span>
        <span class="text-amber-200/70 text-xs ml-2">For data collection & epoch snapshots. Looking for the dashboard?</span>
    </div>
    <a href="https://www.thealliancedao.com/tla-stats.html" target="_blank" class="bg-cyan-600 hover:bg-cyan-500 text-white px-3 py-1 rounded text-xs font-bold transition-colors flex items-center gap-1">
        <i class="fas fa-chart-line"></i> View TLA Stats
    </a>
</div>

<!-- TEST MODE BANNER (hidden by default) -->
<div id="test-mode-banner" class="hidden bg-yellow-900/50 border border-yellow-600 rounded-lg px-4 py-3 mb-4 flex items-center gap-3">
    <i class="fas fa-flask text-yellow-400 text-xl"></i>
    <div class="flex-grow">
        <span class="text-yellow-400 font-bold text-sm">üß™ TEST MODE</span>
        <span class="text-yellow-200/80 text-xs ml-2">Loaded from <span id="test-mode-filename" class="font-mono">_test.json</span> - exports will also be saved as _test files</span>
    </div>
    <div class="text-yellow-300 text-[10px] bg-yellow-900/50 px-2 py-1 rounded border border-yellow-700">
        Will NOT update live TLA Stats page
    </div>
</div>

<!-- HEADER -->
<header class="flex flex-col gap-4 mb-4 pb-4 border-b border-gray-800">
    <div class="flex justify-between items-start">
        <div class="flex flex-col">
            <h1 class="text-xl font-bold text-cyan-400 flex items-center gap-2">
                <i class="fas fa-layer-group"></i> TLA Admin <span class="text-gray-500 text-sm">Core</span>
                <span id="live-epoch" class="text-xs bg-gray-800 text-white px-2 py-0.5 rounded border border-gray-700 font-mono ml-2">Epoch ...</span>
            </h1>
            <div class="flex gap-4 mt-1 text-[10px] font-mono text-gray-500">
                <span class="flex items-center gap-1"><i class="far fa-clock text-cyan-600"></i> Ends: <span id="epoch-timer" class="text-gray-300">...</span> <span id="epoch-phase" class="text-yellow-400 font-bold ml-1">...</span></span>
                <span class="flex items-center gap-1"><i class="fas fa-sync text-green-600"></i> Rewards: <span id="reward-timer" class="text-gray-300">...</span></span>
                <div class="flex gap-3 ml-4 border-l border-gray-700 pl-4 text-[10px]">
                    <span id="status-epoch-file" class="text-red-500 font-bold">Epoch File</span>
                    <span class="text-gray-600">|</span>
                    <div class="flex gap-3">
                        <div class="flex flex-col items-center">
                            <span id="status-historical" class="text-gray-500 cursor-pointer font-semibold" title="tla_ext_historical.json - Click to acknowledge if yellow" onclick="acknowledgeStatus('historical')">Historical</span>
                            <span id="status-historical-date" class="text-[8px] text-gray-600">-</span>
                        </div>
                        <div class="flex flex-col items-center">
                            <span id="status-archive" class="text-gray-500 cursor-pointer font-semibold" title="tla_ext_archive.json" onclick="acknowledgeStatus('archive')">Archive</span>
                            <span id="status-archive-date" class="text-[8px] text-gray-600">-</span>
                        </div>
                        <div class="flex flex-col items-center">
                            <span id="status-epoch-ext" class="text-gray-500 cursor-pointer font-semibold" title="tla-ext-epoch-{ep}-{phase}.json" onclick="acknowledgeStatus('epochExt')">Ep Ext</span>
                            <span id="status-epoch-ext-date" class="text-[8px] text-gray-600">-</span>
                        </div>
                        <div class="flex flex-col items-center">
                            <span id="status-pd-bribes" class="text-gray-500 cursor-pointer font-semibold" title="tla_pd_bribes.json - Click to acknowledge if yellow" onclick="acknowledgeStatus('pdBribes')">PD Bribes</span>
                            <span id="status-pd-bribes-date" class="text-[8px] text-gray-600">-</span>
                        </div>
                        <div class="flex flex-col items-center">
                            <span id="status-asset-meta" class="text-red-500 cursor-pointer font-semibold" title="Asset Metadata Manager - Click Config tab to load" onclick="acknowledgeStatus('assetMeta')">Asset Meta</span>
                            <span id="status-asset-meta-count" class="text-[8px] text-gray-600">not loaded</span>
                            <span id="status-asset-meta-epoch" class="text-[7px] text-gray-600"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="flex gap-2">
            <a href="https://raw.githack.com/defipatriot/aDAO-links-site/main/tla-tool_ext.html" target="_blank" class="bg-teal-900/30 hover:bg-teal-900/50 text-teal-300 border border-teal-700 px-3 py-1.5 rounded text-xs font-bold transition-colors flex items-center gap-1" title="Open Extensions Tool">
                üìä Extensions
            </a>
            <button onclick="clearAll()" class="bg-red-900/20 hover:bg-red-900/40 text-red-400 border border-red-900/50 px-3 py-1.5 rounded text-xs font-bold transition-colors">Clear All</button>
            <button onclick="copyExportJson()" class="bg-gray-800 hover:bg-gray-700 text-white border border-gray-600 px-3 py-1.5 rounded text-xs font-bold transition-colors">Copy JSON</button>
            <button onclick="downloadCoreJson()" class="bg-cyan-900/50 hover:bg-cyan-800 text-cyan-200 border border-cyan-700 px-3 py-1.5 rounded text-xs font-bold transition-colors">Download JSON</button>
        </div>
    </div>
</header>

<!-- SESSION MANAGER -->
<div class="bg-[#161616] border border-gray-800 rounded-lg p-3 mb-6">
    <div class="flex items-center gap-4 mb-3">
        <div class="flex-shrink-0 text-cyan-500 text-xl"><i class="fas fa-database"></i></div>
        <div class="flex-grow">
            <h3 class="text-xs font-bold text-gray-400 uppercase">Session Manager</h3>
            <p class="text-[10px] text-gray-600" id="load-msg">Looking for latest snapshot...</p>
        </div>
        <div class="flex items-center gap-2">
            <input type="number" id="historyEpoch" placeholder="Ep" class="input-dark w-16 text-center font-mono" onchange="updateGithubLink()">
            <select id="historyPhase" class="input-dark w-20 text-xs" onchange="updateGithubLink()">
                <option value="end">End</option>
                <option value="mid">Mid</option>
                <option value="start">Start</option>
            </select>
            <button onclick="fetchCoreData()" class="bg-cyan-900/30 hover:bg-cyan-900/50 text-cyan-200 border border-cyan-800 px-3 py-1.5 rounded text-xs font-bold transition-colors">Load Data</button>
        </div>
    </div>
    
    <!-- Manual/Recovery Mode Toggle -->
    <div class="border-t border-gray-800 pt-2 mb-2">
        <div class="flex items-center gap-3">
            <label class="flex items-center gap-2 cursor-pointer">
                <input type="checkbox" id="manual-mode-toggle" class="filter-checkbox" onchange="toggleManualMode()">
                <span class="text-[10px] text-yellow-400 font-bold uppercase">Manual/Recovery Mode</span>
            </label>
            <span class="text-[9px] text-gray-500">(For recreating past epoch snapshots)</span>
        </div>
        
        <!-- Manual Mode Options (hidden by default) -->
        <div id="manual-mode-options" class="hidden mt-2 bg-yellow-900/20 border border-yellow-800/50 rounded p-3">
            <div class="grid grid-cols-4 gap-3">
                <!-- Working Epoch -->
                <div>
                    <label class="text-[9px] text-yellow-400 font-bold block mb-1">Working Epoch</label>
                    <div class="flex gap-1">
                        <input type="number" id="manual-epoch" class="input-dark w-16 text-center font-mono text-sm" placeholder="164">
                        <select id="manual-phase" class="input-dark w-16 text-[10px]">
                            <option value="end">End</option>
                            <option value="mid">Mid</option>
                            <option value="start">Start</option>
                        </select>
                    </div>
                </div>
                
                <!-- Manual Timestamp -->
                <div>
                    <label class="text-[9px] text-yellow-400 font-bold block mb-1">Snapshot Date</label>
                    <input type="date" id="manual-date" class="input-dark text-[10px]">
                </div>
                <div>
                    <label class="text-[9px] text-yellow-400 font-bold block mb-1">Snapshot Time (UTC)</label>
                    <input type="time" id="manual-time" class="input-dark text-[10px]" value="23:59">
                </div>
                
                <!-- Apply Button -->
                <div class="flex items-end">
                    <button onclick="applyManualMode()" class="bg-yellow-600 hover:bg-yellow-500 text-black font-bold px-3 py-1.5 rounded text-[10px] w-full">
                        <i class="fas fa-check mr-1"></i>Apply & Load
                    </button>
                </div>
            </div>
            
            <!-- Manual Mode Status -->
            <div id="manual-mode-status" class="hidden mt-2 text-[9px] bg-yellow-900/30 border border-yellow-700 rounded p-2">
                <div class="flex items-center gap-2">
                    <i class="fas fa-exclamation-triangle text-yellow-400"></i>
                    <span class="text-yellow-300 font-bold">MANUAL MODE ACTIVE</span>
                    <span class="text-gray-400">- Working on Epoch <span id="manual-mode-ep" class="text-yellow-400">--</span> (<span id="manual-mode-phase" class="text-yellow-400">--</span>)</span>
                </div>
                <div class="text-gray-500 mt-1">
                    Snapshot timestamp: <span id="manual-mode-timestamp" class="text-gray-300">--</span>
                    <span class="text-red-400 ml-2">‚Ä¢ Export will be marked as MANUAL EDIT</span>
                </div>
            </div>
            
            <div class="text-[8px] text-gray-500 mt-2">
                <i class="fas fa-info-circle mr-1"></i>
                Use this to recreate a snapshot for a past epoch. The tool will:
                (1) Load existing data from selected epoch,
                (2) Check for ext files matching that epoch,
                (3) Use your manual timestamp for the export,
                (4) Mark the export as a manual/recovery edit.
            </div>
        </div>
    </div>
    
    <!-- Paste Status Tracker -->
    <div class="border-t border-gray-800 pt-2">
        <div class="text-[9px] text-gray-500 uppercase font-bold mb-1">Paste Progress</div>
        <div class="flex gap-2 flex-wrap text-[9px] font-mono items-center">
            <span id="ps-vote" class="px-2 py-0.5 rounded bg-gray-800 text-gray-500 border border-gray-700">Vote Page</span>
            <span id="ps-vote-rew" class="px-2 py-0.5 rounded bg-gray-800 text-gray-500 border border-gray-700">Vote Rewards</span>
            <span class="text-gray-700">|</span>
            <span id="ps-liq-active" class="px-2 py-0.5 rounded bg-gray-800 text-gray-500 border border-gray-700">Liq Active</span>
            <span id="ps-liq-inactive" class="px-2 py-0.5 rounded bg-gray-800 text-gray-500 border border-gray-700">Liq Inactive</span>
            <span id="ps-liq-dep" class="px-2 py-0.5 rounded bg-gray-800 text-gray-500 border border-gray-700">Deposits</span>
            <span id="ps-liq-rew" class="px-2 py-0.5 rounded bg-gray-800 text-gray-500 border border-gray-700">Unclaimed</span>
            <span class="text-gray-700">|</span>
            <span id="ps-locks" class="px-2 py-0.5 rounded bg-gray-800 text-gray-500 border border-gray-700">Locks</span>
            <span class="text-gray-700">|</span>
            <span id="ps-ext" class="px-2 py-0.5 rounded bg-gray-800 text-gray-500 border border-gray-700">Ext Data</span>
            <span class="text-gray-700">|</span>
            <button id="ps-calc-scores" onclick="calculateAndRenderScores()" 
                class="px-3 py-0.5 rounded bg-gray-800 text-gray-500 border border-gray-700 cursor-not-allowed opacity-50" 
                disabled title="Complete all paste steps first">
                üßÆ Calculate Scores
            </button>
        </div>
    </div>
    
    <!-- Fallback Options (for when DAODAO connection fails) -->
    <div class="border-t border-gray-800 pt-2 mt-2">
        <div class="flex items-center gap-2 mb-2">
            <i class="fas fa-life-ring text-yellow-500 text-xs"></i>
            <span class="text-[9px] text-yellow-400 uppercase font-bold">Fallback Options</span>
            <span class="text-[8px] text-gray-500">(Use when paste data unavailable - pulls from previous epoch)</span>
        </div>
        <div class="grid grid-cols-6 gap-2 text-[9px]">
            <!-- aDAO Vote Allocation Fallback (for Vote Page aDAO column) -->
            <div class="bg-gray-900/50 border border-blue-800 rounded p-2">
                <div class="text-blue-400 font-bold mb-1 text-[8px]">aDAO Votes</div>
                <div class="text-[7px] text-gray-500 mb-1">(Vote Tab aDAO col)</div>
                <div class="flex flex-col gap-1">
                    <button onclick="loadAdaoAllocationsFromFallback()" class="w-full px-2 py-1 bg-blue-900/40 text-blue-300 border border-blue-800 rounded hover:bg-blue-900/60 text-[8px]">
                        <i class="fas fa-history mr-1"></i>Use Last
                    </button>
                    <button onclick="skipFallback('adaoVotes')" class="w-full px-2 py-1 bg-gray-800 text-gray-400 border border-gray-700 rounded hover:bg-gray-700 text-[8px]">
                        <i class="fas fa-forward mr-1"></i>Skip
                    </button>
                </div>
            </div>
            
            <!-- Vote Rewards Fallback (matches "Vote Rewards" / "Rewards Popup") -->
            <div class="bg-gray-900/50 border border-gray-800 rounded p-2">
                <div class="text-cyan-400 font-bold mb-1 text-[8px]">Vote Rewards</div>
                <div class="text-[7px] text-gray-500 mb-1">(Rewards Popup)</div>
                <div class="flex flex-col gap-1">
                    <button onclick="openFallbackEditor('voteRewards')" class="w-full px-2 py-1 bg-yellow-900/40 text-yellow-300 border border-yellow-800 rounded hover:bg-yellow-900/60 text-[8px]">
                        <i class="fas fa-history mr-1"></i>Use Last
                    </button>
                    <button onclick="skipFallback('voteRewards')" class="w-full px-2 py-1 bg-gray-800 text-gray-400 border border-gray-700 rounded hover:bg-gray-700 text-[8px]">
                        <i class="fas fa-forward mr-1"></i>Skip
                    </button>
                </div>
            </div>
            
            <!-- Deposits Fallback (matches "Deposits" / "Deposits Popup") -->
            <div class="bg-gray-900/50 border border-gray-800 rounded p-2">
                <div class="text-green-400 font-bold mb-1 text-[8px]">Deposits</div>
                <div class="text-[7px] text-gray-500 mb-1">(Deposits Popup)</div>
                <div class="flex flex-col gap-1">
                    <button onclick="openFallbackEditor('deposits')" class="w-full px-2 py-1 bg-yellow-900/40 text-yellow-300 border border-yellow-800 rounded hover:bg-yellow-900/60 text-[8px]">
                        <i class="fas fa-history mr-1"></i>Use Last
                    </button>
                    <button onclick="skipFallback('deposits')" class="w-full px-2 py-1 bg-gray-800 text-gray-400 border border-gray-700 rounded hover:bg-gray-700 text-[8px]">
                        <i class="fas fa-forward mr-1"></i>Skip
                    </button>
                </div>
            </div>
            
            <!-- Unclaimed Fallback (matches "Unclaimed" / "Unclaimed Popup") -->
            <div class="bg-gray-900/50 border border-gray-800 rounded p-2">
                <div class="text-yellow-400 font-bold mb-1 text-[8px]">Unclaimed</div>
                <div class="text-[7px] text-gray-500 mb-1">(Unclaimed Popup)</div>
                <div class="flex flex-col gap-1">
                    <button onclick="openFallbackEditor('unclaimed')" class="w-full px-2 py-1 bg-yellow-900/40 text-yellow-300 border border-yellow-800 rounded hover:bg-yellow-900/60 text-[8px]">
                        <i class="fas fa-history mr-1"></i>Use Last
                    </button>
                    <button onclick="skipFallback('unclaimed')" class="w-full px-2 py-1 bg-gray-800 text-gray-400 border border-gray-700 rounded hover:bg-gray-700 text-[8px]">
                        <i class="fas fa-forward mr-1"></i>Skip
                    </button>
                </div>
            </div>
            
            <!-- Locks Fallback -->
            <div class="bg-gray-900/50 border border-gray-800 rounded p-2">
                <div class="text-purple-400 font-bold mb-1 text-[8px]">Locks</div>
                <div class="text-[7px] text-gray-500 mb-1">(Locks Tab)</div>
                <div class="flex flex-col gap-1">
                    <button onclick="openFallbackEditor('locks')" class="w-full px-2 py-1 bg-yellow-900/40 text-yellow-300 border border-yellow-800 rounded hover:bg-yellow-900/60 text-[8px]">
                        <i class="fas fa-history mr-1"></i>Use Last
                    </button>
                    <button onclick="skipFallback('locks')" class="w-full px-2 py-1 bg-gray-800 text-gray-400 border border-gray-700 rounded hover:bg-gray-700 text-[8px]">
                        <i class="fas fa-forward mr-1"></i>Skip
                    </button>
                </div>
            </div>
            
            <!-- All aDAO Data (comprehensive - covers Vote Rewards, Deposits, Unclaimed, Locks) -->
            <div class="bg-gray-900/50 border border-yellow-700 rounded p-2">
                <div class="text-orange-400 font-bold mb-1 text-[8px]">‚ö° All aDAO</div>
                <div class="text-[7px] text-gray-500 mb-1">(Rew+Dep+Unc+Lock)</div>
                <div class="flex flex-col gap-1">
                    <button onclick="openFallbackEditor('allDao')" class="w-full px-2 py-1 bg-orange-900/40 text-orange-300 border border-orange-800 rounded hover:bg-orange-900/60 text-[8px]">
                        <i class="fas fa-history mr-1"></i>Use Last
                    </button>
                    <button onclick="skipFallback('allDao')" class="w-full px-2 py-1 bg-gray-800 text-gray-400 border border-gray-700 rounded hover:bg-gray-700 text-[8px]">
                        <i class="fas fa-forward mr-1"></i>Skip All
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Manual File Upload for Fallback -->
        <div class="mt-2 flex items-center gap-2">
            <span class="text-[8px] text-gray-500">Or load from file:</span>
            <input type="file" id="fallback-file-input" accept=".json" class="text-[9px] text-gray-400" onchange="loadFallbackFromFile(event)">
            <span id="fallback-file-status" class="text-[8px] text-gray-600"></span>
        </div>
        
        <div id="last-epoch-source" class="text-[8px] text-gray-600 mt-2 hidden">
            <i class="fas fa-info-circle mr-1"></i>Last epoch data source: <span id="last-epoch-file">-</span>
        </div>
    </div>
    
    <!-- Ext Data Manual Load -->
    <div id="ext-manual-load" class="border-t border-gray-800 pt-2 mt-2 hidden">
        <div class="flex items-center gap-3">
            <div class="text-[9px] text-teal-400 uppercase font-bold">Load Ext Data Manually</div>
            <input type="file" id="ext-file-input" accept=".json" class="text-[10px] text-gray-400" onchange="loadExtFromFile(event)">
            <button onclick="toggleExtPaste()" class="text-[9px] text-teal-400 hover:text-teal-200 underline">or paste JSON</button>
        </div>
        <div id="ext-paste-area" class="hidden mt-2">
            <textarea id="ext-paste" class="input-dark h-20 text-[10px]" placeholder="Paste tla_ext_historical.json or tla_ext_combined.json content here..."></textarea>
            <button onclick="loadExtFromPaste()" class="btn-action bg-teal-900/40 text-teal-200 border border-teal-900 mt-1">Load Ext JSON</button>
        </div>
    </div>
    
    <!-- JSON Export Controls -->
    <div class="border-t border-gray-800 pt-2 mt-2">
        <div class="flex justify-between items-center">
            <div>
                <div class="text-[9px] text-red-400 uppercase font-bold mb-1">‚ö†Ô∏è JSON Export - Data Exclusion</div>
                <div class="text-[8px] text-gray-400">Grade Against controls scoring comparisons. Export controls JSON output.</div>
            </div>
            <div class="flex gap-4">
                <!-- Grade Against Filters -->
                <div class="flex flex-col gap-1">
                    <span class="text-[8px] text-purple-400 font-bold uppercase">Grade Against</span>
                    <div class="flex gap-2 text-[10px] font-bold text-gray-400 bg-purple-900/20 px-2 py-1 rounded border border-purple-900/50">
                        <label class="flex items-center gap-1 hover:text-white cursor-pointer"><input type="checkbox" id="grade-astro" class="filter-checkbox" checked onchange="renderVoteTable()"> Astro</label>
                        <label class="flex items-center gap-1 hover:text-white cursor-pointer"><input type="checkbox" id="grade-ww" class="filter-checkbox" checked onchange="renderVoteTable()">SS</label>
                        <label class="flex items-center gap-1 hover:text-white cursor-pointer"><input type="checkbox" id="grade-inactive" class="filter-checkbox" checked onchange="renderVoteTable()"> Inactive</label>
                    </div>
                </div>
                <!-- Export Filters -->
                <div class="flex flex-col gap-1">
                    <span class="text-[8px] text-red-400 font-bold uppercase">Include in Export</span>
                    <div class="flex gap-2 text-[10px] font-bold text-gray-400 bg-red-900/20 px-2 py-1 rounded border border-red-900/50">
                        <label class="flex items-center gap-1 hover:text-white cursor-pointer"><input type="checkbox" id="export-astro" class="filter-checkbox" checked> Astro</label>
                        <label class="flex items-center gap-1 hover:text-white cursor-pointer"><input type="checkbox" id="export-ww" class="filter-checkbox" checked>SS</label>
                        <label class="flex items-center gap-1 hover:text-white cursor-pointer"><input type="checkbox" id="export-inactive" class="filter-checkbox" checked> Inactive</label>
                        <label class="flex items-center gap-1 hover:text-white cursor-pointer text-cyan-400"><input type="checkbox" id="export-adao" class="filter-checkbox" checked onchange="renderVoteTable()"> aDAO</label>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- TABS -->
<div class="flex gap-2 mb-4 border-b border-gray-800 pb-1 overflow-x-auto">
    <div id="tab-vote" class="tab-btn active tab-incomplete" onclick="switchTab('vote')">
        <span class="tab-status">‚óè</span> 1. Vote
    </div>
    <div id="tab-liquidity" class="tab-btn tab-incomplete" onclick="switchTab('liquidity')">
        <span class="tab-status">‚óè</span> 2. Liquidity
    </div>
    <div id="tab-locks" class="tab-btn tab-incomplete" onclick="switchTab('locks')">
        <span class="tab-status">‚óè</span> 3. Locks
    </div>
    <div id="tab-asset-meta" class="tab-btn tab-incomplete" onclick="switchTab('asset-meta')">
        <span class="tab-status">‚óè</span> 4. Asset Meta
    </div>
    <div id="tab-dashboard" class="tab-btn tab-incomplete" onclick="switchTab('dashboard')">
        <span class="tab-status">‚óè</span> 5. Dashboard
    </div>
    <div id="tab-nft" class="tab-btn tab-incomplete" onclick="switchTab('nft')">
        <span class="tab-status">‚óè</span> 6. NFT Stats
    </div>
    <div id="tab-dao-gov" class="tab-btn tab-incomplete" onclick="switchTab('dao-gov')">
        <span class="tab-status">‚óè</span> 7. DAO Gov
    </div>
    <div id="tab-news" class="tab-btn tab-incomplete" onclick="switchTab('news')">
        <span class="tab-status">‚óè</span> 8. News
    </div>
    <div id="tab-config" class="tab-btn" onclick="switchTab('config')">
        ‚öôÔ∏è Config
    </div>
</div>

<!-- WS 1: VOTE -->
<div id="ws-vote" class="workspace active">
    <div class="flex flex-col gap-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="bg-[#161616] p-3 rounded border border-gray-800">
                <div class="flex justify-between items-center mb-1">
                    <h3 class="text-orange-400 font-bold text-xs">1. Vote Page</h3>
                    <div class="flex items-center gap-2">
                        <span id="status-vote-page" class="text-[9px] text-gray-600 font-bold">PENDING</span>
                        <button onclick="clearPaste('votePaste')" class="text-[9px] text-red-400 hover:text-red-300">Clear</button>
                        <button onclick="markPasteUnknown('votePaste', 'vote-unknown-comment')" class="text-[9px] text-yellow-400 hover:text-yellow-300 font-bold" title="Mark as unavailable - enter reason">???</button>
                    </div>
                </div>
                <textarea id="votePaste" class="input-dark h-32" placeholder="Ctrl+A / Ctrl+C on TLA Vote Page connected to aDAO through DAODAO"></textarea>
                <div id="vote-unknown-comment" class="hidden mt-1">
                    <input type="text" id="vote-unknown-reason" class="w-full bg-yellow-900/20 border border-yellow-700 rounded px-2 py-1 text-xs text-yellow-300" placeholder="Why couldn't you paste? (e.g., DAODAO connection failed)">
                </div>
                <button onclick="parseVote()" class="btn-action bg-cyan-900/40 text-cyan-200 border border-cyan-900">Parse Vote</button>
            </div>
            <div class="bg-[#161616] p-3 rounded border border-gray-800">
                <div class="flex justify-between items-center mb-1">
                    <h3 class="text-cyan-400 font-bold text-xs">2. Rewards Popup</h3>
                    <div class="flex items-center gap-2">
                        <span id="status-rewards" class="text-[9px] text-gray-600 font-bold">PENDING</span>
                        <button onclick="clearPaste('voteRewardsPaste')" class="text-[9px] text-red-400 hover:text-red-300">Clear</button>
                        <button onclick="markPasteUnknown('voteRewardsPaste', 'rewards-unknown-comment')" class="text-[9px] text-yellow-400 hover:text-yellow-300 font-bold" title="Mark as unavailable - enter reason">???</button>
                    </div>
                </div>
                <textarea id="voteRewardsPaste" class="input-dark h-32" placeholder="Select and copy txt from Claim pop-up"></textarea>
                <div id="rewards-unknown-comment" class="hidden mt-1">
                    <input type="text" id="rewards-unknown-reason" class="w-full bg-yellow-900/20 border border-yellow-700 rounded px-2 py-1 text-xs text-yellow-300" placeholder="Why couldn't you paste? (e.g., Popup wouldn't load)">
                </div>
                <button onclick="parseVoteRewards()" class="btn-action">Parse Rewards</button>
            </div>
        </div>

        <div class="preview-card flex flex-col">
            <div class="flex flex-col gap-3 mb-4 border-b border-gray-700 pb-3">
                <!-- Row 1: Title + Calculate Scores Button -->
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-bold text-white">Vote Dashboard</h3>
                    <div class="flex items-center gap-2">
                        <span id="score-status" class="text-[9px] text-gray-500"></span>
                        <button id="calc-scores-btn" onclick="calculateAndRenderScores()" 
                            class="text-[10px] bg-emerald-800 hover:bg-emerald-700 text-emerald-300 px-3 py-1 rounded font-bold hidden">
                            üßÆ Calculate Scores
                        </button>
                    </div>
                </div>
                
                <!-- Row 2: Epoch Info | DEX Tables | aDAO Stats -->
                <div class="grid grid-cols-12 gap-4 items-start">
                    <!-- Left: Epoch Info -->
                    <div class="col-span-2 flex flex-col gap-1">
                        <div class="text-[10px] text-gray-500 flex flex-col gap-1 bg-gray-900/50 p-2 rounded border border-gray-800">
                            <div class="flex justify-between"><span>Epoch:</span><span id="vote-ep" class="text-white font-bold">0</span></div>
                            <div class="flex justify-between"><span>Ends:</span><span id="vote-end" class="text-white">-</span></div>
                            <div class="flex justify-between"><span>Phase:</span><span id="vote-phase" class="text-yellow-400 font-bold">-</span></div>
                        </div>
                        <div class="text-[10px] text-orange-400 font-bold mt-1">
                            Total TLA VP: <span id="vote-tvp" class="text-orange-300">-</span>
                        </div>
                    </div>
                    
                    <!-- Center: DEX Comparison Tables -->
                    <div class="col-span-6 grid grid-cols-2 gap-2">
                        <!-- Astroport Table -->
                        <div class="bg-blue-900/20 border border-blue-900/50 rounded p-2">
                            <div class="text-[10px] font-bold text-blue-400 mb-1 border-b border-blue-900/50 pb-1">Astroport</div>
                            <div class="grid grid-cols-2 gap-x-2 gap-y-0.5 text-[9px]">
                                <span class="text-gray-500">Active LPs:</span><span id="dex-astro-active" class="text-white text-right">0</span>
                                <span class="text-gray-500">Inactive LPs:</span><span id="dex-astro-inactive" class="text-gray-400 text-right">0</span>
                                <span class="text-gray-500">Total Depth:</span><span id="dex-astro-depth" class="text-blue-300 text-right">$0</span>
                                <span class="text-gray-500">TLA Vote %:</span><span id="dex-astro-tla-pct" class="text-orange-400 text-right">0%</span>
                                <span class="text-gray-500">aDAO Vote %:</span><span id="dex-astro-adao-pct" class="text-cyan-400 text-right">0%</span>
                            </div>
                        </div>
                        <!-- Skeleton Swap Table -->
                        <div class="bg-green-900/20 border border-green-900/50 rounded p-2">
                            <div class="text-[10px] font-bold text-green-400 mb-1 border-b border-green-900/50 pb-1">Skeleton Swap</div>
                            <div class="grid grid-cols-2 gap-x-2 gap-y-0.5 text-[9px]">
                                <span class="text-gray-500">Active LPs:</span><span id="dex-ww-active" class="text-white text-right">0</span>
                                <span class="text-gray-500">Inactive LPs:</span><span id="dex-ww-inactive" class="text-gray-400 text-right">0</span>
                                <span class="text-gray-500">Total Depth:</span><span id="dex-ww-depth" class="text-green-300 text-right">$0</span>
                                <span class="text-gray-500">TLA Vote %:</span><span id="dex-ww-tla-pct" class="text-orange-400 text-right">0%</span>
                                <span class="text-gray-500">aDAO Vote %:</span><span id="dex-ww-adao-pct" class="text-cyan-400 text-right">0%</span>
                            </div>
                        </div>
                        <!-- Ext Data Legend -->
                        <div id="ext-data-legend" class="col-span-2 mt-1 text-[8px] text-gray-500 hidden">
                            <span class="text-teal-400">Teal</span> = 4Ep avg from ext data |
                            <span class="text-green-400">üü¢+50</span> Priority |
                            <span class="text-yellow-400">üü°+20</span> Opportunity |
                            <span class="text-gray-400">‚ö™0</span> Balanced |
                            <span class="text-blue-400">üîµ-20</span> Supported |
                            <span class="text-red-400">üî¥-50</span> Over-hyped
                        </div>
                        <!-- Votion Summary -->
                        <div id="votion-summary" class="col-span-2 mt-2 p-2 bg-purple-900/20 border border-purple-800/50 rounded hidden">
                            <div class="flex justify-between items-center text-[10px]">
                                <div class="flex items-center gap-2">
                                    <span class="text-purple-400 font-bold">‚ö° VOTION</span>
                                    <span class="text-gray-400">Total VP:</span>
                                    <span id="votion-total-vp" class="text-purple-300 font-mono font-bold">-</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="text-gray-400">% of TLA:</span>
                                    <span id="votion-tla-pct" class="text-purple-300 font-mono font-bold">-</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="text-gray-400">Source:</span>
                                    <span id="votion-source" class="text-gray-500 font-mono">-</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Right: aDAO Stats -->
                    <div class="col-span-4 flex gap-3 justify-end">
                        <div class="text-center border-r border-gray-700 pr-3">
                            <div class="text-[9px] text-gray-500 uppercase">aDAO VP</div>
                            <div id="vote-adao-vp" class="text-sm text-cyan-400 font-bold font-mono">-</div>
                        </div>
                        <div class="text-center border-r border-gray-700 pr-3">
                            <div class="text-[9px] text-gray-500 uppercase">aDAO %</div>
                            <div id="vote-adao-pct" class="text-sm text-cyan-400 font-bold font-mono">-</div>
                        </div>
                        <div class="text-center border-r border-gray-700 pr-3">
                            <div class="text-[9px] text-gray-500 uppercase">Rebase</div>
                            <div id="vote-rebase" class="text-sm text-cyan-400 font-bold font-mono">0</div>
                        </div>
                        <div class="text-center">
                            <div class="text-[9px] text-gray-500 uppercase">Unclaimed</div>
                            <button onclick="togModal('vote-rew',1)" id="vote-claim" class="text-sm text-cyan-400 font-bold font-mono hover:underline hover:text-white cursor-pointer underline decoration-dotted">$0</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-indigo-900/20 text-indigo-200 rounded-t border-b border-gray-800">
                <div class="vote-grid text-[11px] uppercase font-bold px-3 py-2 whitespace-nowrap">
                    <div class="truncate" title="pool_name">Pool</div>
                    <div class="text-center text-gray-500" title="pool_status (active/inactive)">Status</div>
                    <div class="text-right text-teal-400 cursor-help" title="4-Epoch Average Liquidity" onclick="showScoreInfo('4ep-liq')">4Ep Liq</div>
                    <div class="text-right text-teal-400 cursor-help" title="4-Epoch Average Volume" onclick="showScoreInfo('4ep-vol')">4Ep Vol</div>
                    <div class="text-right text-yellow-400 cursor-help" title="Capital Efficiency = Vol/Liq" onclick="showScoreInfo('efficiency')">Effic</div>
                    <div class="text-right cursor-help" title="APR: Green=Non-Amp, Yellow=Amplified" onclick="showScoreInfo('apr')"><span class="text-green-400">APR</span>/<span class="text-yellow-400">üî•</span></div>
                    <div class="text-right text-cyan-400 cursor-help" title="Access Score (asset + bridge + LUNA)" onclick="showScoreInfo('access')">Access</div>
                    <div class="text-right text-purple-400" title="Votion Current Epoch (VP + %)">Vot Now</div>
                    <div class="text-right text-purple-300" title="Votion Next Epoch Optimization (VP + %)">Vot Next</div>
                    <div class="text-right text-blue-400" title="Expected Vote Change (Next - Now)">Œî Vote</div>
                    <div class="text-right text-green-400" title="Bribes: PD (green) / Total (yellow)">Bribes</div>
                    <div class="text-right text-orange-300 cursor-help" title="Support Score" onclick="showScoreInfo('support')">Supp</div>
                    <div class="text-right text-orange-400" title="TLA VP + Vote %">TLA Vote</div>
                    <div class="text-right text-cyan-400 adao-col" title="aDAO VP + Vote %">aDAO</div>
                    <div class="text-right text-emerald-400 cursor-help" title="aDAO Opportunity Score" onclick="showScoreInfo('adao-score')">Score</div>
                </div>
            </div>
            <div id="vote-list" class="max-h-[600px] overflow-y-auto text-xs bg-[#0D0D0D] p-2 border border-gray-800 rounded-b custom-scroll space-y-1"></div>
        </div>
    </div>
    
    <!-- aDAO Strategy Panel (Vote Tab Only) -->
    <div class="mt-4">
        <div class="bg-gray-900/50 border border-emerald-800 rounded-lg overflow-hidden">
            <div class="flex justify-between items-center px-4 py-2 bg-emerald-900/30 cursor-pointer" onclick="toggleStrategyPanel()">
                <div class="flex items-center gap-2">
                    <span class="text-emerald-400 font-bold text-sm">üéØ aDAO Strategy Recommendations</span>
                    <span class="text-[10px] text-gray-500">(Vote Optimization, Bribe Candidates, Activation Targets)</span>
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="event.stopPropagation(); generateStrategy()" class="text-[10px] bg-emerald-800 hover:bg-emerald-700 px-2 py-1 rounded">Generate</button>
                    <span id="strategy-toggle" class="text-gray-400">‚ñº</span>
                </div>
            </div>
            <div id="strategy-panel" class="hidden p-4">
                <div class="grid grid-cols-2 gap-4">
                    <!-- Vote Optimization -->
                    <div class="bg-gray-900/50 rounded border border-gray-700 p-3">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-sm font-bold text-orange-400">üìä Optimized Vote Allocation</h4>
                            <button onclick="copyVoteStrategy()" class="text-[10px] bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded">üìã Copy</button>
                        </div>
                        <div id="vote-optimization" class="space-y-3 text-[11px] max-h-[400px] overflow-y-auto custom-scroll">
                            <div class="text-gray-500 italic">Click "Generate" to calculate recommendations</div>
                        </div>
                    </div>
                    
                    <!-- Bribe Candidates & Activation Targets -->
                    <div class="space-y-4">
                        <!-- Bribe Candidates -->
                        <div class="bg-gray-900/50 rounded border border-gray-700 p-3">
                            <div class="flex justify-between items-center mb-3">
                                <h4 class="text-sm font-bold text-green-400">üí∞ Bribe Candidates</h4>
                                <button onclick="copyBribeCandidates()" class="text-[10px] bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded">üìã Copy for Prop</button>
                            </div>
                            <div id="bribe-candidates" class="space-y-2 text-[11px]">
                                <div class="text-gray-500 italic">Click "Generate" to identify candidates</div>
                            </div>
                        </div>
                        
                        <!-- Activation Targets -->
                        <div class="bg-gray-900/50 rounded border border-gray-700 p-3">
                            <div class="flex justify-between items-center mb-3">
                                <h4 class="text-sm font-bold text-purple-400">üöÄ Activation Targets</h4>
                                <span class="text-[9px] text-gray-500">Inactive pools worth bringing to 1%+</span>
                            </div>
                            <div id="activation-targets" class="space-y-2 text-[11px]">
                                <div class="text-gray-500 italic">Click "Generate" to find targets</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- WS 2: LIQUIDITY -->
<div id="ws-liquidity" class="workspace">
    <div class="flex flex-col gap-4">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="bg-[#161616] p-3 rounded border border-gray-800">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-cyan-400 font-bold text-xs">1. Full Page Text</h3>
                    <div class="flex items-center gap-2">
                        <button onclick="clearPaste('liqFullPage')" class="text-[9px] text-red-400 hover:text-red-300">Clear</button>
                        <button onclick="markPasteUnknown('liqFullPage', 'liq-unknown-comment')" class="text-[9px] text-yellow-400 hover:text-yellow-300 font-bold" title="Mark as unavailable">???</button>
                    </div>
                </div>
                <div class="flex items-center gap-2 mb-2 p-1.5 bg-gray-900 rounded border border-gray-700">
                    <label class="flex items-center gap-1 text-[10px] text-gray-400 cursor-pointer">
                        <input type="checkbox" id="liqInactiveToggle" class="w-3 h-3"> Inactive Pools
                    </label>
                    <button onclick="skipInactive()" class="text-[9px] text-yellow-400 hover:text-yellow-300 ml-auto">Skip Inactive</button>
                </div>
                <textarea id="liqFullPage" class="input-dark h-20" placeholder="Ctrl+A on Liquidity page..."></textarea>
                <div id="liq-unknown-comment" class="hidden mt-1">
                    <input type="text" id="liq-unknown-reason" class="w-full bg-yellow-900/20 border border-yellow-700 rounded px-2 py-1 text-xs text-yellow-300" placeholder="Why couldn't you paste? (e.g., Page wouldn't load)">
                </div>
                <button onclick="parseLiquidity()" class="btn-action text-cyan-200 bg-cyan-900/40 border border-cyan-900">Parse Pools</button>
            </div>
            <div class="bg-[#161616] p-3 rounded border border-gray-800">
                <div class="flex justify-between items-center mb-1">
                    <h3 class="text-blue-400 font-bold text-xs">2. Deposits Popup</h3>
                    <div class="flex items-center gap-2">
                        <button onclick="clearPaste('liqDeposits')" class="text-[9px] text-red-400 hover:text-red-300">Clear</button>
                        <button onclick="markPasteUnknown('liqDeposits', 'dep-unknown-comment')" class="text-[9px] text-yellow-400 hover:text-yellow-300 font-bold" title="Mark as unavailable">???</button>
                    </div>
                </div>
                <textarea id="liqDeposits" class="input-dark h-24" placeholder="Paste Token List..."></textarea>
                <div id="dep-unknown-comment" class="hidden mt-1">
                    <input type="text" id="dep-unknown-reason" class="w-full bg-yellow-900/20 border border-yellow-700 rounded px-2 py-1 text-xs text-yellow-300" placeholder="Why couldn't you paste?">
                </div>
                <button onclick="parseDeposits()" class="btn-action">Parse Deposits</button>
            </div>
            <div class="bg-[#161616] p-3 rounded border border-gray-800">
                <div class="flex justify-between items-center mb-1">
                    <h3 class="text-green-400 font-bold text-xs">3. Unclaimed Popup</h3>
                    <div class="flex items-center gap-2">
                        <button onclick="clearPaste('liqRewards')" class="text-[9px] text-red-400 hover:text-red-300">Clear</button>
                        <button onclick="markPasteUnknown('liqRewards', 'unc-unknown-comment')" class="text-[9px] text-yellow-400 hover:text-yellow-300 font-bold" title="Mark as unavailable">???</button>
                    </div>
                </div>
                <textarea id="liqRewards" class="input-dark h-24" placeholder="zAssets..."></textarea>
                <div id="unc-unknown-comment" class="hidden mt-1">
                    <input type="text" id="unc-unknown-reason" class="w-full bg-yellow-900/20 border border-yellow-700 rounded px-2 py-1 text-xs text-yellow-300" placeholder="Why couldn't you paste?">
                </div>
                <button onclick="parseRewards()" class="btn-action">Parse Rewards</button>
            </div>
        </div>
        <div class="preview-card flex flex-col">
            <!-- Row 1: TLA Global | DEX Tables | aDAO Stats -->
            <div class="grid grid-cols-12 gap-3 mb-3 border-b border-gray-700 pb-3">
                <!-- TLA Global -->
                <div class="col-span-2 px-2">
                    <h3 class="text-xs font-bold text-orange-400 mb-1">TLA Global</h3>
                    <div class="flex justify-between text-[10px] text-gray-400"><span>TVL</span><span id="tla-tvl" class="text-white font-mono">$0</span></div>
                    <div class="flex justify-between text-[10px] text-gray-400"><span>Rew/Yr</span><span id="tla-rew" class="text-green-400 font-mono">$0</span></div>
                    <div class="flex justify-between text-[10px] text-gray-400"><span>Rew/Ep</span><span id="tla-rew-ep" class="text-green-400 font-mono">$0</span></div>
                </div>
                
                <!-- DEX Tables -->
                <div class="col-span-6 grid grid-cols-2 gap-2">
                    <!-- Astroport -->
                    <div class="bg-blue-900/20 border border-blue-900/50 rounded p-2">
                        <div class="text-[10px] font-bold text-blue-400 mb-1 border-b border-blue-900/50 pb-1">Astroport</div>
                        <div class="grid grid-cols-2 gap-x-2 gap-y-0.5 text-[9px]">
                            <span class="text-gray-500">Active LPs:</span><span id="liq-astro-active" class="text-white text-right">0</span>
                            <span class="text-gray-500">Total Depth:</span><span id="liq-astro-depth" class="text-blue-300 text-right">$0</span>
                            <span class="text-gray-500">TLA Staked:</span><span id="liq-astro-stk" class="text-orange-400 text-right">$0</span>
                            <span class="text-gray-500">TLA % Depth:</span><span id="liq-astro-pct" class="text-orange-300 text-right">0%</span>
                            <span class="text-gray-500">% of TVL:</span><span id="liq-astro-tvl" class="text-white font-bold text-right">0%</span>
                        </div>
                    </div>
                    <!-- Skeleton Swap -->
                    <div class="bg-green-900/20 border border-green-900/50 rounded p-2">
                        <div class="text-[10px] font-bold text-green-400 mb-1 border-b border-green-900/50 pb-1">Skeleton Swap</div>
                        <div class="grid grid-cols-2 gap-x-2 gap-y-0.5 text-[9px]">
                            <span class="text-gray-500">Active LPs:</span><span id="liq-ww-active" class="text-white text-right">0</span>
                            <span class="text-gray-500">Total Depth:</span><span id="liq-ww-depth" class="text-green-300 text-right">$0</span>
                            <span class="text-gray-500">TLA Staked:</span><span id="liq-ww-stk" class="text-orange-400 text-right">$0</span>
                            <span class="text-gray-500">TLA % Depth:</span><span id="liq-ww-pct" class="text-orange-300 text-right">0%</span>
                            <span class="text-gray-500">% of TVL:</span><span id="liq-ww-tvl" class="text-white font-bold text-right">0%</span>
                        </div>
                    </div>
                </div>
                
                <!-- aDAO Stats -->
                <div class="col-span-4 grid grid-cols-2 gap-2">
                    <div class="px-2 border-l border-gray-800">
                        <div class="flex justify-between items-center mb-1">
                            <h3 class="text-xs font-bold text-cyan-400">aDAO Deposits</h3>
                            <button onclick="togModal('token',1)" class="text-[9px] bg-gray-800 px-1 rounded hover:text-white text-cyan-400">View</button>
                        </div>
                        <div class="flex justify-between text-[10px] text-gray-400">
                            <span>TLA Total</span>
                            <div class="flex items-center gap-1">
                                <span id="dao-dep-tla" class="text-white font-mono">$0</span>
                                <button onclick="useTlaDeposit()" class="text-[8px] bg-gray-800 px-1 rounded hover:text-cyan-400" title="Use TLA value">use</button>
                            </div>
                        </div>
                        <div class="flex justify-between text-[10px] text-gray-400">
                            <span>Calc'd Total</span>
                            <div class="flex items-center gap-1">
                                <span id="dao-dep-calc" class="font-mono">$0</span>
                                <button onclick="useCalculatedDeposit()" class="text-[8px] bg-gray-800 px-1 rounded hover:text-cyan-400" title="Use calculated value">use</button>
                            </div>
                        </div>
                        <div class="flex justify-between text-[10px] text-gray-500">
                            <span>Difference</span>
                            <span id="dao-dep-diff" class="font-mono">$0</span>
                        </div>
                        <div class="flex justify-between text-[10px] text-gray-400 mt-1 pt-1 border-t border-gray-800">
                            <span>Avg APR</span>
                            <div class="flex items-center gap-1">
                                <span id="dao-apr" class="text-green-400 font-mono">0%</span>
                                <button onclick="manualAprEntry()" id="dao-apr-edit" class="text-[8px] bg-yellow-800 px-1 rounded hover:text-white text-yellow-400 hidden" title="Manual entry">‚úèÔ∏è</button>
                            </div>
                        </div>
                        <div class="text-[9px] text-gray-600 mt-1">Using: <span id="dao-dep-source" class="text-cyan-400">--</span></div>
                    </div>
                    <div class="px-2 border-l border-gray-800">
                        <h3 class="text-xs font-bold text-green-400 mb-1">Unclaimed</h3>
                        <div class="flex justify-between text-[10px] text-gray-400"><span>Total</span><span id="dao-usd" class="text-green-400 font-mono">$0</span></div>
                        <div class="text-[9px] text-gray-500 mt-1">
                            <span>zAssets: <span id="dao-rew-z" class="text-white">0</span></span>
                            <span class="ml-2">amp: <span id="dao-rew-amp" class="text-white">0</span></span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Table Header -->
            <div class="bg-cyan-900/20 text-cyan-200 rounded-t border-b border-gray-800">
                <div class="liq-grid text-[11px] uppercase font-bold px-3 py-2 whitespace-nowrap">
                    <div title="pool_name">Pool</div>
                    <div class="text-center" title="dex_name">Dex</div>
                    <div class="text-center text-gray-500" title="lp_type (pcl/stable/xyk)">Type</div>
                    <div class="text-right text-gray-500" title="dex_depth_usd">Depth</div>
                    <div class="text-right text-orange-400" title="tla_staked_usd">TLA Stk</div>
                    <div class="text-right text-orange-400" title="tla_depth_pct (TLA Staked / Dex Depth)">TLA %</div>
                    <div class="text-right text-green-400" title="apr_non_amplified">APR</div>
                    <div class="text-right text-yellow-400" title="apr_amplified">üî• APR</div>
                    <div class="text-right text-green-400" title="rewards_usd_year">Rew/Yr</div>
                    <div class="text-right text-green-400" title="rewards_usd_epoch (Rew/Yr √∑ 52)">Rew/Ep</div>
                    <div class="text-right text-cyan-400" title="adao_deposit_non_amp_usd">aDAO</div>
                    <div class="text-right text-yellow-400" title="adao_deposit_amplified_usd">üî• aDAO</div>
                </div>
            </div>
            <div id="liq-list" class="max-h-[600px] overflow-y-auto text-xs bg-[#0D0D0D] p-2 border border-gray-800 rounded-b custom-scroll"></div>
        </div>
    </div>
</div>

<!-- WS 3: LOCKS -->
<div id="ws-locks" class="workspace">
    <div class="flex flex-col gap-4">
        <div class="bg-[#161616] p-3 rounded border border-gray-800">
            <div class="flex justify-between items-center mb-1">
                <h3 class="text-purple-400 font-bold text-xs">Locks Page</h3>
                <button onclick="clearPaste('locksPaste')" class="text-[9px] text-red-400 hover:text-red-300">Clear</button>
            </div>
            <textarea id="locksPaste" class="input-dark h-32" placeholder="Paste locks page content..."></textarea>
            <button onclick="parseLocks()" class="btn-action bg-purple-900/40 text-purple-200 border border-purple-900">Parse Locks</button>
        </div>
        <div class="preview-card flex flex-col">
            <div class="flex justify-between mb-6 border-b border-gray-700 pb-4">
                <div class="text-center px-4 w-1/3 border-r border-gray-800">
                    <div class="text-[10px] text-gray-500 uppercase mb-1">ADAO Voting Power</div>
                    <div id="locks-vp" class="text-xl font-bold text-purple-400 font-mono">0 VP</div>
                </div>
                <div class="text-center px-4 w-1/3 border-r border-gray-800">
                    <div class="text-[10px] text-gray-500 uppercase mb-1">Power Factor</div>
                    <div id="locks-factor" class="text-xl font-bold text-white font-mono">-</div>
                </div>
                <div class="text-center px-4 w-1/3">
                    <div class="text-[10px] text-gray-500 uppercase mb-1">Underlying Assets</div>
                    <div id="locks-assets" class="text-xl font-bold text-white font-mono">-</div>
                </div>
            </div>
            <!-- Locks Table Header -->
            <div class="bg-purple-900/20 text-purple-200 rounded-t border-b border-gray-800 mb-1">
                <div class="grid grid-cols-12 gap-2 text-[8px] uppercase font-bold px-2 py-2">
                    <div class="col-span-1" title="lock_id">Lock</div>
                    <div class="col-span-2 text-gray-500" title="lock_status">Status</div>
                    <div class="col-span-3" title="locked_amount + asset_type">Amount</div>
                    <div class="col-span-3 text-right text-green-400" title="usd_value">USD Value</div>
                    <div class="col-span-3 text-right" title="voting_power">Voting Power</div>
                </div>
            </div>
            <div id="locks-list" class="space-y-0 max-h-[550px] overflow-y-auto custom-scroll pr-2 bg-[#0D0D0D] border border-gray-800 rounded-b p-2">
                <div class="text-center text-gray-600 italic text-xs pt-10">No locks parsed yet...</div>
            </div>
        </div>
    </div>
</div>

<!-- WS 4: CONFIG -->
<div id="ws-config" class="workspace">
    <div class="flex flex-col gap-4">
        <div class="bg-amber-900/20 border border-amber-700/50 rounded-lg p-4 mb-2">
            <div class="flex items-center gap-2 text-amber-400 font-bold text-sm mb-2">
                <span>‚öôÔ∏è</span> Site Configuration Editor
            </div>
            <p class="text-gray-400 text-xs">Edit key values below, then click "Copy Config JSON" to get the updated configuration. Replace the config in your GitHub repo to update the site.</p>
        </div>
        
        <!-- Config Sections -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
            
            <!-- General Settings -->
            <div class="bg-[#161616] p-4 rounded border border-gray-800">
                <h3 class="text-cyan-400 font-bold text-sm mb-3 border-b border-gray-700 pb-2">üìä General Settings</h3>
                <div class="space-y-3">
                    <div>
                        <label class="text-[10px] text-gray-500 uppercase">Current Epoch</label>
                        <input type="number" id="cfg-epoch" class="input-dark w-full" value="161">
                    </div>
                    <div>
                        <label class="text-[10px] text-gray-500 uppercase">Default Phase</label>
                        <select id="cfg-phase" class="input-dark w-full">
                            <option value="end" selected>End (Snapshot)</option>
                            <option value="start">Start</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- GitHub URLs -->
            <div class="bg-[#161616] p-4 rounded border border-gray-800">
                <h3 class="text-purple-400 font-bold text-sm mb-3 border-b border-gray-700 pb-2">üîó GitHub Data URLs</h3>
                <div class="space-y-3">
                    <div>
                        <label class="text-[10px] text-gray-500 uppercase">Main Data Repo</label>
                        <input type="text" id="cfg-baseUrl" class="input-dark w-full text-xs" value="https://raw.githubusercontent.com/defipatriot/tla_json_storage/main">
                    </div>
                    <div>
                        <label class="text-[10px] text-gray-500 uppercase">Extensions Repo</label>
                        <input type="text" id="cfg-extUrl" class="input-dark w-full text-xs" value="https://raw.githubusercontent.com/defipatriot/tla-ext_json_storage/main">
                    </div>
                    <div>
                        <label class="text-[10px] text-gray-500 uppercase">aDAO Repo</label>
                        <input type="text" id="cfg-adaoUrl" class="input-dark w-full text-xs" value="https://raw.githubusercontent.com/defipatriot/adao_json_storage/main">
                    </div>
                </div>
            </div>
            
            <!-- Scoring Weights -->
            <div class="bg-[#161616] p-4 rounded border border-gray-800">
                <h3 class="text-green-400 font-bold text-sm mb-3 border-b border-gray-700 pb-2">‚öñÔ∏è Scoring Weights</h3>
                <p class="text-[10px] text-gray-500 mb-3">aDAO Score = (Access √ó W1) + (Performance √ó W2) + ((100-Support) √ó W3)</p>
                <div class="space-y-3">
                    <div class="flex items-center gap-2">
                        <label class="text-[10px] text-gray-400 w-28">Access Weight</label>
                        <input type="number" id="cfg-accessWeight" class="input-dark w-20 text-center" value="0.15" step="0.05" min="0" max="1">
                        <span class="text-gray-500 text-xs">(15%)</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <label class="text-[10px] text-gray-400 w-28">Performance Weight</label>
                        <input type="number" id="cfg-perfWeight" class="input-dark w-20 text-center" value="0.55" step="0.05" min="0" max="1">
                        <span class="text-gray-500 text-xs">(55%)</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <label class="text-[10px] text-gray-400 w-28">Support Weight</label>
                        <input type="number" id="cfg-supportWeight" class="input-dark w-20 text-center" value="0.30" step="0.05" min="0" max="1">
                        <span class="text-gray-500 text-xs">(30%)</span>
                    </div>
                    <div id="weight-total" class="text-[10px] text-gray-500 mt-2">Total: 100%</div>
                </div>
            </div>
            
            <!-- Origin Scores -->
            <div class="bg-[#161616] p-4 rounded border border-gray-800">
                <h3 class="text-amber-400 font-bold text-sm mb-3 border-b border-gray-700 pb-2">üåç Origin Base Scores</h3>
                <div class="space-y-2">
                    <div class="flex items-center gap-2">
                        <label class="text-[10px] text-cyan-400 w-32">üîÑ Terra LSD</label>
                        <input type="number" id="cfg-origin-lsd" class="input-dark w-16 text-center" value="85">
                    </div>
                    <div class="flex items-center gap-2">
                        <label class="text-[10px] text-green-400 w-32">üè† Terra Native</label>
                        <input type="number" id="cfg-origin-native" class="input-dark w-16 text-center" value="80">
                    </div>
                    <div class="flex items-center gap-2">
                        <label class="text-[10px] text-purple-400 w-32">‚öõÔ∏è IBC Native</label>
                        <input type="number" id="cfg-origin-ibc" class="input-dark w-16 text-center" value="70">
                    </div>
                    <div class="flex items-center gap-2">
                        <label class="text-[10px] text-blue-400 w-32">üíµ Bridged Stable</label>
                        <input type="number" id="cfg-origin-stable" class="input-dark w-16 text-center" value="65">
                    </div>
                    <div class="flex items-center gap-2">
                        <label class="text-[10px] text-yellow-400 w-32">üåâ Eureka Bridge</label>
                        <input type="number" id="cfg-origin-eureka" class="input-dark w-16 text-center" value="55">
                    </div>
                    <div class="flex items-center gap-2">
                        <label class="text-[10px] text-orange-400 w-32">üî∂ Axelar/Osmosis</label>
                        <input type="number" id="cfg-origin-axelar" class="input-dark w-16 text-center" value="50">
                    </div>
                </div>
            </div>
            
            <!-- Asset Class Bonuses -->
            <div class="bg-[#161616] p-4 rounded border border-gray-800">
                <h3 class="text-blue-400 font-bold text-sm mb-3 border-b border-gray-700 pb-2">üè∑Ô∏è Asset Class Bonuses</h3>
                <div class="space-y-2">
                    <div class="flex items-center gap-2">
                        <label class="text-[10px] text-gray-400 w-32">Stablecoin</label>
                        <input type="number" id="cfg-class-stable" class="input-dark w-16 text-center" value="5">
                    </div>
                    <div class="flex items-center gap-2">
                        <label class="text-[10px] text-gray-400 w-32">Bluechip (BTC/ETH)</label>
                        <input type="number" id="cfg-class-bluechip" class="input-dark w-16 text-center" value="5">
                    </div>
                    <div class="flex items-center gap-2">
                        <label class="text-[10px] text-gray-400 w-32">LSD</label>
                        <input type="number" id="cfg-class-lsd" class="input-dark w-16 text-center" value="5">
                    </div>
                    <div class="flex items-center gap-2">
                        <label class="text-[10px] text-gray-400 w-32">RWA (PAXG)</label>
                        <input type="number" id="cfg-class-rwa" class="input-dark w-16 text-center" value="5">
                    </div>
                    <div class="flex items-center gap-2">
                        <label class="text-[10px] text-gray-400 w-32">Core/DeFi</label>
                        <input type="number" id="cfg-class-core" class="input-dark w-16 text-center" value="0">
                    </div>
                </div>
            </div>
            
            <!-- DEX Configuration -->
            <div class="bg-[#161616] p-4 rounded border border-gray-800">
                <h3 class="text-red-400 font-bold text-sm mb-3 border-b border-gray-700 pb-2">üè¶ DEX Configuration</h3>
                <div class="space-y-3">
                    <div>
                        <label class="text-[10px] text-gray-500 uppercase">Primary DEX Name</label>
                        <input type="text" id="cfg-dex1-name" class="input-dark w-full" value="Astroport">
                    </div>
                    <div>
                        <label class="text-[10px] text-gray-500 uppercase">Primary DEX Link</label>
                        <input type="text" id="cfg-dex1-link" class="input-dark w-full text-xs" value="https://app.astroport.fi/pools">
                    </div>
                    <div>
                        <label class="text-[10px] text-gray-500 uppercase">Secondary DEX Name</label>
                        <input type="text" id="cfg-dex2-name" class="input-dark w-full" value="Skeleton Swap">
                    </div>
                    <div>
                        <label class="text-[10px] text-gray-500 uppercase">Secondary DEX Link</label>
                        <input type="text" id="cfg-dex2-link" class="input-dark w-full text-xs" value="https://app.skeleton_swap.money/terra/pools">
                    </div>
                    <div class="flex items-center gap-2 mt-2">
                        <input type="checkbox" id="cfg-dex2-enabled" class="filter-checkbox">
                        <label class="text-[10px] text-gray-400">Secondary DEX Link Enabled</label>
                    </div>
                </div>
            </div>
            
        </div>
        
        <!-- Export Buttons -->
        <div class="flex gap-3 mt-4">
            <button onclick="copyConfigJSON()" class="btn-action bg-emerald-900/50 text-emerald-300 border border-emerald-700 flex items-center gap-2">
                <span>üìã</span> Copy Config JSON
            </button>
            <button onclick="resetConfigDefaults()" class="btn-action bg-gray-800 text-gray-400 border border-gray-700">
                Reset to Defaults
            </button>
        </div>
        
        <!-- JSON Preview -->
        <div class="bg-[#0D0D0D] p-4 rounded border border-gray-800 mt-2">
            <div class="flex justify-between items-center mb-2">
                <h4 class="text-gray-400 font-bold text-xs">Generated Config JSON</h4>
                <span id="config-copy-status" class="text-[10px] text-emerald-400 hidden">‚úì Copied!</span>
            </div>
            <pre id="config-preview" class="text-[10px] text-gray-500 font-mono overflow-x-auto max-h-60 overflow-y-auto">Click "Copy Config JSON" to generate...</pre>
        </div>
    </div>
</div>

<!-- WS 4: ASSET META -->
<div id="ws-asset-meta" class="workspace">
<!-- Metadata Manager -->
<div class="max-w-[1400px] mx-auto px-2">
    <div class="bg-gray-900/50 border border-gray-800 rounded-lg overflow-hidden">
        <div class="flex justify-between items-center px-4 py-3 bg-gray-800/50">
            <div class="flex items-center gap-2">
                <span class="text-cyan-400 font-bold text-sm">üìä Asset Metadata Manager</span>
                <span class="text-[10px] text-gray-500">(CoinGecko, Multi-DEX, Bridge info)</span>
            </div>
            <div class="flex items-center gap-3">
                <span id="meta-status" class="text-[10px] text-gray-500">0 assets</span>
                <span id="meta-new-count" class="hidden text-[10px] text-yellow-400 font-bold bg-yellow-900/30 px-2 py-0.5 rounded">0 new</span>
            </div>
        </div>
        
        <!-- Verification Status Bar -->
        <div id="meta-verify-bar" class="px-4 py-2 bg-gray-900/50 border-b border-gray-700 flex justify-between items-center">
            <div class="flex items-center gap-4 text-[10px]">
                <span id="meta-load-status" class="text-gray-500">‚è≥ Not loaded</span>
                <span id="meta-extract-status" class="text-gray-500">‚è≥ Not compared</span>
            </div>
            <div class="flex gap-2">
                <button onclick="markMetadataUpdated()" class="text-[10px] bg-green-800 hover:bg-green-700 px-3 py-1.5 rounded font-bold">
                    ‚úì Mark Updated
                </button>
                <button onclick="markMetadataComplete()" class="text-[10px] bg-cyan-800 hover:bg-cyan-700 px-3 py-1.5 rounded font-bold">
                    ‚úì No Changes Needed
                </button>
            </div>
        </div>
        
        <div id="metadata-panel" class="p-4">
            <div class="grid grid-cols-3 gap-4">
                <!-- Asset List -->
                <div class="col-span-2 bg-gray-900/50 rounded border border-gray-700 p-3">
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="text-sm font-bold text-white">Assets</h4>
                        <div class="flex gap-2">
                            <input type="text" id="meta-search" placeholder="Search assets..." 
                                class="bg-gray-800 border border-gray-700 rounded px-2 py-1 text-xs w-32"
                                oninput="filterMetaAssets()">
                            <button onclick="addNewAsset()" class="text-[10px] bg-cyan-800 hover:bg-cyan-700 px-2 py-1 rounded">+ Add</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-12 gap-1 text-[7px] uppercase text-gray-500 font-bold mb-2 px-2">
                        <div class="col-span-2">Asset</div>
                        <div class="col-span-1 text-center" title="Naming matches actual path">Name</div>
                        <div class="col-span-1 text-center" title="CoinGecko status">CG</div>
                        <div class="col-span-1 text-center" title="Easy to find in Skip.go">Skip</div>
                        <div class="col-span-1 text-center" title="On multiple DEXs">DEX</div>
                        <div class="col-span-1 text-center" title="Value to chain treasury">Treas</div>
                        <div class="col-span-1 text-center">Score</div>
                        <div class="col-span-1 text-center" title="Last edited epoch">Edit</div>
                        <div class="col-span-2 text-center">Actions</div>
                    </div>
                    <div id="meta-asset-list" class="max-h-[350px] overflow-y-auto custom-scroll space-y-1">
                        <div class="text-center text-gray-600 italic text-xs py-4">
                            Load from GitHub or extract from parsed pools
                        </div>
                    </div>
                </div>
                
                <!-- Controls -->
                <div class="space-y-3">
                    <div class="bg-gray-900/50 rounded border border-gray-700 p-3">
                        <h4 class="text-sm font-bold text-white mb-2">Data Source</h4>
                        <button onclick="loadMetadataFromGitHub()" class="w-full text-[10px] bg-purple-800 hover:bg-purple-700 px-3 py-2 rounded mb-2">
                            üì• Load from GitHub
                        </button>
                        <button onclick="extractAssetsFromPools()" class="w-full text-[10px] bg-gray-700 hover:bg-gray-600 px-3 py-2 rounded">
                            üîÑ Extract from Parsed Pools
                        </button>
                    </div>
                    
                    <!-- Last Updated Tracking -->
                    <div class="bg-gray-900/50 rounded border border-yellow-800/50 p-3">
                        <h4 class="text-sm font-bold text-yellow-400 mb-2">üìÖ Last Updated</h4>
                        <div class="text-[10px] space-y-1 mb-2">
                            <div class="flex justify-between">
                                <span class="text-gray-500">Epoch:</span>
                                <span id="meta-last-epoch" class="text-white font-mono">--</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-500">Date:</span>
                                <span id="meta-last-date" class="text-gray-300 font-mono">--</span>
                            </div>
                        </div>
                        <button onclick="markMetadataUpdated()" class="w-full text-[10px] bg-yellow-700 hover:bg-yellow-600 text-black font-bold px-3 py-2 rounded">
                            ‚úì Mark as Updated This Epoch
                        </button>
                        <div class="text-[8px] text-gray-500 mt-1 text-center">
                            Click after making changes to track when metadata was last modified
                        </div>
                    </div>
                    
                    <div class="bg-gray-900/50 rounded border border-gray-700 p-3">
                        <h4 class="text-sm font-bold text-white mb-2">Export</h4>
                        <button onclick="downloadMetadata()" class="w-full text-[10px] bg-green-800 hover:bg-green-700 px-3 py-2 rounded mb-2">
                            üíæ Download JSON
                        </button>
                        <button onclick="copyMetadata()" class="w-full text-[10px] bg-blue-800 hover:bg-blue-700 px-3 py-2 rounded">
                            üìã Copy to Clipboard
                        </button>
                    </div>
                    
                    <div class="bg-gray-900/50 rounded border border-gray-700 p-3">
                        <h4 class="text-sm font-bold text-white mb-2">Origin Types</h4>
                        <div class="text-[8px] space-y-0.5">
                            <div><span class="text-green-400">üè† terra_native</span> - Built on Terra (80)</div>
                            <div><span class="text-cyan-400">üîÑ terra_lsd</span> - Terra LSDs (85)</div>
                            <div><span class="text-purple-400">‚öõÔ∏è ibc</span> - Standard IBC (70)</div>
                            <div><span class="text-yellow-400">üåâ bridge_eureka</span> - Skip (.atom) (55)</div>
                            <div><span class="text-orange-400">üî∂ bridge_axelar</span> - Axelar (.axl) (50)</div>
                            <div><span class="text-orange-300">üü† bridge_osmosis</span> - Osmosis (.osmo) (50)</div>
                            <div><span class="text-blue-400">üíµ stable_native</span> - Native stables (65)</div>
                            <div><span class="text-gray-500">‚ùì unknown</span> - Not classified (30)</div>
                        </div>
                    </div>
                    
                    <div class="bg-gray-900/50 rounded border border-gray-700 p-3">
                        <h4 class="text-sm font-bold text-white mb-2">Scoring</h4>
                        <div class="text-[8px] space-y-0.5">
                            <div><span class="text-green-400">‚úì Name</span> - TLA = Actual (+10)</div>
                            <div><span class="text-red-400">‚úó Name</span> - Mismatch (-10)</div>
                            <div><span class="text-green-400">‚úì Skip</span> - Easy to find (+5)</div>
                            <div><span class="text-red-400">‚úó Skip</span> - Confusing (-5)</div>
                            <div><span class="text-purple-400">‚òë DEX</span> - Multi-DEX (+5)</div>
                        </div>
                    </div>
                    
                    <div class="bg-gray-900/50 rounded border border-gray-700 p-3">
                        <h4 class="text-sm font-bold text-white mb-2">Treasury Value</h4>
                        <div class="text-[8px] space-y-0.5">
                            <div><span class="text-yellow-400">üèÜ High</span> - BTC, ETH, stables (+5)</div>
                            <div><span class="text-blue-400">üëç Medium</span> - LSDs, useful (+0)</div>
                            <div><span class="text-gray-400">üëé Low</span> - Protocol tokens (-5)</div>
                        </div>
                    </div>
                    
                    <div class="bg-gray-900/50 rounded border border-gray-700 p-3">
                        <h4 class="text-sm font-bold text-white mb-2">CoinGecko</h4>
                        <div class="text-[8px] space-y-0.5">
                            <div><span class="text-green-400">‚úì</span> - Terra ID (+15)</div>
                            <div><span class="text-yellow-400">‚óã</span> - Chain only (+5)</div>
                            <div><span class="text-red-400">‚úó</span> - Not listed (-15)</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- GitHub Info -->
            <div class="mt-3 p-2 bg-gray-800/50 rounded border border-gray-700 text-[10px] text-gray-400">
                <strong>GitHub:</strong> After editing, download the JSON and replace <code class="bg-gray-900 px-1 rounded">tla_metadata.json</code> in your repository.
                Expected URL: <code class="bg-gray-900 px-1 rounded">https://raw.githubusercontent.com/defipatriot/tla_json_storage/main/tla_metadata.json</code>
            </div>
        </div>
    </div>
</div>
</div>

<!-- WS 5: DAO DASHBOARD -->
<div id="ws-dashboard" class="workspace">
    <div class="bg-[#161616] border border-cyan-900/50 rounded-lg p-4 mb-4">
        <div class="flex justify-between items-center mb-3">
            <div class="flex items-center gap-3">
                <i class="fas fa-tachometer-alt text-cyan-400 text-xl"></i>
                <div>
                    <h2 class="text-cyan-400 font-bold text-sm">DAO Dashboard Snapshot</h2>
                    <p class="text-gray-500 text-[10px]">Treasury, deposits, rewards, NFT backing data for epoch snapshot</p>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <button onclick="loadDashboardFromTool()" class="text-[10px] bg-gray-800 hover:bg-gray-700 px-3 py-1.5 rounded">
                    <i class="fas fa-copy mr-1"></i> Load from Tool
                </button>
                <span id="dashboard-status" class="px-3 py-1 rounded text-[10px] font-bold bg-gray-800 text-gray-400">Not Started</span>
            </div>
        </div>
        
        <div class="grid grid-cols-3 gap-4 mb-4">
            <!-- DAO Treasury - Paste or Manual Entry -->
            <div class="bg-gray-900/50 rounded-lg p-3 border border-yellow-900/30">
                <h3 class="text-[11px] font-bold text-yellow-400 mb-2 flex items-center gap-2">
                    <i class="fas fa-coins"></i> DAO Treasury
                </h3>
                <!-- Paste Area -->
                <textarea id="dash-treas-paste" class="input-dark w-full h-16 text-[8px] mb-1" placeholder="Paste treasury table from Station...&#10;AssetAmountLive Value..."></textarea>
                <button onclick="parseTreasuryPaste()" class="text-[9px] bg-yellow-800 px-2 py-1 rounded hover:bg-yellow-700 mb-2 w-full">
                    <i class="fas fa-magic mr-1"></i> Parse Paste
                </button>
                <!-- Manual Add -->
                <div class="flex gap-1 mb-2">
                    <input type="text" id="dash-treas-token" class="input-dark w-20 text-[9px]" placeholder="Token">
                    <input type="number" id="dash-treas-amt" class="input-dark w-24 text-[9px]" placeholder="Amount" step="0.01">
                    <button onclick="addTreasuryToken()" class="text-[9px] bg-yellow-800 px-2 rounded hover:bg-yellow-700">+</button>
                </div>
                <div id="dash-treasury-list" class="space-y-0.5 text-[9px] max-h-28 overflow-y-auto">
                    <div class="text-gray-600 italic">No tokens added</div>
                </div>
                <div class="mt-2 pt-2 border-t border-gray-800 flex justify-between text-[10px]">
                    <span class="text-gray-400">Total USD:</span>
                    <span id="dash-treasury-total" class="text-yellow-400 font-bold">$0</span>
                </div>
            </div>
            
            <!-- TLA Deposits + Rewards -->
            <div class="bg-gray-900/50 rounded-lg p-3 border border-cyan-900/30">
                <h3 class="text-[11px] font-bold text-cyan-400 mb-2 flex items-center gap-2">
                    <i class="fas fa-piggy-bank"></i> aDAO TLA Position
                </h3>
                <!-- Deposits -->
                <div class="text-[9px] mb-2">
                    <div class="text-gray-500 font-bold mb-1">Deposits</div>
                    <div class="flex justify-between"><span class="text-gray-400">Total USD:</span><span id="dash-dep-usd" class="text-cyan-400 font-mono">$0</span></div>
                    <div class="flex justify-between"><span class="text-gray-400">Voting Power:</span><span id="dash-dep-vp" class="text-cyan-400 font-mono">0</span></div>
                    <div class="flex justify-between"><span class="text-gray-400">Avg APR:</span><span id="dash-dep-apr" class="text-green-400 font-mono">0%</span></div>
                </div>
                <!-- Deposit Tokens -->
                <div id="dash-dep-tokens" class="text-[8px] max-h-16 overflow-y-auto border-t border-gray-800 pt-1 mb-2"></div>
                
                <!-- Unclaimed Rewards -->
                <div class="text-[9px] border-t border-gray-800 pt-2">
                    <div class="text-gray-500 font-bold mb-1">Unclaimed Rewards</div>
                    <div class="flex justify-between"><span class="text-gray-400">Deposit Rewards:</span><span id="dash-rew-usd" class="text-green-400 font-mono">$0</span></div>
                    <div class="flex justify-between"><span class="text-gray-400">zAssets:</span><span id="dash-rew-z" class="text-white font-mono">0</span></div>
                    <div class="flex justify-between"><span class="text-gray-400">ampLUNA:</span><span id="dash-rew-amp" class="text-white font-mono">0</span></div>
                </div>
                
                <!-- Vote Rewards -->
                <div class="text-[9px] border-t border-gray-800 pt-2 mt-2">
                    <div class="text-gray-500 font-bold mb-1">Vote Rewards (unclaimed)</div>
                    <div id="dash-vote-rew" class="max-h-16 overflow-y-auto"></div>
                </div>
                
                <!-- Rebase -->
                <div class="text-[9px] border-t border-gray-800 pt-2 mt-2">
                    <div class="flex justify-between"><span class="text-gray-500 font-bold">Rebase (amp):</span><span id="dash-rebase" class="text-purple-400 font-mono">0</span></div>
                </div>
            </div>
            
            <!-- NFT Backing - Manual Entry -->
            <div class="bg-gray-900/50 rounded-lg p-3 border border-purple-900/30">
                <h3 class="text-[11px] font-bold text-purple-400 mb-2 flex items-center gap-2">
                    <i class="fas fa-gem"></i> NFT Backing (per NFT)
                </h3>
                <div class="space-y-2 text-[9px]">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">Backing (ampLUNA):</span>
                        <input type="number" id="dash-back-amp" class="input-dark w-24 text-right font-mono" placeholder="0" step="0.0001" onchange="updateDashBacking()">
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">= LUNA equivalent:</span>
                        <span id="dash-back-luna-equiv" class="text-purple-400 font-mono">0</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">= USD:</span>
                        <span id="dash-back-usd" class="text-green-400 font-mono">$0</span>
                    </div>
                </div>
                <div class="border-t border-gray-800 pt-2 mt-2 space-y-2 text-[9px]">
                    <div class="text-gray-500 font-bold">Unminted Backing</div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">Unminted Count:</span>
                        <input type="number" id="dash-unminted-count" class="input-dark w-20 text-right font-mono" placeholder="0" onchange="updateUnmintedBacking()">
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">Total ampLUNA:</span>
                        <span id="dash-unminted-amp" class="text-yellow-400 font-mono">0</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">Total LUNA equiv:</span>
                        <span id="dash-unminted-luna" class="text-yellow-400 font-mono">0</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">Total USD:</span>
                        <span id="dash-unminted-usd" class="text-green-400 font-mono">$0</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Save Button -->
        <div class="flex justify-end">
            <button onclick="saveDashboardData()" class="text-[10px] bg-cyan-800 hover:bg-cyan-700 px-4 py-2 rounded font-bold">
                <i class="fas fa-save mr-1"></i> Save Dashboard Data
            </button>
        </div>
    </div>
</div>

<!-- WS 6: NFT STATS -->
<div id="ws-nft" class="workspace">
    <div class="bg-[#161616] border border-purple-900/50 rounded-lg p-4 mb-4">
        <div class="flex justify-between items-center mb-3">
            <div class="flex items-center gap-3">
                <i class="fas fa-images text-purple-400 text-xl"></i>
                <div>
                    <h2 class="text-purple-400 font-bold text-sm">NFT Collection Stats</h2>
                    <p class="text-gray-500 text-[10px]">Collection data, marketplace sales, floor prices</p>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <a href="https://deving.zone/en/terra2/contracts/terra13ckenyqrq9aa2kzz3lnfv8el4squx2xmkwdzy9pvtv755d7uku3qamu6wv" target="_blank" class="text-[9px] text-purple-400 hover:text-purple-300 bg-purple-900/30 px-2 py-1 rounded border border-purple-900/50">
                    <i class="fas fa-external-link-alt mr-1"></i> Deving.zone
                </a>
                <span id="nft-status" class="px-3 py-1 rounded text-[10px] font-bold bg-gray-800 text-gray-400">Not Started</span>
            </div>
        </div>
        
        <!-- Collection Stats Grid - All Manual Entry -->
        <div class="grid grid-cols-4 gap-3 mb-4">
            <!-- Collection Overview -->
            <div class="bg-gray-900/50 rounded-lg p-3 border border-gray-800">
                <h3 class="text-[10px] font-bold text-purple-400 mb-2">Collection</h3>
                <div class="space-y-1 text-[9px]">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-500">Total Supply:</span>
                        <span class="text-white font-mono">10,000</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-500">Broken:</span>
                        <input type="number" id="nft-broken-input" class="input-dark w-20 text-right text-red-400 font-mono" placeholder="0" onchange="updateNftCalcs()">
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-500">Unbroken:</span>
                        <span id="nft-unbroken" class="text-green-400 font-mono">10,000</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-500">Minted:</span>
                        <input type="number" id="nft-minted-input" class="input-dark w-20 text-right text-white font-mono" placeholder="0" onchange="updateNftCalcs()">
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-500">Unminted:</span>
                        <span id="nft-unminted" class="text-gray-400 font-mono">0</span>
                    </div>
                </div>
            </div>
            
            <!-- Staking Stats -->
            <div class="bg-gray-900/50 rounded-lg p-3 border border-gray-800">
                <h3 class="text-[10px] font-bold text-cyan-400 mb-2">Staking</h3>
                <div class="space-y-1 text-[9px]">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-500">DAODAO Staked:</span>
                        <input type="number" id="nft-daodao-input" class="input-dark w-20 text-right text-cyan-400 font-mono" placeholder="0" onchange="updateNftCalcs()">
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-500">DAODAO %:</span>
                        <input type="number" id="nft-daodao-pct-input" class="input-dark w-20 text-right text-cyan-400 font-mono" placeholder="0" step="0.01">
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-500">Enterprise:</span>
                        <input type="number" id="nft-enterprise-input" class="input-dark w-20 text-right text-blue-400 font-mono" placeholder="0">
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-500">DAO Members:</span>
                        <input type="number" id="nft-members-input" class="input-dark w-20 text-right text-white font-mono" placeholder="0">
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-500">DAO Broken:</span>
                        <input type="number" id="nft-dao-broken-input" class="input-dark w-20 text-right text-red-400 font-mono" placeholder="0">
                    </div>
                </div>
            </div>
            
            <!-- Supply Stats -->
            <div class="bg-gray-900/50 rounded-lg p-3 border border-gray-800">
                <h3 class="text-[10px] font-bold text-green-400 mb-2">Supply</h3>
                <div class="space-y-1 text-[9px]">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-500">Circulating:</span>
                        <input type="number" id="nft-circ-input" class="input-dark w-20 text-right text-green-400 font-mono" placeholder="0">
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-500">Liquid:</span>
                        <input type="number" id="nft-liquid-input" class="input-dark w-20 text-right text-green-400 font-mono" placeholder="0">
                    </div>
                </div>
            </div>
            
            <!-- Backing -->
            <div class="bg-gray-900/50 rounded-lg p-3 border border-gray-800">
                <h3 class="text-[10px] font-bold text-yellow-400 mb-2">Backing (per NFT)</h3>
                <div class="space-y-1 text-[9px]">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-500">ampLUNA:</span>
                        <input type="number" id="nft-back-amp-input" class="input-dark w-20 text-right text-yellow-400 font-mono" placeholder="0" step="0.0001" onchange="updateNftBacking()">
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-500">= LUNA:</span>
                        <span id="nft-back-luna" class="text-yellow-400 font-mono">0</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-500">= USD:</span>
                        <span id="nft-back-usd" class="text-green-400 font-mono">$0</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Marketplace Section -->
        <div class="grid grid-cols-2 gap-4">
            <!-- BBL Marketplace -->
            <div class="bg-gray-900/50 rounded-lg p-3 border border-orange-900/30">
                <h3 class="text-[11px] font-bold text-orange-400 mb-2 flex items-center gap-2">
                    <i class="fas fa-store"></i> BBL Marketplace
                    <a href="https://www.bbl.gg" target="_blank" class="ml-auto text-[9px] text-orange-400 hover:text-orange-300">
                        <i class="fas fa-external-link-alt"></i>
                    </a>
                </h3>
                <!-- Floors -->
                <div class="flex justify-between items-center mb-1">
                    <span class="text-[9px] text-gray-400">Floor Prices</span>
                    <button onclick="autoCalcBblFloors()" class="text-[8px] bg-orange-900/50 hover:bg-orange-800 px-2 py-0.5 rounded text-orange-300" title="Auto-calculate from listings">
                        <i class="fas fa-calculator mr-1"></i>Auto-calc
                    </button>
                </div>
                <div class="grid grid-cols-2 gap-2 text-[9px] mb-2">
                    <div>
                        <span class="text-gray-500">Unbroken Floor:</span>
                        <div class="flex items-center gap-1 mt-0.5">
                            <input type="number" id="nft-bbl-floor-unbroken-amt" class="input-dark w-16 text-right" placeholder="0" step="0.01" onchange="updateBblFloorUsd()">
                            <select id="nft-bbl-floor-unbroken-token" class="input-dark w-16 text-[8px]" onchange="updateBblFloorUsd()">
                                <option value="bLUNA">bLUNA</option>
                                <option value="LUNA">LUNA</option>
                            </select>
                        </div>
                        <span id="nft-bbl-floor-unbroken-usd" class="text-gray-400 text-[8px]"></span>
                    </div>
                    <div>
                        <span class="text-gray-500">Broken Floor:</span>
                        <div class="flex items-center gap-1 mt-0.5">
                            <input type="number" id="nft-bbl-floor-broken-amt" class="input-dark w-16 text-right" placeholder="null" step="0.01" onchange="updateBblFloorUsd()">
                            <select id="nft-bbl-floor-broken-token" class="input-dark w-16 text-[8px]" onchange="updateBblFloorUsd()">
                                <option value="bLUNA">bLUNA</option>
                                <option value="LUNA">LUNA</option>
                            </select>
                        </div>
                        <span id="nft-bbl-floor-broken-usd" class="text-gray-400 text-[8px]"></span>
                    </div>
                </div>
                <!-- Volume -->
                <div class="flex items-center gap-2 text-[9px] mb-2">
                    <span class="text-gray-500">Volume:</span>
                    <input type="number" id="nft-bbl-volume" class="input-dark w-24 text-right" placeholder="0">
                    <span class="text-gray-500">bLUNA</span>
                    <span id="nft-bbl-volume-usd" class="text-gray-400">($0)</span>
                </div>
                
                <!-- Listings Entry -->
                <div class="border-t border-gray-800 pt-2 mt-2">
                    <h4 class="text-[9px] text-orange-300 mb-1 flex justify-between">
                        <span>Listings</span>
                        <span class="text-gray-500">(<span id="bbl-listing-count">0</span> total)</span>
                    </h4>
                    <div class="flex gap-1 mb-1">
                        <input type="number" id="nft-bbl-list-id" class="input-dark w-14" placeholder="NFT #">
                        <input type="number" id="nft-bbl-list-amt" class="input-dark w-14" placeholder="Amt" step="0.01">
                        <select id="nft-bbl-list-token" class="input-dark w-16 text-[8px]">
                            <option value="bLUNA">bLUNA</option>
                            <option value="LUNA">LUNA</option>
                        </select>
                        <label class="flex items-center text-[8px] text-gray-500 whitespace-nowrap"><input type="checkbox" id="nft-bbl-list-broken" class="mr-1"> Brk</label>
                        <button onclick="addBblListing()" class="text-[9px] bg-orange-800 px-2 rounded hover:bg-orange-700">+</button>
                    </div>
                    <div id="nft-bbl-listings-list" class="max-h-20 overflow-y-auto text-[8px] space-y-0.5">
                        <div class="text-gray-600 italic">No listings</div>
                    </div>
                </div>
                
                <!-- Sales Entry -->
                <div class="border-t border-gray-800 pt-2 mt-2">
                    <h4 class="text-[9px] text-orange-300 mb-1 flex justify-between">
                        <span>Epoch Sales</span>
                        <span class="text-gray-500">(<span id="bbl-sale-count">0</span> new + <span id="bbl-history-count">0</span> history)</span>
                    </h4>
                    <div class="flex gap-1 mb-1 flex-wrap">
                        <input type="number" id="nft-bbl-sale-id" class="input-dark w-14" placeholder="NFT #">
                        <input type="number" id="nft-bbl-sale-amt" class="input-dark w-14" placeholder="Amt" step="0.01">
                        <select id="nft-bbl-sale-token" class="input-dark w-16 text-[8px]">
                            <option value="bLUNA">bLUNA</option>
                            <option value="LUNA">LUNA</option>
                        </select>
                        <input type="number" id="nft-bbl-sale-usd" class="input-dark w-16" placeholder="USD $" step="0.01">
                        <label class="flex items-center text-[8px] text-gray-500 whitespace-nowrap"><input type="checkbox" id="nft-bbl-sale-broken" class="mr-1"> Brk</label>
                    </div>
                    <div class="flex gap-1 mb-1">
                        <input type="date" id="nft-bbl-sale-date" class="input-dark w-24 text-[8px]">
                        <input type="time" id="nft-bbl-sale-time" class="input-dark w-20 text-[8px]">
                        <button onclick="addBblSale()" class="text-[9px] bg-orange-800 px-2 rounded hover:bg-orange-700">+ Sale</button>
                    </div>
                    <div id="nft-bbl-sales-list" class="max-h-20 overflow-y-auto text-[8px] space-y-0.5">
                        <div class="text-gray-600 italic">No sales</div>
                    </div>
                </div>
            </div>
            
            <!-- Boost Marketplace -->
            <div class="bg-gray-900/50 rounded-lg p-3 border border-blue-900/30">
                <h3 class="text-[11px] font-bold text-blue-400 mb-2 flex items-center gap-2">
                    <i class="fas fa-rocket"></i> Boost Marketplace
                    <a href="https://app.booost.bg" target="_blank" class="ml-auto text-[9px] text-blue-400 hover:text-blue-300">
                        <i class="fas fa-external-link-alt"></i>
                    </a>
                </h3>
                <!-- Floors -->
                <div class="flex justify-between items-center mb-1">
                    <span class="text-[9px] text-gray-400">Floor Prices</span>
                    <button onclick="autoCalcBoostFloors()" class="text-[8px] bg-blue-900/50 hover:bg-blue-800 px-2 py-0.5 rounded text-blue-300" title="Auto-calculate from listings">
                        <i class="fas fa-calculator mr-1"></i>Auto-calc
                    </button>
                </div>
                <div class="grid grid-cols-2 gap-2 text-[9px] mb-2">
                    <div>
                        <span class="text-gray-500">Unbroken Floor:</span>
                        <div class="flex items-center gap-1 mt-0.5">
                            <input type="number" id="nft-boost-floor-unbroken-amt" class="input-dark w-16 text-right" placeholder="0" step="0.01" onchange="updateBoostFloorUsd()">
                            <input type="text" id="nft-boost-floor-unbroken-token" class="input-dark w-16 text-[8px]" placeholder="Token" value="LUNA" onchange="updateBoostFloorUsd()">
                        </div>
                        <span id="nft-boost-floor-unbroken-usd" class="text-gray-400 text-[8px]"></span>
                    </div>
                    <div>
                        <span class="text-gray-500">Broken Floor:</span>
                        <div class="flex items-center gap-1 mt-0.5">
                            <input type="number" id="nft-boost-floor-broken-amt" class="input-dark w-16 text-right" placeholder="null" step="0.01" onchange="updateBoostFloorUsd()">
                            <input type="text" id="nft-boost-floor-broken-token" class="input-dark w-16 text-[8px]" placeholder="Token" value="USDC" onchange="updateBoostFloorUsd()">
                        </div>
                        <span id="nft-boost-floor-broken-usd" class="text-gray-400 text-[8px]"></span>
                    </div>
                </div>
                <!-- Volume - Now tracked from sales history -->
                <div class="text-[9px] text-gray-500 mb-2">Volume: <span id="boost-volume-display" class="text-blue-400 font-mono">$0.00</span> <span id="boost-volume-note" class="text-gray-600">(load history)</span></div>
                
                <!-- Listings Entry - Any Token -->
                <div class="border-t border-gray-800 pt-2 mt-2">
                    <h4 class="text-[9px] text-blue-300 mb-1 flex justify-between">
                        <span>Listings</span>
                        <span class="text-gray-500">(<span id="boost-listing-count">0</span> total)</span>
                    </h4>
                    <div class="flex gap-1 mb-1">
                        <input type="number" id="nft-boost-list-id" class="input-dark w-14" placeholder="NFT #">
                        <input type="number" id="nft-boost-list-amt" class="input-dark w-14" placeholder="Amt" step="0.01">
                        <input type="text" id="nft-boost-list-token" class="input-dark w-16 text-[8px]" placeholder="Token" value="LUNA">
                        <label class="flex items-center text-[8px] text-gray-500 whitespace-nowrap"><input type="checkbox" id="nft-boost-list-broken" class="mr-1"> Brk</label>
                        <button onclick="addBoostListing()" class="text-[9px] bg-blue-800 px-2 rounded hover:bg-blue-700">+</button>
                    </div>
                    <div id="nft-boost-listings-list" class="max-h-20 overflow-y-auto text-[8px] space-y-0.5">
                        <div class="text-gray-600 italic">No listings</div>
                    </div>
                </div>
                
                <!-- Sales Entry - Any Token -->
                <div class="border-t border-gray-800 pt-2 mt-2">
                    <h4 class="text-[9px] text-blue-300 mb-1 flex justify-between">
                        <span>Epoch Sales</span>
                        <span class="text-gray-500">(<span id="boost-sale-count">0</span> new + <span id="boost-history-count">0</span> history)</span>
                    </h4>
                    <div class="flex gap-1 mb-1 flex-wrap">
                        <input type="number" id="nft-boost-sale-id" class="input-dark w-14" placeholder="NFT #">
                        <input type="number" id="nft-boost-sale-amt" class="input-dark w-14" placeholder="Amt" step="0.01">
                        <input type="text" id="nft-boost-sale-token" class="input-dark w-16 text-[8px]" placeholder="Token" value="LUNA">
                        <input type="number" id="nft-boost-sale-usd" class="input-dark w-16" placeholder="USD $" step="0.01">
                        <label class="flex items-center text-[8px] text-gray-500 whitespace-nowrap"><input type="checkbox" id="nft-boost-sale-broken" class="mr-1"> Brk</label>
                    </div>
                    <div class="flex gap-1 mb-1">
                        <input type="date" id="nft-boost-sale-date" class="input-dark w-24 text-[8px]">
                        <input type="time" id="nft-boost-sale-time" class="input-dark w-20 text-[8px]">
                        <button onclick="addBoostSale()" class="text-[9px] bg-blue-800 px-2 rounded hover:bg-blue-700">+ Sale</button>
                    </div>
                    <div id="nft-boost-sales-list" class="max-h-20 overflow-y-auto text-[8px] space-y-0.5">
                        <div class="text-gray-600 italic">No sales</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Save Button -->
        <div class="mt-4 pt-4 border-t border-gray-800 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <button onclick="loadSalesHistory()" class="text-[10px] bg-green-800 hover:bg-green-700 px-3 py-2 rounded font-bold">
                    <i class="fas fa-download mr-1"></i> Load Sales History
                </button>
                <span id="sales-history-status" class="text-[9px] text-gray-500"></span>
            </div>
            <div class="flex items-center gap-2">
                <button onclick="downloadSalesFile()" class="text-[10px] bg-cyan-800 hover:bg-cyan-700 px-3 py-2 rounded font-bold">
                    <i class="fas fa-file-export mr-1"></i> Download Sales File
                </button>
                <button onclick="saveNftStats()" class="text-[10px] bg-purple-800 hover:bg-purple-700 px-4 py-2 rounded font-bold">
                    <i class="fas fa-save mr-1"></i> Save NFT Stats
                </button>
            </div>
        </div>
    </div>
</div>

<!-- WS 7: DAO GOVERNANCE -->
<div id="ws-dao-gov" class="workspace">
    <div class="bg-[#161616] border border-blue-900/50 rounded-lg p-4 mb-4">
        <div class="flex justify-between items-center mb-3">
            <div class="flex items-center gap-3">
                <i class="fas fa-landmark text-blue-400 text-xl"></i>
                <div>
                    <h2 class="text-blue-400 font-bold text-sm">DAO Governance</h2>
                    <p class="text-gray-500 text-[10px]">Track proposals, voting records, and outcomes</p>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <a href="https://daodao.zone/dao/terra1csp8gsjk2yyxzqewza6lkjvwkspn7zs2jvamk9uf05crtcakf6gszk2g8y/proposals" target="_blank" class="text-[9px] text-blue-400 hover:text-blue-300 bg-blue-900/30 px-2 py-1 rounded border border-blue-900/50">
                    <i class="fas fa-external-link-alt mr-1"></i> DAODAO
                </a>
                <span id="dao-gov-status" class="px-3 py-1 rounded text-[10px] font-bold bg-gray-800 text-gray-400">Not Started</span>
            </div>
        </div>
        <div class="text-center text-gray-500 py-8">
            <i class="fas fa-vote-yea text-4xl mb-3 text-gray-700"></i>
            <p class="text-sm">Governance tracking coming soon</p>
            <p class="text-[10px] text-gray-600 mt-1">Proposals, votes, execution status</p>
        </div>
    </div>
</div>

<!-- WS 8: NEWS -->
<div id="ws-news" class="workspace">
    <div class="bg-[#161616] border border-orange-900/50 rounded-lg p-4 mb-4">
        <div class="flex justify-between items-center mb-3">
            <div class="flex items-center gap-3">
                <i class="fas fa-newspaper text-orange-400 text-xl"></i>
                <div>
                    <h2 class="text-orange-400 font-bold text-sm">Terra Ecosystem News</h2>
                    <p class="text-gray-500 text-[10px]">Collect and organize news articles</p>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <a href="https://twitter.com/search?q=%23TerraLuna" target="_blank" class="text-[9px] text-blue-400 hover:text-blue-300 bg-blue-900/30 px-2 py-1 rounded border border-blue-900/50">
                    <i class="fab fa-twitter mr-1"></i> Twitter
                </a>
                <span id="news-status" class="px-3 py-1 rounded text-[10px] font-bold bg-gray-800 text-gray-400">Not Started</span>
            </div>
        </div>
        <div class="text-center text-gray-500 py-8">
            <i class="fas fa-rss text-4xl mb-3 text-gray-700"></i>
            <p class="text-sm">News collection coming soon</p>
            <p class="text-[10px] text-gray-600 mt-1">Articles, announcements, updates</p>
        </div>
    </div>
</div>

<!-- Modals -->
<div id="token-modal" class="modal-overlay" onclick="if(event.target===this)togModal('token',0)">
    <div class="modal-box"><div class="flex justify-between border-b border-gray-700 pb-2 mb-2"><h3 class="font-bold">Tokens</h3><span onclick="togModal('token',0)" class="cursor-pointer">‚úï</span></div><div id="mod-tok-list" class="space-y-1 text-xs"></div></div>
</div>

<div id="vote-rew-modal" class="modal-overlay" onclick="if(event.target===this)togModal('vote-rew',0)">
    <div class="modal-box">
        <div class="flex justify-between border-b border-gray-700 pb-2 mb-2">
            <h3 class="font-bold text-cyan-400">Vote Rewards</h3>
            <span onclick="togModal('vote-rew',0)" class="cursor-pointer">‚úï</span>
        </div>
        <div class="bg-gray-900 p-2 rounded border border-gray-800 mb-3 text-[10px]">
            <div class="flex justify-between mb-1">
                <span class="text-gray-500">Periods:</span>
                <span id="mod-vote-periods" class="text-white font-mono">-</span>
            </div>
            <div class="flex justify-between">
                <span class="text-gray-500">Unclaimed:</span>
                <span id="mod-vote-epoch-count" class="text-yellow-400 font-bold">-</span>
            </div>
        </div>
        <div id="mod-vote-list" class="space-y-1 text-xs"></div>
    </div>
</div>

<div id="incentives-modal" class="modal-overlay" onclick="if(event.target===this)togModal('incentives',0)">
    <div class="modal-box w-[800px] flex flex-col"><div class="flex justify-between border-b border-gray-700 pb-2 mb-2"><h3 class="font-bold text-green-400">Incentives Detail</h3><span onclick="togModal('incentives',0)" class="cursor-pointer">‚úï</span></div>
        <div class="mb-3 text-[10px] text-gray-400 bg-gray-900 p-2 rounded border border-gray-800 font-bold" id="mod-inc-bucket-title">All Buckets</div>
        <div class="grid grid-cols-12 gap-1 text-[9px] text-gray-500 uppercase font-bold border-b border-gray-700 pb-1 mb-2">
            <div class="col-span-5">Pool</div>
            <div class="col-span-2 text-right">Bribes</div>
            <div class="col-span-2 text-right text-green-400">Total</div>
            <div class="col-span-3 text-right text-blue-400">vAPR</div>
        </div>
        <div id="mod-inc-content" class="space-y-1 text-[10px] max-h-[60vh] overflow-y-auto custom-scroll flex-grow"></div>
    </div>
</div>

<script>
// === UTILITIES ===
const $ = id => document.getElementById(id);
const setTxt = (id, v) => { const e = $(id); if(e) e.innerText = v; };
const setHtml = (id, v) => { const e = $(id); if(e) e.innerHTML = v; };
const togModal = (id, show) => { const el = $(id+'-modal'); if(el) el.classList.toggle('open', show); };
const fmt$ = n => '$' + (n || 0).toLocaleString(undefined, {maximumFractionDigits: 0});
const fmtVp = n => {
    if (!n || n === 0) return '-';
    if (n >= 1e6) return (n / 1e6).toFixed(2) + 'M';
    if (n >= 1e3) return (n / 1e3).toFixed(1) + 'K';
    return n.toLocaleString();
};

// Track sections marked as unknown (???)
let unknownSections = {
    // Key = section name, Value = comment explaining why
    // e.g., { 'votePage': 'DAODAO connection failed', 'deposits': 'Popup wouldn\'t load' }
};

// Unified number parser: handles K/M suffixes, strips non-numeric
function parseNum(s) {
    if (!s) return 0;
    let str = String(s);
    let mult = 1;
    if (/[\d\.]\s*[Kk]\b/.test(str)) mult = 1e3;
    if (/[\d\.]\s*[Mm]\b/.test(str)) mult = 1e6;
    return parseFloat(str.replace(/[^0-9\.]/g, '')) * mult || 0;
}

// Clear paste box - also restores from ??? state
function clearPaste(id) {
    const el = $(id);
    if (el) {
        el.value = '';
        el.classList.remove('hidden');
    }
    
    // Also hide the corresponding unknown comment div if it exists
    const commentMaps = {
        'votePaste': 'vote-unknown-comment',
        'voteRewardsPaste': 'rewards-unknown-comment',
        'liqFullPage': 'liq-unknown-comment',
        'liqDeposits': 'dep-unknown-comment',
        'liqRewards': 'unc-unknown-comment'
    };
    
    const commentDivId = commentMaps[id];
    if (commentDivId) {
        const commentDiv = $(commentDivId);
        if (commentDiv) {
            commentDiv.classList.add('hidden');
            // Clear the comment input too
            const input = commentDiv.querySelector('input');
            if (input) input.value = '';
        }
    }
    
    // Remove from unknownSections
    const sectionMap = {
        'votePaste': 'vote_page',
        'voteRewardsPaste': 'vote_rewards',
        'liqFullPage': 'liquidity_page',
        'liqDeposits': 'deposits',
        'liqRewards': 'unclaimed'
    };
    const section = sectionMap[id];
    if (section && unknownSections[section] !== undefined) {
        delete unknownSections[section];
    }
    
    // Reset paste status indicator to gray
    const statusMap = {
        'votePaste': 'ps-vote',
        'voteRewardsPaste': 'ps-vote-rew',
        'liqFullPage': 'ps-liq-active',
        'liqDeposits': 'ps-liq-dep',
        'liqRewards': 'ps-liq-rew'
    };
    const statusId = statusMap[id];
    if (statusId) {
        const statusEl = $(statusId);
        if (statusEl) {
            // Reset to gray (pending) state
            statusEl.className = 'px-2 py-0.5 rounded bg-gray-800 text-gray-500 border border-gray-700';
            // Remove any ??? from the text
            const baseText = statusEl.innerText.replace(/ \?\?\?$/, '').replace(/<[^>]+>/g, '');
            statusEl.innerHTML = baseText;
        }
    }
}

// Mark paste section as unknown (???) - shows comment input
function markPasteUnknown(textareaId, commentDivId) {
    const textarea = $(textareaId);
    const commentDiv = $(commentDivId);
    
    if (textarea && commentDiv) {
        // Hide textarea, show comment input
        textarea.classList.add('hidden');
        commentDiv.classList.remove('hidden');
        
        // Set textarea value to ??? marker
        textarea.value = '???';
        
        // Focus the comment input
        const input = commentDiv.querySelector('input');
        if (input) input.focus();
        
        // Map textarea ID to section name for export
        const sectionMap = {
            'votePaste': 'vote_page',
            'voteRewardsPaste': 'vote_rewards', 
            'liqFullPage': 'liquidity_page',
            'liqDeposits': 'deposits',
            'liqRewards': 'unclaimed'
        };
        
        const section = sectionMap[textareaId];
        if (section) {
            unknownSections[section] = ''; // Will be filled when input changes
            
            // Listen for input changes
            const inputEl = commentDiv.querySelector('input');
            if (inputEl) {
                inputEl.oninput = () => {
                    unknownSections[section] = inputEl.value;
                };
            }
        }
        
        // Update paste status to yellow (unknown)
        const statusMap = {
            'votePaste': 'ps-vote',
            'voteRewardsPaste': 'ps-vote-rew',
            'liqFullPage': 'ps-liq-active',
            'liqDeposits': 'ps-liq-dep',
            'liqRewards': 'ps-liq-rew'
        };
        
        const statusId = statusMap[textareaId];
        if (statusId) {
            const statusEl = $(statusId);
            if (statusEl) {
                statusEl.className = 'px-2 py-0.5 rounded bg-yellow-900/50 text-yellow-400 border border-yellow-700';
                statusEl.innerHTML = statusEl.innerText.split(' ')[0] + ' <span class="font-bold">???</span>';
            }
        }
    }
}

// Restore paste section from unknown state
function restorePasteSection(textareaId, commentDivId) {
    const textarea = $(textareaId);
    const commentDiv = $(commentDivId);
    
    if (textarea && commentDiv) {
        textarea.classList.remove('hidden');
        textarea.value = '';
        commentDiv.classList.add('hidden');
        
        // Clear from unknownSections
        const sectionMap = {
            'votePaste': 'vote_page',
            'voteRewardsPaste': 'vote_rewards',
            'liqFullPage': 'liquidity_page', 
            'liqDeposits': 'deposits',
            'liqRewards': 'unclaimed'
        };
        delete unknownSections[sectionMap[textareaId]];
    }
}

// Update paste status indicator
function updatePasteStatus(id, success, label = '') {
    let el = $(id);
    if (!el) return;
    if (success) {
        el.classList.remove('bg-gray-800', 'text-gray-500', 'border-gray-700');
        el.classList.add('bg-green-900/50', 'text-green-400', 'border-green-700');
    } else {
        el.classList.remove('bg-green-900/50', 'text-green-400', 'border-green-700');
        el.classList.add('bg-gray-800', 'text-gray-500', 'border-gray-700');
    }
    // Update tab statuses whenever paste status changes
    updateAllTabStatuses();
}

// Skip inactive liquidity step
function skipInactive() {
    pasteStatus.liqInactive = true;
    updatePasteStatus('ps-liq-inactive', true);
}

// ============ FALLBACK FUNCTIONS ============
// Load last epoch snapshot data for fallback use
async function loadLastEpochForFallback() {
    // Get the effective epoch we're working on (respects manual mode)
    const { epoch: workingEpoch } = getEffectiveEpoch();
    const targetEpoch = workingEpoch ? workingEpoch - 1 : 164; // Load epoch BEFORE the one we're working on
    
    // Check if we already have data for the right epoch
    if (lastEpochData && lastEpochInfo.epoch === targetEpoch) {
        console.log(`Using cached fallback data from E${lastEpochInfo.epoch}`);
        return lastEpochData;
    }
    
    // Clear stale cache
    lastEpochData = null;
    lastEpochInfo = { epoch: null, phase: null };
    
    const phases = ["end", "mid", "start"];
    const base = "https://raw.githubusercontent.com/defipatriot/tla_json_storage/main/tla-data-epoch";
    
    console.log(`Looking for fallback data starting from E${targetEpoch}...`);
    
    // Start from the epoch before the one we're working on
    for (let ep = targetEpoch; ep >= targetEpoch - 5; ep--) {
        for (let ph of phases) {
            try {
                const url = `${base}-${ep}-${ph}.json`;
                console.log(`Trying: ${url}`);
                let res = await fetch(url);
                if (res.ok) {
                    const data = await res.json();
                    
                    // Validate the data has what we need
                    if (!data.dao) {
                        console.log(`E${ep}-${ph} has no dao section, skipping...`);
                        continue;
                    }
                    
                    lastEpochData = data;
                    lastEpochInfo = { epoch: ep, phase: ph };
                    
                    // Update UI to show source
                    const sourceEl = $('last-epoch-source');
                    const fileEl = $('last-epoch-file');
                    if (sourceEl) sourceEl.classList.remove('hidden');
                    if (fileEl) fileEl.innerText = `Epoch ${ep} (${ph})`;
                    
                    console.log(`Loaded fallback data from E${ep} (${ph})`);
                    console.log(`DAO data preview:`, {
                        locked_vp: data.dao.locked_vp,
                        deposit_usd: data.dao.deposit_usd,
                        rewards: data.dao.rewards,
                        locks_count: data.dao.locks?.length,
                        vote_rewards: Object.keys(data.dao.vote_rewards || {}).length
                    });
                    
                    return lastEpochData;
                }
            } catch(err) {
                console.log(`Failed to load E${ep}-${ph}:`, err);
            }
        }
    }
    
    alert('Could not find any previous epoch snapshots to use as fallback.\n\nTry uploading a file manually using the file picker.');
    return null;
}

// Load fallback data from an uploaded file
function loadFallbackFromFile(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const statusEl = $('fallback-file-status');
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = JSON.parse(e.target.result);
            
            if (!data.dao) {
                alert('File does not contain DAO data');
                if (statusEl) statusEl.innerText = '‚ùå No DAO data';
                return;
            }
            
            // Store as fallback data
            lastEpochData = data;
            lastEpochInfo = { 
                epoch: data.meta?.epoch || data.vote?.epoch || 'unknown', 
                phase: data.meta?.phase || 'unknown' 
            };
            
            // Update UI
            const sourceEl = $('last-epoch-source');
            const fileEl = $('last-epoch-file');
            if (sourceEl) sourceEl.classList.remove('hidden');
            if (fileEl) fileEl.innerText = `Epoch ${lastEpochInfo.epoch} (${lastEpochInfo.phase}) - from file`;
            
            if (statusEl) {
                statusEl.innerText = `‚úì Loaded E${lastEpochInfo.epoch}`;
                statusEl.className = 'text-[8px] text-green-400';
            }
            
            console.log('Loaded fallback from file:', {
                epoch: lastEpochInfo.epoch,
                phase: lastEpochInfo.phase,
                locked_vp: data.dao.locked_vp,
                deposit_usd: data.dao.deposit_usd,
                rewards: data.dao.rewards,
                tokens: data.dao.tokens?.length
            });
            
            alert(`Loaded fallback data from file!\n\nEpoch: ${lastEpochInfo.epoch}\nPhase: ${lastEpochInfo.phase}\n\nNow click "Use Last" on the sections you want to populate.`);
            
        } catch(err) {
            console.error('Error parsing fallback file:', err);
            alert('Error parsing file: ' + err.message);
            if (statusEl) statusEl.innerText = '‚ùå Parse error';
        }
    };
    reader.readAsText(file);
}

// Use Last Epoch: aDAO Data (Rewards, VP, Deposits)
async function useLastEpochDaoData() {
    const data = await loadLastEpochForFallback();
    if (!data || !data.dao) {
        alert('No DAO data found in last epoch snapshot');
        return;
    }
    
    console.log('Loading DAO data from fallback:', data.dao);
    
    // Copy DAO data from last epoch
    // Map from JSON export format to internal store format
    store.dao.lVp = data.dao.locked_vp || 0;
    store.dao.lFac = data.dao.power_factor || 0;
    store.dao.lAst = data.dao.underlying_assets || 0;
    store.dao.dep = data.dao.deposit_usd || 0;
    store.dao.apr = data.dao.deposit_apr || 0;
    
    // Map rewards - JSON uses zAssets/ampLUNA, store uses z/amp
    if (data.dao.rewards) {
        store.dao.rew = {
            usd: data.dao.rewards.usd || 0,
            z: data.dao.rewards.zAssets || data.dao.rewards.z || 0,
            amp: data.dao.rewards.ampLUNA || data.dao.rewards.amp || 0
        };
    } else {
        store.dao.rew = { usd: 0, z: 0, amp: 0 };
    }
    
    // Load vote rewards
    store.dao.vRew = data.dao.vote_rewards || {};
    store.dao.vRewPeriods = data.dao.vote_reward_periods || [];
    
    // Load tokens
    store.dao.toks = data.dao.tokens || [];
    
    // Map locks - JSON uses 'amount', store uses 'amt'
    if (data.dao.locks && data.dao.locks.length > 0) {
        store.dao.locks = data.dao.locks.map(l => ({
            id: l.id,
            amt: l.amount || l.amt || 0,
            asset: l.asset || 'LUNA',
            bucket: l.bucket,
            vp: l.vp || 0,
            usd: l.usd || 0,
            status: l.status || 'Unknown'
        }));
    } else {
        store.dao.locks = [];
    }
    
    // Also load vote rebase/rewards if available
    if (data.vote) {
        store.vote.reb = data.vote.rebase || 0;
        store.vote.usd = data.vote.rewards_usd || 0;
    }
    
    console.log('Store after fallback load:', {
        lVp: store.dao.lVp,
        dep: store.dao.dep,
        rew: store.dao.rew,
        vRew: store.dao.vRew,
        vRewPeriods: store.dao.vRewPeriods,
        toks: store.dao.toks,
        locks: store.dao.locks
    });
    
    fallbackStatus.daoData = 'last';
    
    // Update paste statuses
    pasteStatus.voteRew = true;
    pasteStatus.liqDep = true;
    pasteStatus.liqRew = true;
    pasteStatus.locks = true;
    
    updatePasteStatus('ps-vote-rew', true);
    updatePasteStatus('ps-liq-dep', true);
    updatePasteStatus('ps-liq-rew', true);
    updatePasteStatus('ps-locks', true);
    
    // Update status indicators with yellow color for fallback
    ['ps-vote-rew', 'ps-liq-dep', 'ps-liq-rew', 'ps-locks'].forEach(id => {
        const el = $(id);
        if (el) el.className = 'px-2 py-0.5 rounded bg-yellow-900/50 text-yellow-400 border border-yellow-700';
    });
    
    // Update fallback status display
    const statusEl = $('dao-fallback-status');
    if (statusEl) {
        statusEl.classList.remove('hidden');
        statusEl.innerHTML = `<i class="fas fa-check text-yellow-400"></i> Using E${lastEpochInfo.epoch} data`;
    }
    
    // Update the UI displays
    updateDaoDisplays();
    renderVoteTable();
    renderLocks();
    alert(`Loaded aDAO data from Epoch ${lastEpochInfo.epoch} (${lastEpochInfo.phase})`);
}

// Helper to update all DAO-related UI displays
function updateDaoDisplays() {
    // Update aDAO Stats display in Vote Dashboard
    setTxt('adao-vp', typeof store.dao.lVp === 'number' ? store.dao.lVp.toLocaleString() : (store.dao.lVp || '???'));
    setTxt('adao-pct', store.vote.tvp > 0 && typeof store.dao.lVp === 'number' ? ((store.dao.lVp / store.vote.tvp) * 100).toFixed(2) + '%' : '0%');
    setTxt('adao-reb', typeof store.vote.reb === 'number' ? store.vote.reb.toFixed(2) + ' amp' : (store.vote.reb || '???'));
    setTxt('adao-unclaimed', formatValueOrUnknown(store.dao.rew?.usd, '$', ''));
    
    // Update Liquidity tab displays
    setTxt('dao-dep-total', formatValueOrUnknown(store.dao.dep, '$', ''));
    setTxt('dao-dep-apr', formatValueOrUnknown(store.dao.apr, '', '%', 1));
    setTxt('dao-rew-usd', formatValueOrUnknown(store.dao.rew?.usd, '$', '', 2));
    setTxt('dao-rew-z', formatValueOrUnknown(store.dao.rew?.z, '', ''));
    setTxt('dao-rew-amp', formatValueOrUnknown(store.dao.rew?.amp, '', ''));
    
    // Update Locks display
    setTxt('locks-vp', formatValueOrUnknown(store.dao.lVp, '', ' VP'));
    setTxt('locks-factor', typeof store.dao.lFac === 'number' ? store.dao.lFac.toFixed(2) + 'x' : (store.dao.lFac || '-'));
    setTxt('locks-assets', typeof store.dao.lAst === 'number' ? store.dao.lAst.toLocaleString() + ' LUNA' : (store.dao.lAst || '-'));
}

// Helper to format value or show ??? if unknown
function formatValueOrUnknown(val, prefix = '', suffix = '', decimals = 0) {
    if (val === '???' || val === undefined || val === null) {
        return prefix + '???' + suffix;
    }
    if (typeof val !== 'number') {
        return prefix + String(val) + suffix;
    }
    if (decimals > 0) {
        return prefix + val.toFixed(decimals) + suffix;
    }
    return prefix + val.toLocaleString() + suffix;
}

// Use Last Epoch: Vote Rewards only
async function useLastEpochVoteRewards() {
    const data = await loadLastEpochForFallback();
    if (!data || !data.dao) {
        alert('No vote rewards data found in last epoch snapshot');
        return;
    }
    
    store.dao.vRew = data.dao.vote_rewards || {};
    store.dao.vRewPeriods = data.dao.vote_reward_periods || [];
    store.vote.reb = data.vote?.rebase || 0;
    store.vote.usd = data.vote?.rewards_usd || 0;
    
    fallbackStatus.voteRewards = 'last';
    pasteStatus.voteRew = true;
    
    const el = $('ps-vote-rew');
    if (el) el.className = 'px-2 py-0.5 rounded bg-yellow-900/50 text-yellow-400 border border-yellow-700';
    
    const statusEl = $('voterew-fallback-status');
    if (statusEl) {
        statusEl.classList.remove('hidden');
        statusEl.innerHTML = `<i class="fas fa-check text-yellow-400"></i> Using E${lastEpochInfo.epoch}`;
    }
    
    // Update UI displays
    setTxt('adao-reb', store.vote.reb ? store.vote.reb.toFixed(2) + ' amp' : '0');
    
    renderVoteTable();
    alert(`Loaded vote rewards from Epoch ${lastEpochInfo.epoch}`);
}

// Use Last Epoch: Locks only
async function useLastEpochLocks() {
    const data = await loadLastEpochForFallback();
    if (!data || !data.dao) {
        alert('No locks data found in last epoch snapshot');
        return;
    }
    
    store.dao.locks = data.dao.locks || [];
    store.dao.lVp = data.dao.locked_vp || 0;
    store.dao.lFac = data.dao.power_factor || 0;
    store.dao.lAst = data.dao.underlying_assets || 0;
    
    fallbackStatus.locks = 'last';
    pasteStatus.locks = true;
    
    const el = $('ps-locks');
    if (el) el.className = 'px-2 py-0.5 rounded bg-yellow-900/50 text-yellow-400 border border-yellow-700';
    
    const statusEl = $('locks-fallback-status');
    if (statusEl) {
        statusEl.classList.remove('hidden');
        statusEl.innerHTML = `<i class="fas fa-check text-yellow-400"></i> Using E${lastEpochInfo.epoch}`;
    }
    
    // Update aDAO Stats display
    setTxt('adao-vp', store.dao.lVp.toLocaleString());
    setTxt('adao-pct', store.vote.tvp > 0 ? ((store.dao.lVp / store.vote.tvp) * 100).toFixed(2) + '%' : '0%');
    setTxt('locks-vp', (store.dao.lVp || 0).toLocaleString() + ' VP');
    setTxt('locks-factor', store.dao.lFac ? store.dao.lFac.toFixed(2) + 'x' : '-');
    setTxt('locks-assets', store.dao.lAst ? store.dao.lAst.toLocaleString() + ' LUNA' : '-');
    
    renderLocks();
    renderVoteTable();
    alert(`Loaded locks from Epoch ${lastEpochInfo.epoch}`);
}

// Use Last Epoch: Unclaimed Rewards only
async function useLastEpochUnclaimed() {
    const data = await loadLastEpochForFallback();
    if (!data || !data.dao) {
        alert('No unclaimed rewards data found in last epoch snapshot');
        return;
    }
    
    // Map rewards - JSON uses zAssets/ampLUNA, store uses z/amp
    if (data.dao.rewards) {
        store.dao.rew = {
            usd: data.dao.rewards.usd || 0,
            z: data.dao.rewards.zAssets || data.dao.rewards.z || 0,
            amp: data.dao.rewards.ampLUNA || data.dao.rewards.amp || 0
        };
    }
    
    fallbackStatus.unclaimed = 'last';
    pasteStatus.liqRew = true;
    
    const el = $('ps-liq-rew');
    if (el) el.className = 'px-2 py-0.5 rounded bg-yellow-900/50 text-yellow-400 border border-yellow-700';
    
    const statusEl = $('unclaimed-fallback-status');
    if (statusEl) {
        statusEl.classList.remove('hidden');
        statusEl.innerHTML = `<i class="fas fa-check text-yellow-400"></i> Using E${lastEpochInfo.epoch}`;
    }
    
    // Update UI displays
    setTxt('dao-rew-usd', '$' + (store.dao.rew?.usd || 0).toFixed(2));
    setTxt('dao-rew-z', (store.dao.rew?.z || 0).toLocaleString());
    setTxt('dao-rew-amp', (store.dao.rew?.amp || 0).toLocaleString());
    setTxt('adao-unclaimed', store.dao.rew?.usd ? '$' + store.dao.rew.usd.toFixed(0) : '$0');
    
    alert(`Loaded unclaimed rewards from Epoch ${lastEpochInfo.epoch}`);
}

// Skip functions - mark as intentionally skipped (will export as null/0)
function skipDaoData() {
    fallbackStatus.daoData = 'skip';
    pasteStatus.voteRew = true;
    pasteStatus.liqDep = true;
    pasteStatus.liqRew = true;
    pasteStatus.locks = true;
    
    ['ps-vote-rew', 'ps-liq-dep', 'ps-liq-rew', 'ps-locks'].forEach(id => {
        const el = $(id);
        if (el) el.className = 'px-2 py-0.5 rounded bg-gray-700 text-gray-400 border border-gray-600';
    });
    
    const statusEl = $('dao-fallback-status');
    if (statusEl) {
        statusEl.classList.remove('hidden');
        statusEl.innerHTML = `<i class="fas fa-forward text-gray-400"></i> Skipped`;
    }
}

function skipVoteRewards() {
    fallbackStatus.voteRewards = 'skip';
    pasteStatus.voteRew = true;
    
    const el = $('ps-vote-rew');
    if (el) el.className = 'px-2 py-0.5 rounded bg-gray-700 text-gray-400 border border-gray-600';
    
    const statusEl = $('voterew-fallback-status');
    if (statusEl) {
        statusEl.classList.remove('hidden');
        statusEl.innerHTML = `<i class="fas fa-forward text-gray-400"></i> Skipped`;
    }
}

function skipLocks() {
    fallbackStatus.locks = 'skip';
    pasteStatus.locks = true;
    
    const el = $('ps-locks');
    if (el) el.className = 'px-2 py-0.5 rounded bg-gray-700 text-gray-400 border border-gray-600';
    
    const statusEl = $('locks-fallback-status');
    if (statusEl) {
        statusEl.classList.remove('hidden');
        statusEl.innerHTML = `<i class="fas fa-forward text-gray-400"></i> Skipped`;
    }
}

function skipUnclaimed() {
    fallbackStatus.unclaimed = 'skip';
    pasteStatus.liqRew = true;
    
    const el = $('ps-liq-rew');
    if (el) el.className = 'px-2 py-0.5 rounded bg-gray-700 text-gray-400 border border-gray-600';
    
    const statusEl = $('unclaimed-fallback-status');
    if (statusEl) {
        statusEl.classList.remove('hidden');
        statusEl.innerHTML = `<i class="fas fa-forward text-gray-400"></i> Skipped`;
    }
}

// ============ MANUAL/RECOVERY MODE FUNCTIONS ============

function toggleManualMode() {
    const isChecked = $('manual-mode-toggle').checked;
    const optionsEl = $('manual-mode-options');
    
    if (isChecked) {
        optionsEl.classList.remove('hidden');
        // Pre-fill with current values from session manager
        $('manual-epoch').value = $('historyEpoch').value || '';
        $('manual-phase').value = $('historyPhase').value || 'end';
        
        // Default date to today
        const today = new Date().toISOString().split('T')[0];
        $('manual-date').value = today;
    } else {
        optionsEl.classList.add('hidden');
        deactivateManualMode();
    }
}

function deactivateManualMode() {
    manualMode.active = false;
    manualMode.epoch = null;
    manualMode.phase = null;
    manualMode.timestamp = null;
    
    // Restore original epoch info if we stored it
    if (manualMode.originalEpochInfo) {
        currentEpochInfo = manualMode.originalEpochInfo;
        manualMode.originalEpochInfo = null;
    }
    
    $('manual-mode-status')?.classList.add('hidden');
    
    // Refresh status indicators for current epoch
    updateExtFileStatus();
    updateTimers();
}

async function applyManualMode() {
    const epoch = parseInt($('manual-epoch').value);
    const phase = $('manual-phase').value;
    const dateStr = $('manual-date').value;
    const timeStr = $('manual-time').value || '23:59';
    
    if (!epoch) {
        alert('Please enter an epoch number');
        return;
    }
    
    if (!dateStr) {
        alert('Please enter a snapshot date');
        return;
    }
    
    console.log(`Applying manual mode: Epoch ${epoch}, Phase ${phase}, Date ${dateStr}`);
    
    // Store original epoch info before overriding
    if (!manualMode.originalEpochInfo && currentEpochInfo) {
        manualMode.originalEpochInfo = { ...currentEpochInfo };
    }
    
    // Create manual timestamp
    const manualTimestamp = new Date(`${dateStr}T${timeStr}:00Z`).toISOString();
    
    // Activate manual mode
    manualMode.active = true;
    manualMode.epoch = epoch;
    manualMode.phase = phase;
    manualMode.timestamp = manualTimestamp;
    
    // Override currentEpochInfo to make tool think we're in the selected epoch
    // Find epoch data from epoch file
    const epochEntry = epochData.find(e => e.epoch === epoch);
    if (epochEntry) {
        currentEpochInfo = {
            epoch: epoch,
            start_time: epochEntry.start_time,
            end_time: epochEntry.end_time,
            rewards_update: epochEntry.rewards_update
        };
        console.log('Found epoch in epochData:', currentEpochInfo);
    } else {
        // Create a fake epoch info if not in epoch file
        currentEpochInfo = {
            epoch: epoch,
            start_time: null,
            end_time: null
        };
        console.log('Epoch not in file, using placeholder');
    }
    
    // Update session manager to match
    $('historyEpoch').value = epoch;
    $('historyPhase').value = phase;
    
    // Update UI
    setTxt('live-epoch', `Epoch ${epoch}`);
    $('live-epoch').className = 'text-xs bg-yellow-900/50 text-yellow-400 px-2 py-0.5 rounded border border-yellow-700 font-mono ml-2';
    
    // Show manual mode status
    const statusEl = $('manual-mode-status');
    if (statusEl) {
        statusEl.classList.remove('hidden');
        setTxt('manual-mode-ep', epoch);
        setTxt('manual-mode-phase', phase);
        setTxt('manual-mode-timestamp', new Date(manualTimestamp).toLocaleString());
    }
    
    // Update ext file status indicators for this epoch
    await updateExtFileStatusForEpoch(epoch, phase);
    
    // Load the existing data for this epoch if available
    console.log('Calling fetchCoreData...');
    try {
        await fetchCoreData();
        console.log('fetchCoreData completed');
    } catch(e) {
        console.error('fetchCoreData error:', e);
        alert(`Note: Could not load existing data for E${epoch} (${phase}).\n\nYou may need to paste data manually or the file may not exist yet.`);
    }
    
    console.log(`Manual mode activated: Epoch ${epoch} (${phase}), timestamp: ${manualTimestamp}`);
}

// Check ext file status for a specific epoch (used in manual mode)
async function updateExtFileStatusForEpoch(epoch, phase) {
    // When manual mode changes, reload all ext data checks with new epoch
    console.log(`Refreshing all status checks for E${epoch} (${phase})`);
    
    // Reset acknowledged flags when epoch changes
    Object.keys(fileStatus).forEach(key => {
        fileStatus[key].acknowledged = false;
    });
    
    // Re-run loadExtData which will use getEffectiveEpoch() 
    await loadExtData();
}

// Get the effective epoch for status checks (uses manual mode if active)
function getEffectiveEpoch() {
    if (manualMode.active) {
        return { epoch: manualMode.epoch, phase: manualMode.phase };
    }
    return { 
        epoch: currentEpochInfo?.epoch || store.vote.ep, 
        phase: getPhaseString() 
    };
}

// ============ FILE STATUS TRACKING SYSTEM ============
// Status: 'green' = good, 'yellow' = needs update, 'red' = missing/error, 'acknowledged' = yellow but user clicked OK
let fileStatus = {
    epochFile: { status: 'loading', data: null, acknowledged: false, maxEpoch: null },
    historical: { status: 'loading', data: null, acknowledged: false, epochEnd: null },
    archive: { status: 'loading', data: null, acknowledged: false },
    epochExt: { status: 'loading', data: null, acknowledged: false, foundEpoch: null, foundPhase: null },
    pdBribes: { status: 'loading', data: null, acknowledged: false, maxEpoch: null },
    assetMeta: { status: 'red', acknowledged: false, lastEpoch: null }
};

// Acknowledge a yellow status (user clicks to say "I'm aware, proceed")
function acknowledgeStatus(key) {
    if (fileStatus[key] && fileStatus[key].status === 'yellow') {
        fileStatus[key].acknowledged = true;
        updateStatusDisplay(key);
        console.log(`Acknowledged ${key} status`);
    }
}

// Update visual display for a status indicator
function updateStatusDisplay(key) {
    const config = {
        epochFile: { el: 'status-epoch-file', dateEl: null, label: 'Epoch File' },
        historical: { el: 'status-historical', dateEl: 'status-historical-date', label: 'Historical' },
        archive: { el: 'status-archive', dateEl: 'status-archive-date', label: 'Archive' },
        epochExt: { el: 'status-epoch-ext', dateEl: 'status-epoch-ext-date', label: 'Ep Ext' },
        pdBribes: { el: 'status-pd-bribes', dateEl: 'status-pd-bribes-date', label: 'PD Bribes' },
        assetMeta: { el: 'status-asset-meta', dateEl: 'status-asset-meta-count', label: 'Asset Meta' }
    };
    
    const c = config[key];
    if (!c) return;
    
    const el = $(c.el);
    const dateEl = c.dateEl ? $(c.dateEl) : null;
    const fs = fileStatus[key];
    
    if (!el) return;
    
    // Determine display status (acknowledged yellow = green with checkmark)
    let displayStatus = fs.status;
    if (fs.status === 'yellow' && fs.acknowledged) {
        displayStatus = 'acknowledged';
    }
    
    switch (displayStatus) {
        case 'green':
            el.className = 'text-green-500 font-bold cursor-pointer';
            el.innerText = c.label + ' ‚úì';
            break;
        case 'yellow':
            el.className = 'text-yellow-500 font-bold cursor-pointer';
            el.innerText = c.label + ' ‚ö†';
            el.title = 'Click to acknowledge - ' + (fs.reason || 'Needs update');
            break;
        case 'acknowledged':
            el.className = 'text-green-500 font-bold cursor-pointer';
            el.innerText = c.label + ' ‚úì';
            el.title = 'Acknowledged (was: ' + (fs.reason || 'needs update') + ')';
            break;
        case 'red':
            el.className = 'text-red-500 font-bold cursor-pointer';
            el.innerText = c.label + ' ‚úó';
            break;
        case 'loading':
            el.className = 'text-gray-500 font-semibold cursor-pointer';
            el.innerText = c.label;
            break;
    }
    
    // Update date/info display
    if (dateEl && fs.dateInfo) {
        dateEl.innerText = fs.dateInfo;
        dateEl.className = displayStatus === 'red' ? 'text-[8px] text-red-600' : 
                          displayStatus === 'yellow' ? 'text-[8px] text-yellow-500' : 
                          'text-[8px] text-gray-400';
    }
}

// Update test mode banner visibility
function updateTestModeBanner() {
    const banner = $('test-mode-banner');
    if (!banner) return;
    
    if (store.extFile.isTest) {
        banner.classList.remove('hidden');
        const filenameEl = $('test-mode-filename');
        if (filenameEl) {
            filenameEl.textContent = `tla-ext-epoch-${store.extFile.epoch}-${store.extFile.phase}_test.json`;
        }
    } else {
        banner.classList.add('hidden');
    }
}

// Check all file statuses and determine if export should warn
function getExportWarnings() {
    const warnings = [];
    
    for (const [key, fs] of Object.entries(fileStatus)) {
        if (fs.status === 'red' && !fs.acknowledged) {
            warnings.push(`${key}: Missing/Error`);
        } else if (fs.status === 'yellow' && !fs.acknowledged) {
            warnings.push(`${key}: ${fs.reason || 'Needs update'}`);
        }
    }
    
    return warnings;
}

const BUCKET_ORDER = ['STABLE', 'PROJECT', 'BLUECHIP', 'SINGLE'];

// === DATA STORE ===
let store = {
    dao: { dep: 0, depTla: 0, depCalc: 0, depSource: '--', apr: 0, rew: {z: 0, amp: 0, usd: 0}, toks: [], vRew: {}, vRewPeriods: [], lVp: 0, lFac: 0, lAst: 0, locks: [] },
    tla: { tvl: 0, rewYr: 0, pools: [], inactivePools: [] },
    vote: { ep: 0, end: '-', pools: [], tvp: 0, reb: 0, usd: 0 },
    ext: { lps: {}, meta: {}, loaded: false },
    // New: Ext file data from tla-ext_json_storage
    extFile: {
        loaded: false,
        isTest: false,          // true if loaded from _test.json
        epoch: null,
        phase: null,
        data: null,             // Full ext file data
        votion: null,           // Votion data (lockups, pools, VP)
        lstRatios: null,        // LST ratios with APYs
        tokenPrices: null,      // Token prices
        lpRegistry: null,       // LP catalog
        pdBribes: null          // PD bribes for current epoch
    },
    // Dashboard data (on-chain queries + manual)
    dashboard: {
        treasuryTokens: [],
        treasuryUsd: 0,
        unmintedBackingUsd: 0,
        backingAmpLuna: 0,
        backingLuna: 0,
        backingUsd: 0,
        avgDailyGain: 0,
        manual: null
    },
    // NFT Stats data (deving.zone + manual marketplace data)
    nftStats: {
        brokenCount: 0,
        unbrokenCount: 0,
        mintedCount: 0,
        unmintedCount: 0,
        daodaoStaked: 0,
        daodaoStakedPct: 0,
        enterpriseStaked: 0,
        daoMembers: 0,
        daoBrokenHeld: 0,
        circulatingSupply: 0,
        liquidSupply: 0,
        backingAmpLuna: 0,
        backingLuna: 0,
        backingUsd: 0,
        // BBL Marketplace
        bblSales: [],
        bblFloor: null,
        bblVolume: 0,
        bblListingsBroken: 0,
        bblListingsUnbroken: 0,
        bblListingsTotal: 0,
        bblListingItems: [],
        // Boost Marketplace
        boostSales: [],
        boostFloor: null,
        boostVolume: 0,
        boostListingsBroken: 0,
        boostListingsUnbroken: 0,
        boostListingsTotal: 0,
        boostListingItems: [],
        manual: null
    }
};

// Paste completion status
let pasteStatus = {
    vote: false,
    voteRew: false,
    liqActive: false,
    liqInactive: false,
    liqDep: false,
    liqRew: false,
    locks: false,
    ext: false,
    assetMetaVerified: false,  // Asset metadata reviewed/updated
    assetMetaNewAssets: []     // New assets found that need review
};

// Fallback status - tracks which sections used fallback
let fallbackStatus = {
    daoData: null,      // null = not set, 'last' = from last epoch, 'skip' = intentionally skipped
    voteRewards: null,
    locks: null,
    unclaimed: null,
    adaoVotes: null     // aDAO vote allocations
};

// Last epoch data cache (loaded from previous snapshot)
let lastEpochData = null;
let lastEpochInfo = { epoch: null, phase: null };

// Manual/Recovery Mode state
let manualMode = {
    active: false,
    epoch: null,
    phase: null,
    timestamp: null,  // ISO string for manual timestamp
    originalEpochInfo: null  // Store the real current epoch info
};

// === EPOCH DATA ===
let epochData = []; // Will be loaded from GitHub
let currentEpochInfo = null;

// === INIT ===
window.onload = async function() {
    await loadEpochData();
    await loadExtData();
    await findLatestSnapshot();
    setInterval(updateTimers, 1000);
    updateTimers();
    updateGithubLink();
};

async function loadEpochData() {
    const url = 'https://raw.githubusercontent.com/defipatriot/tla_json_storage/main/epoch_1-300_date.json';
    
    try {
        let res = await fetch(url);
        if (!res.ok) throw new Error("Failed to fetch");
        epochData = await res.json();
        
        // Find max epoch in the file
        const maxEpoch = epochData.reduce((max, e) => Math.max(max, e.epoch), 0);
        fileStatus.epochFile.maxEpoch = maxEpoch;
        fileStatus.epochFile.data = epochData;
        
        // Check if we're getting close to needing an update (within 20 epochs of max)
        const effectiveEp = getEffectiveEpoch().epoch || 165;
        if (maxEpoch - effectiveEp < 20) {
            fileStatus.epochFile.status = 'yellow';
            fileStatus.epochFile.reason = `Only ${maxEpoch - effectiveEp} epochs left (max: ${maxEpoch})`;
            fileStatus.epochFile.dateInfo = `to E${maxEpoch}`;
        } else {
            fileStatus.epochFile.status = 'green';
            fileStatus.epochFile.dateInfo = `to E${maxEpoch}`;
        }
        
        updateStatusDisplay('epochFile');
        findCurrentEpoch();
    } catch(e) {
        console.error("Failed to load epoch data:", e);
        fileStatus.epochFile.status = 'red';
        fileStatus.epochFile.reason = 'Failed to load';
        updateStatusDisplay('epochFile');
    }
}

async function loadExtData() {
    // Use effective epoch (respects manual mode)
    const { epoch, phase } = getEffectiveEpoch();
    const workingEpoch = epoch || currentEpochInfo?.epoch || store.vote.ep || 165;
    const workingPhase = phase || 'end';
    
    console.log('Ext data: working epoch=' + workingEpoch + ', phase=' + workingPhase);
    
    const extBaseUrl = 'https://raw.githubusercontent.com/defipatriot/tla-ext_json_storage/main/';
    const mainBaseUrl = 'https://raw.githubusercontent.com/defipatriot/tla_json_storage/main/';
    
    // ============ CHECK HISTORICAL ============
    try {
        const res = await fetch(extBaseUrl + 'tla_ext_historical.json?t=' + Date.now());
        if (res.ok) {
            const data = await res.json();
            fileStatus.historical.data = data;
            
            // Get epoch range from file
            const epochEnd = data.meta?.epoch_end || null;
            fileStatus.historical.epochEnd = epochEnd;
            
            // Historical should be updated monthly (~4 epochs)
            // Yellow if more than 4 epochs behind
            if (epochEnd && workingEpoch - epochEnd > 4) {
                fileStatus.historical.status = 'yellow';
                fileStatus.historical.reason = `Last updated E${epochEnd}, ${workingEpoch - epochEnd} epochs behind`;
                fileStatus.historical.dateInfo = `E${data.meta?.epoch_start || '?'}-${epochEnd}`;
            } else {
                fileStatus.historical.status = 'green';
                fileStatus.historical.dateInfo = `E${data.meta?.epoch_start || '?'}-${epochEnd || '?'}`;
            }
        } else {
            fileStatus.historical.status = 'red';
            fileStatus.historical.reason = 'File not found';
            fileStatus.historical.dateInfo = 'missing';
        }
    } catch(e) {
        fileStatus.historical.status = 'red';
        fileStatus.historical.reason = 'Load error';
        fileStatus.historical.dateInfo = 'error';
    }
    updateStatusDisplay('historical');
    
    // ============ CHECK ARCHIVE ============
    try {
        const res = await fetch(extBaseUrl + 'tla_ext_archive.json?t=' + Date.now());
        if (res.ok) {
            const data = await res.json();
            fileStatus.archive.data = data;
            fileStatus.archive.status = 'green';
            fileStatus.archive.dateInfo = `E${data.meta?.epoch_start || '?'}-${data.meta?.epoch_end || '?'}`;
        } else {
            fileStatus.archive.status = 'red';
            fileStatus.archive.dateInfo = 'missing';
        }
    } catch(e) {
        fileStatus.archive.status = 'red';
        fileStatus.archive.dateInfo = 'error';
    }
    updateStatusDisplay('archive');
    
    // ============ CHECK EPOCH EXT ============
    // Try phases in order for the working epoch
    // First try production files, then test files
    const phasesToTry = [workingPhase, 'end', 'mid', 'start'].filter((v, i, a) => a.indexOf(v) === i);
    let foundEpochExt = false;
    let isTestFile = false;
    
    // Try production files first
    for (const tryPhase of phasesToTry) {
        try {
            const url = extBaseUrl + `tla-ext-epoch-${workingEpoch}-${tryPhase}.json`;
            const res = await fetch(url + '?t=' + Date.now());
            if (res.ok) {
                const data = await res.json();
                if (data.meta && data.votion) {
                    fileStatus.epochExt.data = data;
                    fileStatus.epochExt.status = 'green';
                    fileStatus.epochExt.foundEpoch = workingEpoch;
                    fileStatus.epochExt.foundPhase = tryPhase;
                    fileStatus.epochExt.dateInfo = `E${workingEpoch}-${tryPhase}`;
                    foundEpochExt = true;
                    isTestFile = false;
                    console.log(`Found epochExt (production): E${workingEpoch}-${tryPhase}`);
                    break;
                }
            }
        } catch(e) {
            console.log(`Failed to load E${workingEpoch}-${tryPhase}`);
        }
    }
    
    // If no production file found, try test files
    if (!foundEpochExt) {
        for (const tryPhase of phasesToTry) {
            try {
                const url = extBaseUrl + `tla-ext-epoch-${workingEpoch}-${tryPhase}_test.json`;
                const res = await fetch(url + '?t=' + Date.now());
                if (res.ok) {
                    const data = await res.json();
                    if (data.meta && data.votion) {
                        fileStatus.epochExt.data = data;
                        fileStatus.epochExt.status = 'yellow'; // Yellow for test
                        fileStatus.epochExt.foundEpoch = workingEpoch;
                        fileStatus.epochExt.foundPhase = tryPhase;
                        fileStatus.epochExt.dateInfo = `E${workingEpoch}-${tryPhase} üß™`;
                        foundEpochExt = true;
                        isTestFile = true;
                        console.log(`Found epochExt (TEST): E${workingEpoch}-${tryPhase}_test`);
                        break;
                    }
                }
            } catch(e) {
                console.log(`Failed to load E${workingEpoch}-${tryPhase}_test`);
            }
        }
    }
    
    // Load ext file data into store
    if (foundEpochExt && fileStatus.epochExt.data) {
        const extData = fileStatus.epochExt.data;
        store.extFile = {
            loaded: true,
            isTest: isTestFile,
            epoch: extData.meta?.epoch,
            phase: extData.meta?.phase,
            data: extData,
            votion: extData.votion || null,
            lstRatios: extData.lst_ratios || null,
            tokenPrices: extData.token_prices || null,
            lpRegistry: extData.lp_registry || null,
            pdBribes: extData.pd_bribes || null,
            pdBribesMaster: extData.pd_bribes_master || null
        };
        console.log('Ext file loaded into store:', store.extFile.isTest ? 'TEST MODE' : 'PRODUCTION');
        
        // Show test mode banner if needed
        updateTestModeBanner();
    }
    
    if (!foundEpochExt) {
        fileStatus.epochExt.status = 'red';
        fileStatus.epochExt.reason = `E${workingEpoch} not found`;
        fileStatus.epochExt.dateInfo = `E${workingEpoch} missing`;
    }
    updateStatusDisplay('epochExt');
    
    // ============ CHECK PD BRIBES ============
    try {
        const res = await fetch(extBaseUrl + 'tla_pd_bribes.json?t=' + Date.now());
        if (res.ok) {
            const data = await res.json();
            fileStatus.pdBribes.data = data;
            
            // Find max end_epoch in the bribes data
            let maxEndEpoch = 0;
            if (Array.isArray(data)) {
                data.forEach(item => {
                    if (item.end_epoch && item.end_epoch > maxEndEpoch) {
                        maxEndEpoch = item.end_epoch;
                    }
                });
            }
            fileStatus.pdBribes.maxEpoch = maxEndEpoch;
            
            // Yellow if working epoch is past the last bribe range
            if (maxEndEpoch && workingEpoch > maxEndEpoch) {
                fileStatus.pdBribes.status = 'yellow';
                fileStatus.pdBribes.reason = `Bribes end at E${maxEndEpoch}, working on E${workingEpoch}`;
                fileStatus.pdBribes.dateInfo = `[E${maxEndEpoch}] expired`;
            } else {
                fileStatus.pdBribes.status = 'green';
                fileStatus.pdBribes.dateInfo = `[${data[data.length-1]?.epoch_range || '?'}]`;
            }
        } else {
            fileStatus.pdBribes.status = 'red';
            fileStatus.pdBribes.reason = 'File not found';
            fileStatus.pdBribes.dateInfo = 'missing';
        }
    } catch(e) {
        fileStatus.pdBribes.status = 'red';
        fileStatus.pdBribes.dateInfo = 'error';
    }
    updateStatusDisplay('pdBribes');
    
    // ============ LOAD ASSET METADATA EPOCH INFO ============
    // Load tla_metadata.json to get last_updated_epoch for Asset Meta display
    try {
        const res = await fetch(mainBaseUrl + 'tla_metadata.json?t=' + Date.now());
        if (res.ok) {
            const data = await res.json();
            // Update assetMetadataMeta with epoch info
            if (data.meta) {
                assetMetadataMeta.last_updated_epoch = data.meta.last_updated_epoch || null;
                assetMetadataMeta.last_updated_date = data.meta.last_updated_date || null;
            }
        }
    } catch(e) {
        console.log('Could not load tla_metadata.json for epoch info');
    }
    
    // ============ APPLY LOADED DATA TO STORE ============
    // Now apply the data we collected to the store
    
    // Apply historical LP data
    if (fileStatus.historical.data && fileStatus.historical.data.lps) {
        store.ext.lps = { ...store.ext.lps, ...fileStatus.historical.data.lps };
        store.ext.loaded = true;
        console.log('Applied historical:', Object.keys(fileStatus.historical.data.lps).length, 'LPs');
    }
    
    // Apply archive LP data
    if (fileStatus.archive.data && fileStatus.archive.data.lps) {
        store.ext.lps = { ...store.ext.lps, ...fileStatus.archive.data.lps };
        console.log('Applied archive:', Object.keys(fileStatus.archive.data.lps).length, 'LPs');
    }
    
    // Apply epoch ext data (votion, pd_bribes for this epoch)
    if (fileStatus.epochExt.data) {
        store.ext.votion = fileStatus.epochExt.data.votion || null;
        store.ext.pdBribesEpoch = fileStatus.epochExt.data.pd_bribes || null;
        console.log('Applied epoch ext: votion=' + !!store.ext.votion + ', pd_bribes=' + !!store.ext.pdBribesEpoch);
    }
    
    // Apply PD bribes master file
    if (fileStatus.pdBribes.data) {
        store.ext.pdBribesMaster = fileStatus.pdBribes.data;
        console.log('Applied PD bribes master:', store.ext.pdBribesMaster.length, 'ranges');
    }
    
    // Show legend if we have lps data
    if (store.ext.loaded) {
        let legend = $('ext-data-legend');
        if (legend) legend.classList.remove('hidden');
        
        // Update paste progress status
        pasteStatus.ext = true;
        updatePasteStatus('ps-ext', true);
        
        // Re-render vote table to apply ext data
        if (store.vote.pools.length > 0) {
            applyExtDataToPools();
            renderVoteTable();
        }
    }
}


function showExtManualLoad() {
    let el = $('ext-manual-load');
    if (el) el.classList.remove('hidden');
}

function toggleExtPaste() {
    let el = $('ext-paste-area');
    if (el) el.classList.toggle('hidden');
}

function loadExtFromFile(event) {
    let file = event.target.files[0];
    if (!file) return;
    
    let reader = new FileReader();
    reader.onload = function(e) {
        try {
            let data = JSON.parse(e.target.result);
            applyExtData(data);
        } catch(err) {
            alert('Error parsing ext JSON file: ' + err.message);
        }
    };
    reader.readAsText(file);
}

function loadExtFromPaste() {
    let txt = $('ext-paste').value;
    if (!txt.trim()) {
        alert('Please paste ext JSON data first');
        return;
    }
    
    try {
        let data = JSON.parse(txt);
        applyExtData(data);
    } catch(err) {
        alert('Error parsing ext JSON: ' + err.message);
    }
}

function applyExtData(data) {
    store.ext.lps = data.lps || {};
    store.ext.meta = data.meta || {};
    store.ext.loaded = true;
    
    // Update paste progress status
    updatePasteStatus('ps-ext', true);
    
    // Show legend
    let legend = $('ext-data-legend');
    if (legend) legend.classList.remove('hidden');
    
    // Hide manual load section
    let manualEl = $('ext-manual-load');
    if (manualEl) manualEl.classList.add('hidden');
    
    // Re-render vote table to apply ext data
    if (store.vote.pools.length > 0) {
        applyExtDataToPools();
        renderVoteTable();
    }
    
    alert('Ext data loaded: ' + Object.keys(store.ext.lps).length + ' LPs');
}

function applyExtDataToPools() {
    if (!store.ext.loaded && !store.ext.votion && !store.ext.pdBribesEpoch) return;
    
    // Get current epoch for looking up data
    let targetEpoch = store.vote.ep || currentEpochInfo?.epoch || 0;
    
    // Get votion data - handle both old (lockups) and new (pools) formats
    let votionTotalVp = store.ext.votion?.total_vp || 0;
    let votionPools = store.ext.votion?.pools || {};
    let votionRatios = store.ext.votion?.ratios || {};
    
    // If we have lockups but no pools, aggregate from lockups (old format)
    if (store.ext.votion?.lockups && Object.keys(votionPools).length === 0) {
        store.ext.votion.lockups.forEach(lockup => {
            votionTotalVp += lockup.vp || 0;
            
            lockup.buckets?.forEach(bucket => {
                bucket.pools?.forEach(pool => {
                    let poolName = pool.name
                        .replace(' LP', '')
                        .replace(/\.(atom|axl|osmo|wh)/gi, '')
                        .trim();
                    
                    // Normalize LUNA position - only swap if LUNA itself is second
                    if (poolName.includes('-')) {
                        let parts = poolName.split('-');
                        if (parts[1] === 'LUNA') {
                            poolName = `LUNA-${parts[0]}`;
                        }
                    }
                    
                    let lpKey = `${poolName}|Astroport`;
                    
                    if (!votionPools[lpKey]) {
                        votionPools[lpKey] = { current_pct: 0, current_vp: 0, optimized_pct: 0, optimized_vp: 0 };
                    }
                    
                    let lockupVp = lockup.vp || 0;
                    votionPools[lpKey].current_vp += lockupVp * (pool.current / 100);
                    votionPools[lpKey].optimized_vp += lockupVp * (pool.optimized / 100);
                });
            });
        });
        
        // Calculate percentages
        Object.keys(votionPools).forEach(key => {
            if (votionTotalVp > 0) {
                votionPools[key].current_pct = (votionPools[key].current_vp / votionTotalVp) * 100;
                votionPools[key].optimized_pct = (votionPools[key].optimized_vp / votionTotalVp) * 100;
            }
            votionPools[key].current_vp = Math.round(votionPools[key].current_vp);
            votionPools[key].optimized_vp = Math.round(votionPools[key].optimized_vp);
        });
        
        console.log('Aggregated votion from lockups:', Object.keys(votionPools).length, 'pools, total VP:', votionTotalVp.toLocaleString());
    }
    
    // Get PD bribes from epoch ext file (not master)
    let pdBribesEpoch = store.ext.pdBribesEpoch || {};
    
    // Helper to find votion pool with flexible matching
    function findVotionPool(poolName, dexName) {
        // Normalize for comparison - lowercase, ensure dot before suffix
        function normalize(name) {
            // Handle suffix attached without dot (WBTCaxl -> wbtc.axl)
            // Only add dot if not preceded by one
            name = name.replace(/([^.])(atom|axl|osmo|wh)$/gi, (m, p1, p2) => p1 + '.' + p2.toLowerCase());
            // Lowercase the dot-suffix
            name = name.replace(/\.(ATOM|AXL|OSMO|WH)/g, (m) => m.toLowerCase());
            // Lowercase everything for comparison
            return name.toLowerCase();
        }
        
        function hasBridgeSuffix(name) {
            return /\.(atom|axl|osmo|wh)$/i.test(name);
        }
        
        function stripSuffix(name) {
            return name.replace(/\.(atom|axl|osmo|wh)$/gi, '');
        }
        
        let normPoolName = normalize(poolName);
        let poolHasSuffix = hasBridgeSuffix(normPoolName);
        
        // Build list of search variations (exact + swapped order)
        let searchVariants = [normPoolName];
        if (normPoolName.includes('-')) {
            let parts = normPoolName.split('-');
            searchVariants.push(`${parts[1]}-${parts[0]}`);
        }
        
        // PASS 1: Try exact match (including suffix)
        for (let key of Object.keys(votionPools)) {
            let [keyPool, keyDex] = key.split('|');
            if (keyDex !== dexName) continue;
            
            let normKeyPool = normalize(keyPool);
            for (let variant of searchVariants) {
                if (normKeyPool === variant) {
                    return votionPools[key];
                }
            }
        }
        
        // PASS 2: If vote pool has NO suffix, try matching against votion pools WITH suffix
        // This handles cases like Vote: "LUNA-PAXG" matching Votion: "LUNA-PAXG.atom"
        if (!poolHasSuffix) {
            let matches = [];
            for (let key of Object.keys(votionPools)) {
                let [keyPool, keyDex] = key.split('|');
                if (keyDex !== dexName) continue;
                
                let normKeyPool = normalize(keyPool);
                let normKeyNoSuffix = stripSuffix(normKeyPool);
                
                for (let variant of searchVariants) {
                    if (normKeyNoSuffix === variant) {
                        matches.push({ key, pool: votionPools[key] });
                    }
                }
            }
            
            // Only use fallback if exactly one match found
            if (matches.length === 1) {
                console.log(`Votion fallback: ${poolName} -> ${matches[0].key} (vote has no suffix)`);
                return matches[0].pool;
            } else if (matches.length > 1) {
                console.log(`Votion ambiguous: ${poolName} matches ${matches.length} pools, skipping`);
            }
        }
        
        return null;
    }
    
    store.vote.pools.forEach(p => {
        // Create key to match ext data: "LUNA-USDC|Astroport"
        // Single-sided assets (ampCAPA, xASTRO) are still on Astroport
        // Use helper functions that handle all DEX name variants (White Whale, Skeleton Swap, etc.)
        let dexName = isAstroport(p.d) ? 'Astroport' : 
                      isSkeletonSwap(p.d) ? 'Skeleton Swap' : null;
        if (!dexName) return;
        
        let lpKey = `${p.n}|${dexName}`;
        let extLp = store.ext.lps?.[lpKey];
        
        // === APPLY LIQUIDITY/VOLUME FROM HISTORICAL ===
        if (extLp && !extLp.notAvailable) {
            let liqData = null, volData = null;
            
            for (let ep = targetEpoch; ep >= targetEpoch - 5 && ep > 0; ep--) {
                if (!liqData && extLp.liquidity?.epochs?.[ep]) {
                    liqData = extLp.liquidity.epochs[ep];
                }
                if (!volData && extLp.volume?.epochs?.[ep]) {
                    volData = extLp.volume.epochs[ep];
                }
                if (liqData && volData) break;
            }
            
            if (liqData && (!p.dp || p.dp === 0)) {
                p.dp = liqData.avg;
                p.dpSource = 'ext';
            }
            if (volData && (!p.vol || p.vol === 0)) {
                p.vol = volData.avg;
                p.volSource = 'ext';
            }
        }
        
        // === APPLY VOTION DATA FROM EPOCH EXT ===
        let votionPool = findVotionPool(p.n, dexName);
        if (votionPool) {
            p.votNowVp = votionPool.current_vp || 0;
            p.votNowPct = votionPool.current_pct || 0;
            p.votNextVp = votionPool.optimized_vp || 0;
            p.votNextPct = votionPool.optimized_pct || 0;
            p.votionSource = 'ext';
        }
        
        // === APPLY PD BRIBES FROM EPOCH EXT ===
        // PD bribes are stored per-LP in ext file (e.g., "LUNA-USDC|Astroport")
        // Try exact match first, then flexible matching
        let pdBribe = pdBribesEpoch[lpKey];
        
        if (!pdBribe) {
            // Try flexible matching - normalize and compare
            let normPoolName = p.n.toLowerCase().replace(/\.(atom|axl|osmo|wh)/gi, '');
            for (let pdKey of Object.keys(pdBribesEpoch)) {
                let [pdPool, pdDex] = pdKey.split('|');
                if (pdDex !== dexName) continue;
                
                let normPdPool = pdPool.toLowerCase().replace(/\.(atom|axl|osmo|wh)/gi, '');
                if (normPdPool === normPoolName) {
                    pdBribe = pdBribesEpoch[pdKey];
                    console.log(`PD bribe match: ${p.n} -> ${pdPool}`);
                    break;
                }
                // Try swapped order
                if (normPoolName.includes('-')) {
                    let parts = normPoolName.split('-');
                    let swapped = `${parts[1]}-${parts[0]}`;
                    if (normPdPool === swapped) {
                        pdBribe = pdBribesEpoch[pdKey];
                        console.log(`PD bribe match (swapped): ${p.n} -> ${pdPool}`);
                        break;
                    }
                }
            }
        }
        
        if (pdBribe) {
            p.incPD = pdBribe.usd || 0;
            p.incPDPct = pdBribe.pct || 0;
            p.incPDSource = 'ext';
        }
        
        // === CALCULATE OTHER BRIBES ===
        // incTotal = total bribes from Vote page
        // incPD = PD bribes from ext file
        // incOther = incTotal - incPD (other non-PD bribes)
        if (p.incTotal > 0 && p.incPD > 0) {
            p.incOther = Math.max(0, p.incTotal - p.incPD);
        } else if (p.incTotal > 0 && !p.incPD) {
            // Have total but no PD data - can't determine breakdown
            p.incOther = 0;
        }
        
        // === APPLY INCENTIVES FROM LIQUIDITY PASTE ===
        // Case-insensitive matching for pool names
        let pnLower = p.n.toLowerCase().replace(/\.(atom|axl|osmo|wh)/gi, '');
        let liqPool = store.tla.pools?.find(lp => {
            let lpNormLower = (lp.normName || '').toLowerCase().replace(/\.(atom|axl|osmo|wh)/gi, '');
            if (lpNormLower !== pnLower) return false;
            // Use helper functions to match DEX
            if (isSkeletonSwap(dexName) && isSkeletonSwap(lp.dex)) return true;
            if (isAstroport(dexName) && isAstroport(lp.dex)) return true;
            return false;
        });
        if (!liqPool) {
            liqPool = store.tla.inactivePools?.find(lp => {
                let lpNormLower = (lp.normName || '').toLowerCase().replace(/\.(atom|axl|osmo|wh)/gi, '');
                if (lpNormLower !== pnLower) return false;
                if (isSkeletonSwap(dexName) && isSkeletonSwap(lp.dex)) return true;
                if (isAstroport(dexName) && isAstroport(lp.dex)) return true;
                return false;
            });
        }
        
        if (liqPool) {
            // Apply APR from liquidity data
            if (!p.aprNon || p.aprNon === 0) p.aprNon = liqPool.aprNon || 0;
            if (!p.aprAmp || p.aprAmp === 0) p.aprAmp = liqPool.aprAmp || 0;
            
            // Note: liqPool.rYr is TOTAL yearly rewards which includes all incentives
            // We don't use it for incOther because we can't distinguish sources
            // incPD comes from the Vote page or ext file and is the weekly PD bribe amount
        } else if (store.tla.pools?.length > 0) {
            // Debug: log failed matches
            console.log(`APR no match: ${p.n} (${dexName}) - searched ${store.tla.pools.length} pools`);
        }
    });
    
    if (votionRatios.arbLUNA || votionRatios.ampLUNA) {
        store.ext.votionRatios = votionRatios;
    }
    
    // Update Votion summary display
    updateVotionSummary(votionTotalVp, Object.keys(votionPools).length);
    
    console.log('Applied ext data to pools: votion=' + Object.keys(votionPools).length + 
                ', pdBribes=' + Object.keys(pdBribesEpoch).length);
}

function updateVotionSummary(totalVp, poolCount) {
    let summaryEl = $('votion-summary');
    if (!summaryEl) return;
    
    if (totalVp > 0) {
        summaryEl.classList.remove('hidden');
        
        // Format VP
        let vpStr = totalVp >= 1000000 ? (totalVp / 1000000).toFixed(2) + 'M' :
                    totalVp >= 1000 ? (totalVp / 1000).toFixed(0) + 'K' : 
                    totalVp.toLocaleString();
        setTxt('votion-total-vp', vpStr);
        
        // Calculate % of TLA
        let tlaPct = store.vote.tvp > 0 ? (totalVp / store.vote.tvp * 100).toFixed(1) + '%' : '-';
        setTxt('votion-tla-pct', tlaPct);
        
        // Show source info
        let phase = store.ext.votion?.phase || store.ext.meta?.phase || 'ext';
        let epoch = store.ext.votion?.epoch || store.ext.meta?.epoch || store.vote.ep;
        setTxt('votion-source', `Ep ${epoch} ${phase} (${poolCount} pools)`);
    } else {
        summaryEl.classList.add('hidden');
    }
}

// ============ aDAO SCORING SYSTEM ============

function get4EpochAverage(lpKey, type) {
    // type = 'liquidity' or 'volume'
    if (!store.ext.loaded || !store.ext.lps[lpKey]) return null;
    
    let extLp = store.ext.lps[lpKey];
    if (extLp.notAvailable) return null;
    
    let targetEpoch = store.vote.ep || currentEpochInfo?.epoch || 0;
    let epochs = extLp[type]?.epochs || {};
    
    // Get up to 4 previous epochs (not current)
    let values = [];
    for (let ep = targetEpoch - 1; ep >= targetEpoch - 4 && ep > 0; ep--) {
        if (epochs[ep]?.avg) {
            values.push({ epoch: ep, avg: epochs[ep].avg });
        }
    }
    
    if (values.length === 0) return null;
    
    let sum = values.reduce((s, v) => s + v.avg, 0);
    return {
        avg: sum / values.length,
        epochs: values,
        count: values.length
    };
}

function getPoolApr(poolName, dex) {
    // Find APR from liquidity paste data
    // Case-insensitive matching
    let poolNameLower = poolName.toLowerCase().replace(/\.(atom|axl|osmo|wh)/gi, '');
    let liqPool = store.tla.pools.find(p => {
        let pnLower = (p.normName || '').toLowerCase().replace(/\.(atom|axl|osmo|wh)/gi, '');
        if (pnLower !== poolNameLower) return false;
        // Use helper functions to match DEX
        if (isSkeletonSwap(dex) && isSkeletonSwap(p.dex)) return true;
        if (isAstroport(dex) && isAstroport(p.dex)) return true;
        return false;
    });
    if (!liqPool) {
        liqPool = store.tla.inactivePools?.find(p => {
            let pnLower = (p.normName || '').toLowerCase().replace(/\.(atom|axl|osmo|wh)/gi, '');
            if (pnLower !== poolNameLower) return false;
            if (isSkeletonSwap(dex) && isSkeletonSwap(p.dex)) return true;
            if (isAstroport(dex) && isAstroport(p.dex)) return true;
            return false;
        });
    }
    return {
        non: liqPool?.aprNon || 0,
        amp: liqPool?.aprAmp || 0
    };
}

function calculateAprFactor(apr) {
    // Target APR = 50% non-amplified
    // Returns bonus/penalty based on distance from target
    if (!apr || apr === 0) return 0; // No data, neutral
    
    if (apr < 40) return 10;      // Needs help
    if (apr < 50) return 5;       // Slightly under target
    if (apr <= 55) return 0;      // At target (50-55 neutral zone)
    if (apr <= 60) return -5;     // Slightly over
    if (apr <= 70) return -15;    // Doing well
    if (apr <= 80) return -25;    // Very healthy
    return -35;                    // Thriving, definitely shift focus
}

// ============ ACCESS SCORE SYSTEM ============

const ASSET_TIERS = {
    // Blue Chip - Store of value, attracts serious capital
    bluechip: { assets: ['BTC', 'wBTC', 'ETH', 'wETH', 'PAXG'], points: 3, label: 'Blue Chip' },
    // Major Stables - Essential trading infrastructure
    stables: { assets: ['USDC', 'USDT', 'EURe', 'DAI'], points: 2.5, label: 'Major Stable' },
    // Ecosystem Core - Heart of Terra/Cosmos
    core: { assets: ['LUNA', 'ATOM', 'INJ'], points: 2.5, label: 'Ecosystem Core' },
    // Native Terra Projects - Supporting local builders
    native: { assets: ['ROAR', 'CAPA', 'SOLID', 'ASTRO', 'FUEL', 'xASTRO', 'ampCAPA'], points: 2, label: 'Native Terra' },
    // Protocol LSDs - Useful derivatives
    lsd: { assets: ['ampLUNA', 'arbLUNA', 'bLUNA', 'stLUNA', 'stATOM', 'boneLUNA'], points: 1.5, label: 'Protocol LSD' },
    // Cross-chain assets - Brings outside liquidity
    crosschain: { assets: ['wBNB', 'wstETH', 'SWTH'], points: 1, label: 'Cross-chain' }
};

const BRIDGE_QUALITY = {
    'native': { points: 3, label: 'Native (no bridge)' },
    '.atom': { points: 2.5, label: 'IBC/Skip (.atom)' },
    '.axl': { points: 2, label: 'Axelar (.axl)' },
    '.osmo': { points: 1.5, label: 'Osmosis (.osmo)' },
    '.wh': { points: 1, label: 'Wormhole (.wh)' }
};

function getAssetTier(assetName) {
    // Strip bridge suffix for matching
    let base = assetName.replace(/\.(atom|axl|osmo|wh)$/i, '');
    
    // Check metadata first (if loaded)
    let meta = assetMetadata[assetName] || assetMetadata[base];
    if (meta && meta.category) {
        let categoryPoints = {
            'bluechip': 3, 'stable': 2.5, 'core': 2.5, 'native': 2, 'lsd': 1.5, 'cross': 1, 'unknown': 0.5
        };
        let categoryLabels = {
            'bluechip': 'Blue Chip', 'stable': 'Stable', 'core': 'Core', 'native': 'Native Terra', 
            'lsd': 'LSD', 'cross': 'Cross-chain', 'unknown': 'Unknown'
        };
        return { 
            tier: meta.category, 
            points: categoryPoints[meta.category] || 0.5, 
            label: categoryLabels[meta.category] || 'Unknown',
            fromMetadata: true
        };
    }
    
    // Fallback to hardcoded ASSET_TIERS
    for (let [tier, data] of Object.entries(ASSET_TIERS)) {
        if (data.assets.some(a => base.toUpperCase().includes(a.toUpperCase()))) {
            return { tier, ...data };
        }
    }
    return { tier: 'unknown', points: 0.5, label: 'Unknown' };
}

function getBridgeQuality(assetName) {
    // Check metadata first (if loaded)
    let meta = assetMetadata[assetName];
    if (meta && meta.bridge) {
        let bridgeData = BRIDGE_QUALITY[meta.bridge] || BRIDGE_QUALITY['native'];
        return { suffix: meta.bridge, ...bridgeData, fromMetadata: true };
    }
    
    // Fallback to suffix detection
    let match = assetName.match(/\.(atom|axl|osmo|wh)$/i);
    if (match) {
        let suffix = '.' + match[1].toLowerCase();
        return { suffix, ...BRIDGE_QUALITY[suffix] };
    }
    // Native asset (no bridge)
    return { suffix: 'native', ...BRIDGE_QUALITY['native'] };
}

function getLunaBenefit(asset1, asset2) {
    let hasLuna = asset1.toUpperCase() === 'LUNA' || asset2.toUpperCase() === 'LUNA';
    let hasLsd = ['ampLUNA', 'arbLUNA', 'bLUNA', 'stLUNA', 'boneLUNA'].some(l => 
        asset1.toUpperCase().includes(l.toUpperCase()) || asset2.toUpperCase().includes(l.toUpperCase())
    );
    
    if (hasLuna) {
        // Check what LUNA is paired with
        let other = asset1.toUpperCase() === 'LUNA' ? asset2 : asset1;
        let otherTier = getAssetTier(other);
        
        if (otherTier.tier === 'bluechip') return { points: 3, label: 'LUNA + Blue Chip', reason: 'Attracts value TO Luna' };
        if (otherTier.tier === 'stables') return { points: 2.5, label: 'LUNA + Stable', reason: 'Trading infrastructure' };
        if (otherTier.tier === 'native') return { points: 2.5, label: 'LUNA + Native Terra', reason: 'Supporting ecosystem' };
        if (otherTier.tier === 'core') return { points: 2.5, label: 'LUNA + Ecosystem', reason: 'Cosmos connectivity' };
        if (otherTier.tier === 'lsd') return { points: 2, label: 'LUNA + LSD', reason: 'LSD utility' };
        return { points: 2, label: 'LUNA + Other', reason: 'Still benefits LUNA' };
    }
    
    if (hasLsd) {
        return { points: 1.5, label: 'LSD Pair', reason: 'Indirect LUNA support' };
    }
    
    // Check for stable-stable
    let tier1 = getAssetTier(asset1);
    let tier2 = getAssetTier(asset2);
    if (tier1.tier === 'stables' && tier2.tier === 'stables') {
        return { points: 1, label: 'Stable-Stable', reason: 'Useful but not LUNA focused' };
    }
    
    return { points: 0.5, label: 'Non-LUNA Pair', reason: 'Minimal ecosystem benefit' };
}

// Get detailed score breakdown for a single asset
function getAssetScoreDetails(assetName, meta) {
    if (!meta || !meta.actual_path) {
        return {
            name: assetName,
            score: 30,
            source: 'no_metadata',
            issues: ['‚ö†Ô∏è No metadata configured'],
            positives: [],
            notes: [],
            breakdown: {}
        };
    }
    
    let origin = ORIGIN_TYPES[meta.origin] || ORIGIN_TYPES.unknown;
    let assetClass = ASSET_CLASSES[meta.asset_class] || ASSET_CLASSES.unknown;
    let cg = CG_STATUS[meta.cg_status] || CG_STATUS.cg_none;
    let treasury = TREASURY_VALUE[meta.treasury_value] || TREASURY_VALUE.medium;
    let namingOk = isNamingAccurate(meta);
    
    let breakdown = {
        origin: { label: origin.label, base: origin.baseScore },
        assetClass: { label: assetClass.label, bonus: assetClass.bonus },
        cg: { label: cg.label, score: cg.score },
        treasury: { label: treasury.label, score: treasury.score },
        naming: { accurate: namingOk, score: namingOk ? 10 : -10, actual: meta.actual_path },
        skip: { clear: meta.skip_clear, score: meta.skip_clear ? 5 : -5 },
        multiDex: { enabled: meta.multi_dex, score: meta.multi_dex ? 5 : 0 }
    };
    
    let total = origin.baseScore + assetClass.bonus + cg.score + treasury.score + 
                breakdown.naming.score + breakdown.skip.score + breakdown.multiDex.score;
    total = Math.max(0, Math.min(100, total));
    
    // Identify issues (things that hurt the score)
    let issues = [];
    let positives = [];
    
    // Origin issues
    if (origin.baseScore < 50) {
        issues.push(`üî¥ ${origin.label} origin (-${85 - origin.baseScore} from native)`);
    } else if (origin.baseScore < 70) {
        issues.push(`üü° ${origin.label} origin (not native)`);
    } else {
        positives.push(`‚úÖ ${origin.label} origin`);
    }
    
    // CoinGecko
    if (cg.score < 0) {
        issues.push(`üî¥ Not on CoinGecko (${cg.score})`);
    } else if (cg.score > 5) {
        positives.push(`‚úÖ Listed on CG Terra (${cg.score > 0 ? '+' : ''}${cg.score})`);
    } else if (cg.score > 0) {
        positives.push(`‚úÖ Listed on CG (${cg.score > 0 ? '+' : ''}${cg.score})`);
    }
    
    // Naming
    if (!namingOk) {
        issues.push(`üî¥ Name mismatch: shows "${assetName}" but is "${meta.actual_path}" (-10)`);
    } else {
        positives.push(`‚úÖ Naming accurate (+10)`);
    }
    
    // Skip.go clarity
    if (!meta.skip_clear) {
        issues.push(`üü° Skip.go routing confusing (-5)`);
    }
    
    // Treasury value
    if (treasury.score < 0) {
        issues.push(`üü° Low treasury value (${treasury.score})`);
    } else if (treasury.score > 0) {
        positives.push(`‚úÖ High treasury value (+${treasury.score})`);
    }
    
    // Multi-DEX
    if (meta.multi_dex) {
        positives.push(`‚úÖ Multi-DEX available (+5)`);
    }
    
    // Add acquisition note if present
    let notes = [];
    if (meta.acquisition_note) {
        notes.push(`üìù ${meta.acquisition_note}`);
    }
    if (meta.acquisition === 'hard') {
        issues.push(`üî¥ Hard to acquire`);
    } else if (meta.acquisition === 'medium') {
        issues.push(`üü° Medium difficulty to acquire`);
    }
    
    return {
        name: assetName,
        score: total,
        source: 'metadata',
        origin: meta.origin,
        assetClass: meta.asset_class,
        issues: issues,
        positives: positives,
        notes: notes,
        breakdown: breakdown
    };
}

function calculatePoolAccessScore(poolName) {
    // Parse pool name: "LUNA-USDC" or "wBTC.axl-wBTC.osmo"
    let parts = poolName.split('-');
    if (parts.length !== 2) return { total: 50, breakdown: { error: 'Could not parse pool name' } };
    
    let [asset1, asset2] = parts;
    
    // Check if we have metadata for these assets
    let meta1 = assetMetadata[asset1];
    let meta2 = assetMetadata[asset2];
    
    // Get detailed breakdown for each asset
    let details1 = getAssetScoreDetails(asset1, meta1);
    let details2 = getAssetScoreDetails(asset2, meta2);
    
    let hasMetadata = details1.source === 'metadata' && details2.source === 'metadata';
    let avgScore = (details1.score + details2.score) / 2;
    
    // LUNA benefit bonus
    let lunaBenefit = 0;
    let lunaLabel = '';
    let lunaAssets = ['LUNA', 'ampLUNA', 'stLUNA', 'boneLUNA', 'arbLUNA', 'bLUNA'];
    let hasLuna = lunaAssets.includes(asset1) || lunaAssets.includes(asset2);
    
    if (hasLuna && hasMetadata) {
        let otherMeta = lunaAssets.includes(asset1) ? meta2 : meta1;
        
        if (otherMeta?.asset_class === 'stable') {
            lunaBenefit = 5;
            lunaLabel = 'LUNA + Stable (+5)';
        } else if (otherMeta?.asset_class === 'bluechip') {
            lunaBenefit = 5;
            lunaLabel = 'LUNA + Bluechip (+5)';
        } else if (otherMeta?.asset_class === 'lsd') {
            lunaBenefit = 3;
            lunaLabel = 'LUNA + LSD (+3)';
        } else {
            lunaBenefit = 2;
            lunaLabel = 'LUNA pair (+2)';
        }
    }
    
    let total = Math.min(100, avgScore + lunaBenefit);
    
    // Combine all issues and notes (with fallbacks for undefined)
    let allIssues = [...(details1.issues || []), ...(details2.issues || [])];
    let allPositives = [...(details1.positives || []), ...(details2.positives || [])];
    let allNotes = [...(details1.notes || []), ...(details2.notes || [])];
    
    return {
        total: total,
        raw: avgScore,
        max: 100,
        source: hasMetadata ? 'metadata' : 'fallback',
        breakdown: {
            asset1: details1,
            asset2: details2,
            assetAvg: avgScore,
            lunaBenefit: { label: lunaLabel, points: lunaBenefit },
            allIssues: allIssues,
            allPositives: allPositives,
            allNotes: allNotes
        }
    };
}

function calculateScoresForBucket(bucketName, filterSettings = null) {
    // Get all pools in this bucket
    let bucketPools = store.vote.pools.filter(p => p.b === bucketName);
    if (bucketPools.length === 0) return;
    
    // Apply filters if provided (for relative ranking)
    let poolsForRanking = bucketPools;
    if (filterSettings) {
        poolsForRanking = bucketPools.filter(p => {
            let isAct = p.vps >= 1;
            let isAstroOrSingle = isAstroport(p.d);
            if (isAstroOrSingle && !filterSettings.showAstro) return false;
            if (isSkeletonSwap(p.d) && !filterSettings.showWW) return false;
            if (!isAct && !filterSettings.showInactive) return false;
            return true;
        });
    }
    
    // Calculate 4Ep averages, efficiency, and access score for each pool
    bucketPools.forEach(p => {
        // Single-sided assets (ampCAPA, xASTRO) are still on Astroport
        // Use helper functions that handle all DEX name variants
        let dexName = isAstroport(p.d) ? 'Astroport' : 
                      isSkeletonSwap(p.d) ? 'Skeleton Swap' : null;
        if (!dexName) return;
        
        let lpKey = `${p.n}|${dexName}`;
        
        // Get 4-epoch averages - but PRESERVE existing data if already loaded from file
        if (!p.liq4Ep) {
            p.liq4Ep = get4EpochAverage(lpKey, 'liquidity');
        }
        if (!p.vol4Ep) {
            p.vol4Ep = get4EpochAverage(lpKey, 'volume');
        }
        
        // Calculate efficiency (vol/liq ratio)
        let liqAvg = p.liq4Ep?.avg || p.dp || 0;
        let volAvg = p.vol4Ep?.avg || p.vol || 0;
        p.efficiency = liqAvg > 0 ? (volAvg / liqAvg) : 0;
        
        // Get APR from liquidity data - but PRESERVE existing if already loaded
        if (!p.aprNon || p.aprNon === 0) {
            let aprData = getPoolApr(p.n, dexName);
            if (aprData.non > 0) p.aprNon = aprData.non;
            if (aprData.amp > 0) p.aprAmp = aprData.amp;
        }
        p.aprFactor = calculateAprFactor(p.aprNon);
        
        // Calculate Access Score
        p.accessData = calculatePoolAccessScore(p.n);
        p.accessScore = p.accessData.total;
    });
    
    // Rank within filtered pool set (for relative scoring)
    // This makes rankings relative to what's currently visible
    let withLiq = poolsForRanking.filter(p => (p.liq4Ep?.avg || p.dp) > 0);
    let withVol = poolsForRanking.filter(p => (p.vol4Ep?.avg || p.vol) > 0);
    let withEff = poolsForRanking.filter(p => p.efficiency > 0);
    let withInc = poolsForRanking.filter(p => p.inc > 0);
    let withVot = poolsForRanking.filter(p => (p.votNowPct || 0) > 0);
    let withTla = poolsForRanking.filter(p => p.vps > 0);
    
    // Sort and assign ranks (higher value = higher rank)
    withLiq.sort((a, b) => (b.liq4Ep?.avg || b.dp) - (a.liq4Ep?.avg || a.dp));
    withVol.sort((a, b) => (b.vol4Ep?.avg || b.vol) - (a.vol4Ep?.avg || a.vol));
    withEff.sort((a, b) => b.efficiency - a.efficiency);
    withInc.sort((a, b) => b.inc - a.inc);
    withVot.sort((a, b) => (b.votNowPct || 0) - (a.votNowPct || 0));
    withTla.sort((a, b) => b.vps - a.vps);
    
    // Assign percentile ranks (0-100)
    bucketPools.forEach(p => {
        p.liqRank = withLiq.length > 0 ? (1 - withLiq.indexOf(p) / withLiq.length) * 100 : 0;
        p.volRank = withVol.length > 0 ? (1 - withVol.indexOf(p) / withVol.length) * 100 : 0;
        p.effRank = withEff.length > 0 ? (1 - withEff.indexOf(p) / withEff.length) * 100 : 0;
        p.incRank = withInc.length > 0 ? (1 - withInc.indexOf(p) / withInc.length) * 100 : 0;
        p.votRank = withVot.length > 0 ? (1 - withVot.indexOf(p) / withVot.length) * 100 : 0;
        p.tlaRank = withTla.length > 0 ? (1 - withTla.indexOf(p) / withTla.length) * 100 : 0;
        
        // Fix -0 and pools not in list
        if (withLiq.indexOf(p) === -1) p.liqRank = 0;
        if (withVol.indexOf(p) === -1) p.volRank = 0;
        if (withEff.indexOf(p) === -1) p.effRank = 0;
        if (withInc.indexOf(p) === -1) p.incRank = 0;
        if (withVot.indexOf(p) === -1) p.votRank = 0;
        if (withTla.indexOf(p) === -1) p.tlaRank = 0;
    });
    
    // Calculate Performance Score (0-100)
    // 35% Efficiency, 25% Volume, 20% Liquidity, 15% Access, 5% History
    bucketPools.forEach(p => {
        p.performanceScore = 
            (p.effRank * 0.35) +
            (p.volRank * 0.25) +
            (p.liqRank * 0.20) +
            (p.accessScore * 0.15) + // Access score (now 15%)
            (0 * 0.05);  // History score placeholder (now 5%)
        
        // Calculate Support Score (0-100)
        // 40% Bribes, 30% TLA Vote, 30% Votion Dominance
        // Votion Dominance = what % of TLA votes come from Votion (high = dependent on Votion)
        let votionDominance = p.vps > 0 ? Math.min(100, (p.votNowPct / p.vps) * 100) : 0;
        p.votionDominance = votionDominance;
        
        p.supportScore = 
            (p.incRank * 0.40) +
            (p.tlaRank * 0.30) +
            (votionDominance * 0.30);  // High dominance = high support from Votion
        
        // Calculate aDAO Opportunity Score
        // Performance - Support + APR Factor
        p.adaoScore = p.performanceScore - p.supportScore + (p.aprFactor || 0);
        
        // Clamp to reasonable range
        p.adaoScore = Math.max(-100, Math.min(100, p.adaoScore));
    });
}

function calculateAllScores(filterSettings = null) {
    // Skip recalculation if scores were loaded from v3 file
    if (store.scoresFromFile) {
        console.log('Scores loaded from v3 file - skipping recalculation');
        return;
    }
    
    BUCKET_ORDER.forEach(bucket => {
        calculateScoresForBucket(bucket, filterSettings);
    });
}

// Load 4-epoch historical data from ext files when loading v3 snapshot
// This fills in liq4Ep and vol4Ep for pools that don't have it in the snapshot
async function load4EpDataForV3() {
    const extBaseUrl = 'https://raw.githubusercontent.com/defipatriot/tla-ext_json_storage/main/';
    
    try {
        // Load historical data
        const res = await fetch(extBaseUrl + 'tla_ext_historical.json?t=' + Date.now());
        if (!res.ok) {
            console.log('Could not load ext historical for 4EP data');
            return;
        }
        
        const data = await res.json();
        if (!data.lps) {
            console.log('No LPs in ext historical');
            return;
        }
        
        // Store in ext.lps for get4EpochAverage to use
        store.ext.lps = { ...store.ext.lps, ...data.lps };
        console.log('Loaded ext historical:', Object.keys(data.lps).length, 'LPs');
        
        // Now fill in 4EP data for pools that don't have it
        let filled = 0;
        store.vote.pools.forEach(p => {
            if (!p.liq4Ep || !p.vol4Ep) {
                let lpKey = buildLpKey(p.n, p.d);
                
                if (!p.liq4Ep) {
                    p.liq4Ep = get4EpochAverage(lpKey, 'liquidity');
                    if (p.liq4Ep) filled++;
                }
                if (!p.vol4Ep) {
                    p.vol4Ep = get4EpochAverage(lpKey, 'volume');
                }
                
                // Recalculate efficiency if we now have data
                if (p.liq4Ep || p.vol4Ep) {
                    let liqAvg = p.liq4Ep?.avg || p.dp || 0;
                    let volAvg = p.vol4Ep?.avg || 0;
                    if (liqAvg > 0) {
                        p.efficiency = volAvg / liqAvg;
                    }
                }
            }
        });
        
        console.log('Filled 4EP data for', filled, 'pools');
        
    } catch(e) {
        console.log('Error loading ext historical:', e);
    }
}

// Recalculate scores after loading historical data from file
// Uses raw metrics already in pools but recalculates access/performance/adao scores using current metadata
function recalculateScoresFromLoadedData() {
    console.log('Recalculating scores from loaded data...');
    
    BUCKET_ORDER.forEach(bucketName => {
        let bucketPools = store.vote.pools.filter(p => p.b === bucketName);
        if (bucketPools.length === 0) return;
        
        // Step 1: Recalculate access score for each pool using current metadata
        bucketPools.forEach(p => {
            p.accessData = calculatePoolAccessScore(p.n);
            p.accessScore = p.accessData.total;
            
            // Recalculate efficiency from loaded 4ep data
            let liqAvg = p.liq4Ep?.avg || p.dp || 0;
            let volAvg = p.vol4Ep?.avg || p.vol || 0;
            if (liqAvg > 0) {
                p.efficiency = volAvg / liqAvg;
            }
            
            // Calculate APR factor
            if (p.aprNon > 0) {
                p.aprFactor = calculateAprFactor(p.aprNon);
            }
        });
        
        // Step 2: Rank within bucket (active pools only for ranking)
        let poolsForRanking = bucketPools.filter(p => p.vps >= 1);
        
        let withLiq = poolsForRanking.filter(p => (p.liq4Ep?.avg || p.dp) > 0);
        let withVol = poolsForRanking.filter(p => (p.vol4Ep?.avg || p.vol) > 0);
        let withEff = poolsForRanking.filter(p => p.efficiency > 0);
        let withInc = poolsForRanking.filter(p => p.inc > 0);
        let withVot = poolsForRanking.filter(p => (p.votNowPct || 0) > 0);
        let withTla = poolsForRanking.filter(p => p.vps > 0);
        
        // Sort by value (higher = better rank)
        withLiq.sort((a, b) => (b.liq4Ep?.avg || b.dp) - (a.liq4Ep?.avg || a.dp));
        withVol.sort((a, b) => (b.vol4Ep?.avg || b.vol) - (a.vol4Ep?.avg || a.vol));
        withEff.sort((a, b) => b.efficiency - a.efficiency);
        withInc.sort((a, b) => b.inc - a.inc);
        withVot.sort((a, b) => (b.votNowPct || 0) - (a.votNowPct || 0));
        withTla.sort((a, b) => b.vps - a.vps);
        
        // Assign percentile ranks
        bucketPools.forEach(p => {
            p.liqRank = withLiq.length > 0 && withLiq.indexOf(p) !== -1 ? (1 - withLiq.indexOf(p) / withLiq.length) * 100 : 0;
            p.volRank = withVol.length > 0 && withVol.indexOf(p) !== -1 ? (1 - withVol.indexOf(p) / withVol.length) * 100 : 0;
            p.effRank = withEff.length > 0 && withEff.indexOf(p) !== -1 ? (1 - withEff.indexOf(p) / withEff.length) * 100 : 0;
            p.incRank = withInc.length > 0 && withInc.indexOf(p) !== -1 ? (1 - withInc.indexOf(p) / withInc.length) * 100 : 0;
            p.votRank = withVot.length > 0 && withVot.indexOf(p) !== -1 ? (1 - withVot.indexOf(p) / withVot.length) * 100 : 0;
            p.tlaRank = withTla.length > 0 && withTla.indexOf(p) !== -1 ? (1 - withTla.indexOf(p) / withTla.length) * 100 : 0;
        });
        
        // Step 3: Calculate composite scores
        bucketPools.forEach(p => {
            // Performance Score: 35% Efficiency, 25% Volume, 20% Liquidity, 15% Access, 5% History
            p.performanceScore = 
                (p.effRank * 0.35) +
                (p.volRank * 0.25) +
                (p.liqRank * 0.20) +
                (p.accessScore * 0.15) +
                (0 * 0.05);  // History placeholder
            
            // Support Score: 40% Bribes, 30% TLA Vote, 30% Votion Dominance
            let votionDominance = p.vps > 0 ? Math.min(100, (p.votNowPct / p.vps) * 100) : 0;
            p.votionDominance = votionDominance;
            
            p.supportScore = 
                (p.incRank * 0.40) +
                (p.tlaRank * 0.30) +
                (votionDominance * 0.30);
            
            // aDAO Opportunity Score
            p.adaoScore = p.performanceScore - p.supportScore + (p.aprFactor || 0);
            p.adaoScore = Math.max(-100, Math.min(100, p.adaoScore));
        });
        
        console.log(`  ${bucketName}: ${bucketPools.length} pools recalculated`);
    });
    
    console.log('Score recalculation complete');
}

function getScoreColor(score) {
    if (score >= 50) return 'text-green-400';
    if (score >= 20) return 'text-yellow-400';
    if (score >= -20) return 'text-gray-400';
    if (score >= -50) return 'text-blue-400';
    return 'text-red-400';
}

function getScoreIcon(score) {
    if (score >= 50) return 'üü¢';
    if (score >= 20) return 'üü°';
    if (score >= -20) return '‚ö™';
    if (score >= -50) return 'üîµ';
    return 'üî¥';
}

function showScoreInfo(type) {
    let title = '', content = '';
    
    switch(type) {
        case '4ep-liq':
            title = '4-Epoch Average Liquidity';
            content = `
                <p class="mb-3">Average liquidity over the last 4 epochs (approximately 28 days), calculated from Astroport chart data captured via the Extensions tool.</p>
                <p class="mb-3"><strong>Why it matters:</strong> Shows the pool's sustained liquidity commitment, not just a point-in-time snapshot.</p>
                <p class="mb-3"><strong>Data source:</strong> tla_ext_combined.json from the Extensions tool staging process.</p>
                <p class="text-teal-400"><span class="text-[12px]">‚¨°</span> indicates data from ext tool (epoch averages)</p>
            `;
            break;
        case '4ep-vol':
            title = '4-Epoch Average Volume';
            content = `
                <p class="mb-3">Average trading volume over the last 4 epochs, showing consistent usage patterns.</p>
                <p class="mb-3"><strong>Why it matters:</strong> Volume indicates real utility - people are actually using this pool for trades. High volume = valuable to the chain.</p>
                <p class="mb-3"><strong>Weight in scoring:</strong> 25% of Performance Score (volume is a strong signal of LP value)</p>
            `;
            break;
        case 'efficiency':
            title = 'Capital Efficiency (Vol/Liq Ratio)';
            content = `
                <p class="mb-3">How hard the pool's liquidity is working. Calculated as: Average Volume √∑ Average Liquidity</p>
                <p class="mb-3"><strong>Example:</strong> A pool with $50K liquidity doing $20K/day volume (0.4 efficiency) is more valuable than one with $500K liquidity doing $5K/day (0.01 efficiency).</p>
                <p class="mb-3"><strong>Weight in scoring:</strong> 35% of Performance Score (the most important metric)</p>
                <p class="text-yellow-400">Higher efficiency = pool is working harder for the chain</p>
            `;
            break;
        case 'apr':
            title = 'Non-Amplified APR';
            content = `
                <p class="mb-3">The base APR before amplification multipliers. From liquidity paste data.</p>
                <p class="mb-3"><strong>TLA Target:</strong> 50% non-amplified APR</p>
                <p class="mb-3"><strong>APR Factor applied to score:</strong></p>
                <ul class="list-disc list-inside text-[11px] space-y-1 mb-3">
                    <li>&lt;40% ‚Üí +10 (needs help)</li>
                    <li>40-50% ‚Üí +5 (slightly under)</li>
                    <li>50-55% ‚Üí 0 (at target)</li>
                    <li>55-60% ‚Üí -5 (slightly over)</li>
                    <li>60-70% ‚Üí -15 (doing well)</li>
                    <li>70-80% ‚Üí -25 (very healthy)</li>
                    <li>&gt;80% ‚Üí -35 (thriving, shift focus)</li>
                </ul>
                <p class="text-green-400">This creates automatic rebalancing toward underperforming LPs</p>
            `;
            break;
        case 'access':
            title = 'Access Score (15% of Performance)';
            content = `
                <p class="mb-3">Measures how accessible and valuable this LP is based on asset metadata. Each asset is scored 0-100, then averaged for the pool.</p>
                
                <p class="mb-2 font-bold text-white">1. Origin Base Score (30-85 pts)</p>
                <div class="text-[10px] mb-3 pl-2 border-l border-gray-600">
                    <div>üè† <span class="text-green-400">Terra Native (85)</span>: LUNA, ROAR, CAPA, SOLID</div>
                    <div>üîí <span class="text-green-300">Terra LSD (80)</span>: ampLUNA, stLUNA, bLUNA</div>
                    <div>‚öõÔ∏è <span class="text-cyan-300">IBC (70)</span>: ATOM, ASTRO via IBC</div>
                    <div>üíµ <span class="text-blue-300">Stable Native (65)</span>: USDC.noble, USDT.kava</div>
                    <div>üåâ <span class="text-yellow-300">Bridge Eureka (50)</span>: .atom suffix</div>
                    <div>üîó <span class="text-orange-300">Bridge Axelar (45)</span>: .axl suffix</div>
                    <div>üì¶ <span class="text-red-300">Bridge Osmosis (40)</span>: .osmo suffix</div>
                    <div>‚ùì <span class="text-gray-500">Unknown (30)</span>: Not configured</div>
                </div>
                
                <p class="mb-2 font-bold text-white">2. Asset Class Bonus (+0 to +5)</p>
                <div class="text-[10px] mb-3 pl-2 border-l border-gray-600">
                    <div>üèÜ <span class="text-yellow-300">Bluechip (+5)</span>: BTC, ETH, PAXG</div>
                    <div>üíµ <span class="text-green-300">Stable (+5)</span>: USDC, USDT, EURe</div>
                    <div>‚öõÔ∏è <span class="text-purple-300">Core (+5)</span>: LUNA, ATOM</div>
                    <div>üîí <span class="text-cyan-300">LSD (+3)</span>: ampLUNA, stLUNA</div>
                    <div>üîß <span class="text-gray-300">DeFi/Native (0)</span>: Protocol tokens</div>
                </div>
                
                <p class="mb-2 font-bold text-white">3. CoinGecko Status (-15 to +15)</p>
                <div class="text-[10px] mb-3 pl-2 border-l border-gray-600">
                    <div>‚úÖ <span class="text-green-400">Listed on Terra (+15)</span>: Best visibility</div>
                    <div>‚úì <span class="text-blue-300">Listed Other Chain (+5)</span>: Has CG presence</div>
                    <div>‚ùå <span class="text-red-400">Not Listed (-15)</span>: Hard to find info</div>
                </div>
                
                <p class="mb-2 font-bold text-white">4. Other Factors</p>
                <div class="text-[10px] mb-3 pl-2 border-l border-gray-600">
                    <div>üìõ <span class="text-green-400">Naming Accurate (+10)</span> / <span class="text-red-400">Mismatch (-10)</span></div>
                    <div>üß≠ <span class="text-green-400">Skip.go Clear (+5)</span> / <span class="text-red-400">Confusing (-5)</span></div>
                    <div>üîÑ <span class="text-blue-300">Multi-DEX Available (+5)</span></div>
                    <div>üí∞ <span class="text-yellow-300">Treasury Value High (+5)</span> / <span class="text-gray-400">Low (-5)</span></div>
                </div>
                
                <p class="mb-2 font-bold text-white">5. LUNA Pair Bonus (+2 to +5)</p>
                <div class="text-[10px] mb-3 pl-2 border-l border-gray-600">
                    <div><span class="text-green-400">LUNA + Stable/Bluechip (+5)</span></div>
                    <div><span class="text-cyan-300">LUNA + LSD (+3)</span></div>
                    <div><span class="text-gray-300">Other LUNA pair (+2)</span></div>
                </div>
                
                <div class="bg-emerald-900/30 border border-emerald-700 p-2 rounded mt-3">
                    <p class="text-emerald-400 text-[10px]"><strong>Click on any pool row</strong> to see detailed breakdown with specific issues that hurt the score and what could be fixed!</p>
                </div>
            `;
            break;
        case 'support':
            title = 'Support Score';
            content = `
                <p class="mb-3">How much attention this LP is already getting from other sources.</p>
                <p class="mb-3"><strong>Components (0-100):</strong></p>
                <ul class="list-disc list-inside text-[11px] space-y-1 mb-3">
                    <li>40% - PD Bribes rank (incentives from eris/PD)</li>
                    <li>30% - Votion % rank (automated VP direction)</li>
                    <li>30% - TLA Vote % rank (current vote share)</li>
                </ul>
                <p class="mb-3"><strong>Higher support = already getting attention</strong></p>
                <p class="text-orange-300">aDAO looks for LPs with LOW support scores relative to their performance</p>
            `;
            break;
        case 'adao-score':
            title = 'aDAO Opportunity Score';
            content = `
                <p class="mb-3 text-lg font-bold text-emerald-300">The Bottom Line: Should aDAO support this LP?</p>
                
                <div class="bg-gray-800/50 p-3 rounded mb-3">
                    <p class="text-[11px] text-gray-300 italic mb-2">"aDAO acts as a balance of power in TLA governance. We use data-driven analysis to support high-performing LPs that aren't getting attention from PD bribes or Votion, and help promising projects grow."</p>
                </div>
                
                <p class="mb-2 font-bold text-white">Formula:</p>
                <div class="font-mono text-[11px] bg-gray-900 p-2 rounded mb-3">
                    aDAO Score = Performance - Support + APR Factor
                </div>
                
                <p class="mb-2 font-bold text-white">Performance Score (0-100):</p>
                <div class="text-[10px] mb-3 pl-2 border-l border-gray-600">
                    <div>35% - Efficiency (Vol/Liq ratio) - Is capital working hard?</div>
                    <div>25% - Volume rank - Are people actually using it?</div>
                    <div>20% - Liquidity rank - Is there commitment?</div>
                    <div>15% - Access Score - Asset quality, bridge safety, LUNA benefit</div>
                    <div>5% - History Score - Stability over time (TBD)</div>
                </div>
                
                <p class="mb-2 font-bold text-white">Support Score (0-100):</p>
                <div class="text-[10px] mb-3 pl-2 border-l border-gray-600">
                    <div>40% - PD Bribes rank - Eris/PD attention</div>
                    <div>30% - Votion % rank - Automated VP direction</div>
                    <div>30% - TLA Vote % rank - Current vote share</div>
                </div>
                
                <p class="mb-2 font-bold text-white">APR Factor (Target: 50%):</p>
                <div class="text-[10px] mb-3 pl-2 border-l border-gray-600">
                    <div>LPs under 50% APR get a boost (needs help)</div>
                    <div>LPs over 50% APR get a penalty (shift focus elsewhere)</div>
                    <div>Creates automatic rebalancing toward underperformers</div>
                </div>
                
                <p class="mb-2 font-bold text-white">Score Interpretation:</p>
                <div class="space-y-1 text-[11px] mb-3">
                    <div>üü¢ <span class="text-green-400">+50 to +100</span> - High priority: Strong performer, underserved</div>
                    <div>üü° <span class="text-yellow-400">+20 to +50</span> - Opportunity: Worth considering</div>
                    <div>‚ö™ <span class="text-gray-400">-20 to +20</span> - Balanced: Getting fair support</div>
                    <div>üîµ <span class="text-blue-400">-50 to -20</span> - Over-supported: Already has attention</div>
                    <div>üî¥ <span class="text-red-400">Below -50</span> - Over-hyped: Getting way more than deserved</div>
                </div>
                
                <div class="bg-emerald-900/30 border border-emerald-700 p-2 rounded">
                    <p class="text-emerald-400 text-[11px]"><strong>Our Mission:</strong> Be the thoughtful voice that supports native Terra projects, rewards efficient LPs, and ensures fair distribution of TLA votes across the ecosystem. üè†</p>
                </div>
            `;
            break;
    }
    
    // Create modal
    let modal = document.createElement('div');
    modal.className = 'modal-overlay open';
    modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
    modal.innerHTML = `
        <div class="modal-box max-w-lg">
            <div class="flex justify-between items-center mb-4 border-b border-gray-700 pb-2">
                <h3 class="text-lg font-bold text-white">${title}</h3>
                <button onclick="this.closest('.modal-overlay').remove()" class="text-gray-500 hover:text-white text-xl">&times;</button>
            </div>
            <div class="text-sm text-gray-300">${content}</div>
        </div>
    `;
    document.body.appendChild(modal);
}

function showPoolScoreDetails(poolName, dex) {
    // Match pool using helper functions for DEX comparison
    let p = store.vote.pools.find(pool => {
        if (pool.n !== poolName) return false;
        if (isSkeletonSwap(dex) && isSkeletonSwap(pool.d)) return true;
        if (isAstroport(dex) && isAstroport(pool.d)) return true;
        if (dex === 'Single' && pool.d.includes('Single')) return true;
        return false;
    });
    if (!p) return;
    
    let liq4EpStr = p.liq4Ep ? `$${(p.liq4Ep.avg/1000).toFixed(1)}K (${p.liq4Ep.count} epochs)` : 'N/A';
    let vol4EpStr = p.vol4Ep ? `$${(p.vol4Ep.avg/1000).toFixed(1)}K (${p.vol4Ep.count} epochs)` : 'N/A';
    
    // Access score breakdown
    let accessHtml = '';
    if (p.accessData && p.accessData.breakdown) {
        let b = p.accessData.breakdown;
        
        if (p.accessData.source === 'metadata') {
            // Detailed metadata-based scoring
            let a1 = b.asset1;
            let a2 = b.asset2;
            
            accessHtml = `
                <div class="space-y-2 text-[10px]">
                    <!-- Asset 1 -->
                    <div class="bg-gray-900/50 p-1.5 rounded">
                        <div class="flex justify-between font-bold">
                            <span class="text-white">${a1.name}</span>
                            <span class="text-cyan-400">${a1.score}/100</span>
                        </div>
                        <div class="text-[9px] text-gray-400">${a1.origin || 'unknown'} ‚Ä¢ ${a1.assetClass || 'unknown'}</div>
                    </div>
                    
                    <!-- Asset 2 -->
                    <div class="bg-gray-900/50 p-1.5 rounded">
                        <div class="flex justify-between font-bold">
                            <span class="text-white">${a2.name}</span>
                            <span class="text-cyan-400">${a2.score}/100</span>
                        </div>
                        <div class="text-[9px] text-gray-400">${a2.origin || 'unknown'} ‚Ä¢ ${a2.assetClass || 'unknown'}</div>
                    </div>
                    
                    <!-- Average and LUNA Benefit -->
                    <div class="flex justify-between border-t border-gray-700 pt-1">
                        <span class="text-gray-500">Asset Avg:</span>
                        <span class="text-yellow-300">${b.assetAvg.toFixed(0)}/100</span>
                    </div>
                    ${b.lunaBenefit && b.lunaBenefit.points > 0 ? `
                    <div class="flex justify-between">
                        <span class="text-gray-500">LUNA Benefit:</span>
                        <span class="text-green-300">${b.lunaBenefit.label}</span>
                    </div>` : ''}
                    
                    <!-- Issues Section -->
                    ${b.allIssues && b.allIssues.length > 0 ? `
                    <div class="mt-2 pt-1 border-t border-red-900/50">
                        <div class="text-red-400 font-bold text-[9px] mb-1">Issues:</div>
                        ${b.allIssues.map(i => `<div class="text-[9px] text-red-300/80">${i}</div>`).join('')}
                    </div>` : ''}
                    
                    <!-- Notes Section -->
                    ${b.allNotes && b.allNotes.length > 0 ? `
                    <div class="mt-1 pt-1 border-t border-yellow-900/50">
                        <div class="text-yellow-400 font-bold text-[9px] mb-1">Notes:</div>
                        ${b.allNotes.map(n => `<div class="text-[9px] text-yellow-300/80">${n}</div>`).join('')}
                    </div>` : ''}
                    
                    <!-- Positives Section (collapsed) -->
                    ${b.allPositives && b.allPositives.length > 0 ? `
                    <div class="mt-1 pt-1 border-t border-green-900/50">
                        <div class="text-green-400 font-bold text-[9px] mb-1">Positives:</div>
                        ${b.allPositives.slice(0, 3).map(p => `<div class="text-[9px] text-green-300/80">${p}</div>`).join('')}
                        ${b.allPositives.length > 3 ? `<div class="text-[9px] text-gray-500">+${b.allPositives.length - 3} more...</div>` : ''}
                    </div>` : ''}
                </div>
            `;
        } else {
            // Fallback when no metadata
            accessHtml = `
                <div class="space-y-1 text-[10px]">
                    <div class="flex justify-between"><span class="text-gray-500">${b.asset1?.name || 'Asset 1'}:</span><span class="text-white">${b.asset1?.score || '?'}/100</span></div>
                    <div class="flex justify-between"><span class="text-gray-500">${b.asset2?.name || 'Asset 2'}:</span><span class="text-white">${b.asset2?.score || '?'}/100</span></div>
                    <div class="flex justify-between"><span class="text-gray-500">Asset Avg:</span><span class="text-yellow-300">${b.assetAvg?.toFixed(0) || '?'}/100</span></div>
                    <div class="mt-2 pt-1 border-t border-yellow-900/50">
                        <div class="text-yellow-400 text-[9px]">‚ö†Ô∏è No metadata configured for one or both assets</div>
                        <div class="text-gray-500 text-[9px]">Using fallback scoring - configure metadata in Asset Metadata Manager for accurate scores</div>
                    </div>
                </div>
            `;
        }
    }
    
    let modal = document.createElement('div');
    modal.className = 'modal-overlay open';
    modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
    modal.innerHTML = `
        <div class="modal-box max-w-3xl">
            <div class="flex justify-between items-center mb-4 border-b border-gray-700 pb-2">
                <h3 class="text-lg font-bold text-white">${poolName} <span class="text-sm text-gray-500">(${p.d})</span></h3>
                <button onclick="this.closest('.modal-overlay').remove()" class="text-gray-500 hover:text-white text-xl">&times;</button>
            </div>
            
            <div class="grid grid-cols-3 gap-3 text-sm">
                <div class="bg-gray-800/50 p-3 rounded">
                    <h4 class="text-teal-400 font-bold mb-2 border-b border-gray-700 pb-1">Performance Metrics</h4>
                    <div class="space-y-1 text-[10px]">
                        <div class="flex justify-between"><span class="text-gray-500">4Ep Avg Liquidity:</span><span class="text-teal-300">${liq4EpStr}</span></div>
                        <div class="flex justify-between"><span class="text-gray-500">4Ep Avg Volume:</span><span class="text-teal-300">${vol4EpStr}</span></div>
                        <div class="flex justify-between"><span class="text-gray-500">Efficiency (Vol/Liq):</span><span class="text-yellow-400">${p.efficiency?.toFixed(3) || 'N/A'}</span></div>
                        <div class="flex justify-between"><span class="text-gray-500">Non-Amp APR:</span><span class="text-green-400">${p.aprNon ? p.aprNon.toFixed(1) + '%' : 'N/A'}</span></div>
                        <div class="flex justify-between"><span class="text-gray-500">Amplified APR:</span><span class="text-yellow-400">${p.aprAmp ? 'üî•' + p.aprAmp.toFixed(1) + '%' : 'N/A'}</span></div>
                    </div>
                    <div class="mt-2 pt-2 border-t border-gray-700 text-[10px]">
                        <div class="flex justify-between"><span class="text-gray-500">Efficiency Rank:</span><span>${p.effRank?.toFixed(0) || 0}% (√ó0.35)</span></div>
                        <div class="flex justify-between"><span class="text-gray-500">Volume Rank:</span><span>${p.volRank?.toFixed(0) || 0}% (√ó0.25)</span></div>
                        <div class="flex justify-between"><span class="text-gray-500">Liquidity Rank:</span><span>${p.liqRank?.toFixed(0) || 0}% (√ó0.20)</span></div>
                        <div class="flex justify-between"><span class="text-gray-500">Access Score:</span><span>${p.accessScore?.toFixed(0) || 0}% (√ó0.15)</span></div>
                        <div class="flex justify-between"><span class="text-gray-500">History Score:</span><span class="text-gray-600">TBD (√ó0.05)</span></div>
                    </div>
                    <div class="mt-2 pt-2 border-t border-gray-700 font-bold text-[11px]">
                        <div class="flex justify-between"><span>Performance:</span><span class="text-white">${p.performanceScore?.toFixed(1) || 0}</span></div>
                    </div>
                </div>
                
                <div class="bg-gray-800/50 p-3 rounded">
                    <h4 class="text-orange-300 font-bold mb-2 border-b border-gray-700 pb-1">Support Metrics</h4>
                    <div class="space-y-1 text-[10px]">
                        <div class="flex justify-between"><span class="text-gray-500">PD Bribes:</span><span class="text-green-400">${fmt$(p.incPD)}</span></div>
                        ${p.incOther > 0 ? `<div class="flex justify-between"><span class="text-gray-500">Other Bribes:</span><span class="text-yellow-400">${fmt$(p.incOther)}</span></div>` : ''}
                        ${p.incTotal > p.incPD ? `<div class="flex justify-between"><span class="text-gray-500">Total Bribes:</span><span class="text-white">${fmt$(p.incTotal)}</span></div>` : ''}
                        <div class="flex justify-between"><span class="text-gray-500">Votion Now:</span><span class="text-purple-400">${p.votNowPct?.toFixed(2) || 0}%</span></div>
                        <div class="flex justify-between"><span class="text-gray-500">Votion Next:</span><span class="text-purple-300">${p.votNextPct?.toFixed(2) || 0}%</span></div>
                        <div class="flex justify-between"><span class="text-gray-500">Votion Dominance:</span><span class="${(p.votionDominance || 0) > 50 ? 'text-red-400' : 'text-gray-300'}">${p.votionDominance?.toFixed(0) || 0}%</span></div>
                        <div class="flex justify-between"><span class="text-gray-500">TLA Vote %:</span><span class="text-orange-400">${p.vps?.toFixed(2) || 0}%</span></div>
                    </div>
                    <div class="mt-2 pt-2 border-t border-gray-700 text-[10px]">
                        <div class="flex justify-between"><span class="text-gray-500">Bribes Rank:</span><span>${p.incRank?.toFixed(0) || 0}% (√ó0.40)</span></div>
                        <div class="flex justify-between"><span class="text-gray-500">TLA Rank:</span><span>${p.tlaRank?.toFixed(0) || 0}% (√ó0.30)</span></div>
                        <div class="flex justify-between"><span class="text-gray-500">Votion Dominance:</span><span>${p.votionDominance?.toFixed(0) || 0}% (√ó0.30)</span></div>
                    </div>
                    <div class="mt-2 pt-2 border-t border-gray-700 font-bold text-[11px]">
                        <div class="flex justify-between"><span>Support:</span><span class="text-white">${p.supportScore?.toFixed(1) || 0}</span></div>
                    </div>
                </div>
                
                <div class="bg-gray-800/50 p-3 rounded">
                    <h4 class="text-cyan-400 font-bold mb-2 border-b border-gray-700 pb-1">Access Score Breakdown</h4>
                    ${accessHtml || '<div class="text-gray-500 text-[10px]">No data</div>'}
                    <div class="mt-2 pt-2 border-t border-gray-700 font-bold text-[11px]">
                        <div class="flex justify-between"><span>Access:</span><span class="text-white">${p.accessScore?.toFixed(0) || 0}/100</span></div>
                    </div>
                </div>
            </div>
            
            <div class="mt-4 bg-emerald-900/30 border border-emerald-800 p-3 rounded">
                <h4 class="text-emerald-400 font-bold mb-2">aDAO Opportunity Calculation</h4>
                <div class="grid grid-cols-2 gap-4">
                    <div class="text-[11px] font-mono space-y-1">
                        <div>Performance Score: <span class="text-white">${p.performanceScore?.toFixed(1) || 0}</span></div>
                        <div>- Support Score: <span class="text-white">${p.supportScore?.toFixed(1) || 0}</span></div>
                        <div>+ APR Factor: <span class="${p.aprFactor >= 0 ? 'text-green-400' : 'text-red-400'}">${p.aprFactor >= 0 ? '+' : ''}${p.aprFactor || 0}</span> <span class="text-gray-500">(APR: ${p.aprNon?.toFixed(1) || '?'}%)</span></div>
                        <div class="border-t border-emerald-800 pt-1 mt-1 text-lg">
                            = <span class="${getScoreColor(p.adaoScore)} font-bold">${getScoreIcon(p.adaoScore)} ${p.adaoScore?.toFixed(1) || 0}</span>
                        </div>
                    </div>
                    <div class="text-[10px] text-gray-400">
                        <div class="font-bold text-white mb-1">Score Interpretation:</div>
                        <div>üü¢ +50 to +100: High priority</div>
                        <div>üü° +20 to +50: Opportunity</div>
                        <div>‚ö™ -20 to +20: Balanced</div>
                        <div>üîµ -50 to -20: Over-supported</div>
                        <div>üî¥ Below -50: Over-hyped</div>
                    </div>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

// ============ METADATA MANAGER ============

let assetMetadata = {};
let assetMetadataMeta = {
    last_updated_epoch: null,
    last_updated_date: null,
    loaded_from: null  // 'github' or 'file'
};
const METADATA_GITHUB_URL = 'https://raw.githubusercontent.com/defipatriot/tla_json_storage/main/tla_metadata.json';

// Origin types - how does asset get to Terra?
const ORIGIN_TYPES = {
    terra_native:    { label: 'üè† Terra Native', color: 'text-green-400', baseScore: 80 },
    terra_lsd:       { label: 'üîÑ Terra LSD', color: 'text-cyan-400', baseScore: 85 },
    ibc:             { label: '‚öõÔ∏è IBC', color: 'text-purple-400', baseScore: 70 },
    bridge_eureka:   { label: 'üåâ Eureka', color: 'text-yellow-400', baseScore: 55 },
    bridge_axelar:   { label: 'üî∂ Axelar', color: 'text-orange-400', baseScore: 50 },
    bridge_osmosis:  { label: 'üü† Osmosis', color: 'text-orange-300', baseScore: 50 },
    stable_native:   { label: 'üíµ Stable', color: 'text-blue-400', baseScore: 65 },
    unknown:         { label: '‚ùì Unknown', color: 'text-gray-500', baseScore: 30 }
};

// Asset classes
const ASSET_CLASSES = {
    stable:    { label: 'Stable', desc: 'USDC, USDT, EURe', color: 'text-green-300', bonus: 5 },
    bluechip:  { label: 'Bluechip', desc: 'BTC, ETH, PAXG', color: 'text-yellow-300', bonus: 5 },
    lsd:       { label: 'LSD', desc: 'Liquid staking', color: 'text-cyan-300', bonus: 5 },
    core:      { label: 'Core', desc: 'LUNA, ATOM', color: 'text-purple-300', bonus: 0 },
    native:    { label: 'Native', desc: 'Terra ecosystem', color: 'text-orange-300', bonus: 0 },
    defi:      { label: 'DeFi', desc: 'Protocol tokens', color: 'text-blue-300', bonus: 0 },
    unknown:   { label: 'Unknown', desc: 'Not classified', color: 'text-gray-500', bonus: 0 }
};

// CoinGecko status
const CG_STATUS = {
    cg_terra:  { label: '‚úì Terra', color: 'text-green-400', score: 15 },
    cg_chain:  { label: '‚óã Chain', color: 'text-yellow-400', score: 5 },
    cg_none:   { label: '‚úó None', color: 'text-red-400', score: -15 }
};

// Acquisition difficulty
const ACQUISITION = {
    easy:   { label: '‚úì Easy', color: 'text-green-400', desc: 'Simple IBC or already on Terra' },
    medium: { label: '‚óê Medium', color: 'text-yellow-400', desc: 'Bridge with clear path' },
    hard:   { label: '‚úó Hard', color: 'text-red-400', desc: 'Multiple steps, confusing options' }
};

// Treasury value
const TREASURY_VALUE = {
    high:   { label: 'üèÜ High', color: 'text-yellow-400', score: 5, desc: 'BTC, ETH, stables - chain wants these' },
    medium: { label: 'üëç Medium', color: 'text-blue-400', score: 0, desc: 'Useful assets' },
    low:    { label: 'üëé Low', color: 'text-gray-400', score: -5, desc: 'Protocol/ecosystem tokens' }
};

function toggleMetadataPanel() {
    let panel = $('metadata-panel');
    let toggle = $('meta-toggle');
    if (panel.classList.contains('hidden')) {
        panel.classList.remove('hidden');
        toggle.innerText = '‚ñ≤';
    } else {
        panel.classList.add('hidden');
        toggle.innerText = '‚ñº';
    }
}

// Asset aliases - different names for the same asset
// Maps various formats to canonical form
const ASSET_ALIASES = {
    // bLUNA variants - boneLUNA and bLUNA are the SAME asset
    // TLA shows "boneLUNA" but everywhere else it's "bLUNA"
    'BONELUNA': 'bLUNA',
    'boneLUNA': 'bLUNA',
    'BLUNA': 'bLUNA',
    'bluna': 'bLUNA',
    
    // ampLUNA variants  
    'AMPLUNA': 'ampLUNA',
    'ampluna': 'ampLUNA',
    
    // arbLUNA variants
    'ARBLUNA': 'arbLUNA',
    'arbluna': 'arbLUNA',
    
    // ampCAPA variants
    'AMPCAPA': 'ampCAPA',
    'ampcapa': 'ampCAPA',
    
    // ampROAR variants
    'AMPROAR': 'ampROAR',
    'amproar': 'ampROAR',
    
    // xASTRO variants
    'XASTRO': 'xASTRO',
    'xastro': 'xASTRO',
    
    // Bridged tokens - KEEP SUFFIXES, just normalize case
    // wBTC variants - each bridge path is a SEPARATE asset for metadata
    'WBTC.AXL': 'wBTC.axl',
    'WBTC.ATOM': 'wBTC.atom',
    'WBTC.OSMO': 'wBTC.osmo',
    
    // wETH variants
    'WETH.AXL': 'wETH.axl',
    
    // wBNB variants
    'WBNB.AXL': 'wBNB.axl',
    
    // wstETH variants
    'WSTETH': 'wstETH',
    'wsteth': 'wstETH',
    
    // stLUNA variants
    'STLUNA': 'stLUNA',
    'stluna': 'stLUNA',
    
    // stATOM variants
    'STATOM': 'stATOM',
    'statom': 'stATOM',
    
    // EURe variants
    'EURE': 'EURe',
    'eure': 'EURe'
};

// Normalize asset name (handle case and aliases)
function normalizeAssetName(asset) {
    if (!asset) return '';
    let trimmed = asset.trim();
    
    // Check for alias (case-insensitive)
    let upper = trimmed.toUpperCase();
    if (ASSET_ALIASES[upper]) return ASSET_ALIASES[upper];
    if (ASSET_ALIASES[trimmed]) return ASSET_ALIASES[trimmed];
    
    return trimmed;
}

// Check if asset exists in metadata (case-insensitive)
function assetExistsInMetadata(asset) {
    let normalized = normalizeAssetName(asset);
    
    // Direct match on normalized name
    if (assetMetadata[normalized]) return normalized;
    
    // Direct match on original
    if (assetMetadata[asset]) return asset;
    
    // Case-insensitive search on normalized
    let upperNorm = normalized.toUpperCase();
    for (let key of Object.keys(assetMetadata)) {
        if (key.toUpperCase() === upperNorm) return key;
    }
    
    // Check if any existing key normalizes to the same thing
    // This handles boneLUNA -> bLUNA when boneLUNA exists in metadata
    for (let key of Object.keys(assetMetadata)) {
        let keyNormalized = normalizeAssetName(key);
        if (keyNormalized === normalized || keyNormalized.toUpperCase() === upperNorm) {
            return key;
        }
    }
    
    return null;
}

function extractAssetsFromPools() {
    const extractStatus = $('meta-extract-status');
    if (extractStatus) extractStatus.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Comparing...';
    
    let allAssets = new Set();
    let newAssets = [];
    
    // Get assets from Vote tab pools
    store.vote.pools.forEach(p => {
        p.n.split('-').forEach(a => { 
            if (a && a.length > 0) {
                let normalized = normalizeAssetName(a);
                if (normalized) allAssets.add(normalized);
            }
        });
    });
    
    // Get assets from TLA pools
    store.tla.pools.forEach(p => {
        (p.normName || p.name).split('-').forEach(a => { 
            if (a && a.length > 0) {
                let normalized = normalizeAssetName(a);
                if (normalized) allAssets.add(normalized);
            }
        });
    });
    
    // Get assets from ext file token prices
    if (store.extFile.tokenPrices) {
        Object.keys(store.extFile.tokenPrices).forEach(token => {
            let normalized = normalizeAssetName(token);
            if (normalized) allAssets.add(normalized);
        });
    }
    
    // Compare with existing metadata (case-insensitive)
    allAssets.forEach(asset => {
        let existingKey = assetExistsInMetadata(asset);
        if (!existingKey) {
            // New asset - add with default metadata
            assetMetadata[asset] = createDefaultAssetMeta(asset);
            newAssets.push(asset);
        }
    });
    
    // Store new assets list for tracking
    pasteStatus.assetMetaNewAssets = newAssets;
    
    // Update UI
    renderMetaAssetList(newAssets);
    updateMetaStatus();
    
    // Update new count badge
    const newCountEl = $('meta-new-count');
    if (newCountEl) {
        if (newAssets.length > 0) {
            newCountEl.textContent = `${newAssets.length} new`;
            newCountEl.classList.remove('hidden');
        } else {
            newCountEl.classList.add('hidden');
        }
    }
    
    // Update extract status
    if (extractStatus) {
        if (newAssets.length > 0) {
            extractStatus.innerHTML = `<span class="text-yellow-400">‚ö† ${newAssets.length} new assets need review</span>`;
        } else {
            extractStatus.innerHTML = '<span class="text-green-400">‚úì No new assets found</span>';
        }
    }
}

function createDefaultAssetMeta(asset) {
    return {
        tla_name: asset,
        actual_path: '',  // Blank - user must fill in
        origin: 'unknown',
        acquisition: 'hard',
        acquisition_note: '',
        cg_status: 'cg_none',  // Default to worst case
        skip_clear: false,
        asset_class: 'unknown',
        treasury_value: 'low',
        multi_dex: false,
        notes: '',
        // Edit tracking
        last_edited: null,      // ISO timestamp
        last_edited_epoch: null // Epoch number when last edited
    };
}

// Naming accurate is ALWAYS calculated, not stored
function isNamingAccurate(meta) {
    if (!meta.actual_path || meta.actual_path === '') return false;
    return meta.tla_name === meta.actual_path;
}

function detectOrigin(asset) {
    let base = asset.replace(/\.(atom|axl|osmo|wh)$/i, '').toUpperCase();
    if (asset.match(/\.atom$/i)) return 'bridge_eureka';
    if (asset.match(/\.axl$/i)) return 'bridge_axelar';
    if (asset.match(/\.osmo$/i)) return 'bridge_osmosis';
    if (['AMPLUNA', 'ARBLUNA', 'BLUNA', 'STLUNA', 'BONELUNA', 'AMPROAR', 'AMPCAPA'].includes(base)) return 'terra_lsd';
    if (['ROAR', 'CAPA', 'SOLID', 'FUEL', 'SWTH'].includes(base)) return 'terra_native';
    if (['USDC', 'USDT', 'EURE'].includes(base)) return 'stable_native';
    if (['ATOM', 'INJ', 'ASTRO', 'XASTRO', 'STATOM', 'LUNA'].includes(base)) return 'ibc';
    if (['BTC', 'WBTC', 'ETH', 'WETH', 'PAXG'].includes(base)) return 'bridge_eureka';
    return 'unknown';
}

function detectAssetClass(asset) {
    let base = asset.replace(/\.(atom|axl|osmo|wh)$/i, '').toUpperCase();
    if (['BTC', 'WBTC', 'ETH', 'WETH', 'PAXG'].includes(base)) return 'bluechip';
    if (['USDC', 'USDT', 'EURE', 'DAI', 'SOLID'].includes(base)) return 'stable';
    if (['LUNA', 'ATOM'].includes(base)) return 'core';
    if (['ROAR', 'CAPA', 'FUEL', 'SWTH'].includes(base)) return 'native';
    if (['AMPLUNA', 'ARBLUNA', 'BLUNA', 'STLUNA', 'BONELUNA', 'STATOM', 'AMPROAR', 'AMPCAPA', 'XASTRO'].includes(base)) return 'lsd';
    if (['ASTRO', 'INJ'].includes(base)) return 'defi';
    return 'unknown';
}

function detectActualPath(asset) {
    if (asset.match(/\.(atom|axl|osmo|wh|noble)$/i)) return asset;
    let base = asset.toUpperCase();
    if (['USDC', 'USDT'].includes(base)) return asset + '.noble';
    if (['PAXG'].includes(base)) return asset + '.atom';
    if (['WSTETH', 'WETH', 'WBNB'].includes(base)) return asset + '.axl';
    return asset;
}

function detectNamingAccurate(asset) {
    return asset === detectActualPath(asset);
}

function detectAcquisition(origin) {
    if (['terra_native', 'terra_lsd', 'ibc'].includes(origin)) return 'easy';
    if (['bridge_eureka', 'bridge_axelar', 'bridge_osmosis'].includes(origin)) return 'medium';
    if (origin === 'stable_native') return 'hard';
    return 'hard';
}

function detectTreasuryValue(assetClass) {
    if (['bluechip', 'stable', 'core'].includes(assetClass)) return 'high';
    if (['lsd'].includes(assetClass)) return 'medium';
    return 'low';
}

function calculateAccessScore(meta) {
    let origin = ORIGIN_TYPES[meta.origin] || ORIGIN_TYPES.unknown;
    let assetClass = ASSET_CLASSES[meta.asset_class] || ASSET_CLASSES.unknown;
    let cg = CG_STATUS[meta.cg_status] || CG_STATUS.cg_none;
    let treasury = TREASURY_VALUE[meta.treasury_value] || TREASURY_VALUE.medium;
    let score = origin.baseScore + assetClass.bonus + cg.score + treasury.score;
    
    // Naming accurate is calculated, not stored
    if (isNamingAccurate(meta)) score += 10; else score -= 10;
    
    if (meta.skip_clear) score += 5; else score -= 5;
    if (meta.multi_dex) score += 5;
    return Math.max(0, Math.min(100, score));
}

function renderMetaAssetList(newAssets = []) {
    let container = $('meta-asset-list');
    if (!container) return;
    let search = $('meta-search')?.value?.toLowerCase() || '';
    let assets = Object.keys(assetMetadata).sort();
    let currentEpoch = getCurrentWorkingEpoch();
    
    // Sort order: 
    // 1. New assets first
    // 2. Then unedited (never edited)
    // 3. Then edited in older epochs (yellow)
    // 4. Then edited this epoch (green) at bottom
    assets.sort((a, b) => {
        let metaA = assetMetadata[a];
        let metaB = assetMetadata[b];
        let aNew = newAssets.includes(a);
        let bNew = newAssets.includes(b);
        let aEdited = metaA.last_edited_epoch;
        let bEdited = metaB.last_edited_epoch;
        let aCurrentEpoch = aEdited === currentEpoch;
        let bCurrentEpoch = bEdited === currentEpoch;
        
        // New assets first
        if (aNew && !bNew) return -1;
        if (!aNew && bNew) return 1;
        
        // Never edited next
        if (!aEdited && bEdited) return -1;
        if (aEdited && !bEdited) return 1;
        
        // Older epoch edits next
        if (aEdited && bEdited) {
            if (!aCurrentEpoch && bCurrentEpoch) return -1;
            if (aCurrentEpoch && !bCurrentEpoch) return 1;
        }
        
        // Alphabetical within same category
        return a.localeCompare(b);
    });
    
    if (search) assets = assets.filter(a => a.toLowerCase().includes(search));
    if (assets.length === 0) {
        container.innerHTML = '<div class="text-center text-gray-600 italic text-xs py-4">No assets found</div>';
        return;
    }
    let html = '';
    assets.forEach(asset => {
        let meta = assetMetadata[asset];
        let score = calculateAccessScore(meta);
        let namingOk = isNamingAccurate(meta);
        let scoreColor = score >= 80 ? 'text-green-400' : score >= 60 ? 'text-yellow-400' : 'text-red-400';
        let namingColor = namingOk ? 'text-green-400' : 'text-red-400';
        let namingIcon = namingOk ? '‚úì' : '‚úó';
        let skipColor = meta.skip_clear ? 'text-green-400' : 'text-red-400';
        let skipIcon = meta.skip_clear ? '‚úì' : '‚úó';
        let treasuryInfo = TREASURY_VALUE[meta.treasury_value] || TREASURY_VALUE.medium;
        let cgInfo = CG_STATUS[meta.cg_status] || CG_STATUS.cg_none;
        let needsSetup = !meta.actual_path || meta.origin === 'unknown' || meta.asset_class === 'unknown';
        let isNew = newAssets.includes(asset);
        
        // Edit status
        let editEpoch = meta.last_edited_epoch;
        let editedThisEpoch = editEpoch === currentEpoch;
        let editColor = !editEpoch ? 'text-gray-600' : editedThisEpoch ? 'text-green-400' : 'text-yellow-400';
        let editIcon = !editEpoch ? '-' : editedThisEpoch ? '‚úì' : 'E' + editEpoch;
        let editTitle = !editEpoch ? 'Never edited' : 
                       editedThisEpoch ? 'Edited this epoch (' + meta.last_edited.split('T')[0] + ')' : 
                       'Last edited E' + editEpoch + ' (' + (meta.last_edited?.split('T')[0] || '?') + ')';
        
        // Highlight new assets with a distinct style
        let rowClass = isNew ? 'bg-yellow-800/40 border-l-2 border-yellow-400' : 
                       needsSetup ? 'bg-yellow-900/20' : 
                       !editEpoch ? 'bg-gray-800/30' :
                       !editedThisEpoch ? 'bg-yellow-900/10' :
                       !namingOk ? 'bg-red-900/10' : '';
        
        html += `
        <div class="grid grid-cols-12 gap-1 items-center px-2 py-1 hover:bg-gray-800/50 rounded text-[8px] ${rowClass}">
            <div class="col-span-2">
                <div class="font-mono text-white font-bold">${isNew ? 'üÜï ' : needsSetup ? '‚ö†Ô∏è ' : ''}${asset}</div>
                ${meta.actual_path && !namingOk ? '<div class="text-[7px] text-gray-500">‚Üí ' + meta.actual_path + '</div>' : ''}
                ${!meta.actual_path ? '<div class="text-[7px] text-yellow-500 italic">needs setup</div>' : ''}
            </div>
            <div class="col-span-1 text-center ${namingColor}" title="${namingOk ? 'Name matches' : meta.actual_path ? 'Should be: ' + meta.actual_path : 'Path not set'}">${namingIcon}</div>
            <div class="col-span-1 text-center ${cgInfo.color}" title="CoinGecko: ${cgInfo.label}">${cgInfo.label.charAt(0)}</div>
            <div class="col-span-1 text-center ${skipColor}" title="Skip.go ${meta.skip_clear ? 'clear' : 'confusing'}">${skipIcon}</div>
            <div class="col-span-1 text-center" title="Multi-DEX">
                <input type="checkbox" ${meta.multi_dex ? 'checked' : ''} 
                    onchange="toggleMetaField('${asset}', 'multi_dex', this.checked); renderMetaAssetList();"
                    class="w-3 h-3 accent-purple-500">
            </div>
            <div class="col-span-1 text-center text-[7px] ${treasuryInfo.color}" title="${treasuryInfo.label}">${treasuryInfo.label.substring(0,3)}</div>
            <div class="col-span-1 text-center font-bold ${scoreColor}">${score}</div>
            <div class="col-span-1 text-center ${editColor}" title="${editTitle}">${editIcon}</div>
            <div class="col-span-2 text-center">
                <button onclick="editAssetDetails('${asset}')" class="text-blue-400 hover:text-white">‚úèÔ∏è</button>
                <button onclick="deleteAsset('${asset}')" class="text-red-400 hover:text-white ml-1">üóëÔ∏è</button>
            </div>
        </div>`;
    });
    container.innerHTML = html;
}

function filterMetaAssets() { renderMetaAssetList(); }
function toggleMetaField(asset, field, value) { if (assetMetadata[asset]) assetMetadata[asset][field] = value; }
function updateMetaField(asset, field, value) { if (assetMetadata[asset]) { assetMetadata[asset][field] = value; renderMetaAssetList(); } }
function deleteAsset(asset) { if (confirm('Delete ' + asset + '?')) { delete assetMetadata[asset]; renderMetaAssetList(); updateMetaStatus(); } }
function addNewAsset() {
    let asset = prompt('Enter asset symbol (e.g., LUNA, wBTC.axl):');
    if (!asset) return;
    asset = asset.trim();
    if (assetMetadata[asset]) { alert('Asset already exists!'); return; }
    assetMetadata[asset] = createDefaultAssetMeta(asset);
    renderMetaAssetList();
    updateMetaStatus();
}

function editAssetDetails(asset) {
    let meta = assetMetadata[asset];
    if (!meta) return;
    let score = calculateAccessScore(meta);
    let namingOk = isNamingAccurate(meta);
    let modal = document.createElement('div');
    modal.className = 'modal-overlay open';
    modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
    modal.innerHTML = `
        <div class="modal-box max-w-xl">
            <div class="flex justify-between items-center mb-4 border-b border-gray-700 pb-2">
                <h3 class="text-lg font-bold text-white">Edit: ${asset}</h3>
                <button onclick="this.closest('.modal-overlay').remove()" class="text-gray-500 hover:text-white text-xl">&times;</button>
            </div>
            <div class="grid grid-cols-3 gap-4 mb-4">
                <div class="bg-gray-900 p-3 rounded border border-gray-800 text-center">
                    <div class="text-gray-500 text-[10px]">Access Score</div>
                    <div id="edit-score-display" class="text-2xl font-bold ${score >= 80 ? 'text-green-400' : score >= 60 ? 'text-yellow-400' : 'text-red-400'}">${score}</div>
                </div>
                <div class="bg-gray-900 p-3 rounded border border-gray-800 text-center">
                    <div class="text-gray-500 text-[10px]">TLA Name</div>
                    <div class="text-lg font-mono text-white">${meta.tla_name}</div>
                </div>
                <div class="bg-gray-900 p-3 rounded border border-gray-800 text-center">
                    <div class="text-gray-500 text-[10px]">Naming Status</div>
                    <div id="edit-naming-status" class="text-lg font-bold ${namingOk ? 'text-green-400' : 'text-red-400'}">${namingOk ? '‚úì Match' : '‚úó Mismatch'}</div>
                </div>
            </div>
            <div class="bg-gray-900/50 p-3 rounded border border-gray-700 mb-3">
                <h4 class="text-xs font-bold text-white mb-2">üè∑Ô∏è Identity</h4>
                <div>
                    <label class="block text-gray-400 text-[10px] mb-1">Actual Path (what it really is - leave same as TLA if accurate)</label>
                    <input type="text" id="edit-actual-path" value="${meta.actual_path || ''}" 
                        placeholder="e.g., USDC.noble, wBTC.atom, or same as TLA name if accurate"
                        oninput="updateNamingStatus('${asset}')"
                        class="w-full bg-gray-800 border border-gray-700 rounded px-2 py-1 text-sm font-mono">
                    <div class="text-[9px] text-gray-500 mt-1">
                        If TLA shows "USDC" but it's really "USDC.noble", enter "USDC.noble" here.
                        If TLA shows "wBTC.atom" and that's accurate, enter "wBTC.atom".
                    </div>
                </div>
            </div>
            <div class="bg-gray-900/50 p-3 rounded border border-gray-700 mb-3">
                <h4 class="text-xs font-bold text-white mb-2">üõí Acquisition</h4>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-gray-400 text-[10px] mb-1">Origin</label>
                        <select id="edit-origin" class="w-full bg-gray-800 border border-gray-700 rounded px-2 py-1 text-sm">
                            ${Object.entries(ORIGIN_TYPES).map(([k, v]) => '<option value="' + k + '" ' + (meta.origin === k ? 'selected' : '') + '>' + v.label + ' (' + v.baseScore + ')</option>').join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-400 text-[10px] mb-1">Difficulty</label>
                        <select id="edit-acquisition" class="w-full bg-gray-800 border border-gray-700 rounded px-2 py-1 text-sm">
                            ${Object.entries(ACQUISITION).map(([k, v]) => '<option value="' + k + '" ' + (meta.acquisition === k ? 'selected' : '') + '>' + v.label + ' - ' + v.desc + '</option>').join('')}
                        </select>
                    </div>
                </div>
                <div class="mt-2">
                    <input type="text" id="edit-acquisition-note" value="${meta.acquisition_note || ''}" placeholder="Acquisition notes (e.g., Must select Noble, route to Terra)" class="w-full bg-gray-800 border border-gray-700 rounded px-2 py-1 text-xs">
                </div>
            </div>
            <div class="bg-gray-900/50 p-3 rounded border border-gray-700 mb-3">
                <h4 class="text-xs font-bold text-white mb-2">üîç Discoverability</h4>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-gray-400 text-[10px] mb-1">CoinGecko</label>
                        <select id="edit-cg" class="w-full bg-gray-800 border border-gray-700 rounded px-2 py-1 text-sm">
                            ${Object.entries(CG_STATUS).map(([k, v]) => '<option value="' + k + '" ' + (meta.cg_status === k ? 'selected' : '') + '>' + v.label + ' (' + (v.score >= 0 ? '+' : '') + v.score + ')</option>').join('')}
                        </select>
                    </div>
                    <div class="flex items-end">
                        <div class="flex items-center gap-2 bg-gray-800 p-2 rounded w-full">
                            <input type="checkbox" id="edit-skip-clear" ${meta.skip_clear ? 'checked' : ''} class="accent-green-500">
                            <label class="text-xs">Skip.go Clear (+5/-5)</label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-900/50 p-3 rounded border border-yellow-900/50 mb-3">
                <h4 class="text-xs font-bold text-yellow-400 mb-2">üí∞ Value to Chain (10% take rate)</h4>
                <div class="grid grid-cols-3 gap-3">
                    <div>
                        <label class="block text-gray-400 text-[10px] mb-1">Asset Class</label>
                        <select id="edit-class" class="w-full bg-gray-800 border border-gray-700 rounded px-2 py-1 text-sm">
                            ${Object.entries(ASSET_CLASSES).map(([k, v]) => '<option value="' + k + '" ' + (meta.asset_class === k ? 'selected' : '') + '>' + v.label + ' - ' + v.desc + ' (+' + v.bonus + ')</option>').join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-400 text-[10px] mb-1">Treasury Value</label>
                        <select id="edit-treasury" class="w-full bg-gray-800 border border-gray-700 rounded px-2 py-1 text-sm">
                            ${Object.entries(TREASURY_VALUE).map(([k, v]) => '<option value="' + k + '" ' + (meta.treasury_value === k ? 'selected' : '') + '>' + v.label + ' (' + (v.score >= 0 ? '+' : '') + v.score + ')</option>').join('')}
                        </select>
                    </div>
                    <div class="flex items-end">
                        <div class="flex items-center gap-2 bg-gray-800 p-2 rounded w-full">
                            <input type="checkbox" id="edit-multi-dex" ${meta.multi_dex ? 'checked' : ''} class="accent-purple-500">
                            <label class="text-xs text-purple-400">Multi-DEX (+5)</label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="mb-3">
                <textarea id="edit-notes" rows="2" placeholder="General notes..." class="w-full bg-gray-800 border border-gray-700 rounded px-2 py-1 text-xs">${meta.notes || ''}</textarea>
            </div>
            <button onclick="saveAssetDetails('${asset}')" class="w-full bg-green-700 hover:bg-green-600 py-2 rounded font-bold">Save</button>
        </div>`;
    document.body.appendChild(modal);
}

function updateNamingStatus(asset) {
    let tlaName = asset;
    let actualPath = $('edit-actual-path')?.value || '';
    let namingOk = actualPath && tlaName === actualPath;
    let statusEl = $('edit-naming-status');
    if (statusEl) {
        statusEl.textContent = namingOk ? '‚úì Match' : '‚úó Mismatch';
        statusEl.className = 'text-lg font-bold ' + (namingOk ? 'text-green-400' : 'text-red-400');
    }
}

function saveAssetDetails(asset) {
    let meta = assetMetadata[asset];
    if (!meta) return;
    meta.actual_path = $('edit-actual-path')?.value || '';
    // naming_accurate is calculated from tla_name === actual_path, not stored
    meta.origin = $('edit-origin')?.value || 'unknown';
    meta.acquisition = $('edit-acquisition')?.value || 'hard';
    meta.acquisition_note = $('edit-acquisition-note')?.value || '';
    meta.cg_status = $('edit-cg')?.value || 'cg_none';
    meta.skip_clear = $('edit-skip-clear')?.checked || false;
    meta.asset_class = $('edit-class')?.value || 'unknown';
    meta.treasury_value = $('edit-treasury')?.value || 'medium';
    meta.multi_dex = $('edit-multi-dex')?.checked || false;
    meta.notes = $('edit-notes')?.value || '';
    
    // Set edit tracking
    meta.last_edited = new Date().toISOString();
    meta.last_edited_epoch = getCurrentWorkingEpoch();
    
    document.querySelector('.modal-overlay.open')?.remove();
    renderMetaAssetList();
    updateMetaStatus();
}

// Get the current working epoch from config or ext file
function getCurrentWorkingEpoch() {
    // Try to get from ext file first
    if (store.extFile?.epoch) return store.extFile.epoch;
    // Fallback to config
    let cfgEpoch = $('cfg-epoch')?.value;
    if (cfgEpoch) return parseInt(cfgEpoch);
    // Default
    return 165;
}

function updateMetaStatus() {
    let count = Object.keys(assetMetadata).length;
    let needsSetup = Object.values(assetMetadata).filter(m => !m.actual_path || m.origin === 'unknown' || m.asset_class === 'unknown').length;
    let namingIssues = Object.values(assetMetadata).filter(m => !isNamingAccurate(m)).length;
    let avg = count > 0 ? Math.round(Object.values(assetMetadata).reduce((s, m) => s + calculateAccessScore(m), 0) / count) : 0;
    setTxt('meta-status', count + ' assets (' + needsSetup + ' need setup, ' + namingIssues + ' naming issues, avg: ' + avg + ')');
    
    // Update header indicator
    const statusEl = $('status-asset-meta');
    const countEl = $('status-asset-meta-count');
    const epochEl = $('status-asset-meta-epoch');
    if (statusEl && countEl) {
        if (count > 0) {
            statusEl.className = 'text-green-500 cursor-pointer font-semibold';
            statusEl.innerText = 'Asset Meta ‚úì';
            countEl.innerText = count + ' assets';
            // Show last updated epoch on separate line
            if (epochEl) {
                if (assetMetadataMeta.last_updated_epoch) {
                    epochEl.innerText = `E${assetMetadataMeta.last_updated_epoch}`;
                    epochEl.className = 'text-[7px] text-cyan-500';
                } else {
                    epochEl.innerText = '';
                }
            }
        } else {
            statusEl.className = 'text-red-500 cursor-pointer font-semibold';
            statusEl.innerText = 'Asset Meta ‚úó';
            countEl.innerText = 'not loaded';
            if (epochEl) epochEl.innerText = '';
        }
    }
}

async function loadMetadataFromGitHub() {
    const loadStatusEl = $('meta-load-status');
    if (loadStatusEl) loadStatusEl.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Loading...';
    
    try {
        let resp = await fetch(METADATA_GITHUB_URL + '?t=' + Date.now());
        if (!resp.ok) throw new Error('Failed');
        let data = await resp.json();
        
        // Load meta info (last updated tracking)
        if (data.meta) {
            assetMetadataMeta.last_updated_epoch = data.meta.last_updated_epoch || null;
            assetMetadataMeta.last_updated_date = data.meta.last_updated_date || null;
            console.log('Loaded meta info:', assetMetadataMeta);
        }
        assetMetadataMeta.loaded_from = 'github';
        
        if (data.assets) {
            Object.entries(data.assets).forEach(([asset, meta]) => {
                // v4 format has actual_path
                if (meta.actual_path !== undefined) {
                    assetMetadata[asset] = {
                        tla_name: meta.tla_name || asset,
                        actual_path: meta.actual_path,
                        origin: meta.origin || 'unknown',
                        acquisition: meta.acquisition || 'hard',
                        acquisition_note: meta.acquisition_note || '',
                        cg_status: meta.cg_status || 'cg_none',
                        skip_clear: meta.skip_clear || false,
                        asset_class: meta.asset_class || 'unknown',
                        treasury_value: meta.treasury_value || 'low',
                        multi_dex: meta.multi_dex || false,
                        notes: meta.notes || '',
                        // Edit tracking fields
                        last_edited: meta.last_edited || null,
                        last_edited_epoch: meta.last_edited_epoch || null
                    };
                }
                // Older formats - create with basic info
                else {
                    assetMetadata[asset] = {
                        tla_name: asset,
                        actual_path: asset, // Assume accurate if not specified
                        origin: meta.origin || 'unknown',
                        acquisition: 'hard',
                        acquisition_note: '',
                        cg_status: meta.cg_status || 'cg_none',
                        skip_clear: false,
                        asset_class: meta.asset_class || 'unknown',
                        treasury_value: 'low',
                        multi_dex: false,
                        notes: meta.notes || '',
                        // Edit tracking fields
                        last_edited: meta.last_edited || null,
                        last_edited_epoch: meta.last_edited_epoch || null
                    };
                }
            });
        }
        renderMetaAssetList();
        updateMetaStatus();
        updateMetaLastUpdatedDisplay();
        
        // Update load status
        if (loadStatusEl) {
            loadStatusEl.innerHTML = `<span class="text-green-400">‚úì Loaded ${Object.keys(assetMetadata).length} assets</span>`;
        }
        
        // Update file status indicator
        fileStatus.assetMeta.status = 'green';
        updateStatusDisplay('assetMeta');
        
    } catch (e) {
        console.error('Load error:', e);
        if (loadStatusEl) {
            loadStatusEl.innerHTML = '<span class="text-red-400">‚úó Failed to load</span>';
        }
        alert('Failed to load from GitHub');
    }
}

// Update the Last Updated display in the UI
function updateMetaLastUpdatedDisplay() {
    const epochEl = $('meta-last-epoch');
    const dateEl = $('meta-last-date');
    
    if (epochEl) {
        epochEl.innerText = assetMetadataMeta.last_updated_epoch 
            ? `E${assetMetadataMeta.last_updated_epoch}` 
            : '--';
    }
    if (dateEl) {
        dateEl.innerText = assetMetadataMeta.last_updated_date 
            ? new Date(assetMetadataMeta.last_updated_date).toLocaleDateString() 
            : '--';
    }
}

// Mark metadata as updated this epoch
function markMetadataUpdated() {
    const currentEp = manualMode.active ? manualMode.epoch : (currentEpochInfo?.epoch || store.vote.ep);
    
    if (!currentEp) {
        alert('Cannot determine current epoch. Please load epoch data first.');
        return;
    }
    
    assetMetadataMeta.last_updated_epoch = currentEp;
    assetMetadataMeta.last_updated_date = new Date().toISOString();
    
    updateMetaLastUpdatedDisplay();
    
    // Mark as verified for tab status
    pasteStatus.assetMetaVerified = true;
    updateAllTabStatuses();
    
    alert(`Metadata marked as updated for Epoch ${currentEp}.\n\nRemember to download and upload the JSON to GitHub!`);
}

// Mark metadata as complete (no changes needed)
function markMetadataComplete() {
    pasteStatus.assetMetaVerified = true;
    updateAllTabStatuses();
    
    const extractStatus = $('meta-extract-status');
    if (extractStatus) {
        extractStatus.innerHTML = '<span class="text-green-400">‚úì Complete (no changes)</span>';
    }
}

function downloadMetadata() {
    let assets = {};
    Object.entries(assetMetadata).forEach(([a, m]) => { 
        assets[a] = { 
            ...m, 
            naming_accurate: isNamingAccurate(m),
            access_score: calculateAccessScore(m) 
        }; 
    });
    let data = { 
        version: 4, 
        updated: new Date().toISOString(), 
        score_formula: 'origin + class + cg + treasury + naming(¬±10) + skip(¬±5) + multidex(+5)',
        // Meta tracking info
        meta: {
            last_updated_epoch: assetMetadataMeta.last_updated_epoch,
            last_updated_date: assetMetadataMeta.last_updated_date
        },
        assets 
    };
    let blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    let url = URL.createObjectURL(blob);
    let a = document.createElement('a'); a.href = url; a.download = 'tla_metadata.json'; a.click();
    URL.revokeObjectURL(url);
}

function copyMetadata() {
    let assets = {};
    Object.entries(assetMetadata).forEach(([a, m]) => { 
        assets[a] = { 
            ...m, 
            naming_accurate: isNamingAccurate(m),
            access_score: calculateAccessScore(m) 
        }; 
    });
    let data = { 
        version: 4, 
        updated: new Date().toISOString(), 
        score_formula: 'origin + class + cg + treasury + naming(¬±10) + skip(¬±5) + multidex(+5)',
        // Meta tracking info
        meta: {
            last_updated_epoch: assetMetadataMeta.last_updated_epoch,
            last_updated_date: assetMetadataMeta.last_updated_date
        },
        assets 
    };
    navigator.clipboard.writeText(JSON.stringify(data, null, 2)).then(() => alert('Copied!'));
}

function getPoolAccessScore(poolName) {
    let parts = poolName.split('-');
    if (parts.length < 2) return 50;
    let s1 = assetMetadata[parts[0]] ? calculateAccessScore(assetMetadata[parts[0]]) : 30;
    let s2 = assetMetadata[parts[1]] ? calculateAccessScore(assetMetadata[parts[1]]) : 30;
    return Math.min(s1, s2);
}


// ============ ADAO STRATEGY ============

function toggleStrategyPanel() {
    let panel = $('strategy-panel');
    let toggle = $('strategy-toggle');
    if (panel.classList.contains('hidden')) {
        panel.classList.remove('hidden');
        toggle.innerText = '‚ñ≤';
    } else {
        panel.classList.add('hidden');
        toggle.innerText = '‚ñº';
    }
}

function generateStrategy() {
    if (store.vote.pools.length === 0) {
        alert('Please parse Vote data first');
        return;
    }
    
    calculateAllScores();
    generateVoteOptimization();
    generateBribeCandidates();
    generateActivationTargets();
}

function generateVoteOptimization() {
    let html = '';
    
    BUCKET_ORDER.forEach(bucket => {
        let pools = store.vote.pools.filter(p => p.b === bucket && p.vps >= 1); // Active only for vote allocation
        if (pools.length === 0) return;
        
        // Sort by aDAO score (highest first)
        pools.sort((a, b) => (b.adaoScore || 0) - (a.adaoScore || 0));
        
        // Calculate recommended allocation in 10% chunks
        let totalChunks = 10; // 100% = 10 chunks of 10%
        let allocations = [];
        let remainingChunks = totalChunks;
        
        pools.forEach((p, idx) => {
            if (remainingChunks <= 0) {
                allocations.push({ pool: p, recommended: 0 });
                return;
            }
            
            let chunks = 0;
            if (p.adaoScore >= 30) {
                chunks = Math.min(4, remainingChunks); // Max 40% for top scorers
            } else if (p.adaoScore >= 10) {
                chunks = Math.min(3, remainingChunks); // Max 30%
            } else if (p.adaoScore >= 0) {
                chunks = Math.min(2, remainingChunks); // Max 20%
            } else if (p.adaoScore >= -20) {
                chunks = Math.min(1, remainingChunks); // Max 10%
            }
            // Negative scores below -20 get 0
            
            remainingChunks -= chunks;
            allocations.push({ pool: p, recommended: chunks * 10 });
        });
        
        // Distribute any remaining chunks to top pools
        let i = 0;
        while (remainingChunks > 0 && allocations.length > 0) {
            if (allocations[i].recommended < 50) { // Cap at 50%
                allocations[i].recommended += 10;
                remainingChunks--;
            }
            i = (i + 1) % allocations.length;
            if (i === 0 && allocations.every(a => a.recommended >= 50)) break;
        }
        
        // Build HTML
        html += `<div class="border-b border-gray-700 pb-2 mb-2">
            <div class="text-[10px] font-bold text-gray-400 uppercase mb-2">${bucket}</div>
            <div class="grid grid-cols-5 gap-1 text-[9px] text-gray-500 mb-1 px-1">
                <div class="col-span-2">Pool</div>
                <div class="text-right">Score</div>
                <div class="text-right">Now</div>
                <div class="text-right">Rec</div>
            </div>`;
        
        allocations.filter(a => a.recommended > 0 || a.pool.ms > 0).forEach(a => {
            let p = a.pool;
            let current = p.ms || 0;
            let diff = a.recommended - current;
            let diffColor = diff > 0 ? 'text-green-400' : diff < 0 ? 'text-red-400' : 'text-gray-500';
            let diffStr = diff > 0 ? `+${diff.toFixed(0)}%` : diff < 0 ? `${diff.toFixed(0)}%` : '-';
            
            html += `<div class="grid grid-cols-5 gap-1 px-1 py-0.5 hover:bg-gray-800/50 rounded">
                <div class="col-span-2 truncate text-white">${p.n}</div>
                <div class="text-right ${getScoreColor(p.adaoScore)}">${p.adaoScore?.toFixed(0) || 0}</div>
                <div class="text-right text-cyan-400">${current.toFixed(0)}%</div>
                <div class="text-right font-bold ${diffColor}">${a.recommended}%</div>
            </div>`;
        });
        
        html += `</div>`;
    });
    
    setHtml('vote-optimization', html);
}

function generateBribeCandidates() {
    let html = '';
    let candidates = [];
    
    BUCKET_ORDER.forEach(bucket => {
        // Include both active AND inactive pools for bribe consideration
        let pools = store.vote.pools.filter(p => p.b === bucket);
        if (pools.length === 0) return;
        
        // Score for bribe worthiness:
        // - High aDAO score
        // - Native Terra bonus
        // - Currently low bribes
        // - Minimum liquidity ($25K+)
        pools.forEach(p => {
            let bribeScore = (p.adaoScore || 0);
            
            // Native Terra bonus (+15)
            let isNative = p.n.match(/ROAR|CAPA|SOLID|ASTRO|FUEL/i);
            if (isNative) bribeScore += 15;
            
            // Low current bribes bonus (+10 if <$10)
            if (p.incPD < 10) bribeScore += 10;
            
            // Penalize if already getting lots of bribes
            if (p.incPD > 50) bribeScore -= 20;
            
            // Minimum liquidity check
            let liq = p.liq4Ep?.avg || p.dp || 0;
            if (liq < 25000) bribeScore -= 50; // Heavy penalty for tiny pools
            
            p.bribeScore = bribeScore;
            p.isNative = isNative;
        });
        
        // Sort by bribe score and pick top
        pools.sort((a, b) => (b.bribeScore || 0) - (a.bribeScore || 0));
        let best = pools[0];
        
        if (best) {
            let statusBadge = best.vps < 1 ? '<span class="text-red-400 text-[9px]">INACT</span>' : '';
            let nativeBadge = best.isNative ? '<span class="text-orange-400">üè†</span>' : '';
            
            candidates.push({ bucket, pool: best });
            
            html += `<div class="flex justify-between items-center py-1 px-2 bg-gray-800/50 rounded">
                <div>
                    <span class="text-gray-500 text-[10px] w-20 inline-block">${bucket}:</span>
                    <span class="text-white font-bold">${best.n}</span>
                    ${nativeBadge} ${statusBadge}
                </div>
                <div class="text-right">
                    <span class="${getScoreColor(best.adaoScore)}">${best.adaoScore?.toFixed(0) || 0}</span>
                </div>
            </div>`;
        }
    });
    
    // Store for copy function
    window.bribeCandidates = candidates;
    
    setHtml('bribe-candidates', html);
}

function generateActivationTargets() {
    let html = '';
    
    // Find inactive pools (< 1% votes) that have good potential
    let inactivePools = store.vote.pools.filter(p => p.vps < 1);
    
    if (inactivePools.length === 0) {
        html = '<div class="text-gray-500 italic">No inactive pools found</div>';
        setHtml('activation-targets', html);
        return;
    }
    
    // Score them by potential
    inactivePools.forEach(p => {
        let activationScore = 0;
        
        // Access score matters (good assets, good bridge, LUNA benefit)
        activationScore += (p.accessScore || 0) * 0.4;
        
        // Native Terra bonus
        if (p.n.match(/ROAR|CAPA|SOLID|ASTRO|FUEL/i)) activationScore += 20;
        
        // Has some liquidity (not dead)
        let liq = p.liq4Ep?.avg || p.dp || 0;
        if (liq > 50000) activationScore += 15;
        else if (liq > 25000) activationScore += 10;
        else if (liq > 10000) activationScore += 5;
        
        // Has some volume (people actually trade)
        let vol = p.vol4Ep?.avg || p.vol || 0;
        if (vol > 10000) activationScore += 15;
        else if (vol > 5000) activationScore += 10;
        
        // Low APR = needs help
        if (p.aprNon && p.aprNon < 40) activationScore += 10;
        
        p.activationScore = activationScore;
    });
    
    // Sort and take top 5
    inactivePools.sort((a, b) => (b.activationScore || 0) - (a.activationScore || 0));
    let topTargets = inactivePools.slice(0, 5);
    
    topTargets.forEach(p => {
        let liq = p.liq4Ep?.avg || p.dp || 0;
        let nativeBadge = p.n.match(/ROAR|CAPA|SOLID|ASTRO|FUEL/i) ? '<span class="text-orange-400">üè†</span>' : '';
        
        html += `<div class="flex justify-between items-center py-1 px-2 bg-gray-800/30 rounded">
            <div class="flex items-center gap-2">
                <span class="text-white font-bold">${p.n}</span>
                ${nativeBadge}
                <span class="text-[9px] text-gray-500">${p.d.includes('Single') ? 'Single' : isAstroport(p.d) ? 'Astro' : 'SS'}</span>
            </div>
            <div class="text-right text-[10px]">
                <span class="text-teal-400">${fmt$(liq)}</span>
                <span class="text-gray-500 mx-1">|</span>
                <span class="text-cyan-400">${p.accessScore?.toFixed(0) || '?'} acc</span>
            </div>
        </div>`;
    });
    
    setHtml('activation-targets', html);
}

function copyVoteStrategy() {
    let text = 'aDAO VOTE OPTIMIZATION\n';
    text += '='.repeat(40) + '\n\n';
    
    BUCKET_ORDER.forEach(bucket => {
        let pools = store.vote.pools.filter(p => p.b === bucket && p.vps >= 1);
        if (pools.length === 0) return;
        
        pools.sort((a, b) => (b.adaoScore || 0) - (a.adaoScore || 0));
        
        text += `${bucket}\n`;
        text += '-'.repeat(20) + '\n';
        
        pools.filter(p => (p.adaoScore || 0) > -20).slice(0, 5).forEach(p => {
            text += `${p.n}: Score ${p.adaoScore?.toFixed(0) || 0}\n`;
        });
        text += '\n';
    });
    
    navigator.clipboard.writeText(text).then(() => {
        alert('Vote strategy copied!');
    });
}

function copyBribeCandidates() {
    if (!window.bribeCandidates || window.bribeCandidates.length === 0) {
        alert('Generate strategy first');
        return;
    }
    
    let text = 'aDAO BRIBE ALLOCATION PROPOSAL\n';
    text += '='.repeat(40) + '\n\n';
    text += 'Vote for ONE pool to receive aDAO-sponsored bribes:\n\n';
    
    window.bribeCandidates.forEach(c => {
        let native = c.pool.isNative ? ' üè†' : '';
        text += `‚ñ° ${c.bucket}: ${c.pool.n}${native}\n`;
    });
    
    text += '\n[Bribes distributed over 4 epochs]\n';
    
    navigator.clipboard.writeText(text).then(() => {
        alert('Bribe proposal copied!');
    });
}

function findCurrentEpoch() {
    const now = new Date();
    
    // Find which epoch we're currently in
    for (let ep of epochData) {
        let start = new Date(ep.start_time);
        let end = new Date(ep.end_time);
        
        if (now >= start && now < end) {
            currentEpochInfo = ep;
            store.vote.ep = ep.epoch;
            
            // Set the epoch input field
            if ($('historyEpoch')) {
                $('historyEpoch').value = ep.epoch;
            }
            return;
        }
    }
    
    // If we're past all epochs in the file, use the last one
    if (epochData.length > 0) {
        currentEpochInfo = epochData[epochData.length - 1];
        store.vote.ep = currentEpochInfo.epoch;
        if ($('historyEpoch')) {
            $('historyEpoch').value = currentEpochInfo.epoch;
        }
    }
}

function updateTimers() {
    const now = new Date();
    
    if (currentEpochInfo) {
        // Display current epoch - respect manual mode styling
        if (manualMode.active) {
            setTxt('live-epoch', `Epoch ${manualMode.epoch}`);
            $('live-epoch').className = 'text-xs bg-yellow-900/50 text-yellow-400 px-2 py-0.5 rounded border border-yellow-700 font-mono ml-2';
            
            // Show manual phase instead of calculated
            const phaseEl = $('epoch-phase');
            if (phaseEl) {
                phaseEl.innerText = manualMode.phase.charAt(0).toUpperCase() + manualMode.phase.slice(1) + ' (Manual)';
                phaseEl.className = 'text-yellow-400 font-bold ml-1';
            }
        } else {
            setTxt('live-epoch', `Epoch ${currentEpochInfo.epoch}`);
            $('live-epoch').className = 'text-xs bg-gray-800 text-white px-2 py-0.5 rounded border border-gray-700 font-mono ml-2';
            
            // Calculate phase based on days REMAINING until epoch ends:
            // 5-7 days remaining = 0-2 days into epoch = START
            // 2-5 days remaining = 2-5 days into epoch = MID  
            // 0-2 days remaining = 5-7 days into epoch = END
            const endTime = new Date(currentEpochInfo.end_time);
            const msUntilEnd = endTime - now;
            const daysLeft = msUntilEnd / 86400000;
            
            let phase = 'End';
            let phaseColor = 'text-red-400';
            if (daysLeft >= 5) {
                phase = 'Start';
                phaseColor = 'text-green-400';
            } else if (daysLeft > 2) {
                phase = 'Mid';
                phaseColor = 'text-yellow-400';
            }
            const phaseEl = $('epoch-phase');
            if (phaseEl) {
                phaseEl.innerText = phase;
                phaseEl.className = phaseColor + ' font-bold ml-1';
            }
        }
        
        // Calculate time until epoch ends (use original epoch info for timers)
        const realEpochInfo = manualMode.originalEpochInfo || currentEpochInfo;
        const endTime = new Date(realEpochInfo.end_time);
        const msUntilEnd = endTime - now;
        
        setTxt('epoch-timer', formatTimeDiff(msUntilEnd));
        
        // Calculate time until rewards update
        const rewardsTime = new Date(realEpochInfo.rewards_update);
        const msUntilRewards = rewardsTime - now;
        
        if (msUntilRewards > 0) {
            setTxt('reward-timer', formatTimeDiff(msUntilRewards));
        } else {
            setTxt('reward-timer', 'Updated ‚úì');
        }
        
        // Check if epoch ended and we need to refresh (only in normal mode)
        if (!manualMode.active && msUntilEnd <= 0) {
            findCurrentEpoch(); // Move to next epoch
        }
    } else {
        setTxt('live-epoch', 'Epoch ...');
        setTxt('epoch-timer', 'Loading...');
        setTxt('epoch-phase', '...');
        setTxt('reward-timer', 'Loading...');
    }
}

function formatTimeDiff(ms) {
    if (ms < 0) return "0d 0h 0m";
    let d = Math.floor(ms / 86400000);
    let h = Math.floor((ms % 86400000) / 3600000);
    let m = Math.floor((ms % 3600000) / 60000);
    return `${d}d ${h}h ${m}m`;
}

// === SESSION MANAGER ===
async function findLatestSnapshot() {
    const msg = $('load-msg');
    if (msg) msg.innerText = "Searching for latest snapshot...";
    
    // Start from current epoch (from epoch file) or fallback
    let startEp = currentEpochInfo ? currentEpochInfo.epoch : 165;
    const phases = ["end", "mid", "start"];
    const base = "https://raw.githubusercontent.com/defipatriot/tla_json_storage/main/tla-data-epoch";
    
    // Check up to 10 epochs back - try production first, then test
    for (let ep = startEp; ep >= startEp - 10; ep--) {
        for (let ph of phases) {
            // Try production file
            try {
                let res = await fetch(`${base}-${ep}-${ph}.json`, { method: 'HEAD' });
                if (res.ok) {
                    $('historyEpoch').value = ep;
                    $('historyPhase').value = ph;
                    updateGithubLink();
                    if (msg) {
                        msg.innerText = `Found: Epoch ${ep} (${ph})`;
                        msg.className = "text-[10px] text-green-400 font-bold";
                    }
                    return { epoch: ep, phase: ph };
                }
            } catch(err) {}
            
            // Try test file
            try {
                let res = await fetch(`${base}-${ep}-${ph}_test.json`, { method: 'HEAD' });
                if (res.ok) {
                    $('historyEpoch').value = ep;
                    $('historyPhase').value = ph;
                    updateGithubLink();
                    if (msg) {
                        msg.innerText = `Found: Epoch ${ep} (${ph}) üß™ TEST`;
                        msg.className = "text-[10px] text-yellow-400 font-bold";
                    }
                    return { epoch: ep, phase: ph, isTest: true };
                }
            } catch(err) {}
        }
    }
    
    if (msg) {
        msg.innerText = "No snapshots found";
        msg.className = "text-[10px] text-red-400 font-bold";
    }
    return null;
}

function checkExtData() {
    // TODO: Check if ext data file exists
}

function updateGithubLink() {
    const ep = $('historyEpoch')?.value || '';
    const ph = $('historyPhase')?.value?.toLowerCase() || 'end';
    const fileName = `tla-data-epoch-${ep}-${ph}.json`;
    const linkEl = $('github-link');
    if (linkEl) {
        linkEl.innerHTML = `<i class="fab fa-github"></i> ${fileName}`;
        linkEl.href = `https://github.com/defipatriot/tla_json_storage/blob/main/${fileName}`;
    }
}

async function fetchCoreData() {
    let ep = $('historyEpoch').value;
    let ph = $('historyPhase').value;
    
    // Try production file first, then test file
    let url = `https://raw.githubusercontent.com/defipatriot/tla_json_storage/main/tla-data-epoch-${ep}-${ph}.json`;
    let isTestFile = false;
    
    try {
        let res = await fetch(url + '?t=' + Date.now());
        if (!res.ok) {
            // Try test file
            url = `https://raw.githubusercontent.com/defipatriot/tla_json_storage/main/tla-data-epoch-${ep}-${ph}_test.json`;
            res = await fetch(url + '?t=' + Date.now());
            if (!res.ok) throw new Error("File not found (tried both production and _test)");
            isTestFile = true;
        }
        let d = await res.json();
        
        // Check version
        const version = d.meta?.version || "1.0";
        console.log(`Loading snapshot: E${ep}-${ph}, version ${version}${isTestFile ? ' (TEST)' : ''}`);
        
        if (version === "3.0") {
            // === NEW FORMAT (v3.0) ===
            await loadV3Snapshot(d, ep, ph, isTestFile);
            
        } else if (version === "2.0") {
            // === V2.0 FORMAT ===
            await loadV2Snapshot(d, ep, ph);
            
        } else {
            // === OLD FORMAT (v1) ===
            loadV1Snapshot(d, ep, ph);
        }
        
    } catch(e) {
        console.error('Load error:', e);
        alert("‚ùå Could not load: " + e.message);
    }
}

// Load v3.0 snapshot format
async function loadV3Snapshot(d, ep, ph, isTestFile) {
    // Vote summary
    store.vote.ep = d.vote.summary.epoch;
    store.vote.end = d.vote.summary.end_time || 'Loaded from file';
    store.vote.tvp = d.vote.summary.total_vp;
    store.vote.reb = d.vote.summary.rebase_amp || 0;
    store.vote.usd = d.vote.summary.rewards_usd || 0;
    
    // Vote pools
    store.vote.pools = (d.vote.pools || []).map(p => ({
        n: p.name,
        d: normalizeDexName(p.dex),
        dRaw: p.dex_raw || p.dex,
        b: p.bucket || "UNKNOWN",
        act: p.is_active !== false,
        tvp: p.vp || 0,
        dp: p.depth || 0,
        mvp: p.adao_vp || 0,
        vps: p.vote_pct || 0,
        ms: p.adao_pct || 0,
        inc: p.bribes?.total || 0,
        incTotal: p.bribes?.total || 0,
        incPD: p.bribes?.pd || 0,
        incOther: p.bribes?.other || 0,
        aprNon: p.apr_non || 0,
        aprAmp: p.apr_amp || 0,
        aprFactor: p.apr_factor || 0,
        votNowVp: p.votion?.current_vp || 0,
        votNowPct: p.votion?.current_pct || 0,
        votNextVp: p.votion?.next_vp || 0,
        votNextPct: p.votion?.next_pct || 0,
        liq4Ep: p.historical?.liq_4ep_avg > 0 ? { avg: p.historical.liq_4ep_avg, count: p.historical.liq_4ep_count || 4 } : null,
        vol4Ep: p.historical?.vol_4ep_avg > 0 ? { avg: p.historical.vol_4ep_avg, count: p.historical.vol_4ep_count || 4 } : null,
        efficiency: p.historical?.efficiency || 0,
        // Load scores directly from file
        accessScore: p.scores?.access || 0,
        performanceScore: p.scores?.performance || 0,
        supportScore: p.scores?.support || 0,
        adaoScore: p.scores?.adao_opportunity || 0,
        incGrade: p.included_in_grade !== false
    }));
    
    // Liquidity data
    if (d.liquidity) {
        store.tla.tvl = d.liquidity.summary?.tvl || 0;
        store.tla.rewYr = d.liquidity.summary?.rewards_per_year || 0;
        store.tla.rewEp = d.liquidity.summary?.rewards_per_epoch || 0;
        
        if (d.liquidity.active_pools) {
            store.tla.pools = d.liquidity.active_pools.map(p => ({
                name: p.name,
                normName: p.normalized_name || p.name,
                dex: p.dex,
                type: p.type,
                bucket: p.bucket,
                depth: p.depth || 0,
                stk: p.tla_staked || 0,
                aprNon: p.apr?.non_amp || p.apr_non_amp || 0,
                aprAmp: p.apr?.amplified || p.apr_amplified || 0,
                rYr: p.rewards_per_year || 0,
                adaoNon: p.adao_deposit?.non_amp || 0,
                adaoAmp: p.adao_deposit?.amplified || 0
            }));
        }
        
        if (d.liquidity.inactive_pools) {
            store.tla.inactivePools = d.liquidity.inactive_pools.map(p => ({
                name: p.name,
                normName: p.normalized_name || p.name,
                dex: p.dex,
                type: p.type,
                bucket: p.bucket,
                depth: p.depth || 0,
                stk: p.tla_staked || 0
            }));
        }
        
        // aDAO deposits
        if (d.liquidity.adao_deposits) {
            store.dao.dep = d.liquidity.adao_deposits.total_usd || 0;
            store.dao.apr = d.liquidity.adao_deposits.avg_apr || 0;
            store.dao.toks = (d.liquidity.adao_deposits.tokens || []).map(t => ({
                s: t.symbol,
                a: t.amount
            }));
        }
        
        // Unclaimed rewards
        if (d.liquidity.unclaimed_rewards) {
            store.dao.rew = {
                usd: d.liquidity.unclaimed_rewards.total_usd || 0,
                z: d.liquidity.unclaimed_rewards.zAssets || 0,
                amp: d.liquidity.unclaimed_rewards.ampLUNA || 0
            };
        }
        
        // Vote rewards - from liquidity section
        if (d.liquidity.vote_rewards) {
            store.dao.vRew = d.liquidity.vote_rewards.by_token || {};
            store.dao.vRewPeriods = d.liquidity.vote_rewards.periods || [];
        }
    }
    
    // Locks data
    if (d.locks) {
        store.dao.lVp = d.locks.summary?.total_vp || 0;
        store.dao.lFac = d.locks.summary?.power_factor || 0;
        store.dao.lAst = d.locks.summary?.underlying_assets || 0;
        
        if (d.locks.individual_locks) {
            store.dao.locks = d.locks.individual_locks.map(l => ({
                id: l.id,
                amt: l.amount,
                asset: l.asset || 'LUNA',
                bucket: l.bucket,
                vp: l.vp,
                usd: l.usd,
                status: l.status || 'Unknown'
            }));
        }
        
        if (d.locks.allocations) {
            store.dao.allocs = d.locks.allocations;
        }
    }
    
    // Dashboard data
    if (d.dashboard) {
        store.dashboard.treasuryTokens = (d.dashboard.treasury?.tokens || []).map(t => ({
            token: t.token || t.symbol,
            amount: t.amount,
            price: t.price || 0,
            usd: t.usd || 0
        }));
        store.dashboard.treasuryUsd = d.dashboard.treasury?.total_usd || 0;
        
        // TLA position - override with dashboard data if present
        if (d.dashboard.tla_deposits) {
            store.dao.dep = d.dashboard.tla_deposits.total_usd || store.dao.dep;
            store.dao.lVp = d.dashboard.tla_deposits.vp || store.dao.lVp;
            store.dao.apr = d.dashboard.tla_deposits.apr || store.dao.apr;
        }
        
        // Unclaimed rewards - override if present
        if (d.dashboard.unclaimed_rewards) {
            store.dao.rew = {
                usd: d.dashboard.unclaimed_rewards.deposit_rewards_usd || store.dao.rew?.usd || 0,
                z: d.dashboard.unclaimed_rewards.zAssets || store.dao.rew?.z || 0,
                amp: d.dashboard.unclaimed_rewards.ampLUNA || store.dao.rew?.amp || 0
            };
        }
        
        // Vote rewards - override if present
        if (d.dashboard.vote_rewards?.by_token) {
            store.dao.vRew = {};
            Object.entries(d.dashboard.vote_rewards.by_token).forEach(([token, data]) => {
                store.dao.vRew[token] = typeof data === 'object' ? data.amount : data;
            });
            store.dao.vRewPeriods = d.dashboard.vote_rewards.periods || store.dao.vRewPeriods || [];
        }
        
        // NFT backing
        if (d.dashboard.nft_backing_per_nft) {
            store.dashboard.backingAmpLuna = d.dashboard.nft_backing_per_nft.ampLUNA || 0;
            store.dashboard.backingLuna = d.dashboard.nft_backing_per_nft.LUNA_equivalent || 0;
            store.dashboard.backingUsd = d.dashboard.nft_backing_per_nft.USD || 0;
        }
        
        // Unminted backing
        if (d.dashboard.unminted_backing) {
            store.dashboard.unmintedCount = d.dashboard.unminted_backing.count || 0;
            store.dashboard.unmintedBackingAmp = d.dashboard.unminted_backing.total_ampLUNA || 0;
            store.dashboard.unmintedBackingLuna = d.dashboard.unminted_backing.total_LUNA_equivalent || 0;
            store.dashboard.unmintedBackingUsd = d.dashboard.unminted_backing.total_USD || 0;
        }
    }
    
    // NFT Stats
    if (d.nft_stats) {
        store.nftStats.brokenCount = d.nft_stats.collection?.broken_count || 0;
        store.nftStats.unbrokenCount = d.nft_stats.collection?.unbroken_count || 0;
        store.nftStats.mintedCount = d.nft_stats.collection?.minted_count || 0;
        store.nftStats.unmintedCount = d.nft_stats.collection?.unminted_count || 0;
        
        store.nftStats.daodaoStaked = d.nft_stats.staking?.daodao_staked || 0;
        store.nftStats.daodaoStakedPct = d.nft_stats.staking?.daodao_staked_pct || 0;
        store.nftStats.enterpriseStaked = d.nft_stats.staking?.enterprise_staked || 0;
        store.nftStats.daoMembers = d.nft_stats.staking?.dao_members || 0;
        store.nftStats.daoBrokenHeld = d.nft_stats.staking?.dao_broken_held || 0;
        
        store.nftStats.circulatingSupply = d.nft_stats.supply?.circulating || 0;
        store.nftStats.liquidSupply = d.nft_stats.supply?.liquid || 0;
        
        // Backing per NFT
        if (d.nft_stats.backing_per_nft) {
            store.nftStats.backingAmpLuna = d.nft_stats.backing_per_nft.ampLUNA || 0;
            store.nftStats.backingLuna = d.nft_stats.backing_per_nft.LUNA_equivalent || 0;
            store.nftStats.backingUsd = d.nft_stats.backing_per_nft.USD || 0;
        }
        
        // BBL marketplace
        if (d.nft_stats.marketplaces?.bbl) {
            const bbl = d.nft_stats.marketplaces.bbl;
            store.nftStats.bblFloor = bbl.floor_price || { unbroken: null, broken: null };
            store.nftStats.bblVolume = bbl.total_volume || { amount: 0, token: 'bLUNA', usd: 0 };
            store.nftStats.bblSales = bbl.epoch_sales || [];
            store.nftStats.bblListingItems = bbl.listings?.items || [];
            store.nftStats.bblListingsBroken = bbl.listings?.broken || 0;
            store.nftStats.bblListingsUnbroken = bbl.listings?.unbroken || 0;
            store.nftStats.bblListingsTotal = bbl.listings?.total || 0;
        }
        
        // Boost marketplace
        if (d.nft_stats.marketplaces?.boost) {
            const boost = d.nft_stats.marketplaces.boost;
            store.nftStats.boostFloor = boost.floor_price || { unbroken: null, broken: null };
            store.nftStats.boostVolume = boost.total_volume; // null for N/A
            store.nftStats.boostSales = boost.epoch_sales || [];
            store.nftStats.boostListingItems = boost.listings?.items || [];
            store.nftStats.boostListingsBroken = boost.listings?.broken || 0;
            store.nftStats.boostListingsUnbroken = boost.listings?.unbroken || 0;
            store.nftStats.boostListingsTotal = boost.listings?.total || 0;
        }
    }
    
    // Token prices
    if (d.token_prices) {
        store.extFile = store.extFile || {};
        store.extFile.tokenPrices = d.token_prices;
    }
    
    // Asset metadata
    if (d.asset_metadata?.assets) {
        Object.entries(d.asset_metadata.assets).forEach(([asset, meta]) => {
            assetMetadata[asset] = meta;
        });
    }
    
    // Mark as loaded
    store.ext.loaded = true;
    store.ext.source = 'v3_snapshot';
    
    // Mark that scores are pre-calculated from file (don't recalculate)
    store.scoresFromFile = true;
    
    // Set paste status flags so score display works
    pasteStatus.vote = true;
    pasteStatus.liqActive = true;
    pasteStatus.liqDep = true;
    pasteStatus.locks = true;
    pasteStatus.assetMetaVerified = Object.keys(assetMetadata).length > 0;
    
    // Load ext historical data to fill in 4EP data if missing
    // This fetches tla_ext_historical.json which has monthly liq/vol averages
    await load4EpDataForV3();
    
    // Update UI
    updatePasteStatus('ps-vote', true, 'v3.0');
    updatePasteStatus('ps-liq-active', true, 'v3.0');
    updatePasteStatus('ps-locks', true, 'v3.0');
    renderVoteTable();
    renderLocks();
    renderLiquidityTable();
    updateDaoUIFromLoad();
    
    // Update TLA Global display
    setTxt('tla-tvl', '$' + (store.tla.tvl || 0).toLocaleString());
    setTxt('tla-rew-yr', '$' + (store.tla.rewYr || 0).toLocaleString());
    setTxt('tla-rew-ep', '$' + (store.tla.rewEp || 0).toLocaleString(undefined, {maximumFractionDigits: 0}));
    
    // Populate Dashboard tab
    populateDashboardFromStore();
    
    // Populate NFT Stats tab
    populateNftStatsFromStore();
    
    // Reset flag after rendering
    store.scoresFromFile = false;
    
    alert(`‚úÖ Loaded Epoch ${ep} (${ph}) - v3.0 format${isTestFile ? ' (TEST FILE)' : ''}\n\n` +
          `üìä ${d.vote.pools?.length || 0} pools\n` +
          `üîí ${d.locks?.individual_locks?.length || 0} locks\n` +
          `üíß ${d.liquidity?.active_pools?.length || 0} TLA pools\n` +
          `üè∑Ô∏è ${Object.keys(d.asset_metadata?.assets || {}).length} asset metadata\n` +
          `üí∞ Treasury: $${(d.dashboard?.treasury?.total_usd || 0).toLocaleString()}\n` +
          `üé® NFT Stats loaded`);
}

// Populate Dashboard UI from store
function populateDashboardFromStore() {
    // Treasury
    dashboardTreasuryTokens = store.dashboard.treasuryTokens || [];
    renderTreasuryTokens();
    
    // TLA Position - call the load function
    loadDashboardFromTool();
    
    // NFT Backing
    if (store.dashboard.backingAmpLuna) {
        if ($('dash-back-amp')) $('dash-back-amp').value = store.dashboard.backingAmpLuna;
        updateDashBacking();
    }
    
    // Unminted - load from store values
    if (store.dashboard.unmintedCount) {
        if ($('dash-unminted-count')) $('dash-unminted-count').value = store.dashboard.unmintedCount;
        // Display the calculated values
        setTxt('dash-unminted-amp', (store.dashboard.unmintedBackingAmp || 0).toLocaleString(undefined, {maximumFractionDigits: 4}));
        setTxt('dash-unminted-luna', (store.dashboard.unmintedBackingLuna || 0).toLocaleString(undefined, {maximumFractionDigits: 4}));
        setTxt('dash-unminted-usd', '$' + (store.dashboard.unmintedBackingUsd || 0).toLocaleString(undefined, {maximumFractionDigits: 2}));
    }
    
    // Update status
    const status = $('dashboard-status');
    if (status) {
        status.textContent = 'Loaded';
        status.className = 'px-3 py-1 rounded text-[10px] font-bold bg-green-900/50 text-green-400';
    }
}

// Populate NFT Stats UI from store
function populateNftStatsFromStore() {
    // Collection
    if ($('nft-broken-input')) $('nft-broken-input').value = store.nftStats.brokenCount || '';
    if ($('nft-minted-input')) $('nft-minted-input').value = store.nftStats.mintedCount || '';
    updateNftCalcs();
    
    // Staking
    if ($('nft-daodao-input')) $('nft-daodao-input').value = store.nftStats.daodaoStaked || '';
    if ($('nft-daodao-pct-input')) $('nft-daodao-pct-input').value = store.nftStats.daodaoStakedPct || '';
    if ($('nft-enterprise-input')) $('nft-enterprise-input').value = store.nftStats.enterpriseStaked || '';
    if ($('nft-members-input')) $('nft-members-input').value = store.nftStats.daoMembers || '';
    if ($('nft-dao-broken-input')) $('nft-dao-broken-input').value = store.nftStats.daoBrokenHeld || '';
    
    // Supply
    if ($('nft-circ-input')) $('nft-circ-input').value = store.nftStats.circulatingSupply || '';
    if ($('nft-liquid-input')) $('nft-liquid-input').value = store.nftStats.liquidSupply || '';
    
    // Backing
    if ($('nft-back-amp-input')) {
        $('nft-back-amp-input').value = store.nftStats.backingAmpLuna || '';
        updateNftBacking();
    }
    
    // BBL Floor
    if (store.nftStats.bblFloor?.unbroken) {
        if ($('nft-bbl-floor-unbroken-amt')) $('nft-bbl-floor-unbroken-amt').value = store.nftStats.bblFloor.unbroken.amount || '';
        if ($('nft-bbl-floor-unbroken-token')) $('nft-bbl-floor-unbroken-token').value = store.nftStats.bblFloor.unbroken.token || 'bLUNA';
    }
    if (store.nftStats.bblFloor?.broken) {
        if ($('nft-bbl-floor-broken-amt')) $('nft-bbl-floor-broken-amt').value = store.nftStats.bblFloor.broken.amount || '';
        if ($('nft-bbl-floor-broken-token')) $('nft-bbl-floor-broken-token').value = store.nftStats.bblFloor.broken.token || 'bLUNA';
    }
    
    // BBL Volume
    if (store.nftStats.bblVolume?.amount) {
        if ($('nft-bbl-volume')) $('nft-bbl-volume').value = store.nftStats.bblVolume.amount || '';
    }
    
    // Update BBL floor/volume USD displays
    updateBblFloorUsd();
    
    // Boost Floor
    if (store.nftStats.boostFloor?.unbroken) {
        if ($('nft-boost-floor-unbroken-amt')) $('nft-boost-floor-unbroken-amt').value = store.nftStats.boostFloor.unbroken.amount || '';
        if ($('nft-boost-floor-unbroken-token')) $('nft-boost-floor-unbroken-token').value = store.nftStats.boostFloor.unbroken.token || 'LUNA';
    }
    if (store.nftStats.boostFloor?.broken) {
        if ($('nft-boost-floor-broken-amt')) $('nft-boost-floor-broken-amt').value = store.nftStats.boostFloor.broken.amount || '';
        if ($('nft-boost-floor-broken-token')) $('nft-boost-floor-broken-token').value = store.nftStats.boostFloor.broken.token || 'USDC';
    }
    
    // Update Boost floor USD displays
    updateBoostFloorUsd();
    
    // Render listings and sales
    renderBblListings();
    renderBblSales();
    renderBoostListings();
    renderBoostSales();
    
    // Update status
    const status = $('nft-status');
    if (status) {
        status.textContent = 'Loaded';
        status.className = 'px-3 py-1 rounded text-[10px] font-bold bg-green-900/50 text-green-400';
    }
}

// Load v2.0 snapshot format (existing code refactored)
async function loadV2Snapshot(d, ep, ph) {
            store.vote.ep = d.vote.epoch;
            store.vote.end = d.vote.end_time || 'Loaded from file';
            store.vote.tvp = d.vote.tvp;
            store.vote.reb = d.vote.rebase || 0;
            store.vote.usd = d.vote.rewards_usd || 0;
            
            store.vote.pools = (d.pools || []).map(p => ({
                n: p.name,
                // Normalize DEX names when loading (handles White Whale -> Skeleton Swap, etc.)
                d: normalizeDexName(p.dex),
                b: p.bucket || "UNKNOWN",
                tvp: p.vp || 0,
                dp: p.depth || 0,
                mvp: p.adao_vp || 0,
                vps: p.vote_pct || 0,
                ms: p.adao_pct || 0,
                inc: p.bribes_total || 0,
                incTotal: p.bribes_total || 0,
                incPD: p.bribes_pd || 0,
                incOther: p.bribes_other || 0,
                aprNon: p.apr_non || 0,
                aprAmp: p.apr_amp || 0,
                aprFactor: p.apr_factor || 0,
                votNowVp: p.votion_now_vp || 0,
                votNowPct: p.votion_now_pct || 0,
                votNextVp: p.votion_next_vp || 0,
                votNextPct: p.votion_next_pct || 0,
                liq4Ep: p.liq_4ep_avg > 0 ? { avg: p.liq_4ep_avg, count: p.liq_4ep_count || 4 } : null,
                vol4Ep: p.vol_4ep_avg > 0 ? { avg: p.vol_4ep_avg, count: p.vol_4ep_count || 4 } : null,
                efficiency: p.efficiency || 0,
                // DON'T load scores from file - will be recalculated with current metadata
                // Old file values preserved for reference:
                _oldAccessScore: p.access_score || 0,
                _oldAdaoScore: p.adao_score || 0,
                // These are still valid from file (don't depend on access score):
                performanceScore: null, // Will be recalculated
                supportScore: p.support_score || 0  // Support doesn't depend on access, can keep
            }));
            
            // Debug: Log 4ep data loading
            let poolsWithLiq4Ep = store.vote.pools.filter(p => p.liq4Ep).length;
            let poolsWithVol4Ep = store.vote.pools.filter(p => p.vol4Ep).length;
            console.log(`Loaded pools: ${store.vote.pools.length}`);
            console.log(`Pools with liq4Ep: ${poolsWithLiq4Ep}`);
            console.log(`Pools with vol4Ep: ${poolsWithVol4Ep}`);
            if (store.vote.pools[0]) {
                console.log('First pool:', store.vote.pools[0].n, 'liq4Ep:', store.vote.pools[0].liq4Ep);
            }
            
            // Load DAO data if present
            if (d.dao) {
                store.dao.lVp = d.dao.locked_vp || 0;
                store.dao.lFac = d.dao.power_factor || 0;
                store.dao.lAst = d.dao.underlying_assets || 0;
                store.dao.dep = d.dao.deposit_usd || 0;
                store.dao.apr = d.dao.deposit_apr || 0;
                
                if (d.dao.rewards) {
                    store.dao.rew = {
                        usd: d.dao.rewards.usd || 0,
                        z: d.dao.rewards.zAssets || 0,
                        amp: d.dao.rewards.ampLUNA || 0
                    };
                }
                
                if (d.dao.locks) {
                    store.dao.locks = d.dao.locks.map(l => ({
                        id: l.id,
                        amt: l.amount,
                        asset: l.asset || 'LUNA',
                        bucket: l.bucket,
                        vp: l.vp,
                        usd: l.usd,
                        status: l.status || 'Unknown'
                    }));
                }
                
                if (d.dao.tokens) {
                    store.dao.toks = d.dao.tokens;
                }
                
                // Load vote rewards
                if (d.dao.vote_rewards) {
                    store.dao.vRew = d.dao.vote_rewards;
                }
                if (d.dao.vote_reward_periods) {
                    store.dao.vRewPeriods = d.dao.vote_reward_periods;
                }
            }
            
            // Load TLA liquidity data if present
            if (d.tla) {
                store.tla.tvl = d.tla.tvl || 0;
                store.tla.rewYr = d.tla.rewards_yr || 0;
                
                if (d.tla.pools) {
                    store.tla.pools = d.tla.pools.map(p => ({
                        name: p.name,
                        normName: p.normalized_name || p.name,
                        dex: p.dex,
                        type: p.type,
                        bucket: p.bucket,
                        depth: p.depth || 0,
                        stk: p.tla_staked || 0,
                        aprNon: p.apr_non_amp || 0,
                        aprAmp: p.apr_amplified || 0,
                        rYr: p.rewards_per_year || 0,
                        adaoNon: p.adao_deposit_non_amp || 0,
                        adaoAmp: p.adao_deposit_amplified || 0
                    }));
                }
                
                if (d.tla.inactive_pools) {
                    store.tla.inactivePools = d.tla.inactive_pools.map(p => ({
                        name: p.name,
                        normName: p.normalized_name || p.name,
                        dex: p.dex,
                        type: p.type,
                        bucket: p.bucket,
                        depth: p.depth || 0,
                        stk: p.tla_staked || 0,
                        aprNon: p.apr_non_amp || 0,
                        aprAmp: p.apr_amplified || 0
                    }));
                }
            }
            
            // Mark ext data as loaded from file
            store.ext.loaded = true;
            store.ext.source = 'epoch_file';
            
            // Check what data was actually in the file and set flags
            let hasVotionData = store.vote.pools.some(p => p.votNowVp > 0 || p.votNextVp > 0);
            let hasBribesData = store.vote.pools.some(p => p.incPD > 0 || p.incTotal > 0);
            let has4EpData = store.vote.pools.some(p => p.liq4Ep || p.vol4Ep);
            
            // Set flags so validation knows we have this data
            if (hasVotionData) {
                store.ext.votion = { loaded_from_file: true };
            }
            if (hasBribesData) {
                store.ext.pdBribesEpoch = { loaded_from_file: true };
            }
            if (has4EpData) {
                store.ext.lps = { loaded_from_file: true };
            }
            
            // Auto-load metadata for access scoring (silent, no alert)
            let metaLoaded = 0;
            try {
                let metaResp = await fetch(METADATA_GITHUB_URL + '?t=' + Date.now());
                if (metaResp.ok) {
                    let metaData = await metaResp.json();
                    if (metaData.assets) {
                        Object.entries(metaData.assets).forEach(([asset, meta]) => {
                            assetMetadata[asset] = meta;
                        });
                        metaLoaded = Object.keys(assetMetadata).length;
                        console.log(`Loaded metadata: ${metaLoaded} assets`);
                    }
                }
            } catch (e) {
                console.log('Metadata not loaded - using fallback scoring');
            }
            
            // RECALCULATE all scores using fresh metadata
            // This ignores old access_score/adao_score from file and recalculates
            recalculateScoresFromLoadedData();
            
            // Update UI
            updatePasteStatus('ps-vote', true, 'from file');
            updatePasteStatus('ps-liq-active', true, 'from file');
            
            // Render all tables (after scores recalculated)
            renderVoteTable();
            renderLocks();
            renderLiquidityTable();
            
            // Update additional UI elements
            updateDaoUIFromLoad();
            
            alert(`‚úÖ Loaded Epoch ${ep} (${ph}) - v2.0 format\n\n` +
                  `üìä ${d.pools.length} pools\n` +
                  `üîí ${d.dao?.locks?.length || 0} locks\n` +
                  `üíß ${d.tla?.pools?.length || 0} TLA pools\n` +
                  `üè∑Ô∏è ${metaLoaded} asset metadata\n` +
                  `üîÑ Scores recalculated with current metadata`);
}

// Load v1.0 snapshot format
function loadV1Snapshot(d, ep, ph) {
            if (d.vote_data) {
                store.vote.ep = d.vote_data.epoch;
                store.vote.end = d.vote_data.ends_in;
                store.vote.tvp = d.vote_data.total_voting_power;
                store.vote.reb = d.vote_data.adao_rebase || 0;
                store.vote.usd = d.vote_data.adao_unclaimed_rewards || 0;
                store.vote.pools = (d.vote_data.pools || []).map(p => ({
                    n: p.pool_name,
                    d: normalizeDexName(p.dex || p.dex_name),
                    b: p.bucket || "UNKNOWN",
                    tvp: p.tla_total_votes || 0,
                    dp: p.pool_depth || 0,
                    mvp: p.adao_vote_vp || 0,
                    vps: parseFloat(p.tla_vote_share || 0),
                    ms: parseFloat(p.adao_vote_share || 0),
                    inc: p.total_bribes || 0,
                    apr: '-'
                }));
                
                updatePasteStatus('ps-vote', true, 'v1');
                renderVoteTable();
            }
            
            if (d.locks) {
                store.dao.lVp = d.locks.adao_voting_power || 0;
                store.dao.lFac = d.locks.power_factor || 0;
                store.dao.lAst = d.locks.underlying_assets || 0;
                store.dao.locks = (d.locks.items || []).map(l => ({
                    id: l.id,
                    amt: l.amount,
                    asset: l.asset || 'LUNA',
                    vp: l.voting_power,
                    usd: l.usd_value,
                    status: l.status || 'Unknown'
                }));
                renderLocks();
            }
            
            alert(`‚úÖ Loaded Epoch ${ep} (${ph}) - v1 format`);
}

// Update DAO UI elements after loading from file
function updateDaoUIFromLoad() {
    // Update unclaimed rewards details
    if (store.dao.rew) {
        setTxt('dao-rew-z', (store.dao.rew.z || 0).toLocaleString());
        setTxt('dao-rew-amp', (store.dao.rew.amp || 0).toLocaleString());
        setTxt('dao-usd', fmt$(store.dao.rew.usd || 0));
    }
    
    // Update vote rewards modal
    if (store.dao.vRewPeriods && store.dao.vRewPeriods.length > 0) {
        let first = Math.min(...store.dao.vRewPeriods);
        let last = Math.max(...store.dao.vRewPeriods);
        let count = store.dao.vRewPeriods.length;
        setTxt('mod-vote-periods', `${first} - ${last}`);
        setTxt('mod-vote-epoch-count', `${count} Epochs`);
    } else {
        setTxt('mod-vote-periods', '-');
        setTxt('mod-vote-epoch-count', '-');
    }
    
    // Update vote rewards list in modal
    if (store.dao.vRew && Object.keys(store.dao.vRew).length > 0) {
        let html = Object.entries(store.dao.vRew).map(([token, amount]) => {
            let formatted = amount < 1 ? amount.toFixed(6) : amount.toLocaleString(undefined, {maximumFractionDigits: 2});
            return `<div class="flex justify-between py-1"><span class="text-gray-400">${token}</span><span class="text-green-400 font-mono">${formatted}</span></div>`;
        }).join('');
        setHtml('mod-vote-list', html);
    }
    
    // Update tokens modal
    if (store.dao.toks && store.dao.toks.length > 0) {
        renderTokensModal();
    }
}

// === TAB SWITCHING ===
function switchTab(t) {
    // Remove active from all tabs
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    
    // Add active to clicked tab
    const activeTab = $(`tab-${t}`);
    if (activeTab) {
        activeTab.classList.add('active');
    } else {
        // Fallback for tabs without IDs (like config)
        event.target.classList.add('active');
    }
    
    // Switch workspace
    document.querySelectorAll('.workspace').forEach(w => w.classList.remove('active'));
    $('ws-' + t)?.classList.add('active');
    
    // Auto-load asset metadata when switching to that tab
    if (t === 'asset-meta' && Object.keys(assetMetadata).length === 0) {
        loadMetadataFromGitHub();
    }
}

// Update tab step indicator status
function updateTabStatus(tabId, status) {
    const tab = $(`tab-${tabId}`);
    if (!tab) return;
    
    // Remove existing status classes
    tab.classList.remove('tab-incomplete', 'tab-complete', 'tab-partial');
    
    // Add new status
    tab.classList.add(`tab-${status}`);
    
    // Update status indicator
    const statusEl = tab.querySelector('.tab-status');
    if (statusEl) {
        if (status === 'complete') statusEl.textContent = '‚úì';
        else if (status === 'partial') statusEl.textContent = '‚óê';
        else statusEl.textContent = '‚óè';
    }
}

// Check all tabs and update their status
function updateAllTabStatuses() {
    // Vote tab - complete if pools AND vote rewards parsed
    if (store.vote.pools.length > 0 && pasteStatus.vote && pasteStatus.voteRew) {
        updateTabStatus('vote', 'complete');
    } else if (store.vote.pools.length > 0 || pasteStatus.voteRew) {
        updateTabStatus('vote', 'partial');
    } else {
        updateTabStatus('vote', 'incomplete');
    }
    
    // Liquidity tab - complete if deposits and rewards parsed
    if (pasteStatus.liqDep && (pasteStatus.liqRew || fallbackStatus.unclaimed === 'skip')) {
        updateTabStatus('liquidity', 'complete');
    } else if (pasteStatus.liqDep || pasteStatus.liqRew || pasteStatus.liqActive) {
        updateTabStatus('liquidity', 'partial');
    } else {
        updateTabStatus('liquidity', 'incomplete');
    }
    
    // Locks tab - complete if locks parsed
    if (pasteStatus.locks) {
        updateTabStatus('locks', 'complete');
    } else if (store.dao.locks.length > 0) {
        updateTabStatus('locks', 'partial');
    } else {
        updateTabStatus('locks', 'incomplete');
    }
    
    // Asset Meta tab - complete if metadata loaded and verified
    if (pasteStatus.assetMetaVerified) {
        updateTabStatus('asset-meta', 'complete');
    } else if (Object.keys(assetMetadata).length > 0) {
        updateTabStatus('asset-meta', 'partial');
    } else {
        updateTabStatus('asset-meta', 'incomplete');
    }
    
    // Dashboard tab - placeholder, always incomplete for now
    updateTabStatus('dashboard', 'incomplete');
    
    // NFT Stats tab - placeholder
    updateTabStatus('nft', 'incomplete');
    
    // DAO Gov tab - placeholder
    updateTabStatus('dao-gov', 'incomplete');
    
    // News tab - placeholder
    updateTabStatus('news', 'incomplete');
    
    // Update score calculation button visibility
    updateScoreButtonVisibility();
}

// Check if all data needed for scoring is ready (tabs 1, 2, 3, 4)
function isScoreDataReady() {
    // Vote tab - need vote pools parsed
    let voteReady = pasteStatus.vote && store.vote.pools.length > 0;
    
    // Liquidity tab - need deposits parsed
    let liqReady = pasteStatus.liqDep || pasteStatus.liqActive;
    
    // Locks tab - need locks parsed
    let locksReady = pasteStatus.locks;
    
    // Asset Meta tab - need metadata loaded
    let metaReady = pasteStatus.assetMetaVerified || Object.keys(assetMetadata).length > 0;
    
    return voteReady && liqReady && locksReady && metaReady;
}

// Update score button visibility based on data readiness
function updateScoreButtonVisibility() {
    const btn = $('calc-scores-btn');
    const psBtn = $('ps-calc-scores');
    const status = $('score-status');
    
    let voteReady = pasteStatus.vote && store.vote.pools.length > 0;
    let liqReady = pasteStatus.liqDep || pasteStatus.liqActive;
    let locksReady = pasteStatus.locks;
    let metaReady = pasteStatus.assetMetaVerified || Object.keys(assetMetadata).length > 0;
    let allReady = voteReady && liqReady && locksReady && metaReady;
    
    // Update Vote Dashboard button
    if (btn) {
        if (allReady) {
            btn.classList.remove('hidden');
            if (status) {
                status.textContent = '‚úì Ready to calculate';
                status.className = 'text-[9px] text-green-400';
            }
        } else {
            btn.classList.add('hidden');
            let missing = [];
            if (!voteReady) missing.push('Vote');
            if (!liqReady) missing.push('Liquidity');
            if (!locksReady) missing.push('Locks');
            if (!metaReady) missing.push('Asset Meta');
            if (status) {
                status.textContent = 'Need: ' + missing.join(', ');
                status.className = 'text-[9px] text-yellow-500';
            }
        }
    }
    
    // Update Paste Progress bar button
    if (psBtn) {
        if (allReady) {
            psBtn.disabled = false;
            psBtn.className = 'px-3 py-0.5 rounded bg-emerald-900/50 text-emerald-400 border border-emerald-700 cursor-pointer hover:bg-emerald-800 font-bold';
            psBtn.title = 'Calculate scores for all pools';
        } else {
            psBtn.disabled = true;
            psBtn.className = 'px-3 py-0.5 rounded bg-gray-800 text-gray-500 border border-gray-700 cursor-not-allowed opacity-50';
            let missing = [];
            if (!voteReady) missing.push('Vote');
            if (!liqReady) missing.push('Liq Active');
            if (!locksReady) missing.push('Locks');
            if (!metaReady) missing.push('Asset Meta');
            psBtn.title = 'Need: ' + missing.join(', ');
        }
    }
}

// Calculate all scores and re-render the vote table
function calculateAndRenderScores() {
    if (!isScoreDataReady()) {
        alert('Please complete tabs 1-4 first (Vote, Liquidity, Locks, Asset Meta)');
        return;
    }
    
    // Get current filter settings
    let filterSettings = {
        showAstro: $('show-astro')?.checked ?? true,
        showWW: $('show-ww')?.checked ?? true,
        showInactive: $('show-inactive')?.checked ?? false
    };
    
    // Calculate scores for all buckets
    calculateAllScores(filterSettings);
    
    // Re-render the vote table to show scores
    renderVoteTable();
    
    // Visual feedback
    const btn = $('calc-scores-btn');
    if (btn) {
        btn.textContent = '‚úì Scores Calculated';
        btn.className = 'text-[10px] bg-green-700 text-green-200 px-3 py-1 rounded font-bold';
        setTimeout(() => {
            btn.textContent = 'üßÆ Calculate Scores';
            btn.className = 'text-[10px] bg-emerald-800 hover:bg-emerald-700 text-emerald-300 px-3 py-1 rounded font-bold';
        }, 2000);
    }
    
    console.log('Scores calculated for', store.vote.pools.length, 'pools');
}

// === CONFIG EDITOR ===
function generateConfigJSON() {
    const config = {
        version: 1,
        updated: new Date().toISOString().split('T')[0],
        general: {
            currentEpoch: parseInt($('cfg-epoch')?.value) || 161,
            defaultPhase: $('cfg-phase')?.value || 'end'
        },
        urls: {
            baseUrl: $('cfg-baseUrl')?.value || '',
            extUrl: $('cfg-extUrl')?.value || '',
            adaoUrl: $('cfg-adaoUrl')?.value || ''
        },
        scoring: {
            weights: {
                access: parseFloat($('cfg-accessWeight')?.value) || 0.15,
                performance: parseFloat($('cfg-perfWeight')?.value) || 0.55,
                support: parseFloat($('cfg-supportWeight')?.value) || 0.30
            },
            origin: {
                terra_lsd: parseInt($('cfg-origin-lsd')?.value) || 85,
                terra_native: parseInt($('cfg-origin-native')?.value) || 80,
                ibc_native: parseInt($('cfg-origin-ibc')?.value) || 70,
                bridged_stable: parseInt($('cfg-origin-stable')?.value) || 65,
                bridge_eureka: parseInt($('cfg-origin-eureka')?.value) || 55,
                bridge_axelar: parseInt($('cfg-origin-axelar')?.value) || 50
            },
            assetClass: {
                stable: parseInt($('cfg-class-stable')?.value) || 5,
                bluechip: parseInt($('cfg-class-bluechip')?.value) || 5,
                lsd: parseInt($('cfg-class-lsd')?.value) || 5,
                rwa: parseInt($('cfg-class-rwa')?.value) || 5,
                core: parseInt($('cfg-class-core')?.value) || 0
            }
        },
        dex: {
            primary: {
                name: $('cfg-dex1-name')?.value || 'Astroport',
                link: $('cfg-dex1-link')?.value || ''
            },
            secondary: {
                name: $('cfg-dex2-name')?.value || 'Skeleton Swap',
                link: $('cfg-dex2-link')?.value || '',
                enabled: $('cfg-dex2-enabled')?.checked || false
            }
        }
    };
    return config;
}

function copyConfigJSON() {
    const config = generateConfigJSON();
    const jsonStr = JSON.stringify(config, null, 2);
    
    // Show in preview
    $('config-preview').textContent = jsonStr;
    
    // Copy to clipboard
    navigator.clipboard.writeText(jsonStr).then(() => {
        const status = $('config-copy-status');
        status.classList.remove('hidden');
        setTimeout(() => status.classList.add('hidden'), 2000);
    });
}

function resetConfigDefaults() {
    // General
    $('cfg-epoch').value = 161;
    $('cfg-phase').value = 'end';
    
    // URLs
    $('cfg-baseUrl').value = 'https://raw.githubusercontent.com/defipatriot/tla_json_storage/main';
    $('cfg-extUrl').value = 'https://raw.githubusercontent.com/defipatriot/tla-ext_json_storage/main';
    $('cfg-adaoUrl').value = 'https://raw.githubusercontent.com/defipatriot/adao_json_storage/main';
    
    // Weights
    $('cfg-accessWeight').value = 0.15;
    $('cfg-perfWeight').value = 0.55;
    $('cfg-supportWeight').value = 0.30;
    
    // Origin scores
    $('cfg-origin-lsd').value = 85;
    $('cfg-origin-native').value = 80;
    $('cfg-origin-ibc').value = 70;
    $('cfg-origin-stable').value = 65;
    $('cfg-origin-eureka').value = 55;
    $('cfg-origin-axelar').value = 50;
    
    // Asset class
    $('cfg-class-stable').value = 5;
    $('cfg-class-bluechip').value = 5;
    $('cfg-class-lsd').value = 5;
    $('cfg-class-rwa').value = 5;
    $('cfg-class-core').value = 0;
    
    // DEX
    $('cfg-dex1-name').value = 'Astroport';
    $('cfg-dex1-link').value = 'https://app.astroport.fi/pools';
    $('cfg-dex2-name').value = 'Skeleton Swap';
    $('cfg-dex2-link').value = 'https://app.skeleton_swap.money/terra/pools';
    $('cfg-dex2-enabled').checked = false;
    
    $('config-preview').textContent = 'Click "Copy Config JSON" to generate...';
}

// Update weight total display
document.addEventListener('DOMContentLoaded', () => {
    const updateWeightTotal = () => {
        const a = parseFloat($('cfg-accessWeight')?.value) || 0;
        const p = parseFloat($('cfg-perfWeight')?.value) || 0;
        const s = parseFloat($('cfg-supportWeight')?.value) || 0;
        const total = ((a + p + s) * 100).toFixed(0);
        const el = $('weight-total');
        if (el) {
            el.textContent = `Total: ${total}%`;
            el.className = total == 100 ? 'text-[10px] text-green-400 mt-2' : 'text-[10px] text-red-400 mt-2';
        }
    };
    
    ['cfg-accessWeight', 'cfg-perfWeight', 'cfg-supportWeight'].forEach(id => {
        $(id)?.addEventListener('input', updateWeightTotal);
    });
});

// === VOTE PARSING ===
function normalizeName(name) {
    if (!name.includes('-')) return name;
    let parts = name.split('-');
    // Only swap if LUNA itself is second (to put LUNA first)
    // Don't swap for ampLUNA, bLUNA - they stay as LUNA-ampLUNA, LUNA-bLUNA
    if (parts[1] === 'LUNA') return `LUNA-${parts[0]}`;
    return name;
}

// Normalize DEX names - handles White Whale -> Skeleton Swap transition
// Accepts: White Whale, WhiteWhale, whitewhale, WW, ww, Skeleton, Skeleton Swap, SS, ss, etc.
function normalizeDexName(dexName) {
    if (!dexName) return dexName;
    let lower = dexName.toLowerCase().trim();
    
    // Skeleton Swap / White Whale variants -> "Skeleton Swap"
    if (lower.includes('white') || lower.includes('whale') || 
        lower === 'ww' || lower.includes('skeleton') || lower === 'ss') {
        return 'Skeleton Swap';
    }
    
    // Astroport variants
    if (lower.includes('astro') && !lower.includes('single')) {
        return 'Astroport';
    }
    
    // Single-sided (Astroport single asset staking)
    if (lower === 'single' || lower.includes('single')) {
        return 'Single (Astroport)';
    }
    
    return dexName; // Return as-is if no match
}

// Check if DEX is Skeleton Swap (handles all variants)
function isSkeletonSwap(dexName) {
    if (!dexName) return false;
    let lower = dexName.toLowerCase();
    return lower.includes('white') || lower.includes('whale') || 
           lower === 'ww' || lower.includes('skeleton') || lower === 'ss';
}

// Check if DEX is Astroport (including Single)
function isAstroport(dexName) {
    if (!dexName) return false;
    let lower = dexName.toLowerCase();
    return lower.includes('astro') || lower === 'single';
}

function parseVote() {
    try {
        let txt = $('votePaste').value;
        
        // === HEADER DATA ===
        let m;
        if (m = txt.match(/For Epoch\s*(\d+)/)) store.vote.ep = parseInt(m[1]);
        if (m = txt.match(/ends\s*\n?\s*in\s*(\d+)\s*day/i)) store.vote.end = m[1] + ' days';
        if (m = txt.match(/Total Voting Power\s*\n?\s*([\d\.]+)([KkMm])?VP/i)) store.vote.tvp = parseNum(m[1] + (m[2] || ''));
        if (m = txt.match(/Your Voting Power\s*\n?\s*([\d\.]+)([KkMm]?)VP/i)) store.dao.lVp = parseNum(m[1] + (m[2] || ''));
        if (m = txt.match(/Rebase\s*\n?\s*([\d\.,]+)/i)) store.vote.reb = parseNum(m[1]);
        if (m = txt.match(/Vote Rewards\s*\n?\s*\$\s*([\d\.,]+)/i)) store.vote.usd = parseNum(m[1]);

        // === POOL PARSING ===
        let lines = txt.split('\n').map(l => l.trim());
        store.vote.pools = [];
        let currentBucket = "UNKNOWN";
        
        for (let i = 0; i < lines.length; i++) {
            let l = lines[i];
            if (!l) continue;

            // Bucket headers - only if next line is "Pool" (to avoid confusing with "Single" DEX type)
            if (BUCKET_ORDER.includes(l.toUpperCase())) {
                // Check next line to confirm it's a bucket header, not a DEX
                let nextLine = lines[i + 1]?.trim();
                if (nextLine === 'Pool') {
                    currentBucket = l.toUpperCase();
                    continue;
                }
            }

            // Skip nav/junk lines
            if (/^(LIQUIDITY|VOTE|LOCK|INCENTIVIZE|DASHBOARD|AMPLIFY|GOV|ARBITRAGE|ALLIANCE|icon)/i.test(l)) continue;

            // DEX line = start of pool (pool name is previous line)
            // Match all DEX variants: Astroport, Skeleton Swap, White Whale, WhiteWhale, WW, Single
            let dexMatch = l.match(/^(Astroport|Skeleton\s*Swap|SkeletonSwap|White\s*Whale|WhiteWhale|WW|Single)/i);
            if (dexMatch && i > 0) {
                let poolName = lines[i-1];
                if (!poolName || /^icon/i.test(poolName)) continue;
                
                // Normalize the DEX name (White Whale -> Skeleton Swap, etc.)
                let normalizedDex = normalizeDexName(dexMatch[1]);
                
                // Debug: log single asset detection
                if (dexMatch[1].toLowerCase() === 'single') {
                    console.log('Found Single asset:', poolName, '-> DEX line:', l);
                }
                
                let p = { 
                    n: normalizeName(poolName.replace(' LP', '')), 
                    d: normalizedDex,  // Use normalized DEX name
                    b: currentBucket, 
                    tvp: 0, dp: 0, vol: 0, mvp: 0, vps: 0, ms: 0,
                    // Bribes
                    inc: 0, incPD: 0, incOther: 0, incTotal: 0,
                    // Votion
                    votNowVp: 0, votNowPct: 0, votNextVp: 0, votNextPct: 0,
                    apr: '-'
                };
                
                // Scan forward until "Create locks" (end of pool block)
                // Also stop if we hit another DEX line or pool name (LP)
                for (let k = i + 1; k < i + 20; k++) {
                    let x = lines[k];
                    if (!x) continue;
                    if (x === 'Create locks') break;
                    
                    // CRITICAL: Stop if we hit another DEX line (start of next pool)
                    if (/^(Astroport|Skeleton\s*Swap|SkeletonSwap|White\s*Whale|WhiteWhale|WW|Single)$/i.test(x)) {
                        console.log(`  Stopping scan for ${poolName}|${normalizedDex} - hit DEX line: ${x}`);
                        break;
                    }
                    
                    // CRITICAL: Stop if we hit another pool name (ends with " LP" or is single asset)
                    if ((x.endsWith(' LP') || x === 'ampCAPA' || x === 'xASTRO') && k > i + 1) {
                        console.log(`  Stopping scan for ${poolName}|${normalizedDex} - hit pool name: ${x}`);
                        break;
                    }
                    
                    // Total VP: "VP 15.85M  76.9 %"
                    if (x.startsWith('VP ')) {
                        let vpM = x.match(/VP\s*([\d\.]+)([KkMm]?)\s+([\d\.]+)\s*%/);
                        if (vpM) {
                            p.tvp = parseNum(vpM[1] + (vpM[2] || ''));
                            p.vps = parseFloat(vpM[3]);
                        }
                    }
                    // Depth: "Depth $ 562.97K"
                    else if (x.startsWith('Depth')) {
                        p.dp = parseNum(x);
                    }
                    // Incentives: "$ 16.94" (starts with $) - This is TOTAL bribes from Vote page
                    else if (x.startsWith('$')) {
                        let bribeVal = parseNum(x);
                        p.inc = bribeVal;
                        p.incTotal = bribeVal; // Total bribes from Vote page
                        // incPD will be set from ext file, incOther = incTotal - incPD
                    }
                    // After "Extend locks" comes user VP
                    else if (x === 'Extend locks') {
                        let userVpLine = lines[k + 1];
                        let userShareLine = lines[k + 2];
                        if (userVpLine?.match(/VP$/i)) {
                            p.mvp = parseNum(userVpLine);
                        }
                        if (userShareLine?.match(/^[\d\.,]+\s*%$/)) {
                            p.ms = parseFloat(userShareLine);
                        }
                    }
                    // vAPR: first standalone % line (not a range with -)
                    else if (x.match(/^[\d\.]+\s*%$/) && p.apr === '-') {
                        p.apr = x;
                    }
                }
                
                store.vote.pools.push(p);
            }
        }
        
        // Debug: log all parsed pools
        console.log('Vote parsing complete. Pools by DEX:');
        let byDex = {};
        store.vote.pools.forEach(p => {
            let dex = isAstroport(p.d) ? (p.d.includes('Single') ? 'Single' : 'Astroport') : 'Skeleton Swap';
            if (!byDex[dex]) byDex[dex] = [];
            byDex[dex].push(p.n);
        });
        Object.entries(byDex).forEach(([dex, pools]) => {
            console.log(`  ${dex}: ${pools.length} pools -`, pools.join(', '));
        });
        
        setTxt('status-vote-page', "PARSED");
        $('status-vote-page').className = "text-[9px] text-green-400 font-bold";
        pasteStatus.vote = true;
        updatePasteStatus('ps-vote', true);
        applyExtDataToPools();
        renderVoteTable();
    } catch(e) {
        console.error(e);
        alert("Error parsing vote data. Check console.");
    }
}

function renderVoteTable() {
    setTxt('vote-ep', store.vote.ep);
    setTxt('vote-end', store.vote.end);
    setTxt('vote-tvp', store.vote.tvp.toLocaleString(undefined, {maximumFractionDigits: 0}));
    setTxt('vote-adao-vp', store.dao.lVp ? store.dao.lVp.toLocaleString() : '-');
    
    // Calculate aDAO percentage of total TLA
    if (store.vote.tvp > 0 && store.dao.lVp > 0) {
        setTxt('vote-adao-pct', ((store.dao.lVp / store.vote.tvp) * 100).toFixed(2) + '%');
    } else {
        setTxt('vote-adao-pct', '-');
    }
    
    // Calculate phase from epoch end time (most accurate) or ends string
    let totalDays = 0;
    
    if (currentEpochInfo?.end_time) {
        // Use exact epoch end time for precision
        let endTime = new Date(currentEpochInfo.end_time);
        let msUntilEnd = endTime - new Date();
        totalDays = msUntilEnd / 86400000; // Decimal days
    } else {
        // Fallback to parsed ends string
        let daysMatch = store.vote.end.match(/(\d+)\s*d/i);
        let hoursMatch = store.vote.end.match(/(\d+)\s*h/i);
        if (daysMatch) totalDays += parseInt(daysMatch[1]);
        if (hoursMatch) totalDays += parseInt(hoursMatch[1]) / 24;
    }
    
    let phase = 'End', phaseColor = 'text-red-400';
    if (totalDays >= 5) { phase = 'Start'; phaseColor = 'text-green-400'; }
    else if (totalDays > 2) { phase = 'Mid'; phaseColor = 'text-yellow-400'; }
    
    const phaseEl = $('vote-phase');
    if (phaseEl) { 
        // Show phase and ext file status
        let extPhase = store.ext.votion ? (store.ext.meta?.phase || 'loaded') : 'none';
        let extIndicator = store.ext.votion ? ` <span class="text-[9px] text-gray-500">(ext: ${extPhase})</span>` : '';
        phaseEl.innerHTML = phase + extIndicator; 
        phaseEl.className = phaseColor + ' font-bold'; 
    }
    
    setTxt('vote-rebase', store.vote.reb.toLocaleString() + ' amp');
    setTxt('vote-claim', fmt$(store.vote.usd));

    // Read GRADE filter settings (affects scoring/ranking)
    let gradeAstro = $('grade-astro')?.checked ?? true;
    let gradeWW = $('grade-ww')?.checked ?? true;
    let gradeInactive = $('grade-inactive')?.checked ?? true;
    
    // Read EXPORT filter settings (affects JSON output only)
    let exportAstro = $('export-astro')?.checked ?? true;
    let exportWW = $('export-ww')?.checked ?? true;
    let exportInactive = $('export-inactive')?.checked ?? true;
    let showADAO = $('export-adao')?.checked ?? true;
    
    let gradeSettings = { showAstro: gradeAstro, showWW: gradeWW, showInactive: gradeInactive };

    // Calculate all aDAO scores with current GRADE filter settings
    // Scores are ranked relative to what's selected for grading
    calculateAllScores(gradeSettings);

    // === CALCULATE DEX STATS ===
    let dexStats = {
        astro: { active: 0, inactive: 0, depth: 0, tlaVp: 0, adaoVp: 0 },
        ww: { active: 0, inactive: 0, depth: 0, tlaVp: 0, adaoVp: 0 }
    };
    
    let totalTlaVp = 0;
    let totalAdaoVp = 0;
    
    store.vote.pools.forEach(p => {
        let isActive = p.vps >= 1;
        totalTlaVp += p.tvp;
        totalAdaoVp += p.mvp;
        
        if (isAstroport(p.d)) {
            if (isActive) dexStats.astro.active++; else dexStats.astro.inactive++;
            dexStats.astro.depth += p.dp;
            dexStats.astro.tlaVp += p.tvp;
            dexStats.astro.adaoVp += p.mvp;
        }
        if (isSkeletonSwap(p.d)) {
            if (isActive) dexStats.ww.active++; else dexStats.ww.inactive++;
            dexStats.ww.depth += p.dp;
            dexStats.ww.tlaVp += p.tvp;
            dexStats.ww.adaoVp += p.mvp;
        }
    });
    
    // Update DEX tables
    setTxt('dex-astro-active', dexStats.astro.active);
    setTxt('dex-astro-inactive', dexStats.astro.inactive);
    setTxt('dex-astro-depth', fmt$(dexStats.astro.depth));
    setTxt('dex-astro-tla-pct', totalTlaVp > 0 ? ((dexStats.astro.tlaVp / totalTlaVp) * 100).toFixed(1) + '%' : '0%');
    setTxt('dex-astro-adao-pct', totalAdaoVp > 0 ? ((dexStats.astro.adaoVp / totalAdaoVp) * 100).toFixed(1) + '%' : '0%');
    
    setTxt('dex-ww-active', dexStats.ww.active);
    setTxt('dex-ww-inactive', dexStats.ww.inactive);
    setTxt('dex-ww-depth', fmt$(dexStats.ww.depth));
    setTxt('dex-ww-tla-pct', totalTlaVp > 0 ? ((dexStats.ww.tlaVp / totalTlaVp) * 100).toFixed(1) + '%' : '0%');
    setTxt('dex-ww-adao-pct', totalAdaoVp > 0 ? ((dexStats.ww.adaoVp / totalAdaoVp) * 100).toFixed(1) + '%' : '0%');

    // === RENDER POOL TABLE ===
    // Sort: by bucket, then Active A-Z, then Inactive A-Z
    let sortedPools = [...store.vote.pools].sort((a, b) => {
        // 1. By bucket order
        let biA = BUCKET_ORDER.indexOf(a.b); if (biA === -1) biA = 99;
        let biB = BUCKET_ORDER.indexOf(b.b); if (biB === -1) biB = 99;
        if (biA !== biB) return biA - biB;
        
        // 2. Active pools first (vps >= 1)
        let aActive = a.vps >= 1 ? 0 : 1;
        let bActive = b.vps >= 1 ? 0 : 1;
        if (aActive !== bActive) return aActive - bActive;
        
        // 3. Alphabetical by name
        return a.n.localeCompare(b.n);
    });

    let finalHtml = '';
    document.querySelectorAll('.adao-col').forEach(el => el.style.display = showADAO ? '' : 'none');

    BUCKET_ORDER.forEach(bucketName => {
        let bucketPools = sortedPools.filter(p => p.b === bucketName);
        if (bucketPools.length === 0) return;

        // Determine which pools are included in grading (for visual indicator)
        bucketPools.forEach(p => {
            let isAct = p.vps >= 1;
            let isAstroOrSingle = isAstroport(p.d);
            let isWW = isSkeletonSwap(p.d);
            
            p.includedInGrade = true;
            if (isAstroOrSingle && !gradeAstro) p.includedInGrade = false;
            if (isWW && !gradeWW) p.includedInGrade = false;
            if (!isAct && !gradeInactive) p.includedInGrade = false;
        });

        // Calculate totals from ALL pools in bucket
        let bTlaVp = bucketPools.reduce((s, p) => s + p.tvp, 0);
        let bAdaoVp = bucketPools.reduce((s, p) => s + p.mvp, 0);
        let bVoteShare = bucketPools.reduce((s, p) => s + p.vps, 0);
        let bAdaoShare = bucketPools.reduce((s, p) => s + p.ms, 0);
        let bIncentives = bucketPools.reduce((s, p) => s + p.inc, 0);

        finalHtml += `<div class="bg-[#1f2937] border-y border-gray-700 py-1 mt-2 mb-1"><div class="flex justify-between items-center px-2"><span class="text-gray-300 font-bold text-[10px] tracking-widest uppercase">${bucketName}</span></div></div>`;

        // Render ALL pools (not filtered)
        bucketPools.forEach(p => {
            let isAct = p.vps >= 1;
            let isAstroOrSingle = isAstroport(p.d);
            
            // Dim pools not included in grading
            let rowOpacity = p.includedInGrade ? '' : 'opacity-40';
            let gradeIndicator = p.includedInGrade ? '' : '<span class="text-[8px] text-gray-500 ml-1">(not graded)</span>';

            let dexColor = isAstroOrSingle ? 'text-blue-600' : 'text-green-400';
            let inactiveText = p.vps < 1 ? '<span class="text-red-500 font-bold text-[11px]">INACT</span>' : '';
            
            // 4Ep averages
            let liq4Ep = p.liq4Ep?.avg || 0;
            let vol4Ep = p.vol4Ep?.avg || 0;
            let liq4EpStr = liq4Ep > 0 ? fmt$(liq4Ep) : '-';
            let vol4EpStr = vol4Ep > 0 ? fmt$(vol4Ep) : '-';
            let liq4EpTitle = p.liq4Ep ? `${p.liq4Ep.count} epochs avg` : 'No ext data';
            let vol4EpTitle = p.vol4Ep ? `${p.vol4Ep.count} epochs avg` : 'No ext data';
            
            // Efficiency
            let effStr = p.efficiency > 0 ? p.efficiency.toFixed(2) : '-';
            let effColor = p.efficiency >= 0.3 ? 'text-green-400' : p.efficiency >= 0.1 ? 'text-yellow-400' : 'text-gray-500';
            
            // Access score
            let accStr = p.accessScore ? p.accessScore.toFixed(0) : '-';
            let accColor = p.accessScore >= 70 ? 'text-green-400' : p.accessScore >= 50 ? 'text-cyan-400' : p.accessScore >= 30 ? 'text-yellow-400' : 'text-gray-500';
            let accTitle = 'No access data';
            if (p.accessData?.source === 'metadata') {
                let b = p.accessData.breakdown;
                let issueCount = b.allIssues?.length || 0;
                accTitle = `${b.asset1.name}: ${b.asset1.score} | ${b.asset2.name}: ${b.asset2.score}`;
                if (issueCount > 0) accTitle += ` | ‚ö†Ô∏è ${issueCount} issues`;
            } else if (p.accessData?.breakdown) {
                accTitle = 'No metadata - using fallback scoring';
            }
            
            // Support score
            let suppStr = p.supportScore?.toFixed(0) || '0';
            let suppColor = p.supportScore >= 60 ? 'text-red-400' : p.supportScore >= 30 ? 'text-yellow-400' : 'text-gray-400';
            
            // aDAO Score - only show if tabs 2,3,4 are complete
            let scoringReady = isScoreDataReady();
            let scoreStr = scoringReady && p.adaoScore ? p.adaoScore.toFixed(0) : '-';
            let scoreColor = scoringReady ? getScoreColor(p.adaoScore || 0) : 'text-gray-600';
            let scoreIcon = scoringReady ? getScoreIcon(p.adaoScore || 0) : '';
            let scoreTitle = scoringReady ? 'aDAO Opportunity Score' : 'Complete Liquidity, Locks, and Asset Meta tabs first';
            
            // APR display (both non and amp)
            let aprNonStr = p.aprNon > 0 ? p.aprNon.toFixed(0) + '%' : '-';
            let aprAmpStr = p.aprAmp > 0 ? p.aprAmp.toFixed(0) + '%' : '';
            let aprColor = p.aprNon < 40 ? 'text-red-400' : p.aprNon < 55 ? 'text-green-400' : p.aprNon < 70 ? 'text-yellow-400' : 'text-orange-400';
            
            let dexShort = p.d.includes('Single') ? 'Single' : isAstroport(p.d) ? 'Astro' : 'SS';
            let dexFull = p.d.includes('Single') ? 'Single' : isAstroport(p.d) ? 'Astroport' : 'Skeleton Swap';
            
            finalHtml += `
            <div class="vote-grid border-b border-gray-800/50 py-2 hover:bg-white/5 px-2 cursor-pointer ${rowOpacity}" onclick="showPoolScoreDetails('${p.n}', '${dexShort}')">
                <div class="flex flex-col justify-center">
                    <div class="flex items-center gap-1">
                        <span class="text-white text-[12px] font-bold truncate" title="${p.n}">${p.n}</span>
                        ${gradeIndicator}
                    </div>
                    <span class="text-[10px] ${dexColor}">${dexFull}</span>
                </div>
                <div class="text-center text-[11px]">${inactiveText}</div>
                <div class="text-right font-mono text-teal-400 text-[11px]" title="${liq4EpTitle}">${liq4EpStr}</div>
                <div class="text-right font-mono text-teal-400 text-[11px]" title="${vol4EpTitle}">${vol4EpStr}</div>
                <div class="text-right font-mono ${effColor} text-[11px]" title="Vol/Liq ratio">${effStr}</div>
                <div class="text-right flex flex-col leading-tight" title="Non-amp / Amplified APR">
                    <span class="font-mono ${aprColor} text-[11px]">${aprNonStr}</span>
                    ${aprAmpStr ? `<span class="font-mono text-yellow-500 text-[10px]">üî•${aprAmpStr}</span>` : ''}
                </div>
                <div class="text-right font-mono ${accColor} text-[11px]" title="${accTitle}">${accStr}</div>
                <div class="text-right flex flex-col leading-tight" title="Votion Current Epoch">
                    ${p.votNowVp > 0 ? `<span class="text-purple-400 font-mono text-[11px] font-bold">${fmtVp(p.votNowVp)}</span><span class="text-purple-400/70 font-mono text-[10px]">${p.votNowPct.toFixed(2)}%</span>` : '<span class="text-gray-600 text-[11px]">-</span>'}
                </div>
                <div class="text-right flex flex-col leading-tight" title="Votion Next Epoch Optimization">
                    ${p.votNextVp > 0 ? `<span class="text-purple-300 font-mono text-[11px] font-bold">${fmtVp(p.votNextVp)}</span><span class="text-purple-300/70 font-mono text-[10px]">${p.votNextPct.toFixed(2)}%</span>` : '<span class="text-gray-600 text-[11px]">-</span>'}
                </div>
                <div class="text-right flex flex-col leading-tight" title="Vote Change">
                    ${(() => {
                        let changeVp = (p.votNextVp || 0) - (p.votNowVp || 0);
                        let changePct = (p.votNextPct || 0) - (p.votNowPct || 0);
                        if (changeVp === 0 && changePct === 0 && p.votNowVp === 0) return '<span class="text-gray-600 text-[11px]">-</span>';
                        let color = changeVp > 0 ? 'text-green-400' : changeVp < 0 ? 'text-red-400' : 'text-gray-500';
                        let sign = changeVp > 0 ? '+' : '';
                        return `<span class="${color} font-mono text-[11px] font-bold">${sign}${fmtVp(changeVp)}</span><span class="${color}/70 font-mono text-[10px]">${sign}${changePct.toFixed(2)}%</span>`;
                    })()}
                </div>
                <div class="text-right flex flex-col leading-tight" title="Total: ${fmt$(p.incTotal || 0)} | PD: ${fmt$(p.incPD || 0)} | Other: ${fmt$(p.incOther || 0)}">
                    ${p.incTotal > 0 ? `
                        <span class="text-green-400 font-mono text-[11px]">${fmt$(p.incTotal)}</span>
                        ${p.incPD > 0 && p.incOther > 0 ? `<span class="text-gray-500 font-mono text-[9px]">${fmt$(p.incPD)} PD</span>` : 
                          p.incPD > 0 ? `<span class="text-green-600 font-mono text-[9px]">PD</span>` : ''}
                    ` : (p.incPD > 0 ? `
                        <span class="text-green-400 font-mono text-[11px]">${fmt$(p.incPD)}</span>
                        <span class="text-green-600 font-mono text-[9px]">PD</span>
                    ` : '<span class="text-gray-600 text-[11px]">-</span>')}
                </div>
                <div class="text-right font-mono ${suppColor} text-[11px]" title="Support score">${suppStr}</div>
                <div class="text-right flex flex-col leading-tight">
                    <span class="text-orange-400 font-mono text-[11px] font-bold">${p.tvp.toLocaleString()}</span>
                    <span class="text-orange-400/70 font-mono text-[10px]">${p.vps.toFixed(2)}%</span>
                </div>
                <div class="text-right flex flex-col leading-tight adao-col" style="${showADAO ? '' : 'display:none;'}">
                    ${p.mvp > 0 ? `<span class="text-cyan-400 font-mono text-[11px] font-bold">${p.mvp.toLocaleString()}</span><span class="text-cyan-400/70 font-mono text-[10px]">${p.ms.toFixed(2)}%</span>` : '<span class="text-gray-700 text-[11px]">-</span>'}
                </div>
                <div class="text-right font-mono ${scoreColor} text-[12px] font-bold" title="${scoreTitle}">${scoreIcon}${scoreStr}</div>
            </div>`;
        });

        // Calculate Votion totals for bucket (from ALL pools)
        let bVotNowVp = bucketPools.reduce((s, p) => s + (p.votNowVp || 0), 0);
        let bVotNowPct = bucketPools.reduce((s, p) => s + (p.votNowPct || 0), 0);
        let bVotNextVp = bucketPools.reduce((s, p) => s + (p.votNextVp || 0), 0);
        let bVotNextPct = bucketPools.reduce((s, p) => s + (p.votNextPct || 0), 0);
        
        // Calculate bucket averages for new metrics (from ALL pools)
        let poolsWithScores = bucketPools.filter(p => p.adaoScore !== undefined);
        let avgScore = poolsWithScores.length > 0 
            ? poolsWithScores.reduce((s, p) => s + p.adaoScore, 0) / poolsWithScores.length 
            : 0;

        finalHtml += `
        <div class="vote-grid bg-indigo-900/40 border-t border-indigo-800 py-2 px-2 font-bold mt-1">
            <div class="text-[11px] text-gray-400 uppercase tracking-widest">${bucketName} TOTALS</div>
            <div></div>
            <div></div>
            <div></div>
            <div></div>
            <div></div>
            <div></div>
            <div class="text-right flex flex-col leading-tight">
                ${bVotNowVp > 0 ? `<span class="text-purple-300 font-mono text-[10px]">${fmtVp(bVotNowVp)}</span><span class="text-purple-300/70 font-mono text-[9px]">${bVotNowPct.toFixed(2)}%</span>` : '<span class="text-gray-600">-</span>'}
            </div>
            <div class="text-right flex flex-col leading-tight">
                ${bVotNextVp > 0 ? `<span class="text-purple-200 font-mono text-[10px]">${fmtVp(bVotNextVp)}</span><span class="text-purple-200/70 font-mono text-[9px]">${bVotNextPct.toFixed(2)}%</span>` : '<span class="text-gray-600">-</span>'}
            </div>
            <div class="text-right flex flex-col leading-tight">
                ${(() => {
                    let changeVp = bVotNextVp - bVotNowVp;
                    let changePct = bVotNextPct - bVotNowPct;
                    if (changeVp === 0 && bVotNowVp === 0) return '<span class="text-gray-600">-</span>';
                    let color = changeVp > 0 ? 'text-green-400' : changeVp < 0 ? 'text-red-400' : 'text-gray-500';
                    let sign = changeVp > 0 ? '+' : '';
                    return `<span class="${color} font-mono text-[10px]">${sign}${fmtVp(changeVp)}</span><span class="${color}/70 font-mono text-[9px]">${sign}${changePct.toFixed(2)}%</span>`;
                })()}
            </div>
            <div class="text-right font-mono text-[11px] text-green-400">${fmt$(bIncentives)}</div>
            <div></div>
            <div class="text-right flex flex-col leading-tight">
                <span class="text-orange-300 font-mono text-[11px]">${bTlaVp.toLocaleString()}</span>
                <span class="text-orange-300/70 font-mono text-[10px]">${bVoteShare.toFixed(2)}%</span>
            </div>
            <div class="text-right flex flex-col leading-tight adao-col" style="${showADAO ? '' : 'display:none;'}">
                <span class="text-cyan-300 font-mono text-[11px]">${bAdaoVp.toLocaleString()}</span>
                <span class="text-cyan-300/70 font-mono text-[10px]">${bAdaoShare.toFixed(2)}%</span>
            </div>
            <div class="text-right font-mono text-[11px] ${getScoreColor(avgScore)}">Avg: ${avgScore.toFixed(0)}</div>
        </div>`;
    });

    setHtml('vote-list', finalHtml);
}

function showIncentives(bucketName) {
    setTxt('mod-inc-bucket-title', "Incentives Breakdown (All Buckets)");
    let html = '';
    let totalInc = 0;
    
    BUCKET_ORDER.forEach(bn => {
        let bucketPools = store.vote.pools.filter(p => p.b === bn && p.inc > 0).sort((a, b) => b.inc - a.inc);
        if (bucketPools.length > 0) {
            html += `<div class="text-[9px] font-bold text-gray-500 uppercase border-b border-gray-800 mt-3 mb-1 px-1">${bn}</div>`;
            bucketPools.forEach(p => {
                totalInc += p.inc;
                html += `<div class="grid grid-cols-12 gap-1 border-b border-gray-800 py-1 hover:bg-gray-800/50 px-1">
                    <div class="col-span-5 truncate text-white" title="${p.n}">${p.n}</div>
                    <div class="col-span-2 text-right text-purple-400">-</div>
                    <div class="col-span-2 text-right text-green-400 font-bold">${fmt$(p.inc)}</div>
                    <div class="col-span-3 text-right text-blue-400">${p.apr}</div>
                </div>`;
            });
        }
    });
    
    if (!html) html = '<div class="text-center text-gray-500 py-4">No incentives found.</div>';
    html += `<div class="grid grid-cols-12 gap-1 text-[9px] text-white uppercase font-bold border-t border-gray-700 pt-2 mt-2 bg-gray-900/90 p-2 rounded">
        <div class="col-span-5">TOTAL</div><div class="col-span-2"></div>
        <div class="col-span-2 text-right text-green-400">${fmt$(totalInc)}</div><div class="col-span-3"></div>
    </div>`;

    setHtml('mod-inc-content', html);
    togModal('incentives', 1);
}

function parseVoteRewards() {
    let txt = $('voteRewardsPaste').value;
    let lines = txt.split('\n').map(x => x.trim()).filter(x => x);
    
    store.dao.vRew = {};
    store.dao.vRewPeriods = [];
    
    let skipNext = false; // Skip lines after "Tx fee"
    let expectPeriods = false; // Next line contains period numbers
    
    lines.forEach(x => {
        // Skip "Tx fee" section
        if (x.includes('Tx fee')) {
            skipNext = true;
            return;
        }
        if (skipNext && /LUNA/.test(x)) {
            skipNext = false;
            return; // Skip the fee amount line
        }
        skipNext = false;
        
        // Skip headers and buttons
        if (x.includes('Claim') || x.includes('Claiming') || x.includes('participating')) return;
        
        // Check for "Periods" label - next line or same line has the numbers
        if (/^Periods?$/i.test(x)) {
            expectPeriods = true;
            return;
        }
        
        // Parse periods - could be on its own line after "Periods" label
        // Handles: "164" or "164, 165, 166" or "164,165,166"
        if (expectPeriods || /^\d+(,\s*\d+)*$/.test(x)) {
            let nums = x.match(/\d+/g);
            if (nums) {
                store.dao.vRewPeriods = nums.map(n => parseInt(n)).filter(n => !isNaN(n));
            }
            expectPeriods = false;
            return;
        }
        
        // Parse reward lines: "11 891.29 ASTRO" or "0.00013 wBTC.atom" or "15.06M ROAR" or "287.00 LUNA"
        // Handle spaces in numbers and M/K suffixes
        let m = x.match(/^([\d\s,]+\.?\d*)\s*([MKmk])?\s+([a-zA-Z][a-zA-Z0-9\.]+)/);
        if (m) {
            let numStr = m[1].replace(/[\s,]/g, ''); // Remove spaces and commas from number
            let val = parseFloat(numStr);
            let suffix = m[2]?.toUpperCase();
            let token = m[3];
            
            // Handle M/K suffix
            if (suffix === 'M') val *= 1e6;
            if (suffix === 'K') val *= 1e3;
            
            if (!isNaN(val) && val > 0) {
                store.dao.vRew[token] = val;
            }
        }
    });
    
    // Update modal - Periods display
    updateVoteRewardsModal();
    
    // Mark as parsed
    pasteStatus.voteRew = true;
    updatePasteStatus('ps-vote-rew', true);
    updateAllTabStatuses();
}

function updateVoteRewardsModal() {
    // Periods display
    if (store.dao.vRewPeriods.length > 0) {
        let first = Math.min(...store.dao.vRewPeriods);
        let last = Math.max(...store.dao.vRewPeriods);
        let count = store.dao.vRewPeriods.length;
        
        // Format display based on count
        if (count === 1) {
            setTxt('mod-vote-periods', `${first}`);
            setTxt('mod-vote-epoch-count', `1 Epoch Unclaimed`);
        } else if (last - first + 1 === count) {
            // Consecutive range
            setTxt('mod-vote-periods', `${first} - ${last}`);
            setTxt('mod-vote-epoch-count', `${count} Epochs Unclaimed`);
        } else {
            // Non-consecutive
            setTxt('mod-vote-periods', store.dao.vRewPeriods.join(', '));
            setTxt('mod-vote-epoch-count', `${count} Epochs Unclaimed`);
        }
    } else {
        setTxt('mod-vote-periods', '-');
        setTxt('mod-vote-epoch-count', '-');
    }
    
    // Token list with USD values from ext file
    let totalUsd = 0;
    let html = Object.entries(store.dao.vRew).map(([token, amount]) => {
        // Get price from ext file
        let price = 0;
        let tokenKey = token.toUpperCase();
        if (store.extFile.tokenPrices && store.extFile.tokenPrices[tokenKey]) {
            price = store.extFile.tokenPrices[tokenKey].price || 0;
        }
        let usd = amount * price;
        totalUsd += usd;
        
        // Format with appropriate decimals
        let formatted = amount < 1 ? amount.toFixed(6) : amount.toLocaleString(undefined, {maximumFractionDigits: 2});
        let usdStr = price > 0 ? `<span class="text-green-400">$${usd.toLocaleString(undefined, {maximumFractionDigits: 2})}</span>` : '<span class="text-gray-600">-</span>';
        
        return `<div class="flex justify-between items-center py-1 border-b border-gray-800">
            <span class="text-white">${token}</span>
            <div class="text-right">
                <span class="font-mono">${formatted}</span>
                <span class="text-[10px] ml-2">${usdStr}</span>
            </div>
        </div>`;
    }).join('');
    
    // Add total row
    if (totalUsd > 0) {
        html += `<div class="flex justify-between items-center py-2 mt-2 border-t-2 border-cyan-800 font-bold">
            <span class="text-cyan-400">TOTAL</span>
            <span class="text-green-400">$${totalUsd.toLocaleString(undefined, {maximumFractionDigits: 2})}</span>
        </div>`;
    }
    
    setHtml('mod-vote-list', html || '<div class="text-gray-600 italic">No rewards found</div>');
}

// === LIQUIDITY PARSING ===
function parseLiquidity() {
    let txt = $('liqFullPage').value;
    let isInactive = $('liqInactiveToggle').checked;
    
    // Auto-detect inactive pools from pasted text
    // If text contains "INACTIVE POOLS" header, treat as inactive
    if (txt.match(/INACTIVE\s*POOLS/i)) {
        isInactive = true;
        $('liqInactiveToggle').checked = true;
        console.log('Auto-detected INACTIVE POOLS in paste');
    }
    
    let lines = txt.split('\n').map(l => l.trim());

    if (!isInactive) {
        let m;
        if (m = txt.match(/TVL[\s\n]+([$\d\.\,\s]+[KkMm]?)/i)) store.tla.tvl = parseNum(m[1]);
        if (m = txt.match(/Rewards per year[\s\n]+([$\d\.\,\s]+[KkMm]?)/i)) store.tla.rewYr = parseNum(m[1]);
        if (m = txt.match(/(Your|Total) Deposit[\s\n]*([$\d\.,\s]+)/i)) {
            store.dao.depTla = parseNum(m[2]);
            store.dao.dep = store.dao.depTla; // Default to TLA value
            store.dao.depSource = 'TLA Site';
        }
        if (m = txt.match(/(est\. APR|Avg APR)[\s\n]*([\d\.]+)\s*%/i)) {
            store.dao.apr = parseFloat(m[2]);
        }
        
        // Parse unclaimed rewards - format: "Rewards\n406.82$" or "Rewards\n$ 406.82"
        if (m = txt.match(/Rewards[\s\n]+([\d\s\.,]+)\s*\$/i)) {
            store.dao.rew.usd = parseNum(m[1]);
        } else if (m = txt.match(/Rewards[\s\n]+\$\s*([\d\s\.,]+)/i)) {
            store.dao.rew.usd = parseNum(m[1]);
        }
    }

    let parsedPools = [];
    lines.forEach((l, i) => {
        // Match DEX line format: "Astroport - pcl" or "WhiteWhale - stable" or "Skeleton Swap - xyk"
        // Include all variants of White Whale / Skeleton Swap
        if (l.match(/^(Astroport|WhiteWhale|White\s*Whale|Skeleton\s*Swap|SkeletonSwap|Single)/i)) {
            let dexParts = l.split('-').map(x => x.trim());
            let dexRaw = dexParts[0];
            let dex = normalizeDexName(dexRaw); // Normalize to "Skeleton Swap" if WhiteWhale
            let lpType = dexParts[1]?.toLowerCase() || '?';
            
            // Normalize LP type
            if (lpType.includes('pcl')) lpType = 'pcl';
            else if (lpType.includes('stable')) lpType = 'stable';
            else if (lpType.includes('xyk')) lpType = 'xyk';
            else if (lpType.includes('concentrated')) lpType = 'pcl';
            
            let poolName = lines[i-1]?.trim() || '';
            if (!poolName || /^icon/i.test(poolName)) return;
            
            // Normalize pool name for matching
            let normName = normalizeName(poolName.replace(' LP', ''));
            
            // Find bucket from vote data
            let bucket = 'UNKNOWN';
            
            // Single-sided pools go to SINGLE bucket
            if (dex === 'Single' || dex === 'Single (Astroport)' || lpType === 'single') {
                bucket = 'SINGLE';
            } else {
                // Use helper functions to match DEX - handles both WhiteWhale and Skeleton Swap
                let votePool = store.vote.pools.find(vp => {
                    if (vp.n !== normName) return false;
                    // Both should be Skeleton Swap after normalization
                    if (isSkeletonSwap(dex) && isSkeletonSwap(vp.d)) return true;
                    if (isAstroport(dex) && isAstroport(vp.d)) return true;
                    return false;
                });
                if (votePool) bucket = votePool.b;
            }
            
            let p = { 
                name: poolName, 
                normName: normName,
                dex: dex,  // Already normalized above
                type: lpType, 
                bucket: bucket,
                depth: 0, 
                stk: 0, 
                aprNon: 0,      // Non-amplified APR
                aprAmp: 0,      // Amplified APR
                rYr: 0,         // Rewards per year
                adaoNon: 0,     // Non-amp aDAO deposit
                adaoAmp: 0,     // Amplified aDAO deposit
                inactive: isInactive 
            };
            
            let foundDepth = false;
            let foundStk = false;
            let foundRewards = false;
            let adaoDeposits = [];
            
            for (let k = 1; k < 20; k++) {
                // Stop at next pool - include all DEX variants
                if (lines[i+k+1]?.match(/^(Astroport|WhiteWhale|White\s*Whale|Skeleton\s*Swap|SkeletonSwap|Single)/i)) break;
                let nl = lines[i+k];
                if (!nl) continue;
                
                // Depth line
                if (nl.startsWith('Depth')) {
                    p.depth = parseNum(nl);
                    foundDepth = true;
                    continue;
                }
                
                // TLA Staked - first $ after Depth (not Rewards line)
                if (foundDepth && !foundStk && nl.startsWith('$') && !nl.includes('Rewards')) {
                    p.stk = parseNum(nl);
                    foundStk = true;
                    continue;
                }
                
                // APR with % = Non-amplified (e.g., "54.09 %")
                if (foundStk && !foundRewards && nl.match(/^[\d\s\.]+%$/)) {
                    p.aprNon = parseFloat(nl.replace(/[^\d\.]/g, ''));
                    continue;
                }
                
                // APR without % = Amplified (e.g., "70.20" - just a number, possibly with spaces)
                if (foundStk && !foundRewards && nl.match(/^[\d\s\.]+$/) && !nl.startsWith('$')) {
                    let val = parseFloat(nl.replace(/\s/g, ''));
                    if (val > 0 && val < 500) { // Reasonable APR range
                        p.aprAmp = val;
                    }
                    continue;
                }
                
                // Rewards line
                if (nl.startsWith('Rewards')) {
                    p.rYr = parseNum(nl);
                    foundRewards = true;
                    continue;
                }
                
                // aDAO deposits - $ lines after Rewards
                if (foundRewards && nl.match(/^\$\s*[\d\s\.,]+/)) {
                    adaoDeposits.push(parseNum(nl));
                    continue;
                }
                
                // Stop at Deposit/Amplify buttons
                if (nl === 'Deposit' || nl === 'Amplify') break;
            }
            
            // Assign aDAO deposits based on APR types found
            if (adaoDeposits.length > 0) {
                if (p.aprNon > 0 && p.aprAmp > 0) {
                    // Both APR types: first is non-amp, second is amp
                    p.adaoNon = adaoDeposits[0] || 0;
                    p.adaoAmp = adaoDeposits[1] || 0;
                } else if (p.aprNon > 0) {
                    // Only non-amp APR: deposit is non-amp
                    p.adaoNon = adaoDeposits[0] || 0;
                } else if (p.aprAmp > 0) {
                    // Only amp APR: deposit is amp
                    p.adaoAmp = adaoDeposits[0] || 0;
                } else {
                    // Fallback: assume non-amp
                    p.adaoNon = adaoDeposits[0] || 0;
                }
            }
            
            if (p.depth > 0 || p.stk > 0) parsedPools.push(p);
        }
    });
    
    if (isInactive) {
        store.tla.inactivePools = parsedPools;
        pasteStatus.liqInactive = true;
        updatePasteStatus('ps-liq-inactive', true);
        console.log('Parsed INACTIVE pools:', parsedPools.length);
        // Ensure we DON'T reset active status when parsing inactive
        if (pasteStatus.liqActive) {
            updatePasteStatus('ps-liq-active', true);
        }
    } else {
        store.tla.pools = parsedPools;
        pasteStatus.liqActive = true;
        updatePasteStatus('ps-liq-active', true);
        console.log('Parsed ACTIVE pools:', parsedPools.length, '- liqActive set to true');
        // Ensure we DON'T reset inactive status when parsing active
        if (pasteStatus.liqInactive) {
            updatePasteStatus('ps-liq-inactive', true);
        }
    }
    
    // Force update tab statuses and score button
    updateAllTabStatuses();
    updateScoreButtonVisibility();
    
    renderLiquidityTable();
    
    // Re-apply ext data to update APR on vote pools
    if (store.ext.loaded) {
        applyExtDataToPools();
        renderVoteTable();
    }
}

function renderLiquidityTable() {
    setTxt('tla-tvl', fmt$(store.tla.tvl));
    setTxt('tla-rew', fmt$(store.tla.rewYr));
    setTxt('tla-rew-ep', fmt$(store.tla.rewYr / 52));
    
    // Update deposit display
    updateDepositDisplay();
    
    // Update APR display
    setTxt('dao-apr', (store.dao.apr || 0).toFixed(2) + '%');
    setTxt('dao-usd', fmt$(store.dao.rew.usd || 0));
    
    // Use arrays directly - don't combine and re-filter
    let activePools = [...(store.tla.pools || [])];
    let inactivePools = [...(store.tla.inactivePools || [])];
    
    // Calculate DEX stats from active pools only
    let dexStats = {
        astro: { count: 0, depth: 0, stk: 0 },
        ww: { count: 0, depth: 0, stk: 0 }
    };
    
    activePools.forEach(p => {
        if (isAstroport(p.dex)) {
            dexStats.astro.count++;
            dexStats.astro.depth += p.depth;
            dexStats.astro.stk += p.stk;
        } else if (isSkeletonSwap(p.dex)) {
            dexStats.ww.count++;
            dexStats.ww.depth += p.depth;
            dexStats.ww.stk += p.stk;
        }
    });
    
    // Update DEX stat displays
    setTxt('liq-astro-active', dexStats.astro.count);
    setTxt('liq-astro-depth', fmt$(dexStats.astro.depth));
    setTxt('liq-astro-stk', fmt$(dexStats.astro.stk));
    setTxt('liq-astro-pct', dexStats.astro.depth > 0 ? ((dexStats.astro.stk / dexStats.astro.depth) * 100).toFixed(1) + '%' : '0%');
    
    setTxt('liq-ww-active', dexStats.ww.count);
    setTxt('liq-ww-depth', fmt$(dexStats.ww.depth));
    setTxt('liq-ww-stk', fmt$(dexStats.ww.stk));
    setTxt('liq-ww-pct', dexStats.ww.depth > 0 ? ((dexStats.ww.stk / dexStats.ww.depth) * 100).toFixed(1) + '%' : '0%');
    
    // Calculate % of TVL for each DEX
    let totalDexStk = dexStats.astro.stk + dexStats.ww.stk;
    setTxt('liq-astro-tvl', totalDexStk > 0 ? ((dexStats.astro.stk / totalDexStk) * 100).toFixed(1) + '%' : '0%');
    setTxt('liq-ww-tvl', totalDexStk > 0 ? ((dexStats.ww.stk / totalDexStk) * 100).toFixed(1) + '%' : '0%');
    
    // Sort active by bucket, then alphabetically within bucket
    activePools.sort((a, b) => {
        let biA = BUCKET_ORDER.indexOf(a.bucket); if (biA === -1) biA = 99;
        let biB = BUCKET_ORDER.indexOf(b.bucket); if (biB === -1) biB = 99;
        if (biA !== biB) return biA - biB;
        return a.name.localeCompare(b.name);
    });
    
    // Sort inactive by TLA Staked (stk) descending - most deposits first
    inactivePools.sort((a, b) => (b.stk || 0) - (a.stk || 0));
    
    let html = '';
    let grandTotals = { depth: 0, stk: 0, rYr: 0, adaoNon: 0, adaoAmp: 0 };
    
    // Render active pools by bucket with subtotals
    let currentBucket = null;
    let bucketPools = [];
    
    const renderBucketSubtotal = (bucket, pools) => {
        let totals = pools.reduce((acc, p) => {
            acc.depth += p.depth;
            acc.stk += p.stk;
            acc.rYr += p.rYr;
            acc.adaoNon += p.adaoNon || 0;
            acc.adaoAmp += p.adaoAmp || 0;
            return acc;
        }, { depth: 0, stk: 0, rYr: 0, adaoNon: 0, adaoAmp: 0 });
        
        let tlaPct = totals.depth > 0 ? ((totals.stk / totals.depth) * 100) : 0;
        
        // Add to grand totals
        grandTotals.depth += totals.depth;
        grandTotals.stk += totals.stk;
        grandTotals.rYr += totals.rYr;
        grandTotals.adaoNon += totals.adaoNon;
        grandTotals.adaoAmp += totals.adaoAmp;
        
        return `<div class="liq-grid bg-gray-800/60 border-t border-gray-600 py-1.5 px-2">
            <div class="text-[11px] text-gray-400 font-bold">${bucket} Total</div>
            <div></div><div></div>
            <div class="text-right font-mono text-[11px] text-gray-300">${fmt$(totals.depth)}</div>
            <div class="text-right font-mono text-[11px] text-orange-300">${fmt$(totals.stk)}</div>
            <div class="text-right font-mono text-[11px] text-orange-200">${tlaPct.toFixed(1)}%</div>
            <div></div><div></div>
            <div class="text-right font-mono text-[11px] text-green-300">${fmt$(totals.rYr)}</div>
            <div class="text-right font-mono text-[11px] text-green-300">${fmt$(totals.rYr / 52)}</div>
            <div class="text-right font-mono text-[11px] text-cyan-300">${totals.adaoNon > 0 ? fmt$(totals.adaoNon) : '-'}</div>
            <div class="text-right font-mono text-[11px] text-yellow-300">${totals.adaoAmp > 0 ? fmt$(totals.adaoAmp) : '-'}</div>
        </div>`;
    };
    
    activePools.forEach((p, idx) => {
        // New bucket - render previous bucket's subtotal first
        if (p.bucket !== currentBucket) {
            if (currentBucket && bucketPools.length > 0) {
                html += renderBucketSubtotal(currentBucket, bucketPools);
            }
            currentBucket = p.bucket;
            bucketPools = [];
            
            html += `<div class="bg-[#1f2937] border-y border-gray-700 py-1 mt-2 mb-1">
                <div class="flex justify-between items-center px-2">
                    <span class="text-gray-300 font-bold text-[10px] tracking-widest uppercase">${currentBucket}</span>
                </div>
            </div>`;
        }
        
        bucketPools.push(p);
        
        let dexColor = isAstroport(p.dex) ? 'text-blue-500' : (p.dex === 'Single' ? 'text-purple-400' : 'text-green-400');
        let tlaDepthPct = p.depth > 0 ? ((p.stk / p.depth) * 100) : 0;
        
        html += `<div class="liq-grid border-b border-gray-800/50 py-1.5 hover:bg-white/5 px-2">
            <div class="flex flex-col justify-center">
                <span class="text-white text-[12px] font-bold truncate" title="${p.name}">${p.normName || p.name}</span>
            </div>
            <div class="text-center text-[11px] ${dexColor}">${p.dex === 'Single' ? 'Single' : isAstroport(p.dex) ? 'Astroport' : 'Skeleton Swap'}</div>
            <div class="text-center text-[11px] text-gray-500">${p.type}</div>
            <div class="text-right font-mono text-[11px] text-gray-400">${fmt$(p.depth)}</div>
            <div class="text-right font-mono text-[11px] text-orange-400">${fmt$(p.stk)}</div>
            <div class="text-right font-mono text-[11px] text-orange-300">${tlaDepthPct > 0 ? tlaDepthPct.toFixed(1) + '%' : '-'}</div>
            <div class="text-right font-mono text-[11px] text-green-400">${p.aprNon > 0 ? p.aprNon.toFixed(1) + '%' : '-'}</div>
            <div class="text-right font-mono text-[11px] text-yellow-400">${p.aprAmp > 0 ? p.aprAmp.toFixed(1) + '%' : '-'}</div>
            <div class="text-right font-mono text-[11px] text-green-400">${fmt$(p.rYr)}</div>
            <div class="text-right font-mono text-[11px] text-green-400">${fmt$(p.rYr / 52)}</div>
            <div class="text-right font-mono text-[11px] text-cyan-400">${p.adaoNon > 0 ? fmt$(p.adaoNon) : '-'}</div>
            <div class="text-right font-mono text-[11px] text-yellow-400">${p.adaoAmp > 0 ? fmt$(p.adaoAmp) : '-'}</div>
        </div>`;
    });
    
    // Last bucket subtotal
    if (currentBucket && bucketPools.length > 0) {
        html += renderBucketSubtotal(currentBucket, bucketPools);
    }
    
    // Render inactive pools at bottom
    if (inactivePools.length > 0) {
        html += `<div class="bg-red-900/30 border-y border-red-900/50 py-1 mt-4 mb-1">
            <div class="flex justify-between items-center px-2">
                <span class="text-red-400 font-bold text-[10px] tracking-widest uppercase">INACTIVE POOLS (${inactivePools.length})</span>
                <span class="text-[9px] text-gray-500">Sorted by TLA Deposits</span>
            </div>
        </div>`;
        
        let inactiveTotals = { depth: 0, stk: 0, rYr: 0, adaoNon: 0, adaoAmp: 0 };
        
        inactivePools.forEach(p => {
            let dexColor = isAstroport(p.dex) ? 'text-blue-500' : (p.dex === 'Single' ? 'text-purple-400' : 'text-green-400');
            let tlaDepthPct = p.depth > 0 ? ((p.stk / p.depth) * 100) : 0;
            
            inactiveTotals.depth += p.depth;
            inactiveTotals.stk += p.stk;
            inactiveTotals.rYr += p.rYr;
            inactiveTotals.adaoNon += p.adaoNon || 0;
            inactiveTotals.adaoAmp += p.adaoAmp || 0;
            
            html += `<div class="liq-grid border-b border-gray-800/50 py-1.5 hover:bg-white/5 px-2 opacity-60">
                <div class="flex flex-col justify-center">
                    <span class="text-white text-[11px] font-bold truncate" title="${p.name}">${p.normName || p.name}</span>
                    <span class="text-gray-600 text-[9px]">${p.bucket}</span>
                </div>
                <div class="text-center text-[10px] ${dexColor}">${p.dex === 'Single' ? 'Single' : isAstroport(p.dex) ? 'Astro' : 'SS'}</div>
                <div class="text-center text-[10px] text-gray-500">${p.type}</div>
                <div class="text-right font-mono text-[10px] text-gray-400">${fmt$(p.depth)}</div>
                <div class="text-right font-mono text-[10px] text-orange-400">${fmt$(p.stk)}</div>
                <div class="text-right font-mono text-[10px] text-orange-300">${tlaDepthPct > 0 ? tlaDepthPct.toFixed(1) + '%' : '-'}</div>
                <div class="text-right font-mono text-[10px] text-green-400">${p.aprNon > 0 ? p.aprNon.toFixed(1) + '%' : '-'}</div>
                <div class="text-right font-mono text-[10px] text-yellow-400">${p.aprAmp > 0 ? p.aprAmp.toFixed(1) + '%' : '-'}</div>
                <div class="text-right font-mono text-[10px] text-green-400">${fmt$(p.rYr)}</div>
                <div class="text-right font-mono text-[10px] text-green-400">${fmt$(p.rYr / 52)}</div>
                <div class="text-right font-mono text-[10px] text-cyan-400">${p.adaoNon > 0 ? fmt$(p.adaoNon) : '-'}</div>
                <div class="text-right font-mono text-[10px] text-yellow-400">${p.adaoAmp > 0 ? fmt$(p.adaoAmp) : '-'}</div>
            </div>`;
        });
        
        // Inactive subtotal
        let inactivePct = inactiveTotals.depth > 0 ? ((inactiveTotals.stk / inactiveTotals.depth) * 100) : 0;
        html += `<div class="liq-grid bg-red-900/30 border-t border-red-800 py-1.5 px-2">
            <div class="text-[11px] text-red-300 font-bold">Inactive Total</div>
            <div></div><div></div>
            <div class="text-right font-mono text-[11px] text-gray-400">${fmt$(inactiveTotals.depth)}</div>
            <div class="text-right font-mono text-[11px] text-orange-300">${fmt$(inactiveTotals.stk)}</div>
            <div class="text-right font-mono text-[11px] text-orange-200">${inactivePct.toFixed(1)}%</div>
            <div></div><div></div>
            <div class="text-right font-mono text-[11px] text-green-300">${fmt$(inactiveTotals.rYr)}</div>
            <div class="text-right font-mono text-[11px] text-green-300">${fmt$(inactiveTotals.rYr / 52)}</div>
            <div class="text-right font-mono text-[11px] text-cyan-300">${inactiveTotals.adaoNon > 0 ? fmt$(inactiveTotals.adaoNon) : '-'}</div>
            <div class="text-right font-mono text-[11px] text-yellow-300">${inactiveTotals.adaoAmp > 0 ? fmt$(inactiveTotals.adaoAmp) : '-'}</div>
        </div>`;
        
        // Add inactive to grand totals
        grandTotals.depth += inactiveTotals.depth;
        grandTotals.stk += inactiveTotals.stk;
        grandTotals.rYr += inactiveTotals.rYr;
        grandTotals.adaoNon += inactiveTotals.adaoNon;
        grandTotals.adaoAmp += inactiveTotals.adaoAmp;
    }
    
    // Grand Total
    let grandPct = grandTotals.depth > 0 ? ((grandTotals.stk / grandTotals.depth) * 100) : 0;
    html += `<div class="liq-grid bg-indigo-900/50 border-t-2 border-indigo-500 py-2 px-2 mt-3">
        <div class="text-[12px] text-white font-bold uppercase">Grand Total</div>
        <div></div><div></div>
        <div class="text-right font-mono text-[12px] text-white font-bold">${fmt$(grandTotals.depth)}</div>
        <div class="text-right font-mono text-[12px] text-orange-400 font-bold">${fmt$(grandTotals.stk)}</div>
        <div class="text-right font-mono text-[12px] text-orange-300 font-bold">${grandPct.toFixed(1)}%</div>
        <div></div><div></div>
        <div class="text-right font-mono text-[12px] text-green-400 font-bold">${fmt$(grandTotals.rYr)}</div>
        <div class="text-right font-mono text-[12px] text-green-400 font-bold">${fmt$(grandTotals.rYr / 52)}</div>
        <div class="text-right font-mono text-[12px] text-cyan-400 font-bold">${grandTotals.adaoNon > 0 ? fmt$(grandTotals.adaoNon) : '-'}</div>
        <div class="text-right font-mono text-[12px] text-yellow-400 font-bold">${grandTotals.adaoAmp > 0 ? fmt$(grandTotals.adaoAmp) : '-'}</div>
    </div>`;
    
    setHtml('liq-list', html || '<div class="text-gray-500 text-center py-4">No pools parsed. Parse Vote tab first for bucket assignments.</div>');
}

function parseDeposits() {
    let raw = $('liqDeposits').value.trim();
    store.dao.toks = raw.split('\n').map(l => {
        let p = l.trim().split(/\s+/);
        if (p.length < 2) return null;
        let val = parseFloat(p[0]);
        return isNaN(val) ? { s: p[0], a: parseNum(p[1]) } : { s: p[1], a: parseNum(p[0]) };
    }).filter(x => x);
    
    // Render tokens with USD values from ext file
    renderTokensModal();
    
    pasteStatus.liqDep = true;
    updatePasteStatus('ps-liq-dep', true);
}

// Render tokens modal with USD values
function renderTokensModal() {
    if (!store.dao.toks || store.dao.toks.length === 0) {
        setHtml('mod-tok-list', '<div class="text-gray-500 italic">No tokens parsed</div>');
        return;
    }
    
    let totalUsd = 0;
    let html = store.dao.toks.map(t => {
        // Get price from ext file - try multiple lookups
        let price = getTokenPrice(t.s);
        
        let usd = t.a * price;
        totalUsd += usd;
        
        let amountStr = typeof t.a === 'number' ? t.a.toLocaleString(undefined, {maximumFractionDigits: 3}) : t.a;
        let usdStr = price > 0 ? `<span class="text-green-400">$${usd.toLocaleString(undefined, {maximumFractionDigits: 2})}</span>` : '<span class="text-gray-600">-</span>';
        
        return `<div class="flex justify-between items-center py-1 border-b border-gray-800">
            <span class="text-gray-400">${t.s}</span>
            <div class="text-right">
                <span class="font-mono text-white">${amountStr}</span>
                <span class="text-[10px] ml-2">${usdStr}</span>
            </div>
        </div>`;
    }).join('');
    
    // Add total row
    if (totalUsd > 0) {
        html += `<div class="flex justify-between items-center py-2 mt-2 border-t-2 border-cyan-800 font-bold">
            <span class="text-cyan-400">TOTAL</span>
            <span class="text-green-400 text-sm">$${totalUsd.toLocaleString(undefined, {maximumFractionDigits: 2})}</span>
        </div>`;
    }
    
    setHtml('mod-tok-list', html);
    
    // Store calculated value and update display
    store.dao.depCalc = totalUsd;
    updateDepositDisplay();
}

// Get token price from ext file (handles case and aliases)
function getTokenPrice(symbol) {
    if (!store.extFile.tokenPrices) return 0;
    
    // Normalize symbol using aliases
    let normalized = normalizeAssetName(symbol);
    let upper = symbol.toUpperCase();
    let normalizedUpper = normalized.toUpperCase();
    
    // Try exact match first
    if (store.extFile.tokenPrices[symbol]?.price) return store.extFile.tokenPrices[symbol].price;
    if (store.extFile.tokenPrices[normalized]?.price) return store.extFile.tokenPrices[normalized].price;
    if (store.extFile.tokenPrices[upper]?.price) return store.extFile.tokenPrices[upper].price;
    if (store.extFile.tokenPrices[normalizedUpper]?.price) return store.extFile.tokenPrices[normalizedUpper].price;
    
    return 0;
}

// Use calculated deposit value
function useCalculatedDeposit() {
    store.dao.dep = store.dao.depCalc;
    store.dao.depSource = 'Calculated';
    updateDepositDisplay();
}

// Use TLA deposit value
function useTlaDeposit() {
    store.dao.dep = store.dao.depTla;
    store.dao.depSource = 'TLA Site';
    updateDepositDisplay();
}

// Update deposit display
function updateDepositDisplay() {
    setTxt('dao-dep-tla', fmt$(store.dao.depTla || 0));
    setTxt('dao-dep-calc', fmt$(store.dao.depCalc || 0));
    
    // Calculate difference
    let diff = (store.dao.depTla || 0) - (store.dao.depCalc || 0);
    let diffStr = (diff >= 0 ? '+' : '') + fmt$(diff);
    let diffColor = Math.abs(diff) < 100 ? 'text-gray-500' : diff > 0 ? 'text-yellow-400' : 'text-red-400';
    let diffEl = $('dao-dep-diff');
    if (diffEl) {
        diffEl.textContent = diffStr;
        diffEl.className = 'font-mono ' + diffColor;
    }
    
    setTxt('dao-dep-source', store.dao.depSource || '--');
    
    // Show APR edit button if APR is 0
    let aprEditBtn = $('dao-apr-edit');
    if (aprEditBtn) {
        if (store.dao.apr === 0 || !store.dao.apr) {
            aprEditBtn.classList.remove('hidden');
        } else {
            aprEditBtn.classList.add('hidden');
        }
    }
}

// Manual APR entry
function manualAprEntry() {
    let current = store.dao.apr || 0;
    let input = prompt('Enter Avg APR %:', current.toString());
    if (input !== null) {
        let val = parseFloat(input);
        if (!isNaN(val) && val >= 0) {
            store.dao.apr = val;
            setTxt('dao-apr', val.toFixed(2) + '%');
            $('dao-apr-edit')?.classList.add('hidden');
        }
    }
}

function parseRewards() {
    let txt = $('liqRewards').value;
    let zMatch = txt.match(/zAssets\s*([\d\s\.,]+)/); if (zMatch) store.dao.rew.z = parseNum(zMatch[1]);
    let ampMatch = txt.match(/Received\s*([\d\s\.,]+)\s*ampLUNA/); if (ampMatch) store.dao.rew.amp = parseNum(ampMatch[1]);
    setTxt('dao-rew-z', store.dao.rew.z.toLocaleString());
    setTxt('dao-rew-amp', store.dao.rew.amp.toLocaleString());
    
    pasteStatus.liqRew = true;
    updatePasteStatus('ps-liq-rew', true);
}

// === LOCKS PARSING ===
function parseLocks() {
    let t = $('locksPaste').value;
    
    // Parse VP - handle spaces in numbers
    let vpMatch = t.match(/Your Voting Power\s*([\d\.\s,KkMm]+)\s*VP/);
    if (vpMatch) store.dao.lVp = parseNum(vpMatch[1]);
    
    // Parse factor & assets
    let facMatch = t.match(/Power Factor\s*([\d\.]+)\s*x/i);
    if (facMatch) store.dao.lFac = parseFloat(facMatch[1]);
    
    // Parse underlying assets - handle ~63.88K__LUNA__ format
    let astMatch = t.match(/Underlying Assets\s*~?([\d\.\s,KkMm]+)/i);
    if (astMatch) store.dao.lAst = parseNum(astMatch[1]);
    
    store.dao.locks = [];
    let chunks = t.split(/Lock #/i);
    for (let i = 1; i < chunks.length; i++) {
        let c = chunks[i];
        let idMatch = c.match(/^(\d+)/);
        if (!idMatch) continue;
        
        let id = idMatch[1];
        let amtMatch = c.match(/([\d\.\s,]+[KkMm]?)\s+(arbLUNA|ampLUNA|bLUNA|LUNA)/);
        let amt = amtMatch ? parseNum(amtMatch[1]) : 0;
        let asset = amtMatch ? amtMatch[2] : 'Unknown';
        
        // Determine bucket from asset type
        let bucket = 'LUNA';
        if (asset === 'arbLUNA') bucket = 'arbLUNA';
        else if (asset === 'ampLUNA') bucket = 'ampLUNA';
        else if (asset === 'bLUNA') bucket = 'bLUNA';
        
        let vpMatchC = c.match(/([\d\.\s,]+[KkMm]?)\s*VP/);
        let vp = vpMatchC ? parseNum(vpMatchC[1]) : 0;
        
        // Handle European number format: $ 4 968.73 (spaces in numbers)
        let usdMatch = c.match(/\$\s*([\d\s,\.]+)/);
        let usd = usdMatch ? parseNum(usdMatch[1]) : 0;
        
        let status = c.toLowerCase().includes('auto max-lock') ? "Max Lock (Auto)" : "Manual";
        store.dao.locks.push({ id, amt, asset, bucket, vp, usd, status });
    }
    
    pasteStatus.locks = true;
    updatePasteStatus('ps-locks', true);
    renderLocks();
}

function renderLocks() {
    // Update header stats
    setTxt('locks-vp', store.dao.lVp.toLocaleString() + ' VP');
    setTxt('locks-factor', store.dao.lFac ? store.dao.lFac.toFixed(2) + 'x' : '-');
    setTxt('locks-assets', store.dao.lAst ? store.dao.lAst.toLocaleString() + ' LUNA' : '-');
    
    // Group locks by bucket
    const LOCK_BUCKETS = ['arbLUNA', 'ampLUNA', 'bLUNA', 'LUNA'];
    let html = '';
    let grandTotals = { amt: 0, usd: 0, vp: 0 };
    
    LOCK_BUCKETS.forEach(bucket => {
        let bucketLocks = store.dao.locks.filter(l => l.bucket === bucket);
        if (bucketLocks.length === 0) return;
        
        // Bucket header
        let bucketColor = bucket === 'arbLUNA' ? 'text-orange-400' : 
                          bucket === 'ampLUNA' ? 'text-cyan-400' : 
                          bucket === 'bLUNA' ? 'text-green-400' : 'text-purple-400';
        
        html += `<div class="bg-[#1f2937] border-y border-gray-700 py-1 mt-2 mb-1">
            <div class="px-2">
                <span class="${bucketColor} font-bold text-[10px] tracking-widest uppercase">${bucket}</span>
                <span class="text-gray-500 text-[9px] ml-2">(${bucketLocks.length} lock${bucketLocks.length > 1 ? 's' : ''})</span>
            </div>
        </div>`;
        
        let bucketTotals = { amt: 0, usd: 0, vp: 0 };
        
        bucketLocks.forEach(l => {
            bucketTotals.amt += l.amt;
            bucketTotals.usd += l.usd;
            bucketTotals.vp += l.vp;
            
            html += `<div class="grid grid-cols-12 gap-2 text-[10px] border-b border-gray-800/50 py-1 hover:bg-white/5 px-1">
                <div class="col-span-1 text-purple-400 font-bold">#${l.id}</div>
                <div class="col-span-2 text-gray-500 text-[9px]">${l.status}</div>
                <div class="col-span-3 text-white font-mono">${l.amt.toLocaleString()} <span class="${bucketColor}">${l.asset}</span></div>
                <div class="col-span-3 text-right text-green-400 font-mono">${fmt$(l.usd)}</div>
                <div class="col-span-3 text-right text-white font-bold font-mono">${l.vp.toLocaleString()} VP</div>
            </div>`;
        });
        
        // Bucket subtotal
        html += `<div class="grid grid-cols-12 gap-2 text-[9px] bg-gray-800/50 py-1 px-1 border-t border-gray-600">
            <div class="col-span-3 text-gray-400 font-bold">${bucket} Total</div>
            <div class="col-span-3 text-gray-300 font-mono">${bucketTotals.amt.toLocaleString()}</div>
            <div class="col-span-3 text-right text-green-300 font-mono">${fmt$(bucketTotals.usd)}</div>
            <div class="col-span-3 text-right text-gray-300 font-bold font-mono">${bucketTotals.vp.toLocaleString()} VP</div>
        </div>`;
        
        grandTotals.amt += bucketTotals.amt;
        grandTotals.usd += bucketTotals.usd;
        grandTotals.vp += bucketTotals.vp;
    });
    
    // Grand total
    if (store.dao.locks.length > 0) {
        html += `<div class="grid grid-cols-12 gap-2 text-[10px] bg-indigo-900/50 py-2 px-1 mt-3 border-t-2 border-indigo-500">
            <div class="col-span-6 text-white font-bold uppercase">Grand Total</div>
            <div class="col-span-3 text-right text-green-400 font-mono font-bold">${fmt$(grandTotals.usd)}</div>
            <div class="col-span-3 text-right text-white font-bold font-mono">${grandTotals.vp.toLocaleString()} VP</div>
        </div>`;
    }
    
    setHtml('locks-list', html || '<div class="text-center text-gray-600 italic text-xs pt-10">No locks parsed yet...</div>');
}

// === GLOBAL ACTIONS ===
function clearAll() {
    if (confirm("Clear all data?")) location.reload();
}

function getPhaseString() {
    if (!currentEpochInfo) return 'unknown';
    let now = new Date();
    let endTime = new Date(currentEpochInfo.end_time);
    let daysLeft = (endTime - now) / 86400000;
    if (daysLeft >= 5) return 'start';
    if (daysLeft > 2) return 'mid';
    return 'end';
}

function buildExportData() {
    // Get export filter settings
    let exportAstro = $('export-astro')?.checked ?? true;
    let exportWW = $('export-ww')?.checked ?? true;
    let exportInactive = $('export-inactive')?.checked ?? true;
    let exportAdao = $('export-adao')?.checked ?? true;
    
    // Filter pools based on export settings
    let exportPools = store.vote.pools.filter(p => {
        let isAct = p.vps >= 1;
        let isAstroOrSingle = isAstroport(p.d);
        let isWW = isSkeletonSwap(p.d);
        
        if (isAstroOrSingle && !exportAstro) return false;
        if (isWW && !exportWW) return false;
        if (!isAct && !exportInactive) return false;
        return true;
    });
    
    // Determine epoch and phase - use manual mode if active
    let exportEpoch = manualMode.active ? manualMode.epoch : store.vote.ep;
    let exportPhase = manualMode.active ? manualMode.phase : getPhaseString();
    let exportTimestamp = manualMode.active ? manualMode.timestamp : new Date().toISOString();
    
    // Build token prices from ext file
    let tokenPrices = {};
    if (store.extFile.tokenPrices) {
        Object.entries(store.extFile.tokenPrices).forEach(([token, data]) => {
            tokenPrices[token] = {
                price: data.price || 0,
                source: data.source || 'unknown'
            };
        });
    }
    
    // ============================================
    // BUILD STRUCTURED EXPORT DATA
    // ============================================
    
    return {
        // ========== META ==========
        meta: {
            version: '3.0',
            epoch: exportEpoch,
            phase: exportPhase,
            generated_at: exportTimestamp,
            source: 'TLA Admin Core v3',
            export_filters: {
                astroport: exportAstro,
                skeleton_swap: exportWW,
                inactive: exportInactive,
                adao_allocations: exportAdao
            },
            fallback_used: {
                dao_data: fallbackStatus.daoData,
                vote_rewards: fallbackStatus.voteRewards,
                locks: fallbackStatus.locks,
                unclaimed: fallbackStatus.unclaimed,
                adao_votes: fallbackStatus.adaoVotes,
                source_epoch: lastEpochInfo.epoch || null,
                comments: fallbackOverrides.comments || {}
            },
            unknown_data: Object.keys(unknownSections).length > 0 ? {
                sections: unknownSections,
                fields: Object.keys(unknownFieldsMap)
            } : null,
            manual_edit: manualMode.active ? {
                is_manual: true,
                edited_at: new Date().toISOString(),
                original_epoch: manualMode.originalEpochInfo?.epoch || null
            } : null
        },
        
        // ========== SECTION 1: VOTE ==========
        vote: {
            summary: {
                epoch: exportEpoch,
                total_vp: store.vote.tvp,
                rebase_amp: store.vote.reb,
                rewards_usd: store.vote.usd,
                end_time: store.vote.end,
                pool_count: exportPools.length,
                total_pool_count: store.vote.pools.length
            },
            dex_breakdown: {
                astroport: {
                    active_count: exportPools.filter(p => isAstroport(p.d) && p.vps >= 1).length,
                    inactive_count: exportPools.filter(p => isAstroport(p.d) && p.vps < 1).length,
                    total_depth: exportPools.filter(p => isAstroport(p.d)).reduce((s, p) => s + (p.dp || 0), 0),
                    total_vp: exportPools.filter(p => isAstroport(p.d)).reduce((s, p) => s + (p.tvp || 0), 0)
                },
                skeleton_swap: {
                    active_count: exportPools.filter(p => isSkeletonSwap(p.d) && p.vps >= 1).length,
                    inactive_count: exportPools.filter(p => isSkeletonSwap(p.d) && p.vps < 1).length,
                    total_depth: exportPools.filter(p => isSkeletonSwap(p.d)).reduce((s, p) => s + (p.dp || 0), 0),
                    total_vp: exportPools.filter(p => isSkeletonSwap(p.d)).reduce((s, p) => s + (p.tvp || 0), 0)
                }
            },
            pools: exportPools.map(p => ({
                name: p.n,
                dex: p.d.includes('Single') ? 'Single' : isAstroport(p.d) ? 'Astroport' : 'Skeleton Swap',
                dex_raw: p.d,
                bucket: p.b,
                is_active: p.vps >= 1,
                // TLA Vote
                vp: p.tvp,
                vote_pct: p.vps,
                depth: p.dp,
                // aDAO
                adao_vp: p.mvp,
                adao_pct: p.ms,
                // APR
                apr_non: p.aprNon || 0,
                apr_amp: p.aprAmp || 0,
                apr_factor: p.aprFactor || 0,
                // Bribes
                bribes: {
                    total: p.incTotal || 0,
                    pd: p.incPD || 0,
                    other: p.incOther || 0
                },
                // Votion
                votion: {
                    current_vp: p.votNowVp || 0,
                    current_pct: p.votNowPct || 0,
                    next_vp: p.votNextVp || 0,
                    next_pct: p.votNextPct || 0,
                    change_vp: (p.votNextVp || 0) - (p.votNowVp || 0),
                    change_pct: (p.votNextPct || 0) - (p.votNowPct || 0)
                },
                // Historical
                historical: {
                    liq_4ep_avg: p.liq4Ep?.avg || 0,
                    liq_4ep_count: p.liq4Ep?.count || 0,
                    vol_4ep_avg: p.vol4Ep?.avg || 0,
                    vol_4ep_count: p.vol4Ep?.count || 0,
                    efficiency: p.efficiency || 0
                },
                // Scoring
                scores: {
                    access: p.accessScore || 0,
                    performance: p.performanceScore || 0,
                    support: p.supportScore || 0,
                    adao_opportunity: p.adaoScore || 0
                },
                included_in_grade: p.includedInGrade ?? true
            }))
        },
        
        // ========== SECTION 2: LIQUIDITY ==========
        liquidity: {
            summary: {
                tvl: store.tla.tvl || 0,
                rewards_per_year: store.tla.rewYr || 0,
                rewards_per_epoch: (store.tla.rewYr || 0) / 52,
                active_pool_count: store.tla.pools?.length || 0,
                inactive_pool_count: store.tla.inactivePools?.length || 0
            },
            adao_deposits: {
                total_usd: store.dao.dep || 0,
                total_usd_source: store.dao.depSource || 'unknown',
                calculated_usd: store.dao.depCalc || 0,
                avg_apr: store.dao.apr || 0,
                tokens: (store.dao.toks || []).map(t => ({
                    symbol: t.s,
                    amount: t.a,
                    price: getTokenPrice(t.s),
                    usd: t.a * getTokenPrice(t.s)
                }))
            },
            unclaimed_rewards: {
                total_usd: store.dao.rew?.usd || 0,
                zAssets: store.dao.rew?.z || 0,
                ampLUNA: store.dao.rew?.amp || 0
            },
            vote_rewards: {
                by_token: store.dao.vRew || {},
                periods: store.dao.vRewPeriods || []
            },
            active_pools: (store.tla.pools || []).map(p => ({
                name: p.name,
                normalized_name: p.normName,
                dex: p.dex,
                type: p.type,
                bucket: p.bucket,
                depth: p.depth || 0,
                tla_staked: p.stk || 0,
                apr: {
                    non_amp: p.aprNon || 0,
                    amplified: p.aprAmp || 0
                },
                rewards_per_year: p.rYr || 0,
                adao_deposit: {
                    non_amp: p.adaoNon || 0,
                    amplified: p.adaoAmp || 0
                }
            })),
            inactive_pools: (store.tla.inactivePools || []).map(p => ({
                name: p.name,
                normalized_name: p.normName,
                dex: p.dex,
                type: p.type,
                bucket: p.bucket,
                depth: p.depth || 0,
                tla_staked: p.stk || 0,
                apr: {
                    non_amp: p.aprNon || 0,
                    amplified: p.aprAmp || 0
                }
            }))
        },
        
        // ========== SECTION 3: LOCKS ==========
        locks: {
            summary: {
                total_vp: store.dao.lVp || 0,
                power_factor: store.dao.lFac || 0,
                underlying_assets: store.dao.lAst || 0,
                lock_count: store.dao.locks?.length || 0
            },
            individual_locks: (store.dao.locks || []).map(l => ({
                id: l.id,
                amount: l.amt,
                asset: l.asset,
                bucket: l.bucket,
                vp: l.vp,
                usd: l.usd,
                status: l.status
            })),
            allocations: store.vote.pools
                .filter(p => p.mvp > 0)
                .map(p => ({
                    pool: p.n,
                    dex: p.d.includes('Single') ? 'Single' : isAstroport(p.d) ? 'Astroport' : 'Skeleton Swap',
                    bucket: p.b,
                    vp: p.mvp,
                    pct: p.ms
                }))
                .sort((a, b) => b.vp - a.vp)
        },
        
        // ========== SECTION 4: ASSET METADATA ==========
        asset_metadata: {
            summary: {
                asset_count: Object.keys(assetMetadata).length,
                avg_access_score: Object.values(assetMetadata).length > 0 
                    ? Math.round(Object.values(assetMetadata).reduce((s, m) => s + (calculateAccessScore(m) || 0), 0) / Object.values(assetMetadata).length)
                    : 0,
                last_updated_epoch: assetMetadataMeta.last_updated_epoch,
                last_updated_date: assetMetadataMeta.last_updated_date
            },
            assets: Object.fromEntries(
                Object.entries(assetMetadata).map(([name, m]) => [name, {
                    tla_name: m.tla_name,
                    actual_path: m.actual_path,
                    origin: m.origin,
                    acquisition: m.acquisition,
                    cg_status: m.cg_status,
                    skip_clear: m.skip_clear,
                    asset_class: m.asset_class,
                    treasury_value: m.treasury_value,
                    multi_dex: m.multi_dex,
                    naming_accurate: isNamingAccurate(m),
                    access_score: calculateAccessScore(m),
                    last_edited_epoch: m.last_edited_epoch || null
                }])
            )
        },
        
        // ========== SECTION 5: DASHBOARD (Manual/Auto) ==========
        dashboard: buildDashboardData(),
        
        // ========== SECTION 6: NFT STATS (Manual/Auto) ==========
        nft_stats: buildNftStatsData(),
        
        // ========== SECTION 7: DAO GOVERNANCE ==========
        dao_governance: {
            // Placeholder for DAO governance data
            proposals: [],
            voting_history: [],
            note: "Manual entry required - DAO governance data not yet automated"
        },
        
        // ========== SECTION 8: TOKEN PRICES ==========
        token_prices: tokenPrices,
        
        // ========== SECTION 9: EXT DATA SUMMARY ==========
        ext_data: {
            loaded: store.ext.loaded || false,
            file_epoch: store.extFile.epoch || null,
            votion: {
                available: !!store.ext.votion,
                total_vp: store.ext.votion?.total_vp || 0,
                pool_count: Object.keys(store.ext.votion?.pools || {}).length
            },
            pd_bribes: {
                available: !!store.ext.pdBribesEpoch,
                epoch: store.ext.pdBribesEpoch || null
            },
            historical_lp_count: Object.keys(store.ext.lps || {}).length
        },
        
        // ========== VALIDATION ==========
        validation: validateExportData()
    };
}

// Build Dashboard section data
function buildDashboardData() {
    return {
        treasury: {
            tokens: store.dashboard.treasuryTokens || dashboardTreasuryTokens || [],
            total_usd: store.dashboard.treasuryUsd || 0
        },
        tla_deposits: {
            total_usd: store.dao.dep || 0,
            tokens: (store.dao.toks || []).map(t => ({
                symbol: t.s,
                amount: t.a,
                price: getTokenPrice(t.s),
                usd: t.a * getTokenPrice(t.s)
            })),
            vp: store.dao.lVp || 0,
            apr: store.dao.apr || 0
        },
        unclaimed_rewards: {
            deposit_rewards_usd: store.dao.rew?.usd || 0,
            zAssets: store.dao.rew?.z || 0,
            ampLUNA: store.dao.rew?.amp || 0
        },
        vote_rewards: {
            by_token: Object.fromEntries(
                Object.entries(store.dao.vRew || {}).map(([token, amt]) => [token, {
                    amount: amt,
                    price: getTokenPrice(token),
                    usd: amt * getTokenPrice(token)
                }])
            ),
            periods: store.dao.vRewPeriods || []
        },
        rebase: {
            ampLUNA: store.vote.reb || 0,
            usd: (store.vote.reb || 0) * getTokenPrice('ampLUNA')
        },
        nft_backing_per_nft: {
            ampLUNA: store.dashboard.backingAmpLuna || 0,
            LUNA_equivalent: store.dashboard.backingLuna || 0,
            USD: store.dashboard.backingUsd || 0
        },
        unminted_backing: {
            count: store.dashboard.unmintedCount || 0,
            total_ampLUNA: store.dashboard.unmintedBackingAmp || 0,
            total_LUNA_equivalent: store.dashboard.unmintedBackingLuna || 0,
            total_USD: store.dashboard.unmintedBackingUsd || 0
        }
    };
}

// Build NFT Stats section data
function buildNftStatsData() {
    let nftData = store.nftStats || {};
    
    return {
        collection: {
            total_supply: NFT_TOTAL_SUPPLY,
            broken_count: nftData.brokenCount || 0,
            unbroken_count: nftData.unbrokenCount || (NFT_TOTAL_SUPPLY - (nftData.brokenCount || 0)),
            minted_count: nftData.mintedCount || 0,
            unminted_count: nftData.unmintedCount || 0
        },
        staking: {
            daodao_staked: nftData.daodaoStaked || 0,
            daodao_staked_pct: nftData.daodaoStakedPct || 0,
            enterprise_staked: nftData.enterpriseStaked || 0,
            dao_members: nftData.daoMembers || 0,
            dao_broken_held: nftData.daoBrokenHeld || 0
        },
        supply: {
            circulating: nftData.circulatingSupply || 0,
            liquid: nftData.liquidSupply || 0
        },
        backing_per_nft: {
            ampLUNA: nftData.backingAmpLuna || 0,
            LUNA_equivalent: nftData.backingLuna || 0,
            USD: nftData.backingUsd || 0
        },
        marketplaces: {
            bbl: {
                epoch_sales: nftData.bblSales || [],
                floor_price: nftData.bblFloor || { unbroken: null, broken: null },
                total_volume: nftData.bblVolume || { amount: 0, token: 'bLUNA', usd: 0 },
                listings: {
                    broken: nftData.bblListingsBroken || 0,
                    unbroken: nftData.bblListingsUnbroken || 0,
                    total: nftData.bblListingsTotal || 0,
                    items: nftData.bblListingItems || []
                }
            },
            boost: {
                epoch_sales: nftData.boostSales || [],
                floor_price: nftData.boostFloor || { unbroken: null, broken: null },
                total_volume: null,
                listings: {
                    broken: nftData.boostListingsBroken || 0,
                    unbroken: nftData.boostListingsUnbroken || 0,
                    total: nftData.boostListingsTotal || 0,
                    items: nftData.boostListingItems || []
                }
            }
        },
        manual_entry: nftData.manual || null
    };
}

// ============================================
// DASHBOARD FUNCTIONS
// ============================================

// Treasury tokens array
let dashboardTreasuryTokens = [];

// Parse treasury paste from Station
function parseTreasuryPaste() {
    let paste = $('dash-treas-paste')?.value || '';
    if (!paste.trim()) {
        alert('Please paste treasury data first');
        return;
    }
    
    // Clear existing
    dashboardTreasuryTokens = [];
    
    // Pattern: AssetAmountLive Value (USD) followed by token rows
    // Example: ampLUNA70,633.38$13,248.28LUNA94,803.11$9,388.64...
    
    // Try to extract tokens - look for patterns like: TOKEN_NAME followed by NUMBER
    // Common tokens to look for
    const knownTokens = ['ampLUNA', 'LUNA', 'bLUNA', 'ASTRO', 'SOLID', 'CAPA', 'wBTC', 'ROAR', 'USDC', 'USDT', 
                         'xASTRO', 'ampCAPA', 'ampROAR', 'stLUNA', 'arbLUNA', 'boneLUNA', 'wETH', 'wBNB',
                         'ATOM', 'stATOM', 'INJ', 'PAXG', 'wstETH', 'EURe', 'SWTH', 'FUEL'];
    
    // Remove header text and Total line
    let cleanPaste = paste.replace(/AssetAmountLive Value \(USD\)/gi, '')
                          .replace(/Total\$[\d,\.]+/gi, '');
    
    // Try to parse each known token
    for (let token of knownTokens) {
        // Look for token followed by amount (handles comma-separated numbers)
        let regex = new RegExp(token + '([\\d,]+\\.?\\d*)', 'i');
        let match = cleanPaste.match(regex);
        if (match) {
            let amtStr = match[1].replace(/,/g, '');
            let amt = parseFloat(amtStr);
            if (amt > 0) {
                let price = getTokenPrice(token);
                let usd = amt * price;
                dashboardTreasuryTokens.push({
                    token: token,
                    amount: amt,
                    price: price,
                    usd: usd
                });
            }
        }
    }
    
    if (dashboardTreasuryTokens.length === 0) {
        alert('Could not parse any tokens. Try adding manually.');
        return;
    }
    
    // Sort by USD value
    dashboardTreasuryTokens.sort((a, b) => b.usd - a.usd);
    
    renderTreasuryTokens();
    
    // Clear paste area
    $('dash-treas-paste').value = '';
    
    console.log('Parsed treasury tokens:', dashboardTreasuryTokens);
}

// Load dashboard data from this tool's parsed data
function loadDashboardFromTool() {
    // TLA Deposits
    setTxt('dash-dep-usd', '$' + (store.dao.dep || 0).toLocaleString(undefined, {maximumFractionDigits: 2}));
    setTxt('dash-dep-vp', (store.dao.lVp || 0).toLocaleString());
    setTxt('dash-dep-apr', (store.dao.apr || 0).toFixed(2) + '%');
    
    // Deposit Tokens
    const tokEl = $('dash-dep-tokens');
    if (tokEl && store.dao.toks && store.dao.toks.length > 0) {
        tokEl.innerHTML = store.dao.toks.map(t => {
            let price = getTokenPrice(t.s);
            let usd = t.a * price;
            return `
            <div class="flex justify-between text-gray-400">
                <span>${t.s}</span>
                <span class="text-white font-mono">${t.a.toLocaleString(undefined, {maximumFractionDigits: 2})} <span class="text-gray-500">($${usd.toFixed(2)})</span></span>
            </div>
        `}).join('');
    }
    
    // Unclaimed Rewards
    setTxt('dash-rew-usd', '$' + (store.dao.rew?.usd || 0).toLocaleString(undefined, {maximumFractionDigits: 2}));
    setTxt('dash-rew-z', (store.dao.rew?.z || 0).toLocaleString());
    setTxt('dash-rew-amp', (store.dao.rew?.amp || 0).toLocaleString(undefined, {maximumFractionDigits: 4}));
    
    // Vote Rewards
    const voteRewEl = $('dash-vote-rew');
    if (voteRewEl && store.dao.vRew && Object.keys(store.dao.vRew).length > 0) {
        voteRewEl.innerHTML = Object.entries(store.dao.vRew).map(([token, amt]) => {
            let price = getTokenPrice(token);
            let usd = amt * price;
            return `
            <div class="flex justify-between text-gray-400">
                <span>${token}</span>
                <span class="text-white font-mono">${amt.toLocaleString(undefined, {maximumFractionDigits: 2})} <span class="text-gray-500">($${usd.toFixed(2)})</span></span>
            </div>
        `}).join('');
    } else if (voteRewEl) {
        voteRewEl.innerHTML = '<div class="text-gray-600 italic">No vote rewards</div>';
    }
    
    // Rebase
    setTxt('dash-rebase', (store.vote.reb || 0).toLocaleString(undefined, {maximumFractionDigits: 2}));
    
    // Update status
    const status = $('dashboard-status');
    if (status) {
        status.textContent = 'Loaded';
        status.className = 'px-3 py-1 rounded text-[10px] font-bold bg-green-900/50 text-green-400';
    }
}

// Add treasury token manually
function addTreasuryToken() {
    let token = $('dash-treas-token')?.value?.trim();
    let amt = parseFloat($('dash-treas-amt')?.value);
    
    if (!token || !amt) {
        alert('Please enter token name and amount');
        return;
    }
    
    let price = getTokenPrice(token);
    let usd = amt * price;
    
    dashboardTreasuryTokens.push({
        token: token,
        amount: amt,
        price: price,
        usd: usd
    });
    
    renderTreasuryTokens();
    
    // Clear inputs
    $('dash-treas-token').value = '';
    $('dash-treas-amt').value = '';
}

function renderTreasuryTokens() {
    const el = $('dash-treasury-list');
    const totalEl = $('dash-treasury-total');
    if (!el) return;
    
    if (dashboardTreasuryTokens.length === 0) {
        el.innerHTML = '<div class="text-gray-600 italic">No tokens added</div>';
        if (totalEl) totalEl.textContent = '$0';
        return;
    }
    
    let totalUsd = 0;
    el.innerHTML = dashboardTreasuryTokens.map((t, i) => {
        totalUsd += t.usd;
        return `
        <div class="flex justify-between items-center py-0.5 px-1 rounded bg-yellow-900/10">
            <span class="text-yellow-400">${t.token}</span>
            <span class="text-white font-mono">${t.amount.toLocaleString(undefined, {maximumFractionDigits: 2})}</span>
            <span class="text-gray-400">$${t.usd.toFixed(2)}</span>
            <button onclick="removeTreasuryToken(${i})" class="text-red-400 hover:text-red-300">√ó</button>
        </div>
    `}).join('');
    
    if (totalEl) totalEl.textContent = '$' + totalUsd.toLocaleString(undefined, {maximumFractionDigits: 2});
    
    // Update store
    store.dashboard.treasuryTokens = dashboardTreasuryTokens;
    store.dashboard.treasuryUsd = totalUsd;
}

function removeTreasuryToken(index) {
    dashboardTreasuryTokens.splice(index, 1);
    renderTreasuryTokens();
}

// Update NFT backing USD calculation - converts ampLUNA to LUNA equivalent and USD
function updateDashBacking() {
    let ampLuna = parseFloat($('dash-back-amp')?.value) || 0;
    
    // Get LST ratio from ext file to convert ampLUNA to LUNA
    let ampLunaPrice = getTokenPrice('ampLUNA');
    let lunaPrice = getTokenPrice('LUNA');
    
    // Calculate LUNA equivalent (ampLUNA * ratio)
    let lunaEquiv = lunaPrice > 0 ? (ampLuna * ampLunaPrice / lunaPrice) : 0;
    let usd = ampLuna * ampLunaPrice;
    
    setTxt('dash-back-luna-equiv', lunaEquiv.toLocaleString(undefined, {maximumFractionDigits: 4}));
    setTxt('dash-back-usd', '$' + usd.toLocaleString(undefined, {maximumFractionDigits: 2}));
    
    store.dashboard.backingAmpLuna = ampLuna;
    store.dashboard.backingLuna = lunaEquiv;
    store.dashboard.backingUsd = usd;
    
    // Recalc unminted if count is set
    updateUnmintedBacking();
}

// Update unminted backing calculation
function updateUnmintedBacking() {
    let unmintedCount = parseInt($('dash-unminted-count')?.value) || 0;
    let ampLunaPerNft = parseFloat($('dash-back-amp')?.value) || 0;
    
    let ampLunaPrice = getTokenPrice('ampLUNA');
    let lunaPrice = getTokenPrice('LUNA');
    
    let totalAmp = unmintedCount * ampLunaPerNft;
    let totalLuna = lunaPrice > 0 ? (totalAmp * ampLunaPrice / lunaPrice) : 0;
    let totalUsd = totalAmp * ampLunaPrice;
    
    setTxt('dash-unminted-amp', totalAmp.toLocaleString(undefined, {maximumFractionDigits: 4}));
    setTxt('dash-unminted-luna', totalLuna.toLocaleString(undefined, {maximumFractionDigits: 4}));
    setTxt('dash-unminted-usd', '$' + totalUsd.toLocaleString(undefined, {maximumFractionDigits: 2}));
    
    store.dashboard.unmintedCount = unmintedCount;
    store.dashboard.unmintedBackingAmp = totalAmp;
    store.dashboard.unmintedBackingLuna = totalLuna;
    store.dashboard.unmintedBackingUsd = totalUsd;
}

// Save all dashboard data
function saveDashboardData() {
    // Treasury is already in store from renderTreasuryTokens
    
    // NFT Backing per NFT
    store.dashboard.backingAmpLuna = parseFloat($('dash-back-amp')?.value) || 0;
    let ampPrice = getTokenPrice('ampLUNA');
    let lunaPrice = getTokenPrice('LUNA');
    store.dashboard.backingLuna = lunaPrice > 0 ? (store.dashboard.backingAmpLuna * ampPrice / lunaPrice) : 0;
    store.dashboard.backingUsd = store.dashboard.backingAmpLuna * ampPrice;
    
    // Unminted
    store.dashboard.unmintedCount = parseInt($('dash-unminted-count')?.value) || 0;
    store.dashboard.unmintedBackingAmp = store.dashboard.unmintedCount * store.dashboard.backingAmpLuna;
    store.dashboard.unmintedBackingLuna = store.dashboard.unmintedCount * store.dashboard.backingLuna;
    store.dashboard.unmintedBackingUsd = store.dashboard.unmintedCount * store.dashboard.backingUsd;
    
    alert('Dashboard data saved!');
    
    const status = $('dashboard-status');
    if (status) {
        status.textContent = 'Saved';
        status.className = 'px-3 py-1 rounded text-[10px] font-bold bg-green-900/50 text-green-400';
    }
    
    updateTabStatus('dashboard', 'complete');
}

// ============================================
// NFT STATS FUNCTIONS
// ============================================

const NFT_CONTRACT = 'terra13ckenyqrq9aa2kzz3lnfv8el4squx2xmkwdzy9pvtv755d7uku3qamu6wv';
const NFT_TOTAL_SUPPLY = 10000;

// Update calculated NFT values
function updateNftCalcs() {
    let broken = parseInt($('nft-broken-input')?.value) || 0;
    let minted = parseInt($('nft-minted-input')?.value) || 0;
    
    // Calculate derived values
    let unbroken = NFT_TOTAL_SUPPLY - broken;
    let unminted = NFT_TOTAL_SUPPLY - minted;
    
    // Update displays
    setTxt('nft-unbroken', unbroken.toLocaleString());
    setTxt('nft-unminted', unminted.toLocaleString());
    
    // Update store
    store.nftStats.brokenCount = broken;
    store.nftStats.unbrokenCount = unbroken;
    store.nftStats.mintedCount = minted;
    store.nftStats.unmintedCount = unminted;
}

// Update NFT backing - convert ampLUNA to LUNA equivalent and USD
function updateNftBacking() {
    let ampLuna = parseFloat($('nft-back-amp-input')?.value) || 0;
    
    let ampPrice = getTokenPrice('ampLUNA');
    let lunaPrice = getTokenPrice('LUNA');
    
    // Calculate LUNA equivalent
    let lunaEquiv = lunaPrice > 0 ? (ampLuna * ampPrice / lunaPrice) : 0;
    let usd = ampLuna * ampPrice;
    
    setTxt('nft-back-luna', lunaEquiv.toLocaleString(undefined, {maximumFractionDigits: 4}));
    setTxt('nft-back-usd', '$' + usd.toLocaleString(undefined, {maximumFractionDigits: 2}));
    
    store.nftStats.backingAmpLuna = ampLuna;
    store.nftStats.backingLuna = lunaEquiv;
    store.nftStats.backingUsd = usd;
}

// Update BBL floor USD displays
function updateBblFloorUsd() {
    // Unbroken
    let ubAmt = parseFloat($('nft-bbl-floor-unbroken-amt')?.value) || 0;
    let ubToken = $('nft-bbl-floor-unbroken-token')?.value || 'bLUNA';
    let ubUsd = ubAmt * getTokenPrice(ubToken);
    setTxt('nft-bbl-floor-unbroken-usd', ubAmt > 0 ? '($' + ubUsd.toFixed(2) + ')' : '');
    
    // Broken
    let brAmt = parseFloat($('nft-bbl-floor-broken-amt')?.value) || 0;
    let brToken = $('nft-bbl-floor-broken-token')?.value || 'bLUNA';
    let brUsd = brAmt * getTokenPrice(brToken);
    setTxt('nft-bbl-floor-broken-usd', brAmt > 0 ? '($' + brUsd.toFixed(2) + ')' : '');
    
    // Also update volume USD
    let volAmt = parseFloat($('nft-bbl-volume')?.value) || 0;
    let volUsd = volAmt * getTokenPrice('bLUNA');
    setTxt('nft-bbl-volume-usd', '($' + volUsd.toLocaleString(undefined, {maximumFractionDigits: 2}) + ')');
}

// Update Boost floor USD displays
function updateBoostFloorUsd() {
    // Unbroken
    let ubAmt = parseFloat($('nft-boost-floor-unbroken-amt')?.value) || 0;
    let ubToken = $('nft-boost-floor-unbroken-token')?.value?.trim() || 'LUNA';
    let ubUsd = ubAmt * getTokenPrice(ubToken);
    setTxt('nft-boost-floor-unbroken-usd', ubAmt > 0 ? '($' + ubUsd.toFixed(2) + ')' : '');
    
    // Broken
    let brAmt = parseFloat($('nft-boost-floor-broken-amt')?.value) || 0;
    let brToken = $('nft-boost-floor-broken-token')?.value?.trim() || 'USDC';
    let brUsd = brAmt * getTokenPrice(brToken);
    setTxt('nft-boost-floor-broken-usd', brAmt > 0 ? '($' + brUsd.toFixed(2) + ')' : '');
}

// Convert local datetime to UTC ISO string
function localToUtc(dateStr, timeStr) {
    if (!dateStr) return new Date().toISOString();
    
    // Create date in local timezone
    let localDate;
    if (timeStr) {
        localDate = new Date(`${dateStr}T${timeStr}`);
    } else {
        localDate = new Date(dateStr);
    }
    
    // Return as UTC ISO string
    return localDate.toISOString();
}

// Add BBL Listing
function addBblListing() {
    let id = parseInt($('nft-bbl-list-id')?.value);
    let amt = parseFloat($('nft-bbl-list-amt')?.value);
    let token = $('nft-bbl-list-token')?.value || 'LUNA';
    let broken = $('nft-bbl-list-broken')?.checked || false;
    
    if (!id || !amt) {
        alert('Please enter NFT # and amount');
        return;
    }
    
    let price = getTokenPrice(token);
    let usd = amt * price;
    
    if (!store.nftStats.bblListingItems) store.nftStats.bblListingItems = [];
    store.nftStats.bblListingItems.push({
        nft_id: id,
        amount: amt,
        token: token,
        usd: usd,
        broken: broken
    });
    
    renderBblListings();
    
    // Clear inputs
    $('nft-bbl-list-id').value = '';
    $('nft-bbl-list-amt').value = '';
    $('nft-bbl-list-broken').checked = false;
}

function renderBblListings() {
    const el = $('nft-bbl-listings-list');
    const countEl = $('bbl-listing-count');
    if (!el) return;
    
    let items = store.nftStats.bblListingItems || [];
    if (countEl) countEl.textContent = items.length;
    
    if (items.length === 0) {
        el.innerHTML = '<div class="text-gray-600 italic">No listings</div>';
        return;
    }
    
    el.innerHTML = items.map((s, i) => `
        <div class="flex justify-between items-center py-0.5 px-1 rounded ${s.broken ? 'bg-red-900/20 text-red-400' : 'bg-green-900/20 text-green-400'}">
            <span>#${s.nft_id} ${s.broken ? 'üî•' : ''}</span>
            <span class="font-mono">${s.amount} ${s.token}</span>
            <span class="text-gray-400">$${s.usd.toFixed(2)}</span>
            <button onclick="removeBblListing(${i})" class="text-red-400 hover:text-red-300">√ó</button>
        </div>
    `).join('');
}

function removeBblListing(index) {
    store.nftStats.bblListingItems.splice(index, 1);
    renderBblListings();
}

// Auto-calculate BBL floor prices from listings
function autoCalcBblFloors() {
    const items = store.nftStats.bblListingItems || [];
    
    if (items.length === 0) {
        alert('No listings to calculate from. Add listings first.');
        return;
    }
    
    // Separate broken and unbroken, sort by USD (cheapest first)
    const unbroken = items.filter(l => !l.broken).sort((a, b) => a.usd - b.usd);
    const broken = items.filter(l => l.broken).sort((a, b) => a.usd - b.usd);
    
    // Set unbroken floor (cheapest unbroken listing)
    if (unbroken.length > 0) {
        const floor = unbroken[0];
        $('nft-bbl-floor-unbroken-amt').value = floor.amount;
        $('nft-bbl-floor-unbroken-token').value = floor.token;
    } else {
        $('nft-bbl-floor-unbroken-amt').value = '';
    }
    
    // Set broken floor (cheapest broken listing)
    if (broken.length > 0) {
        const floor = broken[0];
        $('nft-bbl-floor-broken-amt').value = floor.amount;
        $('nft-bbl-floor-broken-token').value = floor.token;
    } else {
        $('nft-bbl-floor-broken-amt').value = '';
    }
    
    // Update USD displays
    updateBblFloorUsd();
    
    // Show what was set
    const msg = [];
    if (unbroken.length > 0) msg.push(`Unbroken: ${unbroken[0].amount} ${unbroken[0].token} ($${unbroken[0].usd.toFixed(2)})`);
    else msg.push('Unbroken: None found');
    if (broken.length > 0) msg.push(`Broken: ${broken[0].amount} ${broken[0].token} ($${broken[0].usd.toFixed(2)})`);
    else msg.push('Broken: None found');
    
    alert('BBL Floors Updated:\n' + msg.join('\n'));
}

// Auto-calculate Boost floor prices from listings
function autoCalcBoostFloors() {
    const items = store.nftStats.boostListingItems || [];
    
    if (items.length === 0) {
        alert('No listings to calculate from. Add listings first.');
        return;
    }
    
    // Separate broken and unbroken, sort by USD (cheapest first)
    const unbroken = items.filter(l => !l.broken).sort((a, b) => a.usd - b.usd);
    const broken = items.filter(l => l.broken).sort((a, b) => a.usd - b.usd);
    
    // Set unbroken floor (cheapest unbroken listing)
    if (unbroken.length > 0) {
        const floor = unbroken[0];
        $('nft-boost-floor-unbroken-amt').value = floor.amount;
        $('nft-boost-floor-unbroken-token').value = floor.token;
    } else {
        $('nft-boost-floor-unbroken-amt').value = '';
    }
    
    // Set broken floor (cheapest broken listing)
    if (broken.length > 0) {
        const floor = broken[0];
        $('nft-boost-floor-broken-amt').value = floor.amount;
        $('nft-boost-floor-broken-token').value = floor.token;
    } else {
        $('nft-boost-floor-broken-amt').value = '';
    }
    
    // Update USD displays
    updateBoostFloorUsd();
    
    // Show what was set
    const msg = [];
    if (unbroken.length > 0) msg.push(`Unbroken: ${unbroken[0].amount} ${unbroken[0].token} ($${unbroken[0].usd.toFixed(2)})`);
    else msg.push('Unbroken: None found');
    if (broken.length > 0) msg.push(`Broken: ${broken[0].amount} ${broken[0].token} ($${broken[0].usd.toFixed(2)})`);
    else msg.push('Broken: None found');
    
    alert('Boost Floors Updated:\n' + msg.join('\n'));
}

// Add BBL Sale
function addBblSale() {
    let id = parseInt($('nft-bbl-sale-id')?.value);
    let amt = parseFloat($('nft-bbl-sale-amt')?.value);
    let token = $('nft-bbl-sale-token')?.value || 'bLUNA';
    let manualUsd = parseFloat($('nft-bbl-sale-usd')?.value);
    let broken = $('nft-bbl-sale-broken')?.checked || false;
    let dateStr = $('nft-bbl-sale-date')?.value;
    let timeStr = $('nft-bbl-sale-time')?.value;
    
    if (!id || !amt) {
        alert('Please enter NFT # and amount');
        return;
    }
    
    // Use manual USD if provided, otherwise calculate from token price
    let usd = manualUsd > 0 ? manualUsd : amt * getTokenPrice(token);
    let timestamp = localToUtc(dateStr, timeStr);
    
    if (!store.nftStats.bblSales) store.nftStats.bblSales = [];
    store.nftStats.bblSales.push({
        nft_id: id,
        amount: amt,
        token: token,
        usd: usd,
        broken: broken,
        timestamp_utc: timestamp
    });
    
    renderBblSales();
    
    // Clear inputs
    $('nft-bbl-sale-id').value = '';
    $('nft-bbl-sale-amt').value = '';
    $('nft-bbl-sale-usd').value = '';
    $('nft-bbl-sale-broken').checked = false;
}

function renderBblSales() {
    const el = $('nft-bbl-sales-list');
    const countEl = $('bbl-sale-count');
    if (!el) return;
    
    let sales = store.nftStats.bblSales || [];
    if (countEl) countEl.textContent = sales.length;
    
    if (sales.length === 0) {
        el.innerHTML = '<div class="text-gray-600 italic">No sales</div>';
        return;
    }
    
    el.innerHTML = sales.map((s, i) => {
        let dateStr = new Date(s.timestamp_utc).toLocaleDateString();
        return `
        <div class="flex justify-between items-center py-0.5 px-1 rounded ${s.broken ? 'bg-red-900/20 text-red-400' : 'bg-green-900/20 text-green-400'}">
            <span>#${s.nft_id} ${s.broken ? 'üî•' : ''}</span>
            <span class="font-mono">${s.amount} ${s.token}</span>
            <span class="text-gray-400">$${s.usd.toFixed(2)}</span>
            <span class="text-gray-500">${dateStr}</span>
            <button onclick="removeBblSale(${i})" class="text-red-400 hover:text-red-300">√ó</button>
        </div>
    `}).join('');
}

function removeBblSale(index) {
    store.nftStats.bblSales.splice(index, 1);
    renderBblSales();
}

// Add Boost Listing - any token
function addBoostListing() {
    let id = parseInt($('nft-boost-list-id')?.value);
    let amt = parseFloat($('nft-boost-list-amt')?.value);
    let token = $('nft-boost-list-token')?.value?.trim() || 'LUNA';
    let broken = $('nft-boost-list-broken')?.checked || false;
    
    if (!id || !amt) {
        alert('Please enter NFT # and amount');
        return;
    }
    
    let price = getTokenPrice(token);
    let usd = amt * price;
    
    if (!store.nftStats.boostListingItems) store.nftStats.boostListingItems = [];
    store.nftStats.boostListingItems.push({
        nft_id: id,
        amount: amt,
        token: token,
        usd: usd,
        broken: broken
    });
    
    renderBoostListings();
    
    $('nft-boost-list-id').value = '';
    $('nft-boost-list-amt').value = '';
    $('nft-boost-list-broken').checked = false;
}

function renderBoostListings() {
    const el = $('nft-boost-listings-list');
    const countEl = $('boost-listing-count');
    if (!el) return;
    
    let items = store.nftStats.boostListingItems || [];
    if (countEl) countEl.textContent = items.length;
    
    if (items.length === 0) {
        el.innerHTML = '<div class="text-gray-600 italic">No listings</div>';
        return;
    }
    
    el.innerHTML = items.map((s, i) => `
        <div class="flex justify-between items-center py-0.5 px-1 rounded ${s.broken ? 'bg-red-900/20 text-red-400' : 'bg-green-900/20 text-green-400'}">
            <span>#${s.nft_id} ${s.broken ? 'üî•' : ''}</span>
            <span class="font-mono">${s.amount} ${s.token}</span>
            <span class="text-gray-400">$${s.usd.toFixed(2)}</span>
            <button onclick="removeBoostListing(${i})" class="text-red-400 hover:text-red-300">√ó</button>
        </div>
    `).join('');
}

function removeBoostListing(index) {
    store.nftStats.boostListingItems.splice(index, 1);
    renderBoostListings();
}

// Add Boost Sale - any token
function addBoostSale() {
    let id = parseInt($('nft-boost-sale-id')?.value);
    let amt = parseFloat($('nft-boost-sale-amt')?.value);
    let token = $('nft-boost-sale-token')?.value?.trim() || 'LUNA';
    let manualUsd = parseFloat($('nft-boost-sale-usd')?.value);
    let broken = $('nft-boost-sale-broken')?.checked || false;
    let dateStr = $('nft-boost-sale-date')?.value;
    let timeStr = $('nft-boost-sale-time')?.value;
    
    if (!id || !amt) {
        alert('Please enter NFT # and amount');
        return;
    }
    
    // Use manual USD if provided, otherwise calculate from token price
    let usd = manualUsd > 0 ? manualUsd : amt * getTokenPrice(token);
    let timestamp = localToUtc(dateStr, timeStr);
    
    if (!store.nftStats.boostSales) store.nftStats.boostSales = [];
    store.nftStats.boostSales.push({
        nft_id: id,
        amount: amt,
        token: token,
        usd: usd,
        broken: broken,
        timestamp_utc: timestamp
    });
    
    renderBoostSales();
    
    $('nft-boost-sale-id').value = '';
    $('nft-boost-sale-amt').value = '';
    $('nft-boost-sale-usd').value = '';
    $('nft-boost-sale-broken').checked = false;
}

function renderBoostSales() {
    const el = $('nft-boost-sales-list');
    const countEl = $('boost-sale-count');
    if (!el) return;
    
    let sales = store.nftStats.boostSales || [];
    if (countEl) countEl.textContent = sales.length;
    
    if (sales.length === 0) {
        el.innerHTML = '<div class="text-gray-600 italic">No sales</div>';
        updateBoostVolumeDisplay();
        return;
    }
    
    el.innerHTML = sales.map((s, i) => {
        let dateStr = new Date(s.timestamp_utc).toLocaleDateString();
        return `
        <div class="flex justify-between items-center py-0.5 px-1 rounded ${s.broken ? 'bg-red-900/20 text-red-400' : 'bg-green-900/20 text-green-400'}">
            <span>#${s.nft_id} ${s.broken ? 'üî•' : ''}</span>
            <span class="font-mono">${s.amount} ${s.token}</span>
            <span class="text-gray-400">$${s.usd.toFixed(2)}</span>
            <span class="text-gray-500">${dateStr}</span>
            <button onclick="removeBoostSale(${i})" class="text-red-400 hover:text-red-300">√ó</button>
        </div>
    `}).join('');
    
    // Update volume display
    updateBoostVolumeDisplay();
}

function removeBoostSale(index) {
    store.nftStats.boostSales.splice(index, 1);
    renderBoostSales();
}

// Update Boost volume display from history + new sales
function updateBoostVolumeDisplay() {
    const displayEl = $('boost-volume-display');
    const noteEl = $('boost-volume-note');
    if (!displayEl) return;
    
    // Get cumulative volume from history
    let cumulativeVolume = window.salesHistory.cumulative?.boost?.total_volume_usd || 0;
    
    // If we have yearTotals, we need to add this year's volume from history
    // (cumulative already includes it, so this is just for display breakdown)
    let historyYearVolume = window.salesHistory.yearTotals?.boost?.volume_usd || 0;
    
    // Get new epoch sales volume
    let newEpochVolume = (store.nftStats.boostSales || []).reduce((sum, s) => sum + (s.usd || 0), 0);
    
    // Total = cumulative + new epoch sales
    let totalVolume = cumulativeVolume + newEpochVolume;
    
    displayEl.textContent = `$${totalVolume.toFixed(2)}`;
    
    if (!window.salesHistory.loaded) {
        noteEl.textContent = '(load history)';
        noteEl.className = 'text-gray-600';
    } else if (newEpochVolume > 0) {
        noteEl.textContent = `(+$${newEpochVolume.toFixed(2)} new)`;
        noteEl.className = 'text-green-500';
    } else {
        noteEl.textContent = `(${window.salesHistory.cumulative?.boost?.total_sales || 0} sales)`;
        noteEl.className = 'text-gray-500';
    }
}

// Sales History Management
// Store for loaded history
window.salesHistory = {
    loaded: false,
    year: null,
    bbl: [],
    boost: [],
    cumulative: null,
    top10: null
};

// Load sales history from GitHub
async function loadSalesHistory() {
    const statusEl = $('sales-history-status');
    const bblHistoryCountEl = $('bbl-history-count');
    const boostHistoryCountEl = $('boost-history-count');
    
    // Determine year from epoch end_time or use current year
    let targetYear = new Date().getFullYear();
    if (currentEpochInfo?.end_time) {
        targetYear = new Date(currentEpochInfo.end_time).getFullYear();
    } else if (store.vote?.end && store.vote.end !== 'Loaded from file') {
        targetYear = new Date(store.vote.end).getFullYear();
    }
    
    if (statusEl) statusEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
    
    try {
        // Try to load the current year's file first
        const baseUrl = 'https://raw.githubusercontent.com/defipatriot/adao_json_storage/main/';
        let response = await fetch(`${baseUrl}nft-sales-${targetYear}.json`);
        
        // If current year doesn't exist, try previous year to get cumulative totals
        if (!response.ok && targetYear > 2023) {
            response = await fetch(`${baseUrl}nft-sales-${targetYear - 1}.json`);
            if (response.ok) {
                // We loaded previous year - we'll create new year file
                const prevData = await response.json();
                window.salesHistory = {
                    loaded: true,
                    year: targetYear,
                    previousYear: targetYear - 1,
                    bbl: [], // No sales yet for new year
                    boost: [],
                    cumulative: prevData.cumulative_totals,
                    top10: prevData.top_10_sales_all_time || null
                };
                
                if (statusEl) statusEl.innerHTML = `<span class="text-yellow-400">‚úì New year ${targetYear} (prev: ${prevData.cumulative_totals.bbl.total_sales} BBL / ${prevData.cumulative_totals.boost.total_sales} Boost)</span>`;
                if (bblHistoryCountEl) bblHistoryCountEl.textContent = '0';
                if (boostHistoryCountEl) boostHistoryCountEl.textContent = '0';
                updateBoostVolumeDisplay();
                return;
            }
        }
        
        if (!response.ok) {
            throw new Error(`No sales file found for ${targetYear}`);
        }
        
        const data = await response.json();
        
        window.salesHistory = {
            loaded: true,
            year: targetYear,
            bbl: data.sales?.bbl || [],
            boost: data.sales?.boost || [],
            cumulative: data.cumulative_totals,
            yearTotals: data.year_totals,
            top10: data.top_10_sales_all_time || null
        };
        
        const bblCount = window.salesHistory.bbl.length;
        const boostCount = window.salesHistory.boost.length;
        
        if (statusEl) statusEl.innerHTML = `<span class="text-green-400">‚úì Loaded ${targetYear}: ${bblCount} BBL / ${boostCount} Boost sales</span>`;
        if (bblHistoryCountEl) bblHistoryCountEl.textContent = bblCount;
        if (boostHistoryCountEl) boostHistoryCountEl.textContent = boostCount;
        updateBoostVolumeDisplay();
        
    } catch (err) {
        console.error('Failed to load sales history:', err);
        if (statusEl) statusEl.innerHTML = `<span class="text-red-400">‚úó ${err.message}</span>`;
        
        // Initialize empty history for new file
        window.salesHistory = {
            loaded: true,
            year: targetYear,
            bbl: [],
            boost: [],
            cumulative: null,
            top10: null
        };
        updateBoostVolumeDisplay();
    }
}

// Download merged sales file
function downloadSalesFile() {
    if (!window.salesHistory.loaded) {
        alert('Please load sales history first!');
        return;
    }
    
    // Determine year from epoch end_time
    let targetYear = new Date().getFullYear();
    if (currentEpochInfo?.end_time) {
        targetYear = new Date(currentEpochInfo.end_time).getFullYear();
    } else if (store.vote?.end && store.vote.end !== 'Loaded from file') {
        targetYear = new Date(store.vote.end).getFullYear();
    }
    
    // Get new sales from current session (epoch sales)
    const newBblSales = (store.nftStats.bblSales || []).map(s => ({
        nft_id: s.nft_id,
        amount: s.amount,
        token: s.token,
        usd: s.usd,
        timestamp: s.timestamp_utc,
        marketplace: 'bbl'
    }));
    
    const newBoostSales = (store.nftStats.boostSales || []).map(s => ({
        nft_id: s.nft_id,
        amount: s.amount,
        token: s.token,
        usd_at_time: s.usd,
        price_at_time: s.usd / s.amount, // Calculate price per token
        timestamp: s.timestamp_utc,
        marketplace: 'boost'
    }));
    
    // Merge with existing history
    const allBblSales = [...window.salesHistory.bbl, ...newBblSales];
    const allBoostSales = [...window.salesHistory.boost, ...newBoostSales];
    
    // Sort by timestamp (newest first)
    allBblSales.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
    allBoostSales.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
    
    // Calculate year totals
    const yearBblVolume = allBblSales.reduce((sum, s) => sum + s.amount, 0);
    const yearBblVolumeUsd = allBblSales.reduce((sum, s) => sum + (s.usd || 0), 0);
    const yearBoostVolume = allBoostSales.reduce((sum, s) => sum + (s.usd_at_time || 0), 0);
    
    // Get date ranges
    const bblDates = allBblSales.map(s => s.timestamp?.substring(0, 10)).filter(Boolean);
    const boostDates = allBoostSales.map(s => s.timestamp?.substring(0, 10)).filter(Boolean);
    
    // Calculate cumulative totals
    let prevCumulative = window.salesHistory.cumulative;
    
    // If this is a new year, use previous year's cumulative as base
    let baseBblSales = 0;
    let baseBblVolume = 0;
    let baseBoostSales = 0;
    let baseBoostVolume = 0;
    
    if (prevCumulative && window.salesHistory.year === targetYear) {
        // Same year - subtract this year's previous totals to get base from prior years
        baseBblSales = prevCumulative.bbl.total_sales - (window.salesHistory.yearTotals?.bbl?.sales_count || 0);
        baseBblVolume = prevCumulative.bbl.total_volume_bluna - (window.salesHistory.yearTotals?.bbl?.volume_bluna || 0);
        baseBoostSales = prevCumulative.boost.total_sales - (window.salesHistory.yearTotals?.boost?.sales_count || 0);
        baseBoostVolume = prevCumulative.boost.total_volume_usd - (window.salesHistory.yearTotals?.boost?.volume_usd || 0);
    } else if (prevCumulative) {
        // New year - use all of previous cumulative
        baseBblSales = prevCumulative.bbl.total_sales;
        baseBblVolume = prevCumulative.bbl.total_volume_bluna;
        baseBoostSales = prevCumulative.boost.total_sales;
        baseBoostVolume = prevCumulative.boost.total_volume_usd;
    }
    
    // Build monthly breakdown
    const bblMonthly = {};
    const boostMonthly = {};
    
    allBblSales.forEach(s => {
        const month = s.timestamp?.substring(0, 7);
        if (!month) return;
        if (!bblMonthly[month]) bblMonthly[month] = { count: 0, volume_bluna: 0, volume_usd: 0 };
        bblMonthly[month].count++;
        bblMonthly[month].volume_bluna += s.amount;
        bblMonthly[month].volume_usd += s.usd || 0;
    });
    
    allBoostSales.forEach(s => {
        const month = s.timestamp?.substring(0, 7);
        if (!month) return;
        if (!boostMonthly[month]) boostMonthly[month] = { count: 0, volume_usd: 0 };
        boostMonthly[month].count++;
        boostMonthly[month].volume_usd += s.usd_at_time || 0;
    });
    
    // Sort monthly keys descending
    const sortedBblMonthly = Object.fromEntries(
        Object.entries(bblMonthly).sort((a, b) => b[0].localeCompare(a[0]))
            .map(([k, v]) => [k, { count: v.count, volume_bluna: Math.round(v.volume_bluna * 100) / 100, volume_usd: Math.round(v.volume_usd * 100) / 100 }])
    );
    const sortedBoostMonthly = Object.fromEntries(
        Object.entries(boostMonthly).sort((a, b) => b[0].localeCompare(a[0]))
            .map(([k, v]) => [k, { count: v.count, volume_usd: Math.round(v.volume_usd * 100) / 100 }])
    );
    
    // Build output JSON
    const output = {
        meta: {
            version: "1.1",
            year: targetYear,
            generated_at: new Date().toISOString(),
            description: `AllianceDAO NFT sales data for ${targetYear}`,
            note: "BBL and Boost volumes include USD values. Historical data merged with new epoch sales."
        },
        year_totals: {
            bbl: {
                sales_count: allBblSales.length,
                volume_bluna: Math.round(yearBblVolume * 100) / 100,
                volume_usd: Math.round(yearBblVolumeUsd * 100) / 100,
                date_range: {
                    first: bblDates.length ? bblDates.reduce((a, b) => a < b ? a : b) : null,
                    last: bblDates.length ? bblDates.reduce((a, b) => a > b ? a : b) : null
                }
            },
            boost: {
                sales_count: allBoostSales.length,
                volume_usd: Math.round(yearBoostVolume * 100) / 100,
                date_range: {
                    first: boostDates.length ? boostDates.reduce((a, b) => a < b ? a : b) : null,
                    last: boostDates.length ? boostDates.reduce((a, b) => a > b ? a : b) : null
                }
            }
        },
        cumulative_totals: {
            through_year: targetYear,
            bbl: {
                total_sales: baseBblSales + allBblSales.length,
                total_volume_bluna: Math.round((baseBblVolume + yearBblVolume) * 100) / 100
            },
            boost: {
                total_sales: baseBoostSales + allBoostSales.length,
                total_volume_usd: Math.round((baseBoostVolume + yearBoostVolume) * 100) / 100
            },
            combined_sales: baseBblSales + allBblSales.length + baseBoostSales + allBoostSales.length
        },
        monthly_breakdown: {
            bbl: sortedBblMonthly,
            boost: sortedBoostMonthly
        },
        sales: {
            bbl: allBblSales,
            boost: allBoostSales
        }
    };
    
    // Build top 10 sales section
    // Start with existing top 10 or empty array
    let top10Sales = window.salesHistory.top10?.sales?.filter(s => s !== null) || [];
    
    // Check new sales against top 10
    const allNewSales = [...newBblSales, ...newBoostSales];
    let newTop10Count = 0;
    
    allNewSales.forEach(sale => {
        const saleUsd = sale.usd || sale.usd_at_time || 0;
        if (saleUsd <= 0) return;
        
        // Get token price for the sale
        const tokenPrice = sale.usd ? (sale.usd / sale.amount) : (sale.price_at_time || 0);
        
        const newEntry = {
            nft_id: sale.nft_id,
            amount: sale.amount,
            token: sale.token,
            usd_value: Math.round(saleUsd * 100) / 100,
            luna_price: Math.round(tokenPrice * 10000) / 10000,
            date: sale.timestamp?.substring(0, 10) || new Date().toISOString().substring(0, 10),
            marketplace: sale.marketplace || 'bbl'
        };
        
        // Check if this sale qualifies for top 10
        if (top10Sales.length < 10) {
            // Not full yet, just add
            top10Sales.push(newEntry);
            newTop10Count++;
        } else {
            // Find lowest USD value in current top 10
            const minUsd = Math.min(...top10Sales.map(s => s.usd_value));
            if (saleUsd > minUsd) {
                // Remove the lowest and add new one
                const minIdx = top10Sales.findIndex(s => s.usd_value === minUsd);
                top10Sales.splice(minIdx, 1);
                top10Sales.push(newEntry);
                newTop10Count++;
            }
        }
    });
    
    // Sort by USD value descending and re-rank
    top10Sales.sort((a, b) => b.usd_value - a.usd_value);
    top10Sales = top10Sales.slice(0, 10); // Keep only top 10
    top10Sales.forEach((s, i) => s.rank = i + 1);
    
    // Pad with nulls if less than 10
    while (top10Sales.length < 10) {
        top10Sales.push(null);
    }
    
    const minToQualify = top10Sales.filter(s => s !== null).length > 0 
        ? Math.min(...top10Sales.filter(s => s !== null).map(s => s.usd_value))
        : null;
    
    output.top_10_sales_all_time = {
        note: "Top 10 NFT sales by USD value through end of this year",
        last_updated: new Date().toISOString().substring(0, 10),
        minimum_usd_to_qualify: minToQualify,
        sales: top10Sales
    };
    
    // Create and download file
    const blob = new Blob([JSON.stringify(output, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `nft-sales-${targetYear}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    // Show summary
    const newBblCount = newBblSales.length;
    const newBoostCount = newBoostSales.length;
    let summaryMsg = `Downloaded nft-sales-${targetYear}.json\n\nNew sales added: ${newBblCount} BBL, ${newBoostCount} Boost\nTotal in file: ${allBblSales.length} BBL, ${allBoostSales.length} Boost\nCumulative all-time: ${output.cumulative_totals.combined_sales} sales`;
    
    if (newTop10Count > 0) {
        summaryMsg += `\n\nüèÜ ${newTop10Count} new sale(s) made it into the TOP 10 ALL-TIME!`;
    }
    
    alert(summaryMsg);
}

// Save all NFT stats
function saveNftStats() {
    // Read all manual inputs
    store.nftStats.brokenCount = parseInt($('nft-broken-input')?.value) || 0;
    store.nftStats.unbrokenCount = NFT_TOTAL_SUPPLY - store.nftStats.brokenCount;
    store.nftStats.mintedCount = parseInt($('nft-minted-input')?.value) || 0;
    store.nftStats.unmintedCount = NFT_TOTAL_SUPPLY - store.nftStats.mintedCount;
    store.nftStats.daodaoStaked = parseInt($('nft-daodao-input')?.value) || 0;
    store.nftStats.daodaoStakedPct = parseFloat($('nft-daodao-pct-input')?.value) || 0;
    store.nftStats.enterpriseStaked = parseInt($('nft-enterprise-input')?.value) || 0;
    store.nftStats.daoMembers = parseInt($('nft-members-input')?.value) || 0;
    store.nftStats.daoBrokenHeld = parseInt($('nft-dao-broken-input')?.value) || 0;
    store.nftStats.circulatingSupply = parseInt($('nft-circ-input')?.value) || 0;
    store.nftStats.liquidSupply = parseInt($('nft-liquid-input')?.value) || 0;
    
    // Backing per NFT
    store.nftStats.backingAmpLuna = parseFloat($('nft-back-amp-input')?.value) || 0;
    let ampPrice = getTokenPrice('ampLUNA');
    let lunaPrice = getTokenPrice('LUNA');
    store.nftStats.backingLuna = lunaPrice > 0 ? (store.nftStats.backingAmpLuna * ampPrice / lunaPrice) : 0;
    store.nftStats.backingUsd = store.nftStats.backingAmpLuna * ampPrice;
    
    // BBL floors - separate broken/unbroken
    let bblUnbrokenAmt = parseFloat($('nft-bbl-floor-unbroken-amt')?.value) || 0;
    let bblUnbrokenToken = $('nft-bbl-floor-unbroken-token')?.value || 'bLUNA';
    let bblBrokenAmt = parseFloat($('nft-bbl-floor-broken-amt')?.value) || 0;
    let bblBrokenToken = $('nft-bbl-floor-broken-token')?.value || 'bLUNA';
    
    store.nftStats.bblFloor = {
        unbroken: bblUnbrokenAmt > 0 ? {
            amount: bblUnbrokenAmt,
            token: bblUnbrokenToken,
            usd: bblUnbrokenAmt * getTokenPrice(bblUnbrokenToken)
        } : null,
        broken: bblBrokenAmt > 0 ? {
            amount: bblBrokenAmt,
            token: bblBrokenToken,
            usd: bblBrokenAmt * getTokenPrice(bblBrokenToken)
        } : null
    };
    
    // BBL Volume with USD
    let bblVolAmt = parseFloat($('nft-bbl-volume')?.value) || 0;
    let bLunaPrice = getTokenPrice('bLUNA');
    store.nftStats.bblVolume = {
        amount: bblVolAmt,
        token: 'bLUNA',
        usd: bblVolAmt * bLunaPrice
    };
    
    // Boost floors - separate broken/unbroken, any token
    let boostUnbrokenAmt = parseFloat($('nft-boost-floor-unbroken-amt')?.value) || 0;
    let boostUnbrokenToken = $('nft-boost-floor-unbroken-token')?.value?.trim() || 'LUNA';
    let boostBrokenAmt = parseFloat($('nft-boost-floor-broken-amt')?.value) || 0;
    let boostBrokenToken = $('nft-boost-floor-broken-token')?.value?.trim() || 'USDC';
    
    store.nftStats.boostFloor = {
        unbroken: boostUnbrokenAmt > 0 ? {
            amount: boostUnbrokenAmt,
            token: boostUnbrokenToken,
            usd: boostUnbrokenAmt * getTokenPrice(boostUnbrokenToken)
        } : null,
        broken: boostBrokenAmt > 0 ? {
            amount: boostBrokenAmt,
            token: boostBrokenToken,
            usd: boostBrokenAmt * getTokenPrice(boostBrokenToken)
        } : null
    };
    
    // Boost volume is N/A
    store.nftStats.boostVolume = null;
    
    // Calculate listing totals
    store.nftStats.bblListingsBroken = (store.nftStats.bblListingItems || []).filter(l => l.broken).length;
    store.nftStats.bblListingsUnbroken = (store.nftStats.bblListingItems || []).filter(l => !l.broken).length;
    store.nftStats.bblListingsTotal = (store.nftStats.bblListingItems || []).length;
    
    store.nftStats.boostListingsBroken = (store.nftStats.boostListingItems || []).filter(l => l.broken).length;
    store.nftStats.boostListingsUnbroken = (store.nftStats.boostListingItems || []).filter(l => !l.broken).length;
    store.nftStats.boostListingsTotal = (store.nftStats.boostListingItems || []).length;
    
    alert('NFT stats saved!');
    
    // Update status
    const status = $('nft-status');
    if (status) {
        status.textContent = 'Saved';
        status.className = 'px-3 py-1 rounded text-[10px] font-bold bg-green-900/50 text-green-400';
    }
    
    updateTabStatus('nft', 'complete');
}

function validateExportData() {
    let issues = [];
    let warnings = [];
    
    // Check Vote data
    if (!store.vote.ep) issues.push('No epoch detected from Vote page');
    if (!store.vote.tvp) issues.push('No total voting power detected');
    if (store.vote.pools.length === 0) issues.push('No pools parsed from Vote page');
    
    // Check ext data - but recognize data loaded from file is valid
    if (!store.ext.loaded) warnings.push('Ext data not loaded from GitHub');
    if (!store.ext.votion) warnings.push('No Votion data available');
    if (!store.ext.pdBribesEpoch) warnings.push('No PD bribes data for this epoch');
    if (Object.keys(store.ext.lps || {}).length === 0 && !store.ext.lps?.loaded_from_file) {
        warnings.push('No historical LP data available');
    }
    
    // Check for pools with missing data
    // Note: Many pools legitimately have 0 Votion votes - only warn if NO pools have votion data
    let poolsWithVotion = store.vote.pools.filter(p => p.votNowVp > 0 || p.votNextVp > 0).length;
    let poolsWithApr = store.vote.pools.filter(p => p.aprNon > 0).length;
    let poolsWith4Ep = store.vote.pools.filter(p => p.liq4Ep).length;
    
    // Only warn about missing data if we have VERY little data
    if (poolsWithVotion === 0 && store.ext.votion) {
        warnings.push('Votion data loaded but no pools matched');
    }
    if (poolsWithApr < store.vote.pools.length * 0.3) {
        warnings.push(`Only ${poolsWithApr}/${store.vote.pools.length} pools have APR data`);
    }
    if (poolsWith4Ep < store.vote.pools.length * 0.3) {
        warnings.push(`Only ${poolsWith4Ep}/${store.vote.pools.length} pools have 4-epoch averages`);
    }
    
    // Check DAO allocations
    if (!store.dao.lVp) warnings.push('No aDAO voting power detected');
    
    return {
        valid: issues.length === 0,
        ready_for_export: issues.length === 0 && warnings.length <= 2,
        issues: issues,
        warnings: warnings,
        summary: {
            vote_parsed: !!store.vote.ep,
            ext_loaded: store.ext.loaded,
            votion_matched: store.vote.pools.filter(p => p.votNowVp > 0).length,
            apr_matched: store.vote.pools.filter(p => p.aprNon > 0).length,
            historical_matched: store.vote.pools.filter(p => p.liq4Ep).length
        }
    };
}

function downloadCoreJson() {
    let data = buildExportData();
    let s = data.validation.summary;
    
    // Determine epoch/phase for filename - use manual mode if active
    let fileEpoch = manualMode.active ? manualMode.epoch : (store.vote.ep || 'unknown');
    let filePhase = manualMode.active ? manualMode.phase : (getPhaseString() || 'unknown');
    
    // Check for file status warnings (red = missing, yellow = needs update)
    const statusWarnings = getExportWarnings();
    if (statusWarnings.length > 0) {
        let statusMsg = '‚ö†Ô∏è FILE STATUS WARNINGS:\n\n' + statusWarnings.map(w => '‚Ä¢ ' + w).join('\n');
        statusMsg += '\n\nThese files need attention. Continue with export anyway?';
        if (!confirm(statusMsg)) return;
    }
    
    // Build a helpful summary message
    let summaryLines = [
        `üìä ${store.vote.pools.length} pools`,
        `üéØ ${s.votion_matched} with Votion data`,
        `üìà ${s.apr_matched} with APR data`,
        `üìâ ${s.historical_matched} with 4-epoch history`,
        `üîí ${store.dao.locks?.length || 0} aDAO locks`,
        `üíß ${store.tla.pools?.length || 0} TLA liquidity pools`,
        `üè∑Ô∏è ${Object.keys(assetMetadata).length} asset metadata`,
        `üîÑ Scores recalculated with current metadata`
    ];
    
    // Add manual mode warning if active
    if (manualMode.active) {
        summaryLines.unshift(`‚ö†Ô∏è MANUAL MODE: Epoch ${fileEpoch} (${filePhase})`);
        summaryLines.unshift(`üìÖ Timestamp: ${new Date(manualMode.timestamp).toLocaleString()}`);
    }
    
    // Check validation
    if (!data.validation.valid) {
        let msg = '‚ùå Export has critical issues:\n\n' + data.validation.issues.join('\n');
        if (!confirm(msg + '\n\nExport anyway?')) return;
    } else if (data.validation.warnings.length > 0) {
        let msg = '‚ö†Ô∏è Export warnings:\n' + data.validation.warnings.join('\n');
        msg += '\n\n‚úÖ Data summary:\n' + summaryLines.join('\n');
        msg += '\n\nContinue with export?';
        if (!confirm(msg)) return;
    } else {
        // All good - show summary
        let msg = '‚úÖ Export ready!\n\n' + summaryLines.join('\n');
        msg += '\n\nProceed with download?';
        if (!confirm(msg)) return;
    }
    
    let jsonStr = JSON.stringify(data, null, 2);
    let blob = new Blob([jsonStr], { type: 'application/json' });
    let url = URL.createObjectURL(blob);
    let a = document.createElement('a');
    a.href = url;
    
    // Use _test suffix if ext file was a test file
    const testSuffix = store.extFile.isTest ? '_test' : '';
    a.download = `tla-data-epoch-${fileEpoch}-${filePhase}${testSuffix}.json`;
    
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    // Show summary
    let completeMsg = `Export complete!\n\nPools: ${data.pools.length}\nVotion matched: ${data.validation.summary.votion_matched}\nAPR matched: ${data.validation.summary.apr_matched}\nHistorical: ${data.validation.summary.historical_matched}`;
    if (store.extFile.isTest) {
        completeMsg += `\n\nüß™ TEST MODE - File saved as _test.json`;
    }
    if (manualMode.active) {
        completeMsg += `\n\n‚ö†Ô∏è This is a MANUAL EDIT for Epoch ${fileEpoch}`;
    }
    alert(completeMsg);
}

function copyExportJson() {
    let data = buildExportData();
    let jsonStr = JSON.stringify(data, null, 2);
    navigator.clipboard.writeText(jsonStr).then(() => {
        alert('JSON copied to clipboard!\n\nPools: ' + data.pools.length);
    }).catch(err => {
        console.error('Copy failed:', err);
        alert('Copy failed - check console');
    });
}

// ============ aDAO VOTE ALLOCATIONS FALLBACK ============
// Load aDAO vote allocations from previous epoch and apply to current pools
async function loadAdaoAllocationsFromFallback() {
    // Check if we already have data loaded from file upload
    let data = lastEpochData;
    if (!data || !data.dao) {
        data = await loadLastEpochForFallback();
    }
    
    if (!data) {
        alert('Could not load previous epoch data.\n\nTry uploading a snapshot file first.');
        return;
    }
    
    const allocations = data.dao?.allocations || [];
    if (allocations.length === 0) {
        alert('No aDAO vote allocations found in the previous epoch data.');
        return;
    }
    
    console.log('Loading aDAO allocations from E' + lastEpochInfo.epoch, allocations);
    
    // Apply allocations to current pools
    let matched = 0;
    let notFound = [];
    
    allocations.forEach(alloc => {
        // Find matching pool in current data
        const pool = store.vote.pools.find(p => 
            p.n === alloc.pool && 
            (p.d.includes(alloc.dex) || alloc.dex.includes('Astroport') && isAstroport(p.d) || alloc.dex.includes('Skeleton') && isSkeletonSwap(p.d))
        );
        
        if (pool) {
            pool.mvp = alloc.vp || 0;  // aDAO VP
            pool.ms = alloc.pct || 0;   // aDAO % of pool
            matched++;
        } else {
            notFound.push(`${alloc.pool} (${alloc.dex})`);
        }
    });
    
    // Store allocations for export
    store.dao.allocs = allocations;
    
    // Update fallback status
    fallbackStatus.adaoVotes = 'last';
    fallbackOverrides.comments.adaoVotes = `aDAO vote allocations loaded from E${lastEpochInfo.epoch}`;
    
    // Re-render table
    renderVoteTable();
    
    // Show result
    let msg = `‚úÖ aDAO Vote Allocations Applied!\n\nSource: E${lastEpochInfo.epoch}\nMatched: ${matched}/${allocations.length} pools`;
    if (notFound.length > 0 && notFound.length <= 5) {
        msg += `\n\nNot found: ${notFound.join(', ')}`;
    } else if (notFound.length > 5) {
        msg += `\n\n${notFound.length} pools not found in current data`;
    }
    alert(msg);
}

// ============ FALLBACK EDITOR MODAL ============
// Stores manual overrides and comments
let fallbackOverrides = {
    comments: {},      // { 'voteRewards': 'DAODAO was down...', ... }
    sourceEpoch: null
};

// Unified skip function
function skipFallback(section) {
    const sectionMap = {
        adaoVotes: { status: 'adaoVotes', paste: null },  // No paste indicator for this
        voteRewards: { status: 'voteRewards', paste: 'ps-vote-rew' },
        deposits: { status: 'daoData', paste: 'ps-liq-dep' },
        unclaimed: { status: 'unclaimed', paste: 'ps-liq-rew' },
        locks: { status: 'locks', paste: 'ps-locks' },
        allDao: { status: 'daoData', paste: ['ps-vote-rew', 'ps-liq-dep', 'ps-liq-rew', 'ps-locks'] }
    };
    
    const map = sectionMap[section];
    if (!map) return;
    
    fallbackStatus[map.status] = 'skip';
    
    // Update paste indicators to gray (skipped)
    const pasteIds = Array.isArray(map.paste) ? map.paste : [map.paste];
    pasteIds.forEach(id => {
        const el = $(id);
        if (el) el.className = 'px-2 py-0.5 rounded bg-gray-700 text-gray-400 border border-gray-600';
    });
    
    // Also set pasteStatus to true so it counts as "done"
    if (section === 'voteRewards') pasteStatus.voteRew = true;
    if (section === 'deposits') pasteStatus.liqDep = true;
    if (section === 'unclaimed') pasteStatus.liqRew = true;
    if (section === 'locks') pasteStatus.locks = true;
    if (section === 'allDao') {
        pasteStatus.voteRew = true;
        pasteStatus.liqDep = true;
        pasteStatus.liqRew = true;
        pasteStatus.locks = true;
    }
    
    alert(`${section} skipped - will export as empty/zero`);
}

function openFallbackEditor(section) {
    // section = 'voteRewards', 'deposits', 'unclaimed', 'locks', or 'allDao'
    console.log('Opening fallback editor for:', section);
    
    // Check if we already have data loaded from file upload
    const loadData = async () => {
        if (lastEpochData && lastEpochData.dao) {
            console.log('Using already loaded fallback data from E' + lastEpochInfo.epoch);
            return lastEpochData;
        }
        return await loadLastEpochForFallback();
    };
    
    loadData().then(data => {
        if (!data) {
            alert('Could not load previous epoch data.\n\nTry uploading a snapshot file using the file picker below the fallback options.');
            return;
        }
        
        console.log('Loaded fallback data:', data);
        console.log('DAO section:', data.dao);
        fallbackOverrides.sourceEpoch = lastEpochInfo.epoch;
        
        const modal = $('fallback-editor-modal');
        const title = $('fallback-editor-title');
        const content = $('fallback-editor-content');
        const comment = $('fallback-comment');
        
        if (!modal || !title || !content) {
            console.error('Modal elements not found!');
            alert('Error: Modal elements not found');
            return;
        }
        
        // Set title based on section
        const titles = {
            voteRewards: 'Vote Rewards (Rewards Popup)',
            deposits: 'Deposits (Deposits Popup)',
            unclaimed: 'Unclaimed (Unclaimed Popup)',
            locks: 'Locks',
            allDao: 'All aDAO Data'
        };
        title.innerText = `Fallback: ${titles[section] || section} from E${lastEpochInfo.epoch}`;
        
        // Store which section we're editing
        modal.dataset.section = section;
        
        // Load existing comment if any
        comment.value = fallbackOverrides.comments[section] || '';
        
        // Build content based on section
        let html = `<div class="text-xs text-cyan-400 mb-3 p-2 bg-cyan-900/20 rounded border border-cyan-800">
            üì• Loading data from <span class="font-bold">Epoch ${lastEpochInfo.epoch}</span> (${lastEpochInfo.phase}).
            Review and edit values below, then click Save & Apply.
        </div>`;
        
        if (section === 'allDao') {
            html += buildAllDaoEditor(data);
        } else if (section === 'voteRewards') {
            html += buildVoteRewardsEditor(data);
        } else if (section === 'deposits') {
            html += buildDepositsEditor(data);
        } else if (section === 'unclaimed') {
            html += buildUnclaimedEditor(data);
        } else if (section === 'locks') {
            html += buildLocksEditor(data);
        }
        
        content.innerHTML = html;
        
        // Show modal using the correct class
        modal.classList.add('open');
        console.log('Modal opened');
    }).catch(err => {
        console.error('Error in openFallbackEditor:', err);
        alert('Error loading fallback data: ' + err.message);
    });
}

// Helper to create input with clear button
function fbInput(id, value, label, step = '0.01') {
    // Use text input to allow ??? character, but style like number
    const displayVal = value === '???' ? '???' : value;
    const isUnknown = displayVal === '???';
    return `
        <div>
            <label class="text-[10px] text-gray-400">${label}</label>
            <div class="flex gap-1">
                <input type="text" id="${id}" value="${displayVal}" 
                    class="flex-1 bg-gray-800 border border-gray-600 rounded px-2 py-1 text-xs text-right ${isUnknown ? 'text-yellow-400' : ''}"
                    ondblclick="this.select()" data-step="${step}"
                    oninput="if(this.value !== '???') this.value = this.value.replace(/[^0-9.-]/g, ''); this.classList.toggle('text-yellow-400', this.value === '???')">
                <button onclick="document.getElementById('${id}').value='';document.getElementById('${id}').focus();document.getElementById('${id}').classList.remove('text-yellow-400')" 
                    class="px-1.5 bg-gray-700 hover:bg-red-900/50 text-gray-400 hover:text-red-400 rounded text-[10px]" title="Clear">‚úï</button>
                <button onclick="document.getElementById('${id}').value='???';document.getElementById('${id}').classList.add('text-yellow-400')" 
                    class="px-1.5 bg-yellow-900/30 hover:bg-yellow-900/50 text-yellow-500 hover:text-yellow-400 rounded text-[10px] font-bold" title="Mark as unknown/problem">???</button>
            </div>
        </div>
    `;
}

function buildAllDaoEditor(data) {
    const dao = data.dao || {};
    const vote = data.vote || {};
    
    return `
        <div class="text-[9px] text-gray-500 mb-2 italic">üí° Double-click to select all | ‚úï to clear | <span class="text-yellow-400 font-bold">???</span> to mark as unknown (shows in TLA Stats tooltips)</div>
        <div class="space-y-4">
            <!-- Vote Rewards Section -->
            <div class="bg-gray-900/50 p-3 rounded border border-cyan-800">
                <h4 class="text-sm font-bold text-cyan-400 mb-2">üìä Vote Rewards</h4>
                <div class="grid grid-cols-2 gap-3">
                    ${fbInput('fb-rebase', vote.rebase || 0, 'Rebase (ampLUNA)')}
                    ${fbInput('fb-rewards-usd', vote.rewards_usd || 0, 'Rewards USD')}
                </div>
                <div class="mt-2 text-[10px] text-gray-500">
                    Periods: ${dao.vote_reward_periods?.join(' - ') || 'None recorded'}
                </div>
                <div class="mt-2 max-h-24 overflow-y-auto">
                    ${buildVoteRewardsList(dao.vote_rewards || {})}
                </div>
            </div>
            
            <!-- Deposits Section -->
            <div class="bg-gray-900/50 p-3 rounded border border-green-800">
                <h4 class="text-sm font-bold text-green-400 mb-2">üí∞ Deposits</h4>
                <div class="grid grid-cols-2 gap-3">
                    ${fbInput('fb-deposit-usd', dao.deposit_usd || 0, 'Total USD')}
                    ${fbInput('fb-deposit-apr', dao.deposit_apr || 0, 'APR %', '0.1')}
                </div>
                <div class="mt-2 max-h-24 overflow-y-auto">
                    ${buildTokensList(dao.tokens || [])}
                </div>
            </div>
            
            <!-- Unclaimed Section -->
            <div class="bg-gray-900/50 p-3 rounded border border-yellow-800">
                <h4 class="text-sm font-bold text-yellow-400 mb-2">üéÅ Unclaimed Rewards</h4>
                <div class="grid grid-cols-3 gap-2">
                    ${fbInput('fb-rew-usd', dao.rewards?.usd || 0, 'USD Value')}
                    ${fbInput('fb-rew-z', dao.rewards?.zAssets || 0, 'zAssets', '0.0001')}
                    ${fbInput('fb-rew-amp', dao.rewards?.ampLUNA || 0, 'ampLUNA', '0.0001')}
                    <div>
                        <label class="text-[10px] text-gray-400">ampLUNA</label>
                        <input type="number" id="fb-rew-amp" value="${dao.rewards?.ampLUNA || 0}" step="0.0001"
                            class="w-full bg-gray-800 border border-gray-600 rounded px-2 py-1 text-xs">
                    </div>
                </div>
            </div>
            
            <!-- Locks Section -->
            <div class="bg-gray-900/50 p-3 rounded border border-purple-800">
                <h4 class="text-sm font-bold text-purple-400 mb-2">üîí Locks</h4>
                <div class="grid grid-cols-3 gap-2">
                    ${fbInput('fb-locked-vp', dao.locked_vp || 0, 'Locked VP', '1')}
                    ${fbInput('fb-power-factor', dao.power_factor || 0, 'Power Factor')}
                    ${fbInput('fb-underlying', dao.underlying_assets || 0, 'Underlying Assets')}
                </div>
                <div class="mt-2 text-[10px] text-gray-500">
                    ${dao.locks?.length || 0} locks in source data (will be copied as-is)
                </div>
            </div>
        </div>
    `;
}

function buildVoteRewardsEditor(data) {
    const dao = data.dao || {};
    const vote = data.vote || {};
    
    return `
        <div class="text-[9px] text-gray-500 mb-2 italic">üí° Double-click to select all | ‚úï to clear | <span class="text-yellow-400 font-bold">???</span> to mark as unknown</div>
        <div class="space-y-3">
            <div class="grid grid-cols-2 gap-3">
                ${fbInput('fb-rebase', vote.rebase || 0, 'Rebase (ampLUNA)')}
                ${fbInput('fb-rewards-usd', vote.rewards_usd || 0, 'Rewards USD')}
            </div>
            <div class="text-xs text-gray-500">
                Periods: ${dao.vote_reward_periods?.join(' - ') || 'None recorded'}
            </div>
            <h4 class="text-sm font-bold text-orange-400 border-b border-gray-700 pb-1 mt-3">Token Rewards</h4>
            <div class="max-h-48 overflow-y-auto space-y-1">
                ${buildVoteRewardsList(dao.vote_rewards || {})}
            </div>
        </div>
    `;
}

function buildDepositsEditor(data) {
    const dao = data.dao || {};
    
    return `
        <div class="text-[9px] text-gray-500 mb-2 italic">üí° Double-click to select all | ‚úï to clear | <span class="text-yellow-400 font-bold">???</span> to mark as unknown</div>
        <div class="space-y-3">
            <div class="grid grid-cols-2 gap-3">
                ${fbInput('fb-deposit-usd', dao.deposit_usd || 0, 'Total Deposit USD')}
                ${fbInput('fb-deposit-apr', dao.deposit_apr || 0, 'Average APR %', '0.1')}
            </div>
            <h4 class="text-sm font-bold text-green-400 border-b border-gray-700 pb-1 mt-3">Token Balances</h4>
            <div class="max-h-48 overflow-y-auto space-y-1">
                ${buildTokensList(dao.tokens || [])}
            </div>
        </div>
    `;
}

function buildUnclaimedEditor(data) {
    const dao = data.dao || {};
    
    return `
        <div class="text-[9px] text-gray-500 mb-2 italic">üí° Double-click to select all | ‚úï to clear | <span class="text-yellow-400 font-bold">???</span> to mark as unknown</div>
        <div class="space-y-3">
            <h4 class="text-sm font-bold text-yellow-400 border-b border-gray-700 pb-1">Unclaimed Rewards</h4>
            <div class="grid grid-cols-3 gap-3">
                ${fbInput('fb-rew-usd', dao.rewards?.usd || 0, 'USD Value')}
                ${fbInput('fb-rew-z', dao.rewards?.zAssets || 0, 'zAssets', '0.0001')}
                ${fbInput('fb-rew-amp', dao.rewards?.ampLUNA || 0, 'ampLUNA', '0.0001')}
            </div>
        </div>
    `;
}

function buildLocksEditor(data) {
    const dao = data.dao || {};
    
    return `
        <div class="text-[9px] text-gray-500 mb-2 italic">üí° Double-click to select all | ‚úï to clear | <span class="text-yellow-400 font-bold">???</span> to mark as unknown</div>
        <div class="space-y-3">
            <div class="grid grid-cols-3 gap-3">
                ${fbInput('fb-locked-vp', dao.locked_vp || 0, 'Locked VP', '1')}
                ${fbInput('fb-power-factor', dao.power_factor || 0, 'Power Factor')}
                ${fbInput('fb-underlying', dao.underlying_assets || 0, 'Underlying Assets')}
            </div>
            <div class="text-xs text-gray-500 mt-2">
                ${dao.locks?.length || 0} individual locks will be copied from E${lastEpochInfo.epoch}
            </div>
        </div>
    `;
}

function buildVoteRewardsList(vRew) {
    const entries = Object.entries(vRew);
    if (entries.length === 0) return '<div class="text-gray-600 text-xs italic p-2">No vote rewards data</div>';
    return entries.map(([token, amount]) => {
        const inputId = `fb-vrew-${token.replace(/[^a-zA-Z0-9]/g, '')}`;
        const isUnknown = amount === '???';
        return `
        <div class="flex justify-between items-center bg-gray-800/50 px-2 py-1 rounded text-xs gap-1">
            <span class="text-gray-300 flex-shrink-0">${token}</span>
            <div class="flex gap-1 items-center">
                <input type="text" id="${inputId}" value="${isUnknown ? '???' : amount}" 
                    class="bg-gray-900 border border-gray-700 rounded px-2 py-0.5 text-[10px] w-28 text-right ${isUnknown ? 'text-yellow-400' : ''}"
                    data-token="${token}" ondblclick="this.select()"
                    oninput="if(this.value !== '???') this.value = this.value.replace(/[^0-9.-]/g, ''); this.classList.toggle('text-yellow-400', this.value === '???')">
                <button onclick="document.getElementById('${inputId}').value='';document.getElementById('${inputId}').focus();document.getElementById('${inputId}').classList.remove('text-yellow-400')" 
                    class="px-1 bg-gray-700 hover:bg-red-900/50 text-gray-400 hover:text-red-400 rounded text-[8px]" title="Clear">‚úï</button>
                <button onclick="document.getElementById('${inputId}').value='???';document.getElementById('${inputId}').classList.add('text-yellow-400')" 
                    class="px-1 bg-yellow-900/30 hover:bg-yellow-900/50 text-yellow-500 hover:text-yellow-400 rounded text-[8px] font-bold" title="Mark unknown">???</button>
            </div>
        </div>
    `}).join('');
}

function buildTokensList(tokens) {
    if (!tokens || tokens.length === 0) return '<div class="text-gray-600 text-xs italic p-2">No token data</div>';
    return tokens.map((t, i) => {
        // Handle both formats: { s: 'CAPA', a: 123 } and { symbol: 'CAPA', amount: 123 }
        const symbol = t.symbol || t.s || t.name || 'Token ' + i;
        const amount = t.amount || t.a || t.balance || 0;
        const inputId = `fb-tok-${i}`;
        const isUnknown = amount === '???';
        return `
        <div class="flex justify-between items-center bg-gray-800/50 px-2 py-1 rounded text-xs gap-1">
            <span class="text-gray-300 flex-shrink-0">${symbol}</span>
            <div class="flex gap-1 items-center">
                <input type="text" id="${inputId}" value="${isUnknown ? '???' : amount}" 
                    class="bg-gray-900 border border-gray-700 rounded px-2 py-0.5 text-[10px] w-28 text-right ${isUnknown ? 'text-yellow-400' : ''}"
                    data-symbol="${symbol}" ondblclick="this.select()"
                    oninput="if(this.value !== '???') this.value = this.value.replace(/[^0-9.-]/g, ''); this.classList.toggle('text-yellow-400', this.value === '???')">
                <button onclick="document.getElementById('${inputId}').value='';document.getElementById('${inputId}').focus();document.getElementById('${inputId}').classList.remove('text-yellow-400')" 
                    class="px-1 bg-gray-700 hover:bg-red-900/50 text-gray-400 hover:text-red-400 rounded text-[8px]" title="Clear">‚úï</button>
                <button onclick="document.getElementById('${inputId}').value='???';document.getElementById('${inputId}').classList.add('text-yellow-400')" 
                    class="px-1 bg-yellow-900/30 hover:bg-yellow-900/50 text-yellow-500 hover:text-yellow-400 rounded text-[8px] font-bold" title="Mark unknown">???</button>
            </div>
        </div>
    `}).join('');
}

function closeFallbackEditor() {
    const modal = $('fallback-editor-modal');
    if (modal) {
        modal.classList.remove('open');
    }
}

// Helper to parse value - returns '???' string if unknown, otherwise number
function parseValueOrUnknown(el) {
    if (!el) return 0;
    const val = el.value?.trim();
    if (val === '???') return '???';
    return parseFloat(val) || 0;
}

// Track fields marked as ??? with their section for export
let unknownFieldsMap = {};  // { 'dao.rebase': true, 'dao.deposit_usd': true, ... }

function saveFallbackData() {
    const modal = $('fallback-editor-modal');
    const section = modal.dataset.section;
    const comment = $('fallback-comment')?.value?.trim() || '';
    
    console.log('Saving fallback data for section:', section);
    
    // Save comment
    if (comment) {
        fallbackOverrides.comments[section] = comment;
    }
    
    // Read values from form and apply to store based on section
    if (section === 'allDao' || section === 'voteRewards') {
        const rebaseVal = parseValueOrUnknown($('fb-rebase'));
        const rewardsVal = parseValueOrUnknown($('fb-rewards-usd'));
        
        store.vote.reb = rebaseVal;
        store.vote.usd = rewardsVal;
        
        if (rebaseVal === '???') unknownFieldsMap['vote.rebase'] = true;
        if (rewardsVal === '???') unknownFieldsMap['vote.rewards_usd'] = true;
        
        // Collect vote rewards
        const vRewInputs = document.querySelectorAll('[id^="fb-vrew-"]');
        store.dao.vRew = {};
        vRewInputs.forEach(inp => {
            const token = inp.dataset.token;
            const val = inp.value?.trim();
            if (token) {
                if (val === '???') {
                    store.dao.vRew[token] = '???';
                    unknownFieldsMap[`vote_rewards.${token}`] = true;
                } else {
                    const num = parseFloat(val) || 0;
                    if (num > 0) store.dao.vRew[token] = num;
                }
            }
        });
        
        if (lastEpochData?.dao?.vote_reward_periods) {
            store.dao.vRewPeriods = lastEpochData.dao.vote_reward_periods;
        }
        
        fallbackStatus.voteRewards = 'last';
        pasteStatus.voteRew = true;
        updatePasteStatus('ps-vote-rew', true);
        $('ps-vote-rew').className = 'px-2 py-0.5 rounded bg-yellow-900/50 text-yellow-400 border border-yellow-700';
    }
    
    if (section === 'allDao' || section === 'deposits') {
        const depVal = parseValueOrUnknown($('fb-deposit-usd'));
        const aprVal = parseValueOrUnknown($('fb-deposit-apr'));
        
        store.dao.dep = depVal;
        store.dao.apr = aprVal;
        
        if (depVal === '???') unknownFieldsMap['dao.deposit_usd'] = true;
        if (aprVal === '???') unknownFieldsMap['dao.deposit_apr'] = true;
        
        // Collect tokens
        const tokInputs = document.querySelectorAll('[id^="fb-tok-"]');
        store.dao.toks = [];
        tokInputs.forEach(inp => {
            const symbol = inp.dataset.symbol;
            const val = inp.value?.trim();
            if (symbol) {
                if (val === '???') {
                    store.dao.toks.push({ symbol, amount: '???' });
                    unknownFieldsMap[`tokens.${symbol}`] = true;
                } else {
                    const num = parseFloat(val) || 0;
                    store.dao.toks.push({ symbol, amount: num });
                }
            }
        });
        
        fallbackStatus.daoData = 'last';
        pasteStatus.liqDep = true;
        updatePasteStatus('ps-liq-dep', true);
        $('ps-liq-dep').className = 'px-2 py-0.5 rounded bg-yellow-900/50 text-yellow-400 border border-yellow-700';
    }
    
    if (section === 'allDao' || section === 'unclaimed') {
        const usdVal = parseValueOrUnknown($('fb-rew-usd'));
        const zVal = parseValueOrUnknown($('fb-rew-z'));
        const ampVal = parseValueOrUnknown($('fb-rew-amp'));
        
        store.dao.rew = {
            usd: usdVal,
            z: zVal,
            amp: ampVal
        };
        
        if (usdVal === '???') unknownFieldsMap['rewards.usd'] = true;
        if (zVal === '???') unknownFieldsMap['rewards.zAssets'] = true;
        if (ampVal === '???') unknownFieldsMap['rewards.ampLUNA'] = true;
        
        fallbackStatus.unclaimed = 'last';
        pasteStatus.liqRew = true;
        updatePasteStatus('ps-liq-rew', true);
        $('ps-liq-rew').className = 'px-2 py-0.5 rounded bg-yellow-900/50 text-yellow-400 border border-yellow-700';
    }
    
    if (section === 'allDao' || section === 'locks') {
        const vpVal = parseValueOrUnknown($('fb-locked-vp'));
        const facVal = parseValueOrUnknown($('fb-power-factor'));
        const undVal = parseValueOrUnknown($('fb-underlying'));
        
        store.dao.lVp = vpVal;
        store.dao.lFac = facVal;
        store.dao.lAst = undVal;
        
        if (vpVal === '???') unknownFieldsMap['dao.locked_vp'] = true;
        if (facVal === '???') unknownFieldsMap['dao.power_factor'] = true;
        if (undVal === '???') unknownFieldsMap['dao.underlying_assets'] = true;
        
        // Copy locks from lastEpochData
        if (lastEpochData?.dao?.locks) {
            store.dao.locks = lastEpochData.dao.locks.map(l => ({
                id: l.id,
                amt: l.amount || l.amt || 0,
                asset: l.asset || 'LUNA',
                bucket: l.bucket,
                vp: l.vp || 0,
                usd: l.usd || 0,
                status: l.status || 'Unknown'
            }));
        }
        
        fallbackStatus.locks = 'last';
        pasteStatus.locks = true;
        updatePasteStatus('ps-locks', true);
        $('ps-locks').className = 'px-2 py-0.5 rounded bg-yellow-900/50 text-yellow-400 border border-yellow-700';
    }
    
    // Update UI displays
    updateDaoDisplays();
    renderVoteTable();
    renderLocks();
    
    // Show last epoch source
    const sourceEl = $('last-epoch-source');
    const fileEl = $('last-epoch-file');
    if (sourceEl) sourceEl.classList.remove('hidden');
    if (fileEl) fileEl.innerText = `Epoch ${lastEpochInfo.epoch} (${lastEpochInfo.phase})`;
    
    closeFallbackEditor();
    
    const unknownCount = Object.keys(unknownFieldsMap).length;
    let msg = `‚úÖ Fallback data applied from E${lastEpochInfo.epoch}!\n\nSection: ${section}`;
    if (unknownCount > 0) msg += `\n‚ö†Ô∏è ${unknownCount} field(s) marked as ???`;
    if (comment) msg += `\nComment: ${comment}`;
    alert(msg);
}


</script>

<!-- Fallback Editor Modal -->
<div id="fallback-editor-modal" class="modal-overlay" onclick="if(event.target===this)closeFallbackEditor()">
    <div class="modal-box" style="max-width: 700px; max-height: 85vh; overflow-y: auto;">
        <div class="flex justify-between items-center border-b border-gray-700 pb-2 mb-3">
            <h3 id="fallback-editor-title" class="font-bold text-cyan-400">Edit Fallback Data</h3>
            <span onclick="closeFallbackEditor()" class="cursor-pointer text-gray-400 hover:text-white text-xl">&times;</span>
        </div>
        
        <div id="fallback-editor-content" class="mb-4">
            <!-- Dynamic content inserted here -->
        </div>
        
        <div class="border-t border-gray-700 pt-3 mt-3">
            <label class="text-xs text-gray-400 block mb-1">
                üí¨ <span class="text-yellow-400">Comment</span> (explains why fallback was needed - saved to export for TLA Stats):
            </label>
            <textarea id="fallback-comment" rows="2" 
                class="w-full bg-gray-800 border border-gray-600 rounded px-2 py-1 text-xs"
                placeholder="e.g., DAODAO connection was down during E164 snapshot, using E163 data..."></textarea>
        </div>
        
        <div class="flex gap-2 mt-4">
            <button onclick="saveFallbackData()" 
                class="flex-1 bg-green-700 hover:bg-green-600 text-white px-4 py-2 rounded text-sm font-bold">
                ‚úì Save & Apply
            </button>
            <button onclick="closeFallbackEditor()" 
                class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded text-sm">
                Cancel
            </button>
        </div>
    </div>
</div>

</body>
</html>
