<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TLA Admin (Core)</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    body { font-family: 'Inter', monospace; background: #0D0D0D; color: #EAEAEA; }
    .input-dark { background: #1A1A1A; border: 1px solid #333; color: white; padding: 8px; border-radius: 6px; width: 100%; font-family: monospace; font-size: 0.75rem; resize: vertical; }
    .input-dark:focus { border-color: #2dd4bf; outline: none; }
    .tab-btn { padding: 8px 16px; border-radius: 6px; font-weight: 600; cursor: pointer; background: #1f2937; border: 1px solid #374151; color: #9ca3af; font-size: 0.8rem; transition: all 0.2s; }
    .tab-btn:hover { background: #374151; color: white; }
    .tab-btn.active { background: #2dd4bf; color: #000; border-color: #2dd4bf; }
    .workspace { display: none; } .workspace.active { display: block; }
    .preview-card { background: #111; border: 1px solid #333; border-radius: 8px; padding: 16px; }
    .btn-action { background: #333; color: white; padding: 6px; border-radius: 6px; font-size: 0.75rem; width: 100%; margin-top: 8px; transition: 0.2s; font-weight: 600; }
    .btn-action:hover { background: #444; }
    .custom-scroll::-webkit-scrollbar { width: 6px; }
    .custom-scroll::-webkit-scrollbar-track { background: #0d0d0d; }
    .custom-scroll::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
    .filter-checkbox { accent-color: #2dd4bf; cursor: pointer; }
    .vote-grid { display: grid; grid-template-columns: 180px 65px 100px 100px 70px 80px 70px 85px 85px 85px 60px 120px 110px 80px; gap: 8px; align-items: center; }
    .liq-grid { display: grid; grid-template-columns: 190px 100px 65px 110px 110px 75px 85px 85px 110px 110px 110px 110px; gap: 8px; align-items: center; }
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 50; justify-content: center; align-items: center; }
    .modal-overlay.open { display: flex; }
    .modal-box { background: #1A1A1A; border: 1px solid #333; padding: 20px; border-radius: 8px; width: 800px; max-height: 80vh; overflow-y: auto; }
</style>
</head>
<body class="p-4 w-full max-w-[1600px] mx-auto min-h-screen flex flex-col">

<!-- HEADER -->
<header class="flex flex-col gap-4 mb-4 pb-4 border-b border-gray-800">
    <div class="flex justify-between items-start">
        <div class="flex flex-col">
            <h1 class="text-xl font-bold text-cyan-400 flex items-center gap-2">
                <i class="fas fa-layer-group"></i> TLA Admin <span class="text-gray-500 text-sm">Core</span>
                <span id="live-epoch" class="text-xs bg-gray-800 text-white px-2 py-0.5 rounded border border-gray-700 font-mono ml-2">Epoch ...</span>
            </h1>
            <div class="flex gap-4 mt-1 text-[10px] font-mono text-gray-500">
                <span class="flex items-center gap-1"><i class="far fa-clock text-cyan-600"></i> Ends: <span id="epoch-timer" class="text-gray-300">...</span> <span id="epoch-phase" class="text-yellow-400 font-bold ml-1">...</span></span>
                <span class="flex items-center gap-1"><i class="fas fa-sync text-green-600"></i> Rewards: <span id="reward-timer" class="text-gray-300">...</span></span>
                <div class="flex gap-2 ml-4 border-l border-gray-700 pl-4">
                    <span id="status-epoch-file" class="text-red-500 font-bold">Epoch File</span>
                    <span id="status-ext-data" class="text-red-500 font-bold">Ext Data</span>
                </div>
                <a id="github-link" href="#" target="_blank" class="flex items-center gap-1 ml-4 text-gray-500 hover:text-cyan-400 transition-colors">
                    <i class="fab fa-github"></i> <span id="github-filename">tla-data-epoch-...</span>
                </a>
            </div>
        </div>
        <div class="flex gap-2">
            <a href="https://defipatriot.github.io/aDAO-links-site/tla-tool_ext.html" target="_blank" class="bg-teal-900/30 hover:bg-teal-900/50 text-teal-300 border border-teal-700 px-3 py-1.5 rounded text-xs font-bold transition-colors flex items-center gap-1">
                <i class="fas fa-puzzle-piece"></i> Extensions
            </a>
            <button onclick="clearAll()" class="bg-red-900/20 hover:bg-red-900/40 text-red-400 border border-red-900/50 px-3 py-1.5 rounded text-xs font-bold transition-colors">Clear All</button>
            <button onclick="copyCoreJson()" class="bg-gray-800 hover:bg-gray-700 text-white border border-gray-600 px-3 py-1.5 rounded text-xs font-bold transition-colors">Copy JSON</button>
            <button onclick="downloadCoreJson()" class="bg-cyan-900/50 hover:bg-cyan-800 text-cyan-200 border border-cyan-700 px-3 py-1.5 rounded text-xs font-bold transition-colors">Download JSON</button>
        </div>
    </div>
</header>

<!-- SESSION MANAGER -->
<div class="bg-[#161616] border border-gray-800 rounded-lg p-3 mb-6">
    <div class="flex items-center gap-4 mb-3">
        <div class="flex-shrink-0 text-cyan-500 text-xl"><i class="fas fa-database"></i></div>
        <div class="flex-grow">
            <h3 class="text-xs font-bold text-gray-400 uppercase">Session Manager</h3>
            <p class="text-[10px] text-gray-600" id="load-msg">Looking for latest snapshot...</p>
        </div>
        <div class="flex items-center gap-2">
            <input type="number" id="historyEpoch" placeholder="Ep" class="input-dark w-16 text-center font-mono" onchange="updateGithubLink()">
            <select id="historyPhase" class="input-dark w-20 text-xs" onchange="updateGithubLink()">
                <option value="end">End</option>
                <option value="mid">Mid</option>
                <option value="start">Start</option>
            </select>
            <button onclick="fetchCoreData()" class="bg-cyan-900/30 hover:bg-cyan-900/50 text-cyan-200 border border-cyan-800 px-3 py-1.5 rounded text-xs font-bold transition-colors">Load Data</button>
        </div>
    </div>
    
    <!-- Paste Status Tracker -->
    <div class="border-t border-gray-800 pt-2">
        <div class="text-[9px] text-gray-500 uppercase font-bold mb-1">Paste Progress</div>
        <div class="flex gap-2 flex-wrap text-[9px] font-mono">
            <span id="ps-vote" class="px-2 py-0.5 rounded bg-gray-800 text-gray-500 border border-gray-700">Vote Page</span>
            <span id="ps-vote-rew" class="px-2 py-0.5 rounded bg-gray-800 text-gray-500 border border-gray-700">Vote Rewards</span>
            <span class="text-gray-700">|</span>
            <span id="ps-liq-active" class="px-2 py-0.5 rounded bg-gray-800 text-gray-500 border border-gray-700">Liq Active</span>
            <span id="ps-liq-inactive" class="px-2 py-0.5 rounded bg-gray-800 text-gray-500 border border-gray-700">Liq Inactive</span>
            <span id="ps-liq-dep" class="px-2 py-0.5 rounded bg-gray-800 text-gray-500 border border-gray-700">Deposits</span>
            <span id="ps-liq-rew" class="px-2 py-0.5 rounded bg-gray-800 text-gray-500 border border-gray-700">Unclaimed</span>
            <span class="text-gray-700">|</span>
            <span id="ps-locks" class="px-2 py-0.5 rounded bg-gray-800 text-gray-500 border border-gray-700">Locks</span>
            <span class="text-gray-700">|</span>
            <span id="ps-ext" class="px-2 py-0.5 rounded bg-gray-800 text-gray-500 border border-gray-700">Ext Data</span>
        </div>
    </div>
    
    <!-- Ext Data Manual Load -->
    <div id="ext-manual-load" class="border-t border-gray-800 pt-2 mt-2 hidden">
        <div class="flex items-center gap-3">
            <div class="text-[9px] text-teal-400 uppercase font-bold">Load Ext Data Manually</div>
            <input type="file" id="ext-file-input" accept=".json" class="text-[10px] text-gray-400" onchange="loadExtFromFile(event)">
            <button onclick="toggleExtPaste()" class="text-[9px] text-teal-400 hover:text-teal-200 underline">or paste JSON</button>
        </div>
        <div id="ext-paste-area" class="hidden mt-2">
            <textarea id="ext-paste" class="input-dark h-20 text-[10px]" placeholder="Paste tla_ext_historical.json or tla_ext_combined.json content here..."></textarea>
            <button onclick="loadExtFromPaste()" class="btn-action bg-teal-900/40 text-teal-200 border border-teal-900 mt-1">Load Ext JSON</button>
        </div>
    </div>
    
    <!-- JSON Export Controls -->
    <div class="border-t border-gray-800 pt-2 mt-2">
        <div class="flex justify-between items-center">
            <div>
                <div class="text-[9px] text-red-400 uppercase font-bold mb-1">‚ö†Ô∏è JSON Export - Data Exclusion</div>
                <div class="text-[8px] text-red-400/70">Unchecked items will be DELETED from JSON export, not just hidden</div>
            </div>
            <div class="flex gap-3 text-[10px] font-bold text-gray-400 bg-red-900/20 px-3 py-1.5 rounded border border-red-900/50">
                <label class="flex items-center gap-1 hover:text-white cursor-pointer"><input type="checkbox" id="export-astro" class="filter-checkbox" checked onchange="renderVoteTable()"> Astroport</label>
                <label class="flex items-center gap-1 hover:text-white cursor-pointer"><input type="checkbox" id="export-ww" class="filter-checkbox" checked onchange="renderVoteTable()"> WhiteWhale</label>
                <label class="flex items-center gap-1 hover:text-white cursor-pointer"><input type="checkbox" id="export-inactive" class="filter-checkbox" checked onchange="renderVoteTable()"> Inactive</label>
                <label class="flex items-center gap-1 hover:text-white cursor-pointer text-cyan-400"><input type="checkbox" id="export-adao" class="filter-checkbox" checked onchange="renderVoteTable()"> aDAO</label>
            </div>
        </div>
    </div>
</div>

<!-- TABS -->
<div class="flex gap-2 mb-4 border-b border-gray-800 pb-1">
    <div class="tab-btn active" onclick="switchTab('vote')">1. Vote</div>
    <div class="tab-btn" onclick="switchTab('liquidity')">2. Liquidity</div>
    <div class="tab-btn" onclick="switchTab('locks')">3. Locks</div>
</div>

<!-- WS 1: VOTE -->
<div id="ws-vote" class="workspace active">
    <div class="flex flex-col gap-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="bg-[#161616] p-3 rounded border border-gray-800">
                <div class="flex justify-between items-center mb-1">
                    <h3 class="text-orange-400 font-bold text-xs">1. Vote Page</h3>
                    <div class="flex items-center gap-2">
                        <span id="status-vote-page" class="text-[9px] text-gray-600 font-bold">PENDING</span>
                        <button onclick="clearPaste('votePaste')" class="text-[9px] text-red-400 hover:text-red-300">Clear</button>
                    </div>
                </div>
                <textarea id="votePaste" class="input-dark h-32" placeholder="Ctrl+A / Ctrl+C on TLA Vote Page connected to aDAO through DAODAO"></textarea>
                <button onclick="parseVote()" class="btn-action bg-cyan-900/40 text-cyan-200 border border-cyan-900">Parse Vote</button>
            </div>
            <div class="bg-[#161616] p-3 rounded border border-gray-800">
                <div class="flex justify-between items-center mb-1">
                    <h3 class="text-cyan-400 font-bold text-xs">2. Rewards Popup</h3>
                    <div class="flex items-center gap-2">
                        <span id="status-rewards" class="text-[9px] text-gray-600 font-bold">PENDING</span>
                        <button onclick="clearPaste('voteRewardsPaste')" class="text-[9px] text-red-400 hover:text-red-300">Clear</button>
                    </div>
                </div>
                <textarea id="voteRewardsPaste" class="input-dark h-32" placeholder="Select and copy txt from Claim pop-up"></textarea>
                <button onclick="parseVoteRewards()" class="btn-action">Parse Rewards</button>
            </div>
        </div>

        <div class="preview-card flex flex-col">
            <div class="flex flex-col gap-3 mb-4 border-b border-gray-700 pb-3">
                <!-- Row 1: Title -->
                <h3 class="text-lg font-bold text-white">Vote Dashboard</h3>
                
                <!-- Row 2: Epoch Info | DEX Tables | aDAO Stats -->
                <div class="grid grid-cols-12 gap-4 items-start">
                    <!-- Left: Epoch Info -->
                    <div class="col-span-2 flex flex-col gap-1">
                        <div class="text-[10px] text-gray-500 flex flex-col gap-1 bg-gray-900/50 p-2 rounded border border-gray-800">
                            <div class="flex justify-between"><span>Epoch:</span><span id="vote-ep" class="text-white font-bold">0</span></div>
                            <div class="flex justify-between"><span>Ends:</span><span id="vote-end" class="text-white">-</span></div>
                            <div class="flex justify-between"><span>Phase:</span><span id="vote-phase" class="text-yellow-400 font-bold">-</span></div>
                        </div>
                        <div class="text-[10px] text-orange-400 font-bold mt-1">
                            Total TLA VP: <span id="vote-tvp" class="text-orange-300">-</span>
                        </div>
                    </div>
                    
                    <!-- Center: DEX Comparison Tables -->
                    <div class="col-span-6 grid grid-cols-2 gap-2">
                        <!-- Astroport Table -->
                        <div class="bg-blue-900/20 border border-blue-900/50 rounded p-2">
                            <div class="text-[10px] font-bold text-blue-400 mb-1 border-b border-blue-900/50 pb-1">Astroport</div>
                            <div class="grid grid-cols-2 gap-x-2 gap-y-0.5 text-[9px]">
                                <span class="text-gray-500">Active LPs:</span><span id="dex-astro-active" class="text-white text-right">0</span>
                                <span class="text-gray-500">Inactive LPs:</span><span id="dex-astro-inactive" class="text-gray-400 text-right">0</span>
                                <span class="text-gray-500">Total Depth:</span><span id="dex-astro-depth" class="text-blue-300 text-right">$0</span>
                                <span class="text-gray-500">TLA Vote %:</span><span id="dex-astro-tla-pct" class="text-orange-400 text-right">0%</span>
                                <span class="text-gray-500">aDAO Vote %:</span><span id="dex-astro-adao-pct" class="text-cyan-400 text-right">0%</span>
                            </div>
                        </div>
                        <!-- WhiteWhale Table -->
                        <div class="bg-green-900/20 border border-green-900/50 rounded p-2">
                            <div class="text-[10px] font-bold text-green-400 mb-1 border-b border-green-900/50 pb-1">WhiteWhale</div>
                            <div class="grid grid-cols-2 gap-x-2 gap-y-0.5 text-[9px]">
                                <span class="text-gray-500">Active LPs:</span><span id="dex-ww-active" class="text-white text-right">0</span>
                                <span class="text-gray-500">Inactive LPs:</span><span id="dex-ww-inactive" class="text-gray-400 text-right">0</span>
                                <span class="text-gray-500">Total Depth:</span><span id="dex-ww-depth" class="text-green-300 text-right">$0</span>
                                <span class="text-gray-500">TLA Vote %:</span><span id="dex-ww-tla-pct" class="text-orange-400 text-right">0%</span>
                                <span class="text-gray-500">aDAO Vote %:</span><span id="dex-ww-adao-pct" class="text-cyan-400 text-right">0%</span>
                            </div>
                        </div>
                        <!-- Ext Data Legend -->
                        <div id="ext-data-legend" class="col-span-2 mt-1 text-[8px] text-gray-500 hidden">
                            <span class="text-teal-400">Teal</span> = 4Ep avg from ext data |
                            <span class="text-green-400">üü¢+50</span> Priority |
                            <span class="text-yellow-400">üü°+20</span> Opportunity |
                            <span class="text-gray-400">‚ö™0</span> Balanced |
                            <span class="text-blue-400">üîµ-20</span> Supported |
                            <span class="text-red-400">üî¥-50</span> Over-hyped
                        </div>
                    </div>
                    
                    <!-- Right: aDAO Stats -->
                    <div class="col-span-4 flex gap-3 justify-end">
                        <div class="text-center border-r border-gray-700 pr-3">
                            <div class="text-[9px] text-gray-500 uppercase">aDAO VP</div>
                            <div id="vote-adao-vp" class="text-sm text-cyan-400 font-bold font-mono">-</div>
                        </div>
                        <div class="text-center border-r border-gray-700 pr-3">
                            <div class="text-[9px] text-gray-500 uppercase">aDAO %</div>
                            <div id="vote-adao-pct" class="text-sm text-cyan-400 font-bold font-mono">-</div>
                        </div>
                        <div class="text-center border-r border-gray-700 pr-3">
                            <div class="text-[9px] text-gray-500 uppercase">Rebase</div>
                            <div id="vote-rebase" class="text-sm text-cyan-400 font-bold font-mono">0</div>
                        </div>
                        <div class="text-center">
                            <div class="text-[9px] text-gray-500 uppercase">Unclaimed</div>
                            <button onclick="togModal('vote-rew',1)" id="vote-claim" class="text-sm text-cyan-400 font-bold font-mono hover:underline hover:text-white cursor-pointer underline decoration-dotted">$0</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-indigo-900/20 text-indigo-200 rounded-t border-b border-gray-800">
                <div class="vote-grid text-[11px] uppercase font-bold px-3 py-2 whitespace-nowrap">
                    <div class="truncate" title="pool_name">Pool</div>
                    <div class="text-center text-gray-500" title="pool_status (active/inactive)">Status</div>
                    <div class="text-right text-teal-400 cursor-help" title="4-Epoch Average Liquidity" onclick="showScoreInfo('4ep-liq')">4Ep Liq</div>
                    <div class="text-right text-teal-400 cursor-help" title="4-Epoch Average Volume" onclick="showScoreInfo('4ep-vol')">4Ep Vol</div>
                    <div class="text-right text-yellow-400 cursor-help" title="Capital Efficiency = Vol/Liq" onclick="showScoreInfo('efficiency')">Effic</div>
                    <div class="text-right cursor-help" title="APR: Green=Non-Amp, Yellow=Amplified" onclick="showScoreInfo('apr')"><span class="text-green-400">APR</span>/<span class="text-yellow-400">üî•</span></div>
                    <div class="text-right text-cyan-400 cursor-help" title="Access Score (asset + bridge + LUNA)" onclick="showScoreInfo('access')">Access</div>
                    <div class="text-right text-purple-400" title="Votion Current Epoch (VP + %)">Vot Now</div>
                    <div class="text-right text-purple-300" title="Votion Next Epoch Optimization (VP + %)">Vot Next</div>
                    <div class="text-right text-green-400" title="Bribes: PD (green) / Total (yellow)">Bribes</div>
                    <div class="text-right text-orange-300 cursor-help" title="Support Score" onclick="showScoreInfo('support')">Supp</div>
                    <div class="text-right text-orange-400" title="TLA VP + Vote %">TLA Vote</div>
                    <div class="text-right text-cyan-400 adao-col" title="aDAO VP + Vote %">aDAO</div>
                    <div class="text-right text-emerald-400 cursor-help" title="aDAO Opportunity Score" onclick="showScoreInfo('adao-score')">Score</div>
                </div>
            </div>
            <div id="vote-list" class="max-h-[600px] overflow-y-auto text-xs bg-[#0D0D0D] p-2 border border-gray-800 rounded-b custom-scroll space-y-1"></div>
        </div>
    </div>
</div>

<!-- WS 2: LIQUIDITY -->
<div id="ws-liquidity" class="workspace">
    <div class="flex flex-col gap-4">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="bg-[#161616] p-3 rounded border border-gray-800">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-cyan-400 font-bold text-xs">1. Full Page Text</h3>
                    <div class="flex items-center gap-2">
                        <button onclick="clearPaste('liqFullPage')" class="text-[9px] text-red-400 hover:text-red-300">Clear</button>
                    </div>
                </div>
                <div class="flex items-center gap-2 mb-2 p-1.5 bg-gray-900 rounded border border-gray-700">
                    <label class="flex items-center gap-1 text-[10px] text-gray-400 cursor-pointer">
                        <input type="checkbox" id="liqInactiveToggle" class="w-3 h-3"> Inactive Pools
                    </label>
                    <button onclick="skipInactive()" class="text-[9px] text-yellow-400 hover:text-yellow-300 ml-auto">Skip Inactive</button>
                </div>
                <textarea id="liqFullPage" class="input-dark h-20" placeholder="Ctrl+A on Liquidity page..."></textarea>
                <button onclick="parseLiquidity()" class="btn-action text-cyan-200 bg-cyan-900/40 border border-cyan-900">Parse Pools</button>
            </div>
            <div class="bg-[#161616] p-3 rounded border border-gray-800">
                <div class="flex justify-between items-center mb-1">
                    <h3 class="text-blue-400 font-bold text-xs">2. Deposits Popup</h3>
                    <button onclick="clearPaste('liqDeposits')" class="text-[9px] text-red-400 hover:text-red-300">Clear</button>
                </div>
                <textarea id="liqDeposits" class="input-dark h-24" placeholder="Paste Token List..."></textarea>
                <button onclick="parseDeposits()" class="btn-action">Parse Deposits</button>
            </div>
            <div class="bg-[#161616] p-3 rounded border border-gray-800">
                <div class="flex justify-between items-center mb-1">
                    <h3 class="text-green-400 font-bold text-xs">3. Unclaimed Popup</h3>
                    <button onclick="clearPaste('liqRewards')" class="text-[9px] text-red-400 hover:text-red-300">Clear</button>
                </div>
                <textarea id="liqRewards" class="input-dark h-24" placeholder="zAssets..."></textarea>
                <button onclick="parseRewards()" class="btn-action">Parse Rewards</button>
            </div>
        </div>
        <div class="preview-card flex flex-col">
            <!-- Row 1: TLA Global | DEX Tables | aDAO Stats -->
            <div class="grid grid-cols-12 gap-3 mb-3 border-b border-gray-700 pb-3">
                <!-- TLA Global -->
                <div class="col-span-2 px-2">
                    <h3 class="text-xs font-bold text-orange-400 mb-1">TLA Global</h3>
                    <div class="flex justify-between text-[10px] text-gray-400"><span>TVL</span><span id="tla-tvl" class="text-white font-mono">$0</span></div>
                    <div class="flex justify-between text-[10px] text-gray-400"><span>Rew/Yr</span><span id="tla-rew" class="text-green-400 font-mono">$0</span></div>
                    <div class="flex justify-between text-[10px] text-gray-400"><span>Rew/Ep</span><span id="tla-rew-ep" class="text-green-400 font-mono">$0</span></div>
                </div>
                
                <!-- DEX Tables -->
                <div class="col-span-6 grid grid-cols-2 gap-2">
                    <!-- Astroport -->
                    <div class="bg-blue-900/20 border border-blue-900/50 rounded p-2">
                        <div class="text-[10px] font-bold text-blue-400 mb-1 border-b border-blue-900/50 pb-1">Astroport</div>
                        <div class="grid grid-cols-2 gap-x-2 gap-y-0.5 text-[9px]">
                            <span class="text-gray-500">Active LPs:</span><span id="liq-astro-active" class="text-white text-right">0</span>
                            <span class="text-gray-500">Total Depth:</span><span id="liq-astro-depth" class="text-blue-300 text-right">$0</span>
                            <span class="text-gray-500">TLA Staked:</span><span id="liq-astro-stk" class="text-orange-400 text-right">$0</span>
                            <span class="text-gray-500">TLA % Depth:</span><span id="liq-astro-pct" class="text-orange-300 text-right">0%</span>
                            <span class="text-gray-500">% of TVL:</span><span id="liq-astro-tvl" class="text-white font-bold text-right">0%</span>
                        </div>
                    </div>
                    <!-- WhiteWhale -->
                    <div class="bg-green-900/20 border border-green-900/50 rounded p-2">
                        <div class="text-[10px] font-bold text-green-400 mb-1 border-b border-green-900/50 pb-1">WhiteWhale</div>
                        <div class="grid grid-cols-2 gap-x-2 gap-y-0.5 text-[9px]">
                            <span class="text-gray-500">Active LPs:</span><span id="liq-ww-active" class="text-white text-right">0</span>
                            <span class="text-gray-500">Total Depth:</span><span id="liq-ww-depth" class="text-green-300 text-right">$0</span>
                            <span class="text-gray-500">TLA Staked:</span><span id="liq-ww-stk" class="text-orange-400 text-right">$0</span>
                            <span class="text-gray-500">TLA % Depth:</span><span id="liq-ww-pct" class="text-orange-300 text-right">0%</span>
                            <span class="text-gray-500">% of TVL:</span><span id="liq-ww-tvl" class="text-white font-bold text-right">0%</span>
                        </div>
                    </div>
                </div>
                
                <!-- aDAO Stats -->
                <div class="col-span-4 grid grid-cols-2 gap-2">
                    <div class="px-2 border-l border-gray-800">
                        <div class="flex justify-between items-center mb-1">
                            <h3 class="text-xs font-bold text-cyan-400">aDAO Deposits</h3>
                            <button onclick="togModal('token',1)" class="text-[9px] bg-gray-800 px-1 rounded hover:text-white text-cyan-400">View</button>
                        </div>
                        <div class="flex justify-between text-[10px] text-gray-400"><span>Total</span><span id="dao-dep" class="text-white font-mono">$0</span></div>
                        <div class="flex justify-between text-[10px] text-gray-400"><span>Avg APR</span><span id="dao-apr" class="text-green-400 font-mono">0%</span></div>
                    </div>
                    <div class="px-2 border-l border-gray-800">
                        <h3 class="text-xs font-bold text-green-400 mb-1">Unclaimed</h3>
                        <div class="flex justify-between text-[10px] text-gray-400"><span>Total</span><span id="dao-usd" class="text-green-400 font-mono">$0</span></div>
                        <div class="text-[9px] text-gray-500 mt-1">
                            <span>zAssets: <span id="dao-rew-z" class="text-white">0</span></span>
                            <span class="ml-2">amp: <span id="dao-rew-amp" class="text-white">0</span></span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Table Header -->
            <div class="bg-cyan-900/20 text-cyan-200 rounded-t border-b border-gray-800">
                <div class="liq-grid text-[11px] uppercase font-bold px-3 py-2 whitespace-nowrap">
                    <div title="pool_name">Pool</div>
                    <div class="text-center" title="dex_name">Dex</div>
                    <div class="text-center text-gray-500" title="lp_type (pcl/stable/xyk)">Type</div>
                    <div class="text-right text-gray-500" title="dex_depth_usd">Depth</div>
                    <div class="text-right text-orange-400" title="tla_staked_usd">TLA Stk</div>
                    <div class="text-right text-orange-400" title="tla_depth_pct (TLA Staked / Dex Depth)">TLA %</div>
                    <div class="text-right text-green-400" title="apr_non_amplified">APR</div>
                    <div class="text-right text-yellow-400" title="apr_amplified">üî• APR</div>
                    <div class="text-right text-green-400" title="rewards_usd_year">Rew/Yr</div>
                    <div class="text-right text-green-400" title="rewards_usd_epoch (Rew/Yr √∑ 52)">Rew/Ep</div>
                    <div class="text-right text-cyan-400" title="adao_deposit_non_amp_usd">aDAO</div>
                    <div class="text-right text-yellow-400" title="adao_deposit_amplified_usd">üî• aDAO</div>
                </div>
            </div>
            <div id="liq-list" class="max-h-[600px] overflow-y-auto text-xs bg-[#0D0D0D] p-2 border border-gray-800 rounded-b custom-scroll"></div>
        </div>
    </div>
</div>

<!-- WS 3: LOCKS -->
<div id="ws-locks" class="workspace">
    <div class="flex flex-col gap-4">
        <div class="bg-[#161616] p-3 rounded border border-gray-800">
            <div class="flex justify-between items-center mb-1">
                <h3 class="text-purple-400 font-bold text-xs">Locks Page</h3>
                <button onclick="clearPaste('locksPaste')" class="text-[9px] text-red-400 hover:text-red-300">Clear</button>
            </div>
            <textarea id="locksPaste" class="input-dark h-32" placeholder="Paste locks page content..."></textarea>
            <button onclick="parseLocks()" class="btn-action bg-purple-900/40 text-purple-200 border border-purple-900">Parse Locks</button>
        </div>
        <div class="preview-card flex flex-col">
            <div class="flex justify-between mb-6 border-b border-gray-700 pb-4">
                <div class="text-center px-4 w-1/3 border-r border-gray-800">
                    <div class="text-[10px] text-gray-500 uppercase mb-1">ADAO Voting Power</div>
                    <div id="locks-vp" class="text-xl font-bold text-purple-400 font-mono">0 VP</div>
                </div>
                <div class="text-center px-4 w-1/3 border-r border-gray-800">
                    <div class="text-[10px] text-gray-500 uppercase mb-1">Power Factor</div>
                    <div id="locks-factor" class="text-xl font-bold text-white font-mono">-</div>
                </div>
                <div class="text-center px-4 w-1/3">
                    <div class="text-[10px] text-gray-500 uppercase mb-1">Underlying Assets</div>
                    <div id="locks-assets" class="text-xl font-bold text-white font-mono">-</div>
                </div>
            </div>
            <!-- Locks Table Header -->
            <div class="bg-purple-900/20 text-purple-200 rounded-t border-b border-gray-800 mb-1">
                <div class="grid grid-cols-12 gap-2 text-[8px] uppercase font-bold px-2 py-2">
                    <div class="col-span-1" title="lock_id">Lock</div>
                    <div class="col-span-2 text-gray-500" title="lock_status">Status</div>
                    <div class="col-span-3" title="locked_amount + asset_type">Amount</div>
                    <div class="col-span-3 text-right text-green-400" title="usd_value">USD Value</div>
                    <div class="col-span-3 text-right" title="voting_power">Voting Power</div>
                </div>
            </div>
            <div id="locks-list" class="space-y-0 max-h-[550px] overflow-y-auto custom-scroll pr-2 bg-[#0D0D0D] border border-gray-800 rounded-b p-2">
                <div class="text-center text-gray-600 italic text-xs pt-10">No locks parsed yet...</div>
            </div>
        </div>
    </div>
</div>

<!-- aDAO Strategy Panel (Collapsible) -->
<div class="max-w-[1400px] mx-auto mt-4 px-2">
    <div class="bg-gray-900/50 border border-emerald-800 rounded-lg overflow-hidden">
        <div class="flex justify-between items-center px-4 py-2 bg-emerald-900/30 cursor-pointer" onclick="toggleStrategyPanel()">
            <div class="flex items-center gap-2">
                <span class="text-emerald-400 font-bold text-sm">üéØ aDAO Strategy Recommendations</span>
                <span class="text-[10px] text-gray-500">(Vote Optimization, Bribe Candidates, Activation Targets)</span>
            </div>
            <div class="flex items-center gap-3">
                <button onclick="event.stopPropagation(); generateStrategy()" class="text-[10px] bg-emerald-800 hover:bg-emerald-700 px-2 py-1 rounded">Generate</button>
                <span id="strategy-toggle" class="text-gray-400">‚ñº</span>
            </div>
        </div>
        <div id="strategy-panel" class="hidden p-4">
            <div class="grid grid-cols-2 gap-4">
                <!-- Vote Optimization -->
                <div class="bg-gray-900/50 rounded border border-gray-700 p-3">
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="text-sm font-bold text-orange-400">üìä Optimized Vote Allocation</h4>
                        <button onclick="copyVoteStrategy()" class="text-[10px] bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded">üìã Copy</button>
                    </div>
                    <div id="vote-optimization" class="space-y-3 text-[11px] max-h-[400px] overflow-y-auto custom-scroll">
                        <div class="text-gray-500 italic">Click "Generate" to calculate recommendations</div>
                    </div>
                </div>
                
                <!-- Bribe Candidates & Activation Targets -->
                <div class="space-y-4">
                    <!-- Bribe Candidates -->
                    <div class="bg-gray-900/50 rounded border border-gray-700 p-3">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-sm font-bold text-green-400">üí∞ Bribe Candidates</h4>
                            <button onclick="copyBribeCandidates()" class="text-[10px] bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded">üìã Copy for Prop</button>
                        </div>
                        <div id="bribe-candidates" class="space-y-2 text-[11px]">
                            <div class="text-gray-500 italic">Click "Generate" to identify candidates</div>
                        </div>
                    </div>
                    
                    <!-- Activation Targets (Inactive pools worth supporting) -->
                    <div class="bg-gray-900/50 rounded border border-gray-700 p-3">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-sm font-bold text-purple-400">üöÄ Activation Targets</h4>
                            <span class="text-[9px] text-gray-500">Inactive pools worth bringing to 1%+</span>
                        </div>
                        <div id="activation-targets" class="space-y-2 text-[11px]">
                            <div class="text-gray-500 italic">Click "Generate" to find targets</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Metadata Manager (Collapsible) -->
<div class="max-w-[1400px] mx-auto mt-4 px-2">
    <div class="bg-gray-900/50 border border-gray-800 rounded-lg overflow-hidden">
        <div class="flex justify-between items-center px-4 py-2 bg-gray-800/50 cursor-pointer" onclick="toggleMetadataPanel()">
            <div class="flex items-center gap-2">
                <span class="text-cyan-400 font-bold text-sm">üìä Asset Metadata Manager</span>
                <span class="text-[10px] text-gray-500">(CoinGecko, Multi-DEX, Bridge info)</span>
            </div>
            <div class="flex items-center gap-3">
                <span id="meta-status" class="text-[10px] text-gray-500">0 assets</span>
                <span id="meta-toggle" class="text-gray-400">‚ñº</span>
            </div>
        </div>
        <div id="metadata-panel" class="hidden p-4">
            <div class="grid grid-cols-3 gap-4">
                <!-- Asset List -->
                <div class="col-span-2 bg-gray-900/50 rounded border border-gray-700 p-3">
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="text-sm font-bold text-white">Assets</h4>
                        <div class="flex gap-2">
                            <input type="text" id="meta-search" placeholder="Search assets..." 
                                class="bg-gray-800 border border-gray-700 rounded px-2 py-1 text-xs w-40"
                                oninput="filterMetaAssets()">
                            <button onclick="addNewAsset()" class="text-[10px] bg-cyan-800 hover:bg-cyan-700 px-2 py-1 rounded">+ Add Asset</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-6 gap-1 text-[9px] uppercase text-gray-500 font-bold mb-2 px-2">
                        <div class="col-span-2">Asset</div>
                        <div class="text-center">CoinGecko</div>
                        <div class="text-center">Category</div>
                        <div class="text-center">Bridge</div>
                        <div class="text-center">Actions</div>
                    </div>
                    <div id="meta-asset-list" class="max-h-[300px] overflow-y-auto custom-scroll space-y-1">
                        <div class="text-center text-gray-600 italic text-xs py-4">
                            Assets will auto-populate from parsed data, or load from GitHub
                        </div>
                    </div>
                </div>
                
                <!-- Controls -->
                <div class="space-y-3">
                    <div class="bg-gray-900/50 rounded border border-gray-700 p-3">
                        <h4 class="text-sm font-bold text-white mb-2">Data Source</h4>
                        <button onclick="loadMetadataFromGitHub()" class="w-full text-[10px] bg-purple-800 hover:bg-purple-700 px-3 py-2 rounded mb-2">
                            üì• Load from GitHub
                        </button>
                        <button onclick="extractAssetsFromPools()" class="w-full text-[10px] bg-gray-700 hover:bg-gray-600 px-3 py-2 rounded">
                            üîÑ Extract from Parsed Pools
                        </button>
                    </div>
                    
                    <div class="bg-gray-900/50 rounded border border-gray-700 p-3">
                        <h4 class="text-sm font-bold text-white mb-2">Export</h4>
                        <button onclick="downloadMetadata()" class="w-full text-[10px] bg-green-800 hover:bg-green-700 px-3 py-2 rounded mb-2">
                            üíæ Download JSON
                        </button>
                        <button onclick="copyMetadata()" class="w-full text-[10px] bg-blue-800 hover:bg-blue-700 px-3 py-2 rounded">
                            üìã Copy to Clipboard
                        </button>
                    </div>
                    
                    <div class="bg-gray-900/50 rounded border border-gray-700 p-3">
                        <h4 class="text-sm font-bold text-white mb-2">Categories</h4>
                        <div class="text-[9px] space-y-1">
                            <div><span class="text-yellow-300">üèÜ bluechip</span> - BTC, ETH, PAXG</div>
                            <div><span class="text-green-300">üíµ stable</span> - USDC, USDT, EURe</div>
                            <div><span class="text-purple-300">‚öõÔ∏è core</span> - LUNA, ATOM, INJ</div>
                            <div><span class="text-orange-300">üè† native</span> - ROAR, CAPA, SOLID</div>
                            <div><span class="text-cyan-300">üîÑ lsd</span> - ampLUNA, arbLUNA</div>
                            <div><span class="text-gray-300">üåâ cross</span> - wBNB, wstETH</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- GitHub Info -->
            <div class="mt-3 p-2 bg-gray-800/50 rounded border border-gray-700 text-[10px] text-gray-400">
                <strong>GitHub:</strong> After editing, download the JSON and replace <code class="bg-gray-900 px-1 rounded">tla_metadata.json</code> in your repository.
                Expected URL: <code class="bg-gray-900 px-1 rounded">https://raw.githubusercontent.com/defipatriot/tla-ext_json_storage/main/tla_metadata.json</code>
            </div>
        </div>
    </div>
</div>

<!-- Modals -->
<div id="token-modal" class="modal-overlay" onclick="if(event.target===this)togModal('token',0)">
    <div class="modal-box"><div class="flex justify-between border-b border-gray-700 pb-2 mb-2"><h3 class="font-bold">Tokens</h3><span onclick="togModal('token',0)" class="cursor-pointer">‚úï</span></div><div id="mod-tok-list" class="space-y-1 text-xs"></div></div>
</div>

<div id="vote-rew-modal" class="modal-overlay" onclick="if(event.target===this)togModal('vote-rew',0)">
    <div class="modal-box">
        <div class="flex justify-between border-b border-gray-700 pb-2 mb-2">
            <h3 class="font-bold text-cyan-400">Vote Rewards</h3>
            <span onclick="togModal('vote-rew',0)" class="cursor-pointer">‚úï</span>
        </div>
        <div class="bg-gray-900 p-2 rounded border border-gray-800 mb-3 text-[10px]">
            <div class="flex justify-between mb-1">
                <span class="text-gray-500">Periods:</span>
                <span id="mod-vote-periods" class="text-white font-mono">-</span>
            </div>
            <div class="flex justify-between">
                <span class="text-gray-500">Unclaimed:</span>
                <span id="mod-vote-epoch-count" class="text-yellow-400 font-bold">-</span>
            </div>
        </div>
        <div id="mod-vote-list" class="space-y-1 text-xs"></div>
    </div>
</div>

<div id="incentives-modal" class="modal-overlay" onclick="if(event.target===this)togModal('incentives',0)">
    <div class="modal-box w-[800px] flex flex-col"><div class="flex justify-between border-b border-gray-700 pb-2 mb-2"><h3 class="font-bold text-green-400">Incentives Detail</h3><span onclick="togModal('incentives',0)" class="cursor-pointer">‚úï</span></div>
        <div class="mb-3 text-[10px] text-gray-400 bg-gray-900 p-2 rounded border border-gray-800 font-bold" id="mod-inc-bucket-title">All Buckets</div>
        <div class="grid grid-cols-12 gap-1 text-[9px] text-gray-500 uppercase font-bold border-b border-gray-700 pb-1 mb-2">
            <div class="col-span-5">Pool</div>
            <div class="col-span-2 text-right">Bribes</div>
            <div class="col-span-2 text-right text-green-400">Total</div>
            <div class="col-span-3 text-right text-blue-400">vAPR</div>
        </div>
        <div id="mod-inc-content" class="space-y-1 text-[10px] max-h-[60vh] overflow-y-auto custom-scroll flex-grow"></div>
    </div>
</div>

<script>
// === UTILITIES ===
const $ = id => document.getElementById(id);
const setTxt = (id, v) => { const e = $(id); if(e) e.innerText = v; };
const setHtml = (id, v) => { const e = $(id); if(e) e.innerHTML = v; };
const togModal = (id, show) => { const el = $(id+'-modal'); if(el) el.classList.toggle('open', show); };
const fmt$ = n => '$' + (n || 0).toLocaleString(undefined, {maximumFractionDigits: 0});
const fmtVp = n => {
    if (!n || n === 0) return '-';
    if (n >= 1e6) return (n / 1e6).toFixed(2) + 'M';
    if (n >= 1e3) return (n / 1e3).toFixed(1) + 'K';
    return n.toLocaleString();
};

// Unified number parser: handles K/M suffixes, strips non-numeric
function parseNum(s) {
    if (!s) return 0;
    let str = String(s);
    let mult = 1;
    if (/[\d\.]\s*[Kk]\b/.test(str)) mult = 1e3;
    if (/[\d\.]\s*[Mm]\b/.test(str)) mult = 1e6;
    return parseFloat(str.replace(/[^0-9\.]/g, '')) * mult || 0;
}

// Clear paste box
function clearPaste(id) {
    const el = $(id);
    if (el) el.value = '';
}

// Update paste status indicator
function updatePasteStatus(id, done) {
    const el = $(id);
    if (el) {
        if (done) {
            el.className = 'px-2 py-0.5 rounded bg-green-900/50 text-green-400 border border-green-700';
        } else {
            el.className = 'px-2 py-0.5 rounded bg-gray-800 text-gray-500 border border-gray-700';
        }
    }
}

// Skip inactive liquidity step
function skipInactive() {
    pasteStatus.liqInactive = true;
    updatePasteStatus('ps-liq-inactive', true);
}

const BUCKET_ORDER = ['STABLE', 'PROJECT', 'BLUECHIP', 'SINGLE'];

// === DATA STORE ===
let store = {
    dao: { dep: 0, apr: 0, rew: {z: 0, amp: 0, usd: 0}, toks: [], vRew: {}, vRewPeriods: [], lVp: 0, lFac: 0, lAst: 0, locks: [] },
    tla: { tvl: 0, rewYr: 0, pools: [], inactivePools: [] },
    vote: { ep: 0, end: '-', pools: [], tvp: 0, reb: 0, usd: 0 },
    ext: { lps: {}, meta: {}, loaded: false }
};

// Paste completion status
let pasteStatus = {
    vote: false,
    voteRew: false,
    liqActive: false,
    liqInactive: false,
    liqDep: false,
    liqRew: false,
    locks: false,
    ext: false
};

// === EPOCH DATA ===
let epochData = []; // Will be loaded from GitHub
let currentEpochInfo = null;

// === INIT ===
window.onload = async function() {
    await loadEpochData();
    await loadExtData();
    await findLatestSnapshot();
    setInterval(updateTimers, 1000);
    updateTimers();
    updateGithubLink();
};

async function loadEpochData() {
    const url = 'https://raw.githubusercontent.com/defipatriot/tla_json_storage/main/epoch_1-300_date.json';
    const statusEl = $('status-epoch-file');
    
    try {
        let res = await fetch(url);
        if (!res.ok) throw new Error("Failed to fetch");
        epochData = await res.json();
        
        // Success - turn green
        if (statusEl) {
            statusEl.className = 'text-green-500 font-bold';
            statusEl.innerText = 'Epoch File ‚úì';
        }
        
        findCurrentEpoch();
    } catch(e) {
        console.error("Failed to load epoch data:", e);
        // Failed - turn red
        if (statusEl) {
            statusEl.className = 'text-red-500 font-bold';
            statusEl.innerText = 'Epoch File ‚úó';
        }
    }
}

async function loadExtData() {
    const url = 'https://raw.githubusercontent.com/defipatriot/tla-ext_json_storage/main/tla_ext_combined.json';
    const statusEl = $('status-ext-data');
    
    try {
        let res = await fetch(url);
        if (!res.ok) throw new Error("Failed to fetch");
        let data = await res.json();
        
        store.ext.lps = data.lps || {};
        store.ext.meta = data.meta || {};
        store.ext.loaded = true;
        
        // Success - turn green
        if (statusEl) {
            statusEl.className = 'text-green-500 font-bold';
            statusEl.innerText = 'Ext Data ‚úì';
        }
        
        // Show legend
        let legend = $('ext-data-legend');
        if (legend) legend.classList.remove('hidden');
        
        // Re-render vote table to apply ext data
        if (store.vote.pools.length > 0) {
            applyExtDataToPools();
            renderVoteTable();
        }
        
        console.log('Ext data loaded:', Object.keys(store.ext.lps).length, 'LPs');
    } catch(e) {
        console.error("Failed to load ext data:", e);
        if (statusEl) {
            statusEl.className = 'text-yellow-500 font-bold cursor-pointer';
            statusEl.innerText = 'Ext Data ‚úó';
            statusEl.title = 'Click to load manually';
            statusEl.onclick = showExtManualLoad;
        }
        // Show manual load option
        showExtManualLoad();
    }
}

function showExtManualLoad() {
    let el = $('ext-manual-load');
    if (el) el.classList.remove('hidden');
}

function toggleExtPaste() {
    let el = $('ext-paste-area');
    if (el) el.classList.toggle('hidden');
}

function loadExtFromFile(event) {
    let file = event.target.files[0];
    if (!file) return;
    
    let reader = new FileReader();
    reader.onload = function(e) {
        try {
            let data = JSON.parse(e.target.result);
            applyExtData(data);
        } catch(err) {
            alert('Error parsing ext JSON file: ' + err.message);
        }
    };
    reader.readAsText(file);
}

function loadExtFromPaste() {
    let txt = $('ext-paste').value;
    if (!txt.trim()) {
        alert('Please paste ext JSON data first');
        return;
    }
    
    try {
        let data = JSON.parse(txt);
        applyExtData(data);
    } catch(err) {
        alert('Error parsing ext JSON: ' + err.message);
    }
}

function applyExtData(data) {
    store.ext.lps = data.lps || {};
    store.ext.meta = data.meta || {};
    store.ext.loaded = true;
    
    // Update status
    let statusEl = $('status-ext-data');
    if (statusEl) {
        statusEl.className = 'text-green-500 font-bold';
        statusEl.innerText = 'Ext Data ‚úì';
        statusEl.onclick = null;
    }
    
    updatePasteStatus('ps-ext', true);
    
    // Show legend
    let legend = $('ext-data-legend');
    if (legend) legend.classList.remove('hidden');
    
    // Hide manual load section
    let manualEl = $('ext-manual-load');
    if (manualEl) manualEl.classList.add('hidden');
    
    // Re-render vote table to apply ext data
    if (store.vote.pools.length > 0) {
        applyExtDataToPools();
        renderVoteTable();
    }
    
    alert('Ext data loaded: ' + Object.keys(store.ext.lps).length + ' LPs');
}

function applyExtDataToPools() {
    if (!store.ext.loaded) return;
    
    // Get current epoch for looking up data
    let targetEpoch = store.vote.ep || currentEpochInfo?.epoch || 0;
    
    store.vote.pools.forEach(p => {
        // Create key to match ext data: "LUNA-USDC|Astroport"
        let dexName = p.d.includes('Astro') ? 'Astroport' : p.d.includes('White') ? 'WhiteWhale' : null;
        if (!dexName) return;
        
        let lpKey = `${p.n}|${dexName}`;
        let extLp = store.ext.lps[lpKey];
        
        if (extLp && !extLp.notAvailable) {
            // Get epoch-specific data, fall back to previous epochs if not available
            let liqData = null, volData = null;
            
            // Try current epoch, then go back up to 5 epochs
            for (let ep = targetEpoch; ep >= targetEpoch - 5 && ep > 0; ep--) {
                if (!liqData && extLp.liquidity?.epochs?.[ep]) {
                    liqData = extLp.liquidity.epochs[ep];
                }
                if (!volData && extLp.volume?.epochs?.[ep]) {
                    volData = extLp.volume.epochs[ep];
                }
                if (liqData && volData) break;
            }
            
            // Apply to pool - only if we have ext data and no existing paste data
            if (liqData && (!p.dp || p.dp === 0)) {
                p.dp = liqData.avg;
                p.dpSource = 'ext';
                p.dpEpoch = Object.keys(extLp.liquidity.epochs).find(k => extLp.liquidity.epochs[k] === liqData);
            }
            if (volData && (!p.vol || p.vol === 0)) {
                p.vol = volData.avg;
                p.volSource = 'ext';
            }
        }
    });
}

// ============ aDAO SCORING SYSTEM ============

function get4EpochAverage(lpKey, type) {
    // type = 'liquidity' or 'volume'
    if (!store.ext.loaded || !store.ext.lps[lpKey]) return null;
    
    let extLp = store.ext.lps[lpKey];
    if (extLp.notAvailable) return null;
    
    let targetEpoch = store.vote.ep || currentEpochInfo?.epoch || 0;
    let epochs = extLp[type]?.epochs || {};
    
    // Get up to 4 previous epochs (not current)
    let values = [];
    for (let ep = targetEpoch - 1; ep >= targetEpoch - 4 && ep > 0; ep--) {
        if (epochs[ep]?.avg) {
            values.push({ epoch: ep, avg: epochs[ep].avg });
        }
    }
    
    if (values.length === 0) return null;
    
    let sum = values.reduce((s, v) => s + v.avg, 0);
    return {
        avg: sum / values.length,
        epochs: values,
        count: values.length
    };
}

function getPoolApr(poolName, dex) {
    // Find APR from liquidity paste data
    let liqPool = store.tla.pools.find(p => 
        p.normName === poolName && p.dex.includes(dex.substring(0,5))
    );
    if (!liqPool) {
        liqPool = store.tla.inactivePools?.find(p => 
            p.normName === poolName && p.dex.includes(dex.substring(0,5))
        );
    }
    return {
        non: liqPool?.aprNon || 0,
        amp: liqPool?.aprAmp || 0
    };
}

function calculateAprFactor(apr) {
    // Target APR = 50% non-amplified
    // Returns bonus/penalty based on distance from target
    if (!apr || apr === 0) return 0; // No data, neutral
    
    if (apr < 40) return 10;      // Needs help
    if (apr < 50) return 5;       // Slightly under target
    if (apr <= 55) return 0;      // At target (50-55 neutral zone)
    if (apr <= 60) return -5;     // Slightly over
    if (apr <= 70) return -15;    // Doing well
    if (apr <= 80) return -25;    // Very healthy
    return -35;                    // Thriving, definitely shift focus
}

// ============ ACCESS SCORE SYSTEM ============

const ASSET_TIERS = {
    // Blue Chip - Store of value, attracts serious capital
    bluechip: { assets: ['BTC', 'wBTC', 'ETH', 'wETH', 'PAXG'], points: 3, label: 'Blue Chip' },
    // Major Stables - Essential trading infrastructure
    stables: { assets: ['USDC', 'USDT', 'EURe', 'DAI'], points: 2.5, label: 'Major Stable' },
    // Ecosystem Core - Heart of Terra/Cosmos
    core: { assets: ['LUNA', 'ATOM', 'INJ'], points: 2.5, label: 'Ecosystem Core' },
    // Native Terra Projects - Supporting local builders
    native: { assets: ['ROAR', 'CAPA', 'SOLID', 'ASTRO', 'FUEL', 'xASTRO', 'ampCAPA'], points: 2, label: 'Native Terra' },
    // Protocol LSDs - Useful derivatives
    lsd: { assets: ['ampLUNA', 'arbLUNA', 'bLUNA', 'stLUNA', 'stATOM', 'boneLUNA'], points: 1.5, label: 'Protocol LSD' },
    // Cross-chain assets - Brings outside liquidity
    crosschain: { assets: ['wBNB', 'wstETH', 'SWTH'], points: 1, label: 'Cross-chain' }
};

const BRIDGE_QUALITY = {
    'native': { points: 3, label: 'Native (no bridge)' },
    '.atom': { points: 2.5, label: 'IBC/Skip (.atom)' },
    '.axl': { points: 2, label: 'Axelar (.axl)' },
    '.osmo': { points: 1.5, label: 'Osmosis (.osmo)' },
    '.wh': { points: 1, label: 'Wormhole (.wh)' }
};

function getAssetTier(assetName) {
    // Strip bridge suffix for matching
    let base = assetName.replace(/\.(atom|axl|osmo|wh)$/i, '');
    
    // Check metadata first (if loaded)
    let meta = assetMetadata[assetName] || assetMetadata[base];
    if (meta && meta.category) {
        let categoryPoints = {
            'bluechip': 3, 'stable': 2.5, 'core': 2.5, 'native': 2, 'lsd': 1.5, 'cross': 1, 'unknown': 0.5
        };
        let categoryLabels = {
            'bluechip': 'Blue Chip', 'stable': 'Stable', 'core': 'Core', 'native': 'Native Terra', 
            'lsd': 'LSD', 'cross': 'Cross-chain', 'unknown': 'Unknown'
        };
        return { 
            tier: meta.category, 
            points: categoryPoints[meta.category] || 0.5, 
            label: categoryLabels[meta.category] || 'Unknown',
            fromMetadata: true
        };
    }
    
    // Fallback to hardcoded ASSET_TIERS
    for (let [tier, data] of Object.entries(ASSET_TIERS)) {
        if (data.assets.some(a => base.toUpperCase().includes(a.toUpperCase()))) {
            return { tier, ...data };
        }
    }
    return { tier: 'unknown', points: 0.5, label: 'Unknown' };
}

function getBridgeQuality(assetName) {
    // Check metadata first (if loaded)
    let meta = assetMetadata[assetName];
    if (meta && meta.bridge) {
        let bridgeData = BRIDGE_QUALITY[meta.bridge] || BRIDGE_QUALITY['native'];
        return { suffix: meta.bridge, ...bridgeData, fromMetadata: true };
    }
    
    // Fallback to suffix detection
    let match = assetName.match(/\.(atom|axl|osmo|wh)$/i);
    if (match) {
        let suffix = '.' + match[1].toLowerCase();
        return { suffix, ...BRIDGE_QUALITY[suffix] };
    }
    // Native asset (no bridge)
    return { suffix: 'native', ...BRIDGE_QUALITY['native'] };
}

function getLunaBenefit(asset1, asset2) {
    let hasLuna = asset1.toUpperCase() === 'LUNA' || asset2.toUpperCase() === 'LUNA';
    let hasLsd = ['ampLUNA', 'arbLUNA', 'bLUNA', 'stLUNA', 'boneLUNA'].some(l => 
        asset1.toUpperCase().includes(l.toUpperCase()) || asset2.toUpperCase().includes(l.toUpperCase())
    );
    
    if (hasLuna) {
        // Check what LUNA is paired with
        let other = asset1.toUpperCase() === 'LUNA' ? asset2 : asset1;
        let otherTier = getAssetTier(other);
        
        if (otherTier.tier === 'bluechip') return { points: 3, label: 'LUNA + Blue Chip', reason: 'Attracts value TO Luna' };
        if (otherTier.tier === 'stables') return { points: 2.5, label: 'LUNA + Stable', reason: 'Trading infrastructure' };
        if (otherTier.tier === 'native') return { points: 2.5, label: 'LUNA + Native Terra', reason: 'Supporting ecosystem' };
        if (otherTier.tier === 'core') return { points: 2.5, label: 'LUNA + Ecosystem', reason: 'Cosmos connectivity' };
        if (otherTier.tier === 'lsd') return { points: 2, label: 'LUNA + LSD', reason: 'LSD utility' };
        return { points: 2, label: 'LUNA + Other', reason: 'Still benefits LUNA' };
    }
    
    if (hasLsd) {
        return { points: 1.5, label: 'LSD Pair', reason: 'Indirect LUNA support' };
    }
    
    // Check for stable-stable
    let tier1 = getAssetTier(asset1);
    let tier2 = getAssetTier(asset2);
    if (tier1.tier === 'stables' && tier2.tier === 'stables') {
        return { points: 1, label: 'Stable-Stable', reason: 'Useful but not LUNA focused' };
    }
    
    return { points: 0.5, label: 'Non-LUNA Pair', reason: 'Minimal ecosystem benefit' };
}

function calculateAccessScore(poolName) {
    // Parse pool name: "LUNA-USDC" or "wBTC.axl-wBTC.osmo"
    let parts = poolName.split('-');
    if (parts.length !== 2) return { total: 5, breakdown: { error: 'Could not parse pool name' } };
    
    let [asset1, asset2] = parts;
    
    // 1. Asset Quality (average of both sides)
    let tier1 = getAssetTier(asset1);
    let tier2 = getAssetTier(asset2);
    let assetAvg = (tier1.points + tier2.points) / 2;
    
    // 2. Bridge Quality (use worst bridge - chain is only as strong as weakest link)
    let bridge1 = getBridgeQuality(asset1);
    let bridge2 = getBridgeQuality(asset2);
    let bridgeScore = Math.min(bridge1.points, bridge2.points);
    let bridgeLabel = bridge1.points <= bridge2.points ? bridge1.label : bridge2.label;
    
    // 3. LUNA Ecosystem Benefit
    let lunaBenefit = getLunaBenefit(asset1, asset2);
    
    // 4. Ecosystem factors (from metadata if available)
    let ecosystemBonus = 0;
    let ecosystemFactors = [];
    
    // Check CoinGecko listing from metadata
    let meta1 = assetMetadata[asset1];
    let meta2 = assetMetadata[asset2];
    if (meta1?.coingecko || meta2?.coingecko) {
        ecosystemBonus += 0.5;
        ecosystemFactors.push('CoinGecko listed');
    }
    
    // Check multi-DEX from metadata
    if (meta1?.multiDex || meta2?.multiDex) {
        ecosystemBonus += 0.5;
        ecosystemFactors.push('Multi-DEX');
    }
    
    // Total (max ~10 points, normalize to 0-100 for ranking)
    let rawTotal = assetAvg + bridgeScore + lunaBenefit.points + ecosystemBonus;
    let maxPossible = 3 + 3 + 3 + 1; // 10 points max
    let normalized = (rawTotal / maxPossible) * 100;
    
    return {
        total: normalized,
        raw: rawTotal,
        max: maxPossible,
        breakdown: {
            asset1: { name: asset1, tier: tier1.label, points: tier1.points },
            asset2: { name: asset2, tier: tier2.label, points: tier2.points },
            assetAvg: assetAvg,
            bridge: { label: bridgeLabel, points: bridgeScore, asset1Bridge: bridge1.label, asset2Bridge: bridge2.label },
            lunaBenefit: lunaBenefit,
            ecosystem: { factors: ecosystemFactors, bonus: ecosystemBonus }
        }
    };
}

function calculateScoresForBucket(bucketName) {
    // Get all pools in this bucket
    let bucketPools = store.vote.pools.filter(p => p.b === bucketName);
    if (bucketPools.length === 0) return;
    
    // Calculate 4Ep averages, efficiency, and access score for each pool
    bucketPools.forEach(p => {
        let dexName = p.d.includes('Astro') ? 'Astroport' : p.d.includes('White') ? 'WhiteWhale' : null;
        if (!dexName) return;
        
        let lpKey = `${p.n}|${dexName}`;
        
        // Get 4-epoch averages
        p.liq4Ep = get4EpochAverage(lpKey, 'liquidity');
        p.vol4Ep = get4EpochAverage(lpKey, 'volume');
        
        // Calculate efficiency (vol/liq ratio)
        let liqAvg = p.liq4Ep?.avg || p.dp || 0;
        let volAvg = p.vol4Ep?.avg || p.vol || 0;
        p.efficiency = liqAvg > 0 ? (volAvg / liqAvg) : 0;
        
        // Get APR from liquidity data
        let aprData = getPoolApr(p.n, dexName);
        p.aprNon = aprData.non;
        p.aprAmp = aprData.amp;
        p.aprFactor = calculateAprFactor(p.aprNon);
        
        // Calculate Access Score
        p.accessData = calculateAccessScore(p.n);
        p.accessScore = p.accessData.total;
    });
    
    // Rank within bucket (for relative scoring)
    let withLiq = bucketPools.filter(p => (p.liq4Ep?.avg || p.dp) > 0);
    let withVol = bucketPools.filter(p => (p.vol4Ep?.avg || p.vol) > 0);
    let withEff = bucketPools.filter(p => p.efficiency > 0);
    let withInc = bucketPools.filter(p => p.inc > 0);
    let withVot = bucketPools.filter(p => (p.votNowPct || 0) > 0);
    let withTla = bucketPools.filter(p => p.vps > 0);
    
    // Sort and assign ranks (higher value = higher rank)
    withLiq.sort((a, b) => (b.liq4Ep?.avg || b.dp) - (a.liq4Ep?.avg || a.dp));
    withVol.sort((a, b) => (b.vol4Ep?.avg || b.vol) - (a.vol4Ep?.avg || a.vol));
    withEff.sort((a, b) => b.efficiency - a.efficiency);
    withInc.sort((a, b) => b.inc - a.inc);
    withVot.sort((a, b) => (b.votNowPct || 0) - (a.votNowPct || 0));
    withTla.sort((a, b) => b.vps - a.vps);
    
    // Assign percentile ranks (0-100)
    bucketPools.forEach(p => {
        p.liqRank = withLiq.length > 0 ? (1 - withLiq.indexOf(p) / withLiq.length) * 100 : 0;
        p.volRank = withVol.length > 0 ? (1 - withVol.indexOf(p) / withVol.length) * 100 : 0;
        p.effRank = withEff.length > 0 ? (1 - withEff.indexOf(p) / withEff.length) * 100 : 0;
        p.incRank = withInc.length > 0 ? (1 - withInc.indexOf(p) / withInc.length) * 100 : 0;
        p.votRank = withVot.length > 0 ? (1 - withVot.indexOf(p) / withVot.length) * 100 : 0;
        p.tlaRank = withTla.length > 0 ? (1 - withTla.indexOf(p) / withTla.length) * 100 : 0;
        
        // Fix -0 and pools not in list
        if (withLiq.indexOf(p) === -1) p.liqRank = 0;
        if (withVol.indexOf(p) === -1) p.volRank = 0;
        if (withEff.indexOf(p) === -1) p.effRank = 0;
        if (withInc.indexOf(p) === -1) p.incRank = 0;
        if (withVot.indexOf(p) === -1) p.votRank = 0;
        if (withTla.indexOf(p) === -1) p.tlaRank = 0;
    });
    
    // Calculate Performance Score (0-100)
    // 35% Efficiency, 25% Volume, 20% Liquidity, 15% Access, 5% History
    bucketPools.forEach(p => {
        p.performanceScore = 
            (p.effRank * 0.35) +
            (p.volRank * 0.25) +
            (p.liqRank * 0.20) +
            (p.accessScore * 0.15) + // Access score (now 15%)
            (0 * 0.05);  // History score placeholder (now 5%)
        
        // Calculate Support Score (0-100)
        // 40% Bribes, 30% TLA Vote, 30% Votion Dominance
        // Votion Dominance = what % of TLA votes come from Votion (high = dependent on Votion)
        let votionDominance = p.vps > 0 ? Math.min(100, (p.votNowPct / p.vps) * 100) : 0;
        p.votionDominance = votionDominance;
        
        p.supportScore = 
            (p.incRank * 0.40) +
            (p.tlaRank * 0.30) +
            (votionDominance * 0.30);  // High dominance = high support from Votion
        
        // Calculate aDAO Opportunity Score
        // Performance - Support + APR Factor
        p.adaoScore = p.performanceScore - p.supportScore + (p.aprFactor || 0);
        
        // Clamp to reasonable range
        p.adaoScore = Math.max(-100, Math.min(100, p.adaoScore));
    });
}

function calculateAllScores() {
    BUCKET_ORDER.forEach(bucket => {
        calculateScoresForBucket(bucket);
    });
}

function getScoreColor(score) {
    if (score >= 50) return 'text-green-400';
    if (score >= 20) return 'text-yellow-400';
    if (score >= -20) return 'text-gray-400';
    if (score >= -50) return 'text-blue-400';
    return 'text-red-400';
}

function getScoreIcon(score) {
    if (score >= 50) return 'üü¢';
    if (score >= 20) return 'üü°';
    if (score >= -20) return '‚ö™';
    if (score >= -50) return 'üîµ';
    return 'üî¥';
}

function showScoreInfo(type) {
    let title = '', content = '';
    
    switch(type) {
        case '4ep-liq':
            title = '4-Epoch Average Liquidity';
            content = `
                <p class="mb-3">Average liquidity over the last 4 epochs (approximately 28 days), calculated from Astroport chart data captured via the Extensions tool.</p>
                <p class="mb-3"><strong>Why it matters:</strong> Shows the pool's sustained liquidity commitment, not just a point-in-time snapshot.</p>
                <p class="mb-3"><strong>Data source:</strong> tla_ext_combined.json from the Extensions tool staging process.</p>
                <p class="text-teal-400"><span class="text-[12px]">‚¨°</span> indicates data from ext tool (epoch averages)</p>
            `;
            break;
        case '4ep-vol':
            title = '4-Epoch Average Volume';
            content = `
                <p class="mb-3">Average trading volume over the last 4 epochs, showing consistent usage patterns.</p>
                <p class="mb-3"><strong>Why it matters:</strong> Volume indicates real utility - people are actually using this pool for trades. High volume = valuable to the chain.</p>
                <p class="mb-3"><strong>Weight in scoring:</strong> 25% of Performance Score (volume is a strong signal of LP value)</p>
            `;
            break;
        case 'efficiency':
            title = 'Capital Efficiency (Vol/Liq Ratio)';
            content = `
                <p class="mb-3">How hard the pool's liquidity is working. Calculated as: Average Volume √∑ Average Liquidity</p>
                <p class="mb-3"><strong>Example:</strong> A pool with $50K liquidity doing $20K/day volume (0.4 efficiency) is more valuable than one with $500K liquidity doing $5K/day (0.01 efficiency).</p>
                <p class="mb-3"><strong>Weight in scoring:</strong> 35% of Performance Score (the most important metric)</p>
                <p class="text-yellow-400">Higher efficiency = pool is working harder for the chain</p>
            `;
            break;
        case 'apr':
            title = 'Non-Amplified APR';
            content = `
                <p class="mb-3">The base APR before amplification multipliers. From liquidity paste data.</p>
                <p class="mb-3"><strong>TLA Target:</strong> 50% non-amplified APR</p>
                <p class="mb-3"><strong>APR Factor applied to score:</strong></p>
                <ul class="list-disc list-inside text-[11px] space-y-1 mb-3">
                    <li>&lt;40% ‚Üí +10 (needs help)</li>
                    <li>40-50% ‚Üí +5 (slightly under)</li>
                    <li>50-55% ‚Üí 0 (at target)</li>
                    <li>55-60% ‚Üí -5 (slightly over)</li>
                    <li>60-70% ‚Üí -15 (doing well)</li>
                    <li>70-80% ‚Üí -25 (very healthy)</li>
                    <li>&gt;80% ‚Üí -35 (thriving, shift focus)</li>
                </ul>
                <p class="text-green-400">This creates automatic rebalancing toward underperforming LPs</p>
            `;
            break;
        case 'access':
            title = 'Access Score (15% of Performance)';
            content = `
                <p class="mb-3">Measures how valuable this LP is to the Terra ecosystem based on asset quality, bridge safety, and LUNA benefit.</p>
                
                <p class="mb-2 font-bold text-white">1. Asset Quality (0-3 pts avg)</p>
                <div class="text-[10px] mb-3 pl-2 border-l border-gray-600">
                    <div>üèÜ <span class="text-yellow-300">Blue Chip (3)</span>: BTC, ETH, PAXG</div>
                    <div>üíµ <span class="text-green-300">Major Stable (2.5)</span>: USDC, USDT, EURe</div>
                    <div>‚öõÔ∏è <span class="text-purple-300">Ecosystem Core (2.5)</span>: LUNA, ATOM, INJ</div>
                    <div>üè† <span class="text-orange-300">Native Terra (2)</span>: ROAR, CAPA, SOLID, ASTRO, FUEL</div>
                    <div>üîÑ <span class="text-cyan-300">Protocol LSD (1.5)</span>: ampLUNA, arbLUNA, bLUNA, stLUNA</div>
                    <div>üåâ <span class="text-gray-300">Cross-chain (1)</span>: wBNB, wstETH, SWTH</div>
                </div>
                
                <p class="mb-2 font-bold text-white">2. Bridge Quality (0-3 pts)</p>
                <div class="text-[10px] mb-3 pl-2 border-l border-gray-600">
                    <div><span class="text-green-400">Native (3)</span>: No bridge risk</div>
                    <div><span class="text-green-300">.atom (2.5)</span>: IBC/Skip - cleanest path</div>
                    <div><span class="text-yellow-300">.axl (2)</span>: Axelar - established</div>
                    <div><span class="text-orange-300">.osmo (1.5)</span>: Osmosis - extra hops</div>
                    <div><span class="text-red-300">.wh (1)</span>: Wormhole - complex</div>
                </div>
                
                <p class="mb-2 font-bold text-white">3. LUNA Ecosystem Benefit (0-3 pts)</p>
                <div class="text-[10px] mb-3 pl-2 border-l border-gray-600">
                    <div><span class="text-green-400">LUNA + Blue Chip (3)</span>: Attracts value TO Luna</div>
                    <div><span class="text-green-300">LUNA + Stable/Native (2.5)</span>: Infrastructure & ecosystem</div>
                    <div><span class="text-yellow-300">LUNA + Other (2)</span>: Still benefits LUNA</div>
                    <div><span class="text-orange-300">LSD Pair (1.5)</span>: Indirect LUNA support</div>
                    <div><span class="text-gray-300">Non-LUNA (0.5-1)</span>: Minimal ecosystem benefit</div>
                </div>
                
                <p class="text-emerald-400">aDAO prioritizes LPs that bring value to LUNA and Terra! üè†</p>
            `;
            break;
        case 'support':
            title = 'Support Score';
            content = `
                <p class="mb-3">How much attention this LP is already getting from other sources.</p>
                <p class="mb-3"><strong>Components (0-100):</strong></p>
                <ul class="list-disc list-inside text-[11px] space-y-1 mb-3">
                    <li>40% - PD Bribes rank (incentives from eris/PD)</li>
                    <li>30% - Votion % rank (automated VP direction)</li>
                    <li>30% - TLA Vote % rank (current vote share)</li>
                </ul>
                <p class="mb-3"><strong>Higher support = already getting attention</strong></p>
                <p class="text-orange-300">aDAO looks for LPs with LOW support scores relative to their performance</p>
            `;
            break;
        case 'adao-score':
            title = 'aDAO Opportunity Score';
            content = `
                <p class="mb-3 text-lg font-bold text-emerald-300">The Bottom Line: Should aDAO support this LP?</p>
                
                <div class="bg-gray-800/50 p-3 rounded mb-3">
                    <p class="text-[11px] text-gray-300 italic mb-2">"aDAO acts as a balance of power in TLA governance. We use data-driven analysis to support high-performing LPs that aren't getting attention from PD bribes or Votion, and help promising projects grow."</p>
                </div>
                
                <p class="mb-2 font-bold text-white">Formula:</p>
                <div class="font-mono text-[11px] bg-gray-900 p-2 rounded mb-3">
                    aDAO Score = Performance - Support + APR Factor
                </div>
                
                <p class="mb-2 font-bold text-white">Performance Score (0-100):</p>
                <div class="text-[10px] mb-3 pl-2 border-l border-gray-600">
                    <div>35% - Efficiency (Vol/Liq ratio) - Is capital working hard?</div>
                    <div>25% - Volume rank - Are people actually using it?</div>
                    <div>20% - Liquidity rank - Is there commitment?</div>
                    <div>15% - Access Score - Asset quality, bridge safety, LUNA benefit</div>
                    <div>5% - History Score - Stability over time (TBD)</div>
                </div>
                
                <p class="mb-2 font-bold text-white">Support Score (0-100):</p>
                <div class="text-[10px] mb-3 pl-2 border-l border-gray-600">
                    <div>40% - PD Bribes rank - Eris/PD attention</div>
                    <div>30% - Votion % rank - Automated VP direction</div>
                    <div>30% - TLA Vote % rank - Current vote share</div>
                </div>
                
                <p class="mb-2 font-bold text-white">APR Factor (Target: 50%):</p>
                <div class="text-[10px] mb-3 pl-2 border-l border-gray-600">
                    <div>LPs under 50% APR get a boost (needs help)</div>
                    <div>LPs over 50% APR get a penalty (shift focus elsewhere)</div>
                    <div>Creates automatic rebalancing toward underperformers</div>
                </div>
                
                <p class="mb-2 font-bold text-white">Score Interpretation:</p>
                <div class="space-y-1 text-[11px] mb-3">
                    <div>üü¢ <span class="text-green-400">+50 to +100</span> - High priority: Strong performer, underserved</div>
                    <div>üü° <span class="text-yellow-400">+20 to +50</span> - Opportunity: Worth considering</div>
                    <div>‚ö™ <span class="text-gray-400">-20 to +20</span> - Balanced: Getting fair support</div>
                    <div>üîµ <span class="text-blue-400">-50 to -20</span> - Over-supported: Already has attention</div>
                    <div>üî¥ <span class="text-red-400">Below -50</span> - Over-hyped: Getting way more than deserved</div>
                </div>
                
                <div class="bg-emerald-900/30 border border-emerald-700 p-2 rounded">
                    <p class="text-emerald-400 text-[11px]"><strong>Our Mission:</strong> Be the thoughtful voice that supports native Terra projects, rewards efficient LPs, and ensures fair distribution of TLA votes across the ecosystem. üè†</p>
                </div>
            `;
            break;
    }
    
    // Create modal
    let modal = document.createElement('div');
    modal.className = 'modal-overlay open';
    modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
    modal.innerHTML = `
        <div class="modal-box max-w-lg">
            <div class="flex justify-between items-center mb-4 border-b border-gray-700 pb-2">
                <h3 class="text-lg font-bold text-white">${title}</h3>
                <button onclick="this.closest('.modal-overlay').remove()" class="text-gray-500 hover:text-white text-xl">&times;</button>
            </div>
            <div class="text-sm text-gray-300">${content}</div>
        </div>
    `;
    document.body.appendChild(modal);
}

function showPoolScoreDetails(poolName, dex) {
    let p = store.vote.pools.find(pool => pool.n === poolName && pool.d.includes(dex.substring(0,5)));
    if (!p) return;
    
    let liq4EpStr = p.liq4Ep ? `$${(p.liq4Ep.avg/1000).toFixed(1)}K (${p.liq4Ep.count} epochs)` : 'N/A';
    let vol4EpStr = p.vol4Ep ? `$${(p.vol4Ep.avg/1000).toFixed(1)}K (${p.vol4Ep.count} epochs)` : 'N/A';
    
    // Access score breakdown
    let accessHtml = '';
    if (p.accessData && p.accessData.breakdown) {
        let b = p.accessData.breakdown;
        accessHtml = `
            <div class="space-y-1 text-[10px]">
                <div class="flex justify-between"><span class="text-gray-500">${b.asset1.name}:</span><span class="text-white">${b.asset1.tier} (${b.asset1.points})</span></div>
                <div class="flex justify-between"><span class="text-gray-500">${b.asset2.name}:</span><span class="text-white">${b.asset2.tier} (${b.asset2.points})</span></div>
                <div class="flex justify-between"><span class="text-gray-500">Asset Avg:</span><span class="text-yellow-300">${b.assetAvg.toFixed(1)}/3</span></div>
                <div class="flex justify-between"><span class="text-gray-500">Bridge:</span><span class="text-cyan-300">${b.bridge.label} (${b.bridge.points}/3)</span></div>
                <div class="flex justify-between"><span class="text-gray-500">LUNA Benefit:</span><span class="text-green-300">${b.lunaBenefit.label} (${b.lunaBenefit.points}/3)</span></div>
                ${b.ecosystem.bonus > 0 ? `<div class="flex justify-between"><span class="text-gray-500">Ecosystem:</span><span class="text-blue-300">+${b.ecosystem.bonus} (${b.ecosystem.factors.join(', ')})</span></div>` : ''}
                <div class="text-[9px] text-gray-500 italic mt-1">${b.lunaBenefit.reason}</div>
            </div>
        `;
    }
    
    let modal = document.createElement('div');
    modal.className = 'modal-overlay open';
    modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
    modal.innerHTML = `
        <div class="modal-box max-w-3xl">
            <div class="flex justify-between items-center mb-4 border-b border-gray-700 pb-2">
                <h3 class="text-lg font-bold text-white">${poolName} <span class="text-sm text-gray-500">(${p.d})</span></h3>
                <button onclick="this.closest('.modal-overlay').remove()" class="text-gray-500 hover:text-white text-xl">&times;</button>
            </div>
            
            <div class="grid grid-cols-3 gap-3 text-sm">
                <div class="bg-gray-800/50 p-3 rounded">
                    <h4 class="text-teal-400 font-bold mb-2 border-b border-gray-700 pb-1">Performance Metrics</h4>
                    <div class="space-y-1 text-[10px]">
                        <div class="flex justify-between"><span class="text-gray-500">4Ep Avg Liquidity:</span><span class="text-teal-300">${liq4EpStr}</span></div>
                        <div class="flex justify-between"><span class="text-gray-500">4Ep Avg Volume:</span><span class="text-teal-300">${vol4EpStr}</span></div>
                        <div class="flex justify-between"><span class="text-gray-500">Efficiency (Vol/Liq):</span><span class="text-yellow-400">${p.efficiency?.toFixed(3) || 'N/A'}</span></div>
                        <div class="flex justify-between"><span class="text-gray-500">Non-Amp APR:</span><span class="text-green-400">${p.aprNon ? p.aprNon.toFixed(1) + '%' : 'N/A'}</span></div>
                        <div class="flex justify-between"><span class="text-gray-500">Amplified APR:</span><span class="text-yellow-400">${p.aprAmp ? 'üî•' + p.aprAmp.toFixed(1) + '%' : 'N/A'}</span></div>
                    </div>
                    <div class="mt-2 pt-2 border-t border-gray-700 text-[10px]">
                        <div class="flex justify-between"><span class="text-gray-500">Efficiency Rank:</span><span>${p.effRank?.toFixed(0) || 0}% (√ó0.35)</span></div>
                        <div class="flex justify-between"><span class="text-gray-500">Volume Rank:</span><span>${p.volRank?.toFixed(0) || 0}% (√ó0.25)</span></div>
                        <div class="flex justify-between"><span class="text-gray-500">Liquidity Rank:</span><span>${p.liqRank?.toFixed(0) || 0}% (√ó0.20)</span></div>
                        <div class="flex justify-between"><span class="text-gray-500">Access Score:</span><span>${p.accessScore?.toFixed(0) || 0}% (√ó0.15)</span></div>
                        <div class="flex justify-between"><span class="text-gray-500">History Score:</span><span class="text-gray-600">TBD (√ó0.05)</span></div>
                    </div>
                    <div class="mt-2 pt-2 border-t border-gray-700 font-bold text-[11px]">
                        <div class="flex justify-between"><span>Performance:</span><span class="text-white">${p.performanceScore?.toFixed(1) || 0}</span></div>
                    </div>
                </div>
                
                <div class="bg-gray-800/50 p-3 rounded">
                    <h4 class="text-orange-300 font-bold mb-2 border-b border-gray-700 pb-1">Support Metrics</h4>
                    <div class="space-y-1 text-[10px]">
                        <div class="flex justify-between"><span class="text-gray-500">PD Bribes:</span><span class="text-green-400">${fmt$(p.incPD)}</span></div>
                        ${p.incOther > 0 ? `<div class="flex justify-between"><span class="text-gray-500">Other Bribes:</span><span class="text-yellow-400">${fmt$(p.incOther)}</span></div>` : ''}
                        ${p.incTotal > p.incPD ? `<div class="flex justify-between"><span class="text-gray-500">Total Bribes:</span><span class="text-white">${fmt$(p.incTotal)}</span></div>` : ''}
                        <div class="flex justify-between"><span class="text-gray-500">Votion Now:</span><span class="text-purple-400">${p.votNowPct?.toFixed(2) || 0}%</span></div>
                        <div class="flex justify-between"><span class="text-gray-500">Votion Next:</span><span class="text-purple-300">${p.votNextPct?.toFixed(2) || 0}%</span></div>
                        <div class="flex justify-between"><span class="text-gray-500">Votion Dominance:</span><span class="${(p.votionDominance || 0) > 50 ? 'text-red-400' : 'text-gray-300'}">${p.votionDominance?.toFixed(0) || 0}%</span></div>
                        <div class="flex justify-between"><span class="text-gray-500">TLA Vote %:</span><span class="text-orange-400">${p.vps?.toFixed(2) || 0}%</span></div>
                    </div>
                    <div class="mt-2 pt-2 border-t border-gray-700 text-[10px]">
                        <div class="flex justify-between"><span class="text-gray-500">Bribes Rank:</span><span>${p.incRank?.toFixed(0) || 0}% (√ó0.40)</span></div>
                        <div class="flex justify-between"><span class="text-gray-500">TLA Rank:</span><span>${p.tlaRank?.toFixed(0) || 0}% (√ó0.30)</span></div>
                        <div class="flex justify-between"><span class="text-gray-500">Votion Dominance:</span><span>${p.votionDominance?.toFixed(0) || 0}% (√ó0.30)</span></div>
                    </div>
                    <div class="mt-2 pt-2 border-t border-gray-700 font-bold text-[11px]">
                        <div class="flex justify-between"><span>Support:</span><span class="text-white">${p.supportScore?.toFixed(1) || 0}</span></div>
                    </div>
                </div>
                
                <div class="bg-gray-800/50 p-3 rounded">
                    <h4 class="text-cyan-400 font-bold mb-2 border-b border-gray-700 pb-1">Access Score Breakdown</h4>
                    ${accessHtml || '<div class="text-gray-500 text-[10px]">No data</div>'}
                    <div class="mt-2 pt-2 border-t border-gray-700 font-bold text-[11px]">
                        <div class="flex justify-between"><span>Access:</span><span class="text-white">${p.accessScore?.toFixed(0) || 0}/100</span></div>
                    </div>
                </div>
            </div>
            
            <div class="mt-4 bg-emerald-900/30 border border-emerald-800 p-3 rounded">
                <h4 class="text-emerald-400 font-bold mb-2">aDAO Opportunity Calculation</h4>
                <div class="grid grid-cols-2 gap-4">
                    <div class="text-[11px] font-mono space-y-1">
                        <div>Performance Score: <span class="text-white">${p.performanceScore?.toFixed(1) || 0}</span></div>
                        <div>- Support Score: <span class="text-white">${p.supportScore?.toFixed(1) || 0}</span></div>
                        <div>+ APR Factor: <span class="${p.aprFactor >= 0 ? 'text-green-400' : 'text-red-400'}">${p.aprFactor >= 0 ? '+' : ''}${p.aprFactor || 0}</span> <span class="text-gray-500">(APR: ${p.aprNon?.toFixed(1) || '?'}%)</span></div>
                        <div class="border-t border-emerald-800 pt-1 mt-1 text-lg">
                            = <span class="${getScoreColor(p.adaoScore)} font-bold">${getScoreIcon(p.adaoScore)} ${p.adaoScore?.toFixed(1) || 0}</span>
                        </div>
                    </div>
                    <div class="text-[10px] text-gray-400">
                        <div class="font-bold text-white mb-1">Score Interpretation:</div>
                        <div>üü¢ +50 to +100: High priority</div>
                        <div>üü° +20 to +50: Opportunity</div>
                        <div>‚ö™ -20 to +20: Balanced</div>
                        <div>üîµ -50 to -20: Over-supported</div>
                        <div>üî¥ Below -50: Over-hyped</div>
                    </div>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

// ============ METADATA MANAGER ============

let assetMetadata = {};
const METADATA_GITHUB_URL = 'https://raw.githubusercontent.com/defipatriot/tla_json_storage/main/tla_metadata.json';

const ASSET_CATEGORIES = {
    bluechip: { label: 'üèÜ Blue Chip', color: 'text-yellow-300' },
    stable: { label: 'üíµ Stable', color: 'text-green-300' },
    core: { label: '‚öõÔ∏è Core', color: 'text-purple-300' },
    native: { label: 'üè† Native Terra', color: 'text-orange-300' },
    lsd: { label: 'üîÑ LSD', color: 'text-cyan-300' },
    cross: { label: 'üåâ Cross-chain', color: 'text-gray-300' },
    unknown: { label: '‚ùì Unknown', color: 'text-gray-500' }
};

const BRIDGE_TYPES = {
    native: 'Native',
    '.atom': 'IBC/Skip',
    '.axl': 'Axelar',
    '.osmo': 'Osmosis',
    '.wh': 'Wormhole'
};

function toggleMetadataPanel() {
    let panel = $('metadata-panel');
    let toggle = $('meta-toggle');
    if (panel.classList.contains('hidden')) {
        panel.classList.remove('hidden');
        toggle.innerText = '‚ñ≤';
    } else {
        panel.classList.add('hidden');
        toggle.innerText = '‚ñº';
    }
}

function extractAssetsFromPools() {
    let assets = new Set();
    
    // Extract from vote pools
    store.vote.pools.forEach(p => {
        let parts = p.n.split('-');
        parts.forEach(asset => {
            if (asset && asset.length > 0) {
                assets.add(asset.trim());
            }
        });
    });
    
    // Extract from liquidity pools
    store.tla.pools.forEach(p => {
        let parts = p.normName ? p.normName.split('-') : p.name.split('-');
        parts.forEach(asset => {
            if (asset && asset.length > 0) {
                assets.add(asset.trim());
            }
        });
    });
    
    // Add each unique asset to metadata if not already present
    assets.forEach(asset => {
        if (!assetMetadata[asset]) {
            assetMetadata[asset] = {
                coingecko: false,
                coingecko_id: '',
                category: detectCategory(asset),
                bridge: detectBridge(asset),
                multiDex: false,
                notes: ''
            };
        }
    });
    
    renderMetaAssetList();
    updateMetaStatus();
    alert(`Extracted ${assets.size} unique assets from parsed pools`);
}

function detectCategory(asset) {
    let base = asset.replace(/\.(atom|axl|osmo|wh)$/i, '').toUpperCase();
    
    if (['BTC', 'WBTC', 'ETH', 'WETH', 'PAXG'].includes(base)) return 'bluechip';
    if (['USDC', 'USDT', 'EURE', 'DAI'].includes(base)) return 'stable';
    if (['LUNA', 'ATOM', 'INJ'].includes(base)) return 'core';
    if (['ROAR', 'CAPA', 'SOLID', 'ASTRO', 'FUEL', 'XASTRO'].includes(base)) return 'native';
    if (['AMPLUNA', 'ARBLUNA', 'BLUNA', 'STLUNA', 'STATOM', 'BONELUNA', 'AMPCAPA'].includes(base)) return 'lsd';
    if (['WBNB', 'WSTETH', 'SWTH'].includes(base)) return 'cross';
    return 'unknown';
}

function detectBridge(asset) {
    if (asset.match(/\.atom$/i)) return '.atom';
    if (asset.match(/\.axl$/i)) return '.axl';
    if (asset.match(/\.osmo$/i)) return '.osmo';
    if (asset.match(/\.wh$/i)) return '.wh';
    return 'native';
}

function renderMetaAssetList() {
    let container = $('meta-asset-list');
    if (!container) return;
    
    let search = $('meta-search')?.value?.toLowerCase() || '';
    let assets = Object.keys(assetMetadata).sort();
    
    if (search) {
        assets = assets.filter(a => a.toLowerCase().includes(search));
    }
    
    if (assets.length === 0) {
        container.innerHTML = '<div class="text-center text-gray-600 italic text-xs py-4">No assets found</div>';
        return;
    }
    
    let html = '';
    assets.forEach(asset => {
        let meta = assetMetadata[asset];
        let catInfo = ASSET_CATEGORIES[meta.category] || ASSET_CATEGORIES.unknown;
        let bridgeLabel = BRIDGE_TYPES[meta.bridge] || meta.bridge;
        
        html += `
        <div class="grid grid-cols-6 gap-1 items-center px-2 py-1 hover:bg-gray-800/50 rounded text-[10px]">
            <div class="col-span-2 font-mono text-white font-bold">${asset}</div>
            <div class="text-center">
                <input type="checkbox" ${meta.coingecko ? 'checked' : ''} 
                    onchange="toggleMetaField('${asset}', 'coingecko', this.checked)"
                    class="w-4 h-4 accent-green-500">
            </div>
            <div class="text-center">
                <select onchange="updateMetaField('${asset}', 'category', this.value)" 
                    class="bg-gray-800 border border-gray-700 rounded px-1 py-0.5 text-[9px] ${catInfo.color}">
                    ${Object.entries(ASSET_CATEGORIES).map(([k, v]) => 
                        `<option value="${k}" ${meta.category === k ? 'selected' : ''}>${v.label}</option>`
                    ).join('')}
                </select>
            </div>
            <div class="text-center">
                <select onchange="updateMetaField('${asset}', 'bridge', this.value)"
                    class="bg-gray-800 border border-gray-700 rounded px-1 py-0.5 text-[9px]">
                    ${Object.entries(BRIDGE_TYPES).map(([k, v]) => 
                        `<option value="${k}" ${meta.bridge === k ? 'selected' : ''}>${v}</option>`
                    ).join('')}
                </select>
            </div>
            <div class="text-center">
                <button onclick="editAssetDetails('${asset}')" class="text-blue-400 hover:text-white text-[9px]">‚úèÔ∏è</button>
                <button onclick="deleteAsset('${asset}')" class="text-red-400 hover:text-white text-[9px] ml-1">üóëÔ∏è</button>
            </div>
        </div>`;
    });
    
    container.innerHTML = html;
}

function filterMetaAssets() {
    renderMetaAssetList();
}

function toggleMetaField(asset, field, value) {
    if (assetMetadata[asset]) {
        assetMetadata[asset][field] = value;
    }
}

function updateMetaField(asset, field, value) {
    if (assetMetadata[asset]) {
        assetMetadata[asset][field] = value;
        renderMetaAssetList();
    }
}

function deleteAsset(asset) {
    if (confirm(`Delete ${asset} from metadata?`)) {
        delete assetMetadata[asset];
        renderMetaAssetList();
        updateMetaStatus();
    }
}

function addNewAsset() {
    let asset = prompt('Enter asset symbol (e.g., LUNA, wBTC.axl):');
    if (!asset) return;
    
    asset = asset.trim();
    if (assetMetadata[asset]) {
        alert('Asset already exists!');
        return;
    }
    
    assetMetadata[asset] = {
        coingecko: false,
        coingecko_id: '',
        category: detectCategory(asset),
        bridge: detectBridge(asset),
        multiDex: false,
        notes: ''
    };
    
    renderMetaAssetList();
    updateMetaStatus();
}

function editAssetDetails(asset) {
    let meta = assetMetadata[asset];
    if (!meta) return;
    
    let modal = document.createElement('div');
    modal.className = 'modal-overlay open';
    modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
    modal.innerHTML = `
        <div class="modal-box max-w-md">
            <div class="flex justify-between items-center mb-4 border-b border-gray-700 pb-2">
                <h3 class="text-lg font-bold text-white">Edit: ${asset}</h3>
                <button onclick="this.closest('.modal-overlay').remove()" class="text-gray-500 hover:text-white text-xl">&times;</button>
            </div>
            <div class="space-y-3 text-sm">
                <div>
                    <label class="block text-gray-400 text-xs mb-1">CoinGecko ID (if listed)</label>
                    <input type="text" id="edit-cg-id" value="${meta.coingecko_id || ''}" 
                        placeholder="e.g., terra-luna-2"
                        class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm">
                </div>
                <div class="flex items-center gap-2">
                    <input type="checkbox" id="edit-multi-dex" ${meta.multiDex ? 'checked' : ''} class="accent-green-500">
                    <label class="text-gray-300 text-xs">Available on multiple DEXs</label>
                </div>
                <div>
                    <label class="block text-gray-400 text-xs mb-1">Notes</label>
                    <textarea id="edit-notes" rows="2" 
                        class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm">${meta.notes || ''}</textarea>
                </div>
                <button onclick="saveAssetDetails('${asset}')" 
                    class="w-full bg-green-700 hover:bg-green-600 py-2 rounded font-bold">Save</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

function saveAssetDetails(asset) {
    let meta = assetMetadata[asset];
    if (!meta) return;
    
    meta.coingecko_id = $('edit-cg-id')?.value || '';
    meta.coingecko = meta.coingecko_id.length > 0;
    meta.multiDex = $('edit-multi-dex')?.checked || false;
    meta.notes = $('edit-notes')?.value || '';
    
    document.querySelector('.modal-overlay.open')?.remove();
    renderMetaAssetList();
}

function updateMetaStatus() {
    let count = Object.keys(assetMetadata).length;
    let cgCount = Object.values(assetMetadata).filter(m => m.coingecko).length;
    setTxt('meta-status', `${count} assets (${cgCount} on CG)`);
}

async function loadMetadataFromGitHub() {
    try {
        let resp = await fetch(METADATA_GITHUB_URL);
        if (!resp.ok) throw new Error('Failed to fetch');
        let data = await resp.json();
        
        assetMetadata = data.assets || {};
        renderMetaAssetList();
        updateMetaStatus();
        alert(`Loaded ${Object.keys(assetMetadata).length} assets from GitHub`);
    } catch (e) {
        console.error('Failed to load metadata:', e);
        alert('Failed to load from GitHub. Repository may not exist yet or file is missing.');
    }
}

function downloadMetadata() {
    let data = {
        version: 1,
        updated: new Date().toISOString(),
        assets: assetMetadata
    };
    
    let blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    let url = URL.createObjectURL(blob);
    let a = document.createElement('a');
    a.href = url;
    a.download = 'tla_metadata.json';
    a.click();
    URL.revokeObjectURL(url);
}

function copyMetadata() {
    let data = {
        version: 1,
        updated: new Date().toISOString(),
        assets: assetMetadata
    };
    
    navigator.clipboard.writeText(JSON.stringify(data, null, 2)).then(() => {
        alert('Metadata copied to clipboard!');
    });
}

// ============ ADAO STRATEGY ============

function toggleStrategyPanel() {
    let panel = $('strategy-panel');
    let toggle = $('strategy-toggle');
    if (panel.classList.contains('hidden')) {
        panel.classList.remove('hidden');
        toggle.innerText = '‚ñ≤';
    } else {
        panel.classList.add('hidden');
        toggle.innerText = '‚ñº';
    }
}

function generateStrategy() {
    if (store.vote.pools.length === 0) {
        alert('Please parse Vote data first');
        return;
    }
    
    calculateAllScores();
    generateVoteOptimization();
    generateBribeCandidates();
    generateActivationTargets();
}

function generateVoteOptimization() {
    let html = '';
    
    BUCKET_ORDER.forEach(bucket => {
        let pools = store.vote.pools.filter(p => p.b === bucket && p.vps >= 1); // Active only for vote allocation
        if (pools.length === 0) return;
        
        // Sort by aDAO score (highest first)
        pools.sort((a, b) => (b.adaoScore || 0) - (a.adaoScore || 0));
        
        // Calculate recommended allocation in 10% chunks
        let totalChunks = 10; // 100% = 10 chunks of 10%
        let allocations = [];
        let remainingChunks = totalChunks;
        
        pools.forEach((p, idx) => {
            if (remainingChunks <= 0) {
                allocations.push({ pool: p, recommended: 0 });
                return;
            }
            
            let chunks = 0;
            if (p.adaoScore >= 30) {
                chunks = Math.min(4, remainingChunks); // Max 40% for top scorers
            } else if (p.adaoScore >= 10) {
                chunks = Math.min(3, remainingChunks); // Max 30%
            } else if (p.adaoScore >= 0) {
                chunks = Math.min(2, remainingChunks); // Max 20%
            } else if (p.adaoScore >= -20) {
                chunks = Math.min(1, remainingChunks); // Max 10%
            }
            // Negative scores below -20 get 0
            
            remainingChunks -= chunks;
            allocations.push({ pool: p, recommended: chunks * 10 });
        });
        
        // Distribute any remaining chunks to top pools
        let i = 0;
        while (remainingChunks > 0 && allocations.length > 0) {
            if (allocations[i].recommended < 50) { // Cap at 50%
                allocations[i].recommended += 10;
                remainingChunks--;
            }
            i = (i + 1) % allocations.length;
            if (i === 0 && allocations.every(a => a.recommended >= 50)) break;
        }
        
        // Build HTML
        html += `<div class="border-b border-gray-700 pb-2 mb-2">
            <div class="text-[10px] font-bold text-gray-400 uppercase mb-2">${bucket}</div>
            <div class="grid grid-cols-5 gap-1 text-[9px] text-gray-500 mb-1 px-1">
                <div class="col-span-2">Pool</div>
                <div class="text-right">Score</div>
                <div class="text-right">Now</div>
                <div class="text-right">Rec</div>
            </div>`;
        
        allocations.filter(a => a.recommended > 0 || a.pool.ms > 0).forEach(a => {
            let p = a.pool;
            let current = p.ms || 0;
            let diff = a.recommended - current;
            let diffColor = diff > 0 ? 'text-green-400' : diff < 0 ? 'text-red-400' : 'text-gray-500';
            let diffStr = diff > 0 ? `+${diff.toFixed(0)}%` : diff < 0 ? `${diff.toFixed(0)}%` : '-';
            
            html += `<div class="grid grid-cols-5 gap-1 px-1 py-0.5 hover:bg-gray-800/50 rounded">
                <div class="col-span-2 truncate text-white">${p.n}</div>
                <div class="text-right ${getScoreColor(p.adaoScore)}">${p.adaoScore?.toFixed(0) || 0}</div>
                <div class="text-right text-cyan-400">${current.toFixed(0)}%</div>
                <div class="text-right font-bold ${diffColor}">${a.recommended}%</div>
            </div>`;
        });
        
        html += `</div>`;
    });
    
    setHtml('vote-optimization', html);
}

function generateBribeCandidates() {
    let html = '';
    let candidates = [];
    
    BUCKET_ORDER.forEach(bucket => {
        // Include both active AND inactive pools for bribe consideration
        let pools = store.vote.pools.filter(p => p.b === bucket);
        if (pools.length === 0) return;
        
        // Score for bribe worthiness:
        // - High aDAO score
        // - Native Terra bonus
        // - Currently low bribes
        // - Minimum liquidity ($25K+)
        pools.forEach(p => {
            let bribeScore = (p.adaoScore || 0);
            
            // Native Terra bonus (+15)
            let isNative = p.n.match(/ROAR|CAPA|SOLID|ASTRO|FUEL/i);
            if (isNative) bribeScore += 15;
            
            // Low current bribes bonus (+10 if <$10)
            if (p.incPD < 10) bribeScore += 10;
            
            // Penalize if already getting lots of bribes
            if (p.incPD > 50) bribeScore -= 20;
            
            // Minimum liquidity check
            let liq = p.liq4Ep?.avg || p.dp || 0;
            if (liq < 25000) bribeScore -= 50; // Heavy penalty for tiny pools
            
            p.bribeScore = bribeScore;
            p.isNative = isNative;
        });
        
        // Sort by bribe score and pick top
        pools.sort((a, b) => (b.bribeScore || 0) - (a.bribeScore || 0));
        let best = pools[0];
        
        if (best) {
            let statusBadge = best.vps < 1 ? '<span class="text-red-400 text-[9px]">INACT</span>' : '';
            let nativeBadge = best.isNative ? '<span class="text-orange-400">üè†</span>' : '';
            
            candidates.push({ bucket, pool: best });
            
            html += `<div class="flex justify-between items-center py-1 px-2 bg-gray-800/50 rounded">
                <div>
                    <span class="text-gray-500 text-[10px] w-20 inline-block">${bucket}:</span>
                    <span class="text-white font-bold">${best.n}</span>
                    ${nativeBadge} ${statusBadge}
                </div>
                <div class="text-right">
                    <span class="${getScoreColor(best.adaoScore)}">${best.adaoScore?.toFixed(0) || 0}</span>
                </div>
            </div>`;
        }
    });
    
    // Store for copy function
    window.bribeCandidates = candidates;
    
    setHtml('bribe-candidates', html);
}

function generateActivationTargets() {
    let html = '';
    
    // Find inactive pools (< 1% votes) that have good potential
    let inactivePools = store.vote.pools.filter(p => p.vps < 1);
    
    if (inactivePools.length === 0) {
        html = '<div class="text-gray-500 italic">No inactive pools found</div>';
        setHtml('activation-targets', html);
        return;
    }
    
    // Score them by potential
    inactivePools.forEach(p => {
        let activationScore = 0;
        
        // Access score matters (good assets, good bridge, LUNA benefit)
        activationScore += (p.accessScore || 0) * 0.4;
        
        // Native Terra bonus
        if (p.n.match(/ROAR|CAPA|SOLID|ASTRO|FUEL/i)) activationScore += 20;
        
        // Has some liquidity (not dead)
        let liq = p.liq4Ep?.avg || p.dp || 0;
        if (liq > 50000) activationScore += 15;
        else if (liq > 25000) activationScore += 10;
        else if (liq > 10000) activationScore += 5;
        
        // Has some volume (people actually trade)
        let vol = p.vol4Ep?.avg || p.vol || 0;
        if (vol > 10000) activationScore += 15;
        else if (vol > 5000) activationScore += 10;
        
        // Low APR = needs help
        if (p.aprNon && p.aprNon < 40) activationScore += 10;
        
        p.activationScore = activationScore;
    });
    
    // Sort and take top 5
    inactivePools.sort((a, b) => (b.activationScore || 0) - (a.activationScore || 0));
    let topTargets = inactivePools.slice(0, 5);
    
    topTargets.forEach(p => {
        let liq = p.liq4Ep?.avg || p.dp || 0;
        let nativeBadge = p.n.match(/ROAR|CAPA|SOLID|ASTRO|FUEL/i) ? '<span class="text-orange-400">üè†</span>' : '';
        
        html += `<div class="flex justify-between items-center py-1 px-2 bg-gray-800/30 rounded">
            <div class="flex items-center gap-2">
                <span class="text-white font-bold">${p.n}</span>
                ${nativeBadge}
                <span class="text-[9px] text-gray-500">${p.d.includes('Astro') ? 'Astro' : 'WW'}</span>
            </div>
            <div class="text-right text-[10px]">
                <span class="text-teal-400">${fmt$(liq)}</span>
                <span class="text-gray-500 mx-1">|</span>
                <span class="text-cyan-400">${p.accessScore?.toFixed(0) || '?'} acc</span>
            </div>
        </div>`;
    });
    
    setHtml('activation-targets', html);
}

function copyVoteStrategy() {
    let text = 'aDAO VOTE OPTIMIZATION\n';
    text += '='.repeat(40) + '\n\n';
    
    BUCKET_ORDER.forEach(bucket => {
        let pools = store.vote.pools.filter(p => p.b === bucket && p.vps >= 1);
        if (pools.length === 0) return;
        
        pools.sort((a, b) => (b.adaoScore || 0) - (a.adaoScore || 0));
        
        text += `${bucket}\n`;
        text += '-'.repeat(20) + '\n';
        
        pools.filter(p => (p.adaoScore || 0) > -20).slice(0, 5).forEach(p => {
            text += `${p.n}: Score ${p.adaoScore?.toFixed(0) || 0}\n`;
        });
        text += '\n';
    });
    
    navigator.clipboard.writeText(text).then(() => {
        alert('Vote strategy copied!');
    });
}

function copyBribeCandidates() {
    if (!window.bribeCandidates || window.bribeCandidates.length === 0) {
        alert('Generate strategy first');
        return;
    }
    
    let text = 'aDAO BRIBE ALLOCATION PROPOSAL\n';
    text += '='.repeat(40) + '\n\n';
    text += 'Vote for ONE pool to receive aDAO-sponsored bribes:\n\n';
    
    window.bribeCandidates.forEach(c => {
        let native = c.pool.isNative ? ' üè†' : '';
        text += `‚ñ° ${c.bucket}: ${c.pool.n}${native}\n`;
    });
    
    text += '\n[Bribes distributed over 4 epochs]\n';
    
    navigator.clipboard.writeText(text).then(() => {
        alert('Bribe proposal copied!');
    });
}

function findCurrentEpoch() {
    const now = new Date();
    
    // Find which epoch we're currently in
    for (let ep of epochData) {
        let start = new Date(ep.start_time);
        let end = new Date(ep.end_time);
        
        if (now >= start && now < end) {
            currentEpochInfo = ep;
            store.vote.ep = ep.epoch;
            
            // Set the epoch input field
            if ($('historyEpoch')) {
                $('historyEpoch').value = ep.epoch;
            }
            return;
        }
    }
    
    // If we're past all epochs in the file, use the last one
    if (epochData.length > 0) {
        currentEpochInfo = epochData[epochData.length - 1];
        store.vote.ep = currentEpochInfo.epoch;
        if ($('historyEpoch')) {
            $('historyEpoch').value = currentEpochInfo.epoch;
        }
    }
}

function updateTimers() {
    const now = new Date();
    
    if (currentEpochInfo) {
        // Display current epoch
        setTxt('live-epoch', `Epoch ${currentEpochInfo.epoch}`);
        
        // Calculate time until epoch ends
        const endTime = new Date(currentEpochInfo.end_time);
        const msUntilEnd = endTime - now;
        const daysLeft = Math.floor(msUntilEnd / 86400000);
        
        setTxt('epoch-timer', formatTimeDiff(msUntilEnd));
        
        // Calculate phase: 6+ = Start, 5-3 = Mid, 2-0 = End
        let phase = 'End';
        let phaseColor = 'text-red-400';
        if (daysLeft >= 6) {
            phase = 'Start';
            phaseColor = 'text-green-400';
        } else if (daysLeft >= 3) {
            phase = 'Mid';
            phaseColor = 'text-yellow-400';
        }
        const phaseEl = $('epoch-phase');
        if (phaseEl) {
            phaseEl.innerText = phase;
            phaseEl.className = phaseColor + ' font-bold ml-1';
        }
        
        // Calculate time until rewards update
        const rewardsTime = new Date(currentEpochInfo.rewards_update);
        const msUntilRewards = rewardsTime - now;
        
        if (msUntilRewards > 0) {
            setTxt('reward-timer', formatTimeDiff(msUntilRewards));
        } else {
            setTxt('reward-timer', 'Updated ‚úì');
        }
        
        // Check if epoch ended and we need to refresh
        if (msUntilEnd <= 0) {
            findCurrentEpoch(); // Move to next epoch
        }
    } else {
        setTxt('live-epoch', 'Epoch ...');
        setTxt('epoch-timer', 'Loading...');
        setTxt('epoch-phase', '...');
        setTxt('reward-timer', 'Loading...');
    }
}

function formatTimeDiff(ms) {
    if (ms < 0) return "0d 0h 0m";
    let d = Math.floor(ms / 86400000);
    let h = Math.floor((ms % 86400000) / 3600000);
    let m = Math.floor((ms % 3600000) / 60000);
    return `${d}d ${h}h ${m}m`;
}

// === SESSION MANAGER ===
async function findLatestSnapshot() {
    const msg = $('load-msg');
    if (msg) msg.innerText = "Searching for latest snapshot...";
    
    // Start from current epoch (from epoch file) or fallback
    let startEp = currentEpochInfo ? currentEpochInfo.epoch : 165;
    const phases = ["end", "mid", "start"];
    const base = "https://raw.githubusercontent.com/defipatriot/tla_json_storage/main/tla-data-epoch";
    
    // Check up to 10 epochs back
    for (let ep = startEp; ep >= startEp - 10; ep--) {
        for (let ph of phases) {
            try {
                let res = await fetch(`${base}-${ep}-${ph}.json`, { method: 'HEAD' });
                if (res.ok) {
                    $('historyEpoch').value = ep;
                    $('historyPhase').value = ph;
                    updateGithubLink();
                    if (msg) {
                        msg.innerText = `Found: Epoch ${ep} (${ph})`;
                        msg.className = "text-[10px] text-green-400 font-bold";
                    }
                    return { epoch: ep, phase: ph };
                }
            } catch(err) {}
        }
    }
    
    if (msg) {
        msg.innerText = "No snapshots found";
        msg.className = "text-[10px] text-red-400 font-bold";
    }
    return null;
}

function checkExtData() {
    // TODO: Check if ext data file exists
}

function updateGithubLink() {
    const ep = $('historyEpoch')?.value || '';
    const ph = $('historyPhase')?.value?.toLowerCase() || 'end';
    const fileName = `tla-data-epoch-${ep}-${ph}.json`;
    const linkEl = $('github-link');
    if (linkEl) {
        linkEl.innerHTML = `<i class="fab fa-github"></i> ${fileName}`;
        linkEl.href = `https://github.com/defipatriot/tla_json_storage/blob/main/${fileName}`;
    }
}

async function fetchCoreData() {
    let ep = $('historyEpoch').value;
    let ph = $('historyPhase').value;
    let url = `https://raw.githubusercontent.com/defipatriot/tla_json_storage/main/tla-data-epoch-${ep}-${ph}.json`;
    
    try {
        let res = await fetch(url);
        if (!res.ok) throw new Error("File not found");
        let d = await res.json();
        
        // Load vote data
        if (d.vote_data) {
            store.vote.ep = d.vote_data.epoch;
            store.vote.end = d.vote_data.ends_in;
            store.vote.tvp = d.vote_data.total_voting_power;
            store.vote.reb = d.vote_data.adao_rebase || 0;
            store.vote.usd = d.vote_data.adao_unclaimed_rewards || 0;
            store.vote.pools = (d.vote_data.pools || []).map(p => ({
                n: p.pool_name,
                d: p.dex || p.dex_name,
                b: p.bucket || "UNKNOWN",
                tvp: p.tla_total_votes || 0,
                dp: p.pool_depth || 0,
                mvp: p.adao_vote_vp || 0,
                vps: parseFloat(p.tla_vote_share || 0),
                ms: parseFloat(p.adao_vote_share || 0),
                inc: p.total_bribes || 0,
                apr: '-'
            }));
            renderVoteTable();
        }
        
        // Load locks data
        if (d.locks) {
            store.dao.lVp = d.locks.adao_voting_power || 0;
            store.dao.lFac = d.locks.power_factor || 0;
            store.dao.lAst = d.locks.underlying_assets || 0;
            store.dao.locks = (d.locks.items || []).map(l => ({
                id: l.id,
                amt: l.amount,
                asset: l.asset || 'LUNA',
                vp: l.voting_power,
                usd: l.usd_value,
                status: l.status || 'Unknown'
            }));
            renderLocks();
        }
        
        alert("Loaded Epoch " + ep + " (" + ph + ")");
    } catch(e) {
        alert("Could not load: " + e.message);
    }
}

// === TAB SWITCHING ===
function switchTab(t) {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    event.target.classList.add('active');
    document.querySelectorAll('.workspace').forEach(w => w.classList.remove('active'));
    $('ws-' + t)?.classList.add('active');
}

// === VOTE PARSING ===
function normalizeName(name) {
    if (!name.includes('-')) return name;
    let parts = name.split('-');
    if (['LUNA', 'bLUNA', 'ampLUNA'].includes(parts[1])) return `${parts[1]}-${parts[0]}`;
    return name;
}

function parseVote() {
    try {
        let txt = $('votePaste').value;
        
        // === HEADER DATA ===
        let m;
        if (m = txt.match(/For Epoch\s*(\d+)/)) store.vote.ep = parseInt(m[1]);
        if (m = txt.match(/ends\s*\n?\s*in\s*(\d+)\s*day/i)) store.vote.end = m[1] + ' days';
        if (m = txt.match(/Total Voting Power\s*\n?\s*([\d\.]+)([KkMm])?VP/i)) store.vote.tvp = parseNum(m[1] + (m[2] || ''));
        if (m = txt.match(/Your Voting Power\s*\n?\s*([\d\.]+)([KkMm]?)VP/i)) store.dao.lVp = parseNum(m[1] + (m[2] || ''));
        if (m = txt.match(/Rebase\s*\n?\s*([\d\.,]+)/i)) store.vote.reb = parseNum(m[1]);
        if (m = txt.match(/Vote Rewards\s*\n?\s*\$\s*([\d\.,]+)/i)) store.vote.usd = parseNum(m[1]);

        // === POOL PARSING ===
        let lines = txt.split('\n').map(l => l.trim());
        store.vote.pools = [];
        let currentBucket = "UNKNOWN";
        
        for (let i = 0; i < lines.length; i++) {
            let l = lines[i];
            if (!l) continue;

            // Bucket headers
            if (BUCKET_ORDER.includes(l.toUpperCase())) {
                currentBucket = l.toUpperCase();
                continue;
            }

            // Skip nav/junk lines
            if (/^(LIQUIDITY|VOTE|LOCK|INCENTIVIZE|DASHBOARD|AMPLIFY|GOV|ARBITRAGE|ALLIANCE|icon)/i.test(l)) continue;

            // DEX line = start of pool (pool name is previous line)
            let dexMatch = l.match(/^(Astroport|WhiteWhale|Single)/i);
            if (dexMatch && i > 0) {
                let poolName = lines[i-1];
                if (!poolName || /^icon/i.test(poolName)) continue;
                
                let p = { 
                    n: normalizeName(poolName.replace(' LP', '')), 
                    d: l, 
                    b: currentBucket, 
                    tvp: 0, dp: 0, vol: 0, mvp: 0, vps: 0, ms: 0,
                    // Bribes
                    inc: 0, incPD: 0, incOther: 0, incTotal: 0,
                    // Votion
                    votNowVp: 0, votNowPct: 0, votNextVp: 0, votNextPct: 0,
                    apr: '-'
                };
                
                // Scan forward until "Create locks" (end of pool block)
                for (let k = i + 1; k < i + 20; k++) {
                    let x = lines[k];
                    if (!x) continue;
                    if (x === 'Create locks') break;
                    
                    // Total VP: "VP 15.85M  76.9 %"
                    if (x.startsWith('VP ')) {
                        let vpM = x.match(/VP\s*([\d\.]+)([KkMm]?)\s+([\d\.]+)\s*%/);
                        if (vpM) {
                            p.tvp = parseNum(vpM[1] + (vpM[2] || ''));
                            p.vps = parseFloat(vpM[3]);
                        }
                    }
                    // Depth: "Depth $ 562.97K"
                    else if (x.startsWith('Depth')) {
                        p.dp = parseNum(x);
                    }
                    // Incentives: "$ 16.94" (starts with $)
                    else if (x.startsWith('$')) {
                        let bribeVal = parseNum(x);
                        p.inc = bribeVal;
                        p.incPD = bribeVal; // PD bribes from Vote tab
                        p.incTotal = bribeVal; // Will be updated if we have other bribes
                    }
                    // After "Extend locks" comes user VP
                    else if (x === 'Extend locks') {
                        let userVpLine = lines[k + 1];
                        let userShareLine = lines[k + 2];
                        if (userVpLine?.match(/VP$/i)) {
                            p.mvp = parseNum(userVpLine);
                        }
                        if (userShareLine?.match(/^[\d\.,]+\s*%$/)) {
                            p.ms = parseFloat(userShareLine);
                        }
                    }
                    // vAPR: first standalone % line (not a range with -)
                    else if (x.match(/^[\d\.]+\s*%$/) && p.apr === '-') {
                        p.apr = x;
                    }
                }
                
                store.vote.pools.push(p);
            }
        }
        
        setTxt('status-vote-page', "PARSED");
        $('status-vote-page').className = "text-[9px] text-green-400 font-bold";
        pasteStatus.vote = true;
        updatePasteStatus('ps-vote', true);
        applyExtDataToPools();
        renderVoteTable();
    } catch(e) {
        console.error(e);
        alert("Error parsing vote data. Check console.");
    }
}

function renderVoteTable() {
    setTxt('vote-ep', store.vote.ep);
    setTxt('vote-end', store.vote.end);
    setTxt('vote-tvp', store.vote.tvp.toLocaleString(undefined, {maximumFractionDigits: 0}));
    setTxt('vote-adao-vp', store.dao.lVp ? store.dao.lVp.toLocaleString() : '-');
    
    // Calculate aDAO percentage of total TLA
    if (store.vote.tvp > 0 && store.dao.lVp > 0) {
        setTxt('vote-adao-pct', ((store.dao.lVp / store.vote.tvp) * 100).toFixed(2) + '%');
    } else {
        setTxt('vote-adao-pct', '-');
    }
    
    // Calculate phase from ends string (e.g., "5 days")
    let daysMatch = store.vote.end.match(/(\d+)/);
    if (daysMatch) {
        let days = parseInt(daysMatch[1]);
        let phase = 'End', phaseColor = 'text-red-400';
        if (days >= 6) { phase = 'Start'; phaseColor = 'text-green-400'; }
        else if (days >= 3) { phase = 'Mid'; phaseColor = 'text-yellow-400'; }
        const phaseEl = $('vote-phase');
        if (phaseEl) { phaseEl.innerText = phase; phaseEl.className = phaseColor + ' font-bold'; }
    }
    
    setTxt('vote-rebase', store.vote.reb.toLocaleString() + ' amp');
    setTxt('vote-claim', fmt$(store.vote.usd));

    // Calculate all aDAO scores
    calculateAllScores();

    let showAstro = $('export-astro')?.checked ?? true;
    let showWW = $('export-ww')?.checked ?? true;
    let showInactive = $('export-inactive')?.checked ?? true;
    let showADAO = $('export-adao')?.checked ?? true;

    // === CALCULATE DEX STATS ===
    let dexStats = {
        astro: { active: 0, inactive: 0, depth: 0, tlaVp: 0, adaoVp: 0 },
        ww: { active: 0, inactive: 0, depth: 0, tlaVp: 0, adaoVp: 0 }
    };
    
    let totalTlaVp = 0;
    let totalAdaoVp = 0;
    
    store.vote.pools.forEach(p => {
        let isActive = p.vps >= 1;
        totalTlaVp += p.tvp;
        totalAdaoVp += p.mvp;
        
        if (p.d.includes('Astro')) {
            if (isActive) dexStats.astro.active++; else dexStats.astro.inactive++;
            dexStats.astro.depth += p.dp;
            dexStats.astro.tlaVp += p.tvp;
            dexStats.astro.adaoVp += p.mvp;
        }
        if (p.d.includes('White')) {
            if (isActive) dexStats.ww.active++; else dexStats.ww.inactive++;
            dexStats.ww.depth += p.dp;
            dexStats.ww.tlaVp += p.tvp;
            dexStats.ww.adaoVp += p.mvp;
        }
    });
    
    // Update DEX tables
    setTxt('dex-astro-active', dexStats.astro.active);
    setTxt('dex-astro-inactive', dexStats.astro.inactive);
    setTxt('dex-astro-depth', fmt$(dexStats.astro.depth));
    setTxt('dex-astro-tla-pct', totalTlaVp > 0 ? ((dexStats.astro.tlaVp / totalTlaVp) * 100).toFixed(1) + '%' : '0%');
    setTxt('dex-astro-adao-pct', totalAdaoVp > 0 ? ((dexStats.astro.adaoVp / totalAdaoVp) * 100).toFixed(1) + '%' : '0%');
    
    setTxt('dex-ww-active', dexStats.ww.active);
    setTxt('dex-ww-inactive', dexStats.ww.inactive);
    setTxt('dex-ww-depth', fmt$(dexStats.ww.depth));
    setTxt('dex-ww-tla-pct', totalTlaVp > 0 ? ((dexStats.ww.tlaVp / totalTlaVp) * 100).toFixed(1) + '%' : '0%');
    setTxt('dex-ww-adao-pct', totalAdaoVp > 0 ? ((dexStats.ww.adaoVp / totalAdaoVp) * 100).toFixed(1) + '%' : '0%');

    // === RENDER POOL TABLE ===
    // Sort: by bucket, then Active A-Z, then Inactive A-Z
    let sortedPools = [...store.vote.pools].sort((a, b) => {
        // 1. By bucket order
        let biA = BUCKET_ORDER.indexOf(a.b); if (biA === -1) biA = 99;
        let biB = BUCKET_ORDER.indexOf(b.b); if (biB === -1) biB = 99;
        if (biA !== biB) return biA - biB;
        
        // 2. Active pools first (vps >= 1)
        let aActive = a.vps >= 1 ? 0 : 1;
        let bActive = b.vps >= 1 ? 0 : 1;
        if (aActive !== bActive) return aActive - bActive;
        
        // 3. Alphabetical by name
        return a.n.localeCompare(b.n);
    });

    let finalHtml = '';
    document.querySelectorAll('.adao-col').forEach(el => el.style.display = showADAO ? '' : 'none');

    BUCKET_ORDER.forEach(bucketName => {
        let bucketPools = sortedPools.filter(p => p.b === bucketName);
        if (bucketPools.length === 0) return;

        let bTlaVp = bucketPools.reduce((s, p) => s + p.tvp, 0);
        let bAdaoVp = bucketPools.reduce((s, p) => s + p.mvp, 0);
        let bVoteShare = bucketPools.reduce((s, p) => s + p.vps, 0);
        let bAdaoShare = bucketPools.reduce((s, p) => s + p.ms, 0);
        let bIncentives = bucketPools.reduce((s, p) => s + p.inc, 0);

        finalHtml += `<div class="bg-[#1f2937] border-y border-gray-700 py-1 mt-2 mb-1"><div class="flex justify-between items-center px-2"><span class="text-gray-300 font-bold text-[10px] tracking-widest uppercase">${bucketName}</span></div></div>`;

        bucketPools.forEach(p => {
            let isAct = p.vps >= 1;
            if (p.d.includes('Astro') && !showAstro) return;
            if (p.d.includes('White') && !showWW) return;
            if (!isAct && !showInactive) return;

            let dexColor = p.d.includes('Astro') ? 'text-blue-600' : 'text-green-400';
            let inactiveText = p.vps < 1 ? '<span class="text-red-500 font-bold text-[11px]">INACT</span>' : '';
            
            // 4Ep averages
            let liq4Ep = p.liq4Ep?.avg || 0;
            let vol4Ep = p.vol4Ep?.avg || 0;
            let liq4EpStr = liq4Ep > 0 ? fmt$(liq4Ep) : '-';
            let vol4EpStr = vol4Ep > 0 ? fmt$(vol4Ep) : '-';
            let liq4EpTitle = p.liq4Ep ? `${p.liq4Ep.count} epochs avg` : 'No ext data';
            let vol4EpTitle = p.vol4Ep ? `${p.vol4Ep.count} epochs avg` : 'No ext data';
            
            // Efficiency
            let effStr = p.efficiency > 0 ? p.efficiency.toFixed(2) : '-';
            let effColor = p.efficiency >= 0.3 ? 'text-green-400' : p.efficiency >= 0.1 ? 'text-yellow-400' : 'text-gray-500';
            
            // Access score
            let accStr = p.accessScore ? p.accessScore.toFixed(0) : '-';
            let accColor = p.accessScore >= 70 ? 'text-green-400' : p.accessScore >= 50 ? 'text-cyan-400' : p.accessScore >= 30 ? 'text-yellow-400' : 'text-gray-500';
            let accTitle = p.accessData?.breakdown ? 
                `${p.accessData.breakdown.lunaBenefit.label} | Bridge: ${p.accessData.breakdown.bridge.label}` : 
                'No access data';
            
            // Support score
            let suppStr = p.supportScore?.toFixed(0) || '0';
            let suppColor = p.supportScore >= 60 ? 'text-red-400' : p.supportScore >= 30 ? 'text-yellow-400' : 'text-gray-400';
            
            // aDAO Score
            let scoreStr = p.adaoScore?.toFixed(0) || '0';
            let scoreColor = getScoreColor(p.adaoScore || 0);
            let scoreIcon = getScoreIcon(p.adaoScore || 0);
            
            // APR display (both non and amp)
            let aprNonStr = p.aprNon > 0 ? p.aprNon.toFixed(0) + '%' : '-';
            let aprAmpStr = p.aprAmp > 0 ? p.aprAmp.toFixed(0) + '%' : '';
            let aprColor = p.aprNon < 40 ? 'text-red-400' : p.aprNon < 55 ? 'text-green-400' : p.aprNon < 70 ? 'text-yellow-400' : 'text-orange-400';
            
            let dexShort = p.d.includes('Astro') ? 'Astro' : 'WW';
            
            finalHtml += `
            <div class="vote-grid border-b border-gray-800/50 py-2 hover:bg-white/5 px-2 cursor-pointer" onclick="showPoolScoreDetails('${p.n}', '${dexShort}')">
                <div class="flex flex-col justify-center">
                    <span class="text-white text-[12px] font-bold truncate" title="${p.n}">${p.n}</span>
                    <span class="text-[10px] ${dexColor}">${p.d.includes('Astro') ? 'Astroport' : 'WhiteWhale'}</span>
                </div>
                <div class="text-center text-[11px]">${inactiveText}</div>
                <div class="text-right font-mono text-teal-400 text-[11px]" title="${liq4EpTitle}">${liq4EpStr}</div>
                <div class="text-right font-mono text-teal-400 text-[11px]" title="${vol4EpTitle}">${vol4EpStr}</div>
                <div class="text-right font-mono ${effColor} text-[11px]" title="Vol/Liq ratio">${effStr}</div>
                <div class="text-right flex flex-col leading-tight" title="Non-amp / Amplified APR">
                    <span class="font-mono ${aprColor} text-[11px]">${aprNonStr}</span>
                    ${aprAmpStr ? `<span class="font-mono text-yellow-500 text-[10px]">üî•${aprAmpStr}</span>` : ''}
                </div>
                <div class="text-right font-mono ${accColor} text-[11px]" title="${accTitle}">${accStr}</div>
                <div class="text-right flex flex-col leading-tight" title="Votion Current Epoch">
                    ${p.votNowVp > 0 ? `<span class="text-purple-400 font-mono text-[11px] font-bold">${fmtVp(p.votNowVp)}</span><span class="text-purple-400/70 font-mono text-[10px]">${p.votNowPct.toFixed(2)}%</span>` : '<span class="text-gray-600 text-[11px]">-</span>'}
                </div>
                <div class="text-right flex flex-col leading-tight" title="Votion Next Epoch Optimization">
                    ${p.votNextVp > 0 ? `<span class="text-purple-300 font-mono text-[11px] font-bold">${fmtVp(p.votNextVp)}</span><span class="text-purple-300/70 font-mono text-[10px]">${p.votNextPct.toFixed(2)}%</span>` : '<span class="text-gray-600 text-[11px]">-</span>'}
                </div>
                <div class="text-right flex flex-col leading-tight" title="PD Bribes: ${fmt$(p.incPD)} | Other: ${fmt$(p.incOther)} | Total: ${fmt$(p.incTotal)}">
                    <span class="text-green-400 font-mono text-[11px]">${fmt$(p.incPD)}</span>
                    ${p.incTotal > p.incPD ? `<span class="text-yellow-400 font-mono text-[10px]">Œ£${fmt$(p.incTotal)}</span>` : ''}
                </div>
                <div class="text-right font-mono ${suppColor} text-[11px]" title="Support score">${suppStr}</div>
                <div class="text-right flex flex-col leading-tight">
                    <span class="text-orange-400 font-mono text-[11px] font-bold">${p.tvp.toLocaleString()}</span>
                    <span class="text-orange-400/70 font-mono text-[10px]">${p.vps.toFixed(2)}%</span>
                </div>
                <div class="text-right flex flex-col leading-tight adao-col" style="${showADAO ? '' : 'display:none;'}">
                    ${p.mvp > 0 ? `<span class="text-cyan-400 font-mono text-[11px] font-bold">${p.mvp.toLocaleString()}</span><span class="text-cyan-400/70 font-mono text-[10px]">${p.ms.toFixed(2)}%</span>` : '<span class="text-gray-700 text-[11px]">-</span>'}
                </div>
                <div class="text-right font-mono ${scoreColor} text-[12px] font-bold" title="aDAO Opportunity Score">${scoreIcon}${scoreStr}</div>
            </div>`;
        });

        // Calculate Votion totals for bucket
        let bVotNowVp = bucketPools.reduce((s, p) => s + (p.votNowVp || 0), 0);
        let bVotNowPct = bucketPools.reduce((s, p) => s + (p.votNowPct || 0), 0);
        let bVotNextVp = bucketPools.reduce((s, p) => s + (p.votNextVp || 0), 0);
        let bVotNextPct = bucketPools.reduce((s, p) => s + (p.votNextPct || 0), 0);
        
        // Calculate bucket averages for new metrics
        let poolsWithScores = bucketPools.filter(p => p.adaoScore !== undefined);
        let avgScore = poolsWithScores.length > 0 
            ? poolsWithScores.reduce((s, p) => s + p.adaoScore, 0) / poolsWithScores.length 
            : 0;

        finalHtml += `
        <div class="vote-grid bg-indigo-900/40 border-t border-indigo-800 py-2 px-2 font-bold mt-1">
            <div class="text-[11px] text-gray-400 uppercase tracking-widest">${bucketName} TOTALS</div>
            <div></div>
            <div></div>
            <div></div>
            <div></div>
            <div></div>
            <div></div>
            <div class="text-right flex flex-col leading-tight">
                ${bVotNowVp > 0 ? `<span class="text-purple-300 font-mono text-[10px]">${fmtVp(bVotNowVp)}</span><span class="text-purple-300/70 font-mono text-[9px]">${bVotNowPct.toFixed(1)}%</span>` : '<span class="text-gray-600">-</span>'}
            </div>
            <div class="text-right flex flex-col leading-tight">
                ${bVotNextVp > 0 ? `<span class="text-purple-200 font-mono text-[10px]">${fmtVp(bVotNextVp)}</span><span class="text-purple-200/70 font-mono text-[9px]">${bVotNextPct.toFixed(1)}%</span>` : '<span class="text-gray-600">-</span>'}
            </div>
            <div class="text-right font-mono text-[11px] text-green-400">${fmt$(bIncentives)}</div>
            <div></div>
            <div class="text-right flex flex-col leading-tight">
                <span class="text-orange-300 font-mono text-[11px]">${bTlaVp.toLocaleString()}</span>
                <span class="text-orange-300/70 font-mono text-[10px]">${bVoteShare.toFixed(2)}%</span>
            </div>
            <div class="text-right flex flex-col leading-tight adao-col" style="${showADAO ? '' : 'display:none;'}">
                <span class="text-cyan-300 font-mono text-[11px]">${bAdaoVp.toLocaleString()}</span>
                <span class="text-cyan-300/70 font-mono text-[10px]">${bAdaoShare.toFixed(2)}%</span>
            </div>
            <div class="text-right font-mono text-[11px] ${getScoreColor(avgScore)}">Avg: ${avgScore.toFixed(0)}</div>
        </div>`;
    });

    setHtml('vote-list', finalHtml);
}

function showIncentives(bucketName) {
    setTxt('mod-inc-bucket-title', "Incentives Breakdown (All Buckets)");
    let html = '';
    let totalInc = 0;
    
    BUCKET_ORDER.forEach(bn => {
        let bucketPools = store.vote.pools.filter(p => p.b === bn && p.inc > 0).sort((a, b) => b.inc - a.inc);
        if (bucketPools.length > 0) {
            html += `<div class="text-[9px] font-bold text-gray-500 uppercase border-b border-gray-800 mt-3 mb-1 px-1">${bn}</div>`;
            bucketPools.forEach(p => {
                totalInc += p.inc;
                html += `<div class="grid grid-cols-12 gap-1 border-b border-gray-800 py-1 hover:bg-gray-800/50 px-1">
                    <div class="col-span-5 truncate text-white" title="${p.n}">${p.n}</div>
                    <div class="col-span-2 text-right text-purple-400">-</div>
                    <div class="col-span-2 text-right text-green-400 font-bold">${fmt$(p.inc)}</div>
                    <div class="col-span-3 text-right text-blue-400">${p.apr}</div>
                </div>`;
            });
        }
    });
    
    if (!html) html = '<div class="text-center text-gray-500 py-4">No incentives found.</div>';
    html += `<div class="grid grid-cols-12 gap-1 text-[9px] text-white uppercase font-bold border-t border-gray-700 pt-2 mt-2 bg-gray-900/90 p-2 rounded">
        <div class="col-span-5">TOTAL</div><div class="col-span-2"></div>
        <div class="col-span-2 text-right text-green-400">${fmt$(totalInc)}</div><div class="col-span-3"></div>
    </div>`;

    setHtml('mod-inc-content', html);
    togModal('incentives', 1);
}

function parseVoteRewards() {
    let txt = $('voteRewardsPaste').value;
    let lines = txt.split('\n').map(x => x.trim()).filter(x => x);
    
    store.dao.vRew = {};
    store.dao.vRewPeriods = [];
    
    let skipNext = false; // Skip lines after "Tx fee"
    
    lines.forEach(x => {
        // Skip "Tx fee" section
        if (x.includes('Tx fee')) {
            skipNext = true;
            return;
        }
        if (skipNext && /LUNA/.test(x)) {
            skipNext = false;
            return; // Skip the fee amount line
        }
        skipNext = false;
        
        // Skip headers and buttons
        if (x.includes('Claim') || x.includes('Claiming') || x.includes('participating')) return;
        
        // Parse periods line: "150,151,152,153,154,155,156,157,158,159,160"
        if (/^\d+(,\d+)+$/.test(x)) {
            store.dao.vRewPeriods = x.split(',').map(n => parseInt(n.trim())).filter(n => !isNaN(n));
            return;
        }
        
        // Parse reward lines: "11 891.29 ASTRO" or "0.00013 wBTC.atom" or "15.06M ROAR"
        // Handle spaces in numbers and M/K suffixes
        let m = x.match(/^([\d\s]+\.?\d*)\s*([MKmk])?\s+([a-zA-Z][a-zA-Z0-9\.]+)/);
        if (m) {
            let numStr = m[1].replace(/\s/g, ''); // Remove spaces from number
            let val = parseFloat(numStr);
            let suffix = m[2]?.toUpperCase();
            let token = m[3];
            
            // Handle M/K suffix
            if (suffix === 'M') val *= 1e6;
            if (suffix === 'K') val *= 1e3;
            
            if (!isNaN(val) && val > 0) {
                store.dao.vRew[token] = val;
            }
        }
    });
    
    // Update modal - Periods
    if (store.dao.vRewPeriods.length > 0) {
        let first = Math.min(...store.dao.vRewPeriods);
        let last = Math.max(...store.dao.vRewPeriods);
        let count = store.dao.vRewPeriods.length;
        setTxt('mod-vote-periods', `${first} - ${last}`);
        setTxt('mod-vote-epoch-count', `${count} Epochs`);
    } else {
        setTxt('mod-vote-periods', '-');
        setTxt('mod-vote-epoch-count', '-');
    }
    
    // Update modal - Token list
    let html = Object.entries(store.dao.vRew).map(([token, amount]) => {
        // Format with appropriate decimals (more for small numbers)
        let formatted = amount < 1 ? amount.toFixed(6) : amount.toLocaleString(undefined, {maximumFractionDigits: 2});
        return `<div class="flex justify-between border-b border-gray-800 py-1">
            <span class="text-gray-400">${token}</span>
            <span class="font-mono text-white">${formatted}</span>
        </div>`;
    }).join('');
    setHtml('mod-vote-list', html || '<div class="text-gray-500">No rewards parsed</div>');
    
    setTxt('status-rewards', "PARSED");
    $('status-rewards').className = "text-[9px] text-green-400 font-bold";
    pasteStatus.voteRew = true;
    updatePasteStatus('ps-vote-rew', true);
}

// === LIQUIDITY PARSING ===
function parseLiquidity() {
    let txt = $('liqFullPage').value;
    let isInactive = $('liqInactiveToggle').checked;
    let lines = txt.split('\n').map(l => l.trim());

    if (!isInactive) {
        let m;
        if (m = txt.match(/TVL[\s\n]+([$\d\.\,\s]+[KkMm]?)/i)) store.tla.tvl = parseNum(m[1]);
        if (m = txt.match(/Rewards per year[\s\n]+([$\d\.\,\s]+[KkMm]?)/i)) store.tla.rewYr = parseNum(m[1]);
        if (m = txt.match(/(Your|Total) Deposit[\s\n]*([$\d\.,\s]+)/i)) store.dao.dep = parseNum(m[2]);
        if (m = txt.match(/(est\. APR|Avg APR)[\s\n]*([\d\.]+)\s*%/i)) store.dao.apr = parseFloat(m[2]);
        
        // Parse unclaimed rewards - format: "Rewards\n406.82$" or "Rewards\n$ 406.82"
        if (m = txt.match(/Rewards[\s\n]+([\d\s\.,]+)\s*\$/i)) {
            store.dao.rew.usd = parseNum(m[1]);
        } else if (m = txt.match(/Rewards[\s\n]+\$\s*([\d\s\.,]+)/i)) {
            store.dao.rew.usd = parseNum(m[1]);
        }
    }

    let parsedPools = [];
    lines.forEach((l, i) => {
        // Match DEX line format: "Astroport - pcl" or "WhiteWhale - stable"
        if (l.match(/^(Astroport|WhiteWhale|Single)/i)) {
            let dexParts = l.split('-').map(x => x.trim());
            let dex = dexParts[0];
            let lpType = dexParts[1]?.toLowerCase() || '?';
            
            // Normalize LP type
            if (lpType.includes('pcl')) lpType = 'pcl';
            else if (lpType.includes('stable')) lpType = 'stable';
            else if (lpType.includes('xyk')) lpType = 'xyk';
            else if (lpType.includes('concentrated')) lpType = 'pcl';
            
            let poolName = lines[i-1]?.trim() || '';
            if (!poolName || /^icon/i.test(poolName)) return;
            
            // Normalize pool name for matching
            let normName = normalizeName(poolName.replace(' LP', ''));
            
            // Find bucket from vote data
            let bucket = 'UNKNOWN';
            
            // Single-sided pools go to SINGLE bucket
            if (dex === 'Single' || lpType === 'single') {
                bucket = 'SINGLE';
            } else {
                let votePool = store.vote.pools.find(vp => vp.n === normName && vp.d.includes(dex.substring(0,5)));
                if (votePool) bucket = votePool.b;
            }
            
            let p = { 
                name: poolName, 
                normName: normName,
                dex: dex, 
                type: lpType, 
                bucket: bucket,
                depth: 0, 
                stk: 0, 
                aprNon: 0,      // Non-amplified APR
                aprAmp: 0,      // Amplified APR
                rYr: 0,         // Rewards per year
                adaoNon: 0,     // Non-amp aDAO deposit
                adaoAmp: 0,     // Amplified aDAO deposit
                inactive: isInactive 
            };
            
            let foundDepth = false;
            let foundStk = false;
            let foundRewards = false;
            let adaoDeposits = [];
            
            for (let k = 1; k < 20; k++) {
                if (lines[i+k+1]?.match(/^(Astroport|WhiteWhale|Single)/)) break;
                let nl = lines[i+k];
                if (!nl) continue;
                
                // Depth line
                if (nl.startsWith('Depth')) {
                    p.depth = parseNum(nl);
                    foundDepth = true;
                    continue;
                }
                
                // TLA Staked - first $ after Depth (not Rewards line)
                if (foundDepth && !foundStk && nl.startsWith('$') && !nl.includes('Rewards')) {
                    p.stk = parseNum(nl);
                    foundStk = true;
                    continue;
                }
                
                // APR with % = Non-amplified (e.g., "54.09 %")
                if (foundStk && !foundRewards && nl.match(/^[\d\s\.]+%$/)) {
                    p.aprNon = parseFloat(nl.replace(/[^\d\.]/g, ''));
                    continue;
                }
                
                // APR without % = Amplified (e.g., "70.20" - just a number, possibly with spaces)
                if (foundStk && !foundRewards && nl.match(/^[\d\s\.]+$/) && !nl.startsWith('$')) {
                    let val = parseFloat(nl.replace(/\s/g, ''));
                    if (val > 0 && val < 500) { // Reasonable APR range
                        p.aprAmp = val;
                    }
                    continue;
                }
                
                // Rewards line
                if (nl.startsWith('Rewards')) {
                    p.rYr = parseNum(nl);
                    foundRewards = true;
                    continue;
                }
                
                // aDAO deposits - $ lines after Rewards
                if (foundRewards && nl.match(/^\$\s*[\d\s\.,]+/)) {
                    adaoDeposits.push(parseNum(nl));
                    continue;
                }
                
                // Stop at Deposit/Amplify buttons
                if (nl === 'Deposit' || nl === 'Amplify') break;
            }
            
            // Assign aDAO deposits based on APR types found
            if (adaoDeposits.length > 0) {
                if (p.aprNon > 0 && p.aprAmp > 0) {
                    // Both APR types: first is non-amp, second is amp
                    p.adaoNon = adaoDeposits[0] || 0;
                    p.adaoAmp = adaoDeposits[1] || 0;
                } else if (p.aprNon > 0) {
                    // Only non-amp APR: deposit is non-amp
                    p.adaoNon = adaoDeposits[0] || 0;
                } else if (p.aprAmp > 0) {
                    // Only amp APR: deposit is amp
                    p.adaoAmp = adaoDeposits[0] || 0;
                } else {
                    // Fallback: assume non-amp
                    p.adaoNon = adaoDeposits[0] || 0;
                }
            }
            
            if (p.depth > 0 || p.stk > 0) parsedPools.push(p);
        }
    });
    
    if (isInactive) {
        store.tla.inactivePools = parsedPools;
        pasteStatus.liqInactive = true;
        updatePasteStatus('ps-liq-inactive', true);
    } else {
        store.tla.pools = parsedPools;
        pasteStatus.liqActive = true;
        updatePasteStatus('ps-liq-active', true);
    }
    renderLiquidityTable();
}

function renderLiquidityTable() {
    setTxt('tla-tvl', fmt$(store.tla.tvl));
    setTxt('tla-rew', fmt$(store.tla.rewYr));
    setTxt('tla-rew-ep', fmt$(store.tla.rewYr / 52));
    setTxt('dao-dep', fmt$(store.dao.dep));
    setTxt('dao-apr', store.dao.apr + '%');
    setTxt('dao-usd', fmt$(store.dao.rew.usd || 0));
    
    // Combine all pools
    let allPools = [...store.tla.pools, ...store.tla.inactivePools];
    
    // Separate active and inactive
    let activePools = allPools.filter(p => !p.inactive);
    let inactivePools = allPools.filter(p => p.inactive);
    
    // Calculate DEX stats from active pools only
    let dexStats = {
        astro: { count: 0, depth: 0, stk: 0 },
        ww: { count: 0, depth: 0, stk: 0 }
    };
    
    activePools.forEach(p => {
        if (p.dex.includes('Astro')) {
            dexStats.astro.count++;
            dexStats.astro.depth += p.depth;
            dexStats.astro.stk += p.stk;
        } else if (p.dex.includes('White')) {
            dexStats.ww.count++;
            dexStats.ww.depth += p.depth;
            dexStats.ww.stk += p.stk;
        }
    });
    
    // Update DEX stat displays
    setTxt('liq-astro-active', dexStats.astro.count);
    setTxt('liq-astro-depth', fmt$(dexStats.astro.depth));
    setTxt('liq-astro-stk', fmt$(dexStats.astro.stk));
    setTxt('liq-astro-pct', dexStats.astro.depth > 0 ? ((dexStats.astro.stk / dexStats.astro.depth) * 100).toFixed(1) + '%' : '0%');
    
    setTxt('liq-ww-active', dexStats.ww.count);
    setTxt('liq-ww-depth', fmt$(dexStats.ww.depth));
    setTxt('liq-ww-stk', fmt$(dexStats.ww.stk));
    setTxt('liq-ww-pct', dexStats.ww.depth > 0 ? ((dexStats.ww.stk / dexStats.ww.depth) * 100).toFixed(1) + '%' : '0%');
    
    // Calculate % of TVL for each DEX
    let totalDexStk = dexStats.astro.stk + dexStats.ww.stk;
    setTxt('liq-astro-tvl', totalDexStk > 0 ? ((dexStats.astro.stk / totalDexStk) * 100).toFixed(1) + '%' : '0%');
    setTxt('liq-ww-tvl', totalDexStk > 0 ? ((dexStats.ww.stk / totalDexStk) * 100).toFixed(1) + '%' : '0%');
    
    // Sort active by bucket, then alphabetically
    activePools.sort((a, b) => {
        let biA = BUCKET_ORDER.indexOf(a.bucket); if (biA === -1) biA = 99;
        let biB = BUCKET_ORDER.indexOf(b.bucket); if (biB === -1) biB = 99;
        if (biA !== biB) return biA - biB;
        return a.name.localeCompare(b.name);
    });
    
    // Sort inactive by TLA Deposits (stk) descending
    inactivePools.sort((a, b) => b.stk - a.stk);
    
    let html = '';
    let grandTotals = { depth: 0, stk: 0, rYr: 0, adaoNon: 0, adaoAmp: 0 };
    
    // Render active pools by bucket with subtotals
    let currentBucket = null;
    let bucketPools = [];
    
    const renderBucketSubtotal = (bucket, pools) => {
        let totals = pools.reduce((acc, p) => {
            acc.depth += p.depth;
            acc.stk += p.stk;
            acc.rYr += p.rYr;
            acc.adaoNon += p.adaoNon || 0;
            acc.adaoAmp += p.adaoAmp || 0;
            return acc;
        }, { depth: 0, stk: 0, rYr: 0, adaoNon: 0, adaoAmp: 0 });
        
        let tlaPct = totals.depth > 0 ? ((totals.stk / totals.depth) * 100) : 0;
        
        // Add to grand totals
        grandTotals.depth += totals.depth;
        grandTotals.stk += totals.stk;
        grandTotals.rYr += totals.rYr;
        grandTotals.adaoNon += totals.adaoNon;
        grandTotals.adaoAmp += totals.adaoAmp;
        
        return `<div class="liq-grid bg-gray-800/60 border-t border-gray-600 py-1.5 px-2">
            <div class="text-[11px] text-gray-400 font-bold">${bucket} Total</div>
            <div></div><div></div>
            <div class="text-right font-mono text-[11px] text-gray-300">${fmt$(totals.depth)}</div>
            <div class="text-right font-mono text-[11px] text-orange-300">${fmt$(totals.stk)}</div>
            <div class="text-right font-mono text-[11px] text-orange-200">${tlaPct.toFixed(1)}%</div>
            <div></div><div></div>
            <div class="text-right font-mono text-[11px] text-green-300">${fmt$(totals.rYr)}</div>
            <div class="text-right font-mono text-[11px] text-green-300">${fmt$(totals.rYr / 52)}</div>
            <div class="text-right font-mono text-[11px] text-cyan-300">${totals.adaoNon > 0 ? fmt$(totals.adaoNon) : '-'}</div>
            <div class="text-right font-mono text-[11px] text-yellow-300">${totals.adaoAmp > 0 ? fmt$(totals.adaoAmp) : '-'}</div>
        </div>`;
    };
    
    activePools.forEach((p, idx) => {
        // New bucket - render previous bucket's subtotal first
        if (p.bucket !== currentBucket) {
            if (currentBucket && bucketPools.length > 0) {
                html += renderBucketSubtotal(currentBucket, bucketPools);
            }
            currentBucket = p.bucket;
            bucketPools = [];
            
            html += `<div class="bg-[#1f2937] border-y border-gray-700 py-1 mt-2 mb-1">
                <div class="flex justify-between items-center px-2">
                    <span class="text-gray-300 font-bold text-[10px] tracking-widest uppercase">${currentBucket}</span>
                </div>
            </div>`;
        }
        
        bucketPools.push(p);
        
        let dexColor = p.dex.includes('Astro') ? 'text-blue-500' : (p.dex === 'Single' ? 'text-purple-400' : 'text-green-400');
        let tlaDepthPct = p.depth > 0 ? ((p.stk / p.depth) * 100) : 0;
        
        html += `<div class="liq-grid border-b border-gray-800/50 py-1.5 hover:bg-white/5 px-2">
            <div class="flex flex-col justify-center">
                <span class="text-white text-[12px] font-bold truncate" title="${p.name}">${p.normName || p.name}</span>
            </div>
            <div class="text-center text-[11px] ${dexColor}">${p.dex === 'Single' ? 'Single' : p.dex.includes('Astro') ? 'Astroport' : 'WhiteWhale'}</div>
            <div class="text-center text-[11px] text-gray-500">${p.type}</div>
            <div class="text-right font-mono text-[11px] text-gray-400">${fmt$(p.depth)}</div>
            <div class="text-right font-mono text-[11px] text-orange-400">${fmt$(p.stk)}</div>
            <div class="text-right font-mono text-[11px] text-orange-300">${tlaDepthPct > 0 ? tlaDepthPct.toFixed(1) + '%' : '-'}</div>
            <div class="text-right font-mono text-[11px] text-green-400">${p.aprNon > 0 ? p.aprNon.toFixed(1) + '%' : '-'}</div>
            <div class="text-right font-mono text-[11px] text-yellow-400">${p.aprAmp > 0 ? p.aprAmp.toFixed(1) + '%' : '-'}</div>
            <div class="text-right font-mono text-[11px] text-green-400">${fmt$(p.rYr)}</div>
            <div class="text-right font-mono text-[11px] text-green-400">${fmt$(p.rYr / 52)}</div>
            <div class="text-right font-mono text-[11px] text-cyan-400">${p.adaoNon > 0 ? fmt$(p.adaoNon) : '-'}</div>
            <div class="text-right font-mono text-[11px] text-yellow-400">${p.adaoAmp > 0 ? fmt$(p.adaoAmp) : '-'}</div>
        </div>`;
    });
    
    // Last bucket subtotal
    if (currentBucket && bucketPools.length > 0) {
        html += renderBucketSubtotal(currentBucket, bucketPools);
    }
    
    // Render inactive pools at bottom
    if (inactivePools.length > 0) {
        html += `<div class="bg-red-900/30 border-y border-red-900/50 py-1 mt-4 mb-1">
            <div class="flex justify-between items-center px-2">
                <span class="text-red-400 font-bold text-[10px] tracking-widest uppercase">INACTIVE POOLS (${inactivePools.length})</span>
                <span class="text-[9px] text-gray-500">Sorted by TLA Deposits</span>
            </div>
        </div>`;
        
        let inactiveTotals = { depth: 0, stk: 0, rYr: 0, adaoNon: 0, adaoAmp: 0 };
        
        inactivePools.forEach(p => {
            let dexColor = p.dex.includes('Astro') ? 'text-blue-500' : (p.dex === 'Single' ? 'text-purple-400' : 'text-green-400');
            let tlaDepthPct = p.depth > 0 ? ((p.stk / p.depth) * 100) : 0;
            
            inactiveTotals.depth += p.depth;
            inactiveTotals.stk += p.stk;
            inactiveTotals.rYr += p.rYr;
            inactiveTotals.adaoNon += p.adaoNon || 0;
            inactiveTotals.adaoAmp += p.adaoAmp || 0;
            
            html += `<div class="liq-grid border-b border-gray-800/50 py-1.5 hover:bg-white/5 px-2 opacity-60">
                <div class="flex flex-col justify-center">
                    <span class="text-white text-[11px] font-bold truncate" title="${p.name}">${p.normName || p.name}</span>
                    <span class="text-gray-600 text-[9px]">${p.bucket}</span>
                </div>
                <div class="text-center text-[10px] ${dexColor}">${p.dex === 'Single' ? 'Single' : p.dex.includes('Astro') ? 'Astro' : 'WW'}</div>
                <div class="text-center text-[10px] text-gray-500">${p.type}</div>
                <div class="text-right font-mono text-[10px] text-gray-400">${fmt$(p.depth)}</div>
                <div class="text-right font-mono text-[10px] text-orange-400">${fmt$(p.stk)}</div>
                <div class="text-right font-mono text-[10px] text-orange-300">${tlaDepthPct > 0 ? tlaDepthPct.toFixed(1) + '%' : '-'}</div>
                <div class="text-right font-mono text-[10px] text-green-400">${p.aprNon > 0 ? p.aprNon.toFixed(1) + '%' : '-'}</div>
                <div class="text-right font-mono text-[10px] text-yellow-400">${p.aprAmp > 0 ? p.aprAmp.toFixed(1) + '%' : '-'}</div>
                <div class="text-right font-mono text-[10px] text-green-400">${fmt$(p.rYr)}</div>
                <div class="text-right font-mono text-[10px] text-green-400">${fmt$(p.rYr / 52)}</div>
                <div class="text-right font-mono text-[10px] text-cyan-400">${p.adaoNon > 0 ? fmt$(p.adaoNon) : '-'}</div>
                <div class="text-right font-mono text-[10px] text-yellow-400">${p.adaoAmp > 0 ? fmt$(p.adaoAmp) : '-'}</div>
            </div>`;
        });
        
        // Inactive subtotal
        let inactivePct = inactiveTotals.depth > 0 ? ((inactiveTotals.stk / inactiveTotals.depth) * 100) : 0;
        html += `<div class="liq-grid bg-red-900/30 border-t border-red-800 py-1.5 px-2">
            <div class="text-[11px] text-red-300 font-bold">Inactive Total</div>
            <div></div><div></div>
            <div class="text-right font-mono text-[11px] text-gray-400">${fmt$(inactiveTotals.depth)}</div>
            <div class="text-right font-mono text-[11px] text-orange-300">${fmt$(inactiveTotals.stk)}</div>
            <div class="text-right font-mono text-[11px] text-orange-200">${inactivePct.toFixed(1)}%</div>
            <div></div><div></div>
            <div class="text-right font-mono text-[11px] text-green-300">${fmt$(inactiveTotals.rYr)}</div>
            <div class="text-right font-mono text-[11px] text-green-300">${fmt$(inactiveTotals.rYr / 52)}</div>
            <div class="text-right font-mono text-[11px] text-cyan-300">${inactiveTotals.adaoNon > 0 ? fmt$(inactiveTotals.adaoNon) : '-'}</div>
            <div class="text-right font-mono text-[11px] text-yellow-300">${inactiveTotals.adaoAmp > 0 ? fmt$(inactiveTotals.adaoAmp) : '-'}</div>
        </div>`;
        
        // Add inactive to grand totals
        grandTotals.depth += inactiveTotals.depth;
        grandTotals.stk += inactiveTotals.stk;
        grandTotals.rYr += inactiveTotals.rYr;
        grandTotals.adaoNon += inactiveTotals.adaoNon;
        grandTotals.adaoAmp += inactiveTotals.adaoAmp;
    }
    
    // Grand Total
    let grandPct = grandTotals.depth > 0 ? ((grandTotals.stk / grandTotals.depth) * 100) : 0;
    html += `<div class="liq-grid bg-indigo-900/50 border-t-2 border-indigo-500 py-2 px-2 mt-3">
        <div class="text-[12px] text-white font-bold uppercase">Grand Total</div>
        <div></div><div></div>
        <div class="text-right font-mono text-[12px] text-white font-bold">${fmt$(grandTotals.depth)}</div>
        <div class="text-right font-mono text-[12px] text-orange-400 font-bold">${fmt$(grandTotals.stk)}</div>
        <div class="text-right font-mono text-[12px] text-orange-300 font-bold">${grandPct.toFixed(1)}%</div>
        <div></div><div></div>
        <div class="text-right font-mono text-[12px] text-green-400 font-bold">${fmt$(grandTotals.rYr)}</div>
        <div class="text-right font-mono text-[12px] text-green-400 font-bold">${fmt$(grandTotals.rYr / 52)}</div>
        <div class="text-right font-mono text-[12px] text-cyan-400 font-bold">${grandTotals.adaoNon > 0 ? fmt$(grandTotals.adaoNon) : '-'}</div>
        <div class="text-right font-mono text-[12px] text-yellow-400 font-bold">${grandTotals.adaoAmp > 0 ? fmt$(grandTotals.adaoAmp) : '-'}</div>
    </div>`;
    
    setHtml('liq-list', html || '<div class="text-gray-500 text-center py-4">No pools parsed. Parse Vote tab first for bucket assignments.</div>');
}

function parseDeposits() {
    let raw = $('liqDeposits').value.trim();
    store.dao.toks = raw.split('\n').map(l => {
        let p = l.trim().split(/\s+/);
        if (p.length < 2) return null;
        let val = parseFloat(p[0]);
        return isNaN(val) ? { s: p[0], a: parseNum(p[1]) } : { s: p[1], a: parseNum(p[0]) };
    }).filter(x => x);
    
    setHtml('mod-tok-list', store.dao.toks.map(t => 
        `<div class="flex justify-between border-b border-gray-800"><span class="text-gray-400">${t.s}</span><span class="font-mono">${t.a.toLocaleString()}</span></div>`
    ).join(''));
    
    pasteStatus.liqDep = true;
    updatePasteStatus('ps-liq-dep', true);
}

function parseRewards() {
    let txt = $('liqRewards').value;
    let zMatch = txt.match(/zAssets\s*([\d\s\.,]+)/); if (zMatch) store.dao.rew.z = parseNum(zMatch[1]);
    let ampMatch = txt.match(/Received\s*([\d\s\.,]+)\s*ampLUNA/); if (ampMatch) store.dao.rew.amp = parseNum(ampMatch[1]);
    setTxt('dao-rew-z', store.dao.rew.z.toLocaleString());
    setTxt('dao-rew-amp', store.dao.rew.amp.toLocaleString());
    
    pasteStatus.liqRew = true;
    updatePasteStatus('ps-liq-rew', true);
}

// === LOCKS PARSING ===
function parseLocks() {
    let t = $('locksPaste').value;
    
    // Parse VP - handle spaces in numbers
    let vpMatch = t.match(/Your Voting Power\s*([\d\.\s,KkMm]+)\s*VP/);
    if (vpMatch) store.dao.lVp = parseNum(vpMatch[1]);
    
    // Parse factor & assets
    let facMatch = t.match(/Power Factor\s*([\d\.]+)\s*x/i);
    if (facMatch) store.dao.lFac = parseFloat(facMatch[1]);
    
    // Parse underlying assets - handle ~63.88K__LUNA__ format
    let astMatch = t.match(/Underlying Assets\s*~?([\d\.\s,KkMm]+)/i);
    if (astMatch) store.dao.lAst = parseNum(astMatch[1]);
    
    store.dao.locks = [];
    let chunks = t.split(/Lock #/i);
    for (let i = 1; i < chunks.length; i++) {
        let c = chunks[i];
        let idMatch = c.match(/^(\d+)/);
        if (!idMatch) continue;
        
        let id = idMatch[1];
        let amtMatch = c.match(/([\d\.\s,]+[KkMm]?)\s+(arbLUNA|ampLUNA|bLUNA|LUNA)/);
        let amt = amtMatch ? parseNum(amtMatch[1]) : 0;
        let asset = amtMatch ? amtMatch[2] : 'Unknown';
        
        // Determine bucket from asset type
        let bucket = 'LUNA';
        if (asset === 'arbLUNA') bucket = 'arbLUNA';
        else if (asset === 'ampLUNA') bucket = 'ampLUNA';
        else if (asset === 'bLUNA') bucket = 'bLUNA';
        
        let vpMatchC = c.match(/([\d\.\s,]+[KkMm]?)\s*VP/);
        let vp = vpMatchC ? parseNum(vpMatchC[1]) : 0;
        
        // Handle European number format: $ 4 968.73 (spaces in numbers)
        let usdMatch = c.match(/\$\s*([\d\s,\.]+)/);
        let usd = usdMatch ? parseNum(usdMatch[1]) : 0;
        
        let status = c.toLowerCase().includes('auto max-lock') ? "Max Lock (Auto)" : "Manual";
        store.dao.locks.push({ id, amt, asset, bucket, vp, usd, status });
    }
    
    pasteStatus.locks = true;
    updatePasteStatus('ps-locks', true);
    renderLocks();
}

function renderLocks() {
    // Update header stats
    setTxt('locks-vp', store.dao.lVp.toLocaleString() + ' VP');
    setTxt('locks-factor', store.dao.lFac ? store.dao.lFac.toFixed(2) + 'x' : '-');
    setTxt('locks-assets', store.dao.lAst ? store.dao.lAst.toLocaleString() + ' LUNA' : '-');
    
    // Group locks by bucket
    const LOCK_BUCKETS = ['arbLUNA', 'ampLUNA', 'bLUNA', 'LUNA'];
    let html = '';
    let grandTotals = { amt: 0, usd: 0, vp: 0 };
    
    LOCK_BUCKETS.forEach(bucket => {
        let bucketLocks = store.dao.locks.filter(l => l.bucket === bucket);
        if (bucketLocks.length === 0) return;
        
        // Bucket header
        let bucketColor = bucket === 'arbLUNA' ? 'text-orange-400' : 
                          bucket === 'ampLUNA' ? 'text-cyan-400' : 
                          bucket === 'bLUNA' ? 'text-green-400' : 'text-purple-400';
        
        html += `<div class="bg-[#1f2937] border-y border-gray-700 py-1 mt-2 mb-1">
            <div class="px-2">
                <span class="${bucketColor} font-bold text-[10px] tracking-widest uppercase">${bucket}</span>
                <span class="text-gray-500 text-[9px] ml-2">(${bucketLocks.length} lock${bucketLocks.length > 1 ? 's' : ''})</span>
            </div>
        </div>`;
        
        let bucketTotals = { amt: 0, usd: 0, vp: 0 };
        
        bucketLocks.forEach(l => {
            bucketTotals.amt += l.amt;
            bucketTotals.usd += l.usd;
            bucketTotals.vp += l.vp;
            
            html += `<div class="grid grid-cols-12 gap-2 text-[10px] border-b border-gray-800/50 py-1 hover:bg-white/5 px-1">
                <div class="col-span-1 text-purple-400 font-bold">#${l.id}</div>
                <div class="col-span-2 text-gray-500 text-[9px]">${l.status}</div>
                <div class="col-span-3 text-white font-mono">${l.amt.toLocaleString()} <span class="${bucketColor}">${l.asset}</span></div>
                <div class="col-span-3 text-right text-green-400 font-mono">${fmt$(l.usd)}</div>
                <div class="col-span-3 text-right text-white font-bold font-mono">${l.vp.toLocaleString()} VP</div>
            </div>`;
        });
        
        // Bucket subtotal
        html += `<div class="grid grid-cols-12 gap-2 text-[9px] bg-gray-800/50 py-1 px-1 border-t border-gray-600">
            <div class="col-span-3 text-gray-400 font-bold">${bucket} Total</div>
            <div class="col-span-3 text-gray-300 font-mono">${bucketTotals.amt.toLocaleString()}</div>
            <div class="col-span-3 text-right text-green-300 font-mono">${fmt$(bucketTotals.usd)}</div>
            <div class="col-span-3 text-right text-gray-300 font-bold font-mono">${bucketTotals.vp.toLocaleString()} VP</div>
        </div>`;
        
        grandTotals.amt += bucketTotals.amt;
        grandTotals.usd += bucketTotals.usd;
        grandTotals.vp += bucketTotals.vp;
    });
    
    // Grand total
    if (store.dao.locks.length > 0) {
        html += `<div class="grid grid-cols-12 gap-2 text-[10px] bg-indigo-900/50 py-2 px-1 mt-3 border-t-2 border-indigo-500">
            <div class="col-span-6 text-white font-bold uppercase">Grand Total</div>
            <div class="col-span-3 text-right text-green-400 font-mono font-bold">${fmt$(grandTotals.usd)}</div>
            <div class="col-span-3 text-right text-white font-bold font-mono">${grandTotals.vp.toLocaleString()} VP</div>
        </div>`;
    }
    
    setHtml('locks-list', html || '<div class="text-center text-gray-600 italic text-xs pt-10">No locks parsed yet...</div>');
}

// === GLOBAL ACTIONS ===
function clearAll() {
    if (confirm("Clear all data?")) location.reload();
}

function copyCoreJson() {
    alert("Copy JSON - TODO");
}

function downloadCoreJson() {
    alert("Download JSON - TODO");
}


</script>
</body>
</html>
