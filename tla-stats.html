<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Terra Liquidity Alliance Tracker | Alliance DAO</title>
    
    <!-- Favicons (hosted in aDAO-Image-Files repo) -->
    <link rel="icon" type="image/x-icon" href="https://raw.githubusercontent.com/defipatriot/aDAO-Image-Files/main/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="https://raw.githubusercontent.com/defipatriot/aDAO-Image-Files/main/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://raw.githubusercontent.com/defipatriot/aDAO-Image-Files/main/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="https://raw.githubusercontent.com/defipatriot/aDAO-Image-Files/main/apple-touch-icon.png">
    <link rel="manifest" href="/site.webmanifest">
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="Track Terra Liquidity Alliance pools, votes, bribes, and APR. Data-driven analytics by Alliance DAO.">
    <meta name="keywords" content="Terra, TLA, Liquidity Alliance, Alliance DAO, DeFi, Astroport, Skeleton Swap, LUNA">
    <meta property="og:title" content="Terra Liquidity Alliance Tracker | Alliance DAO">
    <meta property="og:description" content="Track TLA pools, votes, bribes, and APR with data-driven analytics.">
    <meta property="og:image" content="https://raw.githubusercontent.com/defipatriot/aDAO-Image-Files/main/android-chrome-512x512.png">
    <meta property="og:type" content="website">
    <meta name="twitter:card" content="summary">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { font-family: 'Outfit', sans-serif; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        
        :root {
            --bg-deep: #0a0b0f;
            --bg-card: rgba(15, 17, 23, 0.8);
            --glass: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 255, 255, 0.08);
            --accent-cyan: #06b6d4;
            --accent-purple: #a855f7;
            --accent-green: #10b981;
            --accent-orange: #f59e0b;
            --accent-blue: #3b82f6;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #475569;
        }
        
        body {
            background: var(--bg-deep);
            min-height: 100vh;
            color: var(--text-primary);
        }
        
        /* Desktop readability improvements */
        @media (min-width: 1400px) {
            html {
                font-size: 19px; /* Bump up base font size on large screens */
            }
        }
        
        @media (min-width: 1800px) {
            html {
                font-size: 21px; /* Even larger on very wide screens */
            }
        }
        
        @media (min-width: 2200px) {
            html {
                font-size: 23px; /* Extra large screens */
            }
        }
        
        /* Wider container on large screens */
        .max-w-7xl {
            max-width: 1400px !important;
        }
        
        @media (min-width: 1600px) {
            .max-w-7xl {
                max-width: 1550px !important;
            }
        }
        
        @media (min-width: 1920px) {
            .max-w-7xl {
                max-width: 1750px !important;
            }
        }
        
        @media (min-width: 2200px) {
            .max-w-7xl {
                max-width: 2000px !important;
            }
        }
        
        /* Animated gradient background */
        .bg-mesh {
            position: fixed;
            inset: 0;
            z-index: -1;
            background: 
                radial-gradient(ellipse 80% 50% at 20% 40%, rgba(6, 182, 212, 0.12), transparent),
                radial-gradient(ellipse 60% 40% at 80% 60%, rgba(168, 85, 247, 0.08), transparent),
                radial-gradient(ellipse 50% 30% at 50% 80%, rgba(16, 185, 129, 0.06), transparent);
            animation: meshMove 25s ease-in-out infinite;
        }
        
        @keyframes meshMove {
            0%, 100% { transform: scale(1) rotate(0deg); }
            50% { transform: scale(1.05) rotate(1deg); }
        }
        
        /* Glass cards */
        .glass-card {
            background: var(--glass);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            transition: all 0.3s ease;
        }
        
        .glass-card:hover {
            border-color: rgba(255, 255, 255, 0.12);
        }
        
        /* Tab styling */
        .tab-btn {
            position: relative;
            padding: 12px 24px;
            color: var(--text-secondary);
            font-weight: 500;
            transition: all 0.3s ease;
            cursor: pointer;
            border-radius: 8px 8px 0 0;
        }
        
        .tab-btn::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--accent-cyan), var(--accent-purple));
            transition: all 0.3s ease;
            transform: translateX(-50%);
        }
        
        .tab-btn:hover {
            color: var(--text-primary);
            background: rgba(255,255,255,0.03);
        }
        
        .tab-btn.active {
            color: var(--text-primary);
            background: rgba(255,255,255,0.05);
        }
        
        .tab-btn.active::after {
            width: 60%;
        }
        
        /* Pool cards */
        .pool-card {
            background: rgba(15, 17, 23, 0.6);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 16px;
            transition: all 0.3s ease;
        }
        
        .pool-card:hover {
            background: rgba(20, 24, 32, 0.8);
            border-color: rgba(6, 182, 212, 0.3);
            transform: translateY(-2px);
        }
        
        /* Score badges */
        .score-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .score-high { background: rgba(16, 185, 129, 0.2); color: #34d399; }
        .score-mid { background: rgba(245, 158, 11, 0.2); color: #fbbf24; }
        .score-low { background: rgba(239, 68, 68, 0.2); color: #f87171; }
        
        /* Rank badges */
        .rank-1 { background: linear-gradient(135deg, #fbbf24, #f59e0b); color: #0a0b0f; }
        .rank-2 { background: linear-gradient(135deg, #94a3b8, #64748b); color: #0a0b0f; }
        .rank-3 { background: linear-gradient(135deg, #c2885c, #a1693b); color: #0a0b0f; }
        
        /* Stat boxes */
        .stat-box {
            text-align: center;
            padding: 20px 16px;
        }
        
        .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .stat-value-sm {
            font-size: 1.25rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .stat-label {
            font-size: 0.7rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 4px;
        }
        
        /* Chart container */
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        
        @media (min-width: 1400px) {
            .chart-container {
                height: 340px;
            }
        }
        
        @media (min-width: 1800px) {
            .chart-container {
                height: 380px;
            }
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--text-muted); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-secondary); }
        
        /* Loading animation */
        .loading-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Bucket colors */
        .bucket-stable { border-left: 3px solid #10b981; }
        .bucket-project { border-left: 3px solid #f59e0b; }
        .bucket-bluechip { border-left: 3px solid #3b82f6; }
        .bucket-single { border-left: 3px solid #a855f7; }
        .bucket-unknown { border-left: 3px solid #64748b; }
        
        /* Tab content */
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Dex badges */
        .dex-astro { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }
        .dex-ww { background: rgba(16, 185, 129, 0.2); color: #34d399; }
        
        /* Votion bucket filter buttons */
        .votion-bucket-btn {
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }
        .votion-bucket-btn:hover {
            border-color: rgba(255,255,255,0.1);
        }
        .votion-bucket-btn.active {
            background: rgba(255,255,255,0.1) !important;
            color: white !important;
        }
        
        /* Waterfall chart */
        .waterfall-row {
            position: relative;
            background: rgba(255,255,255,0.02);
            border-radius: 4px;
            margin-bottom: 2px;
        }
        .waterfall-row:hover {
            background: rgba(255,255,255,0.05);
        }
        
        /* Progress bars */
        .progress-bar {
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-cyan), var(--accent-purple));
            border-radius: 3px;
            transition: width 0.5s ease;
        }
        
        /* Table styles */
        .data-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }
        
        .data-table th {
            text-align: left;
            padding: 12px 16px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--glass-border);
            position: sticky;
            top: 0;
            background: rgba(10, 11, 15, 0.95);
            backdrop-filter: blur(10px);
            cursor: help;
        }
        
        .data-table th[title]:hover {
            color: var(--accent-cyan);
        }
        
        .data-table th.sortable {
            cursor: pointer;
            user-select: none;
            transition: all 0.15s ease;
        }
        
        .data-table th.sortable:hover {
            background: rgba(255,255,255,0.05);
        }
        
        .data-table th.sortable.active {
            color: var(--accent-cyan);
        }
        
        .data-table td {
            padding: 12px 16px;
            border-bottom: 1px solid rgba(255,255,255,0.03);
            font-size: 14px;
        }
        
        .data-table tbody tr:hover {
            background: rgba(255,255,255,0.02);
        }
        
        /* Epoch selector */
        .epoch-select {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 8px 12px;
            color: white;
            font-size: 13px;
            cursor: pointer;
        }
        
        .epoch-select:focus {
            outline: none;
            border-color: var(--accent-cyan);
        }
        
        .epoch-select option {
            background: #1a1b23;
            color: white;
            padding: 8px;
        }
            border: 1px solid var(--glass-border);
            color: var(--text-primary);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
        }
        
        .epoch-select:focus {
            outline: none;
            border-color: var(--accent-cyan);
        }
        
        /* Info tooltip */
        .info-tip {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: rgba(255,255,255,0.1);
            font-size: 10px;
            color: var(--text-secondary);
            cursor: help;
            margin-left: 4px;
        }
        
        /* Active indicator */
        .active-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }
        .active-dot.on { background: #10b981; }
        .active-dot.off { background: #475569; }
        
        /* Desktop readability - larger text on big screens */
        @media (min-width: 1400px) {
            /* Increase small text sizes */
            .text-xs { font-size: 0.9rem !important; }
            .text-sm { font-size: 1rem !important; }
            .text-\[10px\] { font-size: 13px !important; }
            .text-\[11px\] { font-size: 14px !important; }
            .text-\[9px\] { font-size: 12px !important; }
            
            /* Larger stat values */
            .stat-value { font-size: 2.1rem !important; }
            .stat-label { font-size: 0.85rem !important; }
            
            /* Table improvements */
            table th, table td { 
                padding: 14px 12px !important; 
                font-size: 0.95rem !important;
            }
            
            /* Card padding */
            .glass-card { padding: 1.5rem !important; }
        }
        
        @media (min-width: 1800px) {
            .text-xs { font-size: 0.95rem !important; }
            .text-sm { font-size: 1.05rem !important; }
            .text-\[10px\] { font-size: 14px !important; }
            .text-\[11px\] { font-size: 15px !important; }
            .text-\[9px\] { font-size: 13px !important; }
            
            .stat-value { font-size: 2.4rem !important; }
            
            table th, table td { 
                padding: 16px 14px !important;
                font-size: 1rem !important;
            }
            
            .glass-card { padding: 1.75rem !important; }
        }
        
        @media (min-width: 2200px) {
            .text-xs { font-size: 1rem !important; }
            .text-sm { font-size: 1.1rem !important; }
            .text-\[10px\] { font-size: 15px !important; }
            .text-\[11px\] { font-size: 16px !important; }
            
            .stat-value { font-size: 2.6rem !important; }
            
            table th, table td { 
                padding: 18px 16px !important;
                font-size: 1.05rem !important;
            }
            
            .glass-card { padding: 2rem !important; }
        }
        
        /* Docs Tab Styles */
        .docs-card .docs-header {
            user-select: none;
        }
        
        .docs-card .docs-header:hover {
            opacity: 0.8;
        }
        
        .docs-card .fa-chevron-down {
            transition: transform 0.3s ease;
        }
        
        .docs-expanded {
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Smooth scrolling for docs */
        html {
            scroll-behavior: smooth;
        }
        
        /* Docs section anchor offset */
        #docs-basics, #docs-glossary, #docs-scores, #docs-access, #docs-ecosystem, #docs-faq {
            scroll-margin-top: 100px;
        }
    </style>
</head>
<body>
    <div class="bg-mesh"></div>
    
    <!-- Header -->
    <header class="sticky top-0 z-50 backdrop-blur-xl bg-[#0a0b0f]/80 border-b border-white/5">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between flex-wrap gap-4">
                <div class="flex items-center gap-3">
                    <a href="https://www.thealliancedao.com/" title="Back to aDAO Dashboard" class="hover:opacity-80 transition-opacity flex flex-col items-center">
                        <img src="https://raw.githubusercontent.com/defipatriot/aDAO-Image-Files/main/aDAO%20Logo%20No%20Background.png" 
                             alt="Alliance DAO" 
                             class="h-10 min-h-[40px] object-contain">
                        <span class="text-[9px] text-gray-500 hover:text-cyan-400 mt-0.5"><i class="fas fa-arrow-left mr-1"></i>Dashboard</span>
                    </a>
                    <div>
                        <h1 class="text-xl font-bold">Terra Liquidity Alliance Tracker</h1>
                        <p class="text-xs text-gray-500">
                            by <span class="text-cyan-400">The Alliance DAO</span>
                            <span class="mx-1">•</span>
                            <a href="https://www.erisprotocol.com/terra/liquidity-hub?tab=liquidity" target="_blank" class="text-purple-400 hover:text-purple-300 hover:underline">
                                <i class="fas fa-external-link-alt text-[9px] mr-1"></i>Eris TLA
                            </a>
                        </p>
                    </div>
                </div>
                <div class="flex items-center gap-4 flex-wrap">
                    <div class="flex items-center gap-2">
                        <label class="text-xs text-gray-500">Epoch:</label>
                        <select id="epoch-select" class="epoch-select">
                            <option value="latest">Latest</option>
                        </select>
                        <select id="phase-select" class="epoch-select">
                            <option value="end">End</option>
                            <option value="mid">Mid</option>
                            <option value="start">Start</option>
                        </select>
                    </div>
                    <div class="h-8 w-px bg-white/10 hidden md:block"></div>
                    <div class="text-center">
                        <div class="text-xs text-gray-500">Live Epoch</div>
                        <div id="live-epoch" class="text-lg font-bold mono text-cyan-400">-</div>
                    </div>
                    <div class="h-8 w-px bg-white/10 hidden md:block"></div>
                    <div class="text-center">
                        <div class="text-xs text-gray-500">Epoch Ends In</div>
                        <div id="epoch-countdown" class="text-sm font-bold mono text-amber-400">-</div>
                    </div>
                    <div class="h-8 w-px bg-white/10 hidden md:block"></div>
                    <div class="text-center">
                        <div id="load-status" class="text-xs text-gray-500">
                            <i class="fas fa-circle-notch fa-spin mr-1"></i> Loading...
                        </div>
                        <!-- Historical Data Notice - now under snapshot info -->
                        <div id="data-notice" class="hidden mt-1 px-2 py-1 bg-amber-500/10 border border-amber-500/30 rounded text-[10px] text-amber-400">
                            <span id="data-notice-text">Viewing historical data</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>
    
    <!-- Stats Bar -->
    <section class="max-w-7xl mx-auto px-4 py-6">
        <div class="glass-card grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 divide-x divide-white/5">
            <div class="stat-box">
                <div class="stat-label">Astroport Pools</div>
                <div id="stat-astro-pools" class="stat-value mono">-</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Skeleton Swap Pools</div>
                <div id="stat-ww-pools" class="stat-value mono">-</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Epoch Rewards</div>
                <div id="stat-epoch-rewards" class="stat-value-sm mono">-</div>
                <div id="stat-epoch-rewards-sub" class="text-[10px] text-gray-500 mt-0.5">-</div>
            </div>
            <div class="stat-box cursor-pointer hover:bg-white/5 transition-colors rounded-lg" id="bribes-stat-box" onclick="showBribesModal()">
                <div class="stat-label">Epoch Bribes <i class="fas fa-info-circle text-gray-500 text-xs ml-1"></i></div>
                <div id="stat-total-bribes" class="stat-value mono">-</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Avg APR (Non-Amp)</div>
                <div id="stat-avg-apr-non" class="stat-value mono">-</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Avg APR (Amplified)</div>
                <div id="stat-avg-apr-amp" class="stat-value mono">-</div>
            </div>
        </div>
    </section>
    
    <!-- Tabs -->
    <nav class="max-w-7xl mx-auto px-4">
        <div class="flex gap-1 border-b border-white/10 overflow-x-auto">
            <div class="tab-btn active" data-tab="overview">
                <i class="fas fa-chart-pie mr-2"></i>Overview
            </div>
            <div class="tab-btn" data-tab="pools">
                <i class="fas fa-water mr-2"></i>Pools
            </div>
            <div class="tab-btn" data-tab="tla">
                <i class="fas fa-coins mr-2"></i>TLA Liquidity
            </div>
            <div class="tab-btn" data-tab="rankings">
                <i class="fas fa-trophy mr-2"></i>Rankings
            </div>
            <div class="tab-btn" data-tab="dao">
                <i class="fas fa-landmark mr-2"></i>aDAO
            </div>
            <div class="tab-btn" data-tab="docs">
                <i class="fas fa-book mr-2"></i>Docs
            </div>
        </div>
    </nav>
    
    <!-- Tab Content -->
    <main class="max-w-7xl mx-auto px-4 py-6">
        
        <!-- OVERVIEW TAB -->
        <div id="tab-overview" class="tab-content active">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- TLA Total VP Chart -->
                <div class="glass-card p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-semibold text-lg">TLA Total VP</h3>
                        <div class="text-right">
                            <div class="text-xs text-gray-500">Total VP</div>
                            <div id="chart-total-vp" class="text-lg font-bold mono text-cyan-400">-</div>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="vpBreakdownChart"></canvas>
                    </div>
                </div>
                
                <!-- Liquidity Distribution Chart -->
                <div class="glass-card p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-semibold text-lg">Liquidity: DEX vs TLA Staked</h3>
                        <div class="text-right">
                            <div class="text-xs text-gray-500">TLA TVL</div>
                            <div id="chart-tla-tvl" class="text-lg font-bold mono text-cyan-400">-</div>
                        </div>
                    </div>
                    <div class="chart-container" style="height: 300px;">
                        <canvas id="bucketLiqChart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Top Pools -->
            <div class="mt-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="glass-card p-6">
                    <h3 class="font-semibold mb-4 flex items-center gap-2 cursor-pointer hover:text-cyan-400 transition-colors" onclick="showRankingModal('volume')">
                        <i class="fas fa-chart-line text-orange-400"></i> Top Avg Volume
                        <i class="fas fa-external-link-alt text-gray-500 text-xs ml-auto"></i>
                    </h3>
                    <div id="top-vp-pools" class="space-y-3">
                        <div class="loading-pulse text-gray-500 text-sm">Loading...</div>
                    </div>
                </div>
                <div class="glass-card p-6">
                    <h3 class="font-semibold mb-4 flex items-center gap-2 cursor-pointer hover:text-cyan-400 transition-colors" onclick="showRankingModal('liquidity')">
                        <i class="fas fa-water text-cyan-400"></i> Top Avg DEX Liquidity
                        <i class="fas fa-external-link-alt text-gray-500 text-xs ml-auto"></i>
                    </h3>
                    <div id="top-depth-pools" class="space-y-3">
                        <div class="loading-pulse text-gray-500 text-sm">Loading...</div>
                    </div>
                </div>
                <div class="glass-card p-6">
                    <h3 class="font-semibold mb-4 flex items-center gap-2 cursor-pointer hover:text-cyan-400 transition-colors" onclick="showRankingModal('apr')">
                        <i class="fas fa-percentage text-green-400"></i> Top by APR
                        <i class="fas fa-external-link-alt text-gray-500 text-xs ml-auto"></i>
                    </h3>
                    <div id="top-apr-pools" class="space-y-3">
                        <div class="loading-pulse text-gray-500 text-sm">Loading...</div>
                    </div>
                </div>
            </div>
            
            <!-- Vote Breakdown Waterfall -->
            <div class="mt-6 glass-card p-6">
                <div class="flex items-center justify-between mb-2">
                    <div>
                        <h3 class="font-semibold text-lg">Vote Breakdown by Pool</h3>
                        <p class="text-xs text-gray-500">Pools stacked by total votes - showing Votion, aDAO, and Other votes</p>
                    </div>
                    <div class="flex gap-2" id="votion-bucket-filters">
                        <button class="votion-bucket-btn active px-3 py-1.5 text-xs rounded-lg bg-white/10 text-white" data-bucket="STABLE">Stable</button>
                        <button class="votion-bucket-btn px-3 py-1.5 text-xs rounded-lg text-amber-400 hover:bg-amber-500/20" data-bucket="PROJECT">Project</button>
                        <button class="votion-bucket-btn px-3 py-1.5 text-xs rounded-lg text-blue-400 hover:bg-blue-500/20" data-bucket="BLUECHIP">Bluechip</button>
                        <button class="votion-bucket-btn px-3 py-1.5 text-xs rounded-lg text-purple-400 hover:bg-purple-500/20" data-bucket="SINGLE">Single</button>
                    </div>
                </div>
                
                <!-- Totals display -->
                <div class="flex flex-wrap items-center gap-4 mb-3 px-2 text-sm">
                    <div class="flex items-center gap-2">
                        <span class="text-gray-400">Bucket Total:</span>
                        <span id="waterfall-total" class="font-bold mono text-cyan-400">-</span>
                    </div>
                    <div class="h-4 w-px bg-white/10"></div>
                    <div class="flex items-center gap-2">
                        <span class="w-3 h-3 rounded bg-purple-500"></span>
                        <span class="text-gray-400">Votion:</span>
                        <span id="waterfall-votion" class="font-mono text-purple-400">-</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="w-3 h-3 rounded bg-cyan-500"></span>
                        <span class="text-gray-400">aDAO:</span>
                        <span id="waterfall-adao" class="font-mono text-cyan-400">-</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="w-3 h-3 rounded bg-amber-500"></span>
                        <span class="text-gray-400">Other:</span>
                        <span id="waterfall-other" class="font-mono text-amber-400">-</span>
                    </div>
                </div>
                
                <!-- Scale bar -->
                <div class="relative mb-1 h-6" id="waterfall-scale-bar">
                    <div class="absolute inset-0 flex justify-between items-end">
                        <div class="text-[10px] text-gray-500">0</div>
                        <div class="text-[10px] text-gray-500" id="scale-25">-</div>
                        <div class="text-[10px] text-gray-500" id="scale-50">-</div>
                        <div class="text-[10px] text-gray-500" id="scale-75">-</div>
                        <div class="text-[10px] text-gray-500" id="scale-max">-</div>
                    </div>
                    <!-- Grid lines -->
                    <div class="absolute bottom-0 left-0 right-0 h-px bg-white/10"></div>
                    <div class="absolute bottom-0 h-2 w-px bg-white/20" style="left: 0%"></div>
                    <div class="absolute bottom-0 h-2 w-px bg-white/10" style="left: 25%"></div>
                    <div class="absolute bottom-0 h-2 w-px bg-white/10" style="left: 50%"></div>
                    <div class="absolute bottom-0 h-2 w-px bg-white/10" style="left: 75%"></div>
                    <div class="absolute bottom-0 h-2 w-px bg-white/20" style="left: 100%"></div>
                </div>
                
                <!-- Waterfall Chart Container -->
                <div id="waterfall-container" class="relative" style="min-height: 200px;">
                    <!-- Grid lines behind bars -->
                    <div class="absolute inset-0 pointer-events-none">
                        <div class="absolute top-0 bottom-0 w-px bg-white/5" style="left: 25%"></div>
                        <div class="absolute top-0 bottom-0 w-px bg-white/5" style="left: 50%"></div>
                        <div class="absolute top-0 bottom-0 w-px bg-white/5" style="left: 75%"></div>
                    </div>
                    <div id="waterfall-bars" class="relative z-10 space-y-1">
                        <div class="text-center text-gray-500 py-8">Loading...</div>
                    </div>
                </div>
                
                <!-- Legend -->
                <div class="flex items-center justify-center gap-6 mt-4 text-sm">
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-3 rounded" style="background: #a855f7;"></div>
                        <span class="text-gray-400">Votion</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-3 rounded" style="background: #06b6d4;"></div>
                        <span class="text-gray-400">aDAO</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-3 rounded" style="background: #f59e0b;"></div>
                        <span class="text-gray-400">Other</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- POOLS TAB -->
        <div id="tab-pools" class="tab-content">
            <div class="glass-card p-4 mb-4">
                <div class="flex flex-wrap items-center gap-4">
                    <input type="text" id="pool-search" placeholder="Search pools..." 
                        class="bg-white/5 border border-white/10 rounded-lg px-4 py-2 text-sm w-64 focus:outline-none focus:border-cyan-500/50">
                    <select id="bucket-filter" class="epoch-select">
                        <option value="all">All Buckets</option>
                        <option value="STABLE">Stable</option>
                        <option value="PROJECT">Project</option>
                        <option value="BLUECHIP">Bluechip</option>
                        <option value="SINGLE">Single</option>
                    </select>
                    <select id="dex-filter" class="epoch-select">
                        <option value="all">All DEXes</option>
                        <option value="Astroport">Astroport</option>
                        <option value="Skeleton Swap">Skeleton Swap</option>
                    </select>
                    <label class="flex items-center gap-2 text-sm text-gray-400">
                        <input type="checkbox" id="active-only" class="rounded">
                        Include Inactive
                    </label>
                </div>
            </div>
            
            <!-- All Buckets with Charts and Tables -->
            <div id="pools-by-bucket" class="space-y-8">
                <!-- Populated by JS - each bucket gets chart + table -->
            </div>
        </div>
        
        <!-- TLA LIQUIDITY TAB -->
        <div id="tab-tla" class="tab-content">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="glass-card p-5 text-center">
                    <div id="tla-total-depth" class="text-3xl font-bold text-green-400 mono">-</div>
                    <div class="text-xs text-gray-500 mt-1">Total DEX Depth</div>
                </div>
                <div class="glass-card p-5 text-center">
                    <div id="tla-total-staked" class="text-3xl font-bold text-cyan-400 mono">-</div>
                    <div class="text-xs text-gray-500 mt-1">TLA Staked</div>
                </div>
                <div class="glass-card p-5 text-center">
                    <div id="tla-pct-of-dex" class="text-3xl font-bold text-purple-400 mono">-</div>
                    <div class="text-xs text-gray-500 mt-1">TLA % of DEX</div>
                </div>
                <div class="glass-card p-5 text-center">
                    <div id="tla-total-volume" class="text-3xl font-bold text-orange-400 mono">-</div>
                    <div class="text-xs text-gray-500 mt-1">Total Epoch Volume</div>
                    <div class="text-[10px] text-gray-600 mt-0.5">Astroport only</div>
                </div>
            </div>
            
            <div class="glass-card p-4 mb-4">
                <div class="flex items-center gap-6 flex-wrap">
                    <label class="flex items-center gap-2 text-sm text-gray-400">
                        <input type="checkbox" id="tla-hide-inactive" class="rounded">
                        Hide Inactive
                    </label>
                    <label class="flex items-center gap-2 text-sm text-gray-400">
                        <input type="checkbox" id="tla-hide-astro" class="rounded">
                        Hide Astroport
                    </label>
                    <label class="flex items-center gap-2 text-sm text-gray-400">
                        <input type="checkbox" id="tla-hide-ww" class="rounded">
                        Hide Skeleton Swap
                    </label>
                </div>
            </div>
            
            <div class="glass-card overflow-hidden">
                <div class="overflow-x-auto max-h-[600px]">
                    <table class="data-table" id="tla-table">
                        <thead>
                            <tr>
                                <th class="text-left sortable" data-sort="name" title="Click to sort A-Z">Pool <i class="fas fa-sort text-gray-600 ml-1"></i></th>
                                <th class="text-center sortable" data-sort="bucket" title="Click to sort by bucket">Bucket <i class="fas fa-sort text-gray-600 ml-1"></i></th>
                                <th class="text-right sortable" data-sort="depth" title="Total DEX liquidity depth. Click to sort.">DEX Depth <i class="fas fa-sort text-gray-600 ml-1"></i></th>
                                <th class="text-right sortable active" data-sort="tla_staked" title="TLA tokens staked. Click to sort.">TLA Staked <i class="fas fa-sort-down text-cyan-400 ml-1"></i></th>
                                <th class="text-right" title="Percentage of DEX depth that is TLA staked">% Depth</th>
                                <th class="text-right sortable" data-sort="tla_pct" title="Pool's share of total TLA. Click to sort.">% of TLA <i class="fas fa-sort text-gray-600 ml-1"></i></th>
                                <th class="text-right sortable" data-sort="efficiency" title="Capital efficiency score. Hover for breakdown. Click to sort.">Efficiency <i class="fas fa-sort text-gray-600 ml-1"></i></th>
                                <th class="text-right sortable" data-sort="apr" title="APR rates. Top: Amplified, Bottom: Non-amp. Click to sort.">APR <i class="fas fa-sort text-gray-600 ml-1"></i></th>
                                <th class="text-right sortable" data-sort="rewards" title="Rewards. Top: Per epoch, Bottom: Per year. Click to sort.">Rewards <i class="fas fa-sort text-gray-600 ml-1"></i></th>
                                <th class="text-right sortable" data-sort="adao" title="Alliance DAO deposit. Click to sort.">aDAO <i class="fas fa-sort text-gray-600 ml-1"></i></th>
                            </tr>
                        </thead>
                        <tbody id="tla-table-body">
                            <tr><td colspan="10" class="text-center text-gray-500 py-8">Loading TLA pools...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- RANKINGS TAB -->
        <div id="tab-rankings" class="tab-content">
            <!-- Mission Statement -->
            <div class="glass-card p-6 mb-6 border-l-4 border-cyan-500">
                <div class="flex items-start gap-4">
                    <div class="w-14 h-14 rounded-xl bg-gradient-to-br from-cyan-500 to-purple-600 flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-balance-scale text-2xl"></i>
                    </div>
                    <div>
                        <h3 class="font-semibold text-xl mb-2">aDAO Value-Driven Voting</h3>
                        <p class="text-sm text-gray-400 leading-relaxed">
                            Alliance DAO votes for <span class="text-cyan-400 font-semibold">Terra's success</span>, not personal gain. 
                            Our scoring system identifies pools that deliver real value to the chain but lack adequate support. 
                            We don't chase bribes or APR — we invest in <span class="text-green-400 font-semibold">performance</span> and 
                            <span class="text-purple-400 font-semibold">ecosystem growth</span>.
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- Three Score Cards - Clickable -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <!-- Performance Card -->
                <div class="glass-card p-5 cursor-pointer hover:border-emerald-500/50 transition-all group" onclick="showPerformanceModal()">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 rounded-lg bg-emerald-500/20 flex items-center justify-center group-hover:bg-emerald-500/30 transition-colors">
                                <i class="fas fa-chart-line text-emerald-400 text-xl"></i>
                            </div>
                            <div>
                                <div class="font-semibold text-lg">Performance</div>
                                <div class="text-[10px] text-gray-500">How valuable is this pool?</div>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right text-gray-600 group-hover:text-emerald-400 transition-colors"></i>
                    </div>
                    <div class="text-xs text-gray-500 border-t border-gray-800 pt-3 mt-2">
                        <div class="grid grid-cols-2 gap-2">
                            <div><span class="text-emerald-400">35%</span> Efficiency</div>
                            <div><span class="text-emerald-400">25%</span> Volume</div>
                            <div><span class="text-emerald-400">20%</span> Liquidity</div>
                            <div><span class="text-emerald-400">15%</span> Access</div>
                        </div>
                    </div>
                </div>
                
                <!-- Support Card -->
                <div class="glass-card p-5 cursor-pointer hover:border-amber-500/50 transition-all group" onclick="showSupportModal()">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 rounded-lg bg-amber-500/20 flex items-center justify-center group-hover:bg-amber-500/30 transition-colors">
                                <i class="fas fa-hands-helping text-amber-400 text-xl"></i>
                            </div>
                            <div>
                                <div class="font-semibold text-lg">Support</div>
                                <div class="text-[10px] text-gray-500">How much backing does it have?</div>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right text-gray-600 group-hover:text-amber-400 transition-colors"></i>
                    </div>
                    <div class="text-xs text-gray-500 border-t border-gray-800 pt-3 mt-2">
                        <div class="grid grid-cols-2 gap-2">
                            <div><span class="text-amber-400">40%</span> Bribes</div>
                            <div><span class="text-amber-400">30%</span> TLA Votes</div>
                            <div class="col-span-2"><span class="text-amber-400">30%</span> Votion Dominance</div>
                        </div>
                    </div>
                </div>
                
                <!-- Opportunity Card -->
                <div class="glass-card p-5 cursor-pointer hover:border-cyan-500/50 transition-all group" onclick="showOpportunityModal()">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 rounded-lg bg-cyan-500/20 flex items-center justify-center group-hover:bg-cyan-500/30 transition-colors">
                                <i class="fas fa-bullseye text-cyan-400 text-xl"></i>
                            </div>
                            <div>
                                <div class="font-semibold text-lg">Opportunity</div>
                                <div class="text-[10px] text-gray-500">Where can aDAO make an impact?</div>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right text-gray-600 group-hover:text-cyan-400 transition-colors"></i>
                    </div>
                    <div class="text-xs text-gray-500 border-t border-gray-800 pt-3 mt-2">
                        <div class="text-center">
                            <span class="text-emerald-400">Performance</span> 
                            <span class="text-white mx-2">−</span> 
                            <span class="text-amber-400">Support</span>
                            <span class="text-white mx-2">=</span>
                            <span class="text-cyan-400">Opportunity</span>
                        </div>
                        <div class="text-[10px] text-gray-600 mt-2 text-center">
                            Positive = undervalued • Negative = well-supported
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Asset Access Scores Section -->
            <div class="glass-card p-5 mb-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-lg bg-purple-500/20 flex items-center justify-center">
                            <i class="fas fa-coins text-purple-400"></i>
                        </div>
                        <div>
                            <div class="font-semibold">Asset Access Scores</div>
                            <div class="text-[10px] text-gray-500">How easy is it for users to acquire each asset?</div>
                        </div>
                    </div>
                    <button onclick="showAccessScoreModal()" class="text-xs text-purple-400 hover:text-purple-300 flex items-center gap-1">
                        <span>View Methodology</span>
                        <i class="fas fa-external-link-alt"></i>
                    </button>
                </div>
                <div id="asset-scores-grid" class="grid grid-cols-4 md:grid-cols-6 lg:grid-cols-8 gap-2">
                    <!-- Populated by JS -->
                </div>
            </div>
            
            <!-- Rankings Filters -->
            <div class="glass-card p-4 mb-6">
                <div class="flex items-center justify-between flex-wrap gap-4">
                    <div class="flex items-center gap-4">
                        <span class="text-xs text-gray-500 font-semibold">FILTERS:</span>
                        <label class="flex items-center gap-2 text-xs text-gray-400">
                            <input type="checkbox" id="rankings-hide-inactive" class="rounded">
                            Hide Inactive
                        </label>
                        <label class="flex items-center gap-2 text-xs text-gray-400">
                            <input type="checkbox" id="rankings-hide-astro" class="rounded">
                            Hide Astroport
                        </label>
                        <label class="flex items-center gap-2 text-xs text-gray-400">
                            <input type="checkbox" id="rankings-hide-ww" class="rounded">
                            Hide Skeleton Swap
                        </label>
                    </div>
                    <div class="flex items-center gap-3">
                        <label class="flex items-center gap-2 text-xs text-gray-400">
                            <input type="checkbox" id="rankings-hide-negative" class="rounded">
                            Hide negative scores
                        </label>
                    </div>
                </div>
                <div class="mt-3 pt-3 border-t border-gray-800 text-[10px] text-gray-500">
                    <i class="fas fa-info-circle text-cyan-400 mr-1"></i> 
                    Scores are recalculated dynamically based on filters. Rankings reflect relative performance within visible pools only.
                </div>
            </div>
            
            <!-- Rankings by Bucket -->
            <div id="rankings-buckets-container" class="space-y-6">
                <!-- Populated by JS - each bucket gets its own section -->
            </div>
            
            <!-- Legend -->
            <div class="glass-card p-3 mt-6 text-[10px] text-gray-500">
                <div class="flex items-center gap-6 flex-wrap">
                    <span><i class="fas fa-info-circle text-cyan-400 mr-1"></i> <strong>DAODAO:</strong> Votes in 10% increments</span>
                    <span><i class="fas fa-info-circle text-purple-400 mr-1"></i> <strong>Custom:</strong> Votes in 1% increments</span>
                    <span><i class="fas fa-fire text-orange-400 mr-1"></i> <strong>PD Rank:</strong> Phoenix Directive allocation %</span>
                </div>
            </div>
        </div>
        
        <!-- DAO TAB -->
        <div id="tab-dao" class="tab-content">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="glass-card p-5 text-center">
                    <div id="dao-locked-vp" class="text-3xl font-bold text-cyan-400 mono">-</div>
                    <div class="text-xs text-gray-500 mt-1">Locked VP</div>
                </div>
                <div class="glass-card p-5 text-center">
                    <div id="dao-underlying" class="text-3xl font-bold text-purple-400 mono">-</div>
                    <div class="text-xs text-gray-500 mt-1">Underlying Assets</div>
                </div>
                <div class="glass-card p-5 text-center">
                    <div id="dao-deposit-usd" class="text-3xl font-bold text-green-400 mono">-</div>
                    <div class="text-xs text-gray-500 mt-1">Deposit Value</div>
                </div>
                <div class="glass-card p-5 text-center">
                    <div id="dao-rewards-usd" class="text-3xl font-bold text-orange-400 mono">-</div>
                    <div class="text-xs text-gray-500 mt-1">Pending Rewards</div>
                </div>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Locks -->
                <div class="glass-card p-6">
                    <h3 class="font-semibold text-lg mb-4">
                        <i class="fas fa-lock text-cyan-400 mr-2"></i>Active Locks
                    </h3>
                    <div id="dao-locks" class="space-y-3">
                        <div class="loading-pulse text-gray-500 text-sm">Loading locks...</div>
                    </div>
                </div>
                
                <!-- Allocations -->
                <div class="glass-card p-6">
                    <h3 class="font-semibold text-lg mb-4">
                        <i class="fas fa-vote-yea text-purple-400 mr-2"></i>Vote Allocations
                    </h3>
                    <div id="dao-allocations" class="space-y-2 max-h-80 overflow-y-auto">
                        <div class="loading-pulse text-gray-500 text-sm">Loading allocations...</div>
                    </div>
                </div>
            </div>
            
            <!-- Vote Rewards -->
            <div class="mt-6 glass-card p-6">
                <h3 class="font-semibold text-lg mb-4">
                    <i class="fas fa-gift text-green-400 mr-2"></i>Accumulated Vote Rewards
                    <span class="text-xs text-gray-500 font-normal ml-2">(Epochs <span id="reward-epochs">-</span>)</span>
                </h3>
                <div id="dao-vote-rewards" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                    <div class="loading-pulse text-gray-500 text-sm">Loading rewards...</div>
                </div>
            </div>
            
            <!-- Treasury Tokens -->
            <div class="mt-6 glass-card p-6">
                <h3 class="font-semibold text-lg mb-4">
                    <i class="fas fa-wallet text-amber-400 mr-2"></i>Treasury Tokens
                </h3>
                <div id="dao-tokens" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                    <div class="loading-pulse text-gray-500 text-sm">Loading tokens...</div>
                </div>
            </div>
        </div>
        
        <!-- DOCS TAB -->
        <div id="tab-docs" class="tab-content">
            <div class="flex flex-col items-center justify-center py-20">
                <div class="w-24 h-24 rounded-2xl bg-gradient-to-br from-cyan-500/20 to-purple-500/20 flex items-center justify-center mb-6">
                    <i class="fas fa-book-open text-4xl text-cyan-400"></i>
                </div>
                <h2 class="text-3xl font-bold mb-3">Documentation</h2>
                <div class="flex items-center gap-2 mb-6">
                    <span class="px-3 py-1 bg-amber-500/20 text-amber-400 text-sm font-semibold rounded-full">
                        <i class="fas fa-hard-hat mr-1"></i>Coming Soon
                    </span>
                </div>
                <p class="text-gray-400 text-center max-w-md mb-8">
                    We're building comprehensive documentation to help you understand TLA, 
                    our scoring methodology, and how to make the most of this dashboard.
                </p>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 max-w-2xl">
                    <div class="glass-card p-4 text-center">
                        <i class="fas fa-seedling text-cyan-400 text-xl mb-2"></i>
                        <h3 class="font-semibold text-sm mb-1">The Basics</h3>
                        <p class="text-xs text-gray-500">What is TLA, liquidity, epochs</p>
                    </div>
                    <div class="glass-card p-4 text-center">
                        <i class="fas fa-calculator text-purple-400 text-xl mb-2"></i>
                        <h3 class="font-semibold text-sm mb-1">Scoring System</h3>
                        <p class="text-xs text-gray-500">How we calculate scores</p>
                    </div>
                    <div class="glass-card p-4 text-center">
                        <i class="fas fa-question-circle text-amber-400 text-xl mb-2"></i>
                        <h3 class="font-semibold text-sm mb-1">FAQ</h3>
                        <p class="text-xs text-gray-500">Common questions answered</p>
                    </div>
                </div>
                <p class="text-xs text-gray-600 mt-8">
                    Questions? DM <a href="https://x.com/defi_patriot" target="_blank" class="text-cyan-400 hover:underline">@defi_patriot</a> on X
                </p>
            </div>
        </div>
        
    </main>
    
    <!-- Bribes Modal -->
    <div id="bribes-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 hidden items-center justify-center overflow-y-auto py-8" onclick="closeBribesModal(event)">
        <div class="bg-gray-900 border border-white/10 rounded-2xl p-6 max-w-3xl w-full mx-4 shadow-2xl my-auto" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-bold">Epoch Bribes Breakdown</h3>
                <button onclick="closeBribesModal()" class="text-gray-400 hover:text-white transition-colors">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <!-- Summary Bars -->
            <div class="grid grid-cols-3 gap-4 mb-6">
                <div class="text-center p-4 bg-purple-500/10 rounded-lg border border-purple-500/20">
                    <div class="text-xs text-gray-400 mb-1">Phoenix Directive</div>
                    <div id="bribes-pd-luna" class="text-sm font-mono text-purple-300">-</div>
                    <div id="bribes-pd-usd" class="text-lg font-bold text-purple-400">-</div>
                </div>
                <div class="text-center p-4 bg-amber-500/10 rounded-lg border border-amber-500/20">
                    <div class="text-xs text-gray-400 mb-1">Other Bribes</div>
                    <div class="text-sm font-mono text-amber-300">USD only</div>
                    <div id="bribes-other-usd" class="text-lg font-bold text-amber-400">-</div>
                </div>
                <div class="text-center p-4 bg-cyan-500/10 rounded-lg border border-cyan-500/20">
                    <div class="text-xs text-gray-400 mb-1">Total Bribes</div>
                    <div id="bribes-luna-price" class="text-sm font-mono text-cyan-300">-</div>
                    <div id="bribes-total-usd" class="text-lg font-bold text-cyan-400">-</div>
                </div>
            </div>
            
            <!-- Bucket Breakdown -->
            <div class="space-y-4" id="bribes-bucket-breakdown">
                <!-- Populated by JS -->
            </div>
        </div>
    </div>
    
    <!-- Ranking Modal -->
    <div id="ranking-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 hidden items-center justify-center overflow-y-auto py-8" onclick="closeRankingModal(event)">
        <div class="bg-gray-900 border border-white/10 rounded-2xl p-6 max-w-2xl w-full mx-4 shadow-2xl my-auto" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between mb-4">
                <h3 id="ranking-modal-title" class="text-lg font-bold">Rankings</h3>
                <button onclick="closeRankingModal()" class="text-gray-400 hover:text-white transition-colors">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <!-- Sort Toggle -->
            <div class="flex items-center justify-between mb-4">
                <div class="text-sm text-gray-400">
                    Showing <span id="ranking-count" class="text-white">0</span> pools
                </div>
                <button id="ranking-sort-btn" onclick="toggleRankingSort()" class="flex items-center gap-2 px-3 py-1.5 text-xs rounded-lg bg-white/10 hover:bg-white/20 transition-colors">
                    <i class="fas fa-sort-amount-down"></i>
                    <span id="ranking-sort-label">High to Low</span>
                </button>
            </div>
            
            <!-- Rankings List -->
            <div id="ranking-list" class="space-y-2 max-h-[60vh] overflow-y-auto pr-2">
                <!-- Populated by JS -->
            </div>
        </div>
    </div>
    
    <!-- Performance Score Modal -->
    <div id="performance-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 hidden items-center justify-center overflow-y-auto py-8" onclick="closePerformanceModal(event)">
        <div class="bg-gray-900 border border-emerald-500/30 rounded-2xl p-6 max-w-3xl w-full mx-4 shadow-2xl my-auto" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 rounded-lg bg-emerald-500/20 flex items-center justify-center">
                        <i class="fas fa-chart-line text-emerald-400 text-xl"></i>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-emerald-400">Performance Score</h3>
                        <div class="text-sm text-gray-400">Measuring real value to Terra</div>
                    </div>
                </div>
                <button onclick="closePerformanceModal()" class="text-gray-400 hover:text-white transition-colors text-xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <div class="p-4 bg-emerald-500/5 border border-emerald-500/20 rounded-lg">
                    <div class="text-sm text-gray-300 mb-3">
                        Performance Score measures how much <span class="text-emerald-400 font-semibold">real value</span> a pool generates for Terra. 
                        Higher scores = pool is working harder for the chain.
                    </div>
                </div>
                
                <!-- Component Breakdown -->
                <div class="grid gap-3">
                    <div class="p-4 bg-gray-800/50 rounded-lg border border-gray-700">
                        <div class="flex items-center justify-between mb-2">
                            <div class="font-semibold text-emerald-400">Capital Efficiency</div>
                            <div class="text-xl font-bold text-emerald-400">35%</div>
                        </div>
                        <div class="text-sm text-gray-400">
                            <span class="text-white">Volume ÷ Liquidity</span> — How hard is the liquidity working?
                        </div>
                        <div class="text-xs text-gray-500 mt-2 p-2 bg-black/30 rounded">
                            Example: $50K liquidity doing $20K/day volume (0.4) beats $500K doing $5K/day (0.01)
                        </div>
                    </div>
                    
                    <div class="p-4 bg-gray-800/50 rounded-lg border border-gray-700">
                        <div class="flex items-center justify-between mb-2">
                            <div class="font-semibold text-blue-400">Trading Volume</div>
                            <div class="text-xl font-bold text-blue-400">25%</div>
                        </div>
                        <div class="text-sm text-gray-400">
                            <span class="text-white">4-epoch average volume</span> — More trades = more activity on Terra
                        </div>
                    </div>
                    
                    <div class="p-4 bg-gray-800/50 rounded-lg border border-gray-700">
                        <div class="flex items-center justify-between mb-2">
                            <div class="font-semibold text-cyan-400">Liquidity Depth</div>
                            <div class="text-xl font-bold text-cyan-400">20%</div>
                        </div>
                        <div class="text-sm text-gray-400">
                            <span class="text-white">4-epoch average liquidity</span> — Deeper pools enable larger trades with less slippage
                        </div>
                    </div>
                    
                    <div class="p-4 bg-gray-800/50 rounded-lg border border-gray-700">
                        <div class="flex items-center justify-between mb-2">
                            <div class="font-semibold text-purple-400">Access Score</div>
                            <div class="text-xl font-bold text-purple-400">15%</div>
                        </div>
                        <div class="text-sm text-gray-400">
                            <span class="text-white">How easy to use</span> — Can new users easily deposit? Is naming consistent across TLA, CoinGecko, DEXs, and wallets (Skip.go)? Users always know what they need & what they're getting.
                        </div>
                    </div>
                </div>
                
                <div class="p-3 bg-gray-800/30 rounded-lg text-xs text-gray-500 text-center">
                    All components are ranked within each bucket, then weighted to produce a 0-100 score
                </div>
            </div>
        </div>
    </div>
    
    <!-- Support Score Modal -->
    <div id="support-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 hidden items-center justify-center overflow-y-auto py-8" onclick="closeSupportModal(event)">
        <div class="bg-gray-900 border border-amber-500/30 rounded-2xl p-6 max-w-3xl w-full mx-4 shadow-2xl my-auto" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 rounded-lg bg-amber-500/20 flex items-center justify-center">
                        <i class="fas fa-hands-helping text-amber-400 text-xl"></i>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-amber-400">Support Score</h3>
                        <div class="text-sm text-gray-400">Measuring existing backing</div>
                    </div>
                </div>
                <button onclick="closeSupportModal()" class="text-gray-400 hover:text-white transition-colors text-xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <div class="p-4 bg-amber-500/5 border border-amber-500/20 rounded-lg">
                    <div class="text-sm text-gray-300 mb-3">
                        Support Score measures how much <span class="text-amber-400 font-semibold">existing backing</span> a pool already has. 
                        High support = pool doesn't need more votes. Low support = potential opportunity.
                    </div>
                </div>
                
                <!-- Component Breakdown -->
                <div class="grid gap-3">
                    <div class="p-4 bg-gray-800/50 rounded-lg border border-gray-700">
                        <div class="flex items-center justify-between mb-2">
                            <div class="font-semibold text-amber-400">Bribes</div>
                            <div class="text-xl font-bold text-amber-400">40%</div>
                        </div>
                        <div class="text-sm text-gray-400">
                            <span class="text-white">Total bribe value this epoch</span> — Pools paying bribes are actively seeking votes
                        </div>
                        <div class="text-xs text-gray-500 mt-2 p-2 bg-black/30 rounded">
                            Includes Phoenix Directive + other bribes. High bribes = someone is paying for votes
                        </div>
                    </div>
                    
                    <div class="p-4 bg-gray-800/50 rounded-lg border border-gray-700">
                        <div class="flex items-center justify-between mb-2">
                            <div class="font-semibold text-orange-400">TLA Vote Share</div>
                            <div class="text-xl font-bold text-orange-400">30%</div>
                        </div>
                        <div class="text-sm text-gray-400">
                            <span class="text-white">% of bucket's TLA votes</span> — How much of existing vote power goes here
                        </div>
                    </div>
                    
                    <div class="p-4 bg-gray-800/50 rounded-lg border border-gray-700">
                        <div class="flex items-center justify-between mb-2">
                            <div class="font-semibold text-red-400">Votion Dominance</div>
                            <div class="text-xl font-bold text-red-400">30%</div>
                        </div>
                        <div class="text-sm text-gray-400">
                            <span class="text-white">Votion votes ÷ TLA votes</span> — How dependent is pool on automated voting
                        </div>
                        <div class="text-xs text-gray-500 mt-2 p-2 bg-black/30 rounded">
                            High Votion dominance = pool relies heavily on protocol votes, may be vulnerable if Votion changes
                        </div>
                    </div>
                </div>
                
                <div class="p-3 bg-gray-800/30 rounded-lg text-xs text-gray-500 text-center">
                    aDAO targets pools with LOW support scores — our votes make more impact where support is lacking
                </div>
            </div>
        </div>
    </div>
    
    <!-- Opportunity Score Modal -->
    <div id="opportunity-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 hidden items-center justify-center overflow-y-auto py-8" onclick="closeOpportunityModal(event)">
        <div class="bg-gray-900 border border-cyan-500/30 rounded-2xl p-6 max-w-3xl w-full mx-4 shadow-2xl my-auto" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 rounded-lg bg-cyan-500/20 flex items-center justify-center">
                        <i class="fas fa-bullseye text-cyan-400 text-xl"></i>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-cyan-400">Opportunity Score</h3>
                        <div class="text-sm text-gray-400">Finding undervalued pools</div>
                    </div>
                </div>
                <button onclick="closeOpportunityModal()" class="text-gray-400 hover:text-white transition-colors text-xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <div class="p-4 bg-cyan-500/5 border border-cyan-500/20 rounded-lg">
                    <div class="text-sm text-gray-300">
                        The aDAO Opportunity Score finds pools that are <span class="text-emerald-400 font-semibold">high performance</span> but 
                        <span class="text-amber-400 font-semibold">low support</span> — exactly where aDAO's votes can make the biggest impact.
                    </div>
                </div>
                
                <!-- Formula -->
                <div class="p-6 bg-gradient-to-r from-emerald-500/10 via-gray-800/50 to-amber-500/10 rounded-lg border border-gray-700">
                    <div class="text-center">
                        <div class="text-3xl font-bold mb-2">
                            <span class="text-emerald-400">Performance</span>
                            <span class="text-white mx-3">−</span>
                            <span class="text-amber-400">Support</span>
                            <span class="text-white mx-3">=</span>
                            <span class="text-cyan-400">Opportunity</span>
                        </div>
                        <div class="text-sm text-gray-400">Range: -100 to +100</div>
                    </div>
                </div>
                
                <!-- Interpretation -->
                <div class="grid md:grid-cols-2 gap-3">
                    <div class="p-4 bg-green-500/10 border border-green-500/30 rounded-lg">
                        <div class="flex items-center gap-2 mb-2">
                            <i class="fas fa-arrow-up text-green-400"></i>
                            <div class="font-semibold text-green-400">Positive Score</div>
                        </div>
                        <div class="text-sm text-gray-400">
                            Pool is <span class="text-white">undervalued</span>. Performance exceeds support — 
                            this is where aDAO votes can drive value.
                        </div>
                        <div class="text-xs text-green-400 mt-2">✓ Target for voting</div>
                    </div>
                    
                    <div class="p-4 bg-red-500/10 border border-red-500/30 rounded-lg">
                        <div class="flex items-center gap-2 mb-2">
                            <i class="fas fa-arrow-down text-red-400"></i>
                            <div class="font-semibold text-red-400">Negative Score</div>
                        </div>
                        <div class="text-sm text-gray-400">
                            Pool is <span class="text-white">well-supported</span>. Already has more backing than 
                            performance justifies — aDAO votes go elsewhere.
                        </div>
                        <div class="text-xs text-red-400 mt-2">✗ Skip for now</div>
                    </div>
                </div>
                
                <div class="p-4 bg-gray-800/50 rounded-lg border border-gray-700">
                    <div class="font-semibold text-white mb-2">Why This Matters</div>
                    <div class="text-sm text-gray-400 space-y-2">
                        <p>• aDAO doesn't chase bribes or APR — we vote for Terra's success</p>
                        <p>• By supporting undervalued pools, we help the entire ecosystem grow</p>
                        <p>• Over time, this creates a healthier, more balanced TLA distribution</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Access Score Methodology Modal -->
    <div id="access-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 hidden items-center justify-center overflow-y-auto py-8" onclick="closeAccessModal(event)">
        <div class="bg-gray-900 border border-purple-500/30 rounded-2xl p-6 max-w-4xl w-full mx-4 shadow-2xl my-auto" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 rounded-lg bg-purple-500/20 flex items-center justify-center">
                        <i class="fas fa-key text-purple-400 text-xl"></i>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-purple-400">Access Score Methodology</h3>
                        <div class="text-sm text-gray-400">How we grade asset accessibility</div>
                    </div>
                </div>
                <button onclick="closeAccessModal()" class="text-gray-400 hover:text-white transition-colors text-xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <div class="p-4 bg-purple-500/5 border border-purple-500/20 rounded-lg">
                    <div class="text-sm text-gray-300">
                        Access Score measures how easy it is for new users to acquire an asset and deposit into a pool.
                        Assets that are hard to get reduce pool accessibility, hurting adoption.
                    </div>
                </div>
                
                <div class="grid md:grid-cols-2 gap-4">
                    <!-- Origin -->
                    <div class="p-4 bg-gray-800/50 rounded-lg border border-gray-700">
                        <div class="font-semibold text-white mb-3 flex items-center gap-2">
                            <i class="fas fa-globe text-green-400"></i> Origin (Base Score)
                        </div>
                        <div class="space-y-2 text-xs">
                            <div class="flex justify-between"><span class="text-cyan-400">🔄 Terra LSD</span><span class="text-green-400">+85</span></div>
                            <div class="flex justify-between"><span class="text-green-400">🏠 Terra Native</span><span class="text-green-400">+80</span></div>
                            <div class="flex justify-between"><span class="text-purple-400">⚛️ IBC</span><span class="text-yellow-400">+70</span></div>
                            <div class="flex justify-between"><span class="text-blue-400">💵 Bridged Stable</span><span class="text-yellow-400">+65</span></div>
                            <div class="flex justify-between"><span class="text-yellow-400">🌉 Eureka Bridge</span><span class="text-orange-400">+55</span></div>
                            <div class="flex justify-between"><span class="text-orange-400">🔶 Axelar/Osmosis</span><span class="text-red-400">+50</span></div>
                        </div>
                        <div class="text-[10px] text-gray-500 mt-2 space-y-1">
                            <div><span class="text-cyan-400">LSD</span> = LSDs like ampLUNA directly benefit Terra staking</div>
                            <div><span class="text-green-400">Native</span> = Built on Terra, fully integrated</div>
                            <div><span class="text-purple-400">IBC</span> = Cosmos native, reliable bridging</div>
                            <div><span class="text-blue-400">Bridged Stable</span> = Lower score due to bridge/route complexity, multiple variants (USDC.axl, USDC.noble, etc.) can confuse users</div>
                        </div>
                    </div>
                    
                    <!-- CoinGecko -->
                    <div class="p-4 bg-gray-800/50 rounded-lg border border-gray-700">
                        <div class="font-semibold text-white mb-3 flex items-center gap-2">
                            <i class="fas fa-chart-pie text-yellow-400"></i> CoinGecko Status
                        </div>
                        <div class="space-y-2 text-xs">
                            <div class="flex justify-between"><span class="text-green-400">✓ Terra Listed</span><span class="text-green-400">+15</span></div>
                            <div class="flex justify-between"><span class="text-yellow-400">○ Other Chain</span><span class="text-yellow-400">+5</span></div>
                            <div class="flex justify-between"><span class="text-red-400">✗ Not Listed</span><span class="text-red-400">-15</span></div>
                        </div>
                        <div class="text-[10px] text-gray-500 mt-2 space-y-1">
                            <div>Provides reliable price oracles for LP balancing & transparency</div>
                            <div>Public pricing ensures you know asset value without relying solely on DEX data</div>
                        </div>
                    </div>
                    
                    <!-- Asset Class -->
                    <div class="p-4 bg-gray-800/50 rounded-lg border border-gray-700">
                        <div class="font-semibold text-white mb-3 flex items-center gap-2">
                            <i class="fas fa-tags text-blue-400"></i> Asset Class (Bonus)
                        </div>
                        <div class="space-y-2 text-xs">
                            <div class="flex justify-between"><span class="text-green-300">Stable (USDC, USDT)</span><span class="text-green-400">+5</span></div>
                            <div class="flex justify-between"><span class="text-yellow-300">Bluechip (BTC, ETH)</span><span class="text-green-400">+5</span></div>
                            <div class="flex justify-between"><span class="text-amber-300">RWA (PAXG, tokenized assets)</span><span class="text-green-400">+5</span></div>
                            <div class="flex justify-between"><span class="text-cyan-300">LSD (ampLUNA, stLUNA)</span><span class="text-green-400">+5</span></div>
                            <div class="flex justify-between"><span class="text-gray-300">Core/Native/DeFi</span><span class="text-gray-400">+0</span></div>
                        </div>
                        <div class="text-[10px] text-gray-500 mt-2 space-y-1">
                            <div>Bonus for asset types that bring value to Terra ecosystem</div>
                            <div><span class="text-amber-300">RWA</span> = Non-crypto correlated, store of value in bear markets</div>
                        </div>
                    </div>
                    
                    <!-- Treasury Value -->
                    <div class="p-4 bg-gray-800/50 rounded-lg border border-gray-700">
                        <div class="font-semibold text-white mb-3 flex items-center gap-2">
                            <i class="fas fa-vault text-amber-400"></i> Treasury Value
                        </div>
                        <div class="space-y-2 text-xs">
                            <div class="flex justify-between"><span class="text-yellow-400">🏆 High (BTC, ETH, Stables)</span><span class="text-green-400">+5</span></div>
                            <div class="flex justify-between"><span class="text-blue-400">👍 Medium</span><span class="text-gray-400">+0</span></div>
                            <div class="flex justify-between"><span class="text-gray-400">👎 Low (Protocol tokens)</span><span class="text-red-400">-5</span></div>
                        </div>
                        <div class="text-[10px] text-gray-500 mt-2">Does Terra treasury want this asset?</div>
                    </div>
                </div>
                
                <!-- Modifiers -->
                <div class="p-4 bg-gray-800/50 rounded-lg border border-gray-700">
                    <div class="font-semibold text-white mb-3">Additional Modifiers</div>
                    <div class="grid md:grid-cols-3 gap-4 text-xs">
                        <div>
                            <div class="text-gray-400 mb-1">Naming Accurate</div>
                            <div class="flex gap-2">
                                <span class="text-green-400">✓ Matches: +10</span>
                                <span class="text-red-400">✗ Confusing: -10</span>
                            </div>
                        </div>
                        <div>
                            <div class="text-gray-400 mb-1">Skip.go Clear</div>
                            <div class="flex gap-2">
                                <span class="text-green-400">✓ Easy: +5</span>
                                <span class="text-red-400">✗ Hard: -5</span>
                            </div>
                        </div>
                        <div>
                            <div class="text-gray-400 mb-1">Multi-DEX</div>
                            <div><span class="text-green-400">✓ Available: +5</span></div>
                        </div>
                    </div>
                </div>
                
                <div class="text-center text-xs text-gray-500">
                    <a href="https://github.com/defipatriot/tla_json_storage/blob/main/tla_metadata.json" target="_blank" class="text-purple-400 hover:text-purple-300">
                        View full metadata on GitHub <i class="fas fa-external-link-alt ml-1"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Pool Detail Modal -->
    <div id="pool-detail-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 hidden items-center justify-center overflow-y-auto py-8" onclick="closePoolDetailModal(event)">
        <div class="bg-gray-900 border border-white/10 rounded-2xl p-6 max-w-2xl w-full mx-4 shadow-2xl my-auto" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h3 id="pool-detail-name" class="text-xl font-bold">Pool Name</h3>
                    <div id="pool-detail-meta" class="text-sm text-gray-400">DEX • Bucket</div>
                </div>
                <button onclick="closePoolDetailModal()" class="text-gray-400 hover:text-white transition-colors text-xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div id="pool-detail-content" class="space-y-4">
                <!-- Populated by JS -->
            </div>
        </div>
    </div>
    
    <!-- Asset Detail Modal -->
    <div id="asset-detail-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 hidden items-center justify-center overflow-y-auto py-8" onclick="closeAssetDetailModal(event)">
        <div class="bg-gray-900 border border-purple-500/30 rounded-2xl p-6 max-w-lg w-full mx-4 shadow-2xl my-auto" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center gap-3">
                    <div id="asset-detail-icon" class="w-12 h-12 rounded-lg bg-purple-500/20 flex items-center justify-center">
                        <span id="asset-detail-score-icon" class="text-2xl font-bold text-purple-400">100</span>
                    </div>
                    <div>
                        <h3 id="asset-detail-name" class="text-xl font-bold">LUNA</h3>
                        <div id="asset-detail-origin" class="text-sm text-gray-400">Terra Native</div>
                    </div>
                </div>
                <button onclick="closeAssetDetailModal()" class="text-gray-400 hover:text-white transition-colors text-xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div id="asset-detail-content" class="space-y-4">
                <!-- Populated by JS -->
            </div>
        </div>
    </div>
    
    <!-- Footer -->
    <footer class="max-w-7xl mx-auto px-4 py-8 border-t border-white/5">
        <!-- Mission Statement -->
        <div class="mb-6 p-4 bg-cyan-500/5 border border-cyan-500/20 rounded-lg">
            <div class="flex items-start gap-3">
                <i class="fas fa-balance-scale text-cyan-400 mt-1"></i>
                <div>
                    <h4 class="font-semibold text-cyan-400 mb-2">Our Philosophy</h4>
                    <p class="text-sm text-gray-400 leading-relaxed">
                        Alliance DAO serves as a balancing force in TLA governance. We're not here to compete with Phoenix Directive or Votion — 
                        we're here to fill the natural gaps in the ve(3,3) incentive structure. Using data-driven analysis, we support LPs 
                        with real utility and strategic value, working alongside PD and Votion to help promising projects and pools grow. 
                        Together, we strengthen Terra's liquidity ecosystem.
                    </p>
                </div>
            </div>
        </div>
        
        <!-- Ecosystem Links -->
        <div class="mb-6 p-4 bg-gray-800/30 border border-gray-700/50 rounded-lg">
            <h4 class="text-xs font-semibold text-gray-400 mb-3 uppercase tracking-wider">Terra Liquidity Ecosystem</h4>
            <div class="flex flex-wrap gap-4">
                <a href="https://www.erisprotocol.com/terra/liquidity-hub?tab=liquidity" target="_blank" 
                   class="flex items-center gap-2 px-3 py-2 bg-purple-500/10 border border-purple-500/30 rounded-lg hover:bg-purple-500/20 transition-colors">
                    <i class="fas fa-water text-purple-400"></i>
                    <span class="text-sm text-purple-400">Eris TLA</span>
                    <i class="fas fa-external-link-alt text-[10px] text-purple-400/50"></i>
                </a>
                <a href="https://app.astroport.fi/pools" target="_blank" 
                   class="flex items-center gap-2 px-3 py-2 bg-red-500/10 border border-red-500/30 rounded-lg hover:bg-red-500/20 transition-colors">
                    <i class="fas fa-rocket text-red-400"></i>
                    <span class="text-sm text-red-400">Astroport</span>
                    <i class="fas fa-external-link-alt text-[10px] text-red-400/50"></i>
                </a>
                <a href="https://skeletonswap.backbonelabs.io/terra/pools" target="_blank" id="secondary-dex-link"
                   class="flex items-center gap-2 px-3 py-2 bg-emerald-500/10 border border-emerald-500/30 rounded-lg hover:bg-emerald-500/20 transition-colors">
                    <i class="fas fa-bone text-emerald-400"></i>
                    <span class="text-sm text-emerald-400">Skeleton Swap</span>
                    <i class="fas fa-external-link-alt text-[10px] text-emerald-400/50"></i>
                </a>
                <a href="https://votion.money/liquidity-alliance" target="_blank" 
                   class="flex items-center gap-2 px-3 py-2 bg-blue-500/10 border border-blue-500/30 rounded-lg hover:bg-blue-500/20 transition-colors">
                    <i class="fas fa-vote-yea text-blue-400"></i>
                    <span class="text-sm text-blue-400">Votion</span>
                    <i class="fas fa-external-link-alt text-[10px] text-blue-400/50"></i>
                </a>
                <a href="tla-docs.html" 
                   class="flex items-center gap-2 px-3 py-2 bg-cyan-500/10 border border-cyan-500/30 rounded-lg hover:bg-cyan-500/20 transition-colors">
                    <i class="fas fa-book text-cyan-400"></i>
                    <span class="text-sm text-cyan-400">Docs</span>
                </a>
                <a href="https://daodao.zone/dao/terra1k8ug6dkzntczfzn76wsh24tdjmx944yj6mk063wum7n20cwd7lxq4lppjg/proposals" target="_blank" 
                   class="flex items-center gap-2 px-3 py-2 bg-orange-500/10 border border-orange-500/30 rounded-lg hover:bg-orange-500/20 transition-colors">
                    <i class="fas fa-fire text-orange-400"></i>
                    <span class="text-sm text-orange-400">Phoenix Directive</span>
                    <i class="fas fa-external-link-alt text-[10px] text-orange-400/50"></i>
                </a>
            </div>
        </div>
        
        <!-- Disclaimers -->
        <div class="mb-6 p-4 bg-gray-800/30 border border-gray-700/50 rounded-lg text-[11px] text-gray-500 space-y-2">
            <p><strong class="text-gray-400">⚠️ Not Financial Advice:</strong> The information provided on this dashboard is for informational and educational purposes only. It should not be construed as financial, investment, or trading advice. Always do your own research (DYOR) and consult with qualified professionals before making any financial decisions.</p>
            <p><strong class="text-gray-400">📊 Data Accuracy:</strong> While we strive to maintain accurate and up-to-date information, this dashboard relies on third-party data sources and automated calculations. Data may be delayed, incomplete, or contain errors. We make no guarantees regarding the accuracy, completeness, or reliability of any information presented.</p>
            <p><strong class="text-gray-400">🔗 Third-Party Links:</strong> This site may contain links to external websites. We are not responsible for the content or accuracy of any third-party sites.</p>
            <p><strong class="text-gray-400">💡 Use at Your Own Risk:</strong> Any actions taken based on the information on this dashboard are at your own risk. The creators and contributors of this dashboard shall not be held liable for any losses, damages, or claims arising from the use of this information.</p>
        </div>
        
        <!-- Credits -->
        <div class="flex flex-wrap items-center justify-between gap-4">
            <div class="text-xs text-gray-500">
                <span id="last-updated">-</span>
                <span class="mx-2">•</span>
                Data from <a href="https://github.com/defipatriot/tla_json_storage" target="_blank" class="text-cyan-400 hover:underline">GitHub</a>
            </div>
            <div class="text-xs text-gray-500">
                Built by: <a href="https://x.com/defi_patriot" target="_blank" class="text-cyan-400 hover:underline">DeFi Patriot</a>
                <span class="mx-2">•</span>
                <span class="text-gray-600">DM for edits or errors</span>
            </div>
        </div>
        
        <!-- Copyright -->
        <div class="mt-4 pt-4 border-t border-gray-800 text-center text-[10px] text-gray-600">
            © 2025 Alliance DAO Community Project. Not affiliated with Terraform Labs or any official Terra entity.
        </div>
    </footer>
    
    <script>
    // ============================================================
    // CONFIGURATION
    // ============================================================
    const CONFIG = {
        configUrl: 'https://raw.githubusercontent.com/defipatriot/tla_json_storage/main/tla_config.json',
        baseUrl: 'https://raw.githubusercontent.com/defipatriot/tla_json_storage/main',
        extUrl: 'https://raw.githubusercontent.com/defipatriot/tla-ext_json_storage/main',
        adaoUrl: 'https://raw.githubusercontent.com/defipatriot/adao_json_storage/main',
        pdBribesUrl: 'https://raw.githubusercontent.com/defipatriot/tla-ext_json_storage/main/tla_pd_bribes.json',
        historicalUrl: 'https://raw.githubusercontent.com/defipatriot/tla-ext_json_storage/main/tla_ext_historical.json',
        epochDatesUrl: 'https://raw.githubusercontent.com/defipatriot/tla_json_storage/main/epoch_1-300_date.json',
        docsUrl: 'https://raw.githubusercontent.com/defipatriot/tla_json_storage/main/tla_docs.json',
        currentEpoch: 161,
        defaultPhase: 'end'
    };
    
    // Site config loaded from tla_config.json - provides defaults until loaded
    let siteConfig = {
        scoring: {
            weights: { access: 0.15, performance: 0.55, support: 0.30 },
            origin: { terra_lsd: 85, terra_native: 80, ibc_native: 70, bridged_stable: 65, bridge_eureka: 55, bridge_axelar: 50 },
            assetClass: { stable: 5, bluechip: 5, lsd: 5, rwa: 5, core: 0 }
        },
        dex: {
            primary: { name: 'Astroport', link: 'https://app.astroport.fi/pools' },
            secondary: { name: 'Skeleton Swap', link: 'https://skeletonswap.backbonelabs.io/terra/pools', enabled: true }
        }
    };
    
    // ============================================================
    // STATE
    // ============================================================
    const store = {
        epoch: null,
        phase: 'end',
        data: null,
        adaoSnap: null,
        pdBribesData: null,
        docs: null,
        siteConfig: null,
        pools: [],
        tlaPools: [],
        dao: null,
        bribesData: null,
        epochDates: null,
        currentRealEpoch: null,
        loaded: false,
        charts: {}
    };
    
    // ============================================================
    // HELPERS
    // ============================================================
    function fmt$(n) {
        if (n === null || n === undefined || isNaN(n)) return '-';
        if (Math.abs(n) >= 1e6) return '$' + (n / 1e6).toFixed(2) + 'M';
        if (Math.abs(n) >= 1e3) return '$' + (n / 1e3).toFixed(1) + 'K';
        return '$' + n.toFixed(2);
    }
    
    function fmtNum(n) {
        if (n === null || n === undefined || isNaN(n)) return '-';
        if (Math.abs(n) >= 1e6) return (n / 1e6).toFixed(2) + 'M';
        if (Math.abs(n) >= 1e3) return (n / 1e3).toFixed(1) + 'K';
        return n.toFixed(2);
    }
    
    function fmtPct(n) {
        if (n === null || n === undefined || isNaN(n)) return '-';
        return n.toFixed(1) + '%';
    }
    
    function fmtNumComma(n) {
        if (n === null || n === undefined || isNaN(n)) return '-';
        return Math.round(n).toLocaleString('en-US');
    }
    
    function fmtBig(n) {
        if (n === null || n === undefined || isNaN(n)) return '-';
        if (Math.abs(n) >= 1e9) return (n / 1e9).toFixed(2) + 'B';
        if (Math.abs(n) >= 1e6) return (n / 1e6).toFixed(2) + 'M';
        if (Math.abs(n) >= 1e3) return (n / 1e3).toFixed(1) + 'K';
        return n.toFixed(2);
    }
    
    function getBucketColor(bucket) {
        const colors = {
            'STABLE': '#10b981',
            'PROJECT': '#f59e0b',
            'BLUECHIP': '#3b82f6',
            'SINGLE': '#a855f7',
            'UNKNOWN': '#64748b'
        };
        return colors[bucket] || colors.UNKNOWN;
    }
    
    function getDexClass(dex) {
        if (dex?.includes('Astro')) return 'dex-astro';
        if (dex?.includes('White')) return 'dex-ww';
        return 'bg-white/10 text-gray-400';
    }
    
    function getScoreClass(score) {
        if (score >= 20) return 'score-high';
        if (score >= 0) return 'score-mid';
        return 'score-low';
    }
    
    function getScoreIcon(score) {
        if (score >= 20) return '<i class="fas fa-arrow-up"></i>';
        if (score >= 0) return '<i class="fas fa-minus"></i>';
        return '<i class="fas fa-arrow-down"></i>';
    }
    
    // ============================================================
    // SITE CONFIG LOADING
    // ============================================================
    async function loadSiteConfig() {
        try {
            const response = await fetch(CONFIG.configUrl);
            if (response.ok) {
                const config = await response.json();
                store.siteConfig = config;
                
                // Update siteConfig with loaded values
                if (config.scoring) {
                    if (config.scoring.weights) siteConfig.scoring.weights = config.scoring.weights;
                    if (config.scoring.origin) siteConfig.scoring.origin = config.scoring.origin;
                    if (config.scoring.assetClass) siteConfig.scoring.assetClass = config.scoring.assetClass;
                }
                if (config.dex) {
                    if (config.dex.primary) siteConfig.dex.primary = config.dex.primary;
                    if (config.dex.secondary) siteConfig.dex.secondary = config.dex.secondary;
                }
                if (config.general) {
                    if (config.general.currentEpoch) CONFIG.currentEpoch = config.general.currentEpoch;
                    if (config.general.defaultPhase) CONFIG.defaultPhase = config.general.defaultPhase;
                }
                if (config.urls) {
                    if (config.urls.baseUrl) CONFIG.baseUrl = config.urls.baseUrl;
                    if (config.urls.extUrl) CONFIG.extUrl = config.urls.extUrl;
                    if (config.urls.adaoUrl) CONFIG.adaoUrl = config.urls.adaoUrl;
                }
                
                console.log('Site config loaded:', config.version, config.updated);
                
                // Update secondary DEX link visibility
                updateSecondaryDexLink();
            }
        } catch (err) {
            console.log('Site config fetch error (using defaults):', err.message);
        }
    }
    
    function updateSecondaryDexLink() {
        const dexLinkEl = document.getElementById('secondary-dex-link');
        if (!dexLinkEl) return;
        
        const dex = siteConfig.dex.secondary;
        if (dex.enabled && dex.link) {
            // Make it a clickable link
            dexLinkEl.outerHTML = `
                <a id="secondary-dex-link" href="${dex.link}" target="_blank" 
                   class="flex items-center gap-2 px-3 py-2 bg-emerald-500/10 border border-emerald-500/30 rounded-lg hover:bg-emerald-500/20 transition-colors">
                    <i class="fas fa-bone text-emerald-400"></i>
                    <span class="text-sm text-emerald-400">${dex.name}</span>
                    <i class="fas fa-external-link-alt text-[10px] text-emerald-400/50"></i>
                </a>`;
        } else {
            // Keep it disabled
            dexLinkEl.outerHTML = `
                <div id="secondary-dex-link" class="flex items-center gap-2 px-3 py-2 bg-emerald-500/10 border border-emerald-500/30 rounded-lg opacity-50 cursor-not-allowed">
                    <i class="fas fa-bone text-emerald-400"></i>
                    <span class="text-sm text-emerald-400">${dex.name}</span>
                    <span class="text-[9px] text-gray-500">(Coming Soon)</span>
                </div>`;
        }
    }
    
    // Helper to get origin score from config
    function getOriginScore(origin) {
        const scores = siteConfig.scoring.origin;
        const mapping = {
            'terra_lsd': scores.terra_lsd,
            'terra_native': scores.terra_native,
            'ibc': scores.ibc_native,
            'ibc_native': scores.ibc_native,
            'bridge_eureka': scores.bridge_eureka,
            'bridge_axelar': scores.bridge_axelar,
            'bridge_osmosis': scores.bridge_axelar,
            'stable_native': scores.bridged_stable,
            'bridged_stable': scores.bridged_stable
        };
        return mapping[origin] || 30;
    }
    
    // Helper to get asset class bonus from config
    function getAssetClassBonus(assetClass) {
        const bonuses = siteConfig.scoring.assetClass;
        const mapping = {
            'stable': bonuses.stable,
            'bluechip': bonuses.bluechip,
            'lsd': bonuses.lsd,
            'rwa': bonuses.rwa,
            'core': bonuses.core,
            'native': 0,
            'defi': 0
        };
        return mapping[assetClass] || 0;
    }
    
    // ============================================================
    // EPOCH DATES & TIMING
    // ============================================================
    async function loadEpochDates() {
        try {
            const response = await fetch(CONFIG.epochDatesUrl);
            if (response.ok) {
                store.epochDates = await response.json();
                console.log('Epoch dates loaded:', store.epochDates.length, 'epochs');
                calculateCurrentEpoch();
                startEpochCountdown();
            }
        } catch (err) {
            console.log('Epoch dates fetch error:', err.message);
        }
    }
    
    function calculateCurrentEpoch() {
        if (!store.epochDates) return null;
        
        const now = new Date();
        
        // Find the epoch we're currently in
        for (const ep of store.epochDates) {
            const start = new Date(ep.start_time);
            const end = new Date(ep.end_time);
            
            if (now >= start && now < end) {
                store.currentRealEpoch = ep.epoch;
                document.getElementById('live-epoch').textContent = ep.epoch;
                console.log('Current real epoch:', ep.epoch);
                return ep;
            }
        }
        
        // If we're past all defined epochs, use the last one
        const lastEpoch = store.epochDates[store.epochDates.length - 1];
        store.currentRealEpoch = lastEpoch.epoch;
        document.getElementById('live-epoch').textContent = lastEpoch.epoch;
        return lastEpoch;
    }
    
    function getCurrentEpochInfo() {
        if (!store.epochDates || !store.currentRealEpoch) return null;
        return store.epochDates.find(e => e.epoch === store.currentRealEpoch);
    }
    
    function startEpochCountdown() {
        updateEpochCountdown();
        // Update every minute
        setInterval(updateEpochCountdown, 60000);
    }
    
    function updateEpochCountdown() {
        const epochInfo = getCurrentEpochInfo();
        if (!epochInfo) {
            document.getElementById('epoch-countdown').textContent = '-';
            return;
        }
        
        const now = new Date();
        const endTime = new Date(epochInfo.end_time);
        const diff = endTime - now;
        
        if (diff <= 0) {
            document.getElementById('epoch-countdown').innerHTML = '<span class="text-green-400">Ending soon!</span>';
            // Recalculate epoch in case it changed
            calculateCurrentEpoch();
            return;
        }
        
        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
        const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        
        let countdownStr = '';
        if (days > 0) {
            countdownStr = `${days}d ${hours}h ${minutes}m`;
        } else if (hours > 0) {
            countdownStr = `${hours}h ${minutes}m`;
        } else {
            countdownStr = `${minutes}m`;
        }
        
        document.getElementById('epoch-countdown').textContent = countdownStr;
    }
    
    function updateDataNotice(dataEpoch, snapshotTime) {
        const notice = document.getElementById('data-notice');
        const noticeText = document.getElementById('data-notice-text');
        const liveEpoch = store.currentRealEpoch;
        
        if (!liveEpoch || dataEpoch === liveEpoch) {
            // Data is current epoch - hide notice
            notice.classList.add('hidden');
            return;
        }
        
        // Viewing historical data - show compact notice
        notice.classList.remove('hidden');
        const epochsBehind = liveEpoch - dataEpoch;
        noticeText.innerHTML = `<i class="fas fa-history mr-1"></i>${epochsBehind} epoch${epochsBehind > 1 ? 's' : ''} behind`;
    }
    
    // ============================================================
    // DATA LOADING
    // ============================================================
    async function loadEpochData(epoch, phase) {
        updateStatus('Loading...');
        
        try {
            const url = `${CONFIG.baseUrl}/tla-data-epoch-${epoch}-${phase}.json`;
            const adaoUrl = `${CONFIG.adaoUrl}/adao-snap_${epoch}_${phase}.json`;
            console.log('Fetching TLA:', url);
            console.log('Fetching aDAO:', adaoUrl);
            
            // Fetch TLA data
            const response = await fetch(url);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            
            const data = await response.json();
            store.data = data;
            store.epoch = epoch;
            store.phase = phase;
            
            // Extract pools
            store.pools = data.pools || [];
            store.tlaPools = data.tla?.pools || [];
            store.tlaInactivePools = data.tla?.inactive_pools || [];
            store.dao = data.dao || null;
            
            // Try to fetch matching aDAO snap (don't fail if missing)
            try {
                const adaoResponse = await fetch(adaoUrl);
                if (adaoResponse.ok) {
                    store.adaoSnap = await adaoResponse.json();
                    console.log('aDAO snap loaded, Luna price:', store.adaoSnap.lunaPrice_USD);
                } else {
                    store.adaoSnap = null;
                    console.log('aDAO snap not found for this epoch/phase');
                }
            } catch (adaoErr) {
                store.adaoSnap = null;
                console.log('aDAO snap fetch error:', adaoErr.message);
            }
            
            // Fetch PD bribes master file (only once, it's shared across epochs)
            if (!store.pdBribesData) {
                try {
                    const pdResponse = await fetch(CONFIG.pdBribesUrl);
                    if (pdResponse.ok) {
                        store.pdBribesData = await pdResponse.json();
                        console.log('PD Bribes master file loaded:', store.pdBribesData.length, 'epoch ranges');
                    }
                } catch (pdErr) {
                    console.log('PD Bribes fetch error:', pdErr.message);
                }
            }
            
            store.loaded = true;
            
            populateUI();
            
            // Get timestamp from aDAO snap or TLA data
            const snapshotTime = store.adaoSnap?.timestamp || store.data?.meta?.generated_at;
            updateStatus('Loaded', snapshotTime);
            
        } catch (error) {
            console.error('Error loading data:', error);
            updateStatus('Error');
            showError('Failed to load epoch data. Check console for details.');
        }
    }
    
    function updateStatus(status, timestamp) {
        const el = document.getElementById('load-status');
        if (status === 'Loaded') {
            // Format timestamp in UTC if provided
            let timeStr = '';
            if (timestamp) {
                const date = new Date(timestamp);
                timeStr = date.toLocaleDateString('en-US', { 
                    month: 'short', 
                    day: 'numeric',
                    hour: 'numeric',
                    minute: '2-digit',
                    timeZone: 'UTC'
                }) + ' UTC';
            }
            el.innerHTML = `<div class="text-[10px] text-gray-500">Data Snapshot</div><div class="text-cyan-400 font-bold">Epoch ${store.epoch}</div>${timeStr ? `<div class="text-[10px] text-gray-400">${timeStr}</div>` : ''}`;
            el.className = 'text-xs text-center';
            
            // Update the data notice
            updateDataNotice(store.epoch, timestamp);
        } else if (status === 'Error') {
            el.innerHTML = '<i class="fas fa-exclamation-circle text-red-500 mr-1"></i> Error';
            el.className = 'text-xs text-red-400';
        } else {
            el.innerHTML = '<i class="fas fa-circle-notch fa-spin mr-1"></i> ' + status;
            el.className = 'text-xs text-gray-500';
        }
    }
    
    function showError(msg) {
        // Could show a toast/modal, for now just console
        console.error(msg);
    }
    
    // ============================================================
    // POPULATE UI
    // ============================================================
    function populateUI() {
        if (!store.data) return;
        
        const data = store.data;
        
        const activePools = store.pools.filter(p => p.is_active !== false);
        
        // Astroport active pools
        const astroPools = activePools.filter(p => p.dex?.includes('Astro'));
        document.getElementById('stat-astro-pools').textContent = astroPools.length;
        
        // Skeleton Swap active pools  
        const wwPools = activePools.filter(p => p.dex?.includes('White'));
        document.getElementById('stat-ww-pools').textContent = wwPools.length;
        
        // TLA Epoch Rewards in LUNA (using Luna price from aDAO snap)
        const totalRewardsPerYearUSD = store.tlaPools.reduce((sum, p) => sum + (p.rewards_per_year || 0), 0);
        const lunaPrice = store.adaoSnap?.lunaPrice_USD || 0.073; // Fallback price
        
        if (lunaPrice > 0) {
            const totalRewardsPerYearLuna = totalRewardsPerYearUSD / lunaPrice;
            const epochRewardsLuna = totalRewardsPerYearLuna / 52;
            document.getElementById('stat-epoch-rewards').textContent = fmtNumComma(epochRewardsLuna) + ' LUNA';
            document.getElementById('stat-epoch-rewards-sub').textContent = `≈ ${fmt$(totalRewardsPerYearUSD / 52)} @ $${lunaPrice.toFixed(4)}`;
        } else {
            const epochRewardsUSD = totalRewardsPerYearUSD / 52;
            document.getElementById('stat-epoch-rewards').textContent = fmt$(epochRewardsUSD);
            document.getElementById('stat-epoch-rewards-sub').textContent = '';
        }
        
        // Calculate bribes from PD bribes master file
        let pdBribesLuna = 0;
        let pdBribesUSD = 0;
        let pdBribesByPool = {}; // Map pool name -> {luna, usd, percent, bucket}
        
        if (store.pdBribesData) {
            // Find epoch range that contains current epoch
            const currentEpoch = store.epoch;
            const matchingRange = store.pdBribesData.find(range => 
                currentEpoch >= range.start_epoch && currentEpoch <= range.end_epoch
            );
            
            if (matchingRange) {
                console.log('Found PD bribes for epoch range:', matchingRange.epoch_range);
                
                // Build map of PD bribes by pool name
                matchingRange.bribes.forEach(bribe => {
                    const luna = bribe.luna_per_epoch || 0;
                    // Use usd_per_epoch directly if available, otherwise calculate from luna
                    const usd = bribe.usd_per_epoch || (luna * lunaPrice);
                    
                    pdBribesLuna += luna;
                    pdBribesUSD += usd;
                    
                    pdBribesByPool[bribe.pool] = {
                        luna: luna,
                        usd: usd,
                        percent: bribe.percent || 0,
                        bucket: bribe.gauge?.toLowerCase() || 'other'
                    };
                    
                    console.log(`PD bribe: ${bribe.pool} = ${luna} LUNA / $${usd.toFixed(2)} (gauge: ${bribe.gauge})`);
                });
                
                console.log('PD bribes pools:', Object.keys(pdBribesByPool));
                console.log('Total PD bribes:', pdBribesLuna, 'LUNA / $', pdBribesUSD.toFixed(2));
            } else {
                console.log('No PD bribes found for epoch', currentEpoch);
            }
        }
        
        // Get other bribes from pools - check all possible field names
        let otherBribesByPool = {}; // Map pool name -> {usd, bucket}
        let totalOtherBribesUSD = 0;
        
        // Helper to normalize pool names for matching (handles FUEL-LUNA vs LUNA-FUEL)
        function normalizePoolName(name) {
            if (!name) return '';
            const parts = name.toUpperCase().split('-');
            return parts.sort().join('-');
        }
        
        store.pools.forEach(p => {
            // Check various possible field names for other bribes
            const otherUSD = p.bribes_other || p.other_bribes || p.bribes_usd || 0;
            if (otherUSD > 0) {
                // Store with both original name and normalized name
                otherBribesByPool[p.name] = {
                    usd: otherUSD,
                    bucket: p.bucket?.toLowerCase() || 'other',
                    originalName: p.name
                };
                // Also store normalized version for matching
                otherBribesByPool[normalizePoolName(p.name)] = {
                    usd: otherUSD,
                    bucket: p.bucket?.toLowerCase() || 'other',
                    originalName: p.name
                };
                totalOtherBribesUSD += otherUSD;
                console.log('Found other bribes for', p.name, '(normalized:', normalizePoolName(p.name), '):', otherUSD);
            }
        });
        
        console.log('Other bribes pools:', Object.keys(otherBribesByPool));
        console.log('Total other bribes USD:', totalOtherBribesUSD);
        
        // Merge all pools with any bribes into buckets
        let allBribedPools = {}; // bucket -> [{pool, pdLuna, pdUSD, otherUSD, percent}]
        const buckets = ['stable', 'project', 'bluechip', 'single'];
        buckets.forEach(b => allBribedPools[b] = []);
        
        // Track which other-bribe pools we've matched
        const matchedOtherPools = new Set();
        
        // Add all PD bribed pools
        Object.entries(pdBribesByPool).forEach(([poolName, pd]) => {
            const bucket = pd.bucket;
            if (!allBribedPools[bucket]) allBribedPools[bucket] = [];
            
            // Try to find matching other bribes (check both original and normalized names)
            let other = otherBribesByPool[poolName] || otherBribesByPool[normalizePoolName(poolName)];
            if (other) {
                matchedOtherPools.add(poolName);
                matchedOtherPools.add(normalizePoolName(poolName));
                if (other.originalName) matchedOtherPools.add(other.originalName);
            }
            
            allBribedPools[bucket].push({
                pool: poolName,
                pdLuna: pd.luna,
                pdUSD: pd.usd,
                otherUSD: other?.usd || 0,
                percent: pd.percent,
                bucket: bucket
            });
        });
        
        // Add pools that ONLY have other bribes (not matched to any PD pool)
        Object.entries(otherBribesByPool).forEach(([poolName, other]) => {
            // Skip normalized duplicates and already matched pools
            if (matchedOtherPools.has(poolName)) return;
            if (matchedOtherPools.has(normalizePoolName(poolName))) return;
            
            const bucket = other.bucket;
            if (!allBribedPools[bucket]) allBribedPools[bucket] = [];
            
            allBribedPools[bucket].push({
                pool: other.originalName || poolName,
                pdLuna: 0,
                pdUSD: 0,
                otherUSD: other.usd,
                percent: 0,
                bucket: bucket
            });
            console.log('Added other-only bribe pool:', poolName, 'to bucket:', bucket);
        });
        
        const totalBribesUSD = pdBribesUSD + totalOtherBribesUSD;
        
        // Store for modal
        store.bribesData = {
            pdLuna: pdBribesLuna,
            pdUSD: pdBribesUSD,
            allBribedPools: allBribedPools,
            otherUSD: totalOtherBribesUSD,
            totalUSD: totalBribesUSD,
            lunaPrice: lunaPrice
        };
        
        console.log('Bribes data from pools:');
        
        // Log bribes from pool data (already in the data)
        let totalBribesFromPools = 0;
        store.pools.forEach(p => {
            if ((p.bribes_total || 0) > 0) {
                console.log(`${p.name}: Total=$${(p.bribes_total || 0).toFixed(2)}, PD=$${(p.bribes_pd || 0).toFixed(2)}, Other=$${(p.bribes_other || 0).toFixed(2)}`);
                totalBribesFromPools += p.bribes_total || 0;
            }
        });
        console.log('Total bribes from pools:', totalBribesFromPools.toFixed(2));
        
        // Update the total bribes display with pool data
        document.getElementById('stat-total-bribes').textContent = fmt$(totalBribesFromPools);
        
        // Average APRs (only from active TLA pools with APR > 0)
        const activePoolsWithApr = store.tlaPools.filter(p => p.apr_non_amp > 0 || p.apr_amplified > 0);
        
        const nonAmpAprs = activePoolsWithApr.map(p => p.apr_non_amp || 0).filter(a => a > 0);
        const avgNonApr = nonAmpAprs.length ? nonAmpAprs.reduce((a, b) => a + b, 0) / nonAmpAprs.length : 0;
        document.getElementById('stat-avg-apr-non').textContent = fmtPct(avgNonApr);
        
        const ampAprs = activePoolsWithApr.map(p => p.apr_amplified || 0).filter(a => a > 0);
        const avgAmpApr = ampAprs.length ? ampAprs.reduce((a, b) => a + b, 0) / ampAprs.length : 0;
        document.getElementById('stat-avg-apr-amp').textContent = fmtPct(avgAmpApr);
        
        // Last updated
        if (data.meta?.generated_at) {
            document.getElementById('last-updated').textContent = 
                'Updated: ' + new Date(data.meta.generated_at).toLocaleDateString();
        }
        
        // Render all tabs
        renderOverviewTab();
        renderPoolsTab();
        renderTlaTab();
        renderRankingsTab();
        renderDaoTab();
    }
    
    // ============================================================
    // OVERVIEW TAB
    // ============================================================
    function renderOverviewTab() {
        renderBucketCharts();
        renderTopPools();
        renderWaterfallChart('STABLE');
        setupVotionFilters();
    }
    
    function renderBucketCharts() {
        const data = store.data;
        const active = store.pools.filter(p => p.is_active !== false);
        
        // Calculate VP breakdown (corrected)
        const totalVP = data?.vote?.tvp || 0;
        const votionVP = data?.ext_data?.votion_total_vp || 4800000;
        const adaoVP = data?.dao?.locked_vp || 0;
        const otherVP = Math.max(0, totalVP - votionVP - adaoVP);
        
        // Update chart header
        document.getElementById('chart-total-vp').textContent = fmtNum(totalVP);
        
        // TLA TVL for liquidity chart (sum of tla_staked)
        const tlaTVL = store.tlaPools.reduce((sum, p) => sum + (p.tla_staked || 0), 0);
        document.getElementById('chart-tla-tvl').textContent = fmt$(tlaTVL);
        
        // VP Breakdown Chart (Votion, aDAO, Other)
        const vpLabels = ['Votion VP', 'aDAO VP', 'Other'];
        const vpData = [votionVP, adaoVP, otherVP];
        const vpColors = ['#a855f7', '#06b6d4', '#64748b'];
        
        const ctx1 = document.getElementById('vpBreakdownChart').getContext('2d');
        if (store.charts.vpBreakdown) store.charts.vpBreakdown.destroy();
        store.charts.vpBreakdown = new Chart(ctx1, {
            type: 'doughnut',
            data: {
                labels: vpLabels,
                datasets: [{
                    data: vpData,
                    backgroundColor: vpColors.map(c => c + '99'),
                    borderColor: vpColors,
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { 
                        position: 'right',
                        labels: { 
                            color: '#e2e8f0',
                            font: { size: 12, weight: '500' },
                            padding: 15,
                            generateLabels: function(chart) {
                                const data = chart.data;
                                const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
                                return data.labels.map((label, i) => {
                                    const value = data.datasets[0].data[i];
                                    const pct = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                    return {
                                        text: `${label}: ${fmtNum(value)} (${pct}%)`,
                                        fillStyle: data.datasets[0].backgroundColor[i],
                                        strokeStyle: data.datasets[0].borderColor[i],
                                        lineWidth: 2,
                                        index: i,
                                        fontColor: '#e2e8f0'
                                    };
                                });
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: ctx => {
                                const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
                                const pct = total > 0 ? ((ctx.raw / total) * 100).toFixed(1) : 0;
                                return ctx.label + ': ' + fmtNum(ctx.raw) + ' (' + pct + '%)';
                            }
                        }
                    }
                }
            }
        });
        
        // Build custom liquidity chart with TLA staked breakdown
        renderLiquidityChart();
    }
    
    function renderLiquidityChart() {
        const container = document.getElementById('bucketLiqChart');
        const buckets = ['STABLE', 'PROJECT', 'BLUECHIP', 'SINGLE'];
        
        // Calculate data per bucket from TLA pools
        const bucketData = buckets.map(bucket => {
            const bucketTlaPools = store.tlaPools.filter(p => p.bucket === bucket);
            
            let totalDepth = 0;
            let tlaAstro = 0;
            let tlaWW = 0;
            
            bucketTlaPools.forEach(pool => {
                totalDepth += pool.depth || 0;
                const staked = pool.tla_staked || 0;
                
                if (pool.dex?.includes('Astro')) {
                    tlaAstro += staked;
                } else if (pool.dex?.includes('White')) {
                    tlaWW += staked;
                }
            });
            
            return {
                bucket,
                totalDepth,
                tlaTotal: tlaAstro + tlaWW,
                tlaAstro,
                tlaWW,
                color: getBucketColor(bucket)
            };
        });
        
        // Calculate totals for scale
        const totalDexDepth = bucketData.reduce((sum, d) => sum + d.totalDepth, 0);
        const totalTlaStaked = bucketData.reduce((sum, d) => sum + d.tlaTotal, 0);
        const scaleMax = Math.ceil(Math.max(totalDexDepth, totalTlaStaked) / 500000) * 500000 || 1000000;
        
        // Calculate cumulative positions for waterfall
        let cumulative = 0;
        bucketData.forEach(d => {
            d.startY = cumulative;
            d.endY = cumulative + d.tlaTotal;
            cumulative += d.tlaTotal;
        });
        
        // Build waterfall HTML
        let html = `
            <div class="flex h-full">
                <!-- Y-axis scale -->
                <div class="flex flex-col justify-between text-[10px] text-gray-500 pr-2 py-1" style="width: 50px;">
                    <span class="text-right">${fmt$(scaleMax)}</span>
                    <span class="text-right">${fmt$(scaleMax * 0.75)}</span>
                    <span class="text-right">${fmt$(scaleMax * 0.5)}</span>
                    <span class="text-right">${fmt$(scaleMax * 0.25)}</span>
                    <span class="text-right">$0</span>
                </div>
                
                <!-- Chart area -->
                <div class="flex-1 relative border-l border-b border-white/10">
                    <!-- Grid lines -->
                    <div class="absolute inset-0 pointer-events-none">
                        <div class="absolute left-0 right-0 border-t border-white/5" style="top: 25%"></div>
                        <div class="absolute left-0 right-0 border-t border-white/5" style="top: 50%"></div>
                        <div class="absolute left-0 right-0 border-t border-white/5" style="top: 75%"></div>
                    </div>
                    
                    <!-- DEX Depth dotted line -->
                    <div class="absolute left-0 right-0 border-t-2 border-dashed border-gray-400/50 z-10" 
                         style="bottom: ${(totalDexDepth / scaleMax) * 100}%;">
                        <span class="absolute right-1 -top-4 text-[9px] text-gray-400 font-medium bg-gray-900/80 px-1 rounded">DEX Depth</span>
                    </div>
                    
                    <!-- TLA TVL dotted line -->
                    <div class="absolute left-0 right-0 border-t-2 border-dashed border-cyan-500/70 z-10" 
                         style="bottom: ${(totalTlaStaked / scaleMax) * 100}%;">
                        <span class="absolute right-1 -top-4 text-[9px] text-cyan-400 font-medium bg-gray-900/80 px-1 rounded">TLA TVL</span>
                    </div>
                    
                    <!-- Bucket columns -->
                    <div class="absolute inset-0 flex">
        `;
        
        // Add each bucket's column with waterfall bar
        bucketData.forEach((data, idx) => {
            const columnWidth = 100 / buckets.length;
            const barBottomPct = (data.startY / scaleMax) * 100;
            const barHeightPct = (data.tlaTotal / scaleMax) * 100;
            
            // Calculate Astro and WW heights within the bar
            const astroPct = data.tlaTotal > 0 ? (data.tlaAstro / data.tlaTotal) * 100 : 0;
            const wwPct = data.tlaTotal > 0 ? (data.tlaWW / data.tlaTotal) * 100 : 0;
            
            html += `
                <div class="relative group" style="width: ${columnWidth}%;">
                    <!-- Waterfall bar -->
                    <div class="absolute left-1 right-1 flex flex-col-reverse overflow-hidden rounded"
                         style="bottom: ${barBottomPct}%; height: ${barHeightPct}%;">
                        <!-- Astroport portion (bottom, dark blue) -->
                        ${data.tlaAstro > 0 ? `
                        <div class="w-full bg-blue-600" style="height: ${astroPct}%;"></div>
                        ` : ''}
                        <!-- Skeleton Swap portion (top, green) -->
                        ${data.tlaWW > 0 ? `
                        <div class="w-full bg-emerald-500" style="height: ${wwPct}%;"></div>
                        ` : ''}
                    </div>
                    
                    <!-- Bucket label at bottom -->
                    <div class="absolute -bottom-5 left-0 right-0 text-center">
                        <span class="text-[9px] font-semibold" style="color: ${data.color}">${data.bucket}</span>
                    </div>
                    
                    <!-- Tooltip -->
                    <div class="absolute opacity-0 group-hover:opacity-100 transition-opacity z-30 
                                bg-gray-900/95 border border-white/10 rounded-lg px-3 py-2 text-xs shadow-xl whitespace-nowrap pointer-events-none"
                         style="bottom: ${barBottomPct + barHeightPct + 2}%; left: 50%; transform: translateX(-50%);">
                        <div class="font-semibold mb-1" style="color: ${data.color}">${data.bucket}</div>
                        <div class="text-gray-400">DEX Depth: <span class="text-white">${fmt$(data.totalDepth)}</span></div>
                        <div class="text-cyan-400">TLA Staked: <span class="text-white">${fmt$(data.tlaTotal)}</span></div>
                        ${data.tlaAstro > 0 ? `<div class="text-blue-400 pl-2 text-[10px]">↳ Astro: ${fmt$(data.tlaAstro)} (${astroPct.toFixed(0)}%)</div>` : ''}
                        ${data.tlaWW > 0 ? `<div class="text-emerald-400 pl-2 text-[10px]">↳ WW: ${fmt$(data.tlaWW)} (${wwPct.toFixed(0)}%)</div>` : ''}
                    </div>
                </div>
            `;
        });
        
        html += `
                    </div>
                </div>
            </div>
            
            <!-- Legend -->
            <div class="flex items-center justify-center gap-4 mt-6 text-[10px]">
                <div class="flex items-center gap-1">
                    <div class="w-3 h-2 rounded bg-blue-600"></div>
                    <span class="text-gray-400">Astroport</span>
                </div>
                <div class="flex items-center gap-1">
                    <div class="w-3 h-2 rounded bg-emerald-500"></div>
                    <span class="text-gray-400">Skeleton Swap</span>
                </div>
                <div class="flex items-center gap-1">
                    <div class="w-4 border-t-2 border-dashed border-gray-400"></div>
                    <span class="text-gray-400">DEX Depth</span>
                </div>
                <div class="flex items-center gap-1">
                    <div class="w-4 border-t-2 border-dashed border-cyan-500"></div>
                    <span class="text-gray-400">TLA TVL</span>
                </div>
            </div>
        `;
        
        container.outerHTML = `<div id="bucketLiqChart" class="h-full relative flex flex-col">${html}</div>`;
    }
    
    function renderTopPools() {
        const active = store.pools.filter(p => p.is_active !== false);
        const tlaPools = store.tlaPools || [];
        
        // Create map of TLA pool data by name for quick lookup
        const tlaMap = {};
        tlaPools.forEach(tp => {
            tlaMap[tp.name] = tp;
        });
        
        // Helper to get short DEX label
        const getDexLabel = (dex) => {
            if (dex?.includes('Astro')) return '<span class="text-[9px] px-1 py-0.5 rounded bg-blue-500/20 text-blue-400">Astro</span>';
            if (dex?.includes('White')) return '<span class="text-[9px] px-1 py-0.5 rounded bg-emerald-500/20 text-emerald-400">SS</span>';
            return '';
        };
        
        // Top by Avg Volume - use vol_4ep_avg field
        const topVolume = [...active]
            .map(p => ({
                ...p,
                avgVolume: p.vol_4ep_avg || 0
            }))
            .filter(p => p.avgVolume > 0)
            .sort((a, b) => b.avgVolume - a.avgVolume)
            .slice(0, 5);
        
        document.getElementById('top-vp-pools').innerHTML = topVolume.map((p, i) => `
            <div class="flex items-center justify-between p-2 rounded-lg bg-white/[0.02] hover:bg-white/[0.04]">
                <div class="flex items-center gap-2">
                    <span class="w-6 h-6 rounded flex items-center justify-center text-xs font-bold ${i < 3 ? `rank-${i+1}` : 'bg-white/10'}">${i+1}</span>
                    <div class="flex flex-col">
                        <span class="text-sm font-medium">${p.name}</span>
                        <div class="flex items-center gap-1">${getDexLabel(p.dex)}</div>
                    </div>
                </div>
                <span class="mono text-orange-400 text-sm">${fmt$(p.avgVolume)}</span>
            </div>
        `).join('') || '<div class="text-gray-500 text-sm">No volume data</div>';
        
        // Top by Avg DEX Liquidity (liq_4ep_avg)
        const topLiquidity = [...active]
            .map(p => ({
                ...p,
                avgLiquidity: p.liq_4ep_avg || 0
            }))
            .filter(p => p.avgLiquidity > 0)
            .sort((a, b) => b.avgLiquidity - a.avgLiquidity)
            .slice(0, 5);
        
        document.getElementById('top-depth-pools').innerHTML = topLiquidity.map((p, i) => `
            <div class="flex items-center justify-between p-2 rounded-lg bg-white/[0.02] hover:bg-white/[0.04]">
                <div class="flex items-center gap-2">
                    <span class="w-6 h-6 rounded flex items-center justify-center text-xs font-bold ${i < 3 ? `rank-${i+1}` : 'bg-white/10'}">${i+1}</span>
                    <div class="flex flex-col">
                        <span class="text-sm font-medium">${p.name}</span>
                        <div class="flex items-center gap-1">${getDexLabel(p.dex)}</div>
                    </div>
                </div>
                <span class="mono text-cyan-400 text-sm">${fmt$(p.avgLiquidity)}</span>
            </div>
        `).join('') || '<div class="text-gray-500 text-sm">No liquidity data</div>';
        
        // Top by APR
        const topAPR = [...active].filter(p => p.apr_amp > 0).sort((a, b) => (b.apr_amp || 0) - (a.apr_amp || 0)).slice(0, 5);
        document.getElementById('top-apr-pools').innerHTML = topAPR.map((p, i) => `
            <div class="flex items-center justify-between p-2 rounded-lg bg-white/[0.02] hover:bg-white/[0.04]">
                <div class="flex items-center gap-2">
                    <span class="w-6 h-6 rounded flex items-center justify-center text-xs font-bold ${i < 3 ? `rank-${i+1}` : 'bg-white/10'}">${i+1}</span>
                    <div class="flex flex-col">
                        <span class="text-sm font-medium">${p.name}</span>
                        <div class="flex items-center gap-1">${getDexLabel(p.dex)}</div>
                    </div>
                </div>
                <span class="mono text-green-400 text-sm">${fmtPct(p.apr_amp)}</span>
            </div>
        `).join('');
    }
    
    function renderWaterfallChart(filterBucket = 'STABLE') {
        const container = document.getElementById('waterfall-bars');
        
        // Get pools for this bucket
        let pools = store.pools
            .filter(p => p.bucket === filterBucket)
            .sort((a, b) => (b.vp || 0) - (a.vp || 0));
        
        // Calculate bucket totals
        const bucketTotalVP = pools.reduce((sum, p) => sum + (p.vp || 0), 0);
        const bucketVotionVP = pools.reduce((sum, p) => sum + (p.votion_now_vp || 0), 0);
        const bucketAdaoVP = pools.reduce((sum, p) => sum + (p.adao_vp || 0), 0);
        const bucketOtherVP = Math.max(0, bucketTotalVP - bucketVotionVP - bucketAdaoVP);
        
        // Calculate percentages
        const votionPct = bucketTotalVP > 0 ? (bucketVotionVP / bucketTotalVP) * 100 : 0;
        const adaoPct = bucketTotalVP > 0 ? (bucketAdaoVP / bucketTotalVP) * 100 : 0;
        const otherPct = bucketTotalVP > 0 ? (bucketOtherVP / bucketTotalVP) * 100 : 0;
        
        // Round up to nice number for scale
        const scaleMax = Math.ceil(bucketTotalVP / 1000000) * 1000000 || 1000000;
        
        // Update displays
        document.getElementById('waterfall-total').textContent = fmtNum(bucketTotalVP) + ' VP';
        document.getElementById('waterfall-votion').textContent = `${fmtNum(bucketVotionVP)} / ${votionPct.toFixed(1)}%`;
        document.getElementById('waterfall-adao').textContent = `${fmtNum(bucketAdaoVP)} / ${adaoPct.toFixed(1)}%`;
        document.getElementById('waterfall-other').textContent = `${fmtNum(bucketOtherVP)} / ${otherPct.toFixed(1)}%`;
        document.getElementById('scale-max').textContent = fmtNum(scaleMax);
        document.getElementById('scale-25').textContent = fmtNum(scaleMax * 0.25);
        document.getElementById('scale-50').textContent = fmtNum(scaleMax * 0.50);
        document.getElementById('scale-75').textContent = fmtNum(scaleMax * 0.75);
        
        if (pools.length === 0) {
            container.innerHTML = '<div class="text-center text-gray-500 py-8">No pools in this bucket</div>';
            return;
        }
        
        // Build waterfall bars
        let html = '';
        let cumulative = 0;
        
        pools.forEach((pool, idx) => {
            const poolVP = pool.vp || 0;
            const votionVP = pool.votion_now_vp || 0;
            const adaoVP = pool.adao_vp || 0;
            const otherVP = Math.max(0, poolVP - votionVP - adaoVP);
            
            // Calculate start position and width as percentage of scale
            const startPct = (cumulative / scaleMax) * 100;
            const poolWidthPct = (poolVP / scaleMax) * 100;
            
            // Determine if pool is active or inactive
            const isActive = pool.is_active !== false;
            const activeClass = isActive ? '' : 'opacity-60';
            const activeLabel = isActive ? '' : '<span class="text-red-400 text-[10px] ml-1">[INACT]</span>';
            
            // Calculate sub-segment widths (as % of pool's width)
            const votionPct = poolVP > 0 ? (votionVP / poolVP) * 100 : 0;
            const adaoPct = poolVP > 0 ? (adaoVP / poolVP) * 100 : 0;
            const otherPct = poolVP > 0 ? (otherVP / poolVP) * 100 : 0;
            
            html += `
                <div class="waterfall-row group ${activeClass}" style="height: 44px;">
                    <!-- Pool name label on left -->
                    <div class="absolute left-1 top-0 h-full flex flex-col justify-center z-20 pointer-events-none" style="max-width: ${Math.max(startPct - 1, 0)}%;">
                        <span class="text-xs text-gray-300 font-medium truncate leading-tight">
                            ${pool.name}${activeLabel}
                        </span>
                        <span class="text-[9px] ${pool.dex?.includes('Astro') ? 'text-red-400' : 'text-emerald-400'} truncate leading-tight">
                            ${pool.dex?.includes('Astro') ? 'Astro' : 'SS'}
                        </span>
                    </div>
                    
                    <!-- The stacked bar -->
                    <div class="absolute top-1.5 bottom-1.5 flex rounded overflow-hidden shadow-lg" 
                         style="left: ${startPct}%; width: ${Math.max(poolWidthPct, 0.5)}%;">
                        ${votionVP > 0 ? `<div class="h-full" style="width: ${votionPct}%; background: rgba(168, 85, 247, 0.9);"></div>` : ''}
                        ${adaoVP > 0 ? `<div class="h-full" style="width: ${adaoPct}%; background: rgba(6, 182, 212, 0.9);"></div>` : ''}
                        ${otherVP > 0 ? `<div class="h-full" style="width: ${otherPct}%; background: rgba(245, 158, 11, 0.7);"></div>` : ''}
                    </div>
                    
                    <!-- Pool name inside bar if bar is wide enough -->
                    ${poolWidthPct > 15 ? `
                    <div class="absolute top-0 h-full flex flex-col justify-center z-20 pointer-events-none" style="left: ${startPct + 0.5}%;">
                        <span class="text-xs text-white font-medium drop-shadow-lg px-2 leading-tight">
                            ${pool.name}${activeLabel}
                        </span>
                        <span class="text-[9px] ${pool.dex?.includes('Astro') ? 'text-red-300' : 'text-emerald-300'} drop-shadow-lg px-2 leading-tight">
                            ${pool.dex?.includes('Astro') ? 'Astro' : 'SS'}
                        </span>
                    </div>
                    ` : ''}
                    
                    <!-- Tooltip on hover -->
                    <div class="absolute opacity-0 group-hover:opacity-100 transition-opacity z-30 pointer-events-none
                                bg-gray-900/95 border border-white/10 rounded-lg px-3 py-2 text-xs shadow-xl"
                         style="left: ${Math.min(startPct + poolWidthPct/2, 70)}%; top: 100%; margin-top: 4px; min-width: 180px;">
                        <div class="font-semibold text-white mb-1">${pool.name} <span class="text-gray-400 font-normal">(${pool.dex})</span></div>
                        <div class="text-gray-300">Total VP: <span class="text-cyan-400 font-mono">${fmtNum(poolVP)}</span></div>
                        ${votionVP > 0 ? `<div class="text-purple-400">Votion: ${fmtNum(votionVP)} (${votionPct.toFixed(1)}%)</div>` : ''}
                        ${adaoVP > 0 ? `<div class="text-cyan-400">aDAO: ${fmtNum(adaoVP)} (${adaoPct.toFixed(1)}%)</div>` : ''}
                        ${otherVP > 0 ? `<div class="text-amber-400">Other: ${fmtNum(otherVP)} (${otherPct.toFixed(1)}%)</div>` : ''}
                    </div>
                </div>
            `;
            
            cumulative += poolVP;
        });
        
        container.innerHTML = html;
    }
    
    // Bucket filter event listeners for waterfall
    function setupVotionFilters() {
        document.querySelectorAll('.votion-bucket-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                // Update active state
                document.querySelectorAll('.votion-bucket-btn').forEach(b => {
                    b.classList.remove('active', 'bg-white/10', 'text-white');
                });
                btn.classList.add('active', 'bg-white/10', 'text-white');
                
                // Re-render chart with filter
                renderWaterfallChart(btn.dataset.bucket);
            });
        });
    }
    
    // ============================================================
    // POOLS TAB
    // ============================================================
    function renderPoolsTab() {
        loadHistoricalData().then(() => {
            renderPoolsByBucket();
        });
    }
    
    // Historical chart state
    let historicalState = {
        data: null
    };
    
    async function loadHistoricalData() {
        if (historicalState.data) {
            return;
        }
        
        try {
            const response = await fetch(CONFIG.historicalUrl);
            historicalState.data = await response.json();
            console.log('Historical data loaded:', Object.keys(historicalState.data.lps || {}).length, 'LPs');
        } catch (error) {
            console.error('Failed to load historical data:', error);
        }
    }
    
    function renderPoolsByBucket() {
        const search = document.getElementById('pool-search').value.toLowerCase();
        const bucketFilter = document.getElementById('bucket-filter').value;
        const dexFilter = document.getElementById('dex-filter').value;
        const includeInactive = document.getElementById('active-only').checked;
        
        // Group pools by bucket
        const buckets = ['STABLE', 'PROJECT', 'BLUECHIP', 'SINGLE'];
        const container = document.getElementById('pools-by-bucket');
        
        let html = '';
        
        buckets.forEach(bucket => {
            if (bucketFilter !== 'all' && bucketFilter !== bucket) return;
            
            let pools = store.pools.filter(p => p.bucket === bucket);
            
            // Apply filters
            if (search) {
                pools = pools.filter(p => p.name.toLowerCase().includes(search));
            }
            if (dexFilter !== 'all') {
                pools = pools.filter(p => p.dex?.includes(dexFilter.substring(0, 5)));
            }
            
            // Separate active and inactive
            const activePools = pools.filter(p => p.is_active !== false);
            const inactivePools = pools.filter(p => p.is_active === false);
            
            // Sort active A-Z, inactive by TLA vote desc
            activePools.sort((a, b) => a.name.localeCompare(b.name));
            inactivePools.sort((a, b) => (b.vp || 0) - (a.vp || 0));
            
            // Combine
            let sortedPools = [...activePools];
            if (includeInactive) {
                sortedPools = [...activePools, ...inactivePools];
            }
            
            if (sortedPools.length === 0) return;
            
            // Bucket totals
            const totalVP = activePools.reduce((sum, p) => sum + (p.vp || 0), 0);
            const totalAdaoVP = activePools.reduce((sum, p) => sum + (p.adao_vp || 0), 0);
            
            const bucketColors = {
                'STABLE': { text: 'text-cyan-400', border: 'border-cyan-500/30', bg: 'bg-cyan-500/5', accent: '#06b6d4' },
                'PROJECT': { text: 'text-amber-400', border: 'border-amber-500/30', bg: 'bg-amber-500/5', accent: '#f59e0b' },
                'BLUECHIP': { text: 'text-blue-400', border: 'border-blue-500/30', bg: 'bg-blue-500/5', accent: '#3b82f6' },
                'SINGLE': { text: 'text-purple-400', border: 'border-purple-500/30', bg: 'bg-purple-500/5', accent: '#a855f7' }
            };
            
            const colors = bucketColors[bucket];
            
            html += `
                <div class="bucket-section" data-bucket="${bucket}">
                    <!-- Bucket Header -->
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-3">
                            <span class="text-xl font-bold ${colors.text} uppercase">${bucket}</span>
                            <span class="text-sm text-gray-400">${activePools.length} active${inactivePools.length > 0 && includeInactive ? `, ${inactivePools.length} inactive` : ''}</span>
                        </div>
                        <div class="flex items-center gap-4 text-sm">
                            <span class="text-gray-400">TLA: <span class="mono text-orange-400">${fmtNum(totalVP)}</span></span>
                            <span class="text-gray-400">aDAO: <span class="mono text-cyan-400">${fmtNum(totalAdaoVP)}</span></span>
                        </div>
                    </div>
                    
                    <!-- Historical Chart for this bucket -->
                    <div class="glass-card p-4 mb-4">
                        <div class="flex items-center justify-between mb-3">
                            <div class="text-sm text-gray-400">
                                <i class="fas fa-chart-line mr-2"></i>Historical Liquidity & Volume
                                <span class="text-[10px] text-gray-500 ml-2">Solid = Liq, Dashed = Vol</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <select class="scale-select epoch-select text-xs" data-bucket="${bucket}" onchange="updateBucketChartScale('${bucket}', this.value)">
                                    <option value="all">All LPs</option>
                                    <option value="top">Top Tier ($100K+)</option>
                                    <option value="mid">Mid Tier ($10K-$100K)</option>
                                    <option value="low">Low Tier (<$10K)</option>
                                </select>
                            </div>
                        </div>
                        <div class="relative h-[350px]">
                            <canvas id="chart-${bucket}" class="w-full h-full"></canvas>
                        </div>
                        <div id="legend-${bucket}" class="flex flex-wrap gap-2 mt-2 text-[10px]"></div>
                    </div>
                    
                    <!-- Pool Table -->
                    <div class="glass-card overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="data-table text-sm">
                                <thead>
                                    <tr>
                                        <th class="text-left" title="Pool name, DEX, and pool type (PCL, Stable, XYK)">Pool</th>
                                        <th class="text-center" title="Active = receiving TLA rewards, Inactive = no rewards">Status</th>
                                        <th class="text-right" title="Average DEX liquidity over the last 4 epochs (~28 days)">4EP Avg Liq</th>
                                        <th class="text-right" title="Average trading volume over the last 4 epochs (~28 days)">4EP Avg Vol</th>
                                        <th class="text-right" title="Annual Percentage Rate. Top: Amplified (with boost), Bottom: Non-amplified (base)">APR</th>
                                        <th class="text-right" title="Current Votion protocol votes. Top: Vote power, Bottom: % of bucket total">Votion Now</th>
                                        <th class="text-right" title="Change in Votion votes from current to next epoch">Δ Vote</th>
                                        <th class="text-right" title="Projected Votion votes for next epoch. Top: Vote power, Bottom: % of bucket total">Votion Next</th>
                                        <th class="text-right" title="Total bribes this epoch. Top: Total USD, Bottom: Phoenix Directive contribution">Bribes</th>
                                        <th class="text-right" title="TLA (Terra Liquidity Alliance) votes. Top: Vote power, Bottom: % of bucket total">TLA Vote</th>
                                        <th class="text-right" title="Alliance DAO votes. Top: Vote power, Bottom: % of bucket total">aDAO Vote</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${sortedPools.map(p => renderPoolRow(p)).join('')}
                                </tbody>
                                <tfoot>
                                    <tr class="border-t border-white/10 ${colors.bg}">
                                        <td colspan="5" class="font-bold uppercase ${colors.text}">${bucket} Totals</td>
                                        <td class="text-right mono">
                                            <div class="text-purple-400">${fmtNum(activePools.reduce((s, p) => s + (p.votion_now_vp || 0), 0))}</div>
                                            <div class="text-[10px] text-gray-500">${fmtPct(totalVP > 0 ? (activePools.reduce((s, p) => s + (p.votion_now_vp || 0), 0) / totalVP) * 100 : 0)}</div>
                                        </td>
                                        <td class="text-right">-</td>
                                        <td class="text-right mono">
                                            <div class="text-purple-400">${fmtNum(activePools.reduce((s, p) => s + (p.votion_next_vp || 0), 0))}</div>
                                        </td>
                                        <td class="text-right mono text-amber-400">
                                            ${fmt$(calculateBucketBribes(bucket))}
                                        </td>
                                        <td class="text-right mono">
                                            <div class="text-orange-400">${fmtNum(totalVP)}</div>
                                            <div class="text-[10px] text-gray-500">100%</div>
                                        </td>
                                        <td class="text-right mono">
                                            <div class="text-cyan-400">${fmtNum(totalAdaoVP)}</div>
                                            <div class="text-[10px] text-gray-500">${fmtPct(totalVP > 0 ? (totalAdaoVP / totalVP) * 100 : 0)}</div>
                                        </td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html || '<div class="text-center text-gray-500 py-8">No pools match filters</div>';
        
        // Render charts for each bucket after DOM is updated
        setTimeout(() => {
            buckets.forEach(bucket => {
                if (bucketFilter !== 'all' && bucketFilter !== bucket) return;
                renderBucketChart(bucket, 'all');
            });
        }, 100);
    }
    
    function calculateBucketBribes(bucket) {
        // Sum bribes from pool objects (bribes_total is in the original data)
        return store.pools
            .filter(p => p.bucket === bucket)
            .reduce((sum, p) => sum + (p.bribes_total || 0), 0);
    }
    
    // Bucket chart instances and state
    const bucketCharts = {};
    const bucketChartState = {};
    
    function renderBucketChart(bucket, scaleFilter = 'all') {
        const canvas = document.getElementById(`chart-${bucket}`);
        if (!canvas || !historicalState.data) return;
        
        const data = historicalState.data;
        const bucketPools = store.pools.filter(p => p.bucket === bucket && p.is_active !== false);
        const lpKeys = bucketPools.map(p => `${p.name}|${p.dex}`);
        
        // Get epochs
        let epochs = [];
        for (const lpKey of lpKeys) {
            if (data.lps[lpKey]?.liquidity?.epochs) {
                epochs = Object.keys(data.lps[lpKey].liquidity.epochs).map(Number).sort((a, b) => a - b);
                break;
            }
        }
        
        if (epochs.length === 0) return;
        
        // Filter LPs by scale tier
        const filteredLpKeys = lpKeys.filter(lpKey => {
            const lpData = data.lps[lpKey];
            if (!lpData) return false;
            
            // Get latest liquidity value
            const lastEpoch = epochs[epochs.length - 1];
            const avgLiq = lpData.liquidity?.epochs?.[lastEpoch]?.avg || 0;
            
            if (scaleFilter === 'top') return avgLiq >= 100000;
            if (scaleFilter === 'mid') return avgLiq >= 10000 && avgLiq < 100000;
            if (scaleFilter === 'low') return avgLiq < 10000;
            return true; // 'all'
        });
        
        const colors = [
            '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', 
            '#ec4899', '#06b6d4', '#84cc16', '#f97316', '#6366f1'
        ];
        
        // Store state for this bucket
        bucketChartState[bucket] = {
            lpKeys: filteredLpKeys,
            colors: colors,
            scaleFilter: scaleFilter,
            selectedLP: null,
            epochs: epochs
        };
        
        rebuildBucketChart(bucket);
    }
    
    function rebuildBucketChart(bucket) {
        const state = bucketChartState[bucket];
        if (!state) return;
        
        const canvas = document.getElementById(`chart-${bucket}`);
        if (!canvas) return;
        
        const data = historicalState.data;
        const { lpKeys, colors, selectedLP, epochs } = state;
        
        const datasets = [];
        let colorIdx = 0;
        let maxLiq = 0, maxVol = 0;
        
        // Calculate max values only for visible LPs
        lpKeys.forEach(lpKey => {
            if (selectedLP && selectedLP !== lpKey) return;
            const lpData = data.lps[lpKey];
            if (!lpData) return;
            
            epochs.forEach(ep => {
                const liq = lpData.liquidity?.epochs?.[ep]?.avg || 0;
                const vol = lpData.volume?.epochs?.[ep]?.avg || 0;
                if (liq > maxLiq) maxLiq = liq;
                if (vol > maxVol) maxVol = vol;
            });
        });
        
        lpKeys.forEach((lpKey, idx) => {
            const lpData = data.lps[lpKey];
            if (!lpData) return;
            
            const color = colors[idx % colors.length];
            const lpName = lpKey.split('|')[0];
            const isVisible = !selectedLP || selectedLP === lpKey;
            const opacity = isVisible ? 1 : 0.1;
            
            // Liquidity (solid)
            datasets.push({
                label: `${lpName} Liq`,
                data: epochs.map(ep => lpData.liquidity?.epochs?.[ep]?.avg || null),
                borderColor: isVisible ? color : color + '20',
                backgroundColor: 'transparent',
                borderWidth: isVisible ? 2 : 1,
                tension: 0.3,
                pointRadius: isVisible ? 2 : 0,
                yAxisID: 'y',
                hidden: !isVisible && selectedLP
            });
            
            // Volume (dashed)
            datasets.push({
                label: `${lpName} Vol`,
                data: epochs.map(ep => lpData.volume?.epochs?.[ep]?.avg || null),
                borderColor: isVisible ? color : color + '20',
                backgroundColor: 'transparent',
                borderWidth: isVisible ? 1.5 : 1,
                borderDash: [4, 4],
                tension: 0.3,
                pointRadius: isVisible ? 2 : 0,
                yAxisID: 'y1',
                hidden: !isVisible && selectedLP
            });
            
            colorIdx++;
        });
        
        // Destroy existing chart
        if (bucketCharts[bucket]) {
            bucketCharts[bucket].destroy();
        }
        
        const ctx = canvas.getContext('2d');
        bucketCharts[bucket] = new Chart(ctx, {
            type: 'line',
            data: {
                labels: epochs.map(e => e.toString()),
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: ctx => `${ctx.dataset.label}: ${fmt$(ctx.parsed.y)}`
                        }
                    }
                },
                scales: {
                    x: {
                        grid: { color: 'rgba(255,255,255,0.03)' },
                        ticks: { color: '#6b7280', font: { size: 9 } }
                    },
                    y: {
                        position: 'left',
                        grid: { color: 'rgba(255,255,255,0.03)' },
                        ticks: { color: '#06b6d4', font: { size: 9 }, callback: v => fmt$(v) },
                        suggestedMax: maxLiq * 1.1
                    },
                    y1: {
                        position: 'right',
                        grid: { drawOnChartArea: false },
                        ticks: { color: '#f59e0b', font: { size: 9 }, callback: v => fmt$(v) },
                        suggestedMax: maxVol * 1.1
                    }
                }
            }
        });
        
        // Update interactive legend
        updateBucketLegend(bucket);
    }
    
    function updateBucketLegend(bucket) {
        const state = bucketChartState[bucket];
        if (!state) return;
        
        const legendDiv = document.getElementById(`legend-${bucket}`);
        if (!legendDiv) return;
        
        const { lpKeys, colors, selectedLP } = state;
        
        let legendHtml = '';
        lpKeys.forEach((lpKey, i) => {
            const lpName = lpKey.split('|')[0];
            const color = colors[i % colors.length];
            const isSelected = selectedLP === lpKey;
            const opacity = selectedLP && !isSelected ? 'opacity-30' : '';
            
            legendHtml += `
                <span class="legend-item flex items-center gap-1 px-2 py-1 rounded cursor-pointer hover:bg-white/10 transition-all ${opacity} ${isSelected ? 'bg-white/10 ring-1 ring-white/20' : ''}"
                      data-bucket="${bucket}" 
                      data-lp="${lpKey}"
                      onmouseenter="highlightLP('${bucket}', '${lpKey}')"
                      onmouseleave="unhighlightLP('${bucket}')"
                      onclick="selectLP('${bucket}', '${lpKey}')">
                    <span class="w-3 h-0.5" style="background:${color}"></span>
                    <span class="w-3 h-0.5 border-t border-dashed" style="border-color:${color}"></span>
                    <span>${lpName}</span>
                </span>
            `;
        });
        
        // Add clear selection button if something is selected
        if (selectedLP) {
            legendHtml += `
                <span class="flex items-center gap-1 px-2 py-1 rounded cursor-pointer bg-red-500/20 hover:bg-red-500/30 text-red-400 transition-all ml-2"
                      onclick="clearLPSelection('${bucket}')">
                    <i class="fas fa-times text-xs"></i>
                    <span>Clear</span>
                </span>
            `;
        }
        
        legendDiv.innerHTML = legendHtml || '<span class="text-gray-500">No data for selected tier</span>';
    }
    
    function highlightLP(bucket, lpKey) {
        const state = bucketChartState[bucket];
        if (!state || state.selectedLP) return; // Don't highlight if already selected
        
        const chart = bucketCharts[bucket];
        if (!chart) return;
        
        const lpIndex = state.lpKeys.indexOf(lpKey);
        if (lpIndex === -1) return;
        
        // Dim all other datasets
        chart.data.datasets.forEach((ds, i) => {
            const dsLpIndex = Math.floor(i / 2);
            if (dsLpIndex !== lpIndex) {
                ds.borderColor = ds.borderColor.replace(/[^,]+\)$/, '0.15)').replace(/^#([0-9a-f]{6})$/i, '$&#26');
                ds.borderWidth = 1;
            } else {
                ds.borderWidth = i % 2 === 0 ? 3 : 2;
                ds.pointRadius = 3;
            }
        });
        
        chart.update('none');
    }
    
    function unhighlightLP(bucket) {
        const state = bucketChartState[bucket];
        if (!state || state.selectedLP) return; // Don't unhighlight if something is selected
        
        rebuildBucketChart(bucket);
    }
    
    function selectLP(bucket, lpKey) {
        const state = bucketChartState[bucket];
        if (!state) return;
        
        // Toggle selection
        if (state.selectedLP === lpKey) {
            state.selectedLP = null;
        } else {
            state.selectedLP = lpKey;
        }
        
        rebuildBucketChart(bucket);
    }
    
    function clearLPSelection(bucket) {
        const state = bucketChartState[bucket];
        if (!state) return;
        
        state.selectedLP = null;
        rebuildBucketChart(bucket);
    }
    
    function updateBucketChartScale(bucket, scale) {
        renderBucketChart(bucket, scale);
    }
    
    function renderPoolRow(p) {
        const isActive = p.is_active !== false;
        const changeVP = (p.votion_next_vp || 0) - (p.votion_now_vp || 0);
        const changeClass = changeVP > 0 ? 'text-green-400' : changeVP < 0 ? 'text-red-400' : 'text-gray-500';
        const changeIcon = changeVP > 0 ? '↑' : changeVP < 0 ? '↓' : '';
        
        // Get pool type (pcl, stable, xyk, etc)
        const poolType = p.pool_type || p.type || '';
        
        // Calculate percentages
        const totalBucketVP = store.pools.filter(x => x.bucket === p.bucket && x.is_active !== false).reduce((s, x) => s + (x.vp || 0), 0);
        const tlaPct = totalBucketVP > 0 ? ((p.vp || 0) / totalBucketVP) * 100 : 0;
        const adaoPct = totalBucketVP > 0 ? ((p.adao_vp || 0) / totalBucketVP) * 100 : 0;
        const votionNowPct = totalBucketVP > 0 ? ((p.votion_now_vp || 0) / totalBucketVP) * 100 : 0;
        const votionNextPct = totalBucketVP > 0 ? ((p.votion_next_vp || 0) / totalBucketVP) * 100 : 0;
        
        // Use bribes data directly from pool object (original field names)
        const poolPdBribes = p.bribes_pd || 0;
        const poolOtherBribes = p.bribes_other || 0;
        const poolTotalBribes = p.bribes_total || 0;
        
        return `
            <tr class="${!isActive ? 'opacity-60' : ''}">
                <td>
                    <div class="font-medium">${p.name}</div>
                    <div class="text-[10px] text-gray-500">${p.dex}${poolType ? ' • ' + poolType : ''}</div>
                </td>
                <td class="text-center">
                    ${isActive 
                        ? '<span class="text-[10px] px-2 py-0.5 rounded bg-green-500/20 text-green-400">ACTIVE</span>' 
                        : '<span class="text-[10px] px-2 py-0.5 rounded bg-red-500/20 text-red-400">INACT</span>'}
                </td>
                <td class="text-right mono text-cyan-400">${p.liq_4ep_avg ? fmt$(p.liq_4ep_avg) : '-'}</td>
                <td class="text-right mono text-orange-400">${p.vol_4ep_avg ? fmt$(p.vol_4ep_avg) : '-'}</td>
                <td class="text-right">
                    <div class="mono text-green-400">${p.apr_amp ? fmtPct(p.apr_amp) : '-'}</div>
                    <div class="mono text-[10px] text-gray-500">${p.apr_non ? fmtPct(p.apr_non) : '-'}</div>
                </td>
                <td class="text-right mono">
                    <div class="text-purple-400">${p.votion_now_vp ? fmtNum(p.votion_now_vp) : '-'}</div>
                    <div class="text-[10px] text-gray-500">${votionNowPct > 0 ? fmtPct(votionNowPct) : '-'}</div>
                </td>
                <td class="text-right mono ${changeClass}">
                    ${changeVP !== 0 ? changeIcon + ' ' + fmtNum(Math.abs(changeVP)) : '-'}
                </td>
                <td class="text-right mono">
                    <div class="text-purple-400">${p.votion_next_vp ? fmtNum(p.votion_next_vp) : '-'}</div>
                    <div class="text-[10px] text-gray-500">${votionNextPct > 0 ? fmtPct(votionNextPct) : '-'}</div>
                </td>
                <td class="text-right">
                    <div class="mono ${poolTotalBribes > 0 ? 'text-amber-400' : 'text-gray-500'}">
                        ${poolTotalBribes > 0 ? fmt$(poolTotalBribes) : '-'}
                    </div>
                    ${poolPdBribes > 0 ? `<div class="text-[10px] text-purple-400">Phoenix: ${fmt$(poolPdBribes)}</div>` : ''}
                </td>
                <td class="text-right mono">
                    <div class="text-orange-400">${p.vp ? fmtNum(p.vp) : '-'}</div>
                    <div class="text-[10px] text-gray-500">${tlaPct > 0 ? fmtPct(tlaPct) : '-'}</div>
                </td>
                <td class="text-right mono">
                    <div class="text-cyan-400">${p.adao_vp ? fmtNum(p.adao_vp) : '-'}</div>
                    <div class="text-[10px] text-gray-500">${adaoPct > 0 ? fmtPct(adaoPct) : '-'}</div>
                </td>
            </tr>
        `;
    }
    
    function showPoolBribesDetail(poolName) {
        const pool = store.pools.find(p => p.name === poolName);
        if (!pool) return;
        
        alert(`Bribes for ${poolName}:\nTotal: ${fmt$(pool.bribes_total)}\nPD: ${fmt$(pool.bribes_pd || 0)}\nOther: ${fmt$(pool.bribes_other || 0)}`);
    }
    
    function applyPoolFilters() {
        renderPoolsByBucket();
    }
    
    // ============================================================
    // TLA TAB
    // ============================================================
    // TLA Tab sort state
    let tlaSortState = {
        column: 'tla_staked',
        direction: 'desc'
    };
    
    function renderTlaTab() {
        applyTlaFilters();
        
        // Calculate stats from all TLA pools (active + inactive)
        const allPools = [...store.tlaPools, ...(store.tlaInactivePools || [])];
        
        // Total DEX Depth
        const totalDepth = allPools.reduce((sum, p) => sum + (p.depth || 0), 0);
        document.getElementById('tla-total-depth').textContent = fmt$(totalDepth);
        
        // Total TLA Staked
        const totalStaked = allPools.reduce((sum, p) => sum + (p.tla_staked || 0), 0);
        document.getElementById('tla-total-staked').textContent = fmt$(totalStaked);
        
        // TLA % of DEX
        const tlaPctOfDex = totalDepth > 0 ? (totalStaked / totalDepth) * 100 : 0;
        document.getElementById('tla-pct-of-dex').textContent = fmtPct(tlaPctOfDex);
        
        // Total Epoch Volume (Astroport only for now)
        const astroVolume = store.pools
            .filter(p => p.dex?.includes('Astro'))
            .reduce((sum, p) => sum + (p.vol_4ep_avg || 0), 0);
        document.getElementById('tla-total-volume').textContent = fmt$(astroVolume);
        
        // Setup sort click handlers
        document.querySelectorAll('#tla-table th.sortable').forEach(th => {
            th.style.cursor = 'pointer';
            th.onclick = () => {
                const col = th.dataset.sort;
                if (tlaSortState.column === col) {
                    tlaSortState.direction = tlaSortState.direction === 'desc' ? 'asc' : 'desc';
                } else {
                    tlaSortState.column = col;
                    tlaSortState.direction = 'desc';
                }
                updateTlaSortIcons();
                applyTlaFilters();
            };
        });
    }
    
    function updateTlaSortIcons() {
        document.querySelectorAll('#tla-table th.sortable').forEach(th => {
            const icon = th.querySelector('i');
            const col = th.dataset.sort;
            th.classList.remove('active');
            if (col === tlaSortState.column) {
                th.classList.add('active');
                icon.className = tlaSortState.direction === 'desc' ? 'fas fa-sort-down text-cyan-400 ml-1' : 'fas fa-sort-up text-cyan-400 ml-1';
            } else {
                icon.className = 'fas fa-sort text-gray-600 ml-1';
            }
        });
    }
    
    function applyTlaFilters() {
        const hideInactive = document.getElementById('tla-hide-inactive')?.checked || false;
        const hideAstro = document.getElementById('tla-hide-astro')?.checked || false;
        const hideWW = document.getElementById('tla-hide-ww')?.checked || false;
        
        // Combine active and inactive pools
        let pools = [...store.tlaPools, ...(store.tlaInactivePools || [])];
        
        // Apply filters
        if (hideInactive) {
            pools = pools.filter(p => p.apr_non_amp > 0 || p.apr_amplified > 0);
        }
        if (hideAstro) {
            pools = pools.filter(p => !p.dex?.includes('Astro'));
        }
        if (hideWW) {
            pools = pools.filter(p => !p.dex?.includes('White'));
        }
        
        // Calculate totals for percentages
        const totalTlaStaked = pools.reduce((sum, p) => sum + (p.tla_staked || 0), 0);
        
        // Create efficiency and score maps from store.pools
        const poolDataMap = {};
        store.pools.forEach(p => {
            const key = (p.name || '').toUpperCase();
            poolDataMap[key] = {
                efficiency: p.efficiency || 0,
                access_score: p.access_score || 0,
                performance_score: p.performance_score || 0,
                support_score: p.support_score || 0,
                vol_4ep_avg: p.vol_4ep_avg || 0,
                liq_4ep_avg: p.liq_4ep_avg || 0
            };
        });
        
        // Enrich pools with computed values
        pools = pools.map(p => {
            const normalizedName = (p.normalized_name || p.name || '').toUpperCase();
            const poolData = poolDataMap[normalizedName] || {};
            const tlaPct = totalTlaStaked > 0 ? ((p.tla_staked || 0) / totalTlaStaked) * 100 : 0;
            const depthPct = (p.depth || 0) > 0 ? ((p.tla_staked || 0) / p.depth) * 100 : 0;
            const adaoDeposit = (p.adao_deposit_non_amp || 0) + (p.adao_deposit_amplified || 0);
            
            return {
                ...p,
                tlaPct,
                depthPct,
                adaoDeposit,
                efficiency: poolData.efficiency,
                access_score: poolData.access_score,
                performance_score: poolData.performance_score,
                support_score: poolData.support_score,
                vol_4ep_avg: poolData.vol_4ep_avg,
                liq_4ep_avg: poolData.liq_4ep_avg
            };
        });
        
        // Sort based on current sort state
        const col = tlaSortState.column;
        const dir = tlaSortState.direction === 'desc' ? -1 : 1;
        
        pools.sort((a, b) => {
            let aVal, bVal;
            switch (col) {
                case 'name':
                    aVal = (a.normalized_name || a.name || '').toLowerCase();
                    bVal = (b.normalized_name || b.name || '').toLowerCase();
                    return dir * aVal.localeCompare(bVal);
                case 'bucket':
                    aVal = a.bucket || '';
                    bVal = b.bucket || '';
                    return dir * aVal.localeCompare(bVal);
                case 'depth':
                    return dir * ((a.depth || 0) - (b.depth || 0));
                case 'tla_staked':
                    return dir * ((a.tla_staked || 0) - (b.tla_staked || 0));
                case 'tla_pct':
                    return dir * ((a.tlaPct || 0) - (b.tlaPct || 0));
                case 'efficiency':
                    return dir * ((a.efficiency || 0) - (b.efficiency || 0));
                case 'apr':
                    return dir * ((a.apr_amplified || a.apr_non_amp || 0) - (b.apr_amplified || b.apr_non_amp || 0));
                case 'rewards':
                    return dir * ((a.rewards_per_year || 0) - (b.rewards_per_year || 0));
                case 'adao':
                    return dir * ((a.adaoDeposit || 0) - (b.adaoDeposit || 0));
                default:
                    return dir * ((a.tla_staked || 0) - (b.tla_staked || 0));
            }
        });
        
        const tbody = document.getElementById('tla-table-body');
        
        if (pools.length === 0) {
            tbody.innerHTML = '<tr><td colspan="10" class="text-center text-gray-500 py-8">No TLA pools found</td></tr>';
            return;
        }
        
        // Bucket colors
        const bucketColors = {
            'STABLE': 'text-cyan-400 bg-cyan-500/10',
            'PROJECT': 'text-amber-400 bg-amber-500/10',
            'BLUECHIP': 'text-blue-400 bg-blue-500/10',
            'SINGLE': 'text-purple-400 bg-purple-500/10'
        };
        
        // Calculate efficiency stats for relative coloring
        const efficiencies = pools.map(p => p.efficiency || 0).filter(e => e > 0).sort((a, b) => b - a);
        const maxEff = efficiencies[0] || 1;
        const topTier = efficiencies[Math.floor(efficiencies.length * 0.25)] || maxEff * 0.75;
        const midTier = efficiencies[Math.floor(efficiencies.length * 0.5)] || maxEff * 0.5;
        
        tbody.innerHTML = pools.map(p => {
            const isActive = (p.apr_non_amp > 0 || p.apr_amplified > 0);
            const rewardsPerEpoch = (p.rewards_per_year || 0) / 52;
            
            const bucket = p.bucket || 'UNKNOWN';
            const bucketClass = bucketColors[bucket] || 'text-gray-400 bg-gray-500/10';
            
            // Efficiency display - convert to percentage and add label
            const eff = p.efficiency || 0;
            const effPct = (eff * 100).toFixed(0);
            let effLabel = '';
            let effColor = 'text-gray-500';
            
            if (eff > 0) {
                if (eff >= topTier) {
                    effLabel = 'High';
                    effColor = 'text-green-400';
                } else if (eff >= midTier) {
                    effLabel = 'Good';
                    effColor = 'text-cyan-400';
                } else {
                    effLabel = 'Low';
                    effColor = 'text-gray-400';
                }
            }
            
            // Build efficiency tooltip
            const rank = efficiencies.filter(e => e > eff).length + 1;
            const percentile = efficiencies.length > 0 ? Math.round((1 - (rank - 1) / efficiencies.length) * 100) : 0;
            
            const effTooltip = `CAPITAL EFFICIENCY&#10;` +
                `How hard the pool's liquidity is working.&#10;&#10;` +
                `${effPct}% = For every $100 in this pool,&#10;` +
                `$${effPct} of trading happens per week.&#10;&#10;` +
                `This Pool:&#10;` +
                `  Weekly Volume: ${fmt$(p.vol_4ep_avg || 0)}&#10;` +
                `  Pool Liquidity: ${fmt$(p.liq_4ep_avg || 0)}&#10;&#10;` +
                `Rating: ${effLabel}&#10;` +
                `Rank: #${rank} of ${efficiencies.length} pools (top ${percentile}%)`;
            
            return `
            <tr class="${!isActive ? 'opacity-50' : ''}">
                <td>
                    <div class="flex items-center gap-2">
                        <span class="active-dot ${isActive ? 'on' : 'off'}"></span>
                        <div>
                            <div class="font-medium">${p.normalized_name || p.name}</div>
                            <div class="text-[10px] text-gray-500">${p.dex} • ${p.type || '-'}</div>
                        </div>
                    </div>
                </td>
                <td class="text-center">
                    <span class="text-[10px] px-2 py-0.5 rounded ${bucketClass}">${bucket}</span>
                </td>
                <td class="text-right mono text-green-400">${fmt$(p.depth)}</td>
                <td class="text-right mono text-cyan-400">${fmt$(p.tla_staked)}</td>
                <td class="text-right mono text-gray-400">${p.depthPct > 0 ? fmtPct(p.depthPct) : '-'}</td>
                <td class="text-right mono text-gray-400">${p.tlaPct > 0 ? fmtPct(p.tlaPct) : '-'}</td>
                <td class="text-right ${effColor}" title="${effTooltip}">
                    ${eff > 0 ? `<div class="mono">${effPct}%</div><div class="text-[10px]">${effLabel}</div>` : '-'}
                </td>
                <td class="text-right">
                    <div class="mono ${p.apr_amplified > 0 ? 'text-green-400' : 'text-gray-500'}">${p.apr_amplified > 0 ? fmtPct(p.apr_amplified) : '-'}</div>
                    <div class="mono text-[10px] ${p.apr_non_amp > 0 ? 'text-green-300' : 'text-gray-600'}">${p.apr_non_amp > 0 ? fmtPct(p.apr_non_amp) : '-'}</div>
                </td>
                <td class="text-right">
                    <div class="mono text-orange-400">${rewardsPerEpoch > 0 ? fmt$(rewardsPerEpoch) : '-'}</div>
                    <div class="mono text-[10px] text-gray-500">${p.rewards_per_year > 0 ? fmt$(p.rewards_per_year) : '-'}</div>
                </td>
                <td class="text-right mono ${p.adaoDeposit > 0 ? 'text-purple-400' : 'text-gray-500'}">${p.adaoDeposit > 0 ? fmt$(p.adaoDeposit) : '-'}</td>
            </tr>
            `;
        }).join('');
    }
    
    // ============================================================
    // RANKINGS TAB
    // ============================================================
    function renderRankingsTab() {
        // Render asset scores grid
        renderAssetScoresGrid();
        
        // Apply filters and render bucket sections
        applyRankingsFilters();
        
        // Setup filter listeners
        document.getElementById('rankings-hide-negative')?.addEventListener('change', applyRankingsFilters);
        document.getElementById('rankings-hide-inactive')?.addEventListener('change', applyRankingsFilters);
        document.getElementById('rankings-hide-astro')?.addEventListener('change', applyRankingsFilters);
        document.getElementById('rankings-hide-ww')?.addEventListener('change', applyRankingsFilters);
    }
    
    function renderAssetScoresGrid() {
        const container = document.getElementById('asset-scores-grid');
        if (!container) return;
        
        // Build asset metadata
        const assetMeta = buildAssetMetadata();
        
        // Sort by score descending
        const sorted = Object.entries(assetMeta).sort((a, b) => b[1].score - a[1].score);
        
        container.innerHTML = sorted.map(([asset, meta]) => {
            const score = meta.score;
            const scoreColor = score >= 90 ? 'text-green-400 border-green-500/30 bg-green-500/10 hover:bg-green-500/20' :
                              score >= 70 ? 'text-cyan-400 border-cyan-500/30 bg-cyan-500/10 hover:bg-cyan-500/20' :
                              score >= 50 ? 'text-yellow-400 border-yellow-500/30 bg-yellow-500/10 hover:bg-yellow-500/20' :
                              'text-red-400 border-red-500/30 bg-red-500/10 hover:bg-red-500/20';
            
            return `
                <div class="p-2 rounded border ${scoreColor} text-center cursor-pointer transition-all" 
                     onclick="showAssetDetailModal('${asset}')">
                    <div class="text-xs font-mono font-bold">${asset}</div>
                    <div class="text-lg font-bold">${score}</div>
                </div>
            `;
        }).join('');
    }
    
    // Comprehensive asset metadata based on tla_metadata.json
    const ASSET_METADATA = {
        'LUNA': { 
            score: 100, origin: 'terra_native', origin_label: '🏠 Terra Native', 
            asset_class: 'core', cg_status: 'cg_terra', treasury_value: 'high',
            acquisition: 'easy', skip_clear: true, multi_dex: true, naming_accurate: true,
            actual_path: 'LUNA', note: 'Base chain asset - no bridging needed'
        },
        'EURe': { 
            score: 85, origin: 'ibc', origin_label: '⚛️ IBC (Noble)', 
            asset_class: 'stable', cg_status: 'cg_chain', treasury_value: 'high',
            acquisition: 'hard', skip_clear: true, multi_dex: true, naming_accurate: false,
            actual_path: 'EURe.noble', note: 'Need to search EURe Noble, switch target chain to Terra'
        },
        'USDC': { 
            score: 85, origin: 'ibc', origin_label: '⚛️ IBC (Noble)', 
            asset_class: 'stable', cg_status: 'cg_chain', treasury_value: 'high',
            acquisition: 'hard', skip_clear: true, multi_dex: true, naming_accurate: false,
            actual_path: 'USDC.noble', note: 'Need to select USDC Noble and switch target chain to Terra'
        },
        'USDT': { 
            score: 75, origin: 'ibc', origin_label: '⚛️ IBC (Kava)', 
            asset_class: 'stable', cg_status: 'cg_chain', treasury_value: 'high',
            acquisition: 'hard', skip_clear: false, multi_dex: true, naming_accurate: false,
            actual_path: 'USDT.kava', note: 'Need to find USDT.kava and switch to Terra'
        },
        'ASTRO': { 
            score: 90, origin: 'ibc', origin_label: '⚛️ IBC', 
            asset_class: 'defi', cg_status: 'cg_chain', treasury_value: 'low',
            acquisition: 'hard', skip_clear: true, multi_dex: true, naming_accurate: true,
            actual_path: 'ASTRO', note: 'Keplr: need Astro Neutron then change to Terra. Leap works.'
        },
        'CAPA': { 
            score: 100, origin: 'terra_native', origin_label: '🏠 Terra Native', 
            asset_class: 'native', cg_status: 'cg_terra', treasury_value: 'medium',
            acquisition: 'easy', skip_clear: true, multi_dex: true, naming_accurate: true,
            actual_path: 'CAPA', note: 'Native ecosystem token - available on Terra DEXes'
        },
        'FUEL': { 
            score: 65, origin: 'ibc', origin_label: '⚛️ IBC (Neutron)', 
            asset_class: 'defi', cg_status: 'cg_none', treasury_value: 'low',
            acquisition: 'medium', skip_clear: true, multi_dex: false, naming_accurate: true,
            actual_path: 'FUEL', note: 'Need to select Fuel Neutron and switch to Terra as target'
        },
        'ROAR': { 
            score: 100, origin: 'terra_native', origin_label: '🏠 Terra Native', 
            asset_class: 'native', cg_status: 'cg_terra', treasury_value: 'medium',
            acquisition: 'easy', skip_clear: true, multi_dex: true, naming_accurate: true,
            actual_path: 'ROAR', note: 'Native ecosystem token'
        },
        'SOLID': { 
            score: 100, origin: 'terra_native', origin_label: '🏠 Terra Native', 
            asset_class: 'native', cg_status: 'cg_terra', treasury_value: 'high',
            acquisition: 'easy', skip_clear: true, multi_dex: true, naming_accurate: true,
            actual_path: 'SOLID', note: 'Native ecosystem token'
        },
        'SWTH': { 
            score: 95, origin: 'ibc', origin_label: '⚛️ IBC (Carbon)', 
            asset_class: 'defi', cg_status: 'cg_chain', treasury_value: 'medium',
            acquisition: 'medium', skip_clear: true, multi_dex: true, naming_accurate: true,
            actual_path: 'SWTH', note: 'Select SWTH Carbon then switch target chain to Terra'
        },
        'ampLUNA': { 
            score: 100, origin: 'terra_lsd', origin_label: '🔄 Terra LSD', 
            asset_class: 'lsd', cg_status: 'cg_terra', treasury_value: 'medium',
            acquisition: 'easy', skip_clear: true, multi_dex: true, naming_accurate: true,
            actual_path: 'ampLUNA', note: 'Eris Protocol liquid staking derivative'
        },
        'boneLUNA': { 
            score: 100, origin: 'terra_lsd', origin_label: '🔄 Terra LSD', 
            asset_class: 'lsd', cg_status: 'cg_terra', treasury_value: 'medium',
            acquisition: 'easy', skip_clear: true, multi_dex: true, naming_accurate: false,
            actual_path: 'bLUNA', note: 'Backbone Labs liquid staking (displayed as bLUNA)'
        },
        'bLUNA': { 
            score: 100, origin: 'terra_lsd', origin_label: '🔄 Terra LSD', 
            asset_class: 'lsd', cg_status: 'cg_terra', treasury_value: 'medium',
            acquisition: 'easy', skip_clear: true, multi_dex: true, naming_accurate: true,
            actual_path: 'bLUNA', note: 'Backbone Labs liquid staking'
        },
        'stLUNA': { 
            score: 95, origin: 'terra_lsd', origin_label: '🔄 Terra LSD', 
            asset_class: 'lsd', cg_status: 'cg_none', treasury_value: 'medium',
            acquisition: 'medium', skip_clear: true, multi_dex: true, naming_accurate: true,
            actual_path: 'stLUNA', note: 'Stride liquid staking - need to select stLUNA on Stride'
        },
        'ATOM': { 
            score: 95, origin: 'ibc', origin_label: '⚛️ IBC', 
            asset_class: 'core', cg_status: 'cg_chain', treasury_value: 'medium',
            acquisition: 'easy', skip_clear: true, multi_dex: true, naming_accurate: true,
            actual_path: 'ATOM', note: 'Easy IBC transfer from Cosmos Hub'
        },
        'INJ': { 
            score: 95, origin: 'ibc', origin_label: '⚛️ IBC', 
            asset_class: 'core', cg_status: 'cg_chain', treasury_value: 'medium',
            acquisition: 'easy', skip_clear: true, multi_dex: true, naming_accurate: true,
            actual_path: 'INJ', note: 'Easy IBC transfer from Injective'
        },
        'PAXG': { 
            score: 75, origin: 'bridge_eureka', origin_label: '🌉 Eureka Bridge', 
            asset_class: 'bluechip', cg_status: 'cg_terra', treasury_value: 'high',
            acquisition: 'hard', skip_clear: true, multi_dex: false, naming_accurate: false,
            actual_path: 'PAXG.atom', note: 'Select PAXG Ethereum then change target to Terra'
        },
        'wBNB.axl': { 
            score: 75, origin: 'bridge_axelar', origin_label: '🔶 Axelar Bridge', 
            asset_class: 'core', cg_status: 'cg_chain', treasury_value: 'high',
            acquisition: 'hard', skip_clear: true, multi_dex: false, naming_accurate: true,
            actual_path: 'wBNB.axl', note: 'Can\'t find in Keplr. Leap works with wBNB.axl'
        },
        'wBTC.atom': { 
            score: 95, origin: 'bridge_eureka', origin_label: '🌉 Eureka Bridge', 
            asset_class: 'bluechip', cg_status: 'cg_terra', treasury_value: 'high',
            acquisition: 'hard', skip_clear: true, multi_dex: false, naming_accurate: true,
            actual_path: 'wBTC.atom', note: 'Select wBTC + Ethereum then switch to Terra'
        },
        'wBTC.axl': { 
            score: 60, origin: 'bridge_axelar', origin_label: '🔶 Axelar Bridge', 
            asset_class: 'bluechip', cg_status: 'cg_none', treasury_value: 'high',
            acquisition: 'hard', skip_clear: true, multi_dex: false, naming_accurate: true,
            actual_path: 'wBTC.axl', note: 'Keplr: wBTC.axl isn\'t an option for Terra target'
        },
        'wBTC.osmo': { 
            score: 60, origin: 'bridge_osmosis', origin_label: '🟠 Osmosis Bridge', 
            asset_class: 'bluechip', cg_status: 'cg_none', treasury_value: 'high',
            acquisition: 'hard', skip_clear: true, multi_dex: false, naming_accurate: true,
            actual_path: 'wBTC.osmo', note: 'Find wBTC.osmo then switch target chain to Terra'
        },
        'wstETH': { 
            score: 100, origin: 'ibc', origin_label: '⚛️ IBC', 
            asset_class: 'bluechip', cg_status: 'cg_chain', treasury_value: 'high',
            acquisition: 'hard', skip_clear: true, multi_dex: false, naming_accurate: true,
            actual_path: 'wstETH', note: 'Select wstETH on Ethereum then switch to Terra'
        },
        'stATOM': { 
            score: 100, origin: 'ibc', origin_label: '⚛️ IBC', 
            asset_class: 'lsd', cg_status: 'cg_chain', treasury_value: 'medium',
            acquisition: 'hard', skip_clear: true, multi_dex: true, naming_accurate: true,
            actual_path: 'stATOM', note: 'Select stATOM Stride and switch to Terra target'
        },
        'arbLUNA': { 
            score: 100, origin: 'terra_lsd', origin_label: '🔄 Terra LSD', 
            asset_class: 'lsd', cg_status: 'cg_terra', treasury_value: 'medium',
            acquisition: 'easy', skip_clear: true, multi_dex: true, naming_accurate: true,
            actual_path: 'arbLUNA', note: 'Eris Protocol arbitrage LSD'
        },
        'ampCAPA': { 
            score: 85, origin: 'terra_native', origin_label: '🏠 Terra Native', 
            asset_class: 'lsd', cg_status: 'cg_none', treasury_value: 'medium',
            acquisition: 'easy', skip_clear: true, multi_dex: false, naming_accurate: true,
            actual_path: 'ampCAPA', note: 'Amplified CAPA staking derivative'
        },
        'ampROAR': { 
            score: 90, origin: 'terra_native', origin_label: '🏠 Terra Native', 
            asset_class: 'lsd', cg_status: 'cg_none', treasury_value: 'medium',
            acquisition: 'easy', skip_clear: true, multi_dex: true, naming_accurate: true,
            actual_path: 'ampROAR', note: 'Amplified ROAR staking derivative'
        },
        'wETH.axl': { 
            score: 60, origin: 'bridge_axelar', origin_label: '🔶 Axelar Bridge', 
            asset_class: 'bluechip', cg_status: 'cg_none', treasury_value: 'high',
            acquisition: 'hard', skip_clear: true, multi_dex: false, naming_accurate: true,
            actual_path: 'wETH.axl', note: 'Can\'t find in Keplr. Leap works with wETH.axl'
        },
        'xASTRO': { 
            score: 65, origin: 'ibc', origin_label: '⚛️ IBC', 
            asset_class: 'defi', cg_status: 'cg_none', treasury_value: 'low',
            acquisition: 'medium', skip_clear: true, multi_dex: false, naming_accurate: true,
            actual_path: 'xASTRO', note: 'Staked ASTRO governance token'
        }
    };
    
    function buildAssetMetadata() {
        const meta = {};
        
        // Get all unique assets from pools
        store.pools.forEach(p => {
            const parts = (p.name || '').split('-');
            parts.forEach(asset => {
                if (asset && !meta[asset]) {
                    meta[asset] = ASSET_METADATA[asset] || { 
                        score: 50, origin: 'unknown', origin_label: '❓ Unknown', 
                        asset_class: 'unknown', cg_status: 'cg_none', treasury_value: 'medium',
                        acquisition: 'hard', skip_clear: false, multi_dex: false, naming_accurate: false,
                        actual_path: asset, note: 'Unknown asset - not in metadata'
                    };
                }
            });
        });
        
        return meta;
    }
    
    function showAssetDetailModal(asset) {
        const meta = ASSET_METADATA[asset] || buildAssetMetadata()[asset];
        if (!meta) return;
        
        const score = meta.score;
        const scoreColor = score >= 90 ? 'text-green-400' : score >= 70 ? 'text-cyan-400' : score >= 50 ? 'text-yellow-400' : 'text-red-400';
        const bgColor = score >= 90 ? 'bg-green-500/20' : score >= 70 ? 'bg-cyan-500/20' : score >= 50 ? 'bg-yellow-500/20' : 'bg-red-500/20';
        
        document.getElementById('asset-detail-icon').className = `w-12 h-12 rounded-lg ${bgColor} flex items-center justify-center`;
        document.getElementById('asset-detail-score-icon').className = `text-2xl font-bold ${scoreColor}`;
        document.getElementById('asset-detail-score-icon').textContent = score;
        document.getElementById('asset-detail-name').textContent = asset;
        document.getElementById('asset-detail-origin').textContent = meta.origin_label || meta.origin;
        
        // Calculate score breakdown using config values
        const baseScore = getOriginScore(meta.origin);
        const classScore = getAssetClassBonus(meta.asset_class);
        const cgScores = { cg_terra: 15, cg_chain: 5, cg_none: -15 };
        const treasuryScores = { high: 5, medium: 0, low: -5 };
        
        const cgScore = cgScores[meta.cg_status] || -15;
        const treasuryScore = treasuryScores[meta.treasury_value] || 0;
        const namingScore = meta.naming_accurate ? 10 : -10;
        const skipScore = meta.skip_clear ? 5 : -5;
        const multiDexScore = meta.multi_dex ? 5 : 0;
        
        const content = `
            <!-- Score Breakdown -->
            <div class="p-4 bg-gray-800/50 rounded-lg border border-gray-700">
                <div class="font-semibold mb-3">Score Breakdown</div>
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">Origin (${meta.origin_label || meta.origin})</span>
                        <span class="mono text-green-400">+${baseScore}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">Asset Class (${meta.asset_class})</span>
                        <span class="mono ${classScore >= 0 ? 'text-green-400' : 'text-red-400'}">${classScore >= 0 ? '+' : ''}${classScore}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">CoinGecko (${meta.cg_status?.replace('cg_', '')})</span>
                        <span class="mono ${cgScore >= 0 ? 'text-green-400' : 'text-red-400'}">${cgScore >= 0 ? '+' : ''}${cgScore}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">Treasury Value (${meta.treasury_value})</span>
                        <span class="mono ${treasuryScore >= 0 ? 'text-green-400' : 'text-red-400'}">${treasuryScore >= 0 ? '+' : ''}${treasuryScore}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">Naming ${meta.naming_accurate ? '✓' : '✗'}</span>
                        <span class="mono ${namingScore >= 0 ? 'text-green-400' : 'text-red-400'}">${namingScore >= 0 ? '+' : ''}${namingScore}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">Skip.go ${meta.skip_clear ? '✓' : '✗'}</span>
                        <span class="mono ${skipScore >= 0 ? 'text-green-400' : 'text-red-400'}">${skipScore >= 0 ? '+' : ''}${skipScore}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">Multi-DEX ${meta.multi_dex ? '✓' : '✗'}</span>
                        <span class="mono ${multiDexScore >= 0 ? 'text-green-400' : 'text-gray-500'}">${multiDexScore > 0 ? '+' + multiDexScore : '0'}</span>
                    </div>
                    <div class="flex justify-between items-center pt-2 border-t border-gray-700 font-bold">
                        <span>Total Score</span>
                        <span class="mono ${scoreColor}">${score}</span>
                    </div>
                </div>
            </div>
            
            <!-- Acquisition Info -->
            ${meta.note ? `
            <div class="p-4 ${meta.acquisition === 'easy' ? 'bg-green-500/10 border-green-500/30' : meta.acquisition === 'medium' ? 'bg-yellow-500/10 border-yellow-500/30' : 'bg-red-500/10 border-red-500/30'} rounded-lg border">
                <div class="flex items-center gap-2 mb-2">
                    <i class="fas fa-${meta.acquisition === 'easy' ? 'check-circle text-green-400' : meta.acquisition === 'medium' ? 'exclamation-circle text-yellow-400' : 'times-circle text-red-400'}"></i>
                    <span class="font-semibold">${meta.acquisition === 'easy' ? 'Easy' : meta.acquisition === 'medium' ? 'Medium' : 'Hard'} Acquisition</span>
                </div>
                <div class="text-sm text-gray-400">${meta.note}</div>
            </div>
            ` : ''}
            
            <!-- Path Info -->
            ${meta.actual_path && meta.actual_path !== asset ? `
            <div class="p-3 bg-gray-800/30 rounded-lg text-sm">
                <span class="text-gray-400">Actual path:</span> 
                <span class="mono text-cyan-400">${meta.actual_path}</span>
            </div>
            ` : ''}
        `;
        
        document.getElementById('asset-detail-content').innerHTML = content;
        document.getElementById('asset-detail-modal').classList.remove('hidden');
        document.getElementById('asset-detail-modal').classList.add('flex');
    }
    
    function closeAssetDetailModal(e) {
        if (!e || e.target === document.getElementById('asset-detail-modal')) {
            document.getElementById('asset-detail-modal').classList.add('hidden');
            document.getElementById('asset-detail-modal').classList.remove('flex');
        }
    }
    
    function applyRankingsFilters() {
        const hideNegative = document.getElementById('rankings-hide-negative')?.checked || false;
        const hideInactive = document.getElementById('rankings-hide-inactive')?.checked || false;
        const hideAstro = document.getElementById('rankings-hide-astro')?.checked || false;
        const hideWW = document.getElementById('rankings-hide-ww')?.checked || false;
        
        // Start with all pools
        let pools = [...store.pools];
        
        // Apply visibility filters
        if (hideInactive) {
            pools = pools.filter(p => p.is_active !== false);
        }
        if (hideAstro) {
            pools = pools.filter(p => !p.dex?.includes('Astro'));
        }
        if (hideWW) {
            pools = pools.filter(p => !p.dex?.includes('White'));
        }
        
        // Recalculate scores within filtered pool set
        pools = recalculateScores(pools);
        
        // Hide negative scores if requested
        if (hideNegative) {
            pools = pools.filter(p => (p.calc_score || 0) >= 0);
        }
        
        // Get PD bribe data for current epoch
        const pdRankings = getPdRankings();
        
        // Get aDAO bribe picks (before filtering negative)
        const allPoolsWithScores = recalculateScores([...store.pools].filter(p => {
            if (hideAstro && p.dex?.includes('Astro')) return false;
            if (hideWW && p.dex?.includes('White')) return false;
            return true;
        }));
        const adaoPicks = getAdaoBribePicks(allPoolsWithScores, pdRankings);
        
        // Render each bucket
        const container = document.getElementById('rankings-buckets-container');
        const buckets = ['STABLE', 'PROJECT', 'BLUECHIP', 'SINGLE'];
        
        const bucketInfo = {
            'STABLE': { name: 'Stable', icon: '💰', color: 'cyan', borderColor: 'border-cyan-500/30', bgColor: 'bg-cyan-500/5' },
            'PROJECT': { name: 'Project', icon: '🚀', color: 'amber', borderColor: 'border-amber-500/30', bgColor: 'bg-amber-500/5' },
            'BLUECHIP': { name: 'Bluechip', icon: '💎', color: 'blue', borderColor: 'border-blue-500/30', bgColor: 'bg-blue-500/5' },
            'SINGLE': { name: 'Single', icon: '🔷', color: 'purple', borderColor: 'border-purple-500/30', bgColor: 'bg-purple-500/5' }
        };
        
        // Build aDAO Bribe Proposal section
        let html = `
        <div class="glass-card p-5 mb-6 border border-green-500/30 bg-green-500/5">
            <div class="flex items-center gap-3 mb-4">
                <div class="w-10 h-10 rounded-lg bg-green-500/20 flex items-center justify-center">
                    <i class="fas fa-hand-holding-usd text-green-400"></i>
                </div>
                <div>
                    <div class="font-bold text-green-400">aDAO Bribe Proposal</div>
                    <div class="text-[10px] text-gray-500">Recommended pools for $100 USD bribe (4 epochs in SOLID/USDC)</div>
                </div>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
        `;
        
        buckets.forEach(bucket => {
            const info = bucketInfo[bucket];
            const pick = adaoPicks[bucket];
            if (pick) {
                const pdData = findPdDataForPool(pdRankings, bucket, pick.name, pick.dex);
                const hasPd = pdData && pdData.percent > 0;
                html += `
                <div class="p-3 rounded-lg ${info.bgColor} border ${info.borderColor}">
                    <div class="text-[10px] text-gray-500 mb-1">${info.icon} ${info.name}</div>
                    <div class="font-bold text-${info.color}-400">${pick.name}</div>
                    <div class="text-[10px] text-gray-400">${pick.dex}</div>
                    <div class="flex items-center gap-2 mt-2 text-[10px]">
                        <span class="text-emerald-400" title="Opportunity Score">↑${(pick.calc_score || 0).toFixed(0)}</span>
                        ${hasPd ? `<span class="text-orange-400" title="PD Coverage">PD:${pdData.percent.toFixed(0)}%</span>` : '<span class="text-green-400" title="No PD coverage - gap to fill">No PD</span>'}
                    </div>
                </div>
                `;
            }
        });
        
        html += `
            </div>
            <div class="mt-3 pt-3 border-t border-gray-700 text-[10px] text-gray-500">
                <i class="fas fa-info-circle text-green-400 mr-1"></i>
                These picks fill gaps in Phoenix Directive coverage while targeting high-opportunity pools. 
                Create a multi-choice governance prop to let the DAO vote on which bucket to bribe.
            </div>
        </div>
        `;
        
        buckets.forEach(bucket => {
            const info = bucketInfo[bucket];
            let bucketPools = pools.filter(p => p.bucket === bucket);
            
            // Sort by calculated score within bucket
            bucketPools.sort((a, b) => (b.calc_score || 0) - (a.calc_score || 0));
            
            if (bucketPools.length === 0) return;
            
            // Calculate VP recommendations for this bucket
            const bucketAdaoTotal = bucketPools.reduce((sum, p) => sum + (p.adao_vp || 0), 0);
            const positiveScorePools = bucketPools.filter(p => (p.calc_score || 0) > 0);
            const totalPositiveScore = positiveScorePools.reduce((sum, p) => sum + (p.calc_score || 0), 0);
            
            // Get pick for this bucket
            const bucketPick = adaoPicks[bucket];
            
            html += `
            <div class="glass-card overflow-hidden ${info.borderColor} border">
                <div class="p-4 ${info.bgColor} border-b ${info.borderColor}">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">${info.icon}</span>
                            <div>
                                <h3 class="font-bold text-lg text-${info.color}-400">${info.name} Bucket</h3>
                                <div class="text-xs text-gray-500">${bucketPools.length} pools • ${bucketPools.filter(p => p.is_active !== false).length} active</div>
                            </div>
                        </div>
                        <div class="text-right text-xs">
                            <div class="text-gray-400">Bucket Total VP</div>
                            <div class="mono text-${info.color}-400">${fmtNum(bucketPools.reduce((sum, p) => sum + (p.vp || 0), 0))}</div>
                        </div>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="data-table text-sm w-full table-fixed">
                        <thead class="sticky top-0 bg-[#0f1117] z-10">
                            <tr>
                                <th class="text-center" style="width: 40px;" title="Rank within bucket">#</th>
                                <th class="text-left" style="width: 180px;" title="Pool name and DEX">POOL</th>
                                <th class="text-center" style="width: 60px;" title="Phoenix Directive bribe allocation %">PD %</th>
                                <th class="text-center" style="width: 60px;" title="Performance score">PERF</th>
                                <th class="text-center" style="width: 60px;" title="Support score">SUPP</th>
                                <th class="text-center" style="width: 70px;" title="Opportunity score">SCORE</th>
                                <th class="text-center" style="width: 55px;" title="Current aDAO vote %">NOW</th>
                                <th class="text-center" style="width: 55px;" title="Recommended vote %">REC</th>
                                <th class="text-center" style="width: 60px;" title="DAODAO / Custom">ADJ</th>
                                <th class="text-center" style="width: 50px;" title="aDAO Bribe Candidate">PICK</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            bucketPools.forEach((p, rank) => {
                const score = p.calc_score || 0;
                const currentPct = bucketAdaoTotal > 0 ? ((p.adao_vp || 0) / bucketAdaoTotal) * 100 : 0;
                
                let recommendedPct = 0;
                if (score > 0 && totalPositiveScore > 0) {
                    recommendedPct = (score / totalPositiveScore) * 100;
                }
                
                const daodaoRec = Math.round(recommendedPct / 10) * 10;
                const customRec = Math.round(recommendedPct);
                
                // Get PD ranking for this pool using flexible matching
                const pdData = findPdDataForPool(pdRankings, bucket, p.name, p.dex);
                const pdPct = pdData?.percent || 0;
                
                const isActive = p.is_active !== false;
                const normalizedName = normalizePoolName(p.name);
                const isPick = bucketPick && normalizePoolName(bucketPick.name) === normalizedName;
                const adjustTooltip = `DAODAO: ${daodaoRec}%&#10;Custom: ${customRec}%&#10;Current: ${currentPct.toFixed(0)}%`;
                
                html += `
                <tr class="hover:bg-white/5 cursor-pointer ${!isActive ? 'opacity-50' : ''} ${isPick ? 'bg-green-500/10' : ''}" onclick="showPoolDetail('${p.name}')">
                    <td class="text-center">
                        <span class="w-6 h-6 rounded flex items-center justify-center text-xs font-bold mx-auto ${rank < 3 ? `rank-${rank+1}` : 'bg-white/10'}">${rank+1}</span>
                    </td>
                    <td>
                        <div class="flex items-center gap-2">
                            <span class="active-dot ${isActive ? 'on' : 'off'}"></span>
                            <div class="min-w-0">
                                <div class="font-medium ${isPick ? 'text-green-400' : ''} truncate">${p.name}</div>
                                <div class="text-[10px] text-gray-500">${p.dex}</div>
                            </div>
                        </div>
                    </td>
                    <td class="text-center">
                        ${pdPct > 0 ? `<span class="mono text-orange-400">${pdPct.toFixed(0)}%</span>` : '<span class="text-gray-600">-</span>'}
                    </td>
                    <td class="text-center mono text-emerald-400">${(p.calc_perf || 0).toFixed(1)}</td>
                    <td class="text-center mono text-amber-400">${(p.calc_support || 0).toFixed(1)}</td>
                    <td class="text-center">
                        <span class="score-badge ${getScoreClass(score)}">
                            ${getScoreIcon(score)} ${score.toFixed(1)}
                        </span>
                    </td>
                    <td class="text-center mono text-gray-400">${currentPct > 0 ? currentPct.toFixed(0) + '%' : '-'}</td>
                    <td class="text-center mono ${recommendedPct > 0 ? 'text-cyan-400' : 'text-gray-500'}">${recommendedPct > 0 ? recommendedPct.toFixed(0) + '%' : '-'}</td>
                    <td class="text-center" title="${adjustTooltip}">
                        ${recommendedPct > 0 ? `
                        <div class="mono text-cyan-400 text-[10px]">${daodaoRec}%</div>
                        <div class="mono text-[9px] text-purple-400">${customRec}%</div>
                        ` : '<span class="text-gray-600">-</span>'}
                    </td>
                    <td class="text-center">
                        ${isPick ? '<span class="text-green-400" title="Recommended for aDAO bribe"><i class="fas fa-star"></i></span>' : '<span class="text-gray-700">-</span>'}
                    </td>
                </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            </div>
            `;
        });
        
        container.innerHTML = html || '<div class="text-center text-gray-500 py-8">No pools match current filters</div>';
    }
    
    // Normalize pool name for matching (handle various formats)
    function normalizePoolName(name) {
        if (!name) return '';
        // Remove spaces, uppercase, sort parts alphabetically for consistent matching
        const parts = name.toUpperCase().replace(/\s+/g, '').split('-');
        return parts.sort().join('-');
    }
    
    // Get PD rankings from loaded data
    function getPdRankings() {
        const rankings = {
            stable: {},
            project: {},
            bluechip: {},
            single: {}
        };
        
        // First try to use already-processed bribesData if available
        if (store.bribesData?.allBribedPools) {
            console.log('PD Rankings: Using pre-processed bribesData');
            Object.entries(store.bribesData.allBribedPools).forEach(([bucket, pools]) => {
                pools.forEach(bribeInfo => {
                    if (bribeInfo.percent > 0) {
                        const normalizedName = normalizePoolName(bribeInfo.pool);
                        const upperName = bribeInfo.pool?.toUpperCase() || '';
                        const data = {
                            percent: bribeInfo.percent,
                            usd: bribeInfo.pdUSD || 0,
                            luna: bribeInfo.pdLuna || 0,
                            originalName: bribeInfo.pool
                        };
                        rankings[bucket][normalizedName] = data;
                        rankings[bucket][upperName] = data;
                    }
                });
            });
            console.log('PD Rankings from bribesData:', Object.keys(rankings).map(b => `${b}: ${Object.keys(rankings[b]).length/2} pools`).join(', '));
            return rankings;
        }
        
        // Fallback: build from pdBribesData file directly
        const currentEpoch = store.epoch || CONFIG.currentEpoch;
        
        if (!store.pdBribesData || !currentEpoch) {
            console.log('PD Rankings: No data or epoch', { data: !!store.pdBribesData, epoch: currentEpoch });
            return rankings;
        }
        
        console.log('PD Rankings: Building from pdBribesData for epoch', currentEpoch);
        
        // Find the epoch range that contains current epoch
        const matchingRange = store.pdBribesData.find(range => 
            currentEpoch >= range.start_epoch && currentEpoch <= range.end_epoch
        );
        
        if (!matchingRange?.bribes) {
            console.log('PD Rankings: No matching range found for epoch', currentEpoch);
            return rankings;
        }
        
        console.log('PD Rankings: Found range', matchingRange.epoch_range, 'with', matchingRange.bribes.length, 'bribes');
        
        matchingRange.bribes.forEach(bribe => {
            const bucket = bribe.gauge?.toLowerCase() || '';
            if (!rankings[bucket]) return;
            
            const normalizedName = normalizePoolName(bribe.pool);
            const originalUpper = bribe.pool?.toUpperCase() || '';
            // Also create base name without bridge suffix (e.g., LUNA-WBTC from LUNA-WBTC.AXL)
            const baseName = bribe.pool?.toUpperCase().replace(/\.(AXL|OSMO|ATOM|NOBLE|KAVA)/gi, '') || '';
            const normalizedBase = normalizePoolName(baseName);
            
            const data = {
                percent: bribe.percent || 0,
                usd: bribe.usd_per_epoch || 0,
                luna: bribe.luna_per_epoch || 0,
                originalName: bribe.pool
            };
            
            // Store under multiple keys for flexible matching
            rankings[bucket][normalizedName] = data;
            rankings[bucket][originalUpper] = data;
            if (baseName !== originalUpper) {
                rankings[bucket][baseName] = data;
                rankings[bucket][normalizedBase] = data;
            }
        });
        
        console.log('PD Rankings built from file');
        return rankings;
    }
    
    // Helper to find PD data for a pool (tries multiple matching strategies)
    // Note: PD bribes only apply to Astroport pools
    function findPdDataForPool(pdRankings, bucket, poolName, dex) {
        // PD bribes are only on Astroport - skip Skeleton Swap pools
        if (dex && !dex.includes('Astro')) {
            return null;
        }
        
        const pdBucket = pdRankings[bucket.toLowerCase()] || {};
        
        // Try exact normalized match
        const normalizedName = normalizePoolName(poolName);
        if (pdBucket[normalizedName]) return pdBucket[normalizedName];
        
        // Try uppercase match
        const upperName = poolName?.toUpperCase().replace(/\s+/g, '') || '';
        if (pdBucket[upperName]) return pdBucket[upperName];
        
        // Try base name without bridge suffix
        const baseName = upperName.replace(/\.(AXL|OSMO|ATOM|NOBLE|KAVA)/gi, '');
        if (pdBucket[baseName]) return pdBucket[baseName];
        
        const normalizedBase = normalizePoolName(baseName);
        if (pdBucket[normalizedBase]) return pdBucket[normalizedBase];
        
        // Try matching just the token pair (ignore bridge info)
        // e.g., "LUNA-WBTC.ATOM" should match "LUNA-WBTC" in PD
        for (const [key, data] of Object.entries(pdBucket)) {
            const keyBase = key.replace(/\.(AXL|OSMO|ATOM|NOBLE|KAVA)/gi, '');
            if (normalizePoolName(keyBase) === normalizedBase) {
                return data;
            }
        }
        
        return null;
    }
    
    // Calculate aDAO bribe recommendation for each bucket
    function getAdaoBribePicks(pools, pdRankings) {
        const picks = {};
        const buckets = ['STABLE', 'PROJECT', 'BLUECHIP', 'SINGLE'];
        
        buckets.forEach(bucket => {
            const bucketPools = pools.filter(p => p.bucket === bucket && p.is_active !== false);
            if (bucketPools.length === 0) return;
            
            // Score each pool for bribe potential
            const scored = bucketPools.map(p => {
                const pdData = findPdDataForPool(pdRankings, bucket, p.name, p.dex);
                const hasPdBribe = pdData && pdData.percent > 0;
                const pdPercent = pdData?.percent || 0;
                
                // Calculate bribe impact score
                // Higher score = better candidate for aDAO bribe
                let bribeScore = 0;
                
                // 1. Opportunity score contribution (higher opportunity = more impact)
                bribeScore += (p.calc_score || 0) * 0.4;
                
                // 2. No PD coverage bonus (we fill gaps)
                if (!hasPdBribe) {
                    bribeScore += 25;
                } else if (pdPercent < 10) {
                    // Low PD coverage - still could use boost
                    bribeScore += 15;
                }
                
                // 3. Performance vs Support gap
                const perfSupportGap = (p.calc_perf || 0) - (p.calc_support || 0);
                bribeScore += perfSupportGap * 0.3;
                
                // 4. Low existing bribes bonus
                const totalBribes = p.bribes_total || 0;
                if (totalBribes < 50) bribeScore += 15;
                else if (totalBribes < 100) bribeScore += 8;
                
                // 5. Active pool with some volume (not dead)
                if ((p.vol_4ep_avg || 0) > 1000) bribeScore += 10;
                
                // 6. Votion potential - pools where bribes could drive Votion votes
                const votionPct = p.votion_now_pct || 0;
                if (votionPct < 30) bribeScore += 10; // Low Votion = room to grow
                
                return {
                    ...p,
                    bribeScore,
                    hasPdBribe,
                    pdPercent
                };
            });
            
            // Sort by bribe score and pick the top candidate
            scored.sort((a, b) => b.bribeScore - a.bribeScore);
            
            if (scored.length > 0) {
                picks[bucket] = scored[0];
            }
        });
        
        return picks;
    }
    
    // Recalculate scores within filtered pool set
    function recalculateScores(pools) {
        // Group by bucket for relative ranking
        const buckets = ['STABLE', 'PROJECT', 'BLUECHIP', 'SINGLE'];
        
        buckets.forEach(bucket => {
            const bucketPools = pools.filter(p => p.bucket === bucket);
            if (bucketPools.length === 0) return;
            
            // Get pools with data for ranking
            const withLiq = bucketPools.filter(p => (p.liq_4ep_avg || p.liquidity || 0) > 0);
            const withVol = bucketPools.filter(p => (p.vol_4ep_avg || 0) > 0);
            const withEff = bucketPools.filter(p => (p.efficiency || 0) > 0);
            const withBribes = bucketPools.filter(p => (p.bribes_total || 0) > 0);
            const withVotes = bucketPools.filter(p => (p.vp_share || 0) > 0);
            
            // Sort and rank
            withLiq.sort((a, b) => (b.liq_4ep_avg || b.liquidity || 0) - (a.liq_4ep_avg || a.liquidity || 0));
            withVol.sort((a, b) => (b.vol_4ep_avg || 0) - (a.vol_4ep_avg || 0));
            withEff.sort((a, b) => (b.efficiency || 0) - (a.efficiency || 0));
            withBribes.sort((a, b) => (b.bribes_total || 0) - (a.bribes_total || 0));
            withVotes.sort((a, b) => (b.vp_share || 0) - (a.vp_share || 0));
            
            // Calculate percentile ranks and scores
            bucketPools.forEach(p => {
                const liqRank = withLiq.length > 0 ? (1 - (withLiq.indexOf(p) === -1 ? withLiq.length : withLiq.indexOf(p)) / withLiq.length) * 100 : 0;
                const volRank = withVol.length > 0 ? (1 - (withVol.indexOf(p) === -1 ? withVol.length : withVol.indexOf(p)) / withVol.length) * 100 : 0;
                const effRank = withEff.length > 0 ? (1 - (withEff.indexOf(p) === -1 ? withEff.length : withEff.indexOf(p)) / withEff.length) * 100 : 0;
                const bribeRank = withBribes.length > 0 ? (1 - (withBribes.indexOf(p) === -1 ? withBribes.length : withBribes.indexOf(p)) / withBribes.length) * 100 : 0;
                const voteRank = withVotes.length > 0 ? (1 - (withVotes.indexOf(p) === -1 ? withVotes.length : withVotes.indexOf(p)) / withVotes.length) * 100 : 0;
                
                // Performance: 35% efficiency, 25% volume, 20% liquidity, 15% access, 5% other
                const accessScore = p.access_score || 50;
                p.calc_perf = (effRank * 0.35) + (volRank * 0.25) + (liqRank * 0.20) + (accessScore * 0.15) + (0 * 0.05);
                
                // Support: 40% bribes, 30% TLA votes, 30% Votion
                const votionPct = p.votion_now_pct || 0;
                p.calc_support = (bribeRank * 0.40) + (voteRank * 0.30) + (votionPct * 0.30);
                
                // Opportunity = Performance - Support
                p.calc_score = p.calc_perf - p.calc_support;
                
                // Clamp
                p.calc_score = Math.max(-100, Math.min(100, p.calc_score));
            });
        });
        
        return pools;
    }
    
    // Modal functions
    function showPerformanceModal() {
        document.getElementById('performance-modal').classList.remove('hidden');
        document.getElementById('performance-modal').classList.add('flex');
    }
    
    function closePerformanceModal(e) {
        if (!e || e.target === document.getElementById('performance-modal')) {
            document.getElementById('performance-modal').classList.add('hidden');
            document.getElementById('performance-modal').classList.remove('flex');
        }
    }
    
    function showSupportModal() {
        document.getElementById('support-modal').classList.remove('hidden');
        document.getElementById('support-modal').classList.add('flex');
    }
    
    function closeSupportModal(e) {
        if (!e || e.target === document.getElementById('support-modal')) {
            document.getElementById('support-modal').classList.add('hidden');
            document.getElementById('support-modal').classList.remove('flex');
        }
    }
    
    function showOpportunityModal() {
        document.getElementById('opportunity-modal').classList.remove('hidden');
        document.getElementById('opportunity-modal').classList.add('flex');
    }
    
    function closeOpportunityModal(e) {
        if (!e || e.target === document.getElementById('opportunity-modal')) {
            document.getElementById('opportunity-modal').classList.add('hidden');
            document.getElementById('opportunity-modal').classList.remove('flex');
        }
    }
    
    function showAccessScoreModal() {
        document.getElementById('access-modal').classList.remove('hidden');
        document.getElementById('access-modal').classList.add('flex');
    }
    
    function closeAccessModal(e) {
        if (!e || e.target === document.getElementById('access-modal')) {
            document.getElementById('access-modal').classList.add('hidden');
            document.getElementById('access-modal').classList.remove('flex');
        }
    }
    
    function showPoolDetail(poolName) {
        const pool = store.pools.find(p => p.name === poolName);
        if (!pool) return;
        
        document.getElementById('pool-detail-name').textContent = pool.name;
        document.getElementById('pool-detail-meta').textContent = `${pool.dex} • ${pool.bucket}`;
        
        const score = pool.adao_score || 0;
        const scoreClass = score > 20 ? 'text-green-400 bg-green-500/10 border-green-500/30' :
                          score > 0 ? 'text-cyan-400 bg-cyan-500/10 border-cyan-500/30' :
                          score > -20 ? 'text-yellow-400 bg-yellow-500/10 border-yellow-500/30' :
                          'text-red-400 bg-red-500/10 border-red-500/30';
        
        const content = `
            <!-- Score Summary -->
            <div class="p-4 rounded-lg border ${scoreClass}">
                <div class="flex items-center justify-between">
                    <div>
                        <div class="text-sm text-gray-400">Opportunity Score</div>
                        <div class="text-3xl font-bold">${score.toFixed(1)}</div>
                    </div>
                    <div class="text-right text-sm">
                        <div class="text-emerald-400">Performance: ${(pool.performance_score || 0).toFixed(1)}</div>
                        <div class="text-amber-400">Support: ${(pool.support_score || 0).toFixed(1)}</div>
                    </div>
                </div>
            </div>
            
            <!-- Performance Breakdown -->
            <div class="p-4 bg-gray-800/50 rounded-lg border border-gray-700">
                <div class="font-semibold text-emerald-400 mb-3 flex items-center gap-2">
                    <i class="fas fa-chart-line"></i> Performance Components
                </div>
                <div class="grid grid-cols-2 gap-3 text-sm">
                    <div class="flex justify-between">
                        <span class="text-gray-400">Efficiency (35%)</span>
                        <span class="mono">${pool.efficiency ? (pool.efficiency * 100).toFixed(0) + '%' : '-'}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Volume (25%)</span>
                        <span class="mono">${fmt$(pool.vol_4ep_avg || 0)}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Liquidity (20%)</span>
                        <span class="mono">${fmt$(pool.liq_4ep_avg || 0)}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Access (15%)</span>
                        <span class="mono">${(pool.access_score || 0).toFixed(0)}</span>
                    </div>
                </div>
            </div>
            
            <!-- Support Breakdown -->
            <div class="p-4 bg-gray-800/50 rounded-lg border border-gray-700">
                <div class="font-semibold text-amber-400 mb-3 flex items-center gap-2">
                    <i class="fas fa-hands-helping"></i> Support Components
                </div>
                <div class="grid grid-cols-2 gap-3 text-sm">
                    <div class="flex justify-between">
                        <span class="text-gray-400">Bribes (40%)</span>
                        <span class="mono">${fmt$(pool.bribes_total || 0)}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">TLA Share (30%)</span>
                        <span class="mono">${fmtPct(pool.vp_share || 0)}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Votion Now (30%)</span>
                        <span class="mono">${fmtPct(pool.votion_now_pct || 0)}</span>
                    </div>
                </div>
            </div>
            
            <!-- Recommendation -->
            <div class="p-4 bg-gray-800/30 rounded-lg text-sm">
                ${score > 10 ? 
                    '<div class="text-green-400"><i class="fas fa-check-circle mr-2"></i>High opportunity - aDAO votes could make significant impact here</div>' :
                  score > 0 ? 
                    '<div class="text-cyan-400"><i class="fas fa-info-circle mr-2"></i>Moderate opportunity - worth considering for vote allocation</div>' :
                  score > -10 ?
                    '<div class="text-yellow-400"><i class="fas fa-exclamation-circle mr-2"></i>Well balanced - support roughly matches performance</div>' :
                    '<div class="text-red-400"><i class="fas fa-times-circle mr-2"></i>Already well-supported - aDAO votes better used elsewhere</div>'
                }
            </div>
        `;
        
        document.getElementById('pool-detail-content').innerHTML = content;
        document.getElementById('pool-detail-modal').classList.remove('hidden');
        document.getElementById('pool-detail-modal').classList.add('flex');
    }
    
    function closePoolDetailModal(e) {
        if (!e || e.target === document.getElementById('pool-detail-modal')) {
            document.getElementById('pool-detail-modal').classList.add('hidden');
            document.getElementById('pool-detail-modal').classList.remove('flex');
        }
    }
    
    // ============================================================
    // DAO TAB
    // ============================================================
    function renderDaoTab() {
        if (!store.dao) {
            document.querySelectorAll('#tab-dao [id^="dao-"]').forEach(el => {
                if (el.tagName !== 'DIV') return;
                el.innerHTML = '<span class="text-gray-500">No DAO data</span>';
            });
            return;
        }
        
        const dao = store.dao;
        
        // Stats
        document.getElementById('dao-locked-vp').textContent = fmtNum(dao.locked_vp || 0);
        document.getElementById('dao-underlying').textContent = fmtNum(dao.underlying_assets || 0);
        document.getElementById('dao-deposit-usd').textContent = fmt$(dao.deposit_usd || 0);
        document.getElementById('dao-rewards-usd').textContent = fmt$(dao.rewards?.usd || 0);
        
        // Locks
        const locksHtml = (dao.locks || []).map(lock => `
            <div class="p-4 rounded-lg bg-white/[0.02] border border-white/5">
                <div class="flex items-center justify-between mb-2">
                    <span class="font-semibold">${lock.asset}</span>
                    <span class="text-xs px-2 py-1 rounded-full bg-cyan-500/20 text-cyan-400">${lock.status}</span>
                </div>
                <div class="grid grid-cols-3 gap-4 text-sm">
                    <div>
                        <div class="text-gray-500 text-xs">Amount</div>
                        <div class="mono">${fmtNum(lock.amount)}</div>
                    </div>
                    <div>
                        <div class="text-gray-500 text-xs">VP</div>
                        <div class="mono text-cyan-400">${fmtNum(lock.vp)}</div>
                    </div>
                    <div>
                        <div class="text-gray-500 text-xs">USD</div>
                        <div class="mono text-green-400">${fmt$(lock.usd)}</div>
                    </div>
                </div>
            </div>
        `).join('');
        document.getElementById('dao-locks').innerHTML = locksHtml || '<span class="text-gray-500">No locks</span>';
        
        // Allocations
        const allocHtml = (dao.allocations || []).map(alloc => `
            <div class="flex items-center justify-between p-2 rounded bg-white/[0.02]">
                <div class="flex items-center gap-2">
                    <span class="text-sm font-medium">${alloc.pool}</span>
                    <span class="text-[10px] text-gray-500">${alloc.dex}</span>
                </div>
                <div class="flex items-center gap-3">
                    <span class="mono text-xs">${fmtNum(alloc.vp)} VP</span>
                    <span class="mono text-xs text-purple-400">${fmtPct(alloc.pct)}</span>
                </div>
            </div>
        `).join('');
        document.getElementById('dao-allocations').innerHTML = allocHtml || '<span class="text-gray-500">No allocations</span>';
        
        // Vote Rewards
        if (dao.vote_reward_periods) {
            const periods = dao.vote_reward_periods;
            document.getElementById('reward-epochs').textContent = `${periods[0]} - ${periods[periods.length - 1]}`;
        }
        
        const rewardsHtml = Object.entries(dao.vote_rewards || {}).map(([token, amount]) => `
            <div class="p-3 rounded-lg bg-white/[0.02] border border-white/5 text-center">
                <div class="text-xs text-gray-500 mb-1">${token}</div>
                <div class="mono text-sm font-semibold text-green-400">${fmtBig(amount)}</div>
            </div>
        `).join('');
        document.getElementById('dao-vote-rewards').innerHTML = rewardsHtml || '<span class="text-gray-500">No rewards</span>';
        
        // Treasury Tokens
        const tokensHtml = (dao.tokens || []).map(t => `
            <div class="p-3 rounded-lg bg-white/[0.02] border border-white/5 text-center">
                <div class="text-xs text-gray-500 mb-1">${t.s}</div>
                <div class="mono text-sm font-semibold">${fmtBig(t.a)}</div>
            </div>
        `).join('');
        document.getElementById('dao-tokens').innerHTML = tokensHtml || '<span class="text-gray-500">No tokens</span>';
    }
    
    // ============================================================
    // DOCS TAB FUNCTIONS
    // ============================================================
    function toggleDocsSection(header) {
        const card = header.closest('.docs-card, .glass-card');
        const expanded = card.querySelector('.docs-expanded');
        const icon = header.querySelector('.fa-chevron-down');
        
        if (expanded) {
            expanded.classList.toggle('hidden');
            if (icon) {
                icon.style.transform = expanded.classList.contains('hidden') ? 'rotate(0deg)' : 'rotate(180deg)';
            }
        }
    }
    
    // Smooth scroll for docs navigation
    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('a[href^="#docs-"]').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const targetId = link.getAttribute('href').slice(1);
                const target = document.getElementById(targetId);
                if (target) {
                    // Switch to docs tab first
                    switchToTab('docs');
                    history.pushState(null, '', '#docs');
                    // Then scroll to section
                    setTimeout(() => {
                        target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }, 100);
                }
            });
        });
    });
    
    // ============================================================
    // EVENT HANDLERS
    // ============================================================
    function setupEventListeners() {
        // Tabs - with URL hash support for direct linking and analytics
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tabName = btn.dataset.tab;
                switchToTab(tabName);
                // Update URL hash (enables direct linking and analytics tracking)
                history.pushState(null, '', '#' + tabName);
            });
        });
        
        // Handle browser back/forward navigation
        window.addEventListener('popstate', () => {
            const hash = window.location.hash.slice(1) || 'overview';
            switchToTab(hash);
        });
        
        // Epoch/Phase selectors
        document.getElementById('epoch-select').addEventListener('change', (e) => {
            const epoch = e.target.value === 'latest' ? (store.currentRealEpoch || CONFIG.currentEpoch) : parseInt(e.target.value);
            const phase = document.getElementById('phase-select').value;
            loadEpochData(epoch, phase);
        });
        
        document.getElementById('phase-select').addEventListener('change', (e) => {
            const epochEl = document.getElementById('epoch-select');
            const epoch = epochEl.value === 'latest' ? (store.currentRealEpoch || CONFIG.currentEpoch) : parseInt(epochEl.value);
            loadEpochData(epoch, e.target.value);
        });
        
        // Pool filters
        document.getElementById('pool-search').addEventListener('input', applyPoolFilters);
        document.getElementById('bucket-filter').addEventListener('change', applyPoolFilters);
        document.getElementById('dex-filter').addEventListener('change', applyPoolFilters);
        document.getElementById('active-only').addEventListener('change', applyPoolFilters);
        
        // TLA filter
        // TLA filters
        document.getElementById('tla-hide-inactive')?.addEventListener('change', applyTlaFilters);
        document.getElementById('tla-hide-astro')?.addEventListener('change', applyTlaFilters);
        document.getElementById('tla-hide-ww')?.addEventListener('change', applyTlaFilters);
    }
    
    // Switch to a specific tab
    function switchToTab(tabName) {
        const validTabs = ['overview', 'pools', 'tla', 'rankings', 'dao', 'docs'];
        if (!validTabs.includes(tabName)) tabName = 'overview';
        
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        
        const tabBtn = document.querySelector(`.tab-btn[data-tab="${tabName}"]`);
        const tabContent = document.getElementById('tab-' + tabName);
        
        if (tabBtn) tabBtn.classList.add('active');
        if (tabContent) tabContent.classList.add('active');
    }
    
    // Check URL hash on page load
    function initTabFromHash() {
        const hash = window.location.hash.slice(1);
        if (hash) {
            switchToTab(hash);
        }
    }
    
    function populateEpochSelector() {
        const select = document.getElementById('epoch-select');
        // Use real current epoch if available, otherwise fallback to CONFIG
        const currentEpoch = store.currentRealEpoch || CONFIG.currentEpoch;
        // Add recent epochs (go back 15 epochs for history)
        for (let i = currentEpoch; i >= Math.max(1, currentEpoch - 15); i--) {
            const opt = document.createElement('option');
            opt.value = i;
            opt.textContent = 'Epoch ' + i;
            select.appendChild(opt);
        }
    }
    
    // ============================================================
    // BRIBES MODAL
    // ============================================================
    function showBribesModal() {
        const modal = document.getElementById('bribes-modal');
        const lunaPrice = store.adaoSnap?.lunaPrice_USD || 0.073;
        
        // Calculate totals from pool data
        let totalPdUSD = 0, totalOtherUSD = 0, totalBribesUSD = 0;
        store.pools.forEach(p => {
            totalPdUSD += p.bribes_pd || 0;
            totalOtherUSD += p.bribes_other || 0;
            totalBribesUSD += p.bribes_total || 0;
        });
        
        // Update summary values
        const pdLuna = lunaPrice > 0 ? totalPdUSD / lunaPrice : 0;
        document.getElementById('bribes-pd-luna').textContent = fmtNum(pdLuna) + ' LUNA';
        document.getElementById('bribes-pd-usd').textContent = fmt$(totalPdUSD);
        document.getElementById('bribes-other-usd').textContent = fmt$(totalOtherUSD);
        document.getElementById('bribes-total-usd').textContent = fmt$(totalBribesUSD);
        document.getElementById('bribes-luna-price').textContent = 'LUNA @ $' + lunaPrice.toFixed(4);
        
        // Build bucket breakdown HTML with columns
        const bucketColors = {
            PROJECT: { bg: 'bg-purple-500/10', border: 'border-purple-500/20', text: 'text-purple-400' },
            BLUECHIP: { bg: 'bg-blue-500/10', border: 'border-blue-500/20', text: 'text-blue-400' },
            SINGLE: { bg: 'bg-amber-500/10', border: 'border-amber-500/20', text: 'text-amber-400' },
            STABLE: { bg: 'bg-cyan-500/10', border: 'border-cyan-500/20', text: 'text-cyan-400' }
        };
        
        let breakdownHtml = '';
        const buckets = ['PROJECT', 'BLUECHIP', 'SINGLE', 'STABLE'];
        
        buckets.forEach(bucket => {
            // Get pools with bribes in this bucket
            const pools = store.pools.filter(p => 
                p.bucket === bucket && (p.bribes_total || 0) > 0
            ).sort((a, b) => (b.bribes_total || 0) - (a.bribes_total || 0));
            
            if (pools.length === 0) return;
            
            const colors = bucketColors[bucket];
            
            // Calculate bucket totals
            let bucketPdUSD = 0, bucketOtherUSD = 0;
            pools.forEach(p => {
                bucketPdUSD += p.bribes_pd || 0;
                bucketOtherUSD += p.bribes_other || 0;
            });
            const bucketTotalUSD = bucketPdUSD + bucketOtherUSD;
            const bucketPdLuna = lunaPrice > 0 ? bucketPdUSD / lunaPrice : 0;
            
            breakdownHtml += `
                <div class="${colors.bg} ${colors.border} border rounded-lg overflow-hidden">
                    <!-- Bucket Header -->
                    <div class="grid grid-cols-4 gap-2 p-3 border-b ${colors.border} text-sm">
                        <div class="font-semibold ${colors.text} uppercase">${bucket}</div>
                        <div class="text-right">
                            <div class="text-[10px] text-gray-500">PHOENIX DIR</div>
                            <div class="text-purple-400 font-medium">${fmt$(bucketPdUSD)}</div>
                        </div>
                        <div class="text-right">
                            <div class="text-[10px] text-gray-500">OTHER</div>
                            <div class="text-amber-400 font-medium">${fmt$(bucketOtherUSD)}</div>
                        </div>
                        <div class="text-right">
                            <div class="text-[10px] text-gray-500">TOTAL</div>
                            <div class="${colors.text} font-bold">${fmt$(bucketTotalUSD)}</div>
                        </div>
                    </div>
                    
                    <!-- Column Headers -->
                    <div class="grid grid-cols-4 gap-2 px-3 py-1 text-[10px] text-gray-500 border-b border-white/5">
                        <div>POOL</div>
                        <div class="text-right">Phoenix Dir (USD)</div>
                        <div class="text-right">OTHER (USD)</div>
                        <div class="text-right">TOTAL (USD)</div>
                    </div>
                    
                    <!-- Pool Rows -->
                    <div class="divide-y divide-white/5">
                        ${pools.map(p => {
                            const pdUSD = p.bribes_pd || 0;
                            const otherUSD = p.bribes_other || 0;
                            const totalUSD = p.bribes_total || 0;
                            return `
                            <div class="grid grid-cols-4 gap-2 px-3 py-2 text-sm">
                                <div>
                                    <span class="text-gray-300">${p.name}</span>
                                    <span class="text-[10px] text-gray-500 ml-1">${p.dex}</span>
                                </div>
                                <div class="text-right">
                                    ${pdUSD > 0 ? `<div class="text-purple-400">${fmt$(pdUSD)}</div>` : `<div class="text-gray-600">-</div>`}
                                </div>
                                <div class="text-right">
                                    <div class="text-amber-400">${otherUSD > 0 ? fmt$(otherUSD) : '-'}</div>
                                </div>
                                <div class="text-right">
                                    <div class="text-white font-medium">${fmt$(totalUSD)}</div>
                                </div>
                            </div>
                        `}).join('')}
                    </div>
                </div>
            `;
        });
        
        // Add totals row at bottom
        breakdownHtml += `
            <div class="bg-white/5 border border-white/10 rounded-lg p-4">
                <div class="grid grid-cols-4 gap-2 items-center">
                    <div class="font-bold text-white">TOTAL</div>
                    <div class="text-right">
                        <div class="text-purple-400 font-bold">${fmt$(totalPdUSD)}</div>
                    </div>
                    <div class="text-right">
                        <div class="text-amber-400 font-bold">${fmt$(totalOtherUSD)}</div>
                    </div>
                    <div class="text-right">
                        <div class="text-cyan-400 text-xl font-bold">${fmt$(totalBribesUSD)}</div>
                    </div>
                </div>
            </div>
        `;
        
        document.getElementById('bribes-bucket-breakdown').innerHTML = breakdownHtml;
        
        // Show modal
        modal.classList.remove('hidden');
        modal.classList.add('flex');
    }
    
    function closeBribesModal(event) {
        if (event && event.target !== event.currentTarget) return;
        const modal = document.getElementById('bribes-modal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    }
    
    // ============================================================
    // RANKING MODAL
    // ============================================================
    let rankingState = {
        type: 'volume',
        sortAsc: false,
        data: []
    };
    
    function showRankingModal(type) {
        const modal = document.getElementById('ranking-modal');
        const active = store.pools.filter(p => p.is_active !== false);
        
        rankingState.type = type;
        rankingState.sortAsc = false;
        
        // Set title and prepare data based on type
        let title = '';
        let valueKey = '';
        let valueFormatter = fmt$;
        let valueColor = 'text-cyan-400';
        
        switch (type) {
            case 'volume':
                title = 'All Pools - Avg Volume';
                rankingState.data = active.map(p => ({
                    name: p.name,
                    dex: p.dex,
                    bucket: p.bucket,
                    value: p.vol_4ep_avg || 0
                })).filter(p => p.value > 0);
                valueColor = 'text-orange-400';
                break;
            case 'liquidity':
                title = 'All Pools - Avg DEX Liquidity';
                rankingState.data = active.map(p => ({
                    name: p.name,
                    dex: p.dex,
                    bucket: p.bucket,
                    value: p.liq_4ep_avg || 0
                })).filter(p => p.value > 0);
                valueColor = 'text-cyan-400';
                break;
            case 'apr':
                title = 'All Pools - APR (Amplified)';
                rankingState.data = active.map(p => ({
                    name: p.name,
                    dex: p.dex,
                    bucket: p.bucket,
                    value: p.apr_amp || 0
                })).filter(p => p.value > 0);
                valueFormatter = fmtPct;
                valueColor = 'text-green-400';
                break;
        }
        
        document.getElementById('ranking-modal-title').textContent = title;
        rankingState.valueFormatter = valueFormatter;
        rankingState.valueColor = valueColor;
        
        renderRankingList();
        
        // Show modal
        modal.classList.remove('hidden');
        modal.classList.add('flex');
    }
    
    function renderRankingList() {
        const data = [...rankingState.data];
        
        // Sort
        if (rankingState.sortAsc) {
            data.sort((a, b) => a.value - b.value);
        } else {
            data.sort((a, b) => b.value - a.value);
        }
        
        document.getElementById('ranking-count').textContent = data.length;
        document.getElementById('ranking-sort-label').textContent = rankingState.sortAsc ? 'Low to High' : 'High to Low';
        document.getElementById('ranking-sort-btn').querySelector('i').className = rankingState.sortAsc ? 'fas fa-sort-amount-up' : 'fas fa-sort-amount-down';
        
        const html = data.map((p, i) => `
            <div class="flex items-center justify-between p-3 rounded-lg bg-white/[0.02] hover:bg-white/[0.05]">
                <div class="flex items-center gap-3">
                    <span class="w-8 h-8 rounded-lg flex items-center justify-center text-sm font-bold ${i < 3 ? `rank-${i+1}` : 'bg-white/10'}">${i+1}</span>
                    <div>
                        <div class="font-medium">${p.name}</div>
                        <div class="text-xs text-gray-500">${p.dex} • ${p.bucket}</div>
                    </div>
                </div>
                <span class="mono ${rankingState.valueColor} text-sm font-medium">${rankingState.valueFormatter(p.value)}</span>
            </div>
        `).join('');
        
        document.getElementById('ranking-list').innerHTML = html || '<div class="text-gray-500 text-center py-8">No data available</div>';
    }
    
    function toggleRankingSort() {
        rankingState.sortAsc = !rankingState.sortAsc;
        renderRankingList();
    }
    
    function closeRankingModal(event) {
        if (event && event.target !== event.currentTarget) return;
        const modal = document.getElementById('ranking-modal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    }
    
    // ============================================================
    // INIT
    // ============================================================
    async function init() {
        // Load site config first (scoring weights, DEX settings, etc.)
        await loadSiteConfig();
        
        // Load epoch dates to know current real epoch
        await loadEpochDates();
        
        // Now populate selector with real epoch info
        populateEpochSelector();
        setupEventListeners();
        initTabFromHash(); // Check URL hash and switch to that tab
        
        // Find latest available data by trying epochs starting from current
        const startEpoch = store.currentRealEpoch || CONFIG.currentEpoch;
        let dataEpoch = await findLatestDataEpoch(startEpoch);
        
        // Load the latest available data
        await loadEpochData(dataEpoch, CONFIG.defaultPhase);
    }
    
    // Try to find the latest epoch that has data
    async function findLatestDataEpoch(startFrom) {
        // Try from startFrom down to startFrom - 2 (in case current epoch data isn't ready)
        for (let epoch = startFrom; epoch >= Math.max(1, startFrom - 2); epoch--) {
            const url = `${CONFIG.baseUrl}/tla-data-epoch-${epoch}-${CONFIG.defaultPhase}.json`;
            try {
                const response = await fetch(url, { method: 'HEAD' });
                if (response.ok) {
                    console.log('Found latest data at epoch:', epoch);
                    return epoch;
                }
            } catch (e) {
                // Continue to next epoch
            }
        }
        // Fallback to CONFIG
        return CONFIG.currentEpoch;
    }
    
    // Start
    document.addEventListener('DOMContentLoaded', init);
    </script>
    
    <!-- Vercel Web Analytics (auto-enabled for Vercel-hosted sites) -->
    <script defer src="/_vercel/insights/script.js"></script>
</body>
</html>
